= V4 Outline MultiLine NoSorting TabWidth=30

H="********"


H="Create IAH Flags"
use "E:\nhats\data\Projects\serious_ill\final_data\serious_ill_nhats_sample.dta", replace
/*
drop community_dwelling SP_completed

merge 1:1 spid wave using "C:\Users\rahmao03\Documents\community.dta"
cap drop _m

save "E:\nhats\data\Projects\serious_ill\final_data\serious_ill_nhats_sample.dta", replace
*/
keep if community_dwelling
keep if wave<6
cap drop bene_id 

merge m:1 spid using "E:\nhats\data\20180625 NHATS CMS Data\merged\xwalk_2016.dta" 

keep if _m==3

save "E:\nhats\data\Projects\IAH\int_data\iah_fullsample.dta", replace


keep bene_id spid wave ivw_month ivw_year


saveold "E:\nhats\data\Projects\IAH\int_data\iah_ivwdates.dta", version(12) replace



use "E:\nhats\data\Projects\IAH\int_data\iah_fullsample.dta", clear

cap drop _merge

merge 1:1 spid wave using "E:\nhats\data\Projects\IAH\int_data\iah_ffs.dta", keepus(ffs_6m)
keep if _m==3

save "E:\nhats\data\Projects\IAH\final_data\iah_fullsample.dta", replace



local cvars sr_stroke_ever sr_cancer_ever sr_hip_ever sr_heart_dis_ever sr_htn_ever sr_ra_ever sr_osteoprs_ever sr_diabetes_ever sr_lung_dis_ever sr_dementia_ever

 
egen c_con = anycount(`cvars'), values(1)
gen cc_flag = 0
replace cc_flag = 1 if c_con>=2
label var cc_flag "2+ Chronic Conditions"
 
local avars adl_eat_help adl_bath_help adl_toil_help adl_dres_help adl_bed_help adl_ins_help
egen adl_con = anycount(`avars'), values(1)
gen adl_flag = 0
replace adl_flag = 1 if adl_con>=2 
label var adl_flag "2+ ADL Impairment"

gen homebound = 0
replace homebound = 1 if homebound_cat==1

gen homebound_never = 0
replace homebound_never = 1 if homebound_cat==2

rename cc_flag iah_chronic
rename adl_flag iah_adl
rename ind_nonelect_adm_12m iah_nonelect


saveold "E:\nhats\data\Projects\IAH\final_data\iah_wave1-5.dta", version(12) replace


H="Search for IP rehab and home calls"
libname claims "E:\nhats\data\20180625 NHATS CMS Data\merged";
libname cyears "E:\nhats\data\20180625 NHATS CMS Data\Cumulative";

proc import datafile="E:\nhats\data\Projects\IAH\final_data\iah_wave1-5.dta" out=iv_mb2 dbms=stata replace; run; 


/* Identifying Inpatient Rehab */

data ip_check (keep = bene_id index_date index_month year wave ffs_6m);
set iv_mb2;
run;

data inpatient;
set claims.ip_06_16;
run;

data ip_rev;
set cyears.inpatient_revenue_center_j_06_16;
run;

proc sql;
create table ip_clm_rev as select a.*, b.*
from inpatient a
inner join ip_rev b
on a.bene_id = b.bene_id and a.clm_id = b.clm_id;
quit;

proc freq data=inpatient; tables PTNT_DSCHRG_STUS_CD; run;
proc freq data=ip_rev; tables REV_CNTR_UNIT_CNT; run;
 

data ip_clm_rev;
set ip_clm_rev;
disch_rehab = 0;
ip_rehab = 0;
if PTNT_DSCHRG_STUS_CD='62' or PTNT_DSCHRG_STUS_CD='90' then disch_rehab = 1;
if REV_CNTR_UNIT_CNT = 24 then ip_rehab = 1;
run;


proc freq data=ip_clm_rev; tables disch_rehab; run;
proc freq data=ip_clm_rev; tables ip_rehab; run;


data disch_2_iprehab;
set ip_clm_rev;
where disch_rehab = 1;
run;

data ip_rehab;
set ip_clm_rev;
where ip_rehab = 1;
run;


data test;
set disch_2_iprehab ip_rehab;
run;


proc sort data=test nodupkey; by bene_id admit_date; run;


proc sql;
create table ip_restays as select a.*, b.admit_date, b.disch_date
from ip_check a
inner join test b
on a.bene_id = b.bene_id and 0 < a.index_date-b.admit_date <365;
quit;

proc sort data=ip_restays out=ip_rehabstays nodupkey; by bene_id index_date; run;

data ip_rehabstays; /*inpatient hospital rehab stays */
set ip_rehabstays;
ip_rehab = 1;
run;

/* Checking for HH/SNF within 7 days of disch_date */

data homehealth;
set claims.hh_09_16;
run;

data snf;
set claims.snf_09_16;
run;

proc sql;
create table hh_nhats as select a.*, b.*
from ip_check a
inner join homehealth b
on a.bene_id = b.bene_id
where 0 < a.index_date - b.disch_date < 365;
quit;

data hh_nhats_short (keep = bene_id index_date admit_date disch_date hh);
set hh_nhats;
hh = 1;
run;

proc sql;
create table snf_nhats as select a.*, b.*
from ip_check a
inner join snf b
on a.bene_id = b.bene_id
where 0 <a.index_date - b.disch_date < 365;
quit;

data snf_nhats_short (keep = bene_id index_date admit_date disch_date snf);
set snf_nhats;
snf = 1;
run;

data rehab (rename=(admit_date = rehab_admit disch_date = rehab_disch));
set snf_nhats_short hh_nhats_short;
*format rehab_admit rehab_disch date10.;
run;

proc sql;
create table ip1 as select a.admit_date, a.disch_date, b.*
from inpatient a
inner join rehab b
on a.bene_id = b.bene_id
where 0 <= b.rehab_admit-a.disch_date < 8;
quit;

data ip1;
set ip1 ip_rehabstays;
run;

proc sort data=ip1; by bene_id index_date; run;
proc sort data=ip1 nodupkey; by bene_id index_date; run;

proc freq data=ip1; tables ip_rehab; run;

proc export data=ip1 outfile="E:\nhats\data\Projects\IAH\final_data\iah_rehab_flag.dta" replace; run;


/***** Identifying any Home Health Claim +/- 90 days of interview ******/

data homehealth;
set claims.hh_09_16;
run;

proc sql;
create table nhats_hh as select a.*, b.admit_date
from ip_check a
inner join homehealth b
on a.bene_id=b.bene_id and -90<=a.index_date - b.admit_date<=90;
quit;

proc export data=nhats_hh outfile="E:\nhats\data\Projects\IAH\int_data\homehealth_visit.dta" dbms=stata replace; run;








/********** Identifying house calls ************/

/* Identifying house calls */

data carrier;
set claims.pb_09_16;
array dx hcpcscd1--hcpcscd13;
do over dx;
hcpcs_cd=dx;
output;
end;
run;

data carrier1;
set carrier;
cptcodes1 = input(compress(hcpcs_cd,'ABCDEFGHIJKLMNOPQRSTUVWXYZ/',),8.);
run;

data carrier1;
set carrier1;
cpt1flag = 0;
if 99341<=cptcodes1<=99350 or 99324<=cptcodes1<=99328 or 99334<=cptcodes1<=99337 then cpt1flag = 1;
run;

proc sort data=carrier1 nodupkey; by bene_id clm_id; run;

data carrierline (keep = bene_id clm_id LINE_PLACE_OF_SRVC_CD cptcodes);
set cyears.bcarrier_line_j_09_16;
cptcodes = input(compress(hcpcs_cd,'ABCDEFGHIJKLMNOPQRSTUVWXYZ/',),8.);
run;

data carrierline;
set carrierline;
cptflag = 0;
posflag = 0;
if 99341<=cptcodes<=99350 or 99324<=cptcodes<=99328 or 99334<=cptcodes<=99337 then cptflag=1;
if LINE_PLACE_OF_SRVC_CD in:(12,13,14) then posflag=1;
run;

data linecalls;
set carrierline;
where cptflag = 1 or posflag = 1;
run;

proc sql;
create table carrier2 as select a.*, b.*
from carrier1 a
full outer join linecalls b
on a.bene_id=b.bene_id and a.clm_id = b.clm_id;
quit;

data carrier2;
set carrier2;
where cptflag = 1 and posflag = 1;
year = year(admit_date);
run;

proc sort data=carrier2 nodupkey; by bene_id clm_id; run;

proc sql;
create table annual as select distinct bene_id, year,
sum(posflag) as housecalls_count
from carrier2
group by bene_id, year;
quit;


proc export data=annual(rename=(year = index_year)) outfile="E:\nhats\data\Projects\IAH\int_data\annualcpt_count.dta" replace; run;

proc sql;
create table homecallsb4_90 as select a.*, b.cptcodes, b.admit_date
from ip_check a
inner join carrier2 b
on a.bene_id=b.bene_id and -90<a.index_date-b.admit_date<=90;
quit;


proc sort data=homecallsb4_90 nodupkey; by descending wave bene_id; run;
proc sort data=homecallsb4_90 nodupkey; by bene_id; run;

proc freq data=homecallsb4_90; tables ffs_6m; run;

proc sort data=homecallsb4_90 out=test; by descending wave bene_id; run;

/*
data homecalls_90;
set homecallsb4_90_1 homecallsb4_90_2 homecallsb4_90_3 homecallsb4_90_4 homecallsb4_90_5;
run;

*/
proc export data=homecallsb4_90 outfile="E:\nhats\data\Projects\IAH\int_data\homecalls_90.dta" replace; run;



H="Merging it together"

use "E:\nhats\data\Projects\IAH\final_data\iah_wave1-5.dta", clear

/* merge IP rehab */
cap drop _m
merge 1:1 bene_id index_date using "E:\nhats\data\Projects\IAH\final_data\iah_rehab_flag.dta", keepus(ip_rehab snf hh)
replace ip_rehab=0 if ip_rehab==.
gen ip_rehab_only = 0
replace ip_rehab_only = 1 if ip_rehab==1 & snf==. & hh==.
label var ip_rehab "Inpatient Rehab or SNF/HH within 7 days of IP discharge, 1 yr prior to ivw"
label var ip_rehab_only "Inpatient rehab (no SNF/HH), 1 yr prior to ivw"


/* merge housecalls flag */
cap drop _m
merge 1:1 bene_id index_date using "E:\nhats\data\Projects\IAH\int_data\homecalls_90.dta"
gen hcallsb4 = 0
replace hcallsb4 = 1 if _m==3
label var hcalls " 1 or more house calls +/- 90 days of ivw"


/* house calls count */
cap drop _m
merge 1:1 bene_id index_year using "E:\nhats\data\Projects\IAH\int_data\annualcpt_count.dta"
drop if _m==2

label var housecalls_count "Ave. number of house calls in calendar year of interview"
cap drop _m

save "E:\nhats\data\Projects\IAH\int_data\iah_wave1-5.dta", replace

/* Get geographic region variables 


use "E:\nhats\data\NHATS working data\round_1_to_6.dta", clear 

keep spid wave re*dcensdiv

forvalues i=1/6 {

capture gen northeast = 0
replace northeast = 1 if re`i'dcensdiv==1 | re`i'dcensdiv==2

capture gen midwest = 0
replace midwest = 1 if re`i'dcensdiv==3 | re`i'dcensdiv==4

capture gen west = 0
replace west = 1 if re`i'dcensdiv==8 | re`i'dcensdiv==9
}

capture gen south = 0
replace south = 1 if northeast==0 & west==0 & midwest==0

cap drop re*dcensdiv

tempfile region
save "`region'"




use "E:\nhats\data\Projects\serious_ill\final_data\serious_ill_nhats_sample.dta", clear
cap drop _m
duplicates drop spid wave, force
merge 1:1 spid wave using "`region'"
keep if _m==3
cap drop _m


save "E:\nhats\data\Projects\serious_ill\final_data\serious_ill_nhats_sample.dta", replace


****
use "E:\nhats\data\Projects\IAH\int_data\iah_wave1-5.dta", clear
cap drop _m
duplicates drop spid wave, force
merge 1:1 spid wave using "`region'"
keep if _m==3
cap drop _m
*/

/*Income adjustment to $2016 dollars */
gen income_adj=0
replace income_adj= (240.007/224.939)*aveincome if wave==1
replace income_adj= (240.007/229.594)*aveincome if wave==2
replace income_adj= (240.007/232.957)*aveincome if wave==3
replace income_adj= (240.007/236.736)*aveincome if wave==4
replace income_adj= (240.007/237.017)*aveincome if wave==5

xtile income_quart_adj=income_adj, nq(4) 
sum income_adj, d

replace housecalls_count = 0 if housecalls_count==.

gen iah_rehab = 0
replace iah_rehab = 1 if ip_rehab==1 |snf==1 |hh==1

cap drop iah_all

gen iah_all = 0
replace iah_all = 1 if iah_adl==1 & iah_chronic==1 & iah_nonelect==1 & iah_rehab==1

forvalues w = 1/4 {

gen income_quart_`w' = . 
gen income_cat_`w' = 0
replace income_cat_`w'= 1 if income_quart_ad==`w'

replace income_quart_`w' = income_adj if income_quart_adj==`w'
sum income_quart_`w', d
local p = 25*`w' 
local q = r(mean)
local r = round(`q',1)


label var income_quart_`w' "Ave. Income in `p'th quartile (adjusted to 2016 dollars)"
label var income_cat_`w' "% with income in the `p'th quartile"

} 
gen pos_dem = 0
replace pos_dem = 1 if dem_3_cat==2 
label var pos_dem "Indicator Possible Dementia"

merge 1:1 bene_id wave using "E:\nhats\data\Projects\IAH\int_data\homehealth_visit.dta", keepus(admit_date)

gen mc_hh = 0
replace mc_hh = 1 if _m==3
label var mc_hh "Medicare HH claim +/- 90 days of ivw"
drop _m

H="IAH Table"
/* IAH population */
keep if cont_ffs_n_mos>=6
preserve 

keep if iah_all==1
gsort spid -wave
by spid: gen ind=_n==1 
keep if ind==1 /* keep most recent wave where they had iah_all */
save "E:\nhats\data\Projects\IAH\int_data\iah_mostrecent.dta", replace
levelsof spid, local(list)
restore
gen droplist = 0
foreach x in `list' {

replace droplist=1 if spid==`x'
}

drop if droplist==1 /* drop spid for those who have iah_all */

gsort spid -wave
keep if cont_ffs_n_mos>=6
by spid: gen ind=_n==1
keep if ind==1

save "E:\nhats\data\Projects\IAH\int_data\iah_control.dta", replace

append using "E:\nhats\data\Projects\IAH\int_data\iah_mostrecent.dta"

cap drop _m

merge 1:1 bene_id wave using "E:\nhats\data\Projects\IAH\int_data\homecalls_90.dta"
drop if _m==2

gen housecalls_90 = 0
replace housecalls_90 = 1 if _m==3
label var housecalls_90 "1+ housecalls +/- 90 days of ivw"

gen iah_pacute = 0
replace iah_pacute = 1 if iah_rehab==1

label var iah_pacute "IAH - Post Acute Care 12m prior"
label var iah_all "IAH - All Criteria Met"


local cvars1 age income_quart_1 income_quart_2 income_quart_3 income_quart_4 // score_community
local ivars1 female white black hisp married livealone rcfres educ_hs_ind reg_doc_have reg_doc_seen ///
homebound medicaid metro_ind northeast midwest south west
local ivars2 iah_adl iah_chronic iah_nonelect iah_pacute iah_all sr_ami_ever sr_stroke_ever ///
sr_cancer_ever sr_hip_ever sr_heart_dis_ever sr_htn_ever sr_ra_ever sr_osteoprs_ever ///
sr_diabetes_ever sr_dementia_ever prob_dem
local ivars3 adl_eat_diff adl_eat_help adl_bath_diff adl_bath_help adl_toil_diff ///
adl_toil_help adl_dres_diff adl_dres_help adl_ins_help adl_ins_diff adl_bed_help ///
adl_bed_diff ind_hosp_adm_p12m ind_ed_adm_p12m ind_icu_p12m died_12 housecalls_90
local cvars2 tot_paid_by_mc_12m housecalls_count

local full `cvars1' `ivars1' `ivars2' `ivars3' `cvars2'

local rd: word count `full' 1

mat tab1 = J(`rd',2,.)
mat stars = J(`rd',1,0)

local r = 1
local c = 1

foreach x of local cvars1 {

sum `x' if iah_all==1
mat tab1[`r',`c'] = r(mean)

ttest `x', by(iah_all)
mat stars[`r',`c']= (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if iah_all==0
mat tab1[`r',`c'] = r(mean)

local --c
local ++r
}

foreach x of local ivars1 {

sum `x' if iah_all==1
local b = r(mean)*r(N)

sum `x' if iah_all==0 
local d = r(mean)*r(N)


sum `x' if iah_all==1
if `b'>=11 & `d'>=11 mat tab1[`r',`c'] = r(mean)*100

tab `x' iah_all, chi2
mat stars[`r',`c'] = (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if iah_all==0 
if `b'>=11 & `d'>=11 mat tab1[`r',`c'] = r(mean)*100

local --c
local ++r

}

foreach x of local ivars2 {

sum `x' if iah_all==1
local b = r(mean)*r(N)

sum `x' if iah_all==0 
local d = r(mean)*r(N)


sum `x' if iah_all==1
if `b'>=11 & `d'>=11 mat tab1[`r',`c'] = r(mean)*100

tab `x' iah_all, chi2
mat stars[`r',`c'] = (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if iah_all==0 
if `b'>=11 & `d'>=11 mat tab1[`r',`c'] = r(mean)*100

local --c
local ++r

}

foreach x of local ivars3 {

sum `x' if iah_all==1
local b = r(mean)*r(N)

sum `x' if iah_all==0 
local d = r(mean)*r(N)

sum `x' if iah_all==1
if `b'>=11 & `d'>=11 mat tab1[`r',`c'] = r(mean)*100

tab `x' iah_all, chi2
mat stars[`r',`c'] = (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if iah_all==0 
if `b'>=11 & `d'>=11 mat tab1[`r',`c'] = r(mean)*100

local --c
local ++r

}
 
foreach x of local cvars2 {

sum `x' if iah_all==1
mat tab1[`r',`c'] = r(mean)

ttest `x', by(iah_all)
mat stars[`r',`c']= (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if iah_all==0
mat tab1[`r',`c'] = r(mean)

local --c
local ++r
}

sum age if iah_all==1
mat tab1[`r',1] = r(N)

sum age if iah_all==0
mat tab1[`r',2] = r(N)


mat rownames tab1= `cvars1' `ivars1' `ivars2' `ivars3' `cvars2' N

frmttable using "E:\nhats\projects\IAH\table1_IAH.doc", replace statmat(tab1) ///
varlabels title("Table 1: IAH Unique persons per NHATS Waves 1-5 Community Dwelling + 6m FFS") ///
ctitles("" "IAH" "No IAH") sdec(2) annotate(stars) asymbol(*,**) ///
note("These are unique people, and only survey data from their most recent NHATS interview was used. *p<0.05, **p<0.01")

mat tab2 = J(`rd',2,.)
mat stars2 = J(`rd',1,0)

local r = 1
local c = 1

foreach x of local cvars1 {


sum `x' if homebound==1
mat tab2[`r',`c'] = r(mean)

ttest `x', by(homebound)
mat stars2[`r',`c']= (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if homebound==0
mat tab2[`r',`c'] = r(mean)

local --c
local ++r
}

foreach x of local ivars1 {

sum `x' if homebound==1
local b = r(mean)*r(N)

sum `x' if homebound==0 
local d = r(mean)*r(N)


sum `x' if homebound==1
if `b'>=11 & `d'>=11 mat tab2[`r',`c'] = r(mean)*100

tab `x' homebound, chi2
mat stars2[`r',`c'] = (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if homebound==0 
if `b'>=11 & `d'>=11 mat tab2[`r',`c'] = r(mean)*100

local --c
local ++r

}

foreach x of local ivars2 {

sum `x' if homebound==1
local b = r(mean)*r(N)

sum `x' if homebound==0 
local d = r(mean)*r(N)


sum `x' if homebound==1
if `b'>=11 & `d'>=11 mat tab2[`r',`c'] = r(mean)*100

tab `x' homebound, chi2
mat stars2[`r',`c'] = (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if homebound==0 
if `b'>=11 & `d'>=11 mat tab2[`r',`c'] = r(mean)*100

local --c
local ++r

}

foreach x of local ivars3 {

sum `x' if homebound==1
local b = r(mean)*r(N)

sum `x' if homebound==0 
local d = r(mean)*r(N)


sum `x' if homebound==1
if `b'>=11 & `d'>=11 mat tab2[`r',`c'] = r(mean)*100

tab `x' homebound, chi2
mat stars2[`r',`c'] = (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if homebound==0 
if `b'>=11 & `d'>=11 mat tab2[`r',`c'] = r(mean)*100

local --c
local ++r

}
 
foreach x of local cvars2 {

sum `x' if homebound==1
mat tab2[`r',`c'] = r(mean)

ttest `x', by(homebound)
mat stars2[`r',`c']= (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if homebound==0
mat tab2[`r',`c'] = r(mean)

local --c
local ++r
}

sum age if homebound==1
mat tab2[`r',1] = r(N)

sum age if homebound==0
mat tab2[`r',2] = r(N)



mat rownames tab2= `cvars1' `ivars1' `ivars2' `ivars3' `cvars2' N

frmttable using "E:\nhats\projects\IAH\table1_IAH.doc", addtable statmat(tab2) ///
varlabels title("Table 2: IAH Unique persons per NHATS Waves 1-5 Community Dwelling + 6m FFS") ///
ctitles("" "Homebound" "Not Homebound") sdec(2) annotate(stars2) asymbol(*,**) ///
note("These are unique people, and only survey data from their most recent NHATS interview was used. *p<0.05, **p<0.01")


preserve
keep if homebound==1

mat tab3 = J(`rd',2,.)
mat stars3 = J(`rd',1,0)

local r = 1
local c = 1

foreach x of local cvars1 {

sum `x' if iah_all==1
mat tab3[`r',`c'] = r(mean)

ttest `x', by(iah_all)
mat stars3[`r',`c']= (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if iah_all==0
mat tab3[`r',`c'] = r(mean)

local --c
local ++r
}

foreach x of local ivars1 {

sum `x' if iah_all==1
local b = r(mean)*r(N)

sum `x' if iah_all==0 
local d = r(mean)*r(N)

sum `x' if iah_all==1
if `b'>=11 & `d'>=11 mat tab3[`r',`c'] = r(mean)*100

tab `x' iah_all, chi2
mat stars3[`r',`c'] = (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if iah_all==0 
if `b'>=11 & `d'>=11 mat tab3[`r',`c'] = r(mean)*100

local --c
local ++r

}

foreach x of local ivars2 {

sum `x' if iah_all==1
local b = r(mean)*r(N)

sum `x' if iah_all==0 
local d = r(mean)*r(N)


sum `x' if iah_all==1
if `b'>=11 & `d'>=11 mat tab3[`r',`c'] = r(mean)*100

tab `x' iah_all, chi2
mat stars3[`r',`c'] = (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if iah_all==0 
if `b'>=11 & `d'>=11 mat tab3[`r',`c'] = r(mean)*100

local --c
local ++r

}

foreach x of local ivars3 {

sum `x' if iah_all==1
local b = r(mean)*r(N)

sum `x' if iah_all==0 
local d = r(mean)*r(N)


sum `x' if iah_all==1
if `b'>=11 & `d'>=11 mat tab3[`r',`c'] = r(mean)*100

tab `x' iah_all, chi2
mat stars3[`r',`c'] = (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if iah_all==0 
if `b'>=11 & `d'>=11 mat tab3[`r',`c'] = r(mean)*100

local --c
local ++r

}
 
foreach x of local cvars2 {

sum `x' if iah_all==1
mat tab3[`r',`c'] = r(mean)

ttest `x', by(iah_all)
mat stars3[`r',`c']= (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if iah_all==0
mat tab3[`r',`c'] = r(mean)

local --c
local ++r
}

sum age if iah_all==1
mat tab3[`r',1] = r(N)

sum age if iah_all==0
mat tab3[`r',2] = r(N)



mat rownames tab3= `cvars1' `ivars1' `ivars2' `ivars3' `cvars2' N

frmttable using "E:\nhats\projects\IAH\table1_IAH.doc", addtable statmat(tab3) ///
varlabels title("Table 3: IAH Unique persons per NHATS Waves 1-5 Community Dwelling + 6m FFS (Restricted to Homebound)") ///
ctitles("" "IAH" "Not IAH") sdec(2) annotate(stars3) asymbol(*,**) ///
note("These are unique people, and only survey data from their most recent NHATS interview was used. *p<0.05, **p<0.01")

H="Housecalls setup"
gen iah_pacute = 0
replace iah_pacute = 1 if iah_rehab==1

label var iah_pacute "IAH - Post Acute Care 12m prior"
label var iah_all "IAH - All Criteria Met"


/* Housecalls population */

merge 1:1 bene_id wave using "E:\nhats\data\Projects\IAH\int_data\homecalls_90.dta", keepus(admit_date)
drop if _m==2
*drop _m

gen housecalls_90 = 0
replace housecalls_90 = 1 if _m==3
label var housecalls_90 "1+ housecalls +/- 90 days of ivw"

keep if cont_ffs_n_mos>=6
preserve 

keep if housecalls_90==1

gsort spid -wave
by spid: gen ind=_n==1 
keep if ind==1 /* keep most recent wave where they had housecalls */
save "E:\nhats\data\Projects\IAH\int_data\housecalls.dta", replace
levelsof spid, local(list)
restore
gen droplist = 0
foreach x in `list' {

replace droplist=1 if spid==`x'
}

drop if droplist==1 /* drop spid for those who have housecalls */

gsort spid -wave
by spid: gen ind=_n==1
keep if ind==1 /* keep most recent nonhousecalls */
cap drop _m
append using "E:\nhats\data\Projects\IAH\int_data\housecalls.dta"

cap drop st_date
save "E:\nhats\data\Projects\IAH\final_data\housecalls.dta", replace 

use "E:\nhats\data\Projects\serious_ill\final_data\serious_ill_nhats_sample.dta", replace

keep if wave==1
gen old = 1
label var old "Original Cohort in Wave 1"
tempfile old
gen st_date = index_date - 90 
label var st_date "Start of observation period, 90 days pre ivw"

save `old'

use "E:\nhats\data\Projects\IAH\final_data\housecalls.dta", clear
cap drop _m
merge 1:1 spid using "`old'", keepus(old st_date) update replace
drop if _m==2
drop _m

replace old = 0 if old==.

replace st_date = ivw_date - 90 if wave==5 & st_date==.

gen end_dt = ivw_date + 90

gen person_time = admit_date - st_date
replace person_time = end_dt - st_date if person_time==.
replace person_time = person_time*0.00273

egen person_yrs = total(person_time)

save "E:\nhats\data\Projects\IAH\final_data\housecalls.dta", replace 


H="Housecalls Table"

use "E:\nhats\data\Projects\IAH\final_data\housecalls.dta", clear 


local cvars1 age income_quart_1 income_quart_2 income_quart_3 income_quart_4 // score_community
local ivars1 income_cat_1 income_cat_2 income_cat_3 income_cat_4 female white  ///
black hisp married livealone rcfres educ_hs_ind reg_doc_have reg_doc_seen ///
homebound medicaid metro_ind northeast midwest south west
local ivars2 iah_adl iah_chronic iah_nonelect iah_pacute iah_all sr_ami_ever sr_stroke_ever ///
sr_cancer_ever sr_hip_ever sr_heart_dis_ever sr_htn_ever sr_ra_ever sr_osteoprs_ever ///
sr_diabetes_ever sr_dementia_ever prob_dem pos_dem
local ivars3 adl_eat_diff adl_eat_help adl_bath_diff adl_bath_help adl_toil_diff ///
adl_toil_help adl_dres_diff adl_dres_help adl_ins_help adl_ins_diff adl_bed_help ///
adl_bed_diff ind_hosp_adm_p12m ind_ed_adm_p12m ind_icu_p12m died_12 housecalls_90 mc_hh
local cvars2 tot_paid_by_mc_12m housecalls_count

local full `cvars1' `ivars1' `ivars2' `ivars3' `cvars2'

local rd: word count `full' 1

mat tab1 = J(`rd',2,.)
mat stars = J(`rd',1,0)

local r = 1
local c = 1

foreach x of local cvars1 {

sum `x' if housecalls_90==1
mat tab1[`r',`c'] = r(mean)

ttest `x', by(housecalls_90)
mat stars[`r',`c']= (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if housecalls_90==0
mat tab1[`r',`c'] = r(mean)

local --c
local ++r
}

foreach x of local ivars1 {

sum `x' if housecalls_90==1
local b = r(mean)*r(N)

sum `x' if housecalls_90==0 
local d = r(mean)*r(N)


sum `x' if housecalls_90==1
mat tab1[`r',`c'] = r(mean)*100

tab `x' housecalls_90, chi2
mat stars[`r',`c'] = (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if housecalls_90==0 
mat tab1[`r',`c'] = r(mean)*100

local --c
local ++r

}

foreach x of local ivars2 {

sum `x' if housecalls_90==1
local b = r(mean)*r(N)

sum `x' if housecalls_90==0 
local d = r(mean)*r(N)

sum `x' if housecalls_90==1
mat tab1[`r',`c'] = r(mean)*100

tab `x' housecalls_90, chi2
mat stars[`r',`c'] = (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if housecalls_90==0 
mat tab1[`r',`c'] = r(mean)*100

local --c
local ++r

}

foreach x of local ivars3 {

sum `x' if housecalls_90==1
local b = r(mean)*r(N)

sum `x' if housecalls_90==0 
local d = r(mean)*r(N)


sum `x' if housecalls_90==1
mat tab1[`r',`c'] = r(mean)*100

tab `x' housecalls_90, chi2
mat stars[`r',`c'] = (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if housecalls_90==0 
mat tab1[`r',`c'] = r(mean)*100

local --c
local ++r

}
 
foreach x of local cvars2 {

sum `x' if housecalls_90==1
mat tab1[`r',`c'] = r(mean)

ttest `x', by(housecalls_90)
mat stars[`r',`c']= (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if housecalls_90==0
mat tab1[`r',`c'] = r(mean)

local --c
local ++r
}

sum age if housecalls_90==1
mat tab1[`r',1] = r(N)

sum age if housecalls_90==0
mat tab1[`r',2] = r(N)


mat rownames tab1= `cvars1' `ivars1' `ivars2' `ivars3' `cvars2' N

frmttable using "E:\nhats\projects\IAH\table1_housecalls.doc", replace statmat(tab1) ///
varlabels title("Table 1: Housecalls Unique persons per NHATS Waves 1-5 Community Dwelling + 6m FFS") ///
ctitles("" "Housecalls" "No Housecalls") sdec(2) annotate(stars) asymbol(*,**) ///
note("These are unique people, and only survey data from their most recent NHATS interview was used. Housecalls are +/- 90 days of ivw date. *p<0.05, **p<0.01")

mat tab2 = J(`rd',2,.)
mat stars2 = J(`rd',1,0)

local r = 1
local c = 1

foreach x of local cvars1 {

sum `x' if homebound==1
mat tab2[`r',`c'] = r(mean)

ttest `x', by(homebound)
mat stars2[`r',`c']= (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if homebound==0
mat tab2[`r',`c'] = r(mean)

local --c
local ++r
}

foreach x of local ivars1 {

sum `x' if homebound==1
local b = r(mean)*r(N)

sum `x' if homebound==0 
local d = r(mean)*r(N)

sum `x' if homebound==1
mat tab2[`r',`c'] = r(mean)*100

tab `x' homebound, chi2
mat stars2[`r',`c'] = (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if homebound==0 
mat tab2[`r',`c'] = r(mean)*100

local --c
local ++r

}

foreach x of local ivars2 {

sum `x' if homebound==1
local b = r(mean)*r(N)

sum `x' if homebound==0 
local d = r(mean)*r(N)

sum `x' if homebound==1
mat tab2[`r',`c'] = r(mean)*100

tab `x' homebound, chi2
mat stars2[`r',`c'] = (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if homebound==0 
mat tab2[`r',`c'] = r(mean)*100

local --c
local ++r

}

foreach x of local ivars3 {

sum `x' if homebound==1
local b = r(mean)*r(N)

sum `x' if homebound==0 
local d = r(mean)*r(N)

sum `x' if homebound==1
mat tab2[`r',`c'] = r(mean)*100

tab `x' homebound, chi2
mat stars2[`r',`c'] = (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if homebound==0 
mat tab2[`r',`c'] = r(mean)*100

local --c
local ++r

}
 
foreach x of local cvars2 {

sum `x' if homebound==1
mat tab2[`r',`c'] = r(mean)

ttest `x', by(homebound)
mat stars2[`r',`c']= (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if homebound==0
mat tab2[`r',`c'] = r(mean)

local --c
local ++r
}

sum age if homebound==1
mat tab2[`r',1] = r(N)

sum age if homebound==0
mat tab2[`r',2] = r(N)



mat rownames tab2= `cvars1' `ivars1' `ivars2' `ivars3' `cvars2' N

frmttable using "E:\nhats\projects\IAH\table1_housecalls.doc", addtable statmat(tab2) ///
varlabels title("Table 2: Housecalls Unique persons per NHATS Waves 1-5 Community Dwelling + 6m FFS") ///
ctitles("" "Homebound" "Not Homebound") sdec(2) annotate(stars2) asymbol(*,**) ///
note("These are unique people, and only survey data from their most recent NHATS interview was used. Housecalls are +/- 90 days of ivw date. *p<0.05, **p<0.01")


preserve
keep if homebound==1

mat tab3 = J(`rd',2,.)
mat stars3 = J(`rd',1,0)

local r = 1
local c = 1

foreach x of local cvars1 {

sum `x' if housecalls_90==1
mat tab3[`r',`c'] = r(mean)

ttest `x', by(housecalls_90)
mat stars3[`r',`c']= (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if housecalls_90==0
mat tab3[`r',`c'] = r(mean)

local --c
local ++r
}

foreach x of local ivars1 {

sum `x' if housecalls_90==1
local b = r(mean)*r(N)

sum `x' if housecalls_90==0 
local d = r(mean)*r(N)

sum `x' if housecalls_90==1
mat tab3[`r',`c'] = r(mean)*100

tab `x' housecalls_90, chi2
mat stars3[`r',`c'] = (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if housecalls_90==0 
mat tab3[`r',`c'] = r(mean)*100

local --c
local ++r

}

foreach x of local ivars2 {

sum `x' if housecalls_90==1
local b = r(mean)*r(N)

sum `x' if housecalls_90==0 
local d = r(mean)*r(N)

sum `x' if housecalls_90==1
mat tab3[`r',`c'] = r(mean)*100

tab `x' housecalls_90, chi2
mat stars3[`r',`c'] = (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if housecalls_90==0 
mat tab3[`r',`c'] = r(mean)*100

local --c
local ++r

}

foreach x of local ivars3 {

sum `x' if housecalls_90==1
local b = r(mean)*r(N)

sum `x' if housecalls_90==0 
local d = r(mean)*r(N)

sum `x' if housecalls_90==1
mat tab3[`r',`c'] = r(mean)*100

tab `x' housecalls_90, chi2
mat stars3[`r',`c'] = (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if housecalls_90==0 
mat tab3[`r',`c'] = r(mean)*100

local --c
local ++r

}
 
foreach x of local cvars2 {

sum `x' if housecalls_90==1
mat tab3[`r',`c'] = r(mean)

ttest `x', by(housecalls_90)
mat stars3[`r',`c']= (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if housecalls_90==0
mat tab3[`r',`c'] = r(mean)

local --c
local ++r
}

sum age if housecalls_90==1
mat tab3[`r',1] = r(N)

sum age if housecalls_90==0
mat tab3[`r',2] = r(N)



mat rownames tab3= `cvars1' `ivars1' `ivars2' `ivars3' `cvars2' N

frmttable using "E:\nhats\projects\IAH\table1_housecalls.doc", addtable statmat(tab3) ///
varlabels title("Table 3: Housecalls Unique persons per NHATS Waves 1-5 Community Dwelling + 6m FFS (Restricted to Homebound)") ///
ctitles("" "Housecalls" "No HouseCalls") sdec(2) annotate(stars3) asymbol(*,**) ///
note("These are unique people, and only survey data from their most recent NHATS interview was used. Housecalls are +/- 90 days of ivw date. *p<0.05, **p<0.01")


H="Housecalls table (censored)"

use "E:\nhats\data\Projects\IAH\final_data\housecalls.dta", clear 


local cvars1 age income_quart_1 income_quart_2 income_quart_3 income_quart_4 // score_community
local ivars1 income_cat_1 income_cat_2 income_cat_3 income_cat_4 female white  ///
black hisp married livealone rcfres educ_hs_ind reg_doc_have reg_doc_seen ///
homebound medicaid metro_ind northeast midwest south west
local ivars2 iah_adl iah_chronic iah_nonelect iah_pacute iah_all sr_ami_ever sr_stroke_ever ///
sr_cancer_ever sr_hip_ever sr_heart_dis_ever sr_htn_ever sr_ra_ever sr_osteoprs_ever ///
sr_diabetes_ever sr_dementia_ever prob_dem pos_dem
local ivars3 adl_eat_diff adl_eat_help adl_bath_diff adl_bath_help adl_toil_diff ///
adl_toil_help adl_dres_diff adl_dres_help adl_ins_help adl_ins_diff adl_bed_help ///
adl_bed_diff ind_hosp_adm_p12m ind_ed_adm_p12m ind_icu_p12m died_12 housecalls_90 mc_hh
local cvars2 tot_paid_by_mc_12m housecalls_count

local full `cvars1' `ivars1' `ivars2' `ivars3' `cvars2'

local rd: word count `full' 1

mat tab1 = J(`rd',2,.)
mat stars = J(`rd',1,0)

local r = 1
local c = 1

foreach x of local cvars1 {

sum `x' if housecalls_90==1
mat tab1[`r',`c'] = r(mean)

ttest `x', by(housecalls_90)
mat stars[`r',`c']= (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if housecalls_90==0
mat tab1[`r',`c'] = r(mean)

local --c
local ++r
}

foreach x of local ivars1 {

sum `x' if housecalls_90==1
local b = r(mean)*r(N)

sum `x' if housecalls_90==0 
local d = r(mean)*r(N)


sum `x' if housecalls_90==1
if `b'>=11 & `d'>=11 mat tab1[`r',`c'] = r(mean)*100

tab `x' housecalls_90, chi2
mat stars[`r',`c'] = (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if housecalls_90==0 
if `b'>=11 & `d'>=11 mat tab1[`r',`c'] = r(mean)*100

local --c
local ++r

}

foreach x of local ivars2 {

sum `x' if housecalls_90==1
local b = r(mean)*r(N)

sum `x' if housecalls_90==0 
local d = r(mean)*r(N)

sum `x' if housecalls_90==1
if `b'>=11 & `d'>=11 mat tab1[`r',`c'] = r(mean)*100

tab `x' housecalls_90, chi2
mat stars[`r',`c'] = (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if housecalls_90==0 
if `b'>=11 & `d'>=11 mat tab1[`r',`c'] = r(mean)*100

local --c
local ++r

}

foreach x of local ivars3 {

sum `x' if housecalls_90==1
local b = r(mean)*r(N)

sum `x' if housecalls_90==0 
local d = r(mean)*r(N)


sum `x' if housecalls_90==1
if `b'>=11 & `d'>=11 mat tab1[`r',`c'] = r(mean)*100

tab `x' housecalls_90, chi2
mat stars[`r',`c'] = (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if housecalls_90==0 
if `b'>=11 & `d'>=11 mat tab1[`r',`c'] = r(mean)*100

local --c
local ++r

}
 
foreach x of local cvars2 {

sum `x' if housecalls_90==1
mat tab1[`r',`c'] = r(mean)

ttest `x', by(housecalls_90)
mat stars[`r',`c']= (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if housecalls_90==0
mat tab1[`r',`c'] = r(mean)

local --c
local ++r
}

sum age if housecalls_90==1
mat tab1[`r',1] = r(N)

sum age if housecalls_90==0
mat tab1[`r',2] = r(N)


mat rownames tab1= `cvars1' `ivars1' `ivars2' `ivars3' `cvars2' N

frmttable using "E:\nhats\projects\IAH\table1_housecalls_censored.doc", replace statmat(tab1) ///
varlabels title("Table 1: Housecalls Unique persons per NHATS Waves 1-5 Community Dwelling + 6m FFS") ///
ctitles("" "Housecalls" "No Housecalls") sdec(2) annotate(stars) asymbol(*,**) ///
note("These are unique people, and only survey data from their most recent NHATS interview was used. Housecalls are +/- 90 days of ivw date. *p<0.05, **p<0.01")

mat tab2 = J(`rd',2,.)
mat stars2 = J(`rd',1,0)

local r = 1
local c = 1

foreach x of local cvars1 {

sum `x' if homebound==1
mat tab2[`r',`c'] = r(mean)

ttest `x', by(homebound)
mat stars2[`r',`c']= (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if homebound==0
mat tab2[`r',`c'] = r(mean)

local --c
local ++r
}

foreach x of local ivars1 {

sum `x' if homebound==1
local b = r(mean)*r(N)

sum `x' if homebound==0 
local d = r(mean)*r(N)

sum `x' if homebound==1
if `b'>=11 & `d'>=11 mat tab2[`r',`c'] = r(mean)*100

tab `x' homebound, chi2
mat stars2[`r',`c'] = (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if homebound==0 
if `b'>=11 & `d'>=11 mat tab2[`r',`c'] = r(mean)*100

local --c
local ++r

}

foreach x of local ivars2 {

sum `x' if homebound==1
local b = r(mean)*r(N)

sum `x' if homebound==0 
local d = r(mean)*r(N)

sum `x' if homebound==1
if `b'>=11 & `d'>=11 mat tab2[`r',`c'] = r(mean)*100

tab `x' homebound, chi2
mat stars2[`r',`c'] = (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if homebound==0 
if `b'>=11 & `d'>=11 mat tab2[`r',`c'] = r(mean)*100

local --c
local ++r

}

foreach x of local ivars3 {

sum `x' if homebound==1
local b = r(mean)*r(N)

sum `x' if homebound==0 
local d = r(mean)*r(N)

sum `x' if homebound==1
if `b'>=11 & `d'>=11 mat tab2[`r',`c'] = r(mean)*100

tab `x' homebound, chi2
mat stars2[`r',`c'] = (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if homebound==0 
if `b'>=11 & `d'>=11 mat tab2[`r',`c'] = r(mean)*100

local --c
local ++r

}
 
foreach x of local cvars2 {

sum `x' if homebound==1
mat tab2[`r',`c'] = r(mean)

ttest `x', by(homebound)
mat stars2[`r',`c']= (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if homebound==0
mat tab2[`r',`c'] = r(mean)

local --c
local ++r
}

sum age if homebound==1
mat tab2[`r',1] = r(N)

sum age if homebound==0
mat tab2[`r',2] = r(N)



mat rownames tab2= `cvars1' `ivars1' `ivars2' `ivars3' `cvars2' N

frmttable using "E:\nhats\projects\IAH\table1_housecalls_censored.doc", addtable statmat(tab2) ///
varlabels title("Table 2: Housecalls Unique persons per NHATS Waves 1-5 Community Dwelling + 6m FFS") ///
ctitles("" "Homebound" "Not Homebound") sdec(2) annotate(stars2) asymbol(*,**) ///
note("These are unique people, and only survey data from their most recent NHATS interview was used. Housecalls are +/- 90 days of ivw date. *p<0.05, **p<0.01")


preserve
keep if homebound==1

mat tab3 = J(`rd',2,.)
mat stars3 = J(`rd',1,0)

local r = 1
local c = 1

foreach x of local cvars1 {

sum `x' if housecalls_90==1
mat tab3[`r',`c'] = r(mean)

ttest `x', by(housecalls_90)
mat stars3[`r',`c']= (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if housecalls_90==0
mat tab3[`r',`c'] = r(mean)

local --c
local ++r
}

foreach x of local ivars1 {

sum `x' if housecalls_90==1
local b = r(mean)*r(N)

sum `x' if housecalls_90==0 
local d = r(mean)*r(N)

sum `x' if housecalls_90==1
if `b'>=11 & `d'>=11 mat tab3[`r',`c'] = r(mean)*100

tab `x' housecalls_90, chi2
mat stars3[`r',`c'] = (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if housecalls_90==0 
if `b'>=11 & `d'>=11 mat tab3[`r',`c'] = r(mean)*100

local --c
local ++r

}

foreach x of local ivars2 {

sum `x' if housecalls_90==1
local b = r(mean)*r(N)

sum `x' if housecalls_90==0 
local d = r(mean)*r(N)

sum `x' if housecalls_90==1
if `b'>=11 & `d'>=11 mat tab3[`r',`c'] = r(mean)*100

tab `x' housecalls_90, chi2
mat stars3[`r',`c'] = (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if housecalls_90==0 
if `b'>=11 & `d'>=11 mat tab3[`r',`c'] = r(mean)*100

local --c
local ++r

}

foreach x of local ivars3 {

sum `x' if housecalls_90==1
local b = r(mean)*r(N)

sum `x' if housecalls_90==0 
local d = r(mean)*r(N)

sum `x' if housecalls_90==1
if `b'>=11 & `d'>=11 mat tab3[`r',`c'] = r(mean)*100

tab `x' housecalls_90, chi2
mat stars3[`r',`c'] = (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if housecalls_90==0 
if `b'>=11 & `d'>=11 mat tab3[`r',`c'] = r(mean)*100

local --c
local ++r

}
 
foreach x of local cvars2 {

sum `x' if housecalls_90==1
mat tab3[`r',`c'] = r(mean)

ttest `x', by(housecalls_90)
mat stars3[`r',`c']= (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if housecalls_90==0
mat tab3[`r',`c'] = r(mean)

local --c
local ++r
}

sum age if housecalls_90==1
mat tab3[`r',1] = r(N)

sum age if housecalls_90==0
mat tab3[`r',2] = r(N)



mat rownames tab3= `cvars1' `ivars1' `ivars2' `ivars3' `cvars2' N

frmttable using "E:\nhats\projects\IAH\table1_housecalls_censored.doc", addtable statmat(tab3) ///
varlabels title("Table 3: Housecalls Unique persons per NHATS Waves 1-5 Community Dwelling + 6m FFS (Restricted to Homebound)") ///
ctitles("" "Housecalls" "No HouseCalls") sdec(2) annotate(stars3) asymbol(*,**) ///
note("These are unique people, and only survey data from their most recent NHATS interview was used. Housecalls are +/- 90 days of ivw date. *p<0.05, **p<0.01")


H="Get hospice indicator + LOS"
/*Get claims 1 year and 2 year before each interview*/
/*Step 2: pull claims lists using xwalk and ivw date*/

proc sort data=proj_int.index out=index1 nodupkey;
by bene_id index_year;
run;


libname medi 'E:\nhats\data\cms_DUA_28016\merged';

proc import datafile="E:\nhats\data\Projects\IAH\int_data\death_datesw1_3.dta" out=index replace; run;

/****************************************************************************/
/* Macro to pull claims lists, saves lists to int_data folder               */
/****************************************************************************/
%macro claims_pre(days_start=,days_bef_index=,yrs=,source=);

proc sql;
create table &source._meet_&days_bef_index. as select a.index_date,b.*
from index a inner join
medi.&source._&yrs. b 
on trim(left(a.bene_id))=trim(left(b.bene_id))
and &days_start<=a.index_date-b.admit_date<=&days_bef_index;
quit;

%mend;


%claims_pre(days_start=0,days_bef_index=730,yrs=09_14,source=hs);




/*hs*/
%macro hs_drop(days_bef_index=);
data hs_meet_&days_bef_index.;
set hs_meet_&days_bef_index.(keep=bene_id index_date admit_date disch_date);
run;
%mend hs_drop;


%hs_drop(days_bef_index=730);

proc sort data=hs_meet_730; by bene_id admit_date; run;

proc sort data=hs_meet_730 out=hospice nodupkey; by bene_id admit_date disch_date; run;

data hospice;
set hospice;
diff = disch_date - admit_date;
run;

proc sql;
create table hospice1 as select distinct bene_id,
sum(diff) as n_hs_days
from hospice
group by bene_id;
quit;

proc freq data=hospice1; tables n_hs_days; run;

data test; /*examine outliers with >365 hospice days prior to death */
set hospice;
where bene_id="eeeeeee6OMeqOMY";
run;

data hospice1;
set hospice1;
label n_hs_days = "Number of hospice days before death";
run;

proc export data=hospice1 outfile="E:\nhats\data\Projects\IAH\int_data\hospice_death.dta" replace; run;


H="IAH Table 1"
use "E:\nhats\nhats_code\IAH\Archive\unique_nocptpos.dta", clear 

cap drop _m
merge 1:1 bene_id wave using "E:\nhats\data\Projects\IAH\int_data\cpt+pos.dta", keepus(bflag)
cap drop _m
merge 1:1 bene_id wave using "E:\nhats\data\Projects\IAH\int_data\cpt+only.dta", keepus(cflag)
cap drop _m
merge 1:1 bene_id wave using "E:\nhats\data\Projects\IAH\int_data\pos+only.dta", keepus(posflag)
drop homebound*
/*
preserve
capture gen none = 1
replace none =0 if bflag==1 | cflag==1 |posflag==1

keep if community_dwelling==1 & ffs_6m==1

replace ind_snf_use_p12m = 0 if ind_snf_use_p12m==.

capture gen ind_icu_p12m = 0
replace ind_icu_p12m = 1 if icu_days_p12m>0
label var ind_icu_p12m "ICU use 12m post ivw"

label var iah_adl "IAH - 2+ ADL Impairment"
label var iah_chronic "IAH - 2+ Chronic Conditions"
label var iah_nonelect "IAH - Nonelective admission 12m pre ivw"
label var iah_pacute "IAH - Post Acute Care 12m prior"

label var tot_paid_by_mc_12m "Total Paid by Medicare 12m post ivw"
label var died_12 "Died within 12m post ivw"

local sr_con adl_eat_diff adl_eat_help adl_bath_diff adl_bath_help adl_toil_diff adl_toil_help adl_dres_diff adl_dres_help adl_ins_help adl_ins_diff adl_bed_help adl_bed_diff
foreach x of local sr_con {
tab `x'
replace `x' = 0 if `x'==.
}

label var adl_ins_diff "Difficulty getting around inside"
label var adl_bed_diff "Difficulty getting out of bed"
label var iah_all "IAH - All Criteria Met"
label var adl_eat_diff "Difficulting Eating"
label var adl_bath_diff "Difficulty bathing"
label var adl_dres_diff "Has Difficulty Dressing"

capture egen recent_yr = max(index_year), by(bene_id)

keep if recent_yr==index_year

save unique_nocptpos.dta, replace 

append using cpt+pos.dta
capture gen ind_cpt = 1

keep bene_id wave ind_cpt 

save cpt+pos.dta, replace

restore, preserve
*/
capture gen northeast = 0
replace northeast = 1 if re1dcensdiv==1 | re1dcensdiv==2 | re2dcensdiv==1 | re2dcensdiv==2 | re3dcensdiv==1 | re3dcensdiv==2

capture gen midwest = 0
replace midwest = 1 if re1dcensdiv==3 | re1dcensdiv==4 | re2dcensdiv==3 | re2dcensdiv==4 | re3dcensdiv==3 | re3dcensdiv==4

capture gen west = 0
replace west = 1 if re1dcensdiv==8 | re1dcensdiv==9 | re2dcensdiv==8 | re2dcensdiv==9 | re3dcensdiv==8 | re3dcensdiv==9

capture gen south = 0
replace south = 1 if northeast==0 & west==0 & midwest==0

cap drop _m
*merge m:1 bene_id using cpt+pos.dta, keepus(ind_cpt)

cap drop _m

merge 1:1 bene_id wave using "E:\nhats\data\Projects\IAH\int_data\annualcpt_count.dta"
drop if _m==2
label var housecalls_count "Ave. number of house calls in calendar year of interview"

replace housecalls_count = 0 if housecalls_count==.

cap drop _m
drop adl_bed_diff adl_ins_diff
cap drop _m
merge m:1 spid wave using "E:\nhats\data\NHATS cleaned\sp_round_1_6_public_sens_only.dta", keepus(homebound* adl_bed_diff adl_ins_diff) 
keep if _m==3

cap drop _m
drop anfinwgt

merge 1:1 spid using "E:\nhats\data\NHATS cleaned\wave1.dta", keepus(anfinwgt)
keep if _m==3

levelsof homebound_cat, local(levels)
local hb
foreach l of local levels {
	gen homebound`l'=homebound_cat==`l'
	local lab : label hb `l'
	label var homebound`l' "`lab'"
	local hb `hb' homebound`l'
}

svyset varunit [pweight=anfinwgt], strata(varstrat)

label var adl_bed_diff "Difficulty getting out of bed"
label var adl_ins_diff "Difficulty getting around inside"
gen ind_one_hc=housecalls_count==1
gen ind_no_hc=housecalls_count==0
label var ind_no_hc "No housecalls"
gen ind_lt3_hc=inlist(housecalls_count,1,2)
gen ind_gt2_hc=inrange(housecalls_count,3,365)
label var ind_one_hc "Exactly one housecall"
label var ind_lt3_hc "1 or 2 housecalls"
label var ind_gt2_hc "3+ Housecalls"
local cvars1 age aveincome
local ivars1 female white black hisp married livealone rcfres educ_hs_ind reg_doc_have reg_doc_seen ///
`hb' medicaid metro_ind northeast midwest south west
local ivars2 iah_adl iah_chronic iah_nonelect iah_pacute iah_all sr_ami_ever sr_stroke_ever ///
sr_cancer_ever sr_hip_ever sr_heart_dis_ever sr_htn_ever sr_ra_ever sr_osteoprs_ever ///
sr_diabetes_ever sr_dementia_ever prob_dem
local ivars3 ind_no_hc ind_one_hc ind_lt3_hc ind_gt2_hc adl_eat_diff adl_eat_help adl_bath_diff adl_bath_help adl_toil_diff ///
adl_toil_help adl_dres_diff adl_dres_help adl_ins_help adl_ins_diff adl_bed_help ///
adl_bed_diff ind_hosp_adm_p12m ind_ed_adm_p12m ind_icu_p12m died_12
local cvars2 tot_paid_by_mc_12m housecalls_count

local rd: word count `cvars1' `ivars1' `ivars2' `ivars3' `cvars2' 1 1 1 1 1

mat tab1 = J(`rd',2,.)
mat stars = J(`rd',2,0)

local r = 1
local c = 1
foreach x of local cvars1 {
svy: mean `x', over(ind_cpt)
mat tab1[`r',1] = el(e(b),1,2)
mat tab1[`r',2] = el(e(b),1,1)

test [`x']0 = [`x']1

mat stars[`r',1]=(r(p)<.01) + (r(p)<.05)

local ++r
}

foreach x of local ivars1 {

svy: mean `x', over(ind_cpt)
mat tab1[`r',1] = el(e(b),1,2)*100
mat tab1[`r',2] = el(e(b),1,1)*100

svy: tab `x' ind_cpt, pea
mat stars[`r',1]=(e(p_Pear)<.01) + (e(p_Pear)<.05)

/*
qui sum `x' if posflag==1
mat tab1[`r',3] = r(mean)*100

qui sum `x' if none==1
mat tab1[`r',4] = r(mean)*100
*/
local ++r
}


foreach x of local ivars2 {

svy: mean `x', over(ind_cpt)
mat tab1[`r',1] = el(e(b),1,2)*100
mat tab1[`r',2] = el(e(b),1,1)*100

svy: tab `x' ind_cpt, pea
mat stars[`r',1]=(e(p_Pear)<.01) + (e(p_Pear)<.05)

/*
qui sum `x' if posflag==1
mat tab1[`r',3] = r(mean)*100

qui sum `x' if none==1
mat tab1[`r',4] = r(mean)*100
*/
local ++r
}



foreach x of local ivars3 {

svy: mean `x', over(ind_cpt)
mat tab1[`r',1] = el(e(b),1,2)*100
mat tab1[`r',2] = el(e(b),1,1)*100

svy: tab `x' ind_cpt, pea
mat stars[`r',1]=(e(p_Pear)<.01) + (e(p_Pear)<.05)

/*
qui sum `x' if posflag==1
mat tab1[`r',3] = r(mean)*100

qui sum `x' if none==1
mat tab1[`r',4] = r(mean)*100
*/
local ++r
}

foreach x of local cvars2 {
svy: mean `x', over(ind_cpt)
mat tab1[`r',1] = el(e(b),1,2)
mat tab1[`r',2] = el(e(b),1,1)

test [`x']0 = [`x']1

mat stars[`r',1]=(r(p)<.01) + (r(p)<.05)

local ++r

/*
qui sum `x' if posflag==1
mat tab1[`r',3] = r(mean)

qui sum `x' if none==1
mat tab1[`r',4] = r(mean)
*/
}

sum housecalls_count if ind_cpt==1
mat tab1[`r',1]=r(min)
local ++r
mat tab1[`r',1]=r(max)
local ++r
mat tab1[`r',1]=2
local ++r


sum age if ind_cpt==1
mat tab1[`r',1] = r(N)

sum age if ind_cpt==0
mat tab1[`r',2] = r(N)
local ++r 
svy, subpop(if ind_cpt==1): mean age
mat tab1[`r',1] = e(N_subpop)

svy, subpop(if ind_cpt==0): mean age
mat tab1[`r',2] = e(N_subpop)

mat rownames tab1 = `cvars1' `ivars1' `ivars2' `ivars3' `cvars2' ///
"Minimum number of house calls" "Maximum number of housecalls" "Median House Calls" ///
"N" "Weighted Sample Size"

mat list tab1

frmttable using "E:\nhats\data\projects\IAH\logs\table1_weighted_evan.doc", replace statmat(tab1) ///
varlabels title("Table 1: IAH Unique persons per NHATS Waves 1-3 Community Dwelling + 6m FFS (Weighted)") ///
ctitles("" "CPT+POS" "No House Calls") sdec(2) annotate(stars) asymbol(*,**) ///
note("These are unique people, and only survey data from their most recent NHATS interview was used. *p<0.05, **p<0.01")
gen hb=homebound1

foreach cpt in 1 0 {

local rd: word count `cvars1' `ivars1' `ivars2' `ivars3' `cvars2' 1 1 1 1 1 

mat tab1 = J(`rd',2,.)
mat stars = J(`rd',2,0)

local r = 1
local c = 1
foreach x of local cvars1 {
svy, subpop(if ind_cpt==`cpt'): mean `x', over(hb)
mat tab1[`r',1] = el(e(b),1,2)
mat tab1[`r',2] = el(e(b),1,1)

test [`x']0 = [`x']1

mat stars[`r',1]=(r(p)<.01) + (r(p)<.05)

local ++r
}

foreach x of local ivars1 {

svy, subpop(if ind_cpt==`cpt'): mean `x', over(hb)
mat tab1[`r',1] = el(e(b),1,2)*100
mat tab1[`r',2] = el(e(b),1,1)*100

svy, subpop(if ind_cpt==`cpt'): tab `x' hb, pea
mat stars[`r',1]=(e(p_Pear)<.01) + (e(p_Pear)<.05)

/*
qui sum `x' if posflag==1
mat tab1[`r',3] = r(mean)*100

qui sum `x' if none==1
mat tab1[`r',4] = r(mean)*100
*/
local ++r
}


foreach x of local ivars2 {

svy, subpop(if ind_cpt==`cpt'): mean `x', over(hb)
mat tab1[`r',1] = el(e(b),1,2)*100
mat tab1[`r',2] = el(e(b),1,1)*100

svy, subpop(if ind_cpt==`cpt'): tab `x' hb, pea
mat stars[`r',1]=(e(p_Pear)<.01) + (e(p_Pear)<.05)

/*
qui sum `x' if posflag==1
mat tab1[`r',3] = r(mean)*100

qui sum `x' if none==1
mat tab1[`r',4] = r(mean)*100
*/
local ++r
}



foreach x of local ivars3 {

svy, subpop(if ind_cpt==`cpt'): mean `x', over(hb)
mat tab1[`r',1] = el(e(b),1,2)*100
mat tab1[`r',2] = el(e(b),1,1)*100

svy, subpop(if ind_cpt==`cpt'): tab `x' hb, pea
mat stars[`r',1]=(e(p_Pear)<.01) + (e(p_Pear)<.05)

/*
qui sum `x' if posflag==1
mat tab1[`r',3] = r(mean)*100

qui sum `x' if none==1
mat tab1[`r',4] = r(mean)*100
*/
local ++r
}

foreach x of local cvars2 {
svy, subpop(if ind_cpt==`cpt'): mean `x', over(hb)
mat tab1[`r',1] = el(e(b),1,2)
mat tab1[`r',2] = el(e(b),1,1)

test [`x']0 = [`x']1

mat stars[`r',1]=(r(p)<.01) + (r(p)<.05)

local ++r

/*
qui sum `x' if posflag==1
mat tab1[`r',3] = r(mean)

qui sum `x' if none==1
mat tab1[`r',4] = r(mean)
*/
}

sum housecalls_count if hb==1
mat tab1[`r',1]=r(min)
local ++r
mat tab1[`r',1]=r(max)
local ++r
mat tab1[`r',1]=2
local ++r

sum age if ind_cpt==`cpt' & hb==0
mat tab1[`r',2] = r(N)
sum age if ind_cpt==`cpt' & hb==1
mat tab1[`r',1] = r(N)

local r=`r'+1
svy, subpop(if ind_cpt==`cpt' & hb==0): mean age
mat tab1[`r',2] = e(N_subpop)
svy, subpop(if ind_cpt==`cpt' & hb==1): mean age
mat tab1[`r',1] = e(N_subpop)



mat rownames tab1 = `cvars1' `ivars1' `ivars2' `ivars3' `cvars2' ///
"Minimum number of house calls" "Maximum number of housecalls" "Median House Calls" ///
"N" "Weighted Sample Size"

mat list tab1
local housecall "1+ Housecall"
if `cpt'==0 local housecall "No Housecalls"
frmttable using "E:\nhats\data\projects\IAH\logs\table1_weighted_evan.doc", addtable statmat(tab1) ///
varlabels title("Table 1: IAH Unique persons per NHATS Waves 1-3 Community Dwelling + 6m FFS (Weighted) & `housecall'") ///
ctitles("" "Homebound" "Non-Homebound") sdec(2) annotate(stars) asymbol(*,**) ///
note("These are unique people, and only survey data from their most recent NHATS interview was used. *p<0.05, **p<0.01")

}

preserve
foreach cpt in 1  {
replace hb=ind_one_hc==1
local rd: word count `cvars1' `ivars1' `ivars2' `ivars3' `cvars2' 1 1 1 1 1 

mat tab1 = J(`rd',2,.)
mat stars = J(`rd',2,0)

local r = 1
local c = 1
foreach x of local cvars1 {
svy, subpop(if ind_cpt==`cpt'): mean `x', over(hb)
mat tab1[`r',1] = el(e(b),1,2)
mat tab1[`r',2] = el(e(b),1,1)

test [`x']0 = [`x']1

mat stars[`r',1]=(r(p)<.01) + (r(p)<.05)

local ++r
}

foreach x of local ivars1 {

svy, subpop(if ind_cpt==`cpt'): mean `x', over(hb)
mat tab1[`r',1] = el(e(b),1,2)*100
mat tab1[`r',2] = el(e(b),1,1)*100

svy, subpop(if ind_cpt==`cpt'): tab `x' hb, pea
mat stars[`r',1]=(e(p_Pear)<.01) + (e(p_Pear)<.05)

/*
qui sum `x' if posflag==1
mat tab1[`r',3] = r(mean)*100

qui sum `x' if none==1
mat tab1[`r',4] = r(mean)*100
*/
local ++r
}


foreach x of local ivars2 {

svy, subpop(if ind_cpt==`cpt'): mean `x', over(hb)
mat tab1[`r',1] = el(e(b),1,2)*100
mat tab1[`r',2] = el(e(b),1,1)*100

svy, subpop(if ind_cpt==`cpt'): tab `x' hb, pea
mat stars[`r',1]=(e(p_Pear)<.01) + (e(p_Pear)<.05)

/*
qui sum `x' if posflag==1
mat tab1[`r',3] = r(mean)*100

qui sum `x' if none==1
mat tab1[`r',4] = r(mean)*100
*/
local ++r
}



foreach x of local ivars3 {

svy, subpop(if ind_cpt==`cpt'): mean `x', over(hb)
mat tab1[`r',1] = el(e(b),1,2)*100
mat tab1[`r',2] = el(e(b),1,1)*100

svy, subpop(if ind_cpt==`cpt'): tab `x' hb, pea
mat stars[`r',1]=(e(p_Pear)<.01) + (e(p_Pear)<.05)

/*
qui sum `x' if posflag==1
mat tab1[`r',3] = r(mean)*100

qui sum `x' if none==1
mat tab1[`r',4] = r(mean)*100
*/
local ++r
}

foreach x of local cvars2 {
svy, subpop(if ind_cpt==`cpt'): mean `x', over(hb)
mat tab1[`r',1] = el(e(b),1,2)
mat tab1[`r',2] = el(e(b),1,1)

test [`x']0 = [`x']1

mat stars[`r',1]=(r(p)<.01) + (r(p)<.05)

local ++r

/*
qui sum `x' if posflag==1
mat tab1[`r',3] = r(mean)

qui sum `x' if none==1
mat tab1[`r',4] = r(mean)
*/
}

sum housecalls_count if hb==1
mat tab1[`r',1]=r(min)
local ++r
mat tab1[`r',1]=r(max)
local ++r
mat tab1[`r',1]=2
local ++r

sum age if ind_cpt==`cpt' & hb==0
mat tab1[`r',2] = r(N)
sum age if ind_cpt==`cpt' & hb==1
mat tab1[`r',1] = r(N)

local r=`r'+1
svy, subpop(if ind_cpt==`cpt' & hb==0): mean age
mat tab1[`r',2] = e(N_subpop)
svy, subpop(if ind_cpt==`cpt' & hb==1): mean age
mat tab1[`r',1] = e(N_subpop)



mat rownames tab1 = `cvars1' `ivars1' `ivars2' `ivars3' `cvars2' ///
"Minimum number of house calls" "Maximum number of housecalls" "Median House Calls" ///
"N" "Weighted Sample Size"

mat list tab1
local housecall "1+ Housecall"
if `cpt'==0 local housecall "No Housecalls"
frmttable using "E:\nhats\data\projects\IAH\logs\table1_weighted_evan.doc", addtable statmat(tab1) ///
varlabels title("Table 1: IAH Unique persons per NHATS Waves 1-3 Community Dwelling + 6m FFS (Weighted) & `housecall'") ///
ctitles("" "One Housecall" "2+ Housecalls") sdec(2) annotate(stars) asymbol(*,**) ///
note("These are unique people, and only survey data from their most recent NHATS interview was used. *p<0.05, **p<0.01")

}
restore

preserve


foreach cpt in 1  {
gen cpt2=ind_cpt
replace ind_cpt=hb
replace hb=cpt2
//replace hb=ind_one_hc==1
local rd: word count `cvars1' `ivars1' `ivars2' `ivars3' `cvars2' 1 1 1 1 1 

mat tab1 = J(`rd',2,.)
mat stars = J(`rd',2,0)

local r = 1
local c = 1
foreach x of local cvars1 {
svy, subpop(if ind_cpt==`cpt'): mean `x', over(hb)
mat tab1[`r',1] = el(e(b),1,2)
mat tab1[`r',2] = el(e(b),1,1)

test [`x']0 = [`x']1

mat stars[`r',1]=(r(p)<.01) + (r(p)<.05)

local ++r
}

foreach x of local ivars1 {

svy, subpop(if ind_cpt==`cpt'): mean `x', over(hb)
mat tab1[`r',1] = el(e(b),1,2)*100
mat tab1[`r',2] = el(e(b),1,1)*100

svy, subpop(if ind_cpt==`cpt'): tab `x' hb, pea
mat stars[`r',1]=(e(p_Pear)<.01) + (e(p_Pear)<.05)

/*
qui sum `x' if posflag==1
mat tab1[`r',3] = r(mean)*100

qui sum `x' if none==1
mat tab1[`r',4] = r(mean)*100
*/
local ++r
}


foreach x of local ivars2 {

svy, subpop(if ind_cpt==`cpt'): mean `x', over(hb)
mat tab1[`r',1] = el(e(b),1,2)*100
mat tab1[`r',2] = el(e(b),1,1)*100

svy, subpop(if ind_cpt==`cpt'): tab `x' hb, pea
mat stars[`r',1]=(e(p_Pear)<.01) + (e(p_Pear)<.05)

/*
qui sum `x' if posflag==1
mat tab1[`r',3] = r(mean)*100

qui sum `x' if none==1
mat tab1[`r',4] = r(mean)*100
*/
local ++r
}



foreach x of local ivars3 {

svy, subpop(if ind_cpt==`cpt'): mean `x', over(hb)
mat tab1[`r',1] = el(e(b),1,2)*100
mat tab1[`r',2] = el(e(b),1,1)*100

svy, subpop(if ind_cpt==`cpt'): tab `x' hb, pea
mat stars[`r',1]=(e(p_Pear)<.01) + (e(p_Pear)<.05)

/*
qui sum `x' if posflag==1
mat tab1[`r',3] = r(mean)*100

qui sum `x' if none==1
mat tab1[`r',4] = r(mean)*100
*/
local ++r
}

foreach x of local cvars2 {
svy, subpop(if ind_cpt==`cpt'): mean `x', over(hb)
mat tab1[`r',1] = el(e(b),1,2)
mat tab1[`r',2] = el(e(b),1,1)

test [`x']0 = [`x']1

mat stars[`r',1]=(r(p)<.01) + (r(p)<.05)

local ++r

/*
qui sum `x' if posflag==1
mat tab1[`r',3] = r(mean)

qui sum `x' if none==1
mat tab1[`r',4] = r(mean)
*/
}

sum housecalls_count if hb==1
mat tab1[`r',1]=r(min)
local ++r
mat tab1[`r',1]=r(max)
local ++r
mat tab1[`r',1]=2
local ++r

sum age if ind_cpt==`cpt' & hb==0
mat tab1[`r',2] = r(N)
sum age if ind_cpt==`cpt' & hb==1
mat tab1[`r',1] = r(N)

local r=`r'+1
svy, subpop(if ind_cpt==`cpt' & hb==0): mean age
mat tab1[`r',2] = e(N_subpop)
svy, subpop(if ind_cpt==`cpt' & hb==1): mean age
mat tab1[`r',1] = e(N_subpop)



mat rownames tab1 = `cvars1' `ivars1' `ivars2' `ivars3' `cvars2' ///
"Minimum number of house calls" "Maximum number of housecalls" "Median House Calls" ///
"N" "Weighted Sample Size"

mat list tab1
local housecall "Homebound only"
if `cpt'==0 local housecall "No Housecalls"
frmttable using "E:\nhats\data\projects\IAH\logs\table1_weighted_evan.doc", addtable statmat(tab1) ///
varlabels title("Table 1: IAH Unique persons per NHATS Waves 1-3 Community Dwelling + 6m FFS (Weighted) & `housecall'") ///
ctitles("" "One Housecall" "2+ Housecalls") sdec(2) annotate(stars) asymbol(*,**) ///
note("These are unique people, and only survey data from their most recent NHATS interview was used. *p<0.05, **p<0.01")

}
restore




H="Get life sustaining procedures"
libname proj_int 'E:\nhats\data\projects\pal_perf_scale\int_data';

data ip_365 (drop=hcpcscd1--hcpcscd45);
set proj_int.ip_meet_365;
array list ICD_PRCDR_CD1-ICD_PRCDR_CD25;
array date PRCDR_DT1-PRCDR_DT25;
do over list;
if list ~="" then do;
pro=list+0;
procedure_date = date;
output;
end;
end;
format procedure_date date10.;
run;

data proc_long_ba;
set ip_365;
array list 
pre_intubation
pre_trach
pre_gastro_tude
pre_hemodia
pre_enteral_nut
pre_cpr;
do over list;
list=0;
end;

if length(trim(left(pro)))>=3 then do;

	if  substr(trim(left(pro)),1,3) in ("967")  then pre_intubation =1;
	if  substr(trim(left(pro)),1,3) in ("311") then  pre_trach=1;
	if  substr(trim(left(pro)),1,3) in ("432") then  pre_gastro_tude=1;

	if substr(trim(left(pro)),1,3) in ("966") then  pre_enteral_nut=1;

	if length(trim(left(pro)))>3 then do;
		if substr(trim(left(pro)),1,4) in ("9604","9605") or 
		  substr(trim(left(pro)),1,3) in ("967") then pre_intubation =1;
		if substr(trim(left(pro)),1,4) in ("3121","3129") or 
		  substr(trim(left(pro)),1,3) in ("311") then pre_trach=1;
		if substr(trim(left(pro)),1,4) in ("4311","4319","4432")  or 
		  substr(trim(left(pro)),1,3) in ("432") then pre_gastro_tude=1;
		if substr(trim(left(pro)),1,4) in ("3995") then pre_hemodia=1;
		if substr(trim(left(pro)),1,4) in ("9915") or 
		  substr(trim(left(pro)),1,3) in ("966") then pre_enteral_nut=1;
		if substr(trim(left(pro)),1,4) in ("9960","9963") then pre_cpr=1;
	end;

end;

if pre_intubation|
pre_trach|
pre_gastro_tude|
pre_hemodia|
pre_enteral_nut|
pre_cpr then date_proc=procedure_date;
run;

data proc_list;
set proc_long_ba;
where pre_intubation = 1 or pre_trach = 1 or pre_gastro_tude = 1 or pre_enteral_nut = 1 or pre_cpr = 1;
if procedure_date = . then procedure_date = admit_date;
run;

data proc_12 (keep = bene_id index_year pre_intubation pre_trach pre_gastro_tude pre_enteral_nut pre_cpr proc_12m proc_6m);
set proc_list;
proc_12m = 1;
proc_6m = 0;
if index_date - procedure_date<=183 then proc_6m = 1;
where index_date - procedure_date<=365;
run;

data proc_12;
set proc_12;
label pre_intubation = "intubation/mechanic ventilation pre ivw";
label pre_trach = "trachostomy pre ivw";
label pre_gastro_tude = "gastrostomy tube pre ivw";
label pre_enteral_nut = "enteral/parenteral nutrition pre ivw";
label pre_cpr = "CPR pre ivw";
label proc_12m = "Had 1 or more life saving procedure 12m pre ivw";
label proc_6m = "Had 1 or more life saving procedure 6m pre ivw";
run;

proc export data=proc_12 outfile="E:\nhats\data\Projects\IAH\int_data\life_proc_12.dta" replace; run;


data ip_365_post (drop=hcpcscd1--hcpcscd45);
set proj_int.ip_meet_365p;
array list ICD_PRCDR_CD1-ICD_PRCDR_CD25;
array date PRCDR_DT1-PRCDR_DT25;
do over list;
if list ~="" then do;
pro=list+0;
procedure_date = date;
output;
end;
end;
format procedure_date date10.;
run;

data proc_post;
set ip_365_post;
array list 
post_intubation
post_trach
post_gastro_tude
post_hemodia
post_enteral_nut
post_cpr;
do over list;
list=0;
end;

if length(trim(left(pro)))>=3 then do;

	if  substr(trim(left(pro)),1,3) in ("967")  then post_intubation =1;
	if  substr(trim(left(pro)),1,3) in ("311") then  post_trach=1;
	if  substr(trim(left(pro)),1,3) in ("432") then  post_gastro_tude=1;

	if substr(trim(left(pro)),1,3) in ("966") then  post_enteral_nut=1;

	if length(trim(left(pro)))>3 then do;
		if substr(trim(left(pro)),1,4) in ("9604","9605") or 
		  substr(trim(left(pro)),1,3) in ("967") then post_intubation =1;
		if substr(trim(left(pro)),1,4) in ("3121","3129") or 
		  substr(trim(left(pro)),1,3) in ("311") then post_trach=1;
		if substr(trim(left(pro)),1,4) in ("4311","4319","4432")  or 
		  substr(trim(left(pro)),1,3) in ("432") then post_gastro_tude=1;
		if substr(trim(left(pro)),1,4) in ("3995") then post_hemodia=1;
		if substr(trim(left(pro)),1,4) in ("9915") or 
		  substr(trim(left(pro)),1,3) in ("966") then post_enteral_nut=1;
		if substr(trim(left(pro)),1,4) in ("9960","9963") then post_cpr=1;
	end;

end;

if post_intubation|
post_trach|
post_gastro_tude|
post_hemodia|
post_enteral_nut|
post_cpr then date_proc=procedure_date;
run;

data proc_list_post;
set proc_post;
where post_intubation = 1 or post_trach = 1 or post_gastro_tude = 1 or post_enteral_nut = 1 or post_cpr = 1;
if procedure_date = . then procedure_date = admit_date;
run;

data proc_p12 (keep = bene_id index_year post_intubation post_trach post_gastro_tude post_enteral_nut post_cpr proc_p12m proc_p6m);
set proc_list_post;
proc_p12m = 1;
proc_p6m = 0;
if procedure_date - index_date<=183 then proc_p6m = 1;
run;

data proc_p12;
set proc_p12;
label post_intubation = "intubation/mechanic ventilation post ivw";
label post_trach = "trachostomy post ivw";
label post_gastro_tude = "gastrostomy tube post ivw";
label post_enteral_nut = "enteral/parenteral nutrition post ivw";
label post_cpr = "CPR post ivw";
label proc_p12m = "Had 1 or more life saving procedure 12m post ivw";
label proc_p6m = "Had 1 or more life saving procedure 6m post ivw";
run;


proc export data=proc_p12 outfile="E:\nhats\data\Projects\IAH\int_data\life_proc_p12.dta" replace; run;


H="Prob Dem - HRS"
/*2000-2012 medicare claims*/
libname claims 'E:\data\cms_DUA_24548_2012';
libname raw 'E:\data\cms_DUA_24548_2012\received_20150327';

data carrier;
set raw.pb_1998 raw.pb_1999 raw.pb_2000 raw.pb_2001 raw.pb_2002 raw.pb_2003 raw.pb_2004 raw.pb_2005 raw.pb_2006 raw.pb_2007 raw.pb_2008 raw.pb_2009 raw.pb_2010 raw.pb_2011 raw.pb_2012;
run;

proc contents data=carrier short; run;


data carrier (keep = bid_hrs_21 from_dt thru_dt PLCRVC01--PLCRVC13) ;
set carrier;
run;

proc import datafile="E:\data\IAH - Dementia\core_pdem.dta" out=nhats replace; run; /*technically HRS but too lazy to change */ 

data nhats;
set nhats;
run;


data carrier_pflag;
set carrier;
pos1flag = 0;
array dx PLCRVC01--PLCRVC13;
do over dx;
if dx in:(12,13,14) then pos1flag = 1;
end;
run;


proc freq data=carrier_pflag; tables pos1flag; run;

data carrier_pflag;
set carrier_pflag;
if pos1flag = 0 then delete;
run;

proc contents data=tmp1.pb_2008; run;

data carrier;
set claims.pb_2000_2012;
run;

proc sql;
create table carrier_new as select a.*, b.pos1flag
from carrier a
inner join carrier_pflag b
on a.bid_hrs_21=b.bid_hrs_21 and a.from_dt=b.from_dt and a.thru_dt=b.thru_dt;
quit;


data carrier_new;
set carrier_new;
array dx HCPSCD01--HCPSCD13;
do over dx;
hcpcs_cd = dx;
output;
end;
run;

data carrier_new;
set carrier_new;
cptcodes = input(compress(hcpcs_cd,'ABCDEFGHIJKLMNOPQRSTUVWXYZ/',),8.);
run;

data carrier_new;
set carrier_new;
cptflag = 0;
if 99341<=cptcodes<=99350 or 99324<=cptcodes<=99328 or 99334<=cptcodes<=99337 then cptflag=1;
run;

data carrier_new;
set carrier_new;
where cptflag = 1 and pos1flag = 1;
run;

proc sort data=carrier_new nodup; by bid_hrs_21; run;



/****************************************************************/
/*Add HRS xwalk ID to the claims datasets
Creates 2 datasets, one with the 6 month cc and elix 
and one with 12 month cc and elix */
/****************************************************************/

/*HRS - CMS crosswalk initial processing*/
data crosswalk_1;
set claims.cmsxref2012;
keep bid_hrs_21 hhid pn hhidpn hhidnew pnnew;
/*create id variable as concat of hhid and pn*/
length hhidpn $9 hhidnew $6 pnnew $3;
hhidnew=trim(hhid);
pnnew=trim(pn);
hhidpn=hhidnew||pnnew;
run;

data crosswalk_1a;
set crosswalk_1(keep=bid_hrs_21 hhidpn);
run;

proc sort data=crosswalk_1a nodupkey; by bid_hrs_21; run; 

proc sql;
create table hrs as select a.*, b.bid_hrs_21
from nhats a
inner join crosswalk_1a b
on a.id=b.hhidpn;
quit;


proc sql;
create table carrier_calls as select a.*, b.cptflag, b.pos1flag, b.admit_year
from hrs a
inner join carrier_new b
on a.bid_hrs_21=b.bid_hrs_21 and -183<=a.c_ivw_date-b.admit_date<=183;
quit;



proc sort data=carrier_calls; by bid_hrs_21 admit_year; run;


data dn_file (keep = bid_hrs_21 admit_year buyin12 hmoind12 hmo_mo buyin_mo orec esrd_ind bene_dob);
set claims.dn_2000_2012 (rename=(year = admit_year));
run;


proc sort data=dn_file; by bid_hrs_21 admit_year; run;

proc sql;
create table carrier_calls2 as select a.*, b.*
from carrier_calls a 
inner join dn_file b
on a.bid_hrs_21=b.bid_hrs_21 and a.admit_year=b.admit_year;
quit;


/* Trim buyin and hmo variables to only reflect time before dialysis */
data hrs_dial_y2;
set carrier_calls;
surg_month=month(c_ivw_month);
if length(trim(left(buyin12)))>=6 and surg_month>0 then do;
buyin_sy=substr(trim(left(buyin12)),1,surg_month); * creating buyin/hmo variable for the months before index date in same year;
hmo_sy=substr(trim(left(HMOIND12)),1,surg_month);
end;
else do;
buyin_sy=trim(left(buyin12));
hmo_sy=trim(left(HMOIND12));
end;
run;
proc means n;
var surg_month;
run;


proc sql;
create table dn_surg_y_bef as select
a.bid_hrs_21,a.admit_year as surg_year,b.year as surg_year_bef,b.year,b.buyin12,b.HMOIND12
from hrs_dial_final a inner join
merged.dn_2000_2012 b
on trim(left(a.bid_hrs_21))=trim(left(b.bid_hrs_21))
and a.admit_year-b.year=1 order by bid_hrs_21,admit_year;
quit;


proc sql;
create table all_insurance as select a.*,b.buyin12 as buyin_bef,b.HMOIND12 as hmo_bef from
hrs_dial_y2 a
left join
dn_surg_y_bef b
on trim(left(a.bid_hrs_21))=trim(left(b.bid_hrs_21));
quit;


data all_insurance2;
set all_insurance;
buyin_2y=trim(left(buyin_bef))||trim(left(buyin_sy));
hmo_2y=trim(left(hmo_bef))||trim(left(hmo_sy));

/*create 12 month variables*/
buyin_2y_r=reverse(trim(buyin_2y));
hmo_2y_r=reverse(trim(hmo_2y));

if length(buyin_2y_r)>5 then buyin_1y_r=substr(trim(left(buyin_2y)),1,6);
if length(hmo_2y_r)>5 then hmo_1y_r=substr(trim(left(hmo_2y)),1,6);

if length(buyin_2y_r)<6 then buyin_1y_r="";
if length(hmo_2y_r)<6 then hmo_1y_r="";

buyin_1y=reverse(trim(buyin_1y_r));
hmo_1y=reverse(trim(hmo_1y_r));

/*create indicator variable for mc coverage 0=no, 1=yes*/
if length(buyin_1y)=6 then do;
if indexc(buyin_1y,"0","1","2","A","B") then part_ab_1y=0;
if indexc(buyin_1y,"0","1","2","A","B")=0 then part_ab_1y=1;
end;
/*create indicator variable for hmo coverage 0=no, 1=yes*/
if length(hmo_1y)=6 then do;
hmo_d_1y= 0;
if index(hmo_1y,"000000") then hmo_d_1y=1;
end;

/*create 6 month variable*/
if length(buyin_2y_r)>0 then buyin_6m_r=substr(trim(left(buyin_2y)),1,6);
if length(hmo_2y_r)>0 then hmo_6m_r=substr(trim(left(hmo_2y)),1,6);

if length(buyin_2y_r)<1 then buyin_6m_r="";
if length(hmo_2y_r)<1 then hmo_6m_r="";

buyin_6m=reverse(trim(buyin_6m_r));
hmo_6m=reverse(trim(hmo_6m_r));

/*create indicator variable for mc coverage 6 mo. 0=no, 1=yes*/
if length(buyin_6m)=1 then do;
if indexc(buyin_6m,"0","1","2","A","B") then part_ab_6m=0;
if indexc(buyin_6m,"0","1","2","A","B")=0 then part_ab_6m=1;
end;
if length(hmo_6m)=1 then do;
if index(hmo_6m,"0") then hmo_d_6m=0;
if index(hmo_6m,"0")=0 then hmo_d_6m=1;
end;

run;







data carrier3;
set carrier3;
*where ffs_6m = 1;
where both = 1;
run;

proc sort data=carrier3; by spid wave; run;
proc sort data=carrier3 nodupkey; by spid; run;

proc freq data=carrier3; tables ffs_6m ffs_12m; run;

/* both */

data bothclaims;
set carrier3;
where both = 1;
same = 0;
if hcpcs_cd = cptcodes then same = 1; /*checking if the cptcodes from from carrier claims is the same as the hcpcs_cd code in carrier line */
run;

proc sort data=bothclaims nodupkey; by bene_id clm_id hcpcs_cd; run;

/* gen single line per claim for annual count */

proc sort data=bothclaims out=annual nodupkey; by bene_id clm_id; run;

data annual;
set annual;
year = year(admit_date);
run;

proc sql;
create table annual_1 as select distinct bene_id, year,
sum(both) as housecalls_count
from annual
group by bene_id, year;
quit;

data annual_1;
set annual_1;
if year = 2011 then wave = 1;
if year = 2012 then wave = 2;
if year = 2013 then wave = 3;
run;

proc export data=annual_1 outfile="E:\nhats\data\Projects\IAH\int_data\annualcpt_count.dta" dbms=stata replace; run;

proc freq data=bothclaims order=freq; tables hcpcs_cd; run;

proc sort data=bothclaims nodupkey; by bene_id wave; run;


data both_beneid (keep= bene_id wave bflag);
set bothclaims;
bflag = 1;
run;

proc freq data=both_beneid; tables wave; run;

proc export data=both_beneid outfile="E:\nhats\data\Projects\IAH\int_data\cpt+pos.dta" replace; run;

proc sort data=both_beneid out=test nodupkey; by bene_id; run;


/*cptcodes only */

data cptclaims;
set carrier3;
where cptflag= 1 and both=0;
run;

proc sql;
create table cptclaims1 as select a.*, b.bflag
from cptclaims a
left join both_beneid b
on a.bene_id=b.bene_id and a.wave=b.wave;
quit;

data cptclaims;
set cptclaims1;
if bflag = 1 then delete;
cflag = 1;
run;

proc sort data=cptclaims nodupkey; by bene_id clm_id hcpcs_cd; run;


proc freq data=cptclaims order=freq; tables hcpcs_cd; run;
proc freq data=cptclaims order=freq; tables LINE_PLACE_OF_SRVC_CD; run;

proc sort data=cptclaims nodupkey; by bene_id wave; run;
proc freq data=cptclaims ; tables wave; run;
proc sort data=cptclaims out=test nodupkey; by bene_id; run;

proc export data=cptclaims outfile="E:\nhats\data\Projects\IAH\int_data\cpt+only.dta" replace; run;


/*pos only */

data posclaims;
set carrier3;
where posflag = 1 and both=0;
run;

proc sql;
create table posclaims1 as select a.*, b.cflag
from posclaims a
left join cptclaims b
on a.bene_id=b.bene_id and a.wave=b.wave;
quit;

proc sql;
create table posclaims2 as select a.*, b.bflag
from posclaims1 a
left join both_beneid b
on a.bene_id=b.bene_id and a.wave=b.wave;
quit;

data posclaims;
set posclaims2;
if cflag = 1 or bflag = 1 then delete;
run;



proc sort data=posclaims nodupkey; by bene_id clm_id hcpcs_cd; run;
proc freq data=posclaims order=freq; tables hcpcs_cd; run;

 
proc sort data=posclaims nodupkey; by bene_id wave; run;

proc freq data=posclaims; tables wave; run;


proc sort data=posclaims nodupkey; by bene_id; run;


proc export data=posclaims outfile="E:\nhats\data\Projects\IAH\int_data\pos+only.dta" replace; run;





















/*cptcodes only */

data cptclaims;
set carrier3;
where cptflag= 1 and both=0;
run;

proc sql;
create table cptclaims1 as select a.*, b.pflag
from cptclaims a
left join posclaims b
on a.bene_id=b.bene_id and a.wave=b.wave;
quit;

data cptclaims;
set cptclaims1;
if pflag = 1 then delete;
run;

proc sort data=cptclaims nodupkey; by bene_id clm_id hcpcs_cd; run;


proc freq data=cptclaims order=freq; tables hcpcs_cd; run;
proc freq data=cptclaims order=freq; tables LINE_PLACE_OF_SRVC_CD; run;

proc sort data=cptclaims nodupkey; by bene_id wave; run;
proc freq data=cptclaims ; tables wave; run;

/* none */

data noclaims;
set carrier3;
where cpt


data carrier2 (keep = cptcodes hcpcs_cd) ;
set carrier2;
where posflag = 1 or pos1flag = 1;
run;

data carrier2 (keep = hcpcs_cd);
set carrier2;
run;
*/

proc sort data=carrier2 nodup; by hcpcs_cd; run;


proc export data=carrier2 outfile="E:\nhats\projects\IAH\20171115\cptcodes.xlsx" dbms=xlsx replace; run;


H="Probable Dementia house calls"
/* Stata */

use "E:\nhats\data\Projects\IAH\final_data\iah_wave1-3.dta", clear

keep if prob_dem==1
keep spid bene_id index_date wave

save "E:\nhats\data\Projects\IAH\final_data\dementia_wave1-3.dta"

/* SAS      */

libname claims "E:\nhats\data\CMS_DUA_28016\Merged";
libname line "E:\nhats\data\CMS_DUA_28016\Cumulative Years";
libname cyears "E:\nhats\data\CMS_DUA_28016\Cumulative Years";

proc import datafile="E:\nhats\data\Projects\IAH\final_data\dementia_wave1-3.dta" out=nhats replace; run; 

data nhats;
set nhats;
run;

/*
data carrier_pflag;
set claims.pb_09_14;
pos1flag = 0;
array dx pos1--pos13;
do over dx;
if dx in:(12,13,14) then pos1flag = 1;
output;
end;
run;

*/

data carrier;
set claims.pb_09_14;
array dx hcpcscd1--hcpcscd13;
do over dx;
cptcodes=dx;
output;
end;
/*
pos1flag = 0;
if pos1 in:(12,13,14) then pos1flag = 1;
if pos2 in:(12,13,14) then pos1flag = 1;
if pos3 in:(12,13,14) then pos1flag = 1;
if pos4 in:(12,13,14) then pos1flag = 1;
if pos5 in:(12,13,14) then pos1flag = 1;
if pos6 in:(12,13,14) then pos1flag = 1;
if pos7 in:(12,13,14) then pos1flag = 1;
if pos8 in:(12,13,14) then pos1flag = 1;
if pos9 in:(12,13,14) then pos1flag = 1;
if pos10 in:(12,13,14) then pos1flag = 1;
if pos11 in:(12,13,14) then pos1flag = 1;
if pos12 in:(12,13,14) then pos1flag = 1;
if pos13 in:(12,13,14) then pos1flag = 1;
*/
run;


data carrierline (keep = bene_id clm_id LINE_PLACE_OF_SRVC_CD cptcodes hcpcs_cd);
set line.bcarrier_line_j_09_14;
cptcodes = input(compress(hcpcs_cd,'ABCDEFGHIJKLMNOPQRSTUVWXYZ/',),8.);
run;

data carrierline;
set carrierline;
cptflag = 0;
posflag = 0;
if 99341<=cptcodes<=99350 or 99324<=cptcodes<=99328 or 99334<=cptcodes<=99337 then cptflag=1;
if LINE_PLACE_OF_SRVC_CD in:(12,13,14) then posflag=1;
run;

data carrierline;
set carrierline;
both = 0;
if cptflag = 1 and posflag = 1 then both = 1;
run;


proc sql;
create table carrier2 as select a.*, b.admit_date, b.disch_date
from carrierline a
inner join carrier b
on a.bene_id=b.bene_id and a.clm_id=b.clm_id;
quit;

proc sql;
create table carrier3 as select a.*, b.*
from carrier2 a
inner join nhats b
on a.bene_id=b.bene_id and -183<=b.index_date-a.admit_date<=183;
quit;


data carrier3;
set carrier3;
*where ffs_6m = 1;
where both = 1;
run;

proc sort data=carrier3; by spid wave; run;
proc sort data=carrier3 nodupkey; by spid; run;

proc freq data=carrier3; tables ffs_6m ffs_12m; run;

/* both */

data bothclaims;
set carrier3;
where both = 1;
same = 0;
if hcpcs_cd = cptcodes then same = 1; /*checking if the cptcodes from from carrier claims is the same as the hcpcs_cd code in carrier line */
run;

proc sort data=bothclaims nodupkey; by bene_id clm_id hcpcs_cd; run;

/* gen single line per claim for annual count */

proc sort data=bothclaims out=annual nodupkey; by bene_id clm_id; run;

data annual;
set annual;
year = year(admit_date);
run;

proc sql;
create table annual_1 as select distinct bene_id, year,
sum(both) as housecalls_count
from annual
group by bene_id, year;
quit;

data annual_1;
set annual_1;
if year = 2011 then wave = 1;
if year = 2012 then wave = 2;
if year = 2013 then wave = 3;
run;

proc export data=annual_1 outfile="E:\nhats\data\Projects\IAH\int_data\annualcpt_count.dta" dbms=stata replace; run;

proc freq data=bothclaims order=freq; tables hcpcs_cd; run;

proc sort data=bothclaims nodupkey; by bene_id wave; run;


data both_beneid (keep= bene_id wave bflag);
set bothclaims;
bflag = 1;
run;

proc freq data=both_beneid; tables wave; run;

proc export data=both_beneid outfile="E:\nhats\data\Projects\IAH\int_data\cpt+pos.dta" replace; run;

proc sort data=both_beneid out=test nodupkey; by bene_id; run;


/*cptcodes only */

data cptclaims;
set carrier3;
where cptflag= 1 and both=0;
run;

proc sql;
create table cptclaims1 as select a.*, b.bflag
from cptclaims a
left join both_beneid b
on a.bene_id=b.bene_id and a.wave=b.wave;
quit;

data cptclaims;
set cptclaims1;
if bflag = 1 then delete;
cflag = 1;
run;

proc sort data=cptclaims nodupkey; by bene_id clm_id hcpcs_cd; run;


proc freq data=cptclaims order=freq; tables hcpcs_cd; run;
proc freq data=cptclaims order=freq; tables LINE_PLACE_OF_SRVC_CD; run;

proc sort data=cptclaims nodupkey; by bene_id wave; run;
proc freq data=cptclaims ; tables wave; run;
proc sort data=cptclaims out=test nodupkey; by bene_id; run;

proc export data=cptclaims outfile="E:\nhats\data\Projects\IAH\int_data\cpt+only.dta" replace; run;


/*pos only */

data posclaims;
set carrier3;
where posflag = 1 and both=0;
run;

proc sql;
create table posclaims1 as select a.*, b.cflag
from posclaims a
left join cptclaims b
on a.bene_id=b.bene_id and a.wave=b.wave;
quit;

proc sql;
create table posclaims2 as select a.*, b.bflag
from posclaims1 a
left join both_beneid b
on a.bene_id=b.bene_id and a.wave=b.wave;
quit;

data posclaims;
set posclaims2;
if cflag = 1 or bflag = 1 then delete;
run;



proc sort data=posclaims nodupkey; by bene_id clm_id hcpcs_cd; run;
proc freq data=posclaims order=freq; tables hcpcs_cd; run;

 
proc sort data=posclaims nodupkey; by bene_id wave; run;

proc freq data=posclaims; tables wave; run;


proc sort data=posclaims nodupkey; by bene_id; run;


proc export data=posclaims outfile="E:\nhats\data\Projects\IAH\int_data\pos+only.dta" replace; run;





















/*cptcodes only */

data cptclaims;
set carrier3;
where cptflag= 1 and both=0;
run;

proc sql;
create table cptclaims1 as select a.*, b.pflag
from cptclaims a
left join posclaims b
on a.bene_id=b.bene_id and a.wave=b.wave;
quit;

data cptclaims;
set cptclaims1;
if pflag = 1 then delete;
run;

proc sort data=cptclaims nodupkey; by bene_id clm_id hcpcs_cd; run;


proc freq data=cptclaims order=freq; tables hcpcs_cd; run;
proc freq data=cptclaims order=freq; tables LINE_PLACE_OF_SRVC_CD; run;

proc sort data=cptclaims nodupkey; by bene_id wave; run;
proc freq data=cptclaims ; tables wave; run;

/* none */

data noclaims;
set carrier3;
where cpt


data carrier2 (keep = cptcodes hcpcs_cd) ;
set carrier2;
where posflag = 1 or pos1flag = 1;
run;

data carrier2 (keep = hcpcs_cd);
set carrier2;
run;
*/

proc sort data=carrier2 nodup; by hcpcs_cd; run;


proc export data=carrier2 outfile="E:\nhats\projects\IAH\20171115\cptcodes.xlsx" dbms=xlsx replace; run;


H="Table 1 and res care by homebound status"
use "E:\nhats\data\Projects\IAH\final_data\housecalls.dta", clear


local homebound
levelsof homebound_cat, local(levels)
label define homebound_cat 1  "Never/Rarely leaves home" 2 "Never by self"  3 "Needs help/has difficulty" 4 "Independent"  
label values homebound_cat homebound_cat 

foreach l of local levels {
	gen hb`l'=homebound_cat==`l' if !missing(homebound_cat)
	local lab : label homebound_cat `l'
	label var hb`l' "`lab'"
	local homebound `homebound' hb`l'
}

local cvars1 age  income_quart_1 income_quart_2 income_quart_3 ///
income_quart_4
local ivars1 female white black hisp married livealone rcfres educ_hs_ind reg_doc_have reg_doc_seen ///
homebound medicaid metro_ind northeast midwest south west `homebound'
local ivars2 iah_adl iah_chronic iah_nonelect iah_pacute iah_all sr_ami_ever sr_stroke_ever ///
sr_cancer_ever sr_hip_ever sr_heart_dis_ever sr_htn_ever sr_ra_ever sr_osteoprs_ever ///
sr_diabetes_ever sr_dementia_ever prob_dem
local ivars3 adl_eat_diff adl_eat_help adl_bath_diff adl_bath_help adl_toil_diff ///
adl_toil_help adl_dres_diff adl_dres_help adl_ins_help adl_ins_diff adl_bed_help ///
adl_bed_diff ind_hosp_adm_p12m ind_ed_adm_p12m ind_icu_p12m died_12 housecalls_90
local cvars4 tot_paid_by_mc_12m housecalls_count

gen n=1
svyset [pw=n]
gen group=inrange(homebound_cat,1,3) if !missing(homebound_cat)

local full `cvars1' `ivars1' `ivars2' `ivars3' `cvars4'

local rn: word count `full' 1

mat tab = J(`rn',3,.)
mat stars = J(`rn',3,0)

local r = 1
local c = 1

forvalues i=0/1 {
	forvalues j=1/4 {
		foreach x of local cvars`j' {
			sum `x' if inlist(group,`i') [aw=anfinw]
			mat tab[`r',`c']=r(mean)
			if `i'==1 {
				svy: mean `x', over(group)
				test [`x']0=[`x']1
				mat tab[`r',3]=r(p)
				mat stars[`r',3]=(r(p)<.05)+(r(p)<.01)
}
			local r=`r'+1
}
		foreach x of local ivars`j' {
			sum `x' if inlist(group,`i') [aw=anfinw]
			mat tab[`r',`c']=r(mean)*100
			if `i'==1 {
				svy: tab `x' group
				mat tab[`r',3]=e(p_Pear)
				mat stars[`r',3]=(e(p_Pear)<.05)+(e(p_Pear)<.01)
}
			local r=`r'+1
}
}
		sum n if inlist(group,`i')
		mat tab[`r',`c']=r(N)
		local r=1
		local c=`c'+1
}

mat rownames tab=`full' N

frmttable using "E:\nhats\data\projects\IAH\logs\HBMC_homebound_rescare_tables.rtf", statmat(tab) title("Table 1: IAH Unique persons per NHATS Waves 1-5 Community Dwelling + 6m FFS") ///
note("These are unique people, and only survey data from their most recent NHATS interview was used. *p<0.05, **p<0.01") ///
ctitles("" "Independent" "Partially or fully homebound" "P-value") sdec(2) ///
annotate(stars) asymbol(*,**) varlabels replace


keep if housecalls_90==1

levelsof homebound_cat, local(levels)

local rn : word count `levels' 1

mat tab=J(`rn',3,.)
mat stars=J(`rn',3,0)

local r=1
local c=1

forvalues i=1(-1)0 {
	sum homebound_cat if rcfres==`i'
	local denom=r(N)
	foreach l of local levels {
		sum rcfres if homebound_cat==`l' & rcfres==`i'
		mat tab[`r',`c']=r(N)/`denom'*100
		local r=`r'+1
}
	mat tab[`r',`c']=`denom'
	local c=`c'+1
	local r=1
}
tab homebound_cat rcfres, chi2
mat tab[1,3]=r(p)
mat stars[1,3]=(r(p)<.05)+(r(p)<.01)

foreach l of local levels {
	local lab : label homebound_cat `l'
	local rownames `rownames' `lab'
}



frmttable using "E:\nhats\data\projects\IAH\logs\HBMC_homebound_rescare_tables.rtf", statmat(tab) title("Homebound and Assisted Living, Column percentages") ///
ctitles("" "Assisted living" "No Assisted living" "P-value") ///
sdec(2) annotate(stars) asymbol(*,**) addtable ///
rtitles("Never/Rarely leaves home"\ "Nevere by self"\ "Needs help/has difficulty"\ "Independent" )

local rn 3
mat tab=J(`rn',5,.)
mat stars=J(`rn',5,0)

local r=1
local c=1

foreach l of local levels {
	sum rcfres if homebound_cat==`l'
	local denom=r(N)
	forvalues i=1(-1)0 {
		sum rcfres if homebound_cat==`l' & rcfres==`i'
		mat tab[`r',`c']=r(N)/`denom'*100
		local r=`r'+1
}
	mat tab[`r',`c']=`denom'
	local c=`c'+1
	local r=1
}
tab homebound_cat rcfres, chi2
mat tab[1,5]=r(p)
mat stars[1,5]=(r(p)<.05)+(r(p)<.01)

foreach l of local levels {
	local lab : label homebound_cat `l'
	local rownames `rownames' `lab'
}



frmttable using "E:\nhats\data\projects\IAH\logs\HBMC_homebound_rescare_tables.rtf", statmat(tab) ///
title("Homebound and Assisted Living, Column percentages") ///
ctitles("" "Never/Rarely leaves home" "Never by self" "Needs help/has difficulty" "Independent" "P-value") ///
rtitles("Assisted living" \"No Assisted living") ///
sdec(2) annotate(stars) asymbol(*,**) addtable



H="***************************"


H="HCC"
use "E:\nhats\data\20180625 NHATS CMS Data\merged stata\mbsf_06_16.dta" , clear

gen hicno = bene_id

gen dob = birth_date

gen sex = sex_ident_cd
replace sex = bene_sex_ident_cd if sex==""

gen orec =  bene_entlmt_rsn_orig
replace orec = entlmt_rsn_orig if orec==""


keep hicno dob sex orec year covstart

saveold "E:\nhats\data\Projects\IAH\HCC\2018-Model-Software (1)\CMS-HCC software V2218.79.O1\hicno.dta", version(12) replace


proc import datafile="E:\nhats\data\Projects\IAH\HCC\2018-Model-Software (1)\CMS-HCC software V2218.79.O1\hicno.dta" out=hicno dbms=stata replace; run;

data hicno;
set hicno;
format dob date9.;
run;

proc sort data=hicno nodupkey; by descending year hicno; run;


proc sql;
create table hicno_ffs as select a.*, b.*
from hcc.ffs_before a
left join hicno b
on a.bene_id = b.hicno;
quit;


data hicno_ffs;
set hicno_ffs;
start_year = year(covstart);
newenroll = year - start_year;
ltimcaid = 0;
if indexc(buyin_bef, "A", "B", "C")>0 then ltimcaid = 1;
run;

data hicno_ffs;
set hicno_ffs;
nemcaid = 0;
if newenroll<=1 and ltimcaid=1 then nemcaid = 1;
run;

proc freq data=hicno_ffs; tables newenroll nemcaid; run;

data hicno_ffs;
set hicno_ffs;
hicno_id = hicno||(left(trim(year)));
run;

data hicno_hcc (keep = hicno_id sex dob ltimcaid nemcaid orec);
set hicno_ffs;
run;

data hcc.hicno_hcc (rename=(hicno_id = hicno));
set hicno_hcc;
run;

data diag_hcc;
set hcc.dx_0_1yr;
hicno = left(trim(bene_id))||left(trim(index_year));
run;

data hcc.diag_hcc (keep = hicno diag);
set diag_hcc;
run;

proc sort data=hcc.diag_hcc nodup; by hicno; run;


H="Changelog"
02/13/2019 - Added Medicare Home Health claims flag and created censored version of housecalls table. Omari. 

02/06/2019 - Ammended "Table 1 and res care by homebound status" to include a four-column table (y/n housecall and y/n homebound) and make shareable. Evan

02/05/2019 - Added "Table 1 and res care by homebound status" tab. Evan


01/29/2019 - Calculated person years. Omari


01/02/2019 - Updated the code to include cell size censored tables. Omari