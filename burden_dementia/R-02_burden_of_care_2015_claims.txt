= V4 Outline MultiLine NoSorting TabWidth=30

H="Project outline"
The Burden of Care for Adults with Dementia: Impact on Care Quality and Family Outcomes


10/9/17

This is a project to set up the structure for Amy's R01 and get initial findings while we wait for the HRS and claims data through 2016 and the MDS and Medicaid MAX files.  Right now we have HRS interviews through 2014 and Rand family and CMS data through 2012.  Because we're looking at the last five years of life, the full sample will be those who die 2005-2012.  

Initial dataset creation:

index_date: death date from Karen's death date file
n1, n2, n3, and exit interviews
-OOP spending (have all the code from Kathleen)
-dementia probability
-unpaid caregiving hours (values at state average for hired cgs)
-NH admission
-wealth (Rand)
-cohabitation with adult kids (Rand)
-financial support from adult kids (Rand)
-demographics
-SR illnesses
-location of death

Annual Medicare claims from five years pre-death

Burdensome transitions last 90 days

H="set libraries"
libname clean 'E:\data\hrs_cleaned'; 
libname medi 'E:\data\CMS_DUA_51675_2014\Merged\SAS';
libname dmouth 'E:\data\Dartmouth_misc';

/*rand data path*/
libname rand 'E:\data\hrs_public_2014\rand2014\main';

libname proj_int 'E:\data\burden_dementia\int_data';
libname proj_fin 'E:\data\burden_dementia\final_data';
libname proj_ref 'E:\data\burden_dementia\ref_data';



H="get index date"
/*pull the date of death, assign as index date*/

/*
proc import datafile="E:\data\hrs_cleaned\death_date_2014.dta" out=death_date_2014 dbms=stata replace; run;

data index;
set death_date_2014;
index_date=death_all;
index_month=month(death_all);
index_year=year(death_all);
if bid_hrs_21~='';
run;

data proj_int.index (keep = id bid_hrs_21 index_date index_month index_year);
set index;
run;


*/

data proj_int.index(keep=id bid_hrs_22 index_date index_month index_year);
set clean.death_date_2015;
index_date=death_all;
index_month=death_month;
index_year=death_year;
if bid_hrs_22~='';
run;


proc export data=proj_int.index outfile="E:\data\burden_dementia\int_data\index_dates.dta" dbms=stata replace; run;

H="get ffs before"
/*determine Spouse ffs medicare before R's death using the 
claims denominator files

Several sets of variables created, looking back 6m, 12m, 18m, 24m from R's death

Also pulls in spouse date of death where available in the claims s_claims_dod*/

/*sort claims denominator file*/

proc sort data=medi.bqsf_1998_2015 out=dn  nodupkey;
by bid_hrs_22 start_dt;
run;

proc sort data=proj_int.index out=index1 nodupkey;
by bid_hrs_22 index_year;
run;

/*get dn just for interview year*/

proc sql; 
create table dn_index_quarter as select
a.*,b.ab_mo_cnt,b.start_dt,b.end_dt,b.hmo_mo
from index1 a inner join
dn b
on trim(left(a.bid_hrs_22))=trim(left(b.bid_hrs_22)) 
and b.start_dt<=a.index_date<=b.end_dt;
quit;



data all_insurance_0 (rename=(hmo_mo=hmo0 ab_mo_cnt=ab0));
set dn_index_quarter;
ffs0=ab_mo_cnt>=1 & hmo_mo=0;
set dn_index_quarter;
format index_date date9.;
run;

data all_insurance_0b;
set all_insurance_0;
ab_mos0=ab0;
if ffs0=1 then ffs_mos0=ab_mos0;
if ffs0=0 then ffs_mos0=0;
run;



%macro insyrs(numyrs=);
%let y=%eval(&numyrs.*4);
%do i=1 %to &y.;

%let l=%eval(&i.-1);
proc sql; 
create table dn&i. as select
a.*,b.ab_mo_cnt,b.start_dt,b.end_dt,b.hmo_mo
from index1 a inner join
dn b
on trim(left(a.bid_hrs_22))=trim(left(b.bid_hrs_22)) 
and b.start_dt<=a.index_date-(&i.*(365.25/4))<=end_dt;
quit;

data all_insurance_&i.(rename=(hmo_mo=hmo&i. ab_mo_cnt=ab&i.)); 
set dn&i.;
ffs&i.=ab_mo_cnt>=1 & hmo_mo=0;
format index_date date9.;
run;

proc sql;
create table all_insurance_&i.2 as select * from
all_insurance_&l.b a
left join
all_insurance_&i. b
on a.bid_hrs_22=b.bid_hrs_22;
quit;

data all_insurance_&i.b (drop=ab_mos&l. ffs_mos&l.);
set all_insurance_&i.2;
ab_mos&i.=ab_mos&l.+ab&i.;
if ffs&i.=. then ffs&i.=0;
if ffs&l.=0 then ffs&i.=0;
if ffs&i.=1 then ffs_mos&i.=ab&i.+ffs_mos&l.;
if ffs&i.=0 then ffs_mos&i.=ffs_mos&l.;
run;

%end;

data all_insurance;
set all_insurance_&y.b;
cont_ffs_n_mos=ffs_mos&y.;
%mend;




%insyrs(numyrs=7);


data proj_int.ffs_before;
set all_insurance;
run;

proc export data=proj_int.ffs_before outfile="E:\data\burden_dementia\int_data\ffs_before.dta" replace; run;

H="get claims before"
proc sort data=proj_int.index out=index1 nodupkey;
by bid_hrs_22 id index_date;
run;




/**************************************************************************/
/* ************** Claims Before Death  ******************************/
/**************************************************************************/
/*macro to get claims before death
saves datasets for each claim type / time window to the spo_mc_i directory*/
%macro claimspre(days_start=,days_bef_index=,source=,suf=);

/*claims fully within x time of death date*/
proc sql;
create table &source._meet_1 as select a.*,b.index_date,b.id 
from medi.&source._1998_2015 a inner join
index1 b
on trim(left(a.bid_hrs_22))=trim(left(b.bid_hrs_22))
and &days_start<=b.index_date-a.admit_date<=&days_bef_index ;
quit;

/*claims that start earlier than x time but span into x time before death*/
proc sql;
create table &source._meet_2 as select a.*,b.index_date,b.id 
from medi.&source._1998_2015 a inner join
index1 b
on trim(left(a.bid_hrs_22))=trim(left(b.bid_hrs_22))
and b.index_date-a.admit_date>&days_bef_index and b.index_date-a.disch_date<=&days_bef_index;
quit;

data proj_int.&source._meet_&suf.(compress=yes);
set &source._meet_1 &source._meet_2;
run;
%mend;

/*6m before death*/
*%claims(days_start=0,days_bef_index=183,source=hh,suf=6m); /*home health*/
*%claims(days_start=0,days_bef_index=183,source=hs,suf=6m); /*hospice*/
*%claims(days_start=0,days_bef_index=183,source=mp,suf=6m); /*medpar*/
*%claims(days_start=0,days_bef_index=183,source=dm,suf=6m); /*dme*/
*%claims(days_start=0,days_bef_index=183,source=op,suf=6m); /*outpatient*/
*%claims(days_start=0,days_bef_index=183,source=pb,suf=6m); /*carrier*/
/*12m before death*/
%macro bef(time=);
%claimspre(days_start=0,days_bef_index=365*&time.,source=hh,suf=%eval(12*&time.)m); /*home health*/
%claimspre(days_start=0,days_bef_index=365*&time.,source=hs,suf=%eval(12*&time.)m); /*hospice*/
%claimspre(days_start=0,days_bef_index=365*&time.,source=mp,suf=%eval(12*&time.)m); /*medpar*/
%claimspre(days_start=0,days_bef_index=365*&time.,source=dm,suf=%eval(12*&time.)m); /*dme*/
%claimspre(days_start=0,days_bef_index=365*&time.,source=op,suf=%eval(12*&time.)m); /*outpatient*/
%claimspre(days_start=0,days_bef_index=365*&time.,source=pb,suf=%eval(12*&time.)m); /*carrier*/
%mend;



/**************************************************************************/
/* ************** S Claims After R's Death   ******************************/
/**************************************************************************/
/*macro to get claims after death
saves datasets for each claim type / time window to the spo_mc_i directory*/
%macro claimspost(days_start=,days_aft_index=,source=,suf=);

/*claims fully within x time of death date*/
proc sql;
create table &source._meet_1 as select a.*,b.index_date,b.id 
from medi.&source._1998_2015 a inner join
index1 b
on trim(left(a.bid_hrs_22))=trim(left(b.bid_hrs_22))
and &days_start<=a.admit_date - b.index_date<=&days_aft_index ;
quit;

/*claims that start earlier than R's DOD but span after R's death*/
proc sql;
create table &source._meet_2 as select a.*,b.index_date,b.id 
from medi.&source._1998_2015 a inner join
index1 b
on trim(left(a.bid_hrs_22))=trim(left(b.bid_hrs_22))
and a.admit_date<b.index_date
and &days_start<=a.disch_date - b.index_date;
quit;

data proj_int.&source._meet_&suf.(compress=yes);
set &source._meet_1 &source._meet_2;
format disch_date date9.;
format admit_date date9.;
run;
%mend;

%macro aft(time=);
%claimspost(days_start=0,days_aft_index=365*&time.,source=hh,suf=p%eval(12*&time.)m); /*home health*/
%claimspost(days_start=0,days_aft_index=365*&time.,source=hs,suf=p%eval(12*&time.)m); /*hospice*/
%claimspost(days_start=0,days_aft_index=365*&time.,source=mp,suf=p%eval(12*&time.)m); /*medpar*/
%claimspost(days_start=0,days_aft_index=365*&time.,source=dm,suf=p%eval(12*&time.)m); /*dme*/
%claimspost(days_start=0,days_aft_index=365*&time.,source=op,suf=p%eval(12*&time.)m); /*outpatient*/
%claimspost(days_start=0,days_aft_index=365*&time.,source=pb,suf=p%eval(12*&time.)m); /*carrier*/
%mend;


/**************************************************************************/
/* ********************* S Diagnosis Lists   ******************************/
/**************************************************************************/

%macro dx_time_range(range1=, range2=, suf=);
/*pulls just dx codes from carrier claims*/
data pb_last_&range2._dx(keep=bid_hrs_22 id diag index_date);
set proj_int.pb_meet_&suf.(keep=bid_hrs_22 id PDGNS_CD DGNSCD01-DGNSCD12 index_date);
array dx PDGNS_CD DGNSCD01-DGNSCD12;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=pb_last_&range2._dx out=pb_last_&range2._dx2 nodupkey;
by bid_hrs_22 id index_date diag;
run;

/*outpatient claims*/
data op_last_&range2._dx(keep=bid_hrs_22 id diag index_date);
set proj_int.op_meet_&suf.(keep=bid_hrs_22 id PDGNS_CD DGNSCD01-DGNSCD25  index_date);
array dx PDGNS_CD DGNSCD01-DGNSCD25 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=op_last_&range2._dx out=op_last_&range2._dx2 nodupkey;
by bid_hrs_22 id index_date diag;
run;

/*medpar claims*/
data mp_last_&range2._dx(keep=bid_hrs_22 id diag index_date);
set proj_int.mp_meet_&suf.(keep=bid_hrs_22 id AD_DGNS DGNS_CD01-DGNS_CD25 index_date );
array dx D_DGNS DGNS_CD01-DGNS_CD25 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=mp_last_&range2._dx out=mp_last_&range2._dx2 nodupkey;
by bid_hrs_22 id index_date diag;
run;

/*dme claims*/
data dm_last_&range2._dx(keep=bid_hrs_22 id diag index_date);
set proj_int.dm_meet_&suf.(keep=bid_hrs_22 id PDGNS_CD DGNSCD01-DGNSCD12 index_date);
array dx PDGNS_CD DGNSCD01-DGNSCD12 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=dm_last_&range2._dx out=dm_last_&range2._dx2 nodupkey;
by bid_hrs_22 id index_date diag;
run;

/*home health agency*/
data hh_last_&range2._dx(keep=bid_hrs_22 id diag index_date);
set proj_int.hh_meet_&suf.(keep=bid_hrs_22 id PDGNS_CD DGNSCD01-DGNSCD25 index_date);
array dx PDGNS_CD DGNSCD01-DGNSCD25 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=hh_last_&range2._dx out=hh_last_&range2._dx2 nodupkey;
by bid_hrs_22 id index_date diag;
run;

/*hospice*/
data hs_last_&range2._dx(keep=bid_hrs_22 id diag index_date);
set proj_int.hs_meet_&suf.(keep=bid_hrs_22 id PDGNS_CD DGNSCD01-DGNSCD25 index_date);
array dx PDGNS_CD DGNSCD01-DGNSCD25 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=hs_last_&range2._dx out=hs_last_&range2._dx2 nodupkey;
by bid_hrs_22 id index_date diag;
run;

/*set diag variable length = 7 chars since that's the max length from the mc claims
Need to do this because length varies across the different mc claim types*/
data hs_last_&range2._dx3;
length diag $7;
set hs_last_&range2._dx2;
run;
data hh_last_&range2._dx3;
length diag $7;
set hh_last_&range2._dx2;
run;
data mp_last_&range2._dx3;
length diag $7;
set mp_last_&range2._dx2;
run;
data dm_last_&range2._dx3;
length diag $7;
set dm_last_&range2._dx2;
run;
data op_last_&range2._dx3;
length diag $7;
set op_last_&range2._dx2;
run;
data pb_last_&range2._dx3;
length diag $7;
set pb_last_&range2._dx2;
run;

data dx_all_last_&range2.;
set hs_last_&range2._dx3
hh_last_&range2._dx3
mp_last_&range2._dx3
dm_last_&range2._dx3
op_last_&range2._dx3
pb_last_&range2._dx3;
run;

proc sort data=dx_all_last_&range2.(where=(diag~="")) out=proj_int.dx_&range1._&range2 nodupkey;
by bid_hrs_22 id index_date diag;
run;

%mend;

/****************************************************************/
/*medpar claims, time periods before R's death*******************/
/****************************************************************/
/*macro for medpar claims, splits into costs for snf and ip claims
for time periods before r's death*/
%macro mp(source=,equ=,name=);
data proj_int.&source._meet_&name.;
set proj_int.mp_meet_&name.;
if (trim(left(SSLSSNF)))&equ.="N";
run;
%mend;

%macro mpsplit(time=);
%mp(source=ip,equ=~,name=%eval(12*&i.)m);
%mp(source=snf,equ=,name=%eval(12*&i.)m);
%mp(source=ip,equ=~,name=p%eval(12*&i.)m);
%mp(source=snf,equ=,name=p%eval(12*&i.)m);
%mend;



/*run macros*/

%macro runall(years=);
%do i=1 %to &years.;
%bef(time=&i.);
%aft(time=&i.);
%mpsplit(time=&i.);
%end;
%mend;

%runall(years=7);


/*run macro to create data files proj_int.dx_0d_n6m proj_int.dx_0d_n12m and proj_int.dx_0d_n24m */
*%dx_time_range(range1=0d, range2=n6m, suf=6m);
%dx_time_range(range1=0d, range2=n12m, suf=12m);
*%dx_time_range(range1=0d, range2=n24m, suf=24m);

/*run for dx lists after R's death*/
*%dx_time_range(range1=0d, range2=p6m, suf=p6m);
*%dx_time_range(range1=0d, range2=p12m, suf=p12m);
*%dx_time_range(range1=0d, range2=p24m, suf=p24m);



/*get spouse medicare costs by claim type and total, adjusted for inflation
to 2012$, monthly, 24m before and after R's death

begins with claims lists from "Get S MC claims lists..." section

final dataset is spo_mc_i.hrs_elix_cc_pay*/




H="get annual diagnoses before"


/**************************************************************************/
/* ********************* S Diagnosis Lists   ******************************/
/**************************************************************************/

%macro dx_time_range(range1=, range2=, startdate=, enddate=, suf=);
/*pulls just dx codes from carrier claims*/
data pb_last_&range2._dx(keep=bid_hrs_22 id diag index_date);
set proj_int.pb_meet_&suf.(keep=bid_hrs_22 id PDGNS_CD DGNSCD01-DGNSCD12 index_date admit_date);
if &startdate.<=(index_date-admit_date)/365.25<&enddate.;
array dx PDGNS_CD DGNSCD01-DGNSCD12;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=pb_last_&range2._dx out=pb_last_&range2._dx2 nodupkey;
by bid_hrs_22 id index_date diag;
run;

/*outpatient claims*/
data op_last_&range2._dx(keep=bid_hrs_22 id diag index_date);
set proj_int.op_meet_&suf.(keep=bid_hrs_22 id PDGNS_CD DGNSCD01-DGNSCD25  index_date admit_date);
if &startdate.<=(index_date-admit_date)/365.25<&enddate.;
array dx PDGNS_CD DGNSCD01-DGNSCD25 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=op_last_&range2._dx out=op_last_&range2._dx2 nodupkey;
by bid_hrs_22 id index_date diag;
run;

/*medpar claims*/
data mp_last_&range2._dx(keep=bid_hrs_22 id diag index_date);
set proj_int.mp_meet_&suf.(keep=bid_hrs_22 id AD_DGNS DGNS_CD01-DGNS_CD25 index_date admit_date);
if &startdate.<=(index_date-admit_date)/365.25<&enddate.;
array dx D_DGNS DGNS_CD01-DGNS_CD25 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=mp_last_&range2._dx out=mp_last_&range2._dx2 nodupkey;
by bid_hrs_22 id index_date diag;
run;

/*dme claims*/
data dm_last_&range2._dx(keep=bid_hrs_22 id diag index_date);
set proj_int.dm_meet_&suf.(keep=bid_hrs_22 id PDGNS_CD DGNSCD01-DGNSCD12 index_date admit_date);
if &startdate.<=(index_date-admit_date)/365.25<&enddate.;
array dx PDGNS_CD DGNSCD01-DGNSCD12 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=dm_last_&range2._dx out=dm_last_&range2._dx2 nodupkey;
by bid_hrs_22 id index_date diag;
run;

/*home health agency*/
data hh_last_&range2._dx(keep=bid_hrs_22 id diag index_date);
set proj_int.hh_meet_&suf.(keep=bid_hrs_22 id PDGNS_CD DGNSCD01-DGNSCD25 index_date admit_date);
if &startdate.<=(index_date-admit_date)/365.25<&enddate.;
array dx PDGNS_CD DGNSCD01-DGNSCD25 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=hh_last_&range2._dx out=hh_last_&range2._dx2 nodupkey;
by bid_hrs_22 id index_date diag;
run;

/*hospice*/
data hs_last_&range2._dx(keep=bid_hrs_22 id diag index_date);
set proj_int.hs_meet_&suf.(keep=bid_hrs_22 id PDGNS_CD DGNSCD01-DGNSCD25 index_date admit_date);
if &startdate.<=(index_date-admit_date)/365.25<&enddate.;
array dx PDGNS_CD DGNSCD01-DGNSCD25 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=hs_last_&range2._dx out=hs_last_&range2._dx2 nodupkey;
by bid_hrs_22 id index_date diag;
run;

/*set diag variable length = 7 chars since that's the max length from the mc claims
Need to do this because length varies across the different mc claim types*/
data hs_last_&range2._dx3;
length diag $7;
set hs_last_&range2._dx2;
run;
data hh_last_&range2._dx3;
length diag $7;
set hh_last_&range2._dx2;
run;
data mp_last_&range2._dx3;
length diag $7;
set mp_last_&range2._dx2;
run;
data dm_last_&range2._dx3;
length diag $7;
set dm_last_&range2._dx2;
run;
data op_last_&range2._dx3;
length diag $7;
set op_last_&range2._dx2;
run;
data pb_last_&range2._dx3;
length diag $7;
set pb_last_&range2._dx2;
run;

data dx_all_last_&range2.;
set hs_last_&range2._dx3
hh_last_&range2._dx3
mp_last_&range2._dx3
dm_last_&range2._dx3
op_last_&range2._dx3
pb_last_&range2._dx3;
run;

proc sort data=dx_all_last_&range2.(where=(diag~="")) out=proj_int.dx_&range1._&range2 nodupkey;
by bid_hrs_22 id index_date diag;
run;

%mend;


%macro rundx(years=);
%do i=1 %to &years.;
%let l=%eval(&i.-1);

%dx_time_range(range1=%eval(&l.*12)m, range2=%eval(&i.*12)m, startdate=&l., enddate=&i., suf=84m);

%end;
%mend;

%rundx(years=7);



H="Annual Elixhauser"
/*

Created by: EBL
Date Created: 4/12/19

Updated by:
Date Updated:




**************************************************

/****************************************************************************/
/* Rename variables macro                                                   */
/****************************************************************************/

%macro rename(lib,dsn,pre);
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "Before Renaming All Variables";
run;
proc sql noprint;
select nvar into :num_vars
from dictionary.tables
where libname="&LIB" and
memname="&DSN";
select distinct(name) into :var1-
:var%TRIM(%LEFT(&num_vars))
from dictionary.columns
where libname="&LIB" and
memname="&DSN";
quit;
run;
proc datasets library=&LIB;
modify &DSN;
rename
%do i=1 %to &num_vars;
&&var&i=&&var&i.._&pre 
%end;
;
quit;
run;
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "After Renaming All Variables";
run;
%mend rename;




/****************************************************************************/
/* Elixhauser comorbidities macro                                           */
/****************************************************************************/
/*Note elixhauser comorbidities diagnosis lists are modified for the 
purposes of this project, do not copy and paste this Elixhauser code 
for use in other projects!!*/

%macro elixhauser(range1=, range2=);

data dx_31_comor;
set proj_int.dx_&range1._&range2.(rename=(diag=dx_0));
dx=trim(left(dx_0));

if dx~="" then do;

comorbi_1=0;
comorbi_2=0;
comorbi_3=0;
comorbi_4=0;
comorbi_5=0;
comorbi_6=0;
comorbi_7=0;
comorbi_8=0;
comorbi_9=0;
comorbi_10=0;
comorbi_11=0;
comorbi_12=0;
comorbi_13=0;
comorbi_14=0;
comorbi_15=0;
comorbi_16=0;
comorbi_17=0;
comorbi_18=0;
comorbi_19=0;
comorbi_20=0;
comorbi_21=0;
comorbi_22=0;
comorbi_23=0;
comorbi_24=0;
comorbi_25=0;
comorbi_26=0;
comorbi_27=0;
comorbi_28=0;
comorbi_29=0;
comorbi_30=0;
*end of intialize of 30 binary variables;
*add dementia and CAD and ALS;
dementia=0;
cad=0;
als=0;
renal_dis=0;

*do over dx;
	*Congestive Heart Failure;
	if (substr(dx,1,5)='39891' or
		substr(dx,1,5)='40211' or
		substr(dx,1,5)='40291' or
		substr(dx,1,5)='40411' or
		substr(dx,1,5)='40413' or
		substr(dx,1,5)='40491' or
		substr(dx,1,5)='40493' or
		substr(dx,1,3)='428') 
		and comorbi_1=0 
		then comorbi_1=1;*add one binary variables here.;
	if (substr(dx,1,4)='I099' or
		substr(dx,1,4)='I110' or
		substr(dx,1,4)='I130' or
		substr(dx,1,4)='I132' or
		substr(dx,1,4)='I255' or
		substr(dx,1,4)='I420' or
		substr(dx,1,4)='I425' or
		substr(dx,1,4)='I426' or
		substr(dx,1,4)='I427' or
		substr(dx,1,4)='I428' or
		substr(dx,1,4)='I429' or
		substr(dx,1,3)='I43' or
		substr(dx,1,4)='P290' or
		substr(dx,1,3)='I50') 
		and comorbi_1=0 
		then comorbi_1=1;

		*Cariac Arrhythmias;
	if (substr(dx,1,5)='42610' or
		substr(dx,1,5)='42611' or
		substr(dx,1,5)='42613' or
		substr(dx,1,4)='4262' or
		substr(dx,1,4)='4263' or
		substr(dx,1,4)='4264' or
		substr(dx,1,5)='42650' or
		substr(dx,1,5)='42651' or
		substr(dx,1,5)='42652' or
		substr(dx,1,5)='42653' or
		substr(dx,1,4)='4266' or
		substr(dx,1,4)='4267' or
		substr(dx,1,4)='4268' or
		substr(dx,1,4)='4270' or
		substr(dx,1,4)='4272' or
		substr(dx,1,5)='42731' or
		substr(dx,1,5)='42760' or
		substr(dx,1,4)='4279' or
		substr(dx,1,4)='7850' or
		substr(dx,1,4)='V450' or
		substr(dx,1,4)='V533')
			and comorbi_2=0 
		then comorbi_2=1;
	if (substr(dx,1,4)='I441' or
		substr(dx,1,4)='I442' or
		substr(dx,1,4)='I443' or
		substr(dx,1,4)='I456' or
		substr(dx,1,4)='I459' or
		substr(dx,1,3)='I47' or
		substr(dx,1,3)='I48' or
		substr(dx,1,3)='I49' or
		substr(dx,1,4)='ROOO' or
		substr(dx,1,4)='ROO1' or
		substr(dx,1,4)='ROO8' or
		substr(dx,1,4)='R000' or
		substr(dx,1,4)='R001' or
		substr(dx,1,4)='R008' or
		substr(dx,1,4)='T821' or
		substr(dx,1,4)='Z450' or
		substr(dx,1,4)='Z950')
			and comorbi_2=0 
		then comorbi_2=1;
	* Valvular Disease ;
	if (substr(dx,1,5)='09320' or
		substr(dx,1,5)='09321' or
		substr(dx,1,5)='09322' or
		substr(dx,1,5)='09323' or
		substr(dx,1,5)='09324' or
		substr(dx,1,3)='394' or
		substr(dx,1,3)='395' or
		substr(dx,1,3)='396' or
		substr(dx,1,4)='3970' or
		substr(dx,1,4)='3971' or
		substr(dx,1,4)='4240' or
		substr(dx,1,4)='4241' or
		substr(dx,1,4)='4242' or
		substr(dx,1,4)='4243' or
		substr(dx,1,4)='4244' or
		substr(dx,1,4)='4245' or
		substr(dx,1,4)='4246' or
		substr(dx,1,4)='4247' or
		substr(dx,1,4)='4248' or
		substr(dx,1,5)='42490' or
		substr(dx,1,5)='42491' or
		substr(dx,1,4)='7463' or
		substr(dx,1,4)='7464' or
		substr(dx,1,4)='7465' or
		substr(dx,1,4)='7466' or
		substr(dx,1,4)='V422' or
		substr(dx,1,4)='V433')
			and comorbi_3=0 
		then comorbi_3=1;
	if (substr(dx,1,4)='A520' or
		substr(dx,1,4)='I05' or
		substr(dx,1,3)='I06' or
		substr(dx,1,3)='I07' or
		substr(dx,1,3)='I08' or
		substr(dx,1,4)='I091' or
		substr(dx,1,4)='I098' or
		substr(dx,1,3)='I34' or
		substr(dx,1,3)='I35' or
		substr(dx,1,3)='I36' or
		substr(dx,1,3)='I37' or
		substr(dx,1,3)='I38' or
		substr(dx,1,3)='I39' or
		substr(dx,1,4)='Q230' or
		substr(dx,1,4)='Q231' or
		substr(dx,1,4)='Q232' or
		substr(dx,1,4)='Q233' or
		substr(dx,1,4)='Z952' or
		substr(dx,1,4)='Z954')
			and comorbi_3=0 
		then comorbi_3=1;
	*Pulmonary Circulation Disorders;
	if (substr(dx,1,3)='416' or
		substr(dx,1,4)='4179')
			and comorbi_4=0 
		then comorbi_4=1;
	if (substr(dx,1,3)='I26' or
		substr(dx,1,3)='I27' or
		substr(dx,1,4)='I280' or
		substr(dx,1,4)='I288' or
		substr(dx,1,4)='I289')
			and comorbi_4=0 
		then comorbi_4=1;
	*Peripheral Vascular Disorders;
	if (substr(dx,1,3)='440' or
		substr(dx,1,4)='4412' or
		substr(dx,1,4)='4414' or
		substr(dx,1,4)='4417' or
		substr(dx,1,4)='4419' or
		substr(dx,1,4)='4431' or
		substr(dx,1,4)='4432' or
		substr(dx,1,4)='4438' or
		substr(dx,1,4)='4439' or
		substr(dx,1,4)='4471' or
		substr(dx,1,4)='5571' or
		substr(dx,1,4)='5579' or
		substr(dx,1,4)='V434')
			and comorbi_5=0 
		then comorbi_5=1;
	if (substr(dx,1,3)='I70' or
		substr(dx,1,3)='I71' or
		substr(dx,1,4)='I731' or
		substr(dx,1,4)='I738' or
		substr(dx,1,4)='I739' or
		substr(dx,1,4)='I771' or
		substr(dx,1,4)='I790' or
		substr(dx,1,4)='I792' or
		substr(dx,1,4)='K551' or
		substr(dx,1,4)='K558' or
		substr(dx,1,4)='K559' or
		substr(dx,1,4)='X958' or
		substr(dx,1,4)='Z959')
			and comorbi_5=0 
		then comorbi_5=1;
	*Hypertension;
	if ((substr(dx,1,4)='4011' or
		substr(dx,1,4)='4019')) or
	   ((substr(dx,1,5)='40210' or
		substr(dx,1,5)='40290' or
		substr(dx,1,5)='40410' or
		substr(dx,1,5)='40490' or
		substr(dx,1,5)='40511' or
		substr(dx,1,5)='40519' or
		substr(dx,1,5)='40591' or
		substr(dx,1,5)='40599')) 
			and comorbi_6=0 
		then comorbi_6=1;
	if (substr(dx,1,3)='I10' or
		substr(dx,1,3)='I11' or
	    substr(dx,1,3)='I12' or
		substr(dx,1,3)='I13' or
		substr(dx,1,3)='I15')
			and comorbi_6=0 
		then comorbi_6=1;
	*Paralysis;	
	if (substr(dx,1,4)='3420' or
		substr(dx,1,5)='34210' or
		substr(dx,1,5)='34211' or
		substr(dx,1,5)='34212' or
		substr(dx,1,4)='3429' or
		substr(dx,1,3)='343' or
		substr(dx,1,3)='344')
			and comorbi_7=0 
		then comorbi_7=1;
	if (substr(dx,1,4)='G041' or
		substr(dx,1,4)='G114' or
		substr(dx,1,4)='G801' or
		substr(dx,1,4)='G802' or
		substr(dx,1,3)='G81' or
		substr(dx,1,3)='G82' or
		substr(dx,1,4)='G830' or 
		substr(dx,1,4)='G831' or 
		substr(dx,1,4)='G832' or 
		substr(dx,1,4)='G833' or 
		substr(dx,1,4)='G834' or 
		substr(dx,1,4)='G839')
			and comorbi_7=0 
		then comorbi_7=1;
	*Other Neurological Disorders;
	if (substr(dx,1,4)='3319' or
		substr(dx,1,4)='3320' or
		substr(dx,1,4)='3334' or
		substr(dx,1,4)='3335' or
		substr(dx,1,3)='334' or
		substr(dx,1,3)='335' or
		substr(dx,1,3)='340' or
		substr(dx,1,4)='3411' or
		substr(dx,1,4)='3418' or
		substr(dx,1,4)='3419' or
		substr(dx,1,5)='34500' or
		substr(dx,1,5)='34501' or
		substr(dx,1,5)='34510' or
		substr(dx,1,5)='34511' or
		substr(dx,1,4)='3454' or
		substr(dx,1,5)='34550' or
		substr(dx,1,5)='34551' or
		substr(dx,1,4)='3458' or
		substr(dx,1,5)='34590' or
		substr(dx,1,5)='34591' or
		substr(dx,1,4)='3481' or
		substr(dx,1,4)='3483' or
		substr(dx,1,4)='7803' or
		substr(dx,1,4)='7843') 
			and comorbi_8=0 
		then comorbi_8=1;	
	if (substr(dx,1,3)='G10' or
		substr(dx,1,3)='G13' or
		substr(dx,1,3)='G20' or
		substr(dx,1,3)='G22' or
		substr(dx,1,4)='G254' or
		substr(dx,1,4)='G255' or
		substr(dx,1,4)='G312' or
		substr(dx,1,4)='G318' or
		substr(dx,1,4)='G319' or
		substr(dx,1,3)='G32' or
		substr(dx,1,3)='G35' or
		substr(dx,1,3)='G36' or
		substr(dx,1,3)='G37' or
		substr(dx,1,3)='G40' or
		substr(dx,1,3)='G41' or
		substr(dx,1,4)='G931' or
		substr(dx,1,4)='G934' or
		substr(dx,1,4)='R470' or
		substr(dx,1,4)='R560') 
			and comorbi_8=0 
		then comorbi_8=1;	
		*Chronic Pulmonary Disease;
	if (substr(dx,1,3)='490' or
		substr(dx,1,3)='491' or
		substr(dx,1,3)='492' or
		substr(dx,1,4)='4930' or
		substr(dx,1,4)='4931' or
		substr(dx,1,4)='4932' or
		substr(dx,1,4)='4938' or
		substr(dx,1,5)='49390' or
		substr(dx,1,5)='49391' or
		substr(dx,1,3)='494' or
		substr(dx,1,3)='495' or
		substr(dx,1,3)='496' or
		substr(dx,1,3)='497' or
		substr(dx,1,3)='498' or
		substr(dx,1,3)='499' or
		substr(dx,1,3)='500' or
		substr(dx,1,3)='501' or
		substr(dx,1,3)='502' or
		substr(dx,1,3)='503' or
		substr(dx,1,3)='504' or
		substr(dx,1,3)='505' or
		substr(dx,1,4)='5064') 
			and comorbi_9=0 
		then comorbi_9=1;	
	if (substr(dx,1,4)='I278' or
		substr(dx,1,4)='I279' or
		substr(dx,1,3)='J40' or
		substr(dx,1,3)='J41' or
		substr(dx,1,3)='J42' or
		substr(dx,1,3)='J43' or
		substr(dx,1,3)='J44' or
		substr(dx,1,3)='J45' or
		substr(dx,1,3)='J46' or
		substr(dx,1,3)='J47' or
		substr(dx,1,3)='J60' or
		substr(dx,1,3)='J61' or
		substr(dx,1,3)='J62' or
		substr(dx,1,3)='J63' or
		substr(dx,1,3)='J64' or
		substr(dx,1,3)='J65' or
		substr(dx,1,3)='J66' or
		substr(dx,1,3)='J67' or
		substr(dx,1,4)='J684' or
		substr(dx,1,4)='J701' or
		substr(dx,1,4)='J703') 
			and comorbi_9=0 
		then comorbi_9=1;	
		*Diabetes, uncomplicated;
	if (substr(dx,1,4)='2500' or
		substr(dx,1,4)='2501' or
		substr(dx,1,4)='2502' or
		substr(dx,1,4)='2503') 
			and comorbi_10=0 
		then comorbi_10=1;
	if (substr(dx,1,4)='E100' or
		substr(dx,1,4)='E101' or
		substr(dx,1,4)='E109' or
		substr(dx,1,4)='E110' or
		substr(dx,1,4)='E111' or
		substr(dx,1,4)='E119' or
		substr(dx,1,4)='E120' or
		substr(dx,1,4)='E121' or
		substr(dx,1,4)='E129' or
		substr(dx,1,4)='E130' or
		substr(dx,1,4)='E131' or
		substr(dx,1,4)='E139' or
		substr(dx,1,4)='E140' or
		substr(dx,1,4)='E141' or
		substr(dx,1,4)='E149') 
			and comorbi_10=0 
		then comorbi_10=1;
	*Diabetes, complicated;
	if (substr(dx,1,4)='2504' or
		substr(dx,1,4)='2505' or
		substr(dx,1,4)='2506' or
		substr(dx,1,4)='2507' or
		substr(dx,1,4)='2509') 
			and comorbi_11=0 
		then comorbi_11=1;
	if (substr(dx,1,4)='E102' or
		substr(dx,1,4)='E103' or
		substr(dx,1,4)='E104' or
		substr(dx,1,4)='E105' or
		substr(dx,1,4)='E106' or
		substr(dx,1,4)='E107' or
		substr(dx,1,4)='E108' or
		substr(dx,1,4)='E112' or
		substr(dx,1,4)='E113' or
		substr(dx,1,4)='E114' or
		substr(dx,1,4)='E115' or
		substr(dx,1,4)='E116' or
		substr(dx,1,4)='E117' or
		substr(dx,1,4)='E118' or
		substr(dx,1,4)='E122' or
		substr(dx,1,4)='E123' or
		substr(dx,1,4)='E124' or
		substr(dx,1,4)='E125' or
		substr(dx,1,4)='E126' or
		substr(dx,1,4)='E127' or
		substr(dx,1,4)='E128' or
		substr(dx,1,4)='E132' or
		substr(dx,1,4)='E133' or
		substr(dx,1,4)='E134' or
		substr(dx,1,4)='E135' or
		substr(dx,1,4)='E136' or
		substr(dx,1,4)='E137' or
		substr(dx,1,4)='E138' or
		substr(dx,1,4)='E142' or
		substr(dx,1,4)='E143' or
		substr(dx,1,4)='E144' or
		substr(dx,1,4)='E145' or
		substr(dx,1,4)='E146' or
		substr(dx,1,4)='E147' or
		substr(dx,1,4)='E148') 
			and comorbi_11=0 
		then comorbi_11=1;
		*Hypothyroidism;
	if (substr(dx,1,3)='243' or
		substr(dx,1,4)='2440' or
		substr(dx,1,4)='2441' or
		substr(dx,1,4)='2442' or
		substr(dx,1,4)='2448' or
		substr(dx,1,4)='2449') 	
			and comorbi_12=0 
		then comorbi_12=1;
	if (substr(dx,1,3)='E00' or
		substr(dx,1,3)='E01' or
		substr(dx,1,3)='E02' or
		substr(dx,1,3)='E03' or
		substr(dx,1,4)='E890') 	
			and comorbi_12=0 
		then comorbi_12=1;
		*Renal Failure;
	*Original list modified to drop 2 codes  585 and V568;
	if (substr(dx,1,5)='40311' or
		substr(dx,1,5)='40391' or
		substr(dx,1,5)='40412' or
		substr(dx,1,5)='40492' or
		substr(dx,1,3)='586' or
		substr(dx,1,4)='V420' or
		substr(dx,1,4)='V451' or
		substr(dx,1,4)='V560') 
			and comorbi_13=0 
		then comorbi_13=1;
	if (substr(dx,1,4)='I120' or
		substr(dx,1,4)='I131' or
		substr(dx,1,4)='N185' or
		substr(dx,1,4)='N186' or
		substr(dx,1,3)='N19' or
		substr(dx,1,4)='N250' or
		substr(dx,1,4)='Z490' or
		substr(dx,1,4)='Z491' or
		substr(dx,1,4)='Z492' or
		substr(dx,1,4)='Z940' or
		substr(dx,1,4)='Z992') 
			and comorbi_13=0 
		then comorbi_13=1;
	*Advanced Liver Disease or Cirrhosis;
	*Code list modified from orig Elix;
	*572.4 hepatorenal syndrome must be added; 
	*Remove '07032' or – chronic hep B, '07033' or – chronic hep B, '07054' or – chronic hep C, '5713' or – 
		alcoholic liver damage, '5714' or – chronic hepatitis;
	if (substr(dx,1,4)='4560' or
		substr(dx,1,4)='4561' or
		substr(dx,1,5)='45620' or
		substr(dx,1,5)='45621' or
		substr(dx,1,4)='5710' or
		substr(dx,1,4)='5712' or
		substr(dx,1,4)='5715' or
		substr(dx,1,4)='5716' or
		substr(dx,1,4)='5718' or
		substr(dx,1,4)='5719' or
		substr(dx,1,4)='5723' or
		substr(dx,1,4)='5724' or
		substr(dx,1,4)='5728' or
		substr(dx,1,4)='V427') 
			and comorbi_14=0 
		then comorbi_14=1;
/*1/25/19--changed liver to reflect just what we want in the ICD-10 codes*/
		if (substr(dx,1,5)='I8500'
		or substr(dx,1,5)='I8501'
		or substr(dx,1,5)='I8510'
		or substr(dx,1,5)='I8511'
		or substr(dx,1,4)='K702'
		or substr(dx,1,5)='K7030'
		or substr(dx,1,5)='K7031'
		or substr(dx,1,5)='K7040'
		or substr(dx,1,5)='K7041'
		or substr(dx,1,5)='K7210'
		or substr(dx,1,5)='K7290'
		or substr(dx,1,4)='K740'
		or substr(dx,1,4)='K741'
		or substr(dx,1,4)='K742'
		or substr(dx,1,4)='K743'
		or substr(dx,1,4)='K744'
		or substr(dx,1,4)='K745'
		or substr(dx,1,5)='K7460'
		or substr(dx,1,5)='K7469'
		or substr(dx,1,4)='K766'
		or substr(dx,1,4)='K767') 
					and comorbi_14=0 
		then comorbi_14=1;
	*Peptic Ulcer Disease excluding bleeding;
	if (substr(dx,1,5)='53170' or
		substr(dx,1,5)='53190' or
		substr(dx,1,5)='53270' or
		substr(dx,1,5)='53290' or
		substr(dx,1,5)='53370' or
		substr(dx,1,5)='53390' or
		substr(dx,1,5)='53470' or
		substr(dx,1,5)='53490' or
		substr(dx,1,5)='V1271') 
			and comorbi_15=0 
		then comorbi_15=1;
	if (substr(dx,1,4)='K257' or
		substr(dx,1,4)='K259' or
		substr(dx,1,4)='K267' or
		substr(dx,1,4)='K269' or
		substr(dx,1,4)='K277' or
		substr(dx,1,4)='K279' or
		substr(dx,1,4)='K287' or
		substr(dx,1,4)='K289') 
			and comorbi_15=0 
		then comorbi_15=1;
		*AIDS;
	if (substr(dx,1,3)='042' or
		substr(dx,1,3)='043' or
		substr(dx,1,3)='044') 
			and comorbi_16=0 
		then comorbi_16=1;
		if (substr(dx,1,3)='B20' or
		substr(dx,1,3)='B21' or
		substr(dx,1,3)='B22' or
		substr(dx,1,3)='B24') 
			and comorbi_16=0 
		then comorbi_16=1;
	*Lymphoma;
	if (substr(dx,1,3)='200' or
		substr(dx,1,3)='201' or
		substr(dx,1,4)='2020' or
		substr(dx,1,4)='2021' or
		substr(dx,1,4)='2022' or
		substr(dx,1,4)='2023' or
		substr(dx,1,4)='2025' or
		substr(dx,1,4)='2026' or
		substr(dx,1,4)='2027' or
		substr(dx,1,4)='2028' or
		substr(dx,1,4)='2029' or
		substr(dx,1,4)='2030' or
		substr(dx,1,4)='2038' or
		substr(dx,1,4)='2386' or
		substr(dx,1,4)='2733' or
		substr(dx,1,5)='V1071' or
		substr(dx,1,5)='V1072' or
		substr(dx,1,5)='V1079')
			and comorbi_17=0 
		then comorbi_17=1;
	if (substr(dx,1,3)='C81' or
		substr(dx,1,3)='C82' or
		substr(dx,1,3)='C83' or
		substr(dx,1,3)='C84' or
		substr(dx,1,3)='C85' or
		substr(dx,1,3)='C88' or
		substr(dx,1,3)='C96' or
		substr(dx,1,4)='C900' or
		substr(dx,1,4)='C902')
			and comorbi_17=0 
		then comorbi_17=1;
		*Metastatic Cancer or Hematologic Cancer;
	*Modified to add lukemias;
	if (substr(dx,1,3)='196' or
		substr(dx,1,3)='197' or
		substr(dx,1,3)='198' or
		substr(dx,1,3)='199' or
		substr(dx,1,3)='204' or
		substr(dx,1,3)='205' or
		substr(dx,1,3)='206' or
		substr(dx,1,3)='207' or
		substr(dx,1,3)='208') 
			and comorbi_18=0 
		then comorbi_18=1;	
	if (substr(dx,1,3)='C77' or
		substr(dx,1,3)='C78' or
		substr(dx,1,3)='C79' or
		substr(dx,1,3)='C80') 
			and comorbi_18=0 
		then comorbi_18=1;	
		*Solid Tumor without Metastisis;
	if (substr(dx,1,2)='14' or
		substr(dx,1,2)='15' or
		substr(dx,1,2)='16' or
		substr(dx,1,3)='170' or
		substr(dx,1,3)='171' or
		substr(dx,1,3)='172' or
		substr(dx,1,3)='174' or
		substr(dx,1,3)='175' or
		substr(dx,1,3)='179' or
		substr(dx,1,2)='18' or
		substr(dx,1,3)='190' or
		substr(dx,1,3)='191' or
		substr(dx,1,3)='192' or
		substr(dx,1,3)='193' or
		substr(dx,1,3)='194' or
		substr(dx,1,3)='195' or
		substr(dx,1,3)='V10')
			and comorbi_19=0 
		then comorbi_19=1;
	if (substr(dx,1,2)='C0' or
		substr(dx,1,2)='C1' or
		substr(dx,1,3)='C20' or
		substr(dx,1,3)='C21' or
		substr(dx,1,3)='C22' or
		substr(dx,1,3)='C23' or
		substr(dx,1,3)='C24' or
		substr(dx,1,3)='C25' or
		substr(dx,1,3)='C26' or
		substr(dx,1,3)='C30' or
		substr(dx,1,3)='C31' or
		substr(dx,1,3)='C32' or
		substr(dx,1,3)='C33' or
		substr(dx,1,3)='C34' or
		substr(dx,1,3)='C37' or
		substr(dx,1,3)='C38' or
		substr(dx,1,3)='C39' or
		substr(dx,1,3)='C40' or
		substr(dx,1,3)='C41' or
		substr(dx,1,3)='C43' or
		substr(dx,1,3)='C45' or
		substr(dx,1,3)='C46' or
		substr(dx,1,3)='C47' or
		substr(dx,1,3)='C48' or
		substr(dx,1,3)='C49' or
		substr(dx,1,3)='C50' or
		substr(dx,1,3)='C51' or
		substr(dx,1,3)='C52' or
		substr(dx,1,3)='C53' or
		substr(dx,1,3)='C54' or
		substr(dx,1,3)='C55' or
		substr(dx,1,3)='C56' or
		substr(dx,1,3)='C57' or
		substr(dx,1,3)='C58' or
		substr(dx,1,3)='C60' or
		substr(dx,1,3)='C61' or
		substr(dx,1,3)='C62' or
		substr(dx,1,3)='C63' or
		substr(dx,1,3)='C64' or
		substr(dx,1,3)='C65' or
		substr(dx,1,3)='C66' or
		substr(dx,1,3)='C67' or
		substr(dx,1,3)='C68' or
		substr(dx,1,3)='C69' or
		substr(dx,1,3)='C70' or
		substr(dx,1,3)='C71' or
		substr(dx,1,3)='C72' or
		substr(dx,1,3)='C73' or
		substr(dx,1,3)='C74' or
		substr(dx,1,3)='C75' or
		substr(dx,1,3)='C76' or
		substr(dx,1,3)='C97')
			and comorbi_19=0 
		then comorbi_19=1;
		*Rheumatoid Arthritis/Collagen Vascular Diseases;
	if (substr(dx,1,4)='7010' or
		substr(dx,1,3)='710' or
		substr(dx,1,3)='714' or
		substr(dx,1,3)='720' or
		substr(dx,1,3)='725') 
			and comorbi_20=0 
		then comorbi_20=1;
	if (substr(dx,1,4)='L940' or
		substr(dx,1,4)='L941' or
		substr(dx,1,4)='L943' or
		substr(dx,1,3)='M05' or
		substr(dx,1,3)='M06' or
		substr(dx,1,3)='M08' or
		substr(dx,1,4)='M120' or
		substr(dx,1,4)='M123' or
		substr(dx,1,3)='M30' or
		substr(dx,1,4)='M310' or
		substr(dx,1,4)='M311' or
		substr(dx,1,4)='M312' or
		substr(dx,1,4)='M313' or
		substr(dx,1,3)='M32' or
		substr(dx,1,3)='M33' or
		substr(dx,1,3)='M34' or
		substr(dx,1,3)='M35' or
		substr(dx,1,3)='M45' or
		substr(dx,1,4)='M461' or
		substr(dx,1,4)='M468' or
		substr(dx,1,4)='M469') 
			and comorbi_20=0 
		then comorbi_20=1;
		*Coagulopathy;
	*Coagulopathy;
	if (substr(dx,1,3)='286' or
		substr(dx,1,4)='2871' or
		substr(dx,1,4)='2873' or
		substr(dx,1,4)='2874' or
		substr(dx,1,4)='2875') 
			and comorbi_21=0 
		then comorbi_21=1;
	if (substr(dx,1,3)='D65' or
		substr(dx,1,3)='D66' or
		substr(dx,1,3)='D67' or
		substr(dx,1,3)='D68' or
		substr(dx,1,4)='D691' or
		substr(dx,1,4)='D693' or
		substr(dx,1,4)='D694' or
		substr(dx,1,4)='D695' or
		substr(dx,1,4)='D696') 
			and comorbi_21=0 
		then comorbi_21=1;
	*Obesity;
	if (substr(dx,1,4)='2780'  or
		substr(dx,1,3)='E66')  
			and comorbi_22=0 
		then comorbi_22=1;
	*Weight Loss;
	if (substr(dx,1,3)='260' or
		substr(dx,1,3)='261' or
		substr(dx,1,3)='262' or
		substr(dx,1,3)='263' or
		substr(dx,1,3)='E40' or
		substr(dx,1,3)='E41' or
		substr(dx,1,3)='E42' or
		substr(dx,1,3)='E43' or
		substr(dx,1,3)='E44' or
		substr(dx,1,3)='E45' or
		substr(dx,1,3)='E46' or
		substr(dx,1,4)='R634' or
		substr(dx,1,3)='R64' ) 
			and comorbi_23=0 
		then comorbi_23=1;	
	*Fluid and Electrolyte Disorders;
	if (substr(dx,1,3)='276' or
		substr(dx,1,4)='E222' or
		substr(dx,1,3)='E86' or
		substr(dx,1,3)='E87' ) 
			and comorbi_24=0 
		then comorbi_24=1;
	*Blood Loss Anemia;
	if (substr(dx,1,4)='2800' or
		substr(dx,1,4)='D500' ) 
			and comorbi_25=0 
		then comorbi_25=1;
	*Deficiency Anemias;
	if (substr(dx,1,4)='2801' or
		substr(dx,1,4)='2808' or
		substr(dx,1,4)='2809' or
		substr(dx,1,4)='2859' or
		substr(dx,1,4)='D508' or
		substr(dx,1,3)='D509' or
		substr(dx,1,3)='D51' or
		substr(dx,1,3)='D52' or
		substr(dx,1,3)='D53' ) 
			and comorbi_26=0 
		then comorbi_26=1;
	*Alcohol Abuse;
	if (substr(dx,1,4)='2911' or
		substr(dx,1,4)='2912' or
		substr(dx,1,4)='2915' or
		substr(dx,1,4)='2918' or
		substr(dx,1,4)='2919' or
		substr(dx,1,4)='3039' or
		substr(dx,1,4)='3050' or
		substr(dx,1,4)='V113' or
		substr(dx,1,3)='F10' or
		substr(dx,1,3)='E52' or
		substr(dx,1,4)='G621' or
		substr(dx,1,4)='I426' or
		substr(dx,1,4)='K292' or
		substr(dx,1,4)='K700' or
		substr(dx,1,4)='K703' or
		substr(dx,1,4)='K709' or
		substr(dx,1,3)='T51' or
		substr(dx,1,4)='Z502' or
		substr(dx,1,4)='Z715' or
		substr(dx,1,4)='Z722') 
			and comorbi_27=0 
		then comorbi_27=1;
	*Drug Abuse;
	if (substr(dx,1,4)='2920' or
		substr(dx,1,5)='29282' or
		substr(dx,1,5)='29283' or
		substr(dx,1,5)='29284' or
		substr(dx,1,5)='29289' or
		substr(dx,1,4)='2929' or
		substr(dx,1,3)='304' or
		substr(dx,1,4)='3052' or
		substr(dx,1,4)='3053' or
		substr(dx,1,4)='3054' or
		substr(dx,1,4)='3055' or
		substr(dx,1,4)='3056' or
		substr(dx,1,4)='3057' or
		substr(dx,1,4)='3058' or
		substr(dx,1,4)='3059' or
		substr(dx,1,3)='F11' or
		substr(dx,1,3)='F12' or
		substr(dx,1,3)='F13' or
		substr(dx,1,3)='F14' or
		substr(dx,1,3)='F15' or
		substr(dx,1,3)='F16' or
		substr(dx,1,3)='F18' or
		substr(dx,1,3)='F19' or
		substr(dx,1,4)='Z715' or
		substr(dx,1,4)='Z722')
			and comorbi_28=0 
		then comorbi_28=1;	
	*Psychoses;
	if (substr(dx,1,3)='295' or
		substr(dx,1,3)='296' or
		substr(dx,1,3)='297' or
		substr(dx,1,3)='298' or
		substr(dx,1,4)='2991' or
		substr(dx,1,3)='F20' or
		substr(dx,1,3)='F22' or
		substr(dx,1,3)='F23' or
		substr(dx,1,3)='F24' or
		substr(dx,1,3)='F25' or
		substr(dx,1,3)='F28' or
		substr(dx,1,3)='F29' or
		substr(dx,1,4)='F302' or
		substr(dx,1,4)='F312' or
		substr(dx,1,4)='F315' ) 
			and comorbi_29=0 
		then comorbi_29=1;
	*Depression;
	if (substr(dx,1,4)='3004' or
		substr(dx,1,5)='30112' or
		substr(dx,1,4)='3090' or
		substr(dx,1,4)='3091' or
		substr(dx,1,3)='311' or
		substr(dx,1,3)='294' or
		substr(dx,1,4)='F313' or
		substr(dx,1,4)='F314' or
		substr(dx,1,4)='F315' or
		substr(dx,1,3)='F32' or
		substr(dx,1,3)='F33' or
		substr(dx,1,4)='F341' or
		substr(dx,1,4)='F412' or
		substr(dx,1,4)='F432' )
			and comorbi_30=0 
		then comorbi_30=1;

	*Dementia;
	if (substr(dx,1,4) in ('3310','3311','3312','2900','2901',
             '2902','2903','2912','2948','2949') or
		substr(dx,1,5) in ('29410','29411','29040','29041','29042','29043')) 
		and dementia=0 
          then dementia=1;
/*dementia*/
if (substr(dx,1,5)='F0150'
or substr(dx,1,5)='F0151'
or substr(dx,1,5)='F0280'
or substr(dx,1,5)='F0281'
or substr(dx,1,5)='F0390'
or substr(dx,1,5)='F0391'
or substr(dx,1,4)='F051'
or substr(dx,1,5)='F1027'
or substr(dx,1,5)='F1097'
or substr(dx,1,4)='G300'
or substr(dx,1,4)='G301'
or substr(dx,1,4)='G308'
or substr(dx,1,4)='G309'
or substr(dx,1,5)='G3101'
or substr(dx,1,5)='G3109'
or substr(dx,1,4)='G311'
or substr(dx,1,5)='G3183'
or substr(dx,1,4)='A811'
or substr(dx,1,4)='A812'
or substr(dx,1,4)='A818'
or substr(dx,1,5)='A8100'
or substr(dx,1,5)='A8101'
or substr(dx,1,5)='A8109'
or substr(dx,1,5)='A8181'
or substr(dx,1,5)='A8182'
or substr(dx,1,5)='A8183'
)  
		and dementia=0 
          then dementia=1;
	*CAD coronary artery disease;
	if (substr(dx,1,4) in ('4140','4142','4143','4148','4149') or 
		substr(dx,1,3) in ('410','411','412','413') or
		substr(dx,1,5) in ('V4581','V4582'))
		and cad=0 
          then cad=1;

	*ALS Amyotrophic lateral sclerosis;
	if (substr(dx,1,5)='33520') and als=0 
		then als=1;

*Renal Disease, new variable;
	*To identify diabetese with complications;
	if (substr(dx,1,5)='40311' or
		substr(dx,1,5)='40391' or
		substr(dx,1,5)='40412' or
		substr(dx,1,5)='40492' or
		substr(dx,1,3)='585' or
		substr(dx,1,3)='586' or
		substr(dx,1,4)='V420' or
		substr(dx,1,4)='V451' or
		substr(dx,1,4)='V560' or
		substr(dx,1,4)='V568') 
			and renal_dis=0 
		then renal_dis=1;

end;

run;

/*get count of each comorbidity for each id-core year combination*/
proc sql;
create table com_test1 as
select distinct bid_hrs_22, index_date,
sum(comorbi_1) as com_1,
sum(comorbi_2) as com_2,
sum(comorbi_3) as com_3,
sum(comorbi_4) as com_4,
sum(comorbi_5) as com_5,
sum(comorbi_6) as com_6,
sum(comorbi_7) as com_7,
sum(comorbi_8) as com_8,
sum(comorbi_9) as com_9,
sum(comorbi_10) as com_10,
sum(comorbi_11) as com_11,
sum(comorbi_12) as com_12,
sum(comorbi_13) as com_13,
sum(comorbi_14) as com_14,
sum(comorbi_15) as com_15,
sum(comorbi_16) as com_16,
sum(comorbi_17) as com_17,
sum(comorbi_18) as com_18,
sum(comorbi_19) as com_19,
sum(comorbi_20) as com_20,
sum(comorbi_21) as com_21,
sum(comorbi_22) as com_22,
sum(comorbi_23) as com_23,
sum(comorbi_24) as com_24,
sum(comorbi_25) as com_25,
sum(comorbi_26) as com_26,
sum(comorbi_27) as com_27,
sum(comorbi_28) as com_28,
sum(comorbi_29) as com_29,
sum(comorbi_30) as com_30,
sum(dementia) as dementia,
sum(cad) as cad,
sum(als) as als,
sum(renal_dis) as renal_dis
from dx_31_comor
group by bid_hrs_22, index_date;
quit;

/*convert counts of diagnoses for each comorbidity to indicator variables*/ 
data comorbidity_1(keep=bid_hrs_22 index_date comorb_1-comorb_34 comorb_all);
set com_test1;
array list_com com_1-com_30 dementia cad als renal_dis;
array list_com_bin comorb_1-comorb_34 ;

do over list_com;
  list_com_bin=0;

  if list_com>0 then do;
    list_com_bin=1;
   end;

end;
/*note this comorb_all count does not include CAD or ALS or Renal disease*/
comorb_all=comorb_1+comorb_2+comorb_3+comorb_4+comorb_5+comorb_6+comorb_7+comorb_8+comorb_9+comorb_10
+comorb_11+comorb_12+comorb_13+comorb_14+comorb_15+comorb_16+comorb_17+comorb_18+comorb_19+comorb_20
+comorb_21+comorb_22+comorb_23+comorb_24+comorb_25+comorb_26+comorb_27+comorb_28+comorb_29+comorb_30
+comorb_31;

run;

/*merge in to list of core ivw dates for those with ffs mc, age=65+ */
proc sort data=comorbidity_1 nodupkey;
by bid_hrs_22 index_date;
run;

data elix_&range1._&range2;
set comorbidity_1 ;

label comorb_1 ="Congestive Heart Failure";
label comorb_2 ="Cardiac Arrhythmias";
label comorb_3 ="Valvular Disease";
label comorb_4 ="Pulmonary Circulation Disorders";
label comorb_5 ="Peripheral Vascular Disorders";
label comorb_6 ="Hypertension";
label comorb_7 ="Paralysis";
label comorb_8 ="Other Neurological Disorders";
label comorb_9 ="Chronic Pulmonary Disease";
label comorb_10 ="Diabetes, uncomplicated";
label comorb_11 ="Diabetes, complicated";
label comorb_12 ="Hypothyroidism";
label comorb_13 ="Renal Failure";
label comorb_14 ="Advanced Liver Disease or Cirrhosis";
label comorb_15 ="Peptic Ulcer Disease excluding bleeding";
label comorb_16 ="AIDS";
label comorb_17 ="Lymphoma";
label comorb_18 ="Metastatic or Hematologic Cancer";
label comorb_19 ="Solid Tumor without Metastisis";
label comorb_20 ="Rheumatoid Arthritis/Collagen Vascular Diseases";
label comorb_21 ="Coagulopathy";
label comorb_22 ="Obesity";
label comorb_23 ="Weight Loss";
label comorb_24 ="Fluid and Electrolyte Disorders";
label comorb_25 ="Blood Loss Anemia";
label comorb_26 ="Deficiency Anemias";
label comorb_27 ="Alcohol Abuse";
label comorb_28 ="Drug Abuse";
label comorb_29 ="Psychoses";
label comorb_30 ="Depression";
label comorb_31 ="Dementia";
label comorb_32 ="CAD";
label comorb_33 ="ALS";
label comorb_34 ="Renal Disease";
label comorb_all ="Count of Elix comorbidities";
run;

data test;
set elix_&range1._&range2;
run;

%rename(WORK,TEST,&range1._&range2);

data elix_&range1._&range2.(rename =(bid_hrs_22_&range1._&range2=bid_hrs_22
index_date_&range1._&range2=index_date));
set test;
keep bid_hrs_22_&range1._&range2 comorb: index_date:;
run;


%mend;








/*I do not understand why this doesn't work
%macro runelix(years=);
%do i=1 %to &years.;
%let l=%eval(&i.-1);

%elixhauser(range1=%eval(&l.*12)m, range2=%eval(&i.*12)m);

%end;
%mend;

%runelix(years=7);

*/

%elixhauser(range1=0m, range2=12m);
%elixhauser(range1=12m, range2=24m);
%elixhauser(range1=24m, range2=36m);
%elixhauser(range1=36m, range2=48m);
%elixhauser(range1=48m, range2=60m);
%elixhauser(range1=60m, range2=72m);
%elixhauser(range1=72m, range2=84m);



proc sql; 
create table proj_int.elix as select * from
proj_int.index a
left join 
elix_0m_12m b
on a.bid_hrs_22=b.bid_hrs_22 and a.index_date=b.index_date
left join 
elix_12m_24m c
on a.bid_hrs_22=c.bid_hrs_22 and a.index_date=c.index_date
left join 
elix_24m_36m d
on a.bid_hrs_22=d.bid_hrs_22 and a.index_date=d.index_date
left join 
elix_36m_48m e
on a.bid_hrs_22=e.bid_hrs_22 and a.index_date=e.index_date
left join 
elix_48m_60m f
on a.bid_hrs_22=f.bid_hrs_22 and a.index_date=f.index_date
left join 
elix_60m_72m g
on a.bid_hrs_22=g.bid_hrs_22 and a.index_date=g.index_date
left join 
elix_72m_84m h
on a.bid_hrs_22=h.bid_hrs_22 and a.index_date=h.index_date;
quit;


H="Charlson comorbidities"
/*

Created by: EBL
Date Created: 2/8/19

Updated by: EBL
Date Updated: 2/13/19

Notes: Brings in Charlson charlsondities to R01 dataset, including ICD-10 Charlson.  


**************************************************


/*Add indicator variables for the Charlson charlsondities
and Charlson weighted and unweighted index */

/*Charlson code

This program reads through the diagnosis codes of patient abstract records in a hospital
    file and identifies whether the record belongs to one (or more) of 17 different Charlson
    charlsondity Index (CCI) groups.  The groups are identified by using the Enhanced ICD-9-CM
    diagnosis codes listed in Quan et al., "Coding Algorithms for Defining charlsondities
    in ICD-9-CM and ICD-10 Administrative Data", Medical Care:43(11), Nov. 2005 p1130-1139.*/

/*final datasets to be merged are proj_int.charls_0_1yr and proj_int.charls_0_2yr*/

/****************************************************************************/
/* Rename variables macro                                                   */
/****************************************************************************/

%macro rename(lib,dsn,pre);
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "Before Renaming All Variables";
run;
proc sql noprint;
select nvar into :num_vars
from dictionary.tables
where libname="&LIB" and
memname="&DSN";
select distinct(name) into :var1-
:var%TRIM(%LEFT(&num_vars))
from dictionary.columns
where libname="&LIB" and
memname="&DSN";
quit;
run;
proc datasets library=&LIB;
modify &DSN;
rename
%do i=1 %to &num_vars;
&&var&i=&&var&i.._&pre 
%end;
;
quit;
run;
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "After Renaming All Variables";
run;
%mend rename;


%macro charlson(range1=,range2=);

data dx_charlson;
set proj_int.dx_&range1._&range2.(rename=(diag=dx_0));
dx=trim(left(dx_0));

if dx~="" then do;

*initialize variables;
   charlson_1=0;
   charlson_2=0;
   charlson_3=0;
   charlson_4=0;
   charlson_5=0;
   charlson_6=0;
      charlson_7=0;
	     charlson_8=0;
		    charlson_9=0;
			   charlson_10=0;
			      charlson_11=0;
				     charlson_12=0;
					    charlson_13=0;
						   charlson_14=0;
						      charlson_15=0;
							     charlson_16=0;
								    charlson_17=0;



 *Myocardial Infarction;
		if(substr(dx,1,3)='410' or
               substr(dx,1,3)='412' or
			   substr(dx,1,3)='I21' or
               substr(dx,1,3)='I22' or
               substr(dx,1,4)='I252')
			and charlson_1=0 
		then charlson_1=1;
*Congestive Heart Failure;
   if(substr(dx,1,3)='428' or
   			   substr(dx,1,4)='I099' or
               substr(dx,1,4)='I110' or
               substr(dx,1,4)='I130' or
               substr(dx,1,4)='I132' or
               substr(dx,1,4)='I255' or
               substr(dx,1,4)='I420' or
               substr(dx,1,4)='I425' or
               substr(dx,1,4)='I426' or
               substr(dx,1,4)='I427' or
               substr(dx,1,4)='I428' or
               substr(dx,1,4)='I429' or
               substr(dx,1,3)='I43'  or
               substr(dx,1,3)='I50'  or
               substr(dx,1,4)='P290')
		and charlson_2=0 
		then charlson_2=1;*add one binary variables here.;

*Periphral Vascular Disease;
		if(substr(dx,1,4)='0930' or
               substr(dx,1,4)='4373' or
               substr(dx,1,3)='440' or
               substr(dx,1,3)='441' or
               substr(dx,1,4)='4431' or
               substr(dx,1,4)='4432' or
               substr(dx,1,4)='4438' or
               substr(dx,1,4)='4439' or
               substr(dx,1,4)='4471' or
               substr(dx,1,4)='5571' or
               substr(dx,1,4)='5579' or
               substr(dx,1,4)='V434' or
    		   substr(dx,1,3)='I70' or
               substr(dx,1,3)='I71' or
               substr(dx,1,4)='I731' or
               substr(dx,1,4)='I738' or
               substr(dx,1,4)='I739' or
               substr(dx,1,4)='I771' or
               substr(dx,1,4)='I790' or
               substr(dx,1,4)='I792' or
               substr(dx,1,4)='K551' or
               substr(dx,1,4)='K558' or
               substr(dx,1,4)='K559' or
			   substr(dx,1,4)='Z958' or
               substr(dx,1,4)='Z959')
			and charlson_3=0 
		then charlson_3=1;
 *Cerebrovascular Disease ;
        if(substr(dx,1,5)='36234' or
               substr(dx,1,3)='430' or
               substr(dx,1,3)='431' or
               substr(dx,1,3)='432' or
               substr(dx,1,3)='433' or
               substr(dx,1,3)='434' or
               substr(dx,1,3)='435' or
               substr(dx,1,3)='436' or
               substr(dx,1,3)='437' or
               substr(dx,1,3)='438' or
			   substr(dx,1,3)='G45' or
               substr(dx,1,3)='G46' or
               substr(dx,1,4)='H340' or
               substr(dx,1,3)='I60' or
               substr(dx,1,3)='I61' or
               substr(dx,1,3)='I62' or
               substr(dx,1,3)='I63' or
               substr(dx,1,3)='I64' or
               substr(dx,1,3)='I65' or
			   substr(dx,1,3)='I66' or
               substr(dx,1,3)='I67' or
               substr(dx,1,3)='I68' or
               substr(dx,1,3)='I69')
			and charlson_4=0 
		then charlson_4=1;
*Dementia ;
       if(substr(dx,1,3)='290' or
               substr(dx,1,4)='2941' or
               substr(dx,1,4)='3312' or
			   substr(dx,1,3)='F00' or
               substr(dx,1,3)='F01' or
               substr(dx,1,3)='F02' or
               substr(dx,1,3)='F03' or
               substr(dx,1,4)='F051' or
               substr(dx,1,3)='G30' or
               substr(dx,1,4)='G311')
			and charlson_5=0 
		then charlson_5=1;
	*Chronic Pulmonary Disease ;
        if(substr(dx,1,4)='4168' or
               substr(dx,1,4)='4169' or
               substr(dx,1,3)='490' or
               substr(dx,1,3)='491' or
               substr(dx,1,3)='492' or
               substr(dx,1,3)='493' or
               substr(dx,1,3)='494' or
               substr(dx,1,3)='495' or
               substr(dx,1,3)='496' or
               substr(dx,1,3)='500' or
               substr(dx,1,3)='501' or
               substr(dx,1,3)='502' or
               substr(dx,1,3)='503' or
               substr(dx,1,3)='504' or
               substr(dx,1,3)='505' or
               substr(dx,1,4)='5064' or
               substr(dx,1,4)='5081' or
               substr(dx,1,4)='5088' or
			   substr(dx,1,4)='I278' or
               substr(dx,1,4)='I279' or
               substr(dx,1,3)='J40' or
               substr(dx,1,3)='J41' or
               substr(dx,1,3)='J42' or
               substr(dx,1,3)='J43' or
               substr(dx,1,3)='J44' or
               substr(dx,1,3)='J45' or
               substr(dx,1,3)='J46' or
               substr(dx,1,3)='J47' or
               substr(dx,1,3)='J60' or
               substr(dx,1,3)='J61' or
               substr(dx,1,3)='J62' or
               substr(dx,1,3)='J63' or
               substr(dx,1,3)='J64' or
               substr(dx,1,3)='J65' or
               substr(dx,1,3)='J66' or
			   substr(dx,1,3)='J67' or
               substr(dx,1,4)='J684' or
               substr(dx,1,4)='J701' or
               substr(dx,1,4)='J703')
			and charlson_6=0 
		then charlson_6=1;
*Connective Tissue Disease-Rheumatic Disease;
         if(substr(dx,1,4)='4465' or
               substr(dx,1,4)='7100' or
               substr(dx,1,4)='7101' or
               substr(dx,1,4)='7102' or
               substr(dx,1,4)='7103' or
               substr(dx,1,4)='7104' or
               substr(dx,1,4)='7140' or
               substr(dx,1,4)='7141' or
               substr(dx,1,4)='7142' or
               substr(dx,1,4)='7148' or
               substr(dx,1,3)='725' or
			   substr(dx,1,3)='M05' or
               substr(dx,1,3)='M06' or
               substr(dx,1,4)='M315' or
               substr(dx,1,3)='M32' or
               substr(dx,1,3)='M33' or
               substr(dx,1,3)='M34' or
               substr(dx,1,4)='M351' or
               substr(dx,1,4)='M353' or
               substr(dx,1,4)='M360')
			and charlson_7=0 
		then charlson_7=1;
*Peptic Ulcer Disease;
         if(substr(dx,1,3)='531' or
               substr(dx,1,3)='532' or
               substr(dx,1,3)='533' or
               substr(dx,1,3)='534' or
			   substr(dx,1,3)='K25' or
               substr(dx,1,3)='K26' or
               substr(dx,1,3)='K27' or
               substr(dx,1,3)='K28')
			and charlson_8=0 
		then charlson_8=1;	
*Mild Liver Disease ;
         if(substr(dx,1,5)='07022' or
               substr(dx,1,5)='07023' or
               substr(dx,1,5)='07032' or
               substr(dx,1,5)='07033' or
               substr(dx,1,5)='07044' or
               substr(dx,1,5)='07054' or
               substr(dx,1,4)='0706' or
               substr(dx,1,4)='0709' or
               substr(dx,1,3)='570' or
               substr(dx,1,3)='571' or
               substr(dx,1,4)='5733' or
               substr(dx,1,4)='5734' or
               substr(dx,1,4)='5738' or
               substr(dx,1,4)='5739' or
               substr(dx,1,4)='V427' or
			   substr(dx,1,3)='B18' or
               substr(dx,1,4)='K700' or
               substr(dx,1,4)='K701' or
               substr(dx,1,4)='K702' or
               substr(dx,1,4)='K703' or
               substr(dx,1,4)='K709' or
               substr(dx,1,4)='K713' or
               substr(dx,1,4)='K714' or
               substr(dx,1,4)='K715' or
               substr(dx,1,4)='K717' or
               substr(dx,1,3)='K73' or
               substr(dx,1,3)='K74' or
               substr(dx,1,4)='K76' or
               substr(dx,1,4)='K762' or
			   substr(dx,1,4)='K763' or
               substr(dx,1,4)='K764' or
               substr(dx,1,4)='K768' or
			   substr(dx,1,4)='K769' or
               substr(dx,1,4)='Z944')
			and charlson_9=0 
		then charlson_9=1;	
*Diabetes without complications ;
         if(substr(dx,1,4)='2500' or
               substr(dx,1,4)='2501' or
               substr(dx,1,4)='2502' or
               substr(dx,1,4)='2503' or
               substr(dx,1,4)='2508' or
               substr(dx,1,4)='2509' or
			substr(dx,1,4)='E100' or
		substr(dx,1,4)='E101' or
		substr(dx,1,4)='E106' or
		substr(dx,1,4)='E108' or
		substr(dx,1,4)='E109' or
		substr(dx,1,4)='E110' or
        substr(dx,1,4)='E111' or
		substr(dx,1,4)='E116' or
		substr(dx,1,4)='E118' or
		substr(dx,1,4)='E119' or
		substr(dx,1,4)='E120' or
		substr(dx,1,4)='E121' or
		substr(dx,1,4)='E126' or
		substr(dx,1,4)='E128' or
		substr(dx,1,4)='E129' or
		substr(dx,1,4)='E130' or
		substr(dx,1,4)='E131' or
		substr(dx,1,4)='E136' or
		substr(dx,1,4)='E138' or
        substr(dx,1,4)='E139' or
		substr(dx,1,4)='E140' or
		substr(dx,1,4)='E141' or
		substr(dx,1,4)='E146' or
		substr(dx,1,4)='E148' or
		substr(dx,1,4)='E149')
			and charlson_10=0 
		then charlson_10=1;
*Diabetes, complicated;
	if (substr(dx,1,4)='2504' or
		substr(dx,1,4)='2505' or
		substr(dx,1,4)='2506' or
		substr(dx,1,4)='2507' or
        substr(dx,1,4)='E102' or
		substr(dx,1,4)='E103' or
		substr(dx,1,4)='E104' or
		substr(dx,1,4)='E105' or
		substr(dx,1,4)='E107' or
		substr(dx,1,4)='E112' or
		substr(dx,1,4)='E113' or
		substr(dx,1,4)='E114' or
        substr(dx,1,4)='E115' or
		substr(dx,1,4)='E117' or
        substr(dx,1,4)='E122' or
		substr(dx,1,4)='E123' or
		substr(dx,1,4)='E124' or
		substr(dx,1,4)='E125' or
		substr(dx,1,4)='E127' or
		substr(dx,1,4)='E132' or
		substr(dx,1,4)='E133' or
		substr(dx,1,4)='E134' or
        substr(dx,1,4)='E135' or
		substr(dx,1,4)='E137' or
		substr(dx,1,4)='E142' or
		substr(dx,1,4)='E143' or
		substr(dx,1,4)='E144' or
        substr(dx,1,4)='E145' or
		substr(dx,1,4)='E147')
			and charlson_11=0 
		then charlson_11=1;
*Paraplegia and Hemiplegia ;
	if (substr(dx,1,4)='3341' or
		substr(dx,1,3)='342' or
		substr(dx,1,3)='343' or
		substr(dx,1,4)='3440' or
		substr(dx,1,4)='3441' or
		substr(dx,1,4)='3442' or
		substr(dx,1,4)='3443' or
                substr(dx,1,4)='3444' or
		substr(dx,1,4)='3445' or
		substr(dx,1,4)='3446' or
		substr(dx,1,4)='3449' or
		substr(dx,1,4)='G041' or
		substr(dx,1,4)='G114' or
		substr(dx,1,4)='G801' or
		substr(dx,1,4)='G802' or
		substr(dx,1,3)='G81' or
		substr(dx,1,3)='G82' or
		substr(dx,1,4)='G830' or
        substr(dx,1,4)='G834' or
		substr(dx,1,4)='G839')
			and charlson_12=0 
		then charlson_12=1;
* Renal Disease ;
	if (substr(dx,1,5)='40301' or
		substr(dx,1,5)='40311' or
		substr(dx,1,5)='40391' or
		substr(dx,1,5)='40402' or
		substr(dx,1,5)='40403' or
		substr(dx,1,5)='40412' or
		substr(dx,1,5)='40413' or
                substr(dx,1,5)='40492' or
		substr(dx,1,5)='40493' or
		substr(dx,1,3)='582' or
		substr(dx,1,4)='5830' or
                substr(dx,1,4)='5831' or
                substr(dx,1,4)='5832' or
                substr(dx,1,4)='5834' or
                substr(dx,1,4)='5836' or
                substr(dx,1,4)='5837' or
                substr(dx,1,3)='585' or
                substr(dx,1,3)='586' or
                substr(dx,1,4)='5880' or
                substr(dx,1,4)='V420' or
                substr(dx,1,4)='V451' or
                substr(dx,1,3)='V56' or
			substr(dx,1,4)='I120' or
		substr(dx,1,4)='I131' or
		substr(dx,1,4)='N032' or
		substr(dx,1,4)='N033' or
		substr(dx,1,4)='N034' or
		substr(dx,1,4)='N035' or
		substr(dx,1,4)='N036' or
        substr(dx,1,4)='N037' or
		substr(dx,1,4)='N052' or
		substr(dx,1,4)='N053' or
		substr(dx,1,4)='N054' or
                substr(dx,1,4)='N055' or
                substr(dx,1,4)='N056' or
                substr(dx,1,4)='N057' or
                substr(dx,1,3)='N18' or
                substr(dx,1,3)='N19' or
                substr(dx,1,4)='N250' or
                substr(dx,1,4)='Z490' or
                substr(dx,1,4)='Z491' or
                substr(dx,1,4)='Z492' or
                substr(dx,1,4)='Z940' or
                substr(dx,1,4)='Z992' )
			and charlson_13=0 
		then charlson_13=1;
*Cancer ;
	if (substr(dx,1,2)='14' or
		substr(dx,1,2)='15' or
		substr(dx,1,2)='16' or
		substr(dx,1,3)='170' or
		substr(dx,1,3)='171' or
		substr(dx,1,3)='172' or
		substr(dx,1,3)='174' or
		substr(dx,1,3)='175' or
		substr(dx,1,3)='176' or
		substr(dx,1,3)='179' or
		substr(dx,1,2)='18' or
		substr(dx,1,3)='190' or
		substr(dx,1,3)='191' or
		substr(dx,1,3)='192' or
		substr(dx,1,3)='193' or
		substr(dx,1,3)='194' or
		substr(dx,1,3)='195' or
                substr(dx,1,3)='200' or
                substr(dx,1,3)='201' or
                substr(dx,1,3)='202' or
                substr(dx,1,3)='203' or
                substr(dx,1,3)='204' or
                substr(dx,1,3)='205' or
                substr(dx,1,3)='206' or
                substr(dx,1,3)='207' or
                substr(dx,1,3)='208' or
                substr(dx,1,4)='2386' or
			substr(dx,1,3)='C00' or
		substr(dx,1,3)='C01' or
		substr(dx,1,3)='C02' or
		substr(dx,1,3)='C03' or
		substr(dx,1,3)='C04' or
		substr(dx,1,3)='C05' or
		substr(dx,1,3)='C06' or
		substr(dx,1,3)='C07' or
		substr(dx,1,3)='C08' or
		substr(dx,1,3)='C09' or
		substr(dx,1,3)='C10' or
		substr(dx,1,3)='C11' or
		substr(dx,1,3)='C12' or
		substr(dx,1,3)='C13' or
		substr(dx,1,3)='C14' or
		substr(dx,1,3)='C15' or
		substr(dx,1,3)='C16' or
		substr(dx,1,3)='C17' or
		substr(dx,1,3)='C18' or
		substr(dx,1,3)='C19' or
		substr(dx,1,3)='C20' or
		substr(dx,1,3)='C21' or
		substr(dx,1,3)='C22' or
		substr(dx,1,3)='C23' or
		substr(dx,1,3)='C24' or
		substr(dx,1,3)='C25' or
		substr(dx,1,3)='C26' or
		substr(dx,1,3)='C30' or
		substr(dx,1,3)='C31' or
		substr(dx,1,3)='C32' or
		substr(dx,1,3)='C33' or
		substr(dx,1,3)='C34' or
		substr(dx,1,3)='C37' or
		substr(dx,1,3)='C38' or
		substr(dx,1,3)='C39' or
		substr(dx,1,3)='C40' or
		substr(dx,1,3)='C41' or
		substr(dx,1,3)='C43' or
		substr(dx,1,3)='C45' or
		substr(dx,1,3)='C46' or
		substr(dx,1,3)='C47' or
		substr(dx,1,3)='C48' or
		substr(dx,1,3)='C49' or
		substr(dx,1,3)='C50' or
		substr(dx,1,3)='C51' or
		substr(dx,1,3)='C52' or
		substr(dx,1,3)='C53' or
		substr(dx,1,3)='C54' or
		substr(dx,1,3)='C55' or
		substr(dx,1,3)='C56' or
		substr(dx,1,3)='C57' or
		substr(dx,1,3)='C58' or
		substr(dx,1,3)='C60' or
		substr(dx,1,3)='C61' or
		substr(dx,1,3)='C62' or
		substr(dx,1,3)='C63' or
		substr(dx,1,3)='C64' or
		substr(dx,1,3)='C65' or
		substr(dx,1,3)='C66' or
		substr(dx,1,3)='C67' or
		substr(dx,1,3)='C68' or
		substr(dx,1,3)='C69' or
		substr(dx,1,3)='C70' or
		substr(dx,1,3)='C71' or
		substr(dx,1,3)='C72' or
		substr(dx,1,3)='C73' or
		substr(dx,1,3)='C74' or
		substr(dx,1,3)='C75' or
		substr(dx,1,3)='C76' or
                substr(dx,1,3)='C81' or
                substr(dx,1,3)='C82' or
                substr(dx,1,3)='C83' or
                substr(dx,1,3)='C84' or
                substr(dx,1,3)='C85' or
                substr(dx,1,3)='C88' or
                substr(dx,1,3)='C90' or
                substr(dx,1,3)='C91' or
                substr(dx,1,3)='C92' or
                substr(dx,1,3)='C93' or
                substr(dx,1,3)='C94' or
                substr(dx,1,3)='C95' or
                substr(dx,1,3)='C96' or 
                substr(dx,1,3)='C97')
			and charlson_14=0 
		then charlson_14=1;
* Moderate or Severe Liver Disease ;
	if (substr(dx,1,4)='4560' or
		substr(dx,1,4)='4561' or
		substr(dx,1,4)='4562' or
		substr(dx,1,4)='5722' or
		substr(dx,1,4)='5723' or
		substr(dx,1,4)='5724' or
      	substr(dx,1,4)='5728' or
		substr(dx,1,4)='I850' or
		substr(dx,1,4)='I859' or
		substr(dx,1,4)='I864' or
		substr(dx,1,4)='I982' or
		substr(dx,1,4)='K704' or
		substr(dx,1,4)='K711' or
		substr(dx,1,4)='K721' or
        substr(dx,1,4)='K729' or
        substr(dx,1,4)='K765' or
        substr(dx,1,4)='K766' or
        substr(dx,1,4)='K767')
		and charlson_15=0 
		then charlson_15=1;
  * Metastatic Carcinoma ;
	if (substr(dx,1,3)='196' or
		substr(dx,1,3)='197' or
		substr(dx,1,3)='198' or
		substr(dx,1,3)='199' OR
	substr(dx,1,3)='C77' or
		substr(dx,1,3)='C78' or
		substr(dx,1,3)='C79' or
		substr(dx,1,3)='C80' )
			and charlson_16=0 
		then charlson_16=1;
  * AIDS/HIV ;
	if (substr(dx,1,3)='042' or
		substr(dx,1,3)='043' or
		substr(dx,1,3)='044' or
		substr(dx,1,3)='B20' or
		substr(dx,1,3)='B21' or
        substr(dx,1,3)='B22' or
		substr(dx,1,3)='B24')
			and charlson_17=0 
		then charlson_17=1;

end;


run;




/*get count of each charlsondity for each id-core year combination*/
proc sql;
create table cha_test1 as
select distinct bid_hrs_22,index_date,
sum(charlson_1) as cha_1,
sum(charlson_2) as cha_2,
sum(charlson_3) as cha_3,
sum(charlson_4) as cha_4,
sum(charlson_5) as cha_5,
sum(charlson_6) as cha_6,
sum(charlson_7) as cha_7,
sum(charlson_8) as cha_8,
sum(charlson_9) as cha_9,
sum(charlson_10) as cha_10,
sum(charlson_11) as cha_11,
sum(charlson_12) as cha_12,
sum(charlson_13) as cha_13,
sum(charlson_14) as cha_14,
sum(charlson_15) as cha_15,
sum(charlson_16) as cha_16,
sum(charlson_17) as cha_17
from dx_charlson
group by bid_hrs_22,index_date;
quit;

/*convert counts of diagnoses for each charlsondity to indicator variables*/ 
data charlson_1(keep=bid_hrs_22 index_date charls_1-charls_17 charls_index charls_index_wt);
set cha_test1;
array list_cha cha_1-cha_17;
array list_cha_bin charls_1-charls_17 ;

do over list_cha;
  list_cha_bin=0;

  if list_cha>0 then do;
    list_cha_bin=1;
   end;

end;
/*note this charls_index count count is not weighted for morbidity*/
charls_index=charls_1+charls_2+charls_3+charls_4+charls_5+charls_6+charls_7+charls_8+charls_9+charls_10
+charls_11+charls_12+charls_13+charls_14+charls_15+charls_16+charls_17;
/*now morbidity weighted*/
charls_index_wt=charls_1+charls_2+charls_3+charls_4+charls_5+charls_6+charls_7+charls_8+charls_9+charls_10
+2*charls_11+2*charls_12+2*charls_13+2*charls_14+3*charls_15+6*charls_16+6*charls_17;

label charls_1 ="Myocardial infarction, Charlson";
label charls_2 ="Congestive Heart Failure, Charlson";
label charls_3 ="Peripheral Vascular Disease, Charlson";
label charls_4 ="Cerebrovascular disease, Charlson";
label charls_5 ="Dementia, Charlson";
label charls_6 ="Chronic Pulmonary Disease, Charlson";
label charls_7 ="Rheumatic disease, Charlson";
label charls_8 ="Peptic ulcer disease, Charlson";
label charls_9 ="Mild liver disease, Charlson";
label charls_10 ="Diabetes, uncomplicated, Charlson";
label charls_11 ="Diabetes, complicated, Charlson";
label charls_12 ="Hemiplegia or paraplegia, Charlson";
label charls_13 ="Renal disease, Charlson";
label charls_14 ="Any malignancy except neoplasm of skin, Charlson";
label charls_15 ="Mod or severe liver disease, Charlson";
label charls_16 ="Metastatic solid tumor, Charlson";
label charls_17 ="AIDS/HIV, Charlson";
label charls_index ="Charlson score index, not weighted";
label charls_index_wt ="Charlson score index, weighted";

run;

/*merge into list of obs with ffs mc 6m prior to ivw*/
proc sort data=charlson_1 out=test nodupkey;
by bid_hrs_22 index_date;
run;



%rename(WORK,TEST,&range1._&range2);

data proj_int.charls_&range1._&range2.(rename =(bid_hrs_22_&range1._&range2=bid_hrs_22
index_date_&range1._&range2=index_date));
set test;
keep bid_hrs_22_&range1._&range2 charls: index_date:;
run;
proc sort data=proj_int.charls_&range1._&range2.;
by bid_hrs_22 index_date;
run;

%mend;

%charlson(range1=0d, range2=n12m);


proc freq data=proj_int.charls_0d_n12m;
table charls:;
run;





H="CCW CCs"
/*

Created by: EBL
Date Created: 4/12/19

Updated by:
Date Updated:




**************************************************

/****************************************************************************/
/* Rename variables macro                                                   */
/****************************************************************************/

%macro rename(lib,dsn,pre);
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "Before Renaming All Variables";
run;
proc sql noprint;
select nvar into :num_vars
from dictionary.tables
where libname="&LIB" and
memname="&DSN";
select distinct(name) into :var1-
:var%TRIM(%LEFT(&num_vars))
from dictionary.columns
where libname="&LIB" and
memname="&DSN";
quit;
run;
proc datasets library=&LIB;
modify &DSN;
rename
%do i=1 %to &num_vars;
&&var&i=&&var&i.._&pre 
%end;
;
quit;
run;
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "After Renaming All Variables";
run;
%mend rename;



%macro ccw(range1=,range2=);

data dx_ccw;
set proj_int.dx_&range1._&range2.(rename=(diag=dx_0));
dx=trim(left(dx_0));

if dx~='' then do;

*initialize variables;
   ccw_1=0;
   ccw_2=0;
   ccw_3=0;
   ccw_4=0;
   ccw_5=0;
   ccw_6=0;
      ccw_7=0;
	     ccw_8=0;
		    ccw_9=0;
			   ccw_10=0;
			      ccw_11=0;
				     ccw_12=0;
					    ccw_13=0;
						   ccw_14=0;
						      ccw_15=0;
							     ccw_16=0;
								    ccw_17=0;
	     ccw_18=0;
		    ccw_19=0;
			   ccw_20=0;
			      ccw_21=0;
				     ccw_22=0;
					    ccw_23=0;
						   ccw_24=0;
						      ccw_25=0;
							     ccw_26=0;
								    ccw_27=0;
*do over dx;
   *Acquired Hypothyroidism;
   if (substr(dx,1,4) =	'2441'
or substr(dx,1,4) =	'2442'
or substr(dx,1,4) =	'2443'
or substr(dx,1,4) =	'2448'
or substr(dx,1,4) =	'2449'
or substr(dx,1,4) =	'2440'
or substr(dx,1,4) =	'E018'
or substr(dx,1,3) =	'E02'
or substr(dx,1,4) =	'E032'
or substr(dx,1,4) =	'E033'
or substr(dx,1,4) =	'E038'
or substr(dx,1,4) =	'E039'
or substr(dx,1,4) =	'E890')

               and ccw_1=0
               then ccw_1=1;
   *AMI;
   if (substr(dx,1,5) =	'41001'
or substr(dx,1,5) =	'41011'
or substr(dx,1,5) =	'41021'
or substr(dx,1,5) =	'41031'
or substr(dx,1,5) =	'41041'
or substr(dx,1,5) =	'41051'
or substr(dx,1,5) =	'41061'
or substr(dx,1,5) =	'41071'
or substr(dx,1,5) =	'41081'
or substr(dx,1,5) =	'41091'
or substr(dx,1,5) =	'I2101'
or substr(dx,1,5) =	'I2102'
or substr(dx,1,5) =	'I2109'
or substr(dx,1,5) =	'I2111'
or substr(dx,1,5) =	'I2119'
or substr(dx,1,5) =	'I2121'
or substr(dx,1,5) =	'I2129'
or substr(dx,1,4) =	'I213'
or substr(dx,1,4) =	'I214'
or substr(dx,1,4) =	'I219'
or substr(dx,1,5) =	'I21A1'
or substr(dx,1,5) =	'I21A9'
or substr(dx,1,4) =	'I220'
or substr(dx,1,4) =	'I221'
or substr(dx,1,4) =	'I222'
or substr(dx,1,4) =	'I228'
or substr(dx,1,4) =	'I229')
               and ccw_2=0
               then ccw_2=1;
   *Alzheimers Disease;
    if (substr(dx,1,4) =	'3310'
or substr(dx,1,4) =	'G300'
or substr(dx,1,4) =	'G301'
or substr(dx,1,4) =	'G308'
or substr(dx,1,4) =	'G309')
               and ccw_3=0
               then ccw_3=1;
    *Alzheimers and Related Disorders or Senile Dementia ;
     if (substr(dx,1,5) =	'29011'
or substr(dx,1,5) =	'29012'
or substr(dx,1,5) =	'29013'
or substr(dx,1,5) =	'29010'
or substr(dx,1,5) =	'29021'
or substr(dx,1,5) =	'29020'
or substr(dx,1,4) =	'2903'
or substr(dx,1,5) =	'29041'
or substr(dx,1,5) =	'29042'
or substr(dx,1,5) =	'29043'
or substr(dx,1,5) =	'29040'
or substr(dx,1,5) =	'29000'
or substr(dx,1,5) =	'29411'
or substr(dx,1,5) =	'29410'
or substr(dx,1,5) =	'29421'
or substr(dx,1,5) =	'29420'
or substr(dx,1,4) =	'2948'
or substr(dx,1,4) =	'2940'
or substr(dx,1,5) =	'33111'
or substr(dx,1,5) =	'33119'
or substr(dx,1,4) =	'3312'
or substr(dx,1,4) =	'3317'
or substr(dx,1,4) =	'3310'
or substr(dx,1,3) =	'797'
or substr(dx,1,5) =	'F0150'
or substr(dx,1,5) =	'F0151'
or substr(dx,1,5) =	'F0280'
or substr(dx,1,5) =	'F0281'
or substr(dx,1,5) =	'F0390'
or substr(dx,1,5) =	'F0391'
or substr(dx,1,3) =	'F04'
or substr(dx,1,3) =	'F05'
or substr(dx,1,4) =	'F061'
or substr(dx,1,4) =	'F068'
or substr(dx,1,4) =	'G138'
or substr(dx,1,4) =	'G300'
or substr(dx,1,4) =	'G301'
or substr(dx,1,4) =	'G308'
or substr(dx,1,4) =	'G309'
or substr(dx,1,5) =	'G3101'
or substr(dx,1,5) =	'G3109'
or substr(dx,1,4) =	'G311'
or substr(dx,1,4) =	'G312'
or substr(dx,1,3) =	'G94'
or substr(dx,1,5) =	'R4181'
or substr(dx,1,3) =	'R54')
               and ccw_4=0
               then ccw_4=1;
   *Anemia ;
       if (substr(dx,1,4) =	'2801'
or substr(dx,1,4) =	'2808'
or substr(dx,1,4) =	'2809'
or substr(dx,1,4) =	'2800'
or substr(dx,1,4) =	'2811'
or substr(dx,1,4) =	'2812'
or substr(dx,1,4) =	'2813'
or substr(dx,1,4) =	'2814'
or substr(dx,1,4) =	'2818'
or substr(dx,1,4) =	'2819'
or substr(dx,1,4) =	'2810'
or substr(dx,1,4) =	'2821'
or substr(dx,1,4) =	'2822'
or substr(dx,1,4) =	'2823'
or substr(dx,1,5) =	'28241'
or substr(dx,1,5) =	'28242'
or substr(dx,1,5) =	'28243'
or substr(dx,1,5) =	'28244'
or substr(dx,1,5) =	'28245'
or substr(dx,1,5) =	'28246'
or substr(dx,1,5) =	'28247'
or substr(dx,1,5) =	'28249'
or substr(dx,1,5) =	'28240'
or substr(dx,1,4) =	'2825'
or substr(dx,1,5) =	'28261'
or substr(dx,1,5) =	'28262'
or substr(dx,1,5) =	'28263'
or substr(dx,1,5) =	'28264'
or substr(dx,1,5) =	'28268'
or substr(dx,1,5) =	'28269'
or substr(dx,1,5) =	'28260'
or substr(dx,1,4) =	'2827'
or substr(dx,1,4) =	'2828'
or substr(dx,1,4) =	'2829'
or substr(dx,1,4) =	'2820'
or substr(dx,1,5) =	'28311'
or substr(dx,1,5) =	'28319'
or substr(dx,1,4) =	'2831'
or substr(dx,1,4) =	'2832'
or substr(dx,1,4) =	'2839'
or substr(dx,1,4) =	'2830'
or substr(dx,1,5) =	'28401'
or substr(dx,1,5) =	'28409'
or substr(dx,1,5) =	'28411'
or substr(dx,1,5) =	'28412'
or substr(dx,1,5) =	'28419'
or substr(dx,1,4) =	'2842'
or substr(dx,1,5) =	'28481'
or substr(dx,1,5) =	'28489'
or substr(dx,1,4) =	'2849'
or substr(dx,1,4) =	'2851'
or substr(dx,1,5) =	'28521'
or substr(dx,1,5) =	'28522'
or substr(dx,1,5) =	'28529'
or substr(dx,1,4) =	'2853'
or substr(dx,1,4) =	'2858'
or substr(dx,1,4) =	'2859'
or substr(dx,1,4) =	'2850'
or substr(dx,1,4) =	'D500'
or substr(dx,1,4) =	'D501'
or substr(dx,1,4) =	'D508'
or substr(dx,1,4) =	'D509'
or substr(dx,1,4) =	'D510'
or substr(dx,1,4) =	'D511'
or substr(dx,1,4) =	'D512'
or substr(dx,1,4) =	'D513'
or substr(dx,1,4) =	'D518'
or substr(dx,1,4) =	'D519'
or substr(dx,1,4) =	'D520'
or substr(dx,1,4) =	'D521'
or substr(dx,1,4) =	'D528'
or substr(dx,1,4) =	'D529'
or substr(dx,1,4) =	'D530'
or substr(dx,1,4) =	'D531'
or substr(dx,1,4) =	'D532'
or substr(dx,1,4) =	'D538'
or substr(dx,1,4) =	'D539'
or substr(dx,1,4) =	'D550'
or substr(dx,1,4) =	'D551'
or substr(dx,1,4) =	'D552'
or substr(dx,1,4) =	'D553'
or substr(dx,1,4) =	'D558'
or substr(dx,1,4) =	'D559'
or substr(dx,1,4) =	'D560'
or substr(dx,1,4) =	'D561'
or substr(dx,1,4) =	'D562'
or substr(dx,1,4) =	'D563'
or substr(dx,1,4) =	'D564'
or substr(dx,1,4) =	'D565'
or substr(dx,1,4) =	'D568'
or substr(dx,1,4) =	'D569'
or substr(dx,1,5) =	'D5700'
or substr(dx,1,5) =	'D5701'
or substr(dx,1,5) =	'D5702'
or substr(dx,1,4) =	'D571'
or substr(dx,1,5) =	'D5720'
or substr(dx,1,6) =	'D57211'
or substr(dx,1,6) =	'D57212'
or substr(dx,1,6) =	'D57219'
or substr(dx,1,4) =	'D573'
or substr(dx,1,5) =	'D5740'
or substr(dx,1,6) =	'D57411'
or substr(dx,1,6) =	'D57412'
or substr(dx,1,6) =	'D57419'
or substr(dx,1,5) =	'D5780'
or substr(dx,1,6) =	'D57811'
or substr(dx,1,6) =	'D57812'
or substr(dx,1,6) =	'D57819'
or substr(dx,1,4) =	'D580'
or substr(dx,1,4) =	'D581'
or substr(dx,1,4) =	'D582'
or substr(dx,1,4) =	'D588'
or substr(dx,1,4) =	'D589'
or substr(dx,1,4) =	'D590'
or substr(dx,1,4) =	'D591'
or substr(dx,1,4) =	'D592'
or substr(dx,1,4) =	'D593'
or substr(dx,1,4) =	'D594'
or substr(dx,1,4) =	'D595'
or substr(dx,1,4) =	'D596'
or substr(dx,1,4) =	'D598'
or substr(dx,1,4) =	'D599'
or substr(dx,1,4) =	'D600'
or substr(dx,1,4) =	'D601'
or substr(dx,1,4) =	'D608'
or substr(dx,1,4) =	'D609'
or substr(dx,1,5) =	'D6101'
or substr(dx,1,5) =	'D6109'
or substr(dx,1,4) =	'D611'
or substr(dx,1,4) =	'D612'
or substr(dx,1,4) =	'D613'
or substr(dx,1,6) =	'D61810'
or substr(dx,1,6) =	'D61811'
or substr(dx,1,6) =	'D61818'
or substr(dx,1,5) =	'D6182'
or substr(dx,1,5) =	'D6189'
or substr(dx,1,4) =	'D619'
or substr(dx,1,3) =	'D62'
or substr(dx,1,4) =	'D630'
or substr(dx,1,4) =	'D631'
or substr(dx,1,4) =	'D638'
or substr(dx,1,4) =	'D640'
or substr(dx,1,4) =	'D641'
or substr(dx,1,4) =	'D642'
or substr(dx,1,4) =	'D643'
or substr(dx,1,4) =	'D644'
or substr(dx,1,5) =	'D6481'
or substr(dx,1,5) =	'D6489'
or substr(dx,1,4) =	'D649')
               and ccw_5=0
               then ccw_5=1;
   *Asthma ;
        if (substr(dx,1,5) =	'49301'
or substr(dx,1,5) =	'49302'
or substr(dx,1,5) =	'49311'
or substr(dx,1,5) =	'49312'
or substr(dx,1,5) =	'49310'
or substr(dx,1,5) =	'49321'
or substr(dx,1,5) =	'49322'
or substr(dx,1,5) =	'49320'
or substr(dx,1,5) =	'49381'
or substr(dx,1,5) =	'49382'
or substr(dx,1,5) =	'49391'
or substr(dx,1,5) =	'49392'
or substr(dx,1,5) =	'49390'
or substr(dx,1,5) =	'49300'
or substr(dx,1,5) =	'J4520'
or substr(dx,1,5) =	'J4521'
or substr(dx,1,5) =	'J4522'
or substr(dx,1,5) =	'J4530'
or substr(dx,1,5) =	'J4531'
or substr(dx,1,5) =	'J4532'
or substr(dx,1,5) =	'J4540'
or substr(dx,1,5) =	'J4541'
or substr(dx,1,5) =	'J4542'
or substr(dx,1,5) =	'J4550'
or substr(dx,1,5) =	'J4551'
or substr(dx,1,5) =	'J4552'
or substr(dx,1,6) =	'J45901'
or substr(dx,1,6) =	'J45902'
or substr(dx,1,6) =	'J45909'
or substr(dx,1,6) =	'J45990'
or substr(dx,1,6) =	'J45991'
or substr(dx,1,6) =	'J45998')
               and ccw_6=0
               then ccw_6=1;
*Atrial Fibrillation;
         if (substr(dx,1,5) =	'42731'
or substr(dx,1,4) =	'I480'
or substr(dx,1,4) =	'I481'
or substr(dx,1,4) =	'I482'
or substr(dx,1,5) =	'I4891')
               and ccw_7=0
               then ccw_7=1;
 *Benign Prostatic Hyperplasia;
         if (substr(dx,1,5) =	'60001'
or substr(dx,1,5) =	'60011'
or substr(dx,1,5) =	'60010'
or substr(dx,1,5) =	'60021'
or substr(dx,1,5) =	'60020'
or substr(dx,1,5) =	'60030'
or substr(dx,1,5) =	'60091'
or substr(dx,1,5) =	'60090'
or substr(dx,1,5) =	'60000'
or substr(dx,1,4) =	'N400'
or substr(dx,1,4) =	'N401'
or substr(dx,1,4) =	'N402'
or substr(dx,1,4) =	'N403'
or substr(dx,1,5) =	'N4283')
               and ccw_8=0
               then ccw_8=1;
*Cataract;
         if (substr(dx,1,5) =	'36601'
or substr(dx,1,5) =	'36602'
or substr(dx,1,5) =	'36603'
or substr(dx,1,5) =	'36604'
or substr(dx,1,5) =	'36609'
or substr(dx,1,5) =	'36612'
or substr(dx,1,5) =	'36613'
or substr(dx,1,5) =	'36614'
or substr(dx,1,5) =	'36615'
or substr(dx,1,5) =	'36616'
or substr(dx,1,5) =	'36617'
or substr(dx,1,5) =	'36618'
or substr(dx,1,5) =	'36619'
or substr(dx,1,5) =	'36610'
or substr(dx,1,5) =	'36621'
or substr(dx,1,5) =	'36622'
or substr(dx,1,5) =	'36623'
or substr(dx,1,5) =	'36620'
or substr(dx,1,5) =	'36630'
or substr(dx,1,5) =	'36645'
or substr(dx,1,5) =	'36646'
or substr(dx,1,5) =	'36651'
or substr(dx,1,5) =	'36652'
or substr(dx,1,5) =	'36653'
or substr(dx,1,5) =	'36650'
or substr(dx,1,4) =	'3668'
or substr(dx,1,4) =	'3669'
or substr(dx,1,5) =	'37926'
or substr(dx,1,5) =	'37931'
or substr(dx,1,5) =	'37939'
or substr(dx,1,5) =	'74331'
or substr(dx,1,5) =	'74332'
or substr(dx,1,5) =	'74333'
or substr(dx,1,4) =	'7433'
or substr(dx,1,4) =	'V431'
or substr(dx,1,6) =	'H25011'
or substr(dx,1,6) =	'H25012'
or substr(dx,1,6) =	'H25013'
or substr(dx,1,6) =	'H25019'
or substr(dx,1,6) =	'H25031'
or substr(dx,1,6) =	'H25032'
or substr(dx,1,6) =	'H25033'
or substr(dx,1,6) =	'H25039'
or substr(dx,1,6) =	'H25041'
or substr(dx,1,6) =	'H25042'
or substr(dx,1,6) =	'H25043'
or substr(dx,1,6) =	'H25049'
or substr(dx,1,6) =	'H25091'
or substr(dx,1,6) =	'H25092'
or substr(dx,1,6) =	'H25093'
or substr(dx,1,6) =	'H25099'
or substr(dx,1,5) =	'H2510'
or substr(dx,1,5) =	'H2511'
or substr(dx,1,5) =	'H2512'
or substr(dx,1,5) =	'H2513'
or substr(dx,1,5) =	'H2520'
or substr(dx,1,5) =	'H2521'
or substr(dx,1,5) =	'H2522'
or substr(dx,1,5) =	'H2523'
or substr(dx,1,6) =	'H25811'
or substr(dx,1,6) =	'H25812'
or substr(dx,1,6) =	'H25813'
or substr(dx,1,6) =	'H25819'
or substr(dx,1,5) =	'H2589'
or substr(dx,1,4) =	'H259'
or substr(dx,1,6) =	'H26011'
or substr(dx,1,6) =	'H26012'
or substr(dx,1,6) =	'H26013'
or substr(dx,1,6) =	'H26019'
or substr(dx,1,6) =	'H26031'
or substr(dx,1,6) =	'H26032'
or substr(dx,1,6) =	'H26033'
or substr(dx,1,6) =	'H26039'
or substr(dx,1,6) =	'H26041'
or substr(dx,1,6) =	'H26042'
or substr(dx,1,6) =	'H26043'
or substr(dx,1,6) =	'H26049'
or substr(dx,1,6) =	'H26051'
or substr(dx,1,6) =	'H26052'
or substr(dx,1,6) =	'H26053'
or substr(dx,1,6) =	'H26059'
or substr(dx,1,6) =	'H26061'
or substr(dx,1,6) =	'H26062'
or substr(dx,1,6) =	'H26063'
or substr(dx,1,6) =	'H26069'
or substr(dx,1,5) =	'H2609'
or substr(dx,1,6) =	'H26101'
or substr(dx,1,6) =	'H26102'
or substr(dx,1,6) =	'H26103'
or substr(dx,1,6) =	'H26109'
or substr(dx,1,6) =	'H26111'
or substr(dx,1,6) =	'H26112'
or substr(dx,1,6) =	'H26113'
or substr(dx,1,6) =	'H26119'
or substr(dx,1,6) =	'H26121'
or substr(dx,1,6) =	'H26122'
or substr(dx,1,6) =	'H26123'
or substr(dx,1,6) =	'H26129'
or substr(dx,1,6) =	'H26131'
or substr(dx,1,6) =	'H26132'
or substr(dx,1,6) =	'H26133'
or substr(dx,1,6) =	'H26139'
or substr(dx,1,5) =	'H2620'
or substr(dx,1,6) =	'H26211'
or substr(dx,1,6) =	'H26212'
or substr(dx,1,6) =	'H26213'
or substr(dx,1,6) =	'H26219'
or substr(dx,1,5) =	'H2630'
or substr(dx,1,5) =	'H2631'
or substr(dx,1,5) =	'H2632'
or substr(dx,1,5) =	'H2633'
or substr(dx,1,5) =	'H2640'
or substr(dx,1,6) =	'H26411'
or substr(dx,1,6) =	'H26412'
or substr(dx,1,6) =	'H26413'
or substr(dx,1,6) =	'H26419'
or substr(dx,1,6) =	'H26491'
or substr(dx,1,6) =	'H26492'
or substr(dx,1,6) =	'H26493'
or substr(dx,1,6) =	'H26499'
or substr(dx,1,4) =	'H268'
or substr(dx,1,4) =	'H269'
or substr(dx,1,4) =	'Q120'
or substr(dx,1,4) =	'Z961')
               and ccw_9=0
               then ccw_9=1;
*CKD ;
         if (substr(dx,1,5) =	'01601'
or substr(dx,1,5) =	'01602'
or substr(dx,1,5) =	'01603'
or substr(dx,1,5) =	'01604'
or substr(dx,1,5) =	'01605'
or substr(dx,1,5) =	'01606'
or substr(dx,1,5) =	'01600'
or substr(dx,1,4) =	'1899'
or substr(dx,1,4) =	'1890'
or substr(dx,1,4) =	'2230'
or substr(dx,1,5) =	'23691'
or substr(dx,1,5) =	'24941'
or substr(dx,1,5) =	'24940'
or substr(dx,1,5) =	'25041'
or substr(dx,1,5) =	'25042'
or substr(dx,1,5) =	'25043'
or substr(dx,1,5) =	'25040'
or substr(dx,1,4) =	'2714'
or substr(dx,1,5) =	'27410'
or substr(dx,1,5) =	'28311'
or substr(dx,1,5) =	'40301'
or substr(dx,1,5) =	'40311'
or substr(dx,1,5) =	'40391'
or substr(dx,1,5) =	'40402'
or substr(dx,1,5) =	'40403'
or substr(dx,1,5) =	'40412'
or substr(dx,1,5) =	'40413'
or substr(dx,1,5) =	'40492'
or substr(dx,1,5) =	'40493'
or substr(dx,1,4) =	'4401'
or substr(dx,1,4) =	'4421'
or substr(dx,1,4) =	'5724'
or substr(dx,1,4) =	'5804'
or substr(dx,1,5) =	'58081'
or substr(dx,1,5) =	'58089'
or substr(dx,1,4) =	'5809'
or substr(dx,1,4) =	'5800'
or substr(dx,1,4) =	'5811'
or substr(dx,1,4) =	'5812'
or substr(dx,1,4) =	'5813'
or substr(dx,1,5) =	'58181'
or substr(dx,1,5) =	'58189'
or substr(dx,1,4) =	'5819'
or substr(dx,1,4) =	'5810'
or substr(dx,1,4) =	'5821'
or substr(dx,1,4) =	'5822'
or substr(dx,1,4) =	'5824'
or substr(dx,1,5) =	'58281'
or substr(dx,1,5) =	'58289'
or substr(dx,1,4) =	'5829'
or substr(dx,1,4) =	'5820'
or substr(dx,1,4) =	'5831'
or substr(dx,1,4) =	'5832'
or substr(dx,1,4) =	'5834'
or substr(dx,1,4) =	'5836'
or substr(dx,1,4) =	'5837'
or substr(dx,1,5) =	'58381'
or substr(dx,1,5) =	'58389'
or substr(dx,1,4) =	'5839'
or substr(dx,1,4) =	'5830'
or substr(dx,1,4) =	'5845'
or substr(dx,1,4) =	'5846'
or substr(dx,1,4) =	'5847'
or substr(dx,1,4) =	'5848'
or substr(dx,1,4) =	'5849'
or substr(dx,1,4) =	'5851'
or substr(dx,1,4) =	'5852'
or substr(dx,1,4) =	'5853'
or substr(dx,1,4) =	'5854'
or substr(dx,1,4) =	'5855'
or substr(dx,1,4) =	'5856'
or substr(dx,1,4) =	'5859'
or substr(dx,1,3) =	'586'
or substr(dx,1,3) =	'587'
or substr(dx,1,4) =	'5881'
or substr(dx,1,5) =	'58881'
or substr(dx,1,5) =	'58889'
or substr(dx,1,4) =	'5889'
or substr(dx,1,4) =	'5880'
or substr(dx,1,3) =	'591'
or substr(dx,1,5) =	'75312'
or substr(dx,1,5) =	'75313'
or substr(dx,1,5) =	'75314'
or substr(dx,1,5) =	'75315'
or substr(dx,1,5) =	'75316'
or substr(dx,1,5) =	'75317'
or substr(dx,1,5) =	'75319'
or substr(dx,1,5) =	'75321'
or substr(dx,1,5) =	'75322'
or substr(dx,1,5) =	'75323'
or substr(dx,1,5) =	'75329'
or substr(dx,1,5) =	'75320'
or substr(dx,1,4) =	'7944'
or substr(dx,1,4) =	'0954'
or substr(dx,1,5) =	'A1811'
or substr(dx,1,5) =	'A5275'
or substr(dx,1,4) =	'B520'
or substr(dx,1,4) =	'C641'
or substr(dx,1,4) =	'C642'
or substr(dx,1,4) =	'C649'
or substr(dx,1,4) =	'C689'
or substr(dx,1,5) =	'D3000'
or substr(dx,1,5) =	'D3001'
or substr(dx,1,5) =	'D3002'
or substr(dx,1,5) =	'D4100'
or substr(dx,1,5) =	'D4101'
or substr(dx,1,5) =	'D4102'
or substr(dx,1,5) =	'D4110'
or substr(dx,1,5) =	'D4111'
or substr(dx,1,5) =	'D4112'
or substr(dx,1,5) =	'D4120'
or substr(dx,1,5) =	'D4121'
or substr(dx,1,5) =	'D4122'
or substr(dx,1,4) =	'D593'
or substr(dx,1,5) =	'E0821'
or substr(dx,1,5) =	'E0822'
or substr(dx,1,5) =	'E0829'
or substr(dx,1,5) =	'E0865'
or substr(dx,1,5) =	'E0921'
or substr(dx,1,5) =	'E0922'
or substr(dx,1,5) =	'E0929'
or substr(dx,1,5) =	'E1021'
or substr(dx,1,5) =	'E1022'
or substr(dx,1,5) =	'E1029'
or substr(dx,1,5) =	'E1065'
or substr(dx,1,5) =	'E1121'
or substr(dx,1,5) =	'E1122'
or substr(dx,1,5) =	'E1129'
or substr(dx,1,5) =	'E1165'
or substr(dx,1,5) =	'E1321'
or substr(dx,1,5) =	'E1322'
or substr(dx,1,5) =	'E1329'
or substr(dx,1,4) =	'E748'
or substr(dx,1,4) =	'I120'
or substr(dx,1,4) =	'I129'
or substr(dx,1,4) =	'I130'
or substr(dx,1,5) =	'I1310'
or substr(dx,1,5) =	'I1311'
or substr(dx,1,4) =	'I132'
or substr(dx,1,4) =	'I701'
or substr(dx,1,4) =	'I722'
or substr(dx,1,4) =	'K767'
or substr(dx,1,5) =	'M1030'
or substr(dx,1,6) =	'M10311'
or substr(dx,1,6) =	'M10312'
or substr(dx,1,6) =	'M10319'
or substr(dx,1,6) =	'M10321'
or substr(dx,1,6) =	'M10322'
or substr(dx,1,6) =	'M10329'
or substr(dx,1,6) =	'M10331'
or substr(dx,1,6) =	'M10332'
or substr(dx,1,6) =	'M10339'
or substr(dx,1,6) =	'M10341'
or substr(dx,1,6) =	'M10342'
or substr(dx,1,6) =	'M10349'
or substr(dx,1,6) =	'M10351'
or substr(dx,1,6) =	'M10352'
or substr(dx,1,6) =	'M10359'
or substr(dx,1,6) =	'M10361'
or substr(dx,1,6) =	'M10362'
or substr(dx,1,6) =	'M10369'
or substr(dx,1,6) =	'M10371'
or substr(dx,1,6) =	'M10372'
or substr(dx,1,6) =	'M10379'
or substr(dx,1,5) =	'M1038'
or substr(dx,1,5) =	'M1039'
or substr(dx,1,5) =	'M3214'
or substr(dx,1,5) =	'M3215'
or substr(dx,1,5) =	'M3504'
or substr(dx,1,4) =	'N000'
or substr(dx,1,4) =	'N001'
or substr(dx,1,4) =	'N002'
or substr(dx,1,4) =	'N003'
or substr(dx,1,4) =	'N004'
or substr(dx,1,4) =	'N005'
or substr(dx,1,4) =	'N006'
or substr(dx,1,4) =	'N007'
or substr(dx,1,4) =	'N008'
or substr(dx,1,4) =	'N009'
or substr(dx,1,4) =	'N010'
or substr(dx,1,4) =	'N011'
or substr(dx,1,4) =	'N012'
or substr(dx,1,4) =	'N013'
or substr(dx,1,4) =	'N014'
or substr(dx,1,4) =	'N015'
or substr(dx,1,4) =	'N016'
or substr(dx,1,4) =	'N017'
or substr(dx,1,4) =	'N018'
or substr(dx,1,4) =	'N019'
or substr(dx,1,4) =	'N020'
or substr(dx,1,4) =	'N021'
or substr(dx,1,4) =	'N022'
or substr(dx,1,4) =	'N023'
or substr(dx,1,4) =	'N024'
or substr(dx,1,4) =	'N025'
or substr(dx,1,4) =	'N026'
or substr(dx,1,4) =	'N027'
or substr(dx,1,4) =	'N028'
or substr(dx,1,4) =	'N029'
or substr(dx,1,4) =	'N030'
or substr(dx,1,4) =	'N031'
or substr(dx,1,4) =	'N032'
or substr(dx,1,4) =	'N033'
or substr(dx,1,4) =	'N034'
or substr(dx,1,4) =	'N035'
or substr(dx,1,4) =	'N036'
or substr(dx,1,4) =	'N037'
or substr(dx,1,4) =	'N038'
or substr(dx,1,4) =	'N039'
or substr(dx,1,4) =	'N040'
or substr(dx,1,4) =	'N041'
or substr(dx,1,4) =	'N042'
or substr(dx,1,4) =	'N043'
or substr(dx,1,4) =	'N044'
or substr(dx,1,4) =	'N045'
or substr(dx,1,4) =	'N046'
or substr(dx,1,4) =	'N047'
or substr(dx,1,4) =	'N048'
or substr(dx,1,4) =	'N049'
or substr(dx,1,4) =	'N050'
or substr(dx,1,4) =	'N051'
or substr(dx,1,4) =	'N052'
or substr(dx,1,4) =	'N053'
or substr(dx,1,4) =	'N054'
or substr(dx,1,4) =	'N055'
or substr(dx,1,4) =	'N056'
or substr(dx,1,4) =	'N057'
or substr(dx,1,4) =	'N058'
or substr(dx,1,4) =	'N059'
or substr(dx,1,4) =	'N060'
or substr(dx,1,4) =	'N061'
or substr(dx,1,4) =	'N062'
or substr(dx,1,4) =	'N063'
or substr(dx,1,4) =	'N064'
or substr(dx,1,4) =	'N065'
or substr(dx,1,4) =	'N066'
or substr(dx,1,4) =	'N067'
or substr(dx,1,4) =	'N068'
or substr(dx,1,4) =	'N069'
or substr(dx,1,4) =	'N070'
or substr(dx,1,4) =	'N071'
or substr(dx,1,4) =	'N072'
or substr(dx,1,4) =	'N073'
or substr(dx,1,4) =	'N074'
or substr(dx,1,4) =	'N075'
or substr(dx,1,4) =	'N076'
or substr(dx,1,4) =	'N077'
or substr(dx,1,4) =	'N078'
or substr(dx,1,4) =	'N079'
or substr(dx,1,3) =	'N08'
or substr(dx,1,4) =	'N131'
or substr(dx,1,4) =	'N132'
or substr(dx,1,5) =	'N1330'
or substr(dx,1,5) =	'N1339'
or substr(dx,1,4) =	'N140'
or substr(dx,1,4) =	'N141'
or substr(dx,1,4) =	'N142'
or substr(dx,1,4) =	'N143'
or substr(dx,1,4) =	'N144'
or substr(dx,1,4) =	'N150'
or substr(dx,1,4) =	'N158'
or substr(dx,1,4) =	'N159'
or substr(dx,1,3) =	'N16'
or substr(dx,1,4) =	'N170'
or substr(dx,1,4) =	'N171'
or substr(dx,1,4) =	'N172'
or substr(dx,1,4) =	'N178'
or substr(dx,1,4) =	'N179'
or substr(dx,1,4) =	'N181'
or substr(dx,1,4) =	'N182'
or substr(dx,1,4) =	'N183'
or substr(dx,1,4) =	'N184'
or substr(dx,1,4) =	'N185'
or substr(dx,1,4) =	'N186'
or substr(dx,1,4) =	'N189'
or substr(dx,1,3) =	'N19'
or substr(dx,1,4) =	'N250'
or substr(dx,1,4) =	'N251'
or substr(dx,1,5) =	'N2581'
or substr(dx,1,5) =	'N2589'
or substr(dx,1,4) =	'N259'
or substr(dx,1,4) =	'N261'
or substr(dx,1,4) =	'N269'
or substr(dx,1,5) =	'Q6102'
or substr(dx,1,5) =	'Q6111'
or substr(dx,1,5) =	'Q6119'
or substr(dx,1,4) =	'Q612'
or substr(dx,1,4) =	'Q613'
or substr(dx,1,4) =	'Q614'
or substr(dx,1,4) =	'Q615'
or substr(dx,1,4) =	'Q618'
or substr(dx,1,4) =	'Q620'
or substr(dx,1,5) =	'Q6210'
or substr(dx,1,5) =	'Q6211'
or substr(dx,1,5) =	'Q6212'
or substr(dx,1,4) =	'Q622'
or substr(dx,1,5) =	'Q6231'
or substr(dx,1,5) =	'Q6232'
or substr(dx,1,5) =	'Q6239'
or substr(dx,1,4) =	'R944')
               and ccw_10=0
               then ccw_10=1;
*COPD/Bronchitectasis;
	if (substr(dx,1,3) =	'490'
or substr(dx,1,4) =	'4911'
or substr(dx,1,5) =	'49121'
or substr(dx,1,5) =	'49122'
or substr(dx,1,4) =	'4912'
or substr(dx,1,4) =	'4918'
or substr(dx,1,4) =	'4919'
or substr(dx,1,4) =	'4910'
or substr(dx,1,4) =	'4928'
or substr(dx,1,4) =	'4920'
or substr(dx,1,4) =	'4941'
or substr(dx,1,4) =	'4940'
or substr(dx,1,3) =	'496'
or substr(dx,1,3) =	'J40'
or substr(dx,1,4) =	'J410'
or substr(dx,1,4) =	'J411'
or substr(dx,1,4) =	'J418'
or substr(dx,1,3) =	'J42'
or substr(dx,1,4) =	'J430'
or substr(dx,1,4) =	'J431'
or substr(dx,1,4) =	'J432'
or substr(dx,1,4) =	'J438'
or substr(dx,1,4) =	'J439'
or substr(dx,1,4) =	'J440'
or substr(dx,1,4) =	'J441'
or substr(dx,1,4) =	'J449'
or substr(dx,1,4) =	'J470'
or substr(dx,1,4) =	'J471'
or substr(dx,1,4) =	'J479')
		and ccw_11=0
                then ccw_11=1;
*Depression ;
	if (substr(dx,1,5) =	'29621'
or substr(dx,1,5) =	'29622'
or substr(dx,1,5) =	'29623'
or substr(dx,1,5) =	'29624'
or substr(dx,1,5) =	'29625'
or substr(dx,1,5) =	'29626'
or substr(dx,1,5) =	'29620'
or substr(dx,1,5) =	'29631'
or substr(dx,1,5) =	'29632'
or substr(dx,1,5) =	'29633'
or substr(dx,1,5) =	'29634'
or substr(dx,1,5) =	'29635'
or substr(dx,1,5) =	'29636'
or substr(dx,1,5) =	'29630'
or substr(dx,1,5) =	'29651'
or substr(dx,1,5) =	'29652'
or substr(dx,1,5) =	'29653'
or substr(dx,1,5) =	'29654'
or substr(dx,1,5) =	'29655'
or substr(dx,1,5) =	'29656'
or substr(dx,1,5) =	'29661'
or substr(dx,1,5) =	'29662'
or substr(dx,1,5) =	'29663'
or substr(dx,1,5) =	'29664'
or substr(dx,1,5) =	'29665'
or substr(dx,1,5) =	'29666'
or substr(dx,1,5) =	'29660'
or substr(dx,1,5) =	'29689'
or substr(dx,1,4) =	'2980'
or substr(dx,1,4) =	'3004'
or substr(dx,1,4) =	'3091'
or substr(dx,1,3) =	'311'
or substr(dx,1,5) =	'F3130'
or substr(dx,1,5) =	'F3131'
or substr(dx,1,5) =	'F3132'
or substr(dx,1,4) =	'F314'
or substr(dx,1,4) =	'F315'
or substr(dx,1,5) =	'F3160'
or substr(dx,1,5) =	'F3161'
or substr(dx,1,5) =	'F3162'
or substr(dx,1,5) =	'F3163'
or substr(dx,1,5) =	'F3164'
or substr(dx,1,5) =	'F3175'
or substr(dx,1,5) =	'F3176'
or substr(dx,1,5) =	'F3177'
or substr(dx,1,5) =	'F3178'
or substr(dx,1,5) =	'F3181'
or substr(dx,1,4) =	'F320'
or substr(dx,1,4) =	'F321'
or substr(dx,1,4) =	'F322'
or substr(dx,1,4) =	'F323'
or substr(dx,1,4) =	'F324'
or substr(dx,1,4) =	'F325'
or substr(dx,1,4) =	'F329'
or substr(dx,1,4) =	'F330'
or substr(dx,1,4) =	'F331'
or substr(dx,1,4) =	'F332'
or substr(dx,1,4) =	'F333'
or substr(dx,1,5) =	'F3340'
or substr(dx,1,5) =	'F3341'
or substr(dx,1,5) =	'F3342'
or substr(dx,1,4) =	'F338'
or substr(dx,1,4) =	'F339'
or substr(dx,1,4) =	'F341'
or substr(dx,1,5) =	'F4321'
or substr(dx,1,5) =	'F4323'
)
		and ccw_12=0
                then ccw_12=1;
* Diabetes;
	if (substr(dx,1,5) =	'24901'
or substr(dx,1,5) =	'24911'
or substr(dx,1,5) =	'24910'
or substr(dx,1,5) =	'24921'
or substr(dx,1,5) =	'24920'
or substr(dx,1,5) =	'24931'
or substr(dx,1,5) =	'24930'
or substr(dx,1,5) =	'24941'
or substr(dx,1,5) =	'24940'
or substr(dx,1,5) =	'24951'
or substr(dx,1,5) =	'24950'
or substr(dx,1,5) =	'24961'
or substr(dx,1,5) =	'24960'
or substr(dx,1,5) =	'24971'
or substr(dx,1,5) =	'24970'
or substr(dx,1,5) =	'24981'
or substr(dx,1,5) =	'24980'
or substr(dx,1,5) =	'24991'
or substr(dx,1,5) =	'24990'
or substr(dx,1,5) =	'24900'
or substr(dx,1,5) =	'25001'
or substr(dx,1,5) =	'25002'
or substr(dx,1,5) =	'25003'
or substr(dx,1,5) =	'25011'
or substr(dx,1,5) =	'25012'
or substr(dx,1,5) =	'25013'
or substr(dx,1,5) =	'25010'
or substr(dx,1,5) =	'25021'
or substr(dx,1,5) =	'25022'
or substr(dx,1,5) =	'25023'
or substr(dx,1,5) =	'25020'
or substr(dx,1,5) =	'25031'
or substr(dx,1,5) =	'25032'
or substr(dx,1,5) =	'25033'
or substr(dx,1,5) =	'25030'
or substr(dx,1,5) =	'25041'
or substr(dx,1,5) =	'25042'
or substr(dx,1,5) =	'25043'
or substr(dx,1,5) =	'25040'
or substr(dx,1,5) =	'25051'
or substr(dx,1,5) =	'25052'
or substr(dx,1,5) =	'25053'
or substr(dx,1,5) =	'25050'
or substr(dx,1,5) =	'25061'
or substr(dx,1,5) =	'25062'
or substr(dx,1,5) =	'25063'
or substr(dx,1,5) =	'25060'
or substr(dx,1,5) =	'25071'
or substr(dx,1,5) =	'25072'
or substr(dx,1,5) =	'25073'
or substr(dx,1,5) =	'25070'
or substr(dx,1,5) =	'25081'
or substr(dx,1,5) =	'25082'
or substr(dx,1,5) =	'25083'
or substr(dx,1,5) =	'25080'
or substr(dx,1,5) =	'25091'
or substr(dx,1,5) =	'25092'
or substr(dx,1,5) =	'25093'
or substr(dx,1,5) =	'25090'
or substr(dx,1,5) =	'25000'
or substr(dx,1,4) =	'3572'
or substr(dx,1,5) =	'36201'
or substr(dx,1,5) =	'36202'
or substr(dx,1,5) =	'36203'
or substr(dx,1,5) =	'36204'
or substr(dx,1,5) =	'36205'
or substr(dx,1,5) =	'36206'
or substr(dx,1,5) =	'36641'
or substr(dx,1,5) =	'E0800'
or substr(dx,1,5) =	'E0801'
or substr(dx,1,5) =	'E0810'
or substr(dx,1,5) =	'E0811'
or substr(dx,1,5) =	'E0821'
or substr(dx,1,5) =	'E0822'
or substr(dx,1,5) =	'E0829'
or substr(dx,1,6) =	'E08311'
or substr(dx,1,6) =	'E08319'
or substr(dx,1,7) =	'E083211'
or substr(dx,1,7) =	'E083212'
or substr(dx,1,7) =	'E083213'
or substr(dx,1,7) =	'E083219'
or substr(dx,1,6) =	'E08321'
or substr(dx,1,7) =	'E083291'
or substr(dx,1,7) =	'E083292'
or substr(dx,1,7) =	'E083293'
or substr(dx,1,7) =	'E083299'
or substr(dx,1,6) =	'E08329'
or substr(dx,1,7) =	'E083311'
or substr(dx,1,7) =	'E083312'
or substr(dx,1,7) =	'E083313'
or substr(dx,1,7) =	'E083319'
or substr(dx,1,6) =	'E08331'
or substr(dx,1,7) =	'E083391'
or substr(dx,1,7) =	'E083392'
or substr(dx,1,7) =	'E083393'
or substr(dx,1,7) =	'E083399'
or substr(dx,1,6) =	'E08339'
or substr(dx,1,7) =	'E083411'
or substr(dx,1,7) =	'E083412'
or substr(dx,1,7) =	'E083413'
or substr(dx,1,7) =	'E083419'
or substr(dx,1,6) =	'E08341'
or substr(dx,1,7) =	'E083491'
or substr(dx,1,7) =	'E083492'
or substr(dx,1,7) =	'E083493'
or substr(dx,1,7) =	'E083499'
or substr(dx,1,6) =	'E08349'
or substr(dx,1,7) =	'E083511'
or substr(dx,1,7) =	'E083512'
or substr(dx,1,7) =	'E083513'
or substr(dx,1,7) =	'E083519'
or substr(dx,1,6) =	'E08351'
or substr(dx,1,7) =	'E083521'
or substr(dx,1,7) =	'E083522'
or substr(dx,1,7) =	'E083523'
or substr(dx,1,7) =	'E083529'
or substr(dx,1,7) =	'E083531'
or substr(dx,1,7) =	'E083532'
or substr(dx,1,7) =	'E083533'
or substr(dx,1,7) =	'E083539'
or substr(dx,1,7) =	'E083541'
or substr(dx,1,7) =	'E083542'
or substr(dx,1,7) =	'E083543'
or substr(dx,1,7) =	'E083549'
or substr(dx,1,7) =	'E083551'
or substr(dx,1,7) =	'E083552'
or substr(dx,1,7) =	'E083553'
or substr(dx,1,7) =	'E083559'
or substr(dx,1,7) =	'E083591'
or substr(dx,1,7) =	'E083592'
or substr(dx,1,7) =	'E083593'
or substr(dx,1,7) =	'E083599'
or substr(dx,1,6) =	'E08359'
or substr(dx,1,5) =	'E0836'
or substr(dx,1,7) =	'E0837X1'
or substr(dx,1,7) =	'E0837X2'
or substr(dx,1,7) =	'E0837X3'
or substr(dx,1,7) =	'E0837X9'
or substr(dx,1,5) =	'E0839'
or substr(dx,1,5) =	'E0840'
or substr(dx,1,5) =	'E0841'
or substr(dx,1,5) =	'E0842'
or substr(dx,1,5) =	'E0843'
or substr(dx,1,5) =	'E0844'
or substr(dx,1,5) =	'E0849'
or substr(dx,1,5) =	'E0851'
or substr(dx,1,5) =	'E0852'
or substr(dx,1,5) =	'E0859'
or substr(dx,1,6) =	'E08610'
or substr(dx,1,6) =	'E08618'
or substr(dx,1,6) =	'E08620'
or substr(dx,1,6) =	'E08621'
or substr(dx,1,6) =	'E08622'
or substr(dx,1,6) =	'E08628'
or substr(dx,1,6) =	'E08630'
or substr(dx,1,6) =	'E08638'
or substr(dx,1,6) =	'E08641'
or substr(dx,1,6) =	'E08649'
or substr(dx,1,5) =	'E0865'
or substr(dx,1,5) =	'E0869'
or substr(dx,1,4) =	'E088'
or substr(dx,1,4) =	'E089'
or substr(dx,1,5) =	'E0900'
or substr(dx,1,5) =	'E0901'
or substr(dx,1,5) =	'E0910'
or substr(dx,1,5) =	'E0911'
or substr(dx,1,5) =	'E0921'
or substr(dx,1,5) =	'E0922'
or substr(dx,1,5) =	'E0929'
or substr(dx,1,6) =	'E09311'
or substr(dx,1,6) =	'E09319'
or substr(dx,1,7) =	'E093211'
or substr(dx,1,7) =	'E093212'
or substr(dx,1,7) =	'E093213'
or substr(dx,1,7) =	'E093219'
or substr(dx,1,6) =	'E09321'
or substr(dx,1,7) =	'E093291'
or substr(dx,1,7) =	'E093292'
or substr(dx,1,7) =	'E093293'
or substr(dx,1,7) =	'E093299'
or substr(dx,1,6) =	'E09329'
or substr(dx,1,7) =	'E093311'
or substr(dx,1,7) =	'E093312'
or substr(dx,1,7) =	'E093313'
or substr(dx,1,7) =	'E093319'
or substr(dx,1,6) =	'E09331'
or substr(dx,1,7) =	'E093391'
or substr(dx,1,7) =	'E093392'
or substr(dx,1,7) =	'E093393'
or substr(dx,1,7) =	'E093399'
or substr(dx,1,6) =	'E09339'
or substr(dx,1,7) =	'E093411'
or substr(dx,1,7) =	'E093412'
or substr(dx,1,7) =	'E093413'
or substr(dx,1,7) =	'E093419'
or substr(dx,1,6) =	'E09341'
or substr(dx,1,7) =	'E093491'
or substr(dx,1,7) =	'E093492'
or substr(dx,1,7) =	'E093493'
or substr(dx,1,7) =	'E093499'
or substr(dx,1,6) =	'E09349'
or substr(dx,1,7) =	'E093511'
or substr(dx,1,7) =	'E093512'
or substr(dx,1,7) =	'E093513'
or substr(dx,1,7) =	'E093519'
or substr(dx,1,6) =	'E09351'
or substr(dx,1,7) =	'E093521'
or substr(dx,1,7) =	'E093522'
or substr(dx,1,7) =	'E093523'
or substr(dx,1,7) =	'E093529'
or substr(dx,1,7) =	'E093531'
or substr(dx,1,7) =	'E093532'
or substr(dx,1,7) =	'E093533'
or substr(dx,1,7) =	'E093539'
or substr(dx,1,7) =	'E093541'
or substr(dx,1,7) =	'E093542'
or substr(dx,1,7) =	'E093543'
or substr(dx,1,7) =	'E093549'
or substr(dx,1,7) =	'E093551'
or substr(dx,1,7) =	'E093552'
or substr(dx,1,7) =	'E093553'
or substr(dx,1,7) =	'E093559'
or substr(dx,1,7) =	'E093591'
or substr(dx,1,7) =	'E093592'
or substr(dx,1,7) =	'E093593'
or substr(dx,1,7) =	'E093599'
or substr(dx,1,6) =	'E09359'
or substr(dx,1,5) =	'E0936'
or substr(dx,1,7) =	'E0937X1'
or substr(dx,1,7) =	'E0937X2'
or substr(dx,1,7) =	'E0937X3'
or substr(dx,1,7) =	'E0937X9'
or substr(dx,1,5) =	'E0939'
or substr(dx,1,5) =	'E0940'
or substr(dx,1,5) =	'E0941'
or substr(dx,1,5) =	'E0942'
or substr(dx,1,5) =	'E0943'
or substr(dx,1,5) =	'E0944'
or substr(dx,1,5) =	'E0949'
or substr(dx,1,5) =	'E0951'
or substr(dx,1,5) =	'E0952'
or substr(dx,1,5) =	'E0959'
or substr(dx,1,6) =	'E09610'
or substr(dx,1,6) =	'E09618'
or substr(dx,1,6) =	'E09620'
or substr(dx,1,6) =	'E09621'
or substr(dx,1,6) =	'E09622'
or substr(dx,1,6) =	'E09628'
or substr(dx,1,6) =	'E09630'
or substr(dx,1,6) =	'E09638'
or substr(dx,1,6) =	'E09641'
or substr(dx,1,6) =	'E09649'
or substr(dx,1,5) =	'E0965'
or substr(dx,1,5) =	'E0969'
or substr(dx,1,4) =	'E098'
or substr(dx,1,4) =	'E099'
or substr(dx,1,5) =	'E1010'
or substr(dx,1,5) =	'E1011'
or substr(dx,1,5) =	'E1021'
or substr(dx,1,5) =	'E1022'
or substr(dx,1,5) =	'E1029'
or substr(dx,1,6) =	'E10311'
or substr(dx,1,6) =	'E10319'
or substr(dx,1,7) =	'E103211'
or substr(dx,1,7) =	'E103212'
or substr(dx,1,7) =	'E103213'
or substr(dx,1,7) =	'E103219'
or substr(dx,1,6) =	'E10321'
or substr(dx,1,7) =	'E103291'
or substr(dx,1,7) =	'E103292'
or substr(dx,1,7) =	'E103293'
or substr(dx,1,7) =	'E103299'
or substr(dx,1,6) =	'E10329'
or substr(dx,1,7) =	'E103311'
or substr(dx,1,7) =	'E103312'
or substr(dx,1,7) =	'E103313'
or substr(dx,1,7) =	'E103319'
or substr(dx,1,6) =	'E10331'
or substr(dx,1,7) =	'E103391'
or substr(dx,1,7) =	'E103392'
or substr(dx,1,7) =	'E103393'
or substr(dx,1,7) =	'E103399'
or substr(dx,1,6) =	'E10339'
or substr(dx,1,7) =	'E103411'
or substr(dx,1,7) =	'E103412'
or substr(dx,1,7) =	'E103413'
or substr(dx,1,7) =	'E103419'
or substr(dx,1,6) =	'E10341'
or substr(dx,1,7) =	'E103491'
or substr(dx,1,7) =	'E103492'
or substr(dx,1,7) =	'E103493'
or substr(dx,1,7) =	'E103499'
or substr(dx,1,6) =	'E10349'
or substr(dx,1,7) =	'E103511'
or substr(dx,1,7) =	'E103512'
or substr(dx,1,7) =	'E103513'
or substr(dx,1,7) =	'E103519'
or substr(dx,1,6) =	'E10351'
or substr(dx,1,6) =	'E10359'
or substr(dx,1,5) =	'E1036'
or substr(dx,1,7) =	'E1037X1'
or substr(dx,1,7) =	'E1037X2'
or substr(dx,1,7) =	'E1037X3'
or substr(dx,1,7) =	'E1037X9'
or substr(dx,1,5) =	'E1039'
or substr(dx,1,5) =	'E1040'
or substr(dx,1,5) =	'E1041'
or substr(dx,1,5) =	'E1042'
or substr(dx,1,5) =	'E1043'
or substr(dx,1,5) =	'E1044'
or substr(dx,1,5) =	'E1049'
or substr(dx,1,5) =	'E1051'
or substr(dx,1,5) =	'E1052'
or substr(dx,1,5) =	'E1059'
or substr(dx,1,6) =	'E10610'
or substr(dx,1,6) =	'E10618'
or substr(dx,1,6) =	'E10620'
or substr(dx,1,6) =	'E10621'
or substr(dx,1,6) =	'E10622'
or substr(dx,1,6) =	'E10628'
or substr(dx,1,6) =	'E10630'
or substr(dx,1,6) =	'E10638'
or substr(dx,1,6) =	'E10641'
or substr(dx,1,6) =	'E10649'
or substr(dx,1,5) =	'E1065'
or substr(dx,1,5) =	'E1069'
or substr(dx,1,4) =	'E108'
or substr(dx,1,4) =	'E109'
or substr(dx,1,5) =	'E1100'
or substr(dx,1,5) =	'E1101'
or substr(dx,1,5) =	'E1110'
or substr(dx,1,5) =	'E1111'
or substr(dx,1,5) =	'E1121'
or substr(dx,1,5) =	'E1122'
or substr(dx,1,5) =	'E1129'
or substr(dx,1,6) =	'E11311'
or substr(dx,1,6) =	'E11319'
or substr(dx,1,7) =	'E113211'
or substr(dx,1,7) =	'E113212'
or substr(dx,1,7) =	'E113213'
or substr(dx,1,7) =	'E113219'
or substr(dx,1,6) =	'E11321'
or substr(dx,1,7) =	'E113291'
or substr(dx,1,7) =	'E113292'
or substr(dx,1,7) =	'E113293'
or substr(dx,1,7) =	'E113299'
or substr(dx,1,6) =	'E11329'
or substr(dx,1,7) =	'E113311'
or substr(dx,1,7) =	'E113312'
or substr(dx,1,7) =	'E113313'
or substr(dx,1,7) =	'E113319'
or substr(dx,1,6) =	'E11331'
or substr(dx,1,7) =	'E113391'
or substr(dx,1,7) =	'E113392'
or substr(dx,1,7) =	'E113393'
or substr(dx,1,7) =	'E113399'
or substr(dx,1,6) =	'E11339'
or substr(dx,1,7) =	'E113411'
or substr(dx,1,7) =	'E113412'
or substr(dx,1,7) =	'E113413'
or substr(dx,1,7) =	'E113419'
or substr(dx,1,6) =	'E11341'
or substr(dx,1,7) =	'E113491'
or substr(dx,1,7) =	'E113492'
or substr(dx,1,7) =	'E113493'
or substr(dx,1,7) =	'E113499'
or substr(dx,1,6) =	'E11349'
or substr(dx,1,7) =	'E113511'
or substr(dx,1,7) =	'E113512'
or substr(dx,1,7) =	'E113513'
or substr(dx,1,7) =	'E113519'
or substr(dx,1,6) =	'E11351'
or substr(dx,1,7) =	'E113521'
or substr(dx,1,7) =	'E113522'
or substr(dx,1,7) =	'E113523'
or substr(dx,1,7) =	'E113529'
or substr(dx,1,7) =	'E113531'
or substr(dx,1,7) =	'E113532'
or substr(dx,1,7) =	'E113533'
or substr(dx,1,7) =	'E113539'
or substr(dx,1,7) =	'E113541'
or substr(dx,1,7) =	'E113542'
or substr(dx,1,7) =	'E113543'
or substr(dx,1,7) =	'E113549'
or substr(dx,1,7) =	'E113551'
or substr(dx,1,7) =	'E113552'
or substr(dx,1,7) =	'E113553'
or substr(dx,1,7) =	'E113559'
or substr(dx,1,7) =	'E113591'
or substr(dx,1,7) =	'E113592'
or substr(dx,1,7) =	'E113593'
or substr(dx,1,7) =	'E113599'
or substr(dx,1,6) =	'E11359'
or substr(dx,1,5) =	'E1136'
or substr(dx,1,7) =	'E1137X1'
or substr(dx,1,7) =	'E1137X2'
or substr(dx,1,7) =	'E1137X3'
or substr(dx,1,7) =	'E1137X9'
or substr(dx,1,5) =	'E1139'
or substr(dx,1,5) =	'E1140'
or substr(dx,1,5) =	'E1141'
or substr(dx,1,5) =	'E1142'
or substr(dx,1,5) =	'E1143'
or substr(dx,1,5) =	'E1144'
or substr(dx,1,5) =	'E1149'
or substr(dx,1,5) =	'E1151'
or substr(dx,1,5) =	'E1152'
or substr(dx,1,5) =	'E1159'
or substr(dx,1,6) =	'E11610'
or substr(dx,1,6) =	'E11618'
or substr(dx,1,6) =	'E11620'
or substr(dx,1,6) =	'E11621'
or substr(dx,1,6) =	'E11622'
or substr(dx,1,6) =	'E11628'
or substr(dx,1,6) =	'E11630'
or substr(dx,1,6) =	'E11638'
or substr(dx,1,6) =	'E11641'
or substr(dx,1,6) =	'E11649'
or substr(dx,1,5) =	'E1165'
or substr(dx,1,5) =	'E1169'
or substr(dx,1,4) =	'E118'
or substr(dx,1,4) =	'E119'
or substr(dx,1,5) =	'E1300'
or substr(dx,1,5) =	'E1301'
or substr(dx,1,5) =	'E1310'
or substr(dx,1,5) =	'E1311'
or substr(dx,1,5) =	'E1321'
or substr(dx,1,5) =	'E1322'
or substr(dx,1,5) =	'E1329'
or substr(dx,1,6) =	'E13311'
or substr(dx,1,6) =	'E13319'
or substr(dx,1,7) =	'E133211'
or substr(dx,1,7) =	'E133212'
or substr(dx,1,7) =	'E133213'
or substr(dx,1,7) =	'E133219'
or substr(dx,1,6) =	'E13321'
or substr(dx,1,7) =	'E133291'
or substr(dx,1,7) =	'E133292'
or substr(dx,1,7) =	'E133293'
or substr(dx,1,7) =	'E133299'
or substr(dx,1,6) =	'E13329'
or substr(dx,1,7) =	'E133311'
or substr(dx,1,7) =	'E133312'
or substr(dx,1,7) =	'E133313'
or substr(dx,1,7) =	'E133319'
or substr(dx,1,6) =	'E13331'
or substr(dx,1,7) =	'E133391'
or substr(dx,1,7) =	'E133392'
or substr(dx,1,7) =	'E133393'
or substr(dx,1,7) =	'E133399'
or substr(dx,1,6) =	'E13339'
or substr(dx,1,7) =	'E133411'
or substr(dx,1,7) =	'E133412'
or substr(dx,1,7) =	'E133413'
or substr(dx,1,7) =	'E133419'
or substr(dx,1,6) =	'E13341'
or substr(dx,1,7) =	'E133491'
or substr(dx,1,7) =	'E133492'
or substr(dx,1,7) =	'E133493'
or substr(dx,1,7) =	'E133499'
or substr(dx,1,6) =	'E13349'
or substr(dx,1,7) =	'E133511'
or substr(dx,1,7) =	'E133512'
or substr(dx,1,7) =	'E133513'
or substr(dx,1,7) =	'E133519'
or substr(dx,1,6) =	'E13351'
or substr(dx,1,7) =	'E133521'
or substr(dx,1,7) =	'E133522'
or substr(dx,1,7) =	'E133523'
or substr(dx,1,7) =	'E133529'
or substr(dx,1,7) =	'E133531'
or substr(dx,1,7) =	'E133532'
or substr(dx,1,7) =	'E133533'
or substr(dx,1,7) =	'E133539'
or substr(dx,1,7) =	'E133541'
or substr(dx,1,7) =	'E133542'
or substr(dx,1,7) =	'E133543'
or substr(dx,1,7) =	'E133549'
or substr(dx,1,7) =	'E133551'
or substr(dx,1,7) =	'E133552'
or substr(dx,1,7) =	'E133553'
or substr(dx,1,7) =	'E133559'
or substr(dx,1,6) =	'E13359'
or substr(dx,1,5) =	'E1336'
or substr(dx,1,5) =	'E1339'
or substr(dx,1,5) =	'E1340'
or substr(dx,1,5) =	'E1341'
or substr(dx,1,5) =	'E1342'
or substr(dx,1,5) =	'E1343'
or substr(dx,1,5) =	'E1344'
or substr(dx,1,5) =	'E1349'
or substr(dx,1,5) =	'E1351'
or substr(dx,1,5) =	'E1352'
or substr(dx,1,5) =	'E1359'
or substr(dx,1,6) =	'E13610'
or substr(dx,1,6) =	'E13618'
or substr(dx,1,6) =	'E13620'
or substr(dx,1,6) =	'E13621'
or substr(dx,1,6) =	'E13622'
or substr(dx,1,6) =	'E13628'
or substr(dx,1,6) =	'E13630'
or substr(dx,1,6) =	'E13638'
or substr(dx,1,6) =	'E13641'
or substr(dx,1,6) =	'E13649'
or substr(dx,1,5) =	'E1365'
or substr(dx,1,5) =	'E1369'
or substr(dx,1,4) =	'E138'
or substr(dx,1,4) =	'E139')
		and ccw_13=0
                then ccw_13=1;
*Glaucoma ;
	if (substr(dx,1,5) =	'36285'
or substr(dx,1,5) =	'36501'
or substr(dx,1,5) =	'36502'
or substr(dx,1,5) =	'36503'
or substr(dx,1,5) =	'36504'
or substr(dx,1,5) =	'36511'
or substr(dx,1,5) =	'36512'
or substr(dx,1,5) =	'36513'
or substr(dx,1,5) =	'36515'
or substr(dx,1,5) =	'36510'
or substr(dx,1,5) =	'36521'
or substr(dx,1,5) =	'36522'
or substr(dx,1,5) =	'36523'
or substr(dx,1,5) =	'36524'
or substr(dx,1,5) =	'36520'
or substr(dx,1,5) =	'36531'
or substr(dx,1,5) =	'36532'
or substr(dx,1,5) =	'36541'
or substr(dx,1,5) =	'36542'
or substr(dx,1,5) =	'36543'
or substr(dx,1,5) =	'36551'
or substr(dx,1,5) =	'36552'
or substr(dx,1,5) =	'36559'
or substr(dx,1,5) =	'36561'
or substr(dx,1,5) =	'36562'
or substr(dx,1,5) =	'36563'
or substr(dx,1,5) =	'36564'
or substr(dx,1,5) =	'36565'
or substr(dx,1,5) =	'36560'
or substr(dx,1,5) =	'36581'
or substr(dx,1,5) =	'36582'
or substr(dx,1,5) =	'36583'
or substr(dx,1,5) =	'36589'
or substr(dx,1,4) =	'3659'
or substr(dx,1,5) =	'36500'
or substr(dx,1,5) =	'37714'
or substr(dx,1,6) =	'H40001'
or substr(dx,1,6) =	'H40002'
or substr(dx,1,6) =	'H40003'
or substr(dx,1,6) =	'H40009'
or substr(dx,1,6) =	'H40011'
or substr(dx,1,6) =	'H40012'
or substr(dx,1,6) =	'H40013'
or substr(dx,1,6) =	'H40019'
or substr(dx,1,6) =	'H40031'
or substr(dx,1,6) =	'H40032'
or substr(dx,1,6) =	'H40033'
or substr(dx,1,6) =	'H40039'
or substr(dx,1,6) =	'H40041'
or substr(dx,1,6) =	'H40042'
or substr(dx,1,6) =	'H40043'
or substr(dx,1,6) =	'H40049'
or substr(dx,1,6) =	'H40051'
or substr(dx,1,6) =	'H40052'
or substr(dx,1,6) =	'H40053'
or substr(dx,1,6) =	'H40059'
or substr(dx,1,7) =	'H4010X0'
or substr(dx,1,7) =	'H4010X1'
or substr(dx,1,7) =	'H4010X2'
or substr(dx,1,7) =	'H4010X3'
or substr(dx,1,7) =	'H4010X4'
or substr(dx,1,7) =	'H401110'
or substr(dx,1,7) =	'H401111'
or substr(dx,1,7) =	'H401112'
or substr(dx,1,7) =	'H401113'
or substr(dx,1,7) =	'H401114'
or substr(dx,1,7) =	'H401120'
or substr(dx,1,7) =	'H401121'
or substr(dx,1,7) =	'H401122'
or substr(dx,1,7) =	'H401123'
or substr(dx,1,7) =	'H401124'
or substr(dx,1,7) =	'H401130'
or substr(dx,1,7) =	'H401131'
or substr(dx,1,7) =	'H401132'
or substr(dx,1,7) =	'H401133'
or substr(dx,1,7) =	'H401134'
or substr(dx,1,7) =	'H401190'
or substr(dx,1,7) =	'H401191'
or substr(dx,1,7) =	'H401192'
or substr(dx,1,7) =	'H401193'
or substr(dx,1,7) =	'H401194'
or substr(dx,1,7) =	'H4011X0'
or substr(dx,1,7) =	'H4011X1'
or substr(dx,1,7) =	'H4011X2'
or substr(dx,1,7) =	'H4011X3'
or substr(dx,1,7) =	'H4011X4'
or substr(dx,1,7) =	'H401210'
or substr(dx,1,7) =	'H401211'
or substr(dx,1,7) =	'H401212'
or substr(dx,1,7) =	'H401213'
or substr(dx,1,7) =	'H401214'
or substr(dx,1,7) =	'H401220'
or substr(dx,1,7) =	'H401221'
or substr(dx,1,7) =	'H401222'
or substr(dx,1,7) =	'H401223'
or substr(dx,1,7) =	'H401224'
or substr(dx,1,7) =	'H401230'
or substr(dx,1,7) =	'H401231'
or substr(dx,1,7) =	'H401232'
or substr(dx,1,7) =	'H401233'
or substr(dx,1,7) =	'H401234'
or substr(dx,1,7) =	'H401290'
or substr(dx,1,7) =	'H401291'
or substr(dx,1,7) =	'H401292'
or substr(dx,1,7) =	'H401293'
or substr(dx,1,7) =	'H401294'
or substr(dx,1,7) =	'H401310'
or substr(dx,1,7) =	'H401311'
or substr(dx,1,7) =	'H401312'
or substr(dx,1,7) =	'H401313'
or substr(dx,1,7) =	'H401314'
or substr(dx,1,7) =	'H401320'
or substr(dx,1,7) =	'H401321'
or substr(dx,1,7) =	'H401322'
or substr(dx,1,7) =	'H401323'
or substr(dx,1,7) =	'H401324'
or substr(dx,1,7) =	'H401330'
or substr(dx,1,7) =	'H401331'
or substr(dx,1,7) =	'H401332'
or substr(dx,1,7) =	'H401333'
or substr(dx,1,7) =	'H401334'
or substr(dx,1,7) =	'H401390'
or substr(dx,1,7) =	'H401391'
or substr(dx,1,7) =	'H401392'
or substr(dx,1,7) =	'H401393'
or substr(dx,1,7) =	'H401394'
or substr(dx,1,7) =	'H401410'
or substr(dx,1,7) =	'H401411'
or substr(dx,1,7) =	'H401412'
or substr(dx,1,7) =	'H401413'
or substr(dx,1,7) =	'H401414'
or substr(dx,1,7) =	'H401420'
or substr(dx,1,7) =	'H401421'
or substr(dx,1,7) =	'H401422'
or substr(dx,1,7) =	'H401423'
or substr(dx,1,7) =	'H401424'
or substr(dx,1,7) =	'H401430'
or substr(dx,1,7) =	'H401431'
or substr(dx,1,7) =	'H401432'
or substr(dx,1,7) =	'H401433'
or substr(dx,1,7) =	'H401434'
or substr(dx,1,7) =	'H401490'
or substr(dx,1,7) =	'H401491'
or substr(dx,1,7) =	'H401492'
or substr(dx,1,7) =	'H401493'
or substr(dx,1,7) =	'H401494'
or substr(dx,1,6) =	'H40151'
or substr(dx,1,6) =	'H40152'
or substr(dx,1,6) =	'H40153'
or substr(dx,1,6) =	'H40159'
or substr(dx,1,7) =	'H4020X0'
or substr(dx,1,7) =	'H4020X1'
or substr(dx,1,7) =	'H4020X2'
or substr(dx,1,7) =	'H4020X3'
or substr(dx,1,7) =	'H4020X4'
or substr(dx,1,6) =	'H40211'
or substr(dx,1,6) =	'H40212'
or substr(dx,1,6) =	'H40213'
or substr(dx,1,6) =	'H40219'
or substr(dx,1,7) =	'H402210'
or substr(dx,1,7) =	'H402211'
or substr(dx,1,7) =	'H402212'
or substr(dx,1,7) =	'H402213'
or substr(dx,1,7) =	'H402214'
or substr(dx,1,7) =	'H402220'
or substr(dx,1,7) =	'H402221'
or substr(dx,1,7) =	'H402222'
or substr(dx,1,7) =	'H402223'
or substr(dx,1,7) =	'H402224'
or substr(dx,1,7) =	'H402230'
or substr(dx,1,7) =	'H402231'
or substr(dx,1,7) =	'H402232'
or substr(dx,1,7) =	'H402233'
or substr(dx,1,7) =	'H402234'
or substr(dx,1,7) =	'H402290'
or substr(dx,1,7) =	'H402291'
or substr(dx,1,7) =	'H402292'
or substr(dx,1,7) =	'H402293'
or substr(dx,1,7) =	'H402294'
or substr(dx,1,6) =	'H40231'
or substr(dx,1,6) =	'H40232'
or substr(dx,1,6) =	'H40233'
or substr(dx,1,6) =	'H40239'
or substr(dx,1,6) =	'H40241'
or substr(dx,1,6) =	'H40242'
or substr(dx,1,6) =	'H40243'
or substr(dx,1,6) =	'H40249'
or substr(dx,1,7) =	'H4030X0'
or substr(dx,1,7) =	'H4030X1'
or substr(dx,1,7) =	'H4030X2'
or substr(dx,1,7) =	'H4030X3'
or substr(dx,1,7) =	'H4030X4'
or substr(dx,1,7) =	'H4031X0'
or substr(dx,1,7) =	'H4031X1'
or substr(dx,1,7) =	'H4031X2'
or substr(dx,1,7) =	'H4031X3'
or substr(dx,1,7) =	'H4031X4'
or substr(dx,1,7) =	'H4032X0'
or substr(dx,1,7) =	'H4032X1'
or substr(dx,1,7) =	'H4032X2'
or substr(dx,1,7) =	'H4032X3'
or substr(dx,1,7) =	'H4032X4'
or substr(dx,1,7) =	'H4033X0'
or substr(dx,1,7) =	'H4033X1'
or substr(dx,1,7) =	'H4033X2'
or substr(dx,1,7) =	'H4033X3'
or substr(dx,1,7) =	'H4033X4'
or substr(dx,1,7) =	'H4040X0'
or substr(dx,1,7) =	'H4040X1'
or substr(dx,1,7) =	'H4040X2'
or substr(dx,1,7) =	'H4040X3'
or substr(dx,1,7) =	'H4040X4'
or substr(dx,1,7) =	'H4041X0'
or substr(dx,1,7) =	'H4041X1'
or substr(dx,1,7) =	'H4041X2'
or substr(dx,1,7) =	'H4041X3'
or substr(dx,1,7) =	'H4041X4'
or substr(dx,1,7) =	'H4042X0'
or substr(dx,1,7) =	'H4042X1'
or substr(dx,1,7) =	'H4042X2'
or substr(dx,1,7) =	'H4042X3'
or substr(dx,1,7) =	'H4042X4'
or substr(dx,1,7) =	'H4043X0'
or substr(dx,1,7) =	'H4043X1'
or substr(dx,1,7) =	'H4043X2'
or substr(dx,1,7) =	'H4043X3'
or substr(dx,1,7) =	'H4043X4'
or substr(dx,1,7) =	'H4050X0'
or substr(dx,1,7) =	'H4050X1'
or substr(dx,1,7) =	'H4050X2'
or substr(dx,1,7) =	'H4050X3'
or substr(dx,1,7) =	'H4050X4'
or substr(dx,1,7) =	'H4051X0'
or substr(dx,1,7) =	'H4051X1'
or substr(dx,1,7) =	'H4051X2'
or substr(dx,1,7) =	'H4051X3'
or substr(dx,1,7) =	'H4051X4'
or substr(dx,1,7) =	'H4052X0'
or substr(dx,1,7) =	'H4052X1'
or substr(dx,1,7) =	'H4052X2'
or substr(dx,1,7) =	'H4052X3'
or substr(dx,1,7) =	'H4052X4'
or substr(dx,1,7) =	'H4053X0'
or substr(dx,1,7) =	'H4053X1'
or substr(dx,1,7) =	'H4053X2'
or substr(dx,1,7) =	'H4053X3'
or substr(dx,1,7) =	'H4053X4'
or substr(dx,1,7) =	'H4060X0'
or substr(dx,1,7) =	'H4060X1'
or substr(dx,1,7) =	'H4060X2'
or substr(dx,1,7) =	'H4060X3'
or substr(dx,1,7) =	'H4060X4'
or substr(dx,1,7) =	'H4061X0'
or substr(dx,1,7) =	'H4061X1'
or substr(dx,1,7) =	'H4061X2'
or substr(dx,1,7) =	'H4061X3'
or substr(dx,1,7) =	'H4061X4'
or substr(dx,1,7) =	'H4062X0'
or substr(dx,1,7) =	'H4062X1'
or substr(dx,1,7) =	'H4062X2'
or substr(dx,1,7) =	'H4062X3'
or substr(dx,1,7) =	'H4062X4'
or substr(dx,1,7) =	'H4063X0'
or substr(dx,1,7) =	'H4063X1'
or substr(dx,1,7) =	'H4063X2'
or substr(dx,1,7) =	'H4063X3'
or substr(dx,1,7) =	'H4063X4'
or substr(dx,1,6) =	'H40811'
or substr(dx,1,6) =	'H40812'
or substr(dx,1,6) =	'H40813'
or substr(dx,1,6) =	'H40819'
or substr(dx,1,6) =	'H40821'
or substr(dx,1,6) =	'H40822'
or substr(dx,1,6) =	'H40823'
or substr(dx,1,6) =	'H40829'
or substr(dx,1,6) =	'H40831'
or substr(dx,1,6) =	'H40832'
or substr(dx,1,6) =	'H40833'
or substr(dx,1,6) =	'H40839'
or substr(dx,1,5) =	'H4089'
or substr(dx,1,4) =	'H409'
or substr(dx,1,3) =	'H42'
or substr(dx,1,6) =	'H44511'
or substr(dx,1,6) =	'H44512'
or substr(dx,1,6) =	'H44513'
or substr(dx,1,6) =	'H44519'
or substr(dx,1,6) =	'H47231'
or substr(dx,1,6) =	'H47232'
or substr(dx,1,6) =	'H47233'
or substr(dx,1,6) =	'H47239'
or substr(dx,1,4) =	'Q150')
		and ccw_14=0
                then ccw_14=1;
* Heart Failure;
	if (substr(dx,1,5) =	'39891'
or substr(dx,1,5) =	'40201'
or substr(dx,1,5) =	'40211'
or substr(dx,1,5) =	'40291'
or substr(dx,1,5) =	'40401'
or substr(dx,1,5) =	'40403'
or substr(dx,1,5) =	'40411'
or substr(dx,1,5) =	'40413'
or substr(dx,1,5) =	'40491'
or substr(dx,1,5) =	'40493'
or substr(dx,1,4) =	'4281'
or substr(dx,1,5) =	'42821'
or substr(dx,1,5) =	'42822'
or substr(dx,1,5) =	'42823'
or substr(dx,1,5) =	'42820'
or substr(dx,1,5) =	'42831'
or substr(dx,1,5) =	'42832'
or substr(dx,1,5) =	'42833'
or substr(dx,1,5) =	'42830'
or substr(dx,1,5) =	'42841'
or substr(dx,1,5) =	'42842'
or substr(dx,1,5) =	'42843'
or substr(dx,1,5) =	'42840'
or substr(dx,1,4) =	'4289'
or substr(dx,1,4) =	'4280'
or substr(dx,1,5) =	'I0981'
or substr(dx,1,4) =	'I110'
or substr(dx,1,4) =	'I130'
or substr(dx,1,4) =	'I132'
or substr(dx,1,4) =	'I501'
or substr(dx,1,5) =	'I5020'
or substr(dx,1,5) =	'I5021'
or substr(dx,1,5) =	'I5022'
or substr(dx,1,5) =	'I5023'
or substr(dx,1,5) =	'I5030'
or substr(dx,1,5) =	'I5031'
or substr(dx,1,5) =	'I5032'
or substr(dx,1,5) =	'I5033'
or substr(dx,1,5) =	'I5040'
or substr(dx,1,5) =	'I5041'
or substr(dx,1,5) =	'I5042'
or substr(dx,1,5) =	'I5043'
or substr(dx,1,6) =	'I50810'
or substr(dx,1,6) =	'I50811'
or substr(dx,1,6) =	'I50812'
or substr(dx,1,6) =	'I50813'
or substr(dx,1,6) =	'I50814'
or substr(dx,1,5) =	'I5082'
or substr(dx,1,5) =	'I5083'
or substr(dx,1,5) =	'I5084'
or substr(dx,1,5) =	'I5089'
or substr(dx,1,4) =	'I509')
		and ccw_15=0
                then ccw_15=1;
  * Hip/Pelvic Fracture ;
	if (substr(dx,1,5) =	'73314'
or substr(dx,1,5) =	'73315'
or substr(dx,1,5) =	'73396'
or substr(dx,1,5) =	'73397'
or substr(dx,1,5) =	'73398'
or substr(dx,1,4) =	'8081'
or substr(dx,1,4) =	'8082'
or substr(dx,1,4) =	'8083'
or substr(dx,1,5) =	'80841'
or substr(dx,1,5) =	'80842'
or substr(dx,1,5) =	'80843'
or substr(dx,1,5) =	'80844'
or substr(dx,1,5) =	'80849'
or substr(dx,1,5) =	'80851'
or substr(dx,1,5) =	'80852'
or substr(dx,1,5) =	'80853'
or substr(dx,1,5) =	'80854'
or substr(dx,1,5) =	'80859'
or substr(dx,1,4) =	'8088'
or substr(dx,1,4) =	'8089'
or substr(dx,1,4) =	'8080'
or substr(dx,1,5) =	'82001'
or substr(dx,1,5) =	'82002'
or substr(dx,1,5) =	'82003'
or substr(dx,1,5) =	'82009'
or substr(dx,1,5) =	'82011'
or substr(dx,1,5) =	'82012'
or substr(dx,1,5) =	'82013'
or substr(dx,1,5) =	'82019'
or substr(dx,1,5) =	'82010'
or substr(dx,1,5) =	'82021'
or substr(dx,1,5) =	'82022'
or substr(dx,1,5) =	'82020'
or substr(dx,1,5) =	'82031'
or substr(dx,1,5) =	'82032'
or substr(dx,1,5) =	'82030'
or substr(dx,1,4) =	'8208'
or substr(dx,1,4) =	'8209'
or substr(dx,1,5) =	'82000'
or substr(dx,1,7) =	'M80051A'
or substr(dx,1,7) =	'M80052A'
or substr(dx,1,7) =	'M80059A'
or substr(dx,1,7) =	'M80851A'
or substr(dx,1,7) =	'M80852A'
or substr(dx,1,7) =	'M80859A'
or substr(dx,1,7) =	'M84350A'
or substr(dx,1,7) =	'M84351A'
or substr(dx,1,7) =	'M84352A'
or substr(dx,1,7) =	'M84353A'
or substr(dx,1,7) =	'M84359A'
or substr(dx,1,7) =	'M84451A'
or substr(dx,1,7) =	'M84452A'
or substr(dx,1,7) =	'M84453A'
or substr(dx,1,7) =	'M84459A'
or substr(dx,1,7) =	'M84550A'
or substr(dx,1,7) =	'M84551A'
or substr(dx,1,7) =	'M84552A'
or substr(dx,1,7) =	'M84553A'
or substr(dx,1,7) =	'M84559A'
or substr(dx,1,7) =	'M84650A'
or substr(dx,1,7) =	'M84651A'
or substr(dx,1,7) =	'M84652A'
or substr(dx,1,7) =	'M84653A'
or substr(dx,1,7) =	'M84659A'
or substr(dx,1,7) =	'S32301A'
or substr(dx,1,7) =	'S32301B'
or substr(dx,1,7) =	'S32302A'
or substr(dx,1,7) =	'S32302B'
or substr(dx,1,7) =	'S32309A'
or substr(dx,1,7) =	'S32309B'
or substr(dx,1,7) =	'S32311A'
or substr(dx,1,7) =	'S32311B'
or substr(dx,1,7) =	'S32312A'
or substr(dx,1,7) =	'S32312B'
or substr(dx,1,7) =	'S32313A'
or substr(dx,1,7) =	'S32313B'
or substr(dx,1,7) =	'S32314A'
or substr(dx,1,7) =	'S32314B'
or substr(dx,1,7) =	'S32315A'
or substr(dx,1,7) =	'S32315B'
or substr(dx,1,7) =	'S32316A'
or substr(dx,1,7) =	'S32316B'
or substr(dx,1,7) =	'S32391A'
or substr(dx,1,7) =	'S32391B'
or substr(dx,1,7) =	'S32392A'
or substr(dx,1,7) =	'S32392B'
or substr(dx,1,7) =	'S32399A'
or substr(dx,1,7) =	'S32399B'
or substr(dx,1,7) =	'S32401A'
or substr(dx,1,7) =	'S32401B'
or substr(dx,1,7) =	'S32402A'
or substr(dx,1,7) =	'S32402B'
or substr(dx,1,7) =	'S32409A'
or substr(dx,1,7) =	'S32409B'
or substr(dx,1,7) =	'S32411A'
or substr(dx,1,7) =	'S32411B'
or substr(dx,1,7) =	'S32412A'
or substr(dx,1,7) =	'S32412B'
or substr(dx,1,7) =	'S32413A'
or substr(dx,1,7) =	'S32413B'
or substr(dx,1,7) =	'S32414A'
or substr(dx,1,7) =	'S32414B'
or substr(dx,1,7) =	'S32415A'
or substr(dx,1,7) =	'S32415B'
or substr(dx,1,7) =	'S32416A'
or substr(dx,1,7) =	'S32416B'
or substr(dx,1,7) =	'S32421A'
or substr(dx,1,7) =	'S32421B'
or substr(dx,1,7) =	'S32422A'
or substr(dx,1,7) =	'S32422B'
or substr(dx,1,7) =	'S32423A'
or substr(dx,1,7) =	'S32423B'
or substr(dx,1,7) =	'S32424A'
or substr(dx,1,7) =	'S32424B'
or substr(dx,1,7) =	'S32425A'
or substr(dx,1,7) =	'S32425B'
or substr(dx,1,7) =	'S32426A'
or substr(dx,1,7) =	'S32426B'
or substr(dx,1,7) =	'S32431A'
or substr(dx,1,7) =	'S32431B'
or substr(dx,1,7) =	'S32432A'
or substr(dx,1,7) =	'S32432B'
or substr(dx,1,7) =	'S32433A'
or substr(dx,1,7) =	'S32433B'
or substr(dx,1,7) =	'S32434A'
or substr(dx,1,7) =	'S32434B'
or substr(dx,1,7) =	'S32435A'
or substr(dx,1,7) =	'S32435B'
or substr(dx,1,7) =	'S32436A'
or substr(dx,1,7) =	'S32436B'
or substr(dx,1,7) =	'S32441A'
or substr(dx,1,7) =	'S32441B'
or substr(dx,1,7) =	'S32442A'
or substr(dx,1,7) =	'S32442B'
or substr(dx,1,7) =	'S32443A'
or substr(dx,1,7) =	'S32443B'
or substr(dx,1,7) =	'S32444A'
or substr(dx,1,7) =	'S32444B'
or substr(dx,1,7) =	'S32445A'
or substr(dx,1,7) =	'S32445B'
or substr(dx,1,7) =	'S32446A'
or substr(dx,1,7) =	'S32446B'
or substr(dx,1,7) =	'S32451A'
or substr(dx,1,7) =	'S32451B'
or substr(dx,1,7) =	'S32452A'
or substr(dx,1,7) =	'S32452B'
or substr(dx,1,7) =	'S32453A'
or substr(dx,1,7) =	'S32453B'
or substr(dx,1,7) =	'S32454A'
or substr(dx,1,7) =	'S32454B'
or substr(dx,1,7) =	'S32455A'
or substr(dx,1,7) =	'S32455B'
or substr(dx,1,7) =	'S32456A'
or substr(dx,1,7) =	'S32456B'
or substr(dx,1,7) =	'S32461A'
or substr(dx,1,7) =	'S32461B'
or substr(dx,1,7) =	'S32462A'
or substr(dx,1,7) =	'S32462B'
or substr(dx,1,7) =	'S32463A'
or substr(dx,1,7) =	'S32463B'
or substr(dx,1,7) =	'S32464A'
or substr(dx,1,7) =	'S32464B'
or substr(dx,1,7) =	'S32465A'
or substr(dx,1,7) =	'S32465B'
or substr(dx,1,7) =	'S32466A'
or substr(dx,1,7) =	'S32466B'
or substr(dx,1,7) =	'S32471A'
or substr(dx,1,7) =	'S32471B'
or substr(dx,1,7) =	'S32472A'
or substr(dx,1,7) =	'S32472B'
or substr(dx,1,7) =	'S32473A'
or substr(dx,1,7) =	'S32473B'
or substr(dx,1,7) =	'S32474A'
or substr(dx,1,7) =	'S32474B'
or substr(dx,1,7) =	'S32475A'
or substr(dx,1,7) =	'S32475B'
or substr(dx,1,7) =	'S32476A'
or substr(dx,1,7) =	'S32476B'
or substr(dx,1,7) =	'S32481A'
or substr(dx,1,7) =	'S32481B'
or substr(dx,1,7) =	'S32482A'
or substr(dx,1,7) =	'S32482B'
or substr(dx,1,7) =	'S32483A'
or substr(dx,1,7) =	'S32483B'
or substr(dx,1,7) =	'S32484A'
or substr(dx,1,7) =	'S32484B'
or substr(dx,1,7) =	'S32485A'
or substr(dx,1,7) =	'S32485B'
or substr(dx,1,7) =	'S32486A'
or substr(dx,1,7) =	'S32486B'
or substr(dx,1,7) =	'S32491A'
or substr(dx,1,7) =	'S32491B'
or substr(dx,1,7) =	'S32492A'
or substr(dx,1,7) =	'S32492B'
or substr(dx,1,7) =	'S32499A'
or substr(dx,1,7) =	'S32499B'
or substr(dx,1,7) =	'S32501A'
or substr(dx,1,7) =	'S32501B'
or substr(dx,1,7) =	'S32502A'
or substr(dx,1,7) =	'S32502B'
or substr(dx,1,7) =	'S32509A'
or substr(dx,1,7) =	'S32509B'
or substr(dx,1,7) =	'S32511A'
or substr(dx,1,7) =	'S32511B'
or substr(dx,1,7) =	'S32512A'
or substr(dx,1,7) =	'S32512B'
or substr(dx,1,7) =	'S32519A'
or substr(dx,1,7) =	'S32519B'
or substr(dx,1,7) =	'S32591A'
or substr(dx,1,7) =	'S32591B'
or substr(dx,1,7) =	'S32592A'
or substr(dx,1,7) =	'S32592B'
or substr(dx,1,7) =	'S32599A'
or substr(dx,1,7) =	'S32599B'
or substr(dx,1,7) =	'S32601A'
or substr(dx,1,7) =	'S32601B'
or substr(dx,1,7) =	'S32602A'
or substr(dx,1,7) =	'S32602B'
or substr(dx,1,7) =	'S32609A'
or substr(dx,1,7) =	'S32609B'
or substr(dx,1,7) =	'S32611A'
or substr(dx,1,7) =	'S32611B'
or substr(dx,1,7) =	'S32612A'
or substr(dx,1,7) =	'S32612B'
or substr(dx,1,7) =	'S32613A'
or substr(dx,1,7) =	'S32613B'
or substr(dx,1,7) =	'S32614A'
or substr(dx,1,7) =	'S32614B'
or substr(dx,1,7) =	'S32615A'
or substr(dx,1,7) =	'S32615B'
or substr(dx,1,7) =	'S32616A'
or substr(dx,1,7) =	'S32616B'
or substr(dx,1,7) =	'S32691A'
or substr(dx,1,7) =	'S32691B'
or substr(dx,1,7) =	'S32692A'
or substr(dx,1,7) =	'S32692B'
or substr(dx,1,7) =	'S32699A'
or substr(dx,1,7) =	'S32699B'
or substr(dx,1,7) =	'S32810A'
or substr(dx,1,7) =	'S32810B'
or substr(dx,1,7) =	'S32811A'
or substr(dx,1,7) =	'S32811B'
or substr(dx,1,7) =	'S3282XA'
or substr(dx,1,7) =	'S3282XB'
or substr(dx,1,7) =	'S3289XA'
or substr(dx,1,7) =	'S3289XB'
or substr(dx,1,7) =	'S329XXA'
or substr(dx,1,7) =	'S329XXB'
or substr(dx,1,7) =	'S72001A'
or substr(dx,1,7) =	'S72001B'
or substr(dx,1,7) =	'S72001C'
or substr(dx,1,7) =	'S72002A'
or substr(dx,1,7) =	'S72002B'
or substr(dx,1,7) =	'S72002C'
or substr(dx,1,7) =	'S72009A'
or substr(dx,1,7) =	'S72009B'
or substr(dx,1,7) =	'S72009C'
or substr(dx,1,7) =	'S72011A'
or substr(dx,1,7) =	'S72011B'
or substr(dx,1,7) =	'S72011C'
or substr(dx,1,7) =	'S72012A'
or substr(dx,1,7) =	'S72012B'
or substr(dx,1,7) =	'S72012C'
or substr(dx,1,7) =	'S72019A'
or substr(dx,1,7) =	'S72019B'
or substr(dx,1,7) =	'S72019C'
or substr(dx,1,7) =	'S72021A'
or substr(dx,1,7) =	'S72021B'
or substr(dx,1,7) =	'S72021C'
or substr(dx,1,7) =	'S72022A'
or substr(dx,1,7) =	'S72022B'
or substr(dx,1,7) =	'S72022C'
or substr(dx,1,7) =	'S72023A'
or substr(dx,1,7) =	'S72023B'
or substr(dx,1,7) =	'S72023C'
or substr(dx,1,7) =	'S72024A'
or substr(dx,1,7) =	'S72024B'
or substr(dx,1,7) =	'S72024C'
or substr(dx,1,7) =	'S72025A'
or substr(dx,1,7) =	'S72025B'
or substr(dx,1,7) =	'S72025C'
or substr(dx,1,7) =	'S72026A'
or substr(dx,1,7) =	'S72026B'
or substr(dx,1,7) =	'S72026C'
or substr(dx,1,7) =	'S72031A'
or substr(dx,1,7) =	'S72031B'
or substr(dx,1,7) =	'S72031C'
or substr(dx,1,7) =	'S72032A'
or substr(dx,1,7) =	'S72032B'
or substr(dx,1,7) =	'S72032C'
or substr(dx,1,7) =	'S72033A'
or substr(dx,1,7) =	'S72033B'
or substr(dx,1,7) =	'S72033C'
or substr(dx,1,7) =	'S72034A'
or substr(dx,1,7) =	'S72034B'
or substr(dx,1,7) =	'S72034C'
or substr(dx,1,7) =	'S72035A'
or substr(dx,1,7) =	'S72035B'
or substr(dx,1,7) =	'S72035C'
or substr(dx,1,7) =	'S72036A'
or substr(dx,1,7) =	'S72036B'
or substr(dx,1,7) =	'S72036C'
or substr(dx,1,7) =	'S72041A'
or substr(dx,1,7) =	'S72041B'
or substr(dx,1,7) =	'S72041C'
or substr(dx,1,7) =	'S72042A'
or substr(dx,1,7) =	'S72042B'
or substr(dx,1,7) =	'S72042C'
or substr(dx,1,7) =	'S72043A'
or substr(dx,1,7) =	'S72043B'
or substr(dx,1,7) =	'S72043C'
or substr(dx,1,7) =	'S72044A'
or substr(dx,1,7) =	'S72044B'
or substr(dx,1,7) =	'S72044C'
or substr(dx,1,7) =	'S72045A'
or substr(dx,1,7) =	'S72045B'
or substr(dx,1,7) =	'S72045C'
or substr(dx,1,7) =	'S72046A'
or substr(dx,1,7) =	'S72046B'
or substr(dx,1,7) =	'S72046C'
or substr(dx,1,7) =	'S72051A'
or substr(dx,1,7) =	'S72051B'
or substr(dx,1,7) =	'S72051C'
or substr(dx,1,7) =	'S72052A'
or substr(dx,1,7) =	'S72052B'
or substr(dx,1,7) =	'S72052C'
or substr(dx,1,7) =	'S72059A'
or substr(dx,1,7) =	'S72059B'
or substr(dx,1,7) =	'S72059C'
or substr(dx,1,7) =	'S72061A'
or substr(dx,1,7) =	'S72061B'
or substr(dx,1,7) =	'S72061C'
or substr(dx,1,7) =	'S72062A'
or substr(dx,1,7) =	'S72062B'
or substr(dx,1,7) =	'S72062C'
or substr(dx,1,7) =	'S72063A'
or substr(dx,1,7) =	'S72063B'
or substr(dx,1,7) =	'S72063C'
or substr(dx,1,7) =	'S72064A'
or substr(dx,1,7) =	'S72064B'
or substr(dx,1,7) =	'S72064C'
or substr(dx,1,7) =	'S72065A'
or substr(dx,1,7) =	'S72065B'
or substr(dx,1,7) =	'S72065C'
or substr(dx,1,7) =	'S72066A'
or substr(dx,1,7) =	'S72066B'
or substr(dx,1,7) =	'S72066C'
or substr(dx,1,7) =	'S72091A'
or substr(dx,1,7) =	'S72091B'
or substr(dx,1,7) =	'S72091C'
or substr(dx,1,7) =	'S72092A'
or substr(dx,1,7) =	'S72092B'
or substr(dx,1,7) =	'S72092C'
or substr(dx,1,7) =	'S72099A'
or substr(dx,1,7) =	'S72099B'
or substr(dx,1,7) =	'S72099C'
or substr(dx,1,7) =	'S72101A'
or substr(dx,1,7) =	'S72101B'
or substr(dx,1,7) =	'S72101C'
or substr(dx,1,7) =	'S72102A'
or substr(dx,1,7) =	'S72102B'
or substr(dx,1,7) =	'S72102C'
or substr(dx,1,7) =	'S72109A'
or substr(dx,1,7) =	'S72109B'
or substr(dx,1,7) =	'S72109C'
or substr(dx,1,7) =	'S72111A'
or substr(dx,1,7) =	'S72111B'
or substr(dx,1,7) =	'S72111C'
or substr(dx,1,7) =	'S72112A'
or substr(dx,1,7) =	'S72112B'
or substr(dx,1,7) =	'S72112C'
or substr(dx,1,7) =	'S72113A'
or substr(dx,1,7) =	'S72113B'
or substr(dx,1,7) =	'S72113C'
or substr(dx,1,7) =	'S72114A'
or substr(dx,1,7) =	'S72114B'
or substr(dx,1,7) =	'S72114C'
or substr(dx,1,7) =	'S72115A'
or substr(dx,1,7) =	'S72115B'
or substr(dx,1,7) =	'S72115C'
or substr(dx,1,7) =	'S72116A'
or substr(dx,1,7) =	'S72116B'
or substr(dx,1,7) =	'S72116C'
or substr(dx,1,7) =	'S72121A'
or substr(dx,1,7) =	'S72121B'
or substr(dx,1,7) =	'S72121C'
or substr(dx,1,7) =	'S72122A'
or substr(dx,1,7) =	'S72122B'
or substr(dx,1,7) =	'S72122C'
or substr(dx,1,7) =	'S72123A'
or substr(dx,1,7) =	'S72123B'
or substr(dx,1,7) =	'S72123C'
or substr(dx,1,7) =	'S72124A'
or substr(dx,1,7) =	'S72124B'
or substr(dx,1,7) =	'S72124C'
or substr(dx,1,7) =	'S72125A'
or substr(dx,1,7) =	'S72125B'
or substr(dx,1,7) =	'S72125C'
or substr(dx,1,7) =	'S72126A'
or substr(dx,1,7) =	'S72126B'
or substr(dx,1,7) =	'S72126C'
or substr(dx,1,7) =	'S72131A'
or substr(dx,1,7) =	'S72131B'
or substr(dx,1,7) =	'S72131C'
or substr(dx,1,7) =	'S72132A'
or substr(dx,1,7) =	'S72132B'
or substr(dx,1,7) =	'S72132C'
or substr(dx,1,7) =	'S72133A'
or substr(dx,1,7) =	'S72133B'
or substr(dx,1,7) =	'S72133C'
or substr(dx,1,7) =	'S72134A'
or substr(dx,1,7) =	'S72134B'
or substr(dx,1,7) =	'S72134C'
or substr(dx,1,7) =	'S72135A'
or substr(dx,1,7) =	'S72135B'
or substr(dx,1,7) =	'S72135C'
or substr(dx,1,7) =	'S72136A'
or substr(dx,1,7) =	'S72136B'
or substr(dx,1,7) =	'S72136C'
or substr(dx,1,7) =	'S72141A'
or substr(dx,1,7) =	'S72141B'
or substr(dx,1,7) =	'S72141C'
or substr(dx,1,7) =	'S72142A'
or substr(dx,1,7) =	'S72142B'
or substr(dx,1,7) =	'S72142C'
or substr(dx,1,7) =	'S72143A'
or substr(dx,1,7) =	'S72143B'
or substr(dx,1,7) =	'S72143C'
or substr(dx,1,7) =	'S72144A'
or substr(dx,1,7) =	'S72144B'
or substr(dx,1,7) =	'S72144C'
or substr(dx,1,7) =	'S72145A'
or substr(dx,1,7) =	'S72145B'
or substr(dx,1,7) =	'S72145C'
or substr(dx,1,7) =	'S72146A'
or substr(dx,1,7) =	'S72146B'
or substr(dx,1,7) =	'S72146C'
or substr(dx,1,7) =	'S7221XA'
or substr(dx,1,7) =	'S7221XB'
or substr(dx,1,7) =	'S7221XC'
or substr(dx,1,7) =	'S7222XA'
or substr(dx,1,7) =	'S7222XB'
or substr(dx,1,7) =	'S7222XC'
or substr(dx,1,7) =	'S7223XA'
or substr(dx,1,7) =	'S7223XB'
or substr(dx,1,7) =	'S7223XC'
or substr(dx,1,7) =	'S7224XA'
or substr(dx,1,7) =	'S7224XB'
or substr(dx,1,7) =	'S7224XC'
or substr(dx,1,7) =	'S7225XA'
or substr(dx,1,7) =	'S7225XB'
or substr(dx,1,7) =	'S7225XC'
or substr(dx,1,7) =	'S7226XA'
or substr(dx,1,7) =	'S7226XB'
or substr(dx,1,7) =	'S7226XC'
or substr(dx,1,7) =	'S79001A'
or substr(dx,1,7) =	'S79002A'
or substr(dx,1,7) =	'S79009A'
or substr(dx,1,7) =	'S79011A'
or substr(dx,1,7) =	'S79012A'
or substr(dx,1,7) =	'S79019A'
or substr(dx,1,7) =	'S79091A'
or substr(dx,1,7) =	'S79092A'
or substr(dx,1,7) =	'S79099A')
		and ccw_16=0
                then ccw_16=1;
  * Hyperlipidemia ;
	if (substr(dx,1,4) =	'2721'
or substr(dx,1,4) =	'2722'
or substr(dx,1,4) =	'2723'
or substr(dx,1,4) =	'2724'
or substr(dx,1,4) =	'2720'
or substr(dx,1,4) =	'E780'
or substr(dx,1,4) =	'E781'
or substr(dx,1,4) =	'E782'
or substr(dx,1,4) =	'E783'
or substr(dx,1,4) =	'E784'
or substr(dx,1,4) =	'E785' )
		and ccw_17=0
                then ccw_17=1;

  * Hypertension ;
	if (substr(dx,1,5) =	'36211'
or substr(dx,1,4) =	'4011'
or substr(dx,1,4) =	'4019'
or substr(dx,1,4) =	'4010'
or substr(dx,1,5) =	'40201'
or substr(dx,1,5) =	'40211'
or substr(dx,1,5) =	'40210'
or substr(dx,1,5) =	'40291'
or substr(dx,1,5) =	'40290'
or substr(dx,1,5) =	'40200'
or substr(dx,1,5) =	'40301'
or substr(dx,1,5) =	'40311'
or substr(dx,1,5) =	'40310'
or substr(dx,1,5) =	'40391'
or substr(dx,1,5) =	'40390'
or substr(dx,1,5) =	'40300'
or substr(dx,1,5) =	'40401'
or substr(dx,1,5) =	'40402'
or substr(dx,1,5) =	'40403'
or substr(dx,1,5) =	'40411'
or substr(dx,1,5) =	'40412'
or substr(dx,1,5) =	'40413'
or substr(dx,1,5) =	'40410'
or substr(dx,1,5) =	'40491'
or substr(dx,1,5) =	'40492'
or substr(dx,1,5) =	'40493'
or substr(dx,1,5) =	'40490'
or substr(dx,1,5) =	'40400'
or substr(dx,1,5) =	'40501'
or substr(dx,1,5) =	'40509'
or substr(dx,1,5) =	'40511'
or substr(dx,1,5) =	'40519'
or substr(dx,1,5) =	'40591'
or substr(dx,1,5) =	'40599'
or substr(dx,1,4) =	'4372'
or substr(dx,1,6) =	'H35031'
or substr(dx,1,6) =	'H35032'
or substr(dx,1,6) =	'H35033'
or substr(dx,1,6) =	'H35039'
or substr(dx,1,3) =	'I10'
or substr(dx,1,4) =	'I110'
or substr(dx,1,4) =	'I119'
or substr(dx,1,4) =	'I120'
or substr(dx,1,4) =	'I129'
or substr(dx,1,4) =	'I130'
or substr(dx,1,5) =	'I1310'
or substr(dx,1,5) =	'I1311'
or substr(dx,1,4) =	'I132'
or substr(dx,1,4) =	'I150'
or substr(dx,1,4) =	'I151'
or substr(dx,1,4) =	'I152'
or substr(dx,1,4) =	'I158'
or substr(dx,1,4) =	'I159'
or substr(dx,1,4) =	'I674'
or substr(dx,1,4) =	'N262' )
		and ccw_18=0
                then ccw_18=1;
  * Ischemic Heart Disease ;
	if (substr(dx,1,5) =	'41001'
or substr(dx,1,5) =	'41002'
or substr(dx,1,5) =	'41011'
or substr(dx,1,5) =	'41012'
or substr(dx,1,5) =	'41010'
or substr(dx,1,5) =	'41021'
or substr(dx,1,5) =	'41022'
or substr(dx,1,5) =	'41020'
or substr(dx,1,5) =	'41031'
or substr(dx,1,5) =	'41032'
or substr(dx,1,5) =	'41030'
or substr(dx,1,5) =	'41041'
or substr(dx,1,5) =	'41042'
or substr(dx,1,5) =	'41040'
or substr(dx,1,5) =	'41051'
or substr(dx,1,5) =	'41052'
or substr(dx,1,5) =	'41050'
or substr(dx,1,5) =	'41061'
or substr(dx,1,5) =	'41062'
or substr(dx,1,5) =	'41060'
or substr(dx,1,5) =	'41071'
or substr(dx,1,5) =	'41072'
or substr(dx,1,5) =	'41070'
or substr(dx,1,5) =	'41081'
or substr(dx,1,5) =	'41082'
or substr(dx,1,5) =	'41080'
or substr(dx,1,5) =	'41091'
or substr(dx,1,5) =	'41092'
or substr(dx,1,5) =	'41090'
or substr(dx,1,5) =	'41000'
or substr(dx,1,4) =	'4111'
or substr(dx,1,5) =	'41181'
or substr(dx,1,5) =	'41189'
or substr(dx,1,4) =	'4110'
or substr(dx,1,3) =	'412'
or substr(dx,1,4) =	'4131'
or substr(dx,1,4) =	'4139'
or substr(dx,1,4) =	'4130'
or substr(dx,1,5) =	'41401'
or substr(dx,1,5) =	'41402'
or substr(dx,1,5) =	'41403'
or substr(dx,1,5) =	'41404'
or substr(dx,1,5) =	'41405'
or substr(dx,1,5) =	'41406'
or substr(dx,1,5) =	'41407'
or substr(dx,1,5) =	'41412'
or substr(dx,1,4) =	'4142'
or substr(dx,1,4) =	'4143'
or substr(dx,1,4) =	'4144'
or substr(dx,1,4) =	'4148'
or substr(dx,1,4) =	'4149'
or substr(dx,1,3) =	'414'
or substr(dx,1,4) =	'I200'
or substr(dx,1,4) =	'I201'
or substr(dx,1,4) =	'I208'
or substr(dx,1,4) =	'I209'
or substr(dx,1,5) =	'I2101'
or substr(dx,1,5) =	'I2102'
or substr(dx,1,5) =	'I2109'
or substr(dx,1,5) =	'I2111'
or substr(dx,1,5) =	'I2119'
or substr(dx,1,5) =	'I2121'
or substr(dx,1,5) =	'I2129'
or substr(dx,1,4) =	'I213'
or substr(dx,1,4) =	'I214'
or substr(dx,1,5) =	'I21A1'
or substr(dx,1,5) =	'I21A9'
or substr(dx,1,4) =	'I220'
or substr(dx,1,4) =	'I221'
or substr(dx,1,4) =	'I222'
or substr(dx,1,4) =	'I228'
or substr(dx,1,4) =	'I229'
or substr(dx,1,4) =	'I230'
or substr(dx,1,4) =	'I231'
or substr(dx,1,4) =	'I232'
or substr(dx,1,4) =	'I233'
or substr(dx,1,4) =	'I234'
or substr(dx,1,4) =	'I235'
or substr(dx,1,4) =	'I236'
or substr(dx,1,4) =	'I237'
or substr(dx,1,4) =	'I238'
or substr(dx,1,4) =	'I240'
or substr(dx,1,4) =	'I241'
or substr(dx,1,4) =	'I248'
or substr(dx,1,4) =	'I249'
or substr(dx,1,5) =	'I2510'
or substr(dx,1,6) =	'I25110'
or substr(dx,1,6) =	'I25111'
or substr(dx,1,6) =	'I25118'
or substr(dx,1,6) =	'I25119'
or substr(dx,1,4) =	'I252'
or substr(dx,1,4) =	'I253'
or substr(dx,1,5) =	'I2541'
or substr(dx,1,5) =	'I2542'
or substr(dx,1,4) =	'I255'
or substr(dx,1,4) =	'I256'
or substr(dx,1,6) =	'I25700'
or substr(dx,1,6) =	'I25701'
or substr(dx,1,6) =	'I25708'
or substr(dx,1,6) =	'I25709'
or substr(dx,1,6) =	'I25710'
or substr(dx,1,6) =	'I25711'
or substr(dx,1,6) =	'I25718'
or substr(dx,1,6) =	'I25719'
or substr(dx,1,6) =	'I25720'
or substr(dx,1,6) =	'I25721'
or substr(dx,1,6) =	'I25728'
or substr(dx,1,6) =	'I25729'
or substr(dx,1,6) =	'I25730'
or substr(dx,1,6) =	'I25731'
or substr(dx,1,6) =	'I25738'
or substr(dx,1,6) =	'I25739'
or substr(dx,1,6) =	'I25750'
or substr(dx,1,6) =	'I25751'
or substr(dx,1,6) =	'I25758'
or substr(dx,1,6) =	'I25759'
or substr(dx,1,6) =	'I25760'
or substr(dx,1,6) =	'I25761'
or substr(dx,1,6) =	'I25768'
or substr(dx,1,6) =	'I25769'
or substr(dx,1,6) =	'I25790'
or substr(dx,1,6) =	'I25791'
or substr(dx,1,6) =	'I25798'
or substr(dx,1,6) =	'I25799'
or substr(dx,1,6) =	'I25810'
or substr(dx,1,6) =	'I25811'
or substr(dx,1,6) =	'I25812'
or substr(dx,1,5) =	'I2582'
or substr(dx,1,5) =	'I2583'
or substr(dx,1,5) =	'I2584'
or substr(dx,1,5) =	'I2589'
or substr(dx,1,4) =	'I259')
		and ccw_19=0
                then ccw_19=1;
  * Osteoporosis ;
	if (substr(dx,1,5) =	'73301'
or substr(dx,1,5) =	'73302'
or substr(dx,1,5) =	'73303'
or substr(dx,1,5) =	'73309'
or substr(dx,1,5) =	'73300'
or substr(dx,1,4) =	'M810'
or substr(dx,1,4) =	'M816'
or substr(dx,1,4) =	'M818')
		and ccw_20=0
                then ccw_20=1;
  * RA/OA ;
	if (substr(dx,1,4) =	'7141'
or substr(dx,1,4) =	'7142'
or substr(dx,1,5) =	'71431'
or substr(dx,1,5) =	'71432'
or substr(dx,1,5) =	'71433'
or substr(dx,1,5) =	'71430'
or substr(dx,1,4) =	'7140'
or substr(dx,1,5) =	'71504'
or substr(dx,1,5) =	'71509'
or substr(dx,1,5) =	'71511'
or substr(dx,1,5) =	'71512'
or substr(dx,1,5) =	'71513'
or substr(dx,1,5) =	'71514'
or substr(dx,1,5) =	'71515'
or substr(dx,1,5) =	'71516'
or substr(dx,1,5) =	'71517'
or substr(dx,1,5) =	'71518'
or substr(dx,1,5) =	'71510'
or substr(dx,1,5) =	'71521'
or substr(dx,1,5) =	'71522'
or substr(dx,1,5) =	'71523'
or substr(dx,1,5) =	'71524'
or substr(dx,1,5) =	'71525'
or substr(dx,1,5) =	'71526'
or substr(dx,1,5) =	'71527'
or substr(dx,1,5) =	'71528'
or substr(dx,1,5) =	'71520'
or substr(dx,1,5) =	'71531'
or substr(dx,1,5) =	'71532'
or substr(dx,1,5) =	'71533'
or substr(dx,1,5) =	'71534'
or substr(dx,1,5) =	'71535'
or substr(dx,1,5) =	'71536'
or substr(dx,1,5) =	'71537'
or substr(dx,1,5) =	'71538'
or substr(dx,1,5) =	'71530'
or substr(dx,1,5) =	'71589'
or substr(dx,1,5) =	'71580'
or substr(dx,1,5) =	'71591'
or substr(dx,1,5) =	'71592'
or substr(dx,1,5) =	'71593'
or substr(dx,1,5) =	'71594'
or substr(dx,1,5) =	'71595'
or substr(dx,1,5) =	'71596'
or substr(dx,1,5) =	'71597'
or substr(dx,1,5) =	'71598'
or substr(dx,1,5) =	'71590'
or substr(dx,1,5) =	'71500'
or substr(dx,1,4) =	'7200'
or substr(dx,1,4) =	'7211'
or substr(dx,1,4) =	'7212'
or substr(dx,1,4) =	'7213'
or substr(dx,1,5) =	'72191'
or substr(dx,1,5) =	'72190'
or substr(dx,1,4) =	'7210'
or substr(dx,1,5) =	'M0500'
or substr(dx,1,6) =	'M05011'
or substr(dx,1,6) =	'M05012'
or substr(dx,1,6) =	'M05019'
or substr(dx,1,6) =	'M05021'
or substr(dx,1,6) =	'M05022'
or substr(dx,1,6) =	'M05029'
or substr(dx,1,6) =	'M05031'
or substr(dx,1,6) =	'M05032'
or substr(dx,1,6) =	'M05039'
or substr(dx,1,6) =	'M05041'
or substr(dx,1,6) =	'M05042'
or substr(dx,1,6) =	'M05049'
or substr(dx,1,6) =	'M05051'
or substr(dx,1,6) =	'M05052'
or substr(dx,1,6) =	'M05059'
or substr(dx,1,6) =	'M05061'
or substr(dx,1,6) =	'M05062'
or substr(dx,1,6) =	'M05069'
or substr(dx,1,6) =	'M05071'
or substr(dx,1,6) =	'M05072'
or substr(dx,1,6) =	'M05079'
or substr(dx,1,5) =	'M0509'
or substr(dx,1,5) =	'M0520'
or substr(dx,1,6) =	'M05211'
or substr(dx,1,6) =	'M05212'
or substr(dx,1,6) =	'M05219'
or substr(dx,1,6) =	'M05221'
or substr(dx,1,6) =	'M05222'
or substr(dx,1,6) =	'M05229'
or substr(dx,1,6) =	'M05231'
or substr(dx,1,6) =	'M05232'
or substr(dx,1,6) =	'M05239'
or substr(dx,1,6) =	'M05241'
or substr(dx,1,6) =	'M05242'
or substr(dx,1,6) =	'M05249'
or substr(dx,1,6) =	'M05251'
or substr(dx,1,6) =	'M05252'
or substr(dx,1,6) =	'M05259'
or substr(dx,1,6) =	'M05261'
or substr(dx,1,6) =	'M05262'
or substr(dx,1,6) =	'M05269'
or substr(dx,1,6) =	'M05271'
or substr(dx,1,6) =	'M05272'
or substr(dx,1,6) =	'M05279'
or substr(dx,1,5) =	'M0529'
or substr(dx,1,5) =	'M0530'
or substr(dx,1,6) =	'M05311'
or substr(dx,1,6) =	'M05312'
or substr(dx,1,6) =	'M05319'
or substr(dx,1,6) =	'M05321'
or substr(dx,1,6) =	'M05322'
or substr(dx,1,6) =	'M05329'
or substr(dx,1,6) =	'M05331'
or substr(dx,1,6) =	'M05332'
or substr(dx,1,6) =	'M05339'
or substr(dx,1,6) =	'M05341'
or substr(dx,1,6) =	'M05342'
or substr(dx,1,6) =	'M05349'
or substr(dx,1,6) =	'M05351'
or substr(dx,1,6) =	'M05352'
or substr(dx,1,6) =	'M05359'
or substr(dx,1,6) =	'M05361'
or substr(dx,1,6) =	'M05362'
or substr(dx,1,6) =	'M05369'
or substr(dx,1,6) =	'M05371'
or substr(dx,1,6) =	'M05372'
or substr(dx,1,6) =	'M05379'
or substr(dx,1,5) =	'M0539'
or substr(dx,1,5) =	'M0540'
or substr(dx,1,6) =	'M05411'
or substr(dx,1,6) =	'M05412'
or substr(dx,1,6) =	'M05419'
or substr(dx,1,6) =	'M05421'
or substr(dx,1,6) =	'M05422'
or substr(dx,1,6) =	'M05429'
or substr(dx,1,6) =	'M05431'
or substr(dx,1,6) =	'M05432'
or substr(dx,1,6) =	'M05439'
or substr(dx,1,6) =	'M05441'
or substr(dx,1,6) =	'M05442'
or substr(dx,1,6) =	'M05449'
or substr(dx,1,6) =	'M05451'
or substr(dx,1,6) =	'M05452'
or substr(dx,1,6) =	'M05459'
or substr(dx,1,6) =	'M05461'
or substr(dx,1,6) =	'M05462'
or substr(dx,1,6) =	'M05469'
or substr(dx,1,6) =	'M05471'
or substr(dx,1,6) =	'M05472'
or substr(dx,1,6) =	'M05479'
or substr(dx,1,5) =	'M0549'
or substr(dx,1,5) =	'M0550'
or substr(dx,1,6) =	'M05511'
or substr(dx,1,6) =	'M05512'
or substr(dx,1,6) =	'M05519'
or substr(dx,1,6) =	'M05521'
or substr(dx,1,6) =	'M05522'
or substr(dx,1,6) =	'M05529'
or substr(dx,1,6) =	'M05531'
or substr(dx,1,6) =	'M05532'
or substr(dx,1,6) =	'M05539'
or substr(dx,1,6) =	'M05541'
or substr(dx,1,6) =	'M05542'
or substr(dx,1,6) =	'M05549'
or substr(dx,1,6) =	'M05551'
or substr(dx,1,6) =	'M05552'
or substr(dx,1,6) =	'M05559'
or substr(dx,1,6) =	'M05561'
or substr(dx,1,6) =	'M05562'
or substr(dx,1,6) =	'M05569'
or substr(dx,1,6) =	'M05571'
or substr(dx,1,6) =	'M05572'
or substr(dx,1,6) =	'M05579'
or substr(dx,1,5) =	'M0559'
or substr(dx,1,5) =	'M0560'
or substr(dx,1,6) =	'M05611'
or substr(dx,1,6) =	'M05612'
or substr(dx,1,6) =	'M05619'
or substr(dx,1,6) =	'M05621'
or substr(dx,1,6) =	'M05622'
or substr(dx,1,6) =	'M05629'
or substr(dx,1,6) =	'M05631'
or substr(dx,1,6) =	'M05632'
or substr(dx,1,6) =	'M05639'
or substr(dx,1,6) =	'M05641'
or substr(dx,1,6) =	'M05642'
or substr(dx,1,6) =	'M05649'
or substr(dx,1,6) =	'M05651'
or substr(dx,1,6) =	'M05652'
or substr(dx,1,6) =	'M05659'
or substr(dx,1,6) =	'M05661'
or substr(dx,1,6) =	'M05662'
or substr(dx,1,6) =	'M05669'
or substr(dx,1,6) =	'M05671'
or substr(dx,1,6) =	'M05672'
or substr(dx,1,6) =	'M05679'
or substr(dx,1,5) =	'M0569'
or substr(dx,1,5) =	'M0570'
or substr(dx,1,6) =	'M05711'
or substr(dx,1,6) =	'M05712'
or substr(dx,1,6) =	'M05719'
or substr(dx,1,6) =	'M05721'
or substr(dx,1,6) =	'M05722'
or substr(dx,1,6) =	'M05729'
or substr(dx,1,6) =	'M05731'
or substr(dx,1,6) =	'M05732'
or substr(dx,1,6) =	'M05739'
or substr(dx,1,6) =	'M05741'
or substr(dx,1,6) =	'M05742'
or substr(dx,1,6) =	'M05749'
or substr(dx,1,6) =	'M05751'
or substr(dx,1,6) =	'M05752'
or substr(dx,1,6) =	'M05759'
or substr(dx,1,6) =	'M05761'
or substr(dx,1,6) =	'M05762'
or substr(dx,1,6) =	'M05769'
or substr(dx,1,6) =	'M05771'
or substr(dx,1,6) =	'M05772'
or substr(dx,1,6) =	'M05779'
or substr(dx,1,5) =	'M0579'
or substr(dx,1,5) =	'M0580'
or substr(dx,1,6) =	'M05811'
or substr(dx,1,6) =	'M05812'
or substr(dx,1,6) =	'M05819'
or substr(dx,1,6) =	'M05821'
or substr(dx,1,6) =	'M05822'
or substr(dx,1,6) =	'M05829'
or substr(dx,1,6) =	'M05831'
or substr(dx,1,6) =	'M05832'
or substr(dx,1,6) =	'M05839'
or substr(dx,1,6) =	'M05841'
or substr(dx,1,6) =	'M05842'
or substr(dx,1,6) =	'M05849'
or substr(dx,1,6) =	'M05851'
or substr(dx,1,6) =	'M05852'
or substr(dx,1,6) =	'M05859'
or substr(dx,1,6) =	'M05861'
or substr(dx,1,6) =	'M05862'
or substr(dx,1,6) =	'M05869'
or substr(dx,1,6) =	'M05871'
or substr(dx,1,6) =	'M05872'
or substr(dx,1,6) =	'M05879'
or substr(dx,1,5) =	'M0589'
or substr(dx,1,4) =	'M059'
or substr(dx,1,5) =	'M0600'
or substr(dx,1,6) =	'M06011'
or substr(dx,1,6) =	'M06012'
or substr(dx,1,6) =	'M06019'
or substr(dx,1,6) =	'M06021'
or substr(dx,1,6) =	'M06022'
or substr(dx,1,6) =	'M06029'
or substr(dx,1,6) =	'M06031'
or substr(dx,1,6) =	'M06032'
or substr(dx,1,6) =	'M06039'
or substr(dx,1,6) =	'M06041'
or substr(dx,1,6) =	'M06042'
or substr(dx,1,6) =	'M06049'
or substr(dx,1,6) =	'M06051'
or substr(dx,1,6) =	'M06052'
or substr(dx,1,6) =	'M06059'
or substr(dx,1,6) =	'M06061'
or substr(dx,1,6) =	'M06062'
or substr(dx,1,6) =	'M06069'
or substr(dx,1,6) =	'M06071'
or substr(dx,1,6) =	'M06072'
or substr(dx,1,6) =	'M06079'
or substr(dx,1,5) =	'M0608'
or substr(dx,1,5) =	'M0609'
or substr(dx,1,4) =	'M061'
or substr(dx,1,5) =	'M0620'
or substr(dx,1,6) =	'M06211'
or substr(dx,1,6) =	'M06212'
or substr(dx,1,6) =	'M06219'
or substr(dx,1,6) =	'M06221'
or substr(dx,1,6) =	'M06222'
or substr(dx,1,6) =	'M06229'
or substr(dx,1,6) =	'M06231'
or substr(dx,1,6) =	'M06232'
or substr(dx,1,6) =	'M06239'
or substr(dx,1,6) =	'M06241'
or substr(dx,1,6) =	'M06242'
or substr(dx,1,6) =	'M06249'
or substr(dx,1,6) =	'M06251'
or substr(dx,1,6) =	'M06252'
or substr(dx,1,6) =	'M06259'
or substr(dx,1,6) =	'M06261'
or substr(dx,1,6) =	'M06262'
or substr(dx,1,6) =	'M06269'
or substr(dx,1,6) =	'M06271'
or substr(dx,1,6) =	'M06272'
or substr(dx,1,6) =	'M06279'
or substr(dx,1,5) =	'M0628'
or substr(dx,1,5) =	'M0629'
or substr(dx,1,5) =	'M0630'
or substr(dx,1,6) =	'M06311'
or substr(dx,1,6) =	'M06312'
or substr(dx,1,6) =	'M06319'
or substr(dx,1,6) =	'M06321'
or substr(dx,1,6) =	'M06322'
or substr(dx,1,6) =	'M06329'
or substr(dx,1,6) =	'M06331'
or substr(dx,1,6) =	'M06332'
or substr(dx,1,6) =	'M06339'
or substr(dx,1,6) =	'M06341'
or substr(dx,1,6) =	'M06342'
or substr(dx,1,6) =	'M06349'
or substr(dx,1,6) =	'M06351'
or substr(dx,1,6) =	'M06352'
or substr(dx,1,6) =	'M06359'
or substr(dx,1,6) =	'M06361'
or substr(dx,1,6) =	'M06362'
or substr(dx,1,6) =	'M06369'
or substr(dx,1,6) =	'M06371'
or substr(dx,1,6) =	'M06372'
or substr(dx,1,6) =	'M06379'
or substr(dx,1,5) =	'M0638'
or substr(dx,1,5) =	'M0639'
or substr(dx,1,5) =	'M0680'
or substr(dx,1,6) =	'M06811'
or substr(dx,1,6) =	'M06812'
or substr(dx,1,6) =	'M06819'
or substr(dx,1,6) =	'M06821'
or substr(dx,1,6) =	'M06822'
or substr(dx,1,6) =	'M06829'
or substr(dx,1,6) =	'M06831'
or substr(dx,1,6) =	'M06832'
or substr(dx,1,6) =	'M06839'
or substr(dx,1,6) =	'M06841'
or substr(dx,1,6) =	'M06842'
or substr(dx,1,6) =	'M06849'
or substr(dx,1,6) =	'M06851'
or substr(dx,1,6) =	'M06852'
or substr(dx,1,6) =	'M06859'
or substr(dx,1,6) =	'M06861'
or substr(dx,1,6) =	'M06862'
or substr(dx,1,6) =	'M06869'
or substr(dx,1,6) =	'M06871'
or substr(dx,1,6) =	'M06872'
or substr(dx,1,6) =	'M06879'
or substr(dx,1,5) =	'M0688'
or substr(dx,1,5) =	'M0689'
or substr(dx,1,4) =	'M069'
or substr(dx,1,5) =	'M0800'
or substr(dx,1,6) =	'M08011'
or substr(dx,1,6) =	'M08012'
or substr(dx,1,6) =	'M08019'
or substr(dx,1,6) =	'M08021'
or substr(dx,1,6) =	'M08022'
or substr(dx,1,6) =	'M08029'
or substr(dx,1,6) =	'M08031'
or substr(dx,1,6) =	'M08032'
or substr(dx,1,6) =	'M08039'
or substr(dx,1,6) =	'M08041'
or substr(dx,1,6) =	'M08042'
or substr(dx,1,6) =	'M08049'
or substr(dx,1,6) =	'M08051'
or substr(dx,1,6) =	'M08052'
or substr(dx,1,6) =	'M08059'
or substr(dx,1,6) =	'M08061'
or substr(dx,1,6) =	'M08062'
or substr(dx,1,6) =	'M08069'
or substr(dx,1,6) =	'M08071'
or substr(dx,1,6) =	'M08072'
or substr(dx,1,6) =	'M08079'
or substr(dx,1,5) =	'M0808'
or substr(dx,1,5) =	'M0809'
or substr(dx,1,4) =	'M081'
or substr(dx,1,5) =	'M0820'
or substr(dx,1,6) =	'M08211'
or substr(dx,1,6) =	'M08212'
or substr(dx,1,6) =	'M08219'
or substr(dx,1,6) =	'M08221'
or substr(dx,1,6) =	'M08222'
or substr(dx,1,6) =	'M08229'
or substr(dx,1,6) =	'M08231'
or substr(dx,1,6) =	'M08232'
or substr(dx,1,6) =	'M08239'
or substr(dx,1,6) =	'M08241'
or substr(dx,1,6) =	'M08242'
or substr(dx,1,6) =	'M08249'
or substr(dx,1,6) =	'M08251'
or substr(dx,1,6) =	'M08252'
or substr(dx,1,6) =	'M08259'
or substr(dx,1,6) =	'M08261'
or substr(dx,1,6) =	'M08262'
or substr(dx,1,6) =	'M08269'
or substr(dx,1,6) =	'M08271'
or substr(dx,1,6) =	'M08272'
or substr(dx,1,6) =	'M08279'
or substr(dx,1,5) =	'M0828'
or substr(dx,1,5) =	'M0829'
or substr(dx,1,4) =	'M083'
or substr(dx,1,5) =	'M0840'
or substr(dx,1,6) =	'M08411'
or substr(dx,1,6) =	'M08412'
or substr(dx,1,6) =	'M08419'
or substr(dx,1,6) =	'M08421'
or substr(dx,1,6) =	'M08422'
or substr(dx,1,6) =	'M08429'
or substr(dx,1,6) =	'M08431'
or substr(dx,1,6) =	'M08432'
or substr(dx,1,6) =	'M08439'
or substr(dx,1,6) =	'M08441'
or substr(dx,1,6) =	'M08442'
or substr(dx,1,6) =	'M08449'
or substr(dx,1,6) =	'M08451'
or substr(dx,1,6) =	'M08452'
or substr(dx,1,6) =	'M08459'
or substr(dx,1,6) =	'M08461'
or substr(dx,1,6) =	'M08462'
or substr(dx,1,6) =	'M08469'
or substr(dx,1,6) =	'M08471'
or substr(dx,1,6) =	'M08472'
or substr(dx,1,6) =	'M08479'
or substr(dx,1,5) =	'M0848'
or substr(dx,1,5) =	'M0880'
or substr(dx,1,6) =	'M08811'
or substr(dx,1,6) =	'M08812'
or substr(dx,1,6) =	'M08819'
or substr(dx,1,6) =	'M08821'
or substr(dx,1,6) =	'M08822'
or substr(dx,1,6) =	'M08829'
or substr(dx,1,6) =	'M08831'
or substr(dx,1,6) =	'M08832'
or substr(dx,1,6) =	'M08839'
or substr(dx,1,6) =	'M08841'
or substr(dx,1,6) =	'M08842'
or substr(dx,1,6) =	'M08849'
or substr(dx,1,6) =	'M08851'
or substr(dx,1,6) =	'M08852'
or substr(dx,1,6) =	'M08859'
or substr(dx,1,6) =	'M08861'
or substr(dx,1,6) =	'M08862'
or substr(dx,1,6) =	'M08869'
or substr(dx,1,6) =	'M08871'
or substr(dx,1,6) =	'M08872'
or substr(dx,1,6) =	'M08879'
or substr(dx,1,5) =	'M0888'
or substr(dx,1,5) =	'M0889'
or substr(dx,1,5) =	'M0890'
or substr(dx,1,6) =	'M08911'
or substr(dx,1,6) =	'M08912'
or substr(dx,1,6) =	'M08919'
or substr(dx,1,6) =	'M08921'
or substr(dx,1,6) =	'M08922'
or substr(dx,1,6) =	'M08929'
or substr(dx,1,6) =	'M08931'
or substr(dx,1,6) =	'M08932'
or substr(dx,1,6) =	'M08939'
or substr(dx,1,6) =	'M08941'
or substr(dx,1,6) =	'M08942'
or substr(dx,1,6) =	'M08949'
or substr(dx,1,6) =	'M08951'
or substr(dx,1,6) =	'M08952'
or substr(dx,1,6) =	'M08959'
or substr(dx,1,6) =	'M08961'
or substr(dx,1,6) =	'M08962'
or substr(dx,1,6) =	'M08969'
or substr(dx,1,6) =	'M08971'
or substr(dx,1,6) =	'M08972'
or substr(dx,1,6) =	'M08979'
or substr(dx,1,5) =	'M0898'
or substr(dx,1,5) =	'M0899'
or substr(dx,1,4) =	'M150'
or substr(dx,1,4) =	'M151'
or substr(dx,1,4) =	'M152'
or substr(dx,1,4) =	'M153'
or substr(dx,1,4) =	'M154'
or substr(dx,1,4) =	'M158'
or substr(dx,1,4) =	'M159'
or substr(dx,1,4) =	'M160'
or substr(dx,1,5) =	'M1610'
or substr(dx,1,5) =	'M1611'
or substr(dx,1,5) =	'M1612'
or substr(dx,1,4) =	'M162'
or substr(dx,1,5) =	'M1630'
or substr(dx,1,5) =	'M1631'
or substr(dx,1,5) =	'M1632'
or substr(dx,1,4) =	'M164'
or substr(dx,1,5) =	'M1650'
or substr(dx,1,5) =	'M1651'
or substr(dx,1,5) =	'M1652'
or substr(dx,1,4) =	'M166'
or substr(dx,1,4) =	'M167'
or substr(dx,1,4) =	'M169'
or substr(dx,1,4) =	'M170'
or substr(dx,1,5) =	'M1710'
or substr(dx,1,5) =	'M1711'
or substr(dx,1,5) =	'M1712'
or substr(dx,1,4) =	'M172'
or substr(dx,1,5) =	'M1730'
or substr(dx,1,5) =	'M1731'
or substr(dx,1,5) =	'M1732'
or substr(dx,1,4) =	'M174'
or substr(dx,1,4) =	'M175'
or substr(dx,1,4) =	'M179'
or substr(dx,1,4) =	'M180'
or substr(dx,1,5) =	'M1810'
or substr(dx,1,5) =	'M1811'
or substr(dx,1,5) =	'M1812'
or substr(dx,1,4) =	'M182'
or substr(dx,1,5) =	'M1830'
or substr(dx,1,5) =	'M1831'
or substr(dx,1,5) =	'M1832'
or substr(dx,1,4) =	'M184'
or substr(dx,1,5) =	'M1850'
or substr(dx,1,5) =	'M1851'
or substr(dx,1,5) =	'M1852'
or substr(dx,1,4) =	'M189'
or substr(dx,1,6) =	'M19011'
or substr(dx,1,6) =	'M19012'
or substr(dx,1,6) =	'M19019'
or substr(dx,1,6) =	'M19021'
or substr(dx,1,6) =	'M19022'
or substr(dx,1,6) =	'M19029'
or substr(dx,1,6) =	'M19031'
or substr(dx,1,6) =	'M19032'
or substr(dx,1,6) =	'M19039'
or substr(dx,1,6) =	'M19041'
or substr(dx,1,6) =	'M19042'
or substr(dx,1,6) =	'M19049'
or substr(dx,1,6) =	'M19071'
or substr(dx,1,6) =	'M19072'
or substr(dx,1,6) =	'M19079'
or substr(dx,1,6) =	'M19111'
or substr(dx,1,6) =	'M19112'
or substr(dx,1,6) =	'M19119'
or substr(dx,1,6) =	'M19121'
or substr(dx,1,6) =	'M19122'
or substr(dx,1,6) =	'M19129'
or substr(dx,1,6) =	'M19131'
or substr(dx,1,6) =	'M19132'
or substr(dx,1,6) =	'M19139'
or substr(dx,1,6) =	'M19141'
or substr(dx,1,6) =	'M19142'
or substr(dx,1,6) =	'M19149'
or substr(dx,1,6) =	'M19171'
or substr(dx,1,6) =	'M19172'
or substr(dx,1,6) =	'M19179'
or substr(dx,1,6) =	'M19211'
or substr(dx,1,6) =	'M19212'
or substr(dx,1,6) =	'M19219'
or substr(dx,1,6) =	'M19221'
or substr(dx,1,6) =	'M19222'
or substr(dx,1,6) =	'M19229'
or substr(dx,1,6) =	'M19231'
or substr(dx,1,6) =	'M19232'
or substr(dx,1,6) =	'M19239'
or substr(dx,1,6) =	'M19241'
or substr(dx,1,6) =	'M19242'
or substr(dx,1,6) =	'M19249'
or substr(dx,1,6) =	'M19271'
or substr(dx,1,6) =	'M19272'
or substr(dx,1,6) =	'M19279'
or substr(dx,1,5) =	'M1990'
or substr(dx,1,5) =	'M1991'
or substr(dx,1,5) =	'M1992'
or substr(dx,1,5) =	'M1993'
or substr(dx,1,4) =	'M450'
or substr(dx,1,4) =	'M451'
or substr(dx,1,4) =	'M452'
or substr(dx,1,4) =	'M453'
or substr(dx,1,4) =	'M454'
or substr(dx,1,4) =	'M455'
or substr(dx,1,4) =	'M456'
or substr(dx,1,4) =	'M457'
or substr(dx,1,4) =	'M458'
or substr(dx,1,4) =	'M459'
or substr(dx,1,6) =	'M47011'
or substr(dx,1,6) =	'M47012'
or substr(dx,1,6) =	'M47013'
or substr(dx,1,6) =	'M47014'
or substr(dx,1,6) =	'M47015'
or substr(dx,1,6) =	'M47016'
or substr(dx,1,6) =	'M47019'
or substr(dx,1,6) =	'M47021'
or substr(dx,1,6) =	'M47022'
or substr(dx,1,6) =	'M47029'
or substr(dx,1,5) =	'M4710'
or substr(dx,1,5) =	'M4711'
or substr(dx,1,5) =	'M4712'
or substr(dx,1,5) =	'M4713'
or substr(dx,1,5) =	'M4720'
or substr(dx,1,5) =	'M4721'
or substr(dx,1,5) =	'M4722'
or substr(dx,1,5) =	'M4723'
or substr(dx,1,5) =	'M4724'
or substr(dx,1,5) =	'M4725'
or substr(dx,1,5) =	'M4726'
or substr(dx,1,5) =	'M4727'
or substr(dx,1,5) =	'M4728'
or substr(dx,1,6) =	'M47811'
or substr(dx,1,6) =	'M47812'
or substr(dx,1,6) =	'M47813'
or substr(dx,1,6) =	'M47814'
or substr(dx,1,6) =	'M47815'
or substr(dx,1,6) =	'M47816'
or substr(dx,1,6) =	'M47817'
or substr(dx,1,6) =	'M47818'
or substr(dx,1,6) =	'M47819'
or substr(dx,1,6) =	'M47891'
or substr(dx,1,6) =	'M47892'
or substr(dx,1,6) =	'M47893'
or substr(dx,1,6) =	'M47894'
or substr(dx,1,6) =	'M47895'
or substr(dx,1,6) =	'M47896'
or substr(dx,1,6) =	'M47897'
or substr(dx,1,6) =	'M47898'
or substr(dx,1,6) =	'M47899'
or substr(dx,1,4) =	'M479'
or substr(dx,1,6) =	'M488X1'
or substr(dx,1,6) =	'M488X2'
or substr(dx,1,6) =	'M488X3'
or substr(dx,1,6) =	'M488X4'
or substr(dx,1,6) =	'M488X5'
or substr(dx,1,6) =	'M488X6'
or substr(dx,1,6) =	'M488X7'
or substr(dx,1,6) =	'M488X8'
or substr(dx,1,6) =	'M488X9')
		and ccw_21=0
                then ccw_21=1;
  * Stroke ;
	if (substr(dx,1,3) =	'430'
or substr(dx,1,3) =	'431'
or substr(dx,1,5) =	'43301'
or substr(dx,1,5) =	'43311'
or substr(dx,1,5) =	'43321'
or substr(dx,1,5) =	'43331'
or substr(dx,1,5) =	'43381'
or substr(dx,1,5) =	'43391'
or substr(dx,1,5) =	'43401'
or substr(dx,1,5) =	'43411'
or substr(dx,1,5) =	'43410'
or substr(dx,1,5) =	'43491'
or substr(dx,1,5) =	'43490'
or substr(dx,1,5) =	'43400'
or substr(dx,1,4) =	'4351'
or substr(dx,1,4) =	'4353'
or substr(dx,1,4) =	'4358'
or substr(dx,1,4) =	'4359'
or substr(dx,1,4) =	'4350'
or substr(dx,1,3) =	'436'
or substr(dx,1,5) =	'99702'
or substr(dx,1,4) =	'G450'
or substr(dx,1,4) =	'G451'
or substr(dx,1,4) =	'G452'
or substr(dx,1,4) =	'G458'
or substr(dx,1,4) =	'G459'
or substr(dx,1,4) =	'G460'
or substr(dx,1,4) =	'G461'
or substr(dx,1,4) =	'G462'
or substr(dx,1,4) =	'G463'
or substr(dx,1,4) =	'G464'
or substr(dx,1,4) =	'G465'
or substr(dx,1,4) =	'G466'
or substr(dx,1,4) =	'G467'
or substr(dx,1,4) =	'G468'
or substr(dx,1,5) =	'G9731'
or substr(dx,1,5) =	'G9732'
or substr(dx,1,5) =	'I6000'
or substr(dx,1,5) =	'I6001'
or substr(dx,1,5) =	'I6002'
or substr(dx,1,5) =	'I6010'
or substr(dx,1,5) =	'I6011'
or substr(dx,1,5) =	'I6012'
or substr(dx,1,5) =	'I6020'
or substr(dx,1,5) =	'I6021'
or substr(dx,1,5) =	'I6022'
or substr(dx,1,5) =	'I6030'
or substr(dx,1,5) =	'I6031'
or substr(dx,1,5) =	'I6032'
or substr(dx,1,4) =	'I604'
or substr(dx,1,5) =	'I6050'
or substr(dx,1,5) =	'I6051'
or substr(dx,1,5) =	'I6052'
or substr(dx,1,4) =	'I606'
or substr(dx,1,4) =	'I607'
or substr(dx,1,4) =	'I608'
or substr(dx,1,4) =	'I609'
or substr(dx,1,4) =	'I610'
or substr(dx,1,4) =	'I611'
or substr(dx,1,4) =	'I612'
or substr(dx,1,4) =	'I613'
or substr(dx,1,4) =	'I614'
or substr(dx,1,4) =	'I615'
or substr(dx,1,4) =	'I616'
or substr(dx,1,4) =	'I618'
or substr(dx,1,4) =	'I619'
or substr(dx,1,5) =	'I6300'
or substr(dx,1,6) =	'I63011'
or substr(dx,1,6) =	'I63012'
or substr(dx,1,6) =	'I63013'
or substr(dx,1,6) =	'I63019'
or substr(dx,1,5) =	'I6302'
or substr(dx,1,5) =	'I6302'
or substr(dx,1,6) =	'I63031'
or substr(dx,1,6) =	'I63032'
or substr(dx,1,6) =	'I63039'
or substr(dx,1,5) =	'I6309'
or substr(dx,1,5) =	'I6310'
or substr(dx,1,6) =	'I63111'
or substr(dx,1,6) =	'I63112'
or substr(dx,1,6) =	'I63119'
or substr(dx,1,5) =	'I6312'
or substr(dx,1,6) =	'I63131'
or substr(dx,1,6) =	'I63132'
or substr(dx,1,6) =	'I63139'
or substr(dx,1,5) =	'I6319'
or substr(dx,1,5) =	'I6320'
or substr(dx,1,6) =	'I63211'
or substr(dx,1,6) =	'I63212'
or substr(dx,1,6) =	'I63213'
or substr(dx,1,6) =	'I63219'
or substr(dx,1,5) =	'I6322'
or substr(dx,1,6) =	'I63231'
or substr(dx,1,6) =	'I63232'
or substr(dx,1,6) =	'I63233'
or substr(dx,1,6) =	'I63239'
or substr(dx,1,5) =	'I6329'
or substr(dx,1,5) =	'I6330'
or substr(dx,1,6) =	'I63311'
or substr(dx,1,6) =	'I63312'
or substr(dx,1,6) =	'I63313'
or substr(dx,1,6) =	'I63319'
or substr(dx,1,6) =	'I63321'
or substr(dx,1,6) =	'I63322'
or substr(dx,1,6) =	'I63323'
or substr(dx,1,6) =	'I63329'
or substr(dx,1,6) =	'I63331'
or substr(dx,1,6) =	'I63332'
or substr(dx,1,6) =	'I63333'
or substr(dx,1,6) =	'I63339'
or substr(dx,1,6) =	'I63341'
or substr(dx,1,6) =	'I63342'
or substr(dx,1,6) =	'I63343'
or substr(dx,1,6) =	'I63349'
or substr(dx,1,5) =	'I6339'
or substr(dx,1,5) =	'I6340'
or substr(dx,1,6) =	'I63411'
or substr(dx,1,6) =	'I63412'
or substr(dx,1,6) =	'I63413'
or substr(dx,1,6) =	'I63419'
or substr(dx,1,6) =	'I63421'
or substr(dx,1,6) =	'I63422'
or substr(dx,1,6) =	'I63423'
or substr(dx,1,6) =	'I63429'
or substr(dx,1,6) =	'I63431'
or substr(dx,1,6) =	'I63432'
or substr(dx,1,6) =	'I63433'
or substr(dx,1,6) =	'I63439'
or substr(dx,1,6) =	'I63441'
or substr(dx,1,6) =	'I63442'
or substr(dx,1,6) =	'I63443'
or substr(dx,1,6) =	'I63449'
or substr(dx,1,5) =	'I6349'
or substr(dx,1,5) =	'I6350'
or substr(dx,1,6) =	'I63511'
or substr(dx,1,6) =	'I63512'
or substr(dx,1,6) =	'I63513'
or substr(dx,1,6) =	'I63519'
or substr(dx,1,6) =	'I63521'
or substr(dx,1,6) =	'I63522'
or substr(dx,1,6) =	'I63523'
or substr(dx,1,6) =	'I63529'
or substr(dx,1,6) =	'I63531'
or substr(dx,1,6) =	'I63532'
or substr(dx,1,6) =	'I63533'
or substr(dx,1,6) =	'I63539'
or substr(dx,1,6) =	'I63541'
or substr(dx,1,6) =	'I63542'
or substr(dx,1,6) =	'I63543'
or substr(dx,1,6) =	'I63549'
or substr(dx,1,5) =	'I6359'
or substr(dx,1,4) =	'I636'
or substr(dx,1,4) =	'I638'
or substr(dx,1,4) =	'I639'
or substr(dx,1,5) =	'I6601'
or substr(dx,1,5) =	'I6602'
or substr(dx,1,5) =	'I6603'
or substr(dx,1,5) =	'I6609'
or substr(dx,1,5) =	'I6611'
or substr(dx,1,5) =	'I6612'
or substr(dx,1,5) =	'I6613'
or substr(dx,1,5) =	'I6619'
or substr(dx,1,5) =	'I6621'
or substr(dx,1,5) =	'I6622'
or substr(dx,1,5) =	'I6623'
or substr(dx,1,5) =	'I6629'
or substr(dx,1,4) =	'I663'
or substr(dx,1,4) =	'I668'
or substr(dx,1,4) =	'I669'
or substr(dx,1,6) =	'I67841'
or substr(dx,1,6) =	'I67848'
or substr(dx,1,5) =	'I6789'
or substr(dx,1,6) =	'I97810'
or substr(dx,1,6) =	'I97811'
or substr(dx,1,6) =	'I97820'
or substr(dx,1,6) =	'I97821')
		and ccw_22=0
                then ccw_22=1;
  * Colorectal Cancer ;
	if (substr(dx,1,4) =	'1531'
or substr(dx,1,4) =	'1532'
or substr(dx,1,4) =	'1533'
or substr(dx,1,4) =	'1534'
or substr(dx,1,4) =	'1535'
or substr(dx,1,4) =	'1536'
or substr(dx,1,4) =	'1537'
or substr(dx,1,4) =	'1538'
or substr(dx,1,4) =	'1539'
or substr(dx,1,4) = '1540'
or substr(dx,1,4) = '1541'
or substr(dx,1,4) =	'1530'
or substr(dx,1,4) =	'2303'
or substr(dx,1,4) =	'2304'
or substr(dx,1,5) =	'V1005'
or substr(dx,1,5) =	'V1006'
or substr(dx,1,4) =	'C180'
or substr(dx,1,4) =	'C181'
or substr(dx,1,4) =	'C182'
or substr(dx,1,4) =	'C183'
or substr(dx,1,4) =	'C184'
or substr(dx,1,4) =	'C185'
or substr(dx,1,4) =	'C186'
or substr(dx,1,4) =	'C187'
or substr(dx,1,4) =	'C188'
or substr(dx,1,4) =	'C189'
or substr(dx,1,3) =	'C19'
or substr(dx,1,3) =	'C20'
or substr(dx,1,4) =	'D010'
or substr(dx,1,4) =	'D011'
or substr(dx,1,4) =	'D012'
or substr(dx,1,6) =	'Z85038'
or substr(dx,1,6) =	'Z85040'
or substr(dx,1,6) =	'Z85048')
		and ccw_23=0
                then ccw_23=1;
  * Endometrial Cancer ;
	if (substr(dx,1,4) =	'1820'
or substr(dx,1,4) =	'2332'
or substr(dx,1,5) =	'V1042'
or substr(dx,1,4) =	'C541'
or substr(dx,1,4) =	'C542'
or substr(dx,1,4) =	'C543'
or substr(dx,1,4) =	'C548'
or substr(dx,1,4) =	'C549'
or substr(dx,1,4) =	'D070'
or substr(dx,1,5) =	'Z8542')
		and ccw_24=0
                then ccw_24=1;
  * Breast Cancer ;
if (substr(dx,1,4) = '1741'
or substr(dx,1,4) =	'1742'
or substr(dx,1,4) =	'1743'
or substr(dx,1,4) =	'1744'
or substr(dx,1,4) =	'1745'
or substr(dx,1,4) =	'1746'
or substr(dx,1,4) =	'1748'
or substr(dx,1,4) =	'1749'
or substr(dx,1,4) =	'1740'
or substr(dx,1,4) =	'1759'
or substr(dx,1,4) =	'1750'
or substr(dx,1,4) =	'2330'
or substr(dx,1,4) =	'V103'
or substr(dx,1,6) =	'C50011'
or substr(dx,1,6) =	'C50012'
or substr(dx,1,6) =	'C50019'
or substr(dx,1,6) =	'C50021'
or substr(dx,1,6) =	'C50022'
or substr(dx,1,6) =	'C50029'
or substr(dx,1,6) =	'C50111'
or substr(dx,1,6) =	'C50112'
or substr(dx,1,6) =	'C50119'
or substr(dx,1,6) =	'C50121'
or substr(dx,1,6) =	'C50122'
or substr(dx,1,6) =	'C50129'
or substr(dx,1,6) =	'C50211'
or substr(dx,1,6) =	'C50212'
or substr(dx,1,6) =	'C50219'
or substr(dx,1,6) =	'C50221'
or substr(dx,1,6) =	'C50222'
or substr(dx,1,6) =	'C50229'
or substr(dx,1,6) =	'C50311'
or substr(dx,1,6) =	'C50312'
or substr(dx,1,6) =	'C50319'
or substr(dx,1,6) =	'C50321'
or substr(dx,1,6) =	'C50322'
or substr(dx,1,6) =	'C50329'
or substr(dx,1,6) =	'C50411'
or substr(dx,1,6) =	'C50412'
or substr(dx,1,6) =	'C50419'
or substr(dx,1,6) =	'C50421'
or substr(dx,1,6) =	'C50422'
or substr(dx,1,6) =	'C50429'
or substr(dx,1,6) =	'C50511'
or substr(dx,1,6) =	'C50512'
or substr(dx,1,6) =	'C50519'
or substr(dx,1,6) =	'C50521'
or substr(dx,1,6) =	'C50522'
or substr(dx,1,6) =	'C50529'
or substr(dx,1,6) =	'C50611'
or substr(dx,1,6) =	'C50612'
or substr(dx,1,6) =	'C50619'
or substr(dx,1,6) =	'C50621'
or substr(dx,1,6) =	'C50622'
or substr(dx,1,6) =	'C50629'
or substr(dx,1,6) =	'C50811'
or substr(dx,1,6) =	'C50812'
or substr(dx,1,6) =	'C50819'
or substr(dx,1,6) =	'C50821'
or substr(dx,1,6) =	'C50822'
or substr(dx,1,6) =	'C50829'
or substr(dx,1,6) =	'C50911'
or substr(dx,1,6) =	'C50912'
or substr(dx,1,6) =	'C50919'
or substr(dx,1,6) =	'C50921'
or substr(dx,1,6) =	'C50922'
or substr(dx,1,6) =	'C50929'
or substr(dx,1,5) =	'D0500'
or substr(dx,1,5) =	'D0501'
or substr(dx,1,5) =	'D0502'
or substr(dx,1,5) =	'D0510'
or substr(dx,1,5) =	'D0511'
or substr(dx,1,5) =	'D0512'
or substr(dx,1,5) =	'D0580'
or substr(dx,1,5) =	'D0581'
or substr(dx,1,5) =	'D0582'
or substr(dx,1,5) =	'D0590'
or substr(dx,1,5) =	'D0591'
or substr(dx,1,5) =	'D0592'
or substr(dx,1,4) =	'Z853' )
		and ccw_25=0
                then ccw_25=1;
  * Lung Cancer ;
	if (substr(dx,1,4) =	'1622'
or substr(dx,1,4) =	'1623'
or substr(dx,1,4) =	'1624'
or substr(dx,1,4) =	'1625'
or substr(dx,1,4) =	'1628'
or substr(dx,1,4) =	'1629'
or substr(dx,1,4) =	'2312'
or substr(dx,1,5) =	'V1011'
or substr(dx,1,5) =	'C3400'
or substr(dx,1,5) =	'C3401'
or substr(dx,1,5) =	'C3402'
or substr(dx,1,5) =	'C3410'
or substr(dx,1,5) =	'C3411'
or substr(dx,1,5) =	'C3412'
or substr(dx,1,4) =	'C342'
or substr(dx,1,5) =	'C3430'
or substr(dx,1,5) =	'C3431'
or substr(dx,1,5) =	'C3432'
or substr(dx,1,5) =	'C3480'
or substr(dx,1,5) =	'C3481'
or substr(dx,1,5) =	'C3482'
or substr(dx,1,5) =	'C3490'
or substr(dx,1,5) =	'C3491'
or substr(dx,1,5) =	'C3492'
or substr(dx,1,5) =	'D0220'
or substr(dx,1,5) =	'D0221'
or substr(dx,1,5) =	'D0222'
or substr(dx,1,6) =	'Z85110'
or substr(dx,1,6) =	'Z85118')
		and ccw_26=0
                then ccw_26=1;
  * Prostate Cancer ;
	if (substr(dx,1,3) =	'185'
or substr(dx,1,4) =	'2334'
or substr(dx,1,5) =	'V1046'
or substr(dx,1,3) =	'C61'
or substr(dx,1,4) =	'D075'
or substr(dx,1,5) =	'Z8546')
		and ccw_27=0
                then ccw_27=1;
end;

run;

/*get count of each comorbidity for each id-core year combination*/
proc sql;
create table cnt_test1 as
select distinct bid_hrs_22,index_date,
sum(ccw_1) as cnt_1,
sum(ccw_2) as cnt_2,
sum(ccw_3) as cnt_3,
sum(ccw_4) as cnt_4,
sum(ccw_5) as cnt_5,
sum(ccw_6) as cnt_6,
sum(ccw_7) as cnt_7,
sum(ccw_8) as cnt_8,
sum(ccw_9) as cnt_9,
sum(ccw_10) as cnt_10,
sum(ccw_11) as cnt_11,
sum(ccw_12) as cnt_12,
sum(ccw_13) as cnt_13,
sum(ccw_14) as cnt_14,
sum(ccw_15) as cnt_15,
sum(ccw_16) as cnt_16,
sum(ccw_17) as cnt_17,
sum(ccw_18) as cnt_18,
sum(ccw_19) as cnt_19,
sum(ccw_20) as cnt_20,
sum(ccw_21) as cnt_21,
sum(ccw_22) as cnt_22,
sum(ccw_23) as cnt_23,
sum(ccw_24) as cnt_24,
sum(ccw_25) as cnt_25,
sum(ccw_26) as cnt_26,
sum(ccw_27) as cnt_27
from dx_ccw
group by bid_hrs_22,index_date;
quit;

/*convert counts of diagnoses for each comorbidity to indicator variables*/ 
data ccw_1(keep=bid_hrs_22 index_date ccw_1-ccw_27 ccw_index);
set cnt_test1;
array list_cha cnt_1-cnt_27;
array list_cnt_bin ccw_1-ccw_27 ;

do over list_cha;
  list_cnt_bin=0;

  if list_cha>0 then do;
    list_cnt_bin=1;
   end;

end;
/*note this ccw_index count count is not weighted for morbidity*/
ccw_index=ccw_1+ccw_2+ccw_3+ccw_4+ccw_5+ccw_6+ccw_7+ccw_8+ccw_9+ccw_10
+ccw_11+ccw_12+ccw_13+ccw_14+ccw_15+ccw_16+ccw_17+ccw_18+ccw_19+ccw_20
+ccw_21+ccw_22+ccw_23+ccw_24+ccw_25+ccw_26+ccw_27;

label ccw_1 ='Acquired Hypothyroidism, CCW';
label ccw_2 ='AMI, CCW';
label ccw_3 ="Alzheimer's";
label ccw_4 ="Alzheimer's & Related/Dementia";
label ccw_5 ='Anemia';
label ccw_6 ='Asthma';
label ccw_7 ='Atrial Fibrillation';
label ccw_8 ='Benign Prostatic Hyperplasia';
label ccw_9 ='Cataract';
label ccw_10 ='CKD';
label ccw_11 ='COPD/Bronchiectasis';
label ccw_12 ='Depression';
label ccw_13 ='Diabetes';
label ccw_14 ='Glaucoma';
label ccw_15 ='Heart Failure';
label ccw_16 ='Hip/Pelvic Fracture';
label ccw_17 ='Hyperlipidemia';
label ccw_18 ='Hypertension';
label ccw_19 ='Ischemic Heart Disease';
label ccw_20 ='Osteoporosis';
label ccw_21 ='RA/OA';
label ccw_22 ='Stroke/Transient Ischemic Attack';
label ccw_23 ='Colorectal Cancer';
label ccw_24 ='Endometrial Cancer';
label ccw_25 ='Breast Cancer';
label ccw_26 ='Lung Cancer';
label ccw_27 ='Prostate Cancer';
label ccw_index ='Count of CCs (out of 27)';

run;

/*merge into list of obs with ffs mc 6m prior to ivw*/
proc sort data=ccw_1 out=test nodupkey;
by bid_hrs_22 index_date;
run;



%rename(WORK,TEST,&range1._&range2);

data ccw_&range1._&range2.(rename =(bid_hrs_22_&range1._&range2=bid_hrs_22
index_date_&range1._&range2=index_date));
set test;
keep bid_hrs_22_&range1._&range2 ccw: index_date:;
run;
proc sort data=ccw_&range1._&range2.;
by bid_hrs_22 index_date;
run;

%mend;








%ccw(range1=0m, range2=12m);
%ccw(range1=12m, range2=24m);
%ccw(range1=24m, range2=36m);
%ccw(range1=36m, range2=48m);
%ccw(range1=48m, range2=60m);
%ccw(range1=60m, range2=72m);
%ccw(range1=72m, range2=84m);



proc sql; 
create table proj_int.ccw as select * from
proj_int.index a
left join 
ccw_0m_12m b
on a.bid_hrs_22=b.bid_hrs_22 and a.index_date=b.index_date
left join 
ccw_12m_24m c
on a.bid_hrs_22=c.bid_hrs_22 and a.index_date=c.index_date
left join 
ccw_24m_36m d
on a.bid_hrs_22=d.bid_hrs_22 and a.index_date=d.index_date
left join 
ccw_36m_48m e
on a.bid_hrs_22=e.bid_hrs_22 and a.index_date=e.index_date
left join 
ccw_48m_60m f
on a.bid_hrs_22=f.bid_hrs_22 and a.index_date=f.index_date
left join 
ccw_60m_72m g
on a.bid_hrs_22=g.bid_hrs_22 and a.index_date=g.index_date
left join 
ccw_72m_84m h
on a.bid_hrs_22=h.bid_hrs_22 and a.index_date=h.index_date;
quit;


H="MC Spending"

%macro mp_index_dt(source=);
*get claims that overlap with date of death;

data &source._meet_admit;
set proj_int.&source._meet_84m;
if index_date=admit_date and admit_date~=disch_date;
admit_on_index_date=1;
run;


data &source._meet_both;
set proj_int.&source._meet_84m;
if index_date=disch_date and admit_date=disch_date;
admit_on_index_date=1;
disch_on_index_date=1;
run;




data &source._cost;
set &source._meet_admit &source._meet_both;
array list pmt_amt passthru;
do over list;
if list=. then list=0;
end;

if year(admit_date)=2016 then rate=1;
if year(admit_date)=2015 then rate=1.01262;
if year(admit_date)=2014 then rate=1.01382;
if year(admit_date)=2013 then rate=1.03026;
if year(admit_date)=2012 then rate=1.04535;
if year(admit_date)=2011 then rate=1.06699;
if year(admit_date)=2010 then rate=1.10067;
if year(admit_date)=2009 then rate=1.11872;
if year(admit_date)=2008 then rate=1.11474;
if year(admit_date)=2007 then rate=1.15754;
if year(admit_date)=2006 then rate=1.19051;
if year(admit_date)=2005 then rate=1.22891;
if year(admit_date)=2004 then rate=1.27055;
if year(admit_date)=2003 then rate=1.30439;
if year(admit_date)=2002 then rate=1.33411;
if year(admit_date)=2001 then rate=1.35521;
if year(admit_date)=2000 then rate=1.39377;
if year(admit_date)=1999 then rate=1.44062;
if year(admit_date)=1998 then rate=1.47244;


&source._paid_by_mc=rate*(pmt_amt+passthru);
&source._paid_by_mc_index_dt=(1/(disch_date-admit_date+1))*&source._paid_by_mc;
run;

proc sql;
create table &source._pay as select distinct bid_hrs_22,index_date,
sum(&source._paid_by_mc_index_dt) as &source._paid_by_mc_index_dt,
sum(admit_on_index_date) as &source._admit_dod, sum(disch_on_index_date) as &source._disch_dod
from &source._cost group by bid_hrs_22,index_date;
quit;


proc sort data=&source._pay;
by bid_hrs_22 index_date;
run;

%mend;
%mp_index_dt(source=ip);
%mp_index_dt(source=snf);


%macro claims_index_dt(source=);
*get claims that start with date of death;

data &source._meet_admit;
set proj_int.&source._meet_84m;
if index_date=admit_date; 
run;



data &source._cost;
set &source._meet_admit;
array list pmt_amt passthru;
do over list;
if list=. then list=0;
end;


if year(admit_date)=2016 then rate=1;
if year(admit_date)=2015 then rate=1.01262;
if year(admit_date)=2014 then rate=1.01382;
if year(admit_date)=2013 then rate=1.03026;
if year(admit_date)=2012 then rate=1.04535;
if year(admit_date)=2011 then rate=1.06699;
if year(admit_date)=2010 then rate=1.10067;
if year(admit_date)=2009 then rate=1.11872;
if year(admit_date)=2008 then rate=1.11474;
if year(admit_date)=2007 then rate=1.15754;
if year(admit_date)=2006 then rate=1.19051;
if year(admit_date)=2005 then rate=1.22891;
if year(admit_date)=2004 then rate=1.27055;
if year(admit_date)=2003 then rate=1.30439;
if year(admit_date)=2002 then rate=1.33411;
if year(admit_date)=2001 then rate=1.35521;
if year(admit_date)=2000 then rate=1.39377;
if year(admit_date)=1999 then rate=1.44062;
if year(admit_date)=1998 then rate=1.47244;



&source._paid_by_mc_index_dt=rate*(pmt_amt);
run;

proc sql;
create table &source._pay as select distinct bid_hrs_22,index_date,
sum(&source._paid_by_mc_index_dt) as &source._paid_by_mc_index_dt
from &source._cost group by bid_hrs_22,index_date;
quit;

proc sort data=&source._pay;
by bid_hrs_22 index_date;
run;

%mend;

%claims_index_dt(source=op);
%claims_index_dt(source=pb);
%claims_index_dt(source=hh);
%claims_index_dt(source=hs);
%claims_index_dt(source=dm);


data mc_costs_doda;
merge ip_pay snf_pay op_pay pb_pay hh_pay hs_pay dm_pay ;
bid_hrs_22=bid_hrs_22;
by bid_hrs_22 index_date;
run;


data mc_costs_dod;
set mc_costs_doda;
tot_paid_by_mc_index_dt=ip_paid_by_mc_index_dt+snf_paid_by_mc_index_dt+op_paid_by_mc_index_dt +
pb_paid_by_mc_index_dt+hs_paid_by_mc_index_dt+dm_paid_by_mc_index_dt;
run;


%macro mp_claims(days_start=,days_bef_index=,source=,name=);

*first get claims lists for the specific claims type, snf or ip;
data &source._meet;
set proj_int.&source._meet_84m;
win_start_dt=index_date-&days_bef_index;
win_stop_dt=index_date-&days_start;
format admit_date disch_date win_start_dt win_stop_dt date9.;
run;

/*identify claims where entire claim is within the x months prior to death*/
data &source._meet_1;
set &source._meet;
if win_start_dt<=admit_date<win_stop_dt and
	win_start_dt<=disch_date<win_stop_dt;
run;

/*identify claims where start before window but end during window*/
data &source._meet_2;
set &source._meet;
if win_start_dt>admit_date and
	win_start_dt<=disch_date<win_stop_dt;
run;

/*identify fraction of claims to be attributed to period before death
by just using the fraction of time that was included in the time window*/
data &source._meet_3;
set &source._meet_2;
pct_xm=(disch_date-win_start_dt)/(disch_date-admit_date+1);
array list pmt_amt passthru;
do over list;
if list=. then list=0;
/*scale the partial claims by the time within the x month period*/
list=list*pct_xm;
end;

run;

/*claims where start within window but end after R's death*/
data &source._meet_4;
set &source._meet;
if win_start_dt<=admit_date<win_stop_dt and
	disch_date>=win_stop_dt;
run;

/*again fraction to attribute to window*/
data &source._meet_5;
set &source._meet_4;
pct_xm=(win_stop_dt-admit_date+1)/(disch_date-admit_date+1);
array list pmt_amt passthru;
do over list;
if list=. then list=0;
/*scale the partial claims by the time within the x month period*/
list=list*pct_xm;
end;
run;

/*claims where start before and end after window*/
data &source._meet_6;
set &source._meet;
if win_start_dt>admit_date and
	disch_date>=win_stop_dt;
run;

/*again fraction to attribute to window*/
data &source._meet_7;
set &source._meet_6;
pct_xm=(win_stop_dt-win_start_dt)/(disch_date-admit_date+1);
array list pmt_amt passthru;
do over list;
if list=. then list=0;
/*scale the partial claims by the time within the x month period*/
list=list*pct_xm;
end;
run;

/*merge claims into single dataset, adjust for inflation
xxxxxUses CPI for Medical Services from BLS website, accessed 5/4/2015
Uses CPI from BLS website, accessed 11/28/2018*/
data &source._cost;
set &source._meet_1 &source._meet_3 &source._meet_5 &source._meet_7;
array list pmt_amt passthru;
do over list;
if list=. then list=0;
end;


if year(admit_date)=2016 then rate=1;
if year(admit_date)=2015 then rate=1.01262;
if year(admit_date)=2014 then rate=1.01382;
if year(admit_date)=2013 then rate=1.03026;
if year(admit_date)=2012 then rate=1.04535;
if year(admit_date)=2011 then rate=1.06699;
if year(admit_date)=2010 then rate=1.10067;
if year(admit_date)=2009 then rate=1.11872;
if year(admit_date)=2008 then rate=1.11474;
if year(admit_date)=2007 then rate=1.15754;
if year(admit_date)=2006 then rate=1.19051;
if year(admit_date)=2005 then rate=1.22891;
if year(admit_date)=2004 then rate=1.27055;
if year(admit_date)=2003 then rate=1.30439;
if year(admit_date)=2002 then rate=1.33411;
if year(admit_date)=2001 then rate=1.35521;
if year(admit_date)=2000 then rate=1.39377;
if year(admit_date)=1999 then rate=1.44062;
if year(admit_date)=1998 then rate=1.47244;

&source._paid_by_mc=rate*(pmt_amt+passthru);
run;

*calculates total of mc charges for the claim type by hrs bid;
proc sql;
create table &source._pay as select distinct bid_hrs_22,index_date,
sum(&source._paid_by_mc) as &source._paid_by_mc 
from &source._cost group by bid_hrs_22,index_date;
quit;

/*merge into a full bid list of those s's with ffs mc 6m or more*/
proc sql;
create table &source._&name. as select 
a.bid_hrs_22,a.index_date,coalesce(b.&source._paid_by_mc,0) as &source._paid_by_mc_&name.
from proj_int.index a
left join
 &source._pay b
 on trim(left(a.bid_hrs_22))=trim(left(b.bid_hrs_22)) and a.index_date=b.index_date;
 quit;

proc sort data=&source._&name.; by bid_hrs_22 index_date; run;

%mend;



%macro claims(days_start=,days_bef_index=,source=,name=);

*first get claims lists for the specific claims type, not snf or ip;
data &source._meet;
set proj_int.&source._meet_84m;
win_start_dt=index_date-&days_bef_index;
win_stop_dt=index_date-&days_start;
format admit_date disch_date win_start_dt win_stop_dt date9.;
run;

/*identify claims where start of claim is within the x months prior to death*/
data proj_int.&source._meet&name.;
set &source._meet;
if win_start_dt<=admit_date<win_stop_dt;
run;


/*adjust for inflation
xxxxxUses CPI for Medical Services from BLS website, accessed 5/4/2015
Uses CPI from BLS website, accessed 11/28/2018*/
data &source._cost;
set proj_int.&source._meet&name.;
array list pmt_amt passthru;
do over list;
if list=. then list=0;
end;

if year(admit_date)=2016 then rate=1;
if year(admit_date)=2015 then rate=1.01262;
if year(admit_date)=2014 then rate=1.01382;
if year(admit_date)=2013 then rate=1.03026;
if year(admit_date)=2012 then rate=1.04535;
if year(admit_date)=2011 then rate=1.06699;
if year(admit_date)=2010 then rate=1.10067;
if year(admit_date)=2009 then rate=1.11872;
if year(admit_date)=2008 then rate=1.11474;
if year(admit_date)=2007 then rate=1.15754;
if year(admit_date)=2006 then rate=1.19051;
if year(admit_date)=2005 then rate=1.22891;
if year(admit_date)=2004 then rate=1.27055;
if year(admit_date)=2003 then rate=1.30439;
if year(admit_date)=2002 then rate=1.33411;
if year(admit_date)=2001 then rate=1.35521;
if year(admit_date)=2000 then rate=1.39377;
if year(admit_date)=1999 then rate=1.44062;
if year(admit_date)=1998 then rate=1.47244;



&source._paid_by_mc=rate*(pmt_amt);
run;

*calculates total of mc charges for the claim type by hrs bid;
proc sql;
create table &source._pay as select distinct bid_hrs_22,index_date,
sum(&source._paid_by_mc) as &source._paid_by_mc 
from &source._cost group by bid_hrs_22,index_date;
quit;

/*merge into a full bid list of those s's with ffs at death*/
proc sql;
create table &source._&name. as select 
a.bid_hrs_22,a.index_date,coalesce(b.&source._paid_by_mc,0) as &source._paid_by_mc_&name.
from proj_int.index a
left join
 &source._pay b
 on trim(left(a.bid_hrs_22))=trim(left(b.bid_hrs_22)) and a.index_date=b.index_date;
 quit;

proc sort data=&source._&name.; by bid_hrs_22 index_date; run;

%mend;




/****************************************************************/
/*all claims, time periods after R's death********************/
/****************************************************************/
%macro mp_claims_p(days_start=,days_aft_index=,source=,name=);

*first get claims lists for the specific claims type, snf or ip;
data &source._meet;
set proj_int.&source._meet_p84m;
win_end_dt=index_date+&days_aft_index;
win_start_dt=index_date+&days_start;
format admit_date disch_date win_end_dt win_start_dt date9.;
run;

/*identify claims where entire claim is within the x months after death*/
data &source._meet_1;
set &source._meet;
if win_start_dt<admit_date<=win_end_dt and
	win_start_dt<disch_date<=win_end_dt;
run;

/*identify claims where start before window but end during window*/
data &source._meet_2;
set &source._meet;
if win_start_dt>=admit_date and
	win_start_dt<disch_date<=win_end_dt;
run;

/*identify fraction of claims to be attributed to period after death
by just using the fraction of time that was included in the time window*/
data &source._meet_3;
set &source._meet_2;
pct_xm=(disch_date-win_start_dt)/(disch_date-admit_date+1);
array list pmt_amt passthru;
do over list;
if list=. then list=0;
/*scale the partial claims by the time within the x month period*/
list=list*pct_xm;
end;
run;

/*claims where start within window but end after window*/
data &source._meet_4;
set &source._meet;
if win_start_dt<admit_date<=win_end_dt and
	disch_date>win_end_dt ;
run;

/*again fraction to attribute to window*/
data &source._meet_5;
set &source._meet_4;
pct_xm=(win_end_dt-admit_date+1)/(disch_date-admit_date+1);
array list pmt_amt passthru;
do over list;
if list=. then list=0;
/*scale the partial claims by the time within the x month period*/
list=list*pct_xm;
end;
run;

/*claims where start before window but end after window*/
data &source._meet_6;
set &source._meet;
if win_start_dt>=admit_date and
	disch_date>win_end_dt ;
run;

/*again fraction to attribute to window*/
data &source._meet_7;
set &source._meet_6;
pct_xm=(win_end_dt -win_start_dt)/(disch_date-admit_date+1);
array list pmt_amt passthru;
do over list;
if list=. then list=0;
/*scale the partial claims by the time within the x month period*/
list=list*pct_xm;
end;
run;
/*merge claims into single dataset, adjust for inflation*/
data &source._cost;
set &source._meet_1 &source._meet_3 &source._meet_5 &source._meet_7;
array list pmt_amt passthru;
do over list;
if list=. then list=0;
end;

if year(admit_date)=2016 then rate=1;
if year(admit_date)=2015 then rate=1.01262;
if year(admit_date)=2014 then rate=1.01382;
if year(admit_date)=2013 then rate=1.03026;
if year(admit_date)=2012 then rate=1.04535;
if year(admit_date)=2011 then rate=1.06699;
if year(admit_date)=2010 then rate=1.10067;
if year(admit_date)=2009 then rate=1.11872;
if year(admit_date)=2008 then rate=1.11474;
if year(admit_date)=2007 then rate=1.15754;
if year(admit_date)=2006 then rate=1.19051;
if year(admit_date)=2005 then rate=1.22891;
if year(admit_date)=2004 then rate=1.27055;
if year(admit_date)=2003 then rate=1.30439;
if year(admit_date)=2002 then rate=1.33411;
if year(admit_date)=2001 then rate=1.35521;
if year(admit_date)=2000 then rate=1.39377;
if year(admit_date)=1999 then rate=1.44062;
if year(admit_date)=1998 then rate=1.47244;

&source._paid_by_mc=rate*(pmt_amt+passthru);
run;

*calculates total of mc charges for the claim type by hrs bid;
proc sql;
create table &source._pay as select distinct bid_hrs_22,index_date,
sum(&source._paid_by_mc) as &source._paid_by_mc 
from &source._cost group by bid_hrs_22,index_date;
quit;

/*merge into a full bid list of those s's with ffs mc at death*/
proc sql;
create table &source._&name. as select 
a.bid_hrs_22,a.index_date,coalesce(b.&source._paid_by_mc,0) as &source._paid_by_mc_&name.
from proj_int.index a
left join
 &source._pay b
 on trim(left(a.bid_hrs_22))=trim(left(b.bid_hrs_22)) and a.index_date=b.index_date;
 quit;

proc sort data=&source._&name.; by bid_hrs_22 index_date; run;

%mend;




/****************************************************************/
/*all claims, time periods after R's death********************/
/****************************************************************/
%macro claims_p(days_start=,days_aft_index=,source=,name=);

*first get claims lists for the specific claims type, snf or ip;
data &source._meet;
set proj_int.&source._meet_p84m;
win_end_dt=index_date+&days_aft_index;
win_start_dt=index_date+&days_start;
format admit_date disch_date win_end_dt win_start_dt date9.;
run;

/*identify claims where entire claim is within the x months after death*/
data proj_int.&source._meet&name.;
set &source._meet;
if win_start_dt<admit_date<=win_end_dt;
run;


/*adjust for inflation*/
data &source._cost;
set proj_int.&source._meet&name.;
array list pmt_amt;
do over list;
if list=. then list=0;
end;

if year(admit_date)=2016 then rate=1;
if year(admit_date)=2015 then rate=1.01262;
if year(admit_date)=2014 then rate=1.01382;
if year(admit_date)=2013 then rate=1.03026;
if year(admit_date)=2012 then rate=1.04535;
if year(admit_date)=2011 then rate=1.06699;
if year(admit_date)=2010 then rate=1.10067;
if year(admit_date)=2009 then rate=1.11872;
if year(admit_date)=2008 then rate=1.11474;
if year(admit_date)=2007 then rate=1.15754;
if year(admit_date)=2006 then rate=1.19051;
if year(admit_date)=2005 then rate=1.22891;
if year(admit_date)=2004 then rate=1.27055;
if year(admit_date)=2003 then rate=1.30439;
if year(admit_date)=2002 then rate=1.33411;
if year(admit_date)=2001 then rate=1.35521;
if year(admit_date)=2000 then rate=1.39377;
if year(admit_date)=1999 then rate=1.44062;
if year(admit_date)=1998 then rate=1.47244;

&source._paid_by_mc=rate*(pmt_amt);
run;

*calculates total of mc charges for the claim type by hrs bid;
proc sql;
create table &source._pay as select distinct bid_hrs_22,index_date,
sum(&source._paid_by_mc) as &source._paid_by_mc 
from &source._cost group by bid_hrs_22,index_date;
quit;

/*merge into a full bid list of those s's with ffs mc at death*/
proc sql;
create table &source._&name. as select 
a.bid_hrs_22,a.index_date,coalesce(b.&source._paid_by_mc,0) as &source._paid_by_mc_&name.
from proj_int.index a
left join
 &source._pay b
 on trim(left(a.bid_hrs_22))=trim(left(b.bid_hrs_22)) and a.index_date=b.index_date;
 quit;

proc sort data=&source._&name.; by bid_hrs_22 index_date; run;

%mend;

%macro days_nesting();

%do i=1 %to 7 ;


%mp_claims(days_start=floor((&i.-1)*365),days_bef_index=floor(&i.*365), source=snf,  name=%eval(12*&i.)m);
%mp_claims(days_start=floor((&i.-1)*365),days_bef_index=floor(&i.*365), source=ip,  name=%eval(12*&i.)m);
%claims(days_start=floor((&i.-1)*365),days_bef_index=floor(&i.*365), source=pb,  name=%eval(12*&i.)m);
%claims(days_start=floor((&i.-1)*365),days_bef_index=floor(&i.*365), source=op,  name=%eval(12*&i.)m);
%claims(days_start=floor((&i.-1)*365),days_bef_index=floor(&i.*365), source=hh,  name=%eval(12*&i.)m);
%claims(days_start=floor((&i.-1)*365),days_bef_index=floor(&i.*365), source=hs,  name=%eval(12*&i.)m);
%claims(days_start=floor((&i.-1)*365),days_bef_index=floor(&i.*365), source=dm,  name=%eval(12*&i.)m);

%mp_claims_p(days_start=floor((&i.-1)*365),days_aft_index=floor(&i.*365), source=snf,  name=p%eval(12*&i.)m);
%mp_claims_p(days_start=floor((&i.-1)*365),days_aft_index=floor(&i.*365), source=ip,  name=p%eval(12*&i.)m);
%claims_p(days_start=floor((&i.-1)*365),days_aft_index=floor(&i.*365), source=op,  name=p%eval(12*&i.)m);
%claims_p(days_start=floor((&i.-1)*365),days_aft_index=floor(&i.*365), source=pb,  name=p%eval(12*&i.)m);
%claims_p(days_start=floor((&i.-1)*365),days_aft_index=floor(&i.*365), source=hh,  name=p%eval(12*&i.)m);
%claims_p(days_start=floor((&i.-1)*365),days_aft_index=floor(&i.*365), source=hs,  name=p%eval(12*&i.)m);
%claims_p(days_start=floor((&i.-1)*365),days_aft_index=floor(&i.*365), source=dm,  name=p%eval(12*&i.)m);


%end;
%mend;

%days_nesting();




%macro merge(l=,source=,time=,p=);
data &source._&time._12m;
set &source._&p.12m;
run;

%do i=24 %to 84 %by 12;
%let l = %eval(&i.-12) ;

data &source._&time._&i.m;
merge &source._&time._&l.m &source._&p.&i.m;
run;
%end;

data &source._&time.;
set &source._&time._84m;
run;

proc sort data=&source._&time.;
by bid_hrs_22 index_date;
run;
%mend;

%merge(source=ip,time=bef,p=);
%merge(source=ip,time=aft,p=p);
%merge(source=snf,time=bef,p=);
%merge(source=snf,time=aft,p=p);
%merge(source=op,time=bef,p=);
%merge(source=op,time=aft,p=p);
%merge(source=pb,time=bef,p=);
%merge(source=pb,time=aft,p=p);
%merge(source=hh,time=bef,p=);
%merge(source=hh,time=aft,p=p);
%merge(source=hs,time=bef,p=);
%merge(source=hs,time=aft,p=p);
%merge(source=dm,time=bef,p=);
%merge(source=dm,time=aft,p=p);

/*now merge into single dataset of MC costs and get totals for each time window*/
data mc_costs_all;
merge ip_bef snf_bef op_bef pb_bef hh_bef hs_bef dm_bef 
ip_aft snf_aft op_aft pb_aft hh_aft hs_aft dm_aft;
by bid_hrs_22 index_date;
run;

%macro total();

data mc_costs_all2;
set mc_costs_all;
%do i=12 %to 84 %by 12;
tot_paid_by_mc_&i.m=ip_paid_by_mc_&i.m + snf_paid_by_mc_&i.m + op_paid_by_mc_&i.m + 
pb_paid_by_mc_&i.m + hh_paid_by_mc_&i.m + hs_paid_by_mc_&i.m + dm_paid_by_mc_&i.m;
tot_paid_by_mc_p&i.m=ip_paid_by_mc_p&i.m + snf_paid_by_mc_p&i.m + op_paid_by_mc_p&i.m + 
pb_paid_by_mc_p&i.m + hh_paid_by_mc_p&i.m + hs_paid_by_mc_p&i.m + dm_paid_by_mc_p&i.m;
%end;
run;

proc sort data=mc_costs_all2;
by bid_hrs_22 index_date;
run;

%mend;

%total();

data mc_costs_all3;
merge mc_costs_all2 mc_costs_dod;
by  bid_hrs_22 index_date;
run;

/*save permanent dataset*/
data proj_int.mc_costs_yearly;
set mc_costs_all3;
run;



H="SNF days"


%macro snfnights (name=);

data snf_&i(keep=bid_hrs_22 los index_date);
set proj_int.snf_meet_&name.;
if (&i.*365)>=index_date-admit_date>=((&i.-1)*365) 
or (&i.*365)>=index_date-admit_date>=((&i.-1)*365)
or index_date-admit_date>=&i.*365>=index_date-disch_date; 
if admit_date<index_date-(&i.*365) then admit_date=index_date-(&i.*365);
if disch_date>index_date-((&i.-1)*365) then disch_date=index_date-((&i.-1)*365);
los=disch_date-admit_date;
if los=0 then los=1;
run;

proc sql;
create table snf_&i.b as select distinct bid_hrs_22,
index_date, sum(los) as n_snf_days_y&i.
from snf_&i.
group by bid_hrs_22, index_date;
quit;


%mend;



/*need to set index dataset as snf 0 for the loop*/
data snf_0c;
set proj_int.index;
run;

/*run macros*/

%macro runall(years=);
%do i=1 %to &years.;
%let l=%eval(&i.-1);

%snfnights(name=%eval(12*&i.)m);

proc sql;
create table snf_&i.c as select * from
snf_&l.c a
left join 
snf_&i.b b
on a.bid_hrs_22=b.bid_hrs_22;
quit;

%end;


%mend;

%runall(years=7);

data proj_int.snf_nights;
set snf_7c;
run;

H="combine with interviews into one dataset"
data index;
set proj_int.index;
run;



proc sql; 
create table tomerge as select * from
proj_int.index a left join
proj_int.ffs_before b 
on a.bid_hrs_22=b.bid_hrs_22 and a.index_year=b.index_year
left join 
proj_int.mc_costs_yearly c
on a.bid_hrs_22=c.bid_hrs_22 and a.index_date=c.index_date
left join
proj_int.charls_0d_n12m d
on a.bid_hrs_22=d.bid_hrs_22 and a.index_date=d.index_date
left join
proj_int.snf_nights e
on a.bid_hrs_22=e.bid_hrs_22 and a.index_date=e.index_date
left join
proj_int.elix f
on a.bid_hrs_22=f.bid_hrs_22 and a.index_date=f.index_date
left join
proj_int.ccw g
on a.bid_hrs_22=g.bid_hrs_22 and a.index_date=g.index_date;
quit;

proc sql;
create table proj_int.decedent_dataset as select * from
proj_int.index a 
left join
tomerge b 
on a.id=b.id and a.index_year=b.index_year;
quit;

proc export data=proj_int.decedent_dataset outfile="E:\data\burden_dementia\int_data\decedent_dataset.dta" replace; run;

H="Model Medicaid spending & NH nights"
set more off
capture log close
version 15
clear all


local medipath "E:\data\CMS_DUA_51675_2014\Merged\Stata"
local logpath "E:\data\burden_dementia\logs"
local datapath "E:\data\burden_dementia\int_data"
local hrspath "E:\data\hrs_cleaned"
local restrpath "E:\data\hrs_restricted_2014\Ref Docs"
cd `medipath'


//pull in medicaid generosity
import excel "E:\data\hrs_restricted_2014\Ref Docs\Medicaid generosity.xlsx", ///
sheet("Sheet1") firstrow case(lower) clear
rename location stateusps
tempfile generosity
save `generosity'

//pull HRS ivw dates--going to assign the following core/exit to the year
use `hrspath'\core_00_to_14

append using `hrspath'\exit_02_to_16_dt
gen ivw_date=c_ivw_date
replace ivw_date=e_ivw_date if missing(ivw_date)
replace ivw_date=td(01jan2016) if missing(ivw_date)
gen ivw_year=year(ivw_date)
replace nh_nights=nh_nights_exit if missing(nh_nights)
tempfile hrs
save `hrs'

keep id ivw_*
reshape wide ivw_date, i(id) j(ivw_year)
tempfile hrswide
save `hrswide'

//get state and demo for re model

use "E:\data\hrs_cleaned\restr_tracker_v2014.dta", clear
gen stateusps16=stateusps14
keep hhid pn stateus* birth_date hisp_eth white black other_na degree
rename stateusps0* stateusps200*
rename stateusps1* stateusps201*
rename stateusps9* stateusps199*
reshape long stateusps, i(hhid pn) j(year)
drop if year<1998
expand 2, gen(dup)
replace year=year+1 if dup
gen id=hhid+pn
sort id year
by id: carryforward state, replace
gsort id -year
by id: carryforward state, replace
drop dup


drop if missing(id)
tempfile track
save `track'

//pull Medicaid
use hrs_max_asf_1999_2012, clear
merge m:1 bid using Medicaid2016Xref, keepusing(hhid pn) nogen
gen id=hhid+pn
gen rate=1 if year==2016
quietly replace rate=1.01262 if year==2015
quietly replace rate=1.01382 if year==2014
quietly replace rate=1.03026 if year==2013
quietly replace rate=1.04535 if year==2012
quietly replace rate=1.06699 if year==2011
quietly replace rate=1.10067 if year==2010
quietly replace rate=1.11872 if year==2009
quietly replace rate=1.11474 if year==2008
quietly replace rate=1.15754 if year==2007
quietly replace rate=1.19051 if year==2006
quietly replace rate=1.22891 if year==2005
quietly replace rate=1.27055 if year==2004
quietly replace rate=1.30439 if year==2003
quietly replace rate=1.33411 if year==2002
quietly replace rate=1.35521 if year==2001
quietly replace rate=1.39377 if year==2000
quietly replace rate=1.44062 if year==1999
quietly replace rate=1.47244 if year==1998

by bid, sort: egen ly=max(year)
drop if ly<2004
foreach x in ffs hmo php pccm {
	gen `x'exp=mdcd_`x'_amt*rate
	label var `x'exp "Annual `x' Medicaid Expenditures (2016$)"
}
egen mcaidexp=rowtotal(*exp)
label var mcaidexp "Total Annual Medicaid Expenditures (2016$)"
keep id bid *exp mdcd_nf_days_all year
tempfile mcaid
save `mcaid'





//pull annual expenditures for medicare
use hhid pn BID_HRS_22 using xref2015medicare, clear
rename *, l
tempfile xwalk
save `xwalk'

use bid start_dt ab_mo_cnt hmo_mo buyin_mo snf_covdys using basf_1998_2015 if buyin_mo>=1 & ab_mo_cnt>=1 & hmo_mo==0, clear
gen year=year(start_dt)
drop start_dt
by bid, sort: egen ly=max(year)
drop if ly<2004
merge m:1 bid using `xwalk', keep(match) nogen
drop ly
tempfile mbsf
save `mbsf'

foreach x in dm hh hs ip snf op pb {
	di "`x'"
	use bid_hrs_22 pmt_amt admit_date disch_date using `x'_1998_2015
	gen year=year(admit_date)
	merge m:1 bid year using `mbsf', keep(match)
	gen rate=1 if year==2016
	quietly replace rate=1.01262 if year==2015
	quietly replace rate=1.01382 if year==2014
	quietly replace rate=1.03026 if year==2013
	quietly replace rate=1.04535 if year==2012
	quietly replace rate=1.06699 if year==2011
	quietly replace rate=1.10067 if year==2010
	quietly replace rate=1.11872 if year==2009
	quietly replace rate=1.11474 if year==2008
	quietly replace rate=1.15754 if year==2007
	quietly replace rate=1.19051 if year==2006
	quietly replace rate=1.22891 if year==2005
	quietly replace rate=1.27055 if year==2004
	quietly replace rate=1.30439 if year==2003
	quietly replace rate=1.33411 if year==2002
	quietly replace rate=1.35521 if year==2001
	quietly replace rate=1.39377 if year==2000
	quietly replace rate=1.44062 if year==1999
	quietly replace rate=1.47244 if year==1998
	replace pmt_amt=pmt_amt*rate
	by bid year, sort: egen `x'exp=total(pmt_amt)
	label var `x'exp "Annual `x' expenditures (2016$)"
	keep bid year `x'exp
	duplicates drop
	tempfile `x'
	save ``x''
}

use `mbsf'
foreach x in dm hh hs ip snf op pb {
	merge 1:1 bid year using ``x'', gen(`x'm) 
}
gen id=hhid+pn

merge 1:1 id year using `mcaid', keep(match master) gen(mcmcm)

order id bid* year *exp*

merge m:1 id using `hrswide', keep(match) gen(hrsm)

//find the closest ivw during or after the year

gen ivw_date2001=.
gen ivw_date=ivw_date2016
forvalues i=2015(-1)1998 {
replace ivw_date=ivw_date`i' if year<=`i' & !missing(ivw_date`i')
drop ivw_date`i'
}

drop if missing(ivw_date)

merge m:1 id ivw_date using `hrs', nogen keep(match master)


gen ivw_type=0
replace ivw_type=1 if !missing(exit_year)
label define ivw_type 0 "Core" 1 "Exit"
label values ivw_type ivw_type

merge 1:1 id year using `track', gen(trackm) keep(match master)

//generate variables for use in model

//# months w/ MC but no Medicaid
gen m_no_mcaid=ab_mo-buyin_mo
replace m_no_mcaid=0 if m_no_mcaid<0

//state will be panel variable
encode stateusps, gen(state)
xtset state 

//demovars
rename other_na other_race

gen ind_hs_educ=degree>=2 if !inlist(degree,9,.)
label var ind_hs_educ "Education: HS+ (excl. GED)"

gen age=year-year(birth_date)
label var age "Age on Dec. 31st"
gen age2=age^2

replace nhres=0 if missing(nhres)
replace adl_independent=adl_independent_core if missing(adl_independent)
replace adl_independent=0 if missing(adl_independent)
replace medicaid=0 if missing(medicaid)

//total mc expenditures
egen mcexp=rowtotal(*exp)
label var mcexp "Total Annual Medicare Expenditures (2016$)"
	

	
//merge in medicaid generosity
merge m:1 stateusps using `generosity', keep(match master) gen(gm)
	
local modelvars nhres age age2 black hisp_eth other_race ind_hs_educ ///
ab_mo m_no_mcaid adl_independent married medicaid 


foreach x of local modelvars {
	replace `x'=0 if missing(`x')
}


reg mcaidexp mcexp `modelvars'  generous
estimates store est0

//drop other race & education & mcaid generosity
	
local modelvars nhres age age2 black hisp_eth ///
ab_mo m_no_mcaid adl_independent married medicaid 

reg mcaidexp mcexp `modelvars'  
estimates store est1

lrtest est1 est0

//still drop hispanics
local modelvars nhres married age age2 black ///
ab_mo m_no_mcaid adl_independent medicaid ivw_type year

reg mcaidexp mcexp `modelvars'  
estimates store est2
lrtest est2 est0

local xn : word count `modelvars' 

local mn=1
forvalues i=1/`xn' {
	di `i'
	local v : word `i' of `modelvars' 
	local mvincl`i' `mvincl`=`i'-1'' `v'
	foreach x of local modelvars {
		di "`x'"
		if "`x'"!="`v'" local mvexcl`i' `mvexcl`i'' `x'
}

	foreach y in incl excl {
		qui reg mcaidexp mcexp `mv`y'`i'' i.state
		estimates store est`v'`y'`i'
		local ests`v'`y' `ests`v'`y'' est`v'`y'`i'
		lrtest est0 est`v'`y'`i'
}
}

preserve

gen proxy=proxy_core
replace proxy=proxy_exit if missing(proxy)

xtreg mcaidexp mcexp `modelvars' , fe
predict pfe
capture log close
local logpath E:\data\burden_dementia\logs
log using "`logpath'\predicted_annual_medicaid_costs`c(current_date)'", replace

set seed 12345
gen norm=rnormal()
sort norm
gen testsamp=_n<=_N/2
tab testsamp
tab testsamp if !missing(mcaidexp)

local modelvars nhres married c.age##c.age black ///
ab_mo m_no_mcaid adl_independent medicaid ivw_type proxy year
reg mcaidexp mcexp `modelvars' if testsamp==1
predict pols 
xtreg mcaidexp mcexp `modelvars' if testsamp==1, re
predict pre

twopm mcaidexp mcexp `modelvars' if testsamp==1, firstpart(logit) secondpart(regress)
predict ptwopart
estimates store est1
twopm mcaidexp mcexp `modelvars' i.state  , firstpart(logit) secondpart(regress)
predict ptptwithstates
estimates store est2

log close 
log using "`logpath'\predicted_annual_medicaid_costs_quick_compare`c(current_date)'", replace

foreach x in  re two tpt {
	di "In sample"
	reg mcaidexp p`x' if testsamp
	di "Out of sample"
	reg mcaidexp p`x' if !testsamp
	
}

log close



twopm mcaidexp mcexp `modelvars', firstpart(logit) secondpart(regress)

predict pmcaid
gen ind_mcaid_imputed=missing(mcaidexp) & !missing(pmcaid)
replace mcaidexp=pmcaid if missing(mcaidexp)

local modelvars nhres age age2 black  ///
ab_mo m_no_mcaid adl_independent married medicaid 

local modelvars nhres age age2 black  ///
ind_hs_educ ab_mo m_no_mcaid adl_independent married medicaid ///
ivw_type proxy year generous

//predict medicaid nights
replace nh_nights=0 if missing(nh_nights)
replace nh_nights=365 if nh_nights>365



twopm mdcd_nf_days_all snf_covdys nh_nights `modelvars' if testsamp==1 & nh_nights, ///
firstpart(logit) secondpart(regress)
predict ptwopnhn

twopm mdcd_nf_days_all snf_covdys nh_nights `modelvars' if testsamp==1 & nh_nights, ///
firstpart(logit) secondpart(glm, fam(gamma) link(log))
predict ptwopnhnglm

poisson mdcd_nf_days_all snf_covdys nh_nights `modelvars' if testsamp==1 & nh_nights
predict ppois


local modelvars nhres age   ///
ab_mo m_no_mcaid adl_independent   ///
ivw_type proxy 

/*
cap program drop hplogitLL

program hplogitLL
	args lnf beta1 beta2 
	qui tempvar pi mu
	qui gen double `mu' = exp(`beta1')
	qui gen double `pi' = exp(`beta2')
	qui replace `lnf'	= cond($ML_y1=0, ln(`pi'/(1+`pi')), ln(1/(1+`pi')) - `mu' ///
	 + $ML_y1 * `beta1' - lngamma($ML_y1+1) - ln(1-exp(-`mu')))
end

ml model lf hplogitLL (cnd: count = child camper persons) ///
(logit:count_nonzero=child camper persons) ///
ml maximize, search(on) nolog title("hplogit") difficult
predict xb1, eq(#1)
predict xb2, eq(#2)
generate phat2= 1/(1+exp(xb2))
generate tyhat2=exp(xb1)
gen yhat2=phat2*tyhat2
*/

local modelvars nhres married c.age##c.age black ///
ab_mo m_no_mcaid adl_independent medicaid ivw_type proxy 
poisson mdcd_nf_days_all snf_covdys nh_nights `modelvars' if testsamp==1 & nh_nights ///
& mdcd_nf_days_all
predict pnb

zinb mdcd_nf_days_all snf_covdys nh_nights `modelvars' if testsamp==1 & nh_nights, ///
inflate(  snf_covdys nh_nights `modelvars')
predict pzinb

logit mdcd_nf_days_all snf_covdys nh_nights `modelvars' if testsamp==1 & nh_nights 
predict plogit


poisson mdcd_nf_days_all snf_covdys nh_nights `modelvars' if testsamp==1 & nh_nights ///
& mdcd_nf_days_all
predict ppoisson

gen phurdle=plogit*ppoisson

poisson mdcd_nf_days_all snf_covdys nh_nights `modelvars' if testsamp==1 & nh_nights

twopm mdcd_nf_days_all snf_covdys nh_nights `modelvars' if nh_nights , ///
firstpart(logit) secondpart(glm, fam(gamma) link(log))

predict p2plog

drop plogit pnb

logit mdcd_nf_days_all snf_covdys nh_nights `modelvars' if  nh_nights 
predict plogit

nbreg mdcd_nf_days_all snf_covdys nh_nights `modelvars' if  nh_nights ///
& mdcd_nf_days_all, dispersion(mean)
predict pnb1

nbreg mdcd_nf_days_all snf_covdys nh_nights `modelvars' if  nh_nights ///
& mdcd_nf_days_all, dispersion(constant)
predict pnb2

gen phnb1=plogit*pnb1
gen phnb2=plogit*pnb2

replace mdcd_nf_days_all=phnb1 if missing(mdcd_nf_days_all) 


save E:\data\burden_dementia\int_data\\predicted_annual_medicaid_costs.dta, replace

translate "`logpath'\predicted_annual_medicaid_costs`c(current_date)'.smcl" ///
"`logpath'\predicted_annual_medicaid_costs`c(current_date)'.pdf", replace
translate "E:\data\burden_dementia\logs\predicted_annual_medicaid_costs_quick_compare`c(current_date)'.smcl" ///
"E:\data\burden_dementia\logs\predicted_annual_medicaid_costs_quick_compare`c(current_date)'.pdf", replace


H="Pull Medicaid costs and days"
libname merged 'E:\data\CMS_DUA_51675_2014\Medicaid_merged';

proc import datafile="E:\data\burden_dementia\int_data\decedent_dataset.dta" out=R01 (keep = id index_month index_year index_date) dbms=stata replace; run;

proc import datafile="E:\data\CMS_DUA_51675_2014\Medicaid_merged\MedicaidXref2012_old.dta" out=maid_xwalk (keep = hhidpn bid_hrs_23) dbms=stata replace; run;

proc sql;
create table r01_merged as select a.*, b.bid_hrs_23
from R01 a
inner join maid_xwalk b
on a.id = b.hhidpn; 
quit;


data r01;
set r01_merged;
format index_date date9.;
run;


/*** Get HH + SNF days & cost + Total Maid cost *****/

data month_breakdown (keep = bid_hrs_23 year month mdcd_ffs_amt mdcd_hmo_amt mdcd_php_amt mdcd_pccm_amt mdcd_nf_days_all mdcd_nf_days_hcbs_all mdcd_nf_amt mdcd_nf_amt_hcbs mdcd_hh_amt mdcd_hh_amt_hcbs mdcd_hh_days_all mdcd_hh_days_hcbs_all mdcd_hh_days_ffs mdcd_nf_days_ffs);
set merged.hrs_max_msf_1999_2012;
run;

data month_breakdown (drop = mdcd_ffs_amt mdcd_hmo_amt mdcd_php_amt mdcd_pccm_amt mdcd_nf_days_all mdcd_nf_days_hcbs_all mdcd_nf_amt mdcd_nf_amt_hcbs mdcd_hh_amt mdcd_hh_amt_hcbs mdcd_hh_days_all mdcd_hh_days_hcbs_all);
set month_breakdown;
paid_maid = sum(mdcd_ffs_amt, mdcd_hmo_amt, mdcd_php_amt, mdcd_pccm_amt); /*total paid medicaid */
nf_days_maid = sum(mdcd_nf_days_all);
nf_ffs_days_maid = sum(mdcd_nf_days_ffs);
nf_cost_maid = sum(mdcd_nf_amt);
hh_days_maid = sum(mdcd_hh_days_all);
hh_ffs_days_maid = sum(mdcd_hh_days_ffs);
hh_cost_maid = sum(mdcd_hh_amt);
run;

proc sort data=month_breakdown; by bid_hrs_23 year; run;
proc transpose data=month_breakdown out=month_breakdown_wide; by bid_hrs_23 year; id month; run;


proc sql;
create table r01_b as select a.*, b.*
from r01 a
left join month_breakdown_wide b
on a.bid_hrs_23=b.bid_hrs_23;
quit;



proc export data=r01_b outfile="E:\data\burden_dementia\int_data\medicaid_cost_hh_snf.dta" dbms=stata replace; run;


H="Calculate SNF/HH Medicaid cost+days "
use "E:\data\burden_dementia\int_data\predicted_annual_medicaid_costs.dta", clear
merge m:1 id using "E:\data\burden_dementia\int_data\decedent_dataset.dta", ///
keep(match) keepusing(index*) nogen

drop _*
forvalues i=1/12 {
	gen _`i'=mcaidexp/12
}

gen _name_="paid_maid"

expand 2, gen(dup)
forvalues i=1/12 {
	replace _`i'=mdcd_nf_days_all/12 if dup==1
}
replace _name_="nf_days_maid" if dup==1

keep id year _* ind_mcaid_imp index*

tempfile pmcaid
save `pmcaid'

use  "E:\data\burden_dementia\int_data\medicaid_cost_hh_snf.dta", clear

*drop if index_year>2012 | index_year<=2005

/* inflation adjustment */



gen rate = .

replace rate = 1 if year==2016
replace rate=1.01262 if year==2015
replace rate=1.01382 if year==2014
replace rate=1.03026 if year==2013
replace rate=1.04535 if year==2012
replace rate=1.06699 if year==2011
replace rate=1.10067 if year==2010
replace rate=1.11872 if year==2009
replace rate=1.11474 if year==2008
replace rate=1.15754 if year==2007
replace rate=1.19051 if year==2006
replace rate=1.22891 if year==2005
replace rate=1.27055 if year==2004
replace rate=1.30439 if year==2003
replace rate=1.33411 if year==2002
replace rate=1.35521 if year==2001
replace rate=1.39377 if year==2000
replace rate=1.44062 if year==1999
replace rate=1.47244 if year==1998

gen cost = 0
replace cost = 1 if (_name_=="hh_cost_maid" | _name_=="nf_cost_maid" | _name_=="paid_maid")

forvalues p = 1/12 {

replace _`p' = _`p'*rate if cost==1
}

merge m:1 id year _name_ using `pmcaid', gen(pmcaidm) update

/*Flag year markers, n1=[0,-12], n2=[-12,-24], n3=[-24,-36], etc. */



forvalues i=1/7 {
gen n`i'_flag = 0
replace n`i'_flag = 1 if (year==index_year-`=`i'-1') | (year==index_year-`i')
}


gen index_day = day(index_date)



save "E:\data\burden_dementia\int_data\medicaid_cost_inflation.dta", replace

cd "E:\data\burden_dementia\int_data"

levelsof _name_, local(namevars)
return list

foreach x of local namevars {
use "E:\data\burden_dementia\int_data\medicaid_cost_inflation.dta", clear
keep if _name_=="`x'"



forvalues t=1/12 {
preserve
keep if index_month==`t'

forvalues i=1/7 {

gen sum_n`i'_cyr= 0 if n`i'_flag==1 /*sum months before index month in current year*/

local j = index_month
local k = 1


	while `k' <= `j' { // while current month less than or equal index, add to past value
		while `k' < `j' {
			replace sum_n`i'_cyr = sum_n`i'_cyr + _`k' if sum_n`i'_cyr!=.
			local ++k
		}
	    replace sum_n`i'_cyr = sum_n`i'_cyr + (_`k')*(index_day/30.4) if sum_n`i'_cyr!=. // if current month = index, then prorate it
		local ++k
}

gen sum_n`i'_b4yr = 0 if n`i'_flag==1

local r = index_month
local s = 12
	while `s' >=`r' { // count backwards to get months before index in previous year
		while `s' > `r' {
		replace sum_n`i'_b4yr = sum_n`i'_b4yr + _`s' if sum_n`i'_b4yr!=.
		local --s
	}
	
	replace sum_n`i'_b4yr = sum_n`i'_b4yr + (_`s')*(1-(index_day/30.4)) if sum_n`i'_b4yr!=.
	local --s
	}
	


}
keep if n1_flag | n2_flag | n3_flag | n4_flag | n5_flag | n6_flag | n7_flag


gsort +id +year


forvalues i=1/7 {

gen tot_`x'_n`i' = sum_n`i'_cyr + sum_n`i'_b4yr[_n-1]
}

*keep id index_date bid_hrs_23 index_year year n*_flag tot_`x'_n* 
sort id year
by id: carryforward tot_*, replace
by id: keep if _n==_N
keep id index_date bid_hrs_23 tot_`x'_n* 
save mc_`x'_`t'.dta, replace

restore

}

}

foreach x of local namevars {

	use mc_`x'_1.dta, clear
	
	forvalues i = 2/12 {
		
		append using mc_`x'_`i'.dta
		save tot_`x'.dta, replace
		}
		}

foreach x of local namevars {

use tot_paid_maid.dta, clear
cap drop _m 
merge 1:1 id using "E:\data\burden_dementia\int_data\tot_`x'.dta", ///
keepus(tot_`x'_n1 tot_`x'_n2 tot_`x'_n3 tot_`x'_n4 tot_`x'_n5 tot_`x'_n6 tot_`x'_n7)
save tot_paid_maid.dta, replace
}


label var tot_paid_maid_n1 "Total Medicaid Spending N1"
label var tot_paid_maid_n2 "Total Medicaid Spending N2"
label var tot_paid_maid_n3 "Total Medicaid Spending N3"
label var tot_paid_maid_n4 "Total Medicaid Spending N4"
label var tot_paid_maid_n5 "Total Medicaid Spending N5"
label var tot_paid_maid_n6 "Total Medicaid Spending N6"
label var tot_paid_maid_n7 "Total Medicaid Spending N7"

label var tot_hh_cost_maid_n1 "Total HH (FFS) Medicaid Spending N1"
label var tot_hh_cost_maid_n2 "Total HH (FFS) Medicaid Spending N2"
label var tot_hh_cost_maid_n3 "Total HH (FFS) Medicaid Spending N3"
label var tot_hh_cost_maid_n4 "Total HH (FFS) Medicaid Spending N4"
label var tot_hh_cost_maid_n5 "Total HH (FFS) Medicaid Spending N5"
label var tot_hh_cost_maid_n6 "Total HH (FFS) Medicaid Spending N6"
label var tot_hh_cost_maid_n7 "Total HH (FFS) Medicaid Spending N7"

label var tot_hh_days_maid_n1 "Total HH Medicaid Days N1"
label var tot_hh_days_maid_n2 "Total HH Medicaid Days N2"
label var tot_hh_days_maid_n3 "Total HH Medicaid Days N3"
label var tot_hh_days_maid_n4 "Total HH Medicaid Days N4"
label var tot_hh_days_maid_n5 "Total HH Medicaid Days N5"
label var tot_hh_days_maid_n6 "Total HH Medicaid Days N6"
label var tot_hh_days_maid_n7 "Total HH Medicaid Days N7"

label var tot_hh_ffs_days_maid_n1 "Total HH (FFS) Medicaid Days N1"
label var tot_hh_ffs_days_maid_n2 "Total HH (FFS) Medicaid Days N2"
label var tot_hh_ffs_days_maid_n3 "Total HH (FFS) Medicaid Days N3"
label var tot_hh_ffs_days_maid_n4 "Total HH (FFS) Medicaid Days N4"
label var tot_hh_ffs_days_maid_n5 "Total HH (FFS) Medicaid Days N5"
label var tot_hh_ffs_days_maid_n6 "Total HH (FFS) Medicaid Days N6"
label var tot_hh_ffs_days_maid_n7 "Total HH (FFS) Medicaid Days N7"

label var tot_nf_cost_maid_n1 "Total SNF (FFS) Medicaid Spending N1"
label var tot_nf_cost_maid_n2 "Total SNF (FFS) Medicaid Spending N2"
label var tot_nf_cost_maid_n3 "Total SNF (FFS) Medicaid Spending N3"
label var tot_nf_cost_maid_n4 "Total SNF (FFS) Medicaid Spending N4"
label var tot_nf_cost_maid_n5 "Total SNF (FFS) Medicaid Spending N5"
label var tot_nf_cost_maid_n6 "Total SNF (FFS) Medicaid Spending N6"
label var tot_nf_cost_maid_n7 "Total SNF (FFS) Medicaid Spending N7"

label var tot_nf_days_maid_n1 "Total SNF Medicaid Days N1"
label var tot_nf_days_maid_n2 "Total SNF Medicaid Days N2"
label var tot_nf_days_maid_n3 "Total SNF Medicaid Days N3"
label var tot_nf_days_maid_n4 "Total SNF Medicaid Days N4"
label var tot_nf_days_maid_n5 "Total SNF Medicaid Days N5"
label var tot_nf_days_maid_n6 "Total SNF Medicaid Days N6"
label var tot_nf_days_maid_n7 "Total SNF Medicaid Days N7"

label var tot_nf_ffs_days_maid_n1 "Total SNF (FFS) Medicaid Days N1"
label var tot_nf_ffs_days_maid_n2 "Total SNF (FFS) Medicaid Days N2"
label var tot_nf_ffs_days_maid_n3 "Total SNF (FFS) Medicaid Days N3"
label var tot_nf_ffs_days_maid_n4 "Total SNF (FFS) Medicaid Days N4"
label var tot_nf_ffs_days_maid_n5 "Total SNF (FFS) Medicaid Days N5"
label var tot_nf_ffs_days_maid_n6 "Total SNF (FFS) Medicaid Days N6"
label var tot_nf_ffs_days_maid_n7 "Total SNF (FFS) Medicaid Days N7"


cd "E:\projects\burden_dementia\archive logs"
/*
forvalues i = 1/5 {

qui twoway scatter tot_nf_cost_maid_n`i' tot_nf_ffs_days_maid_n`i'
graph export SNF_n`i'.pdf, as(pdf) replace 

qui twoway scatter tot_hh_cost_maid_n`i' tot_hh_ffs_days_maid_n`i'
graph export HH_n`i'.pdf, as(pdf) replace
}
*/

*preserve
*keep if year(index_date)>=2005 & year(index_date)<=2012

local cost tot_paid_maid_n1 tot_paid_maid_n2 tot_paid_maid_n3 tot_paid_maid_n4 tot_paid_maid_n5 tot_paid_maid_n6 tot_paid_maid_n7 tot_hh_cost_maid_n1 tot_hh_cost_maid_n2 tot_hh_cost_maid_n3 tot_hh_cost_maid_n4 tot_hh_cost_maid_n5 tot_hh_cost_maid_n6 tot_hh_cost_maid_n7 tot_nf_cost_maid_n1 tot_nf_cost_maid_n2 tot_nf_cost_maid_n3 tot_nf_cost_maid_n4 tot_nf_cost_maid_n5 tot_nf_cost_maid_n6 tot_nf_cost_maid_n7
local days tot_hh_days_maid_n1 tot_hh_days_maid_n2 tot_hh_days_maid_n3 tot_hh_days_maid_n4 tot_hh_days_maid_n5 tot_hh_days_maid_n6 tot_hh_days_maid_n7 tot_nf_days_maid_n1 tot_nf_days_maid_n2 tot_nf_days_maid_n3 tot_nf_days_maid_n4 tot_nf_days_maid_n5 tot_nf_days_maid_n6 tot_nf_days_maid_n7 tot_hh_ffs_days_maid_n1 tot_hh_ffs_days_maid_n2 tot_hh_ffs_days_maid_n3 tot_hh_ffs_days_maid_n4 tot_hh_ffs_days_maid_n5 ///
tot_hh_ffs_days_maid_n6 tot_hh_ffs_days_maid_n7 tot_nf_ffs_days_maid_n1 tot_nf_ffs_days_maid_n2 tot_nf_ffs_days_maid_n3 tot_nf_ffs_days_maid_n4 tot_nf_ffs_days_maid_n5 tot_nf_ffs_days_maid_n6 tot_nf_ffs_days_maid_n7
local full `cost' `days'

local rd: word count `full' 1

di `rd'

mat tab1= J(`rd',9,.)
local r = 1

foreach x of local full {

sum `x'
mat tab1[`r',1] = r(mean)
sum `x' if `x'>0, d
mat tab1[`r',2]= r(mean)
mat tab1[`r',3] = r(min)
mat tab1[`r',4]= r(p25)
mat tab1[`r',5] = r(p50)
mat tab1[`r',6]= r(p75)
mat tab1[`r',7] = r(p99)
mat tab1[`r',8] = r(max)

cap drop zero
gen zero = .
replace zero = 1 if `x'==0
sum zero, d
mat tab1[`r',9]= r(N)
local ++r

}

sum `x'
mat tab1[`r',9] = 1422
mat list tab1

mat rownames tab1 = `full' N


frmttable using "E:\projects\burden_dementia\archive logs\MAX_summary.doc", replace statmat(tab1) landscape a4 ///
varlabels title("MAX Summary Statistics For R01 Sample (includes all deceased, regardless of age or dementia)") ctitles("Variables" "Ave." "Ave (non-zero)" "Minimum" "25th percentile" "Median" "75th percentile" "99th percentile" "Maximum" "# of zero's") sdec(2) ///
note("Costs have been pro-rated and inflation adjusted to 2012 dollars. The Percentiles exclude zeros")





H="Cleaning/Merging/Data aggregation"
clear all
capture log close

global datapath "E:\data\burden_dementia\int_data"
local logpath "E:\data\burden_dementia\logs"
global ooppath "E:\data\burden_dementia\oopdata"
global output "E:\projects\burden_dementia\archive logs"

*log using `logpath'\R01_aggregate.txt, text replace

* Constructs aggregate dataset and variables for R01 before people are dropped
* search "to be dropped" to find sample exclusion variables

/****************** START WITH EXIT **********************/

use "E:\data\hrs_cleaned\exit_02_to_16_dt.dta", clear

foreach x of varlist * {

rename `x' `x'_exit
}

rename id_exit id
gen nflag = 0
cap drop _m
gen year = exit_year_exit
save $datapath\exit.dta, replace // all exit interviews 2002-14

/**************** MERGE TRACKER WITH DECEDENT DATASET ***********/

cd $datapath

use decedent_dataset.dta if inrange(index_year,2004,2015), clear
cap drop _m
format %td index_date
merge m:1 id using tracker.dta 
keep if _m==3

replace birth_date=mdy(6,birthd,birthy) if missing(birth_date)
cap drop death_date
gen death_date = index_date
gen age_at_death=floor((death_date-birth_date)/365.25)

cap drop _m
merge 1:1 id using exit.dta
gen age_lt_72 = 1 if age_at_death<72
gen age_lt_70 = 1 if age_at_death<70
label var age_lt_72 "Age <72 at death, to be dropped"
label var age_lt_70 "Age <70 at death, to be dropped"

gen no_exit=1 if _m==1
label var no_exit "Decedents with no exit ivw 2002-16, to be dropped"
drop if _m==2
cap drop _m
save r01_a.dta, replace

/*************** MERGE WITH CORE INTERVIEW **************/

use r01_a.dta, clear
keep id index_date index_year exit_year_exit e_ivw_date_exit
tempfile id 
save `id' //decedents with exit 

use "E:\data\hrs_cleaned\core_00_to_14.dta", clear
merge m:1 id using "`id'", keepus(index_date index_year exit_year_exit e_ivw_date_exit)
levelsof id if _m==2, local(nocore)
global nocore1 "`nocore'"
keep if _m==3
cap drop _m
gsort id -core_year
by id: gen obs=_n
keep if obs<=5 // keeping last 5 core interviews (N1 - N4 + Baseline)

* I'm creating a single ivw date variable that has both the core ivw date and exit ivw date
gen ivw_date = c_ivw_date

* data is sorted in descending order by core year. I am carrying the date & year //
* of the previous (chronologically) interview into the current row
*by id: gen next_ivw_date_old = ivw_date[_n+1]
by id: gen next_ivw_year = core_year[_n+1]

by id: gen diff = core_year - core_year[_n-1] // -4 or higher denotes a gap year

bysort id: egen gap = min(diff) // using min because diff is negative
replace gap = abs(gap) // max number of years between consecutive core
levelsof id if gap>4, local(misscore)

gen miss_core = .
label var miss_core "Missing consecutive core ivw, to be dropped"
foreach x of local misscore {

replace miss_core = 1 if id=="`x'"
}

drop obs gap diff
gen year = core_year // combines exit_year & core_year into a single variable

* Merge with dementia dataset

merge 1:1 id core_year using "E:\data\hrs_public_2014\dementia\pdem_withvarnames_00_14.dta", keepus(pdem)
drop if _m==2

gsort id -core_year

by id: replace pdem = pdem[_n+1] if pdem==.

gen dementia = 0 if pdem!=.
replace dementia = 1 if pdem>=.5 & pdem!=.
cap drop _m

tempfile core
save `core'

use r01_a.dta, clear
append using "`core'" // appending to exit/tracker 
gen no_core = .
label var no_core "No core ivw 2000-14, to be dropped"
foreach x of global nocore1 {

replace no_core = 1 if id=="`x'"

}

* Data is currently in long form, with one row for exit and a row for each core

save r01_b.dta, replace

/****** Imputing core for people with a 4 year gap between ivws *******/

use r01_b.dta, clear

levelsof id if no_exit==1, local(noexit)

foreach x of local noexit {

replace no_exit = 1 if id=="`x'"
}



gen year_ci = core_year 
replace year_ci = index_year if nflag==0
label var year_ci "core_year(if nflag>0) or index_year(if nflag=0)"
gsort id -year 
by id: gen obs=_n

cap drop nflag 
gen nflag = obs - 1
label var nflag "Interview type, 0 = exit, 1 = N1, etc."

gen dem_cohort = 0 if dementia!=.
label var dem_cohort "Probable Dementia at N1"
levelsof id if dementia==1 & nflag==1, local(demlist)

foreach x of local demlist {
replace dem_cohort = 1 if id=="`x'"
}

gen core_4yr = index_date - c_ivw_date if obs==2
replace core_4yr = 4 if core_4yr<=1460 & core_4yr>=0


/* 

* Final R01 dataset requires everyone to have a core ivw within 4 (calendar) years of death
* But their exit ivw may be further away. The date of exit is irrelevant for ivw spacing
* so will use their date of death instead

Funky stuff: People who have a core ivw after they have died
keep if core_4yr < 0
c_ivw_date > index_date */

preserve
keep if c_ivw_date > index_date & c_ivw_date!=. // people with core dates after ivw
keep id index_date c_ivw_date core_year proxy_core no_exit female birth_date bid_hrs_22
save check_id_xwalk.dta, replace
restore

levelsof id if (core_4yr>4 & core_4yr!=.) | core_4yr<0, local(nocore4yr)

gen nocore4yr = .
label var nocore4yr "No Core ivw within 4 years of death, to be dropped"

gen death_b4_core = .
label var death_b4_core "Has NDI/Bene DOD before Core Ivw" 


levelsof id if c_ivw_date > index_date & c_ivw_date!=., local(diedb4core)

foreach x of local diedb4core {

replace death_b4_core = 1 if id=="`x'"
}

foreach x of local nocore4yr {
replace nocore4yr = 1 if id=="`x'"
}

gsort id -year
by id: gen diff = year_ci - year_ci[_n-1] // -4 or higher denotes a gap year

drop obs nflag

gsort id -year
by id: gen nflag = _n
replace nflag = nflag - 1

*replace year = year_ci if nflag>0
label var year "core_year(if nflag>0), exit_year(if nflag=0), includes imputed cores"


levelsof id if miss_core==1, local(misscore)
foreach x of local misscore {

replace miss_core = 1 if id=="`x'"
}

*drop if no_exit==1 & nflag==0 & imputed==1

save R01_d.dta, replace



/********** Final Calculations For Sample Derivation *********/

use R01_d.dta, clear

replace nh_nights = nh_nights_exit_exit if nflag==0

gsort id nflag

by id: gen next_ivw_date = ivw_date[_n+1] // bringing forward date from prior core away from death

format %td next_ivw_date

gen n1_2_death = index_date - c_ivw_date if nflag==1
replace n1_2_death = n1_2_death * 0.0329
replace n1_2_death = ceil(n1_2_death)
replace n1_2_death = 1 if n1_2_death<=0

gen core_b4_death = 0
replace core_b4_death = 1 if nflag==1

gsort id -core_b4_death

gen n1_ivw_date = c_ivw_date if nflag==1

by id: carryforward n1_2_death n1_ivw_date, replace

gen ivw_time = ivw_date - next_ivw_date
replace ivw_time = ivw_time * 0.0329
label var ivw_time "Months between previous ivw & current ivw"

gen n1_2_ivw = n1_ivw_date - ivw_date
replace n1_2_ivw = n1_2_ivw * 0.0329
label var n1_2_ivw "Months between current ivw & N1 interview"

gen last_core = 1 if ivw_time==. & nflag>0
label var last_core "Last observable core, ivw_time imputed at 24 months"
replace ivw_time = 24 if ivw_time==. & nflag>0

sum ivw_time if nflag>0
/*Average time between core ivws is 24 months. So if we subtract ivw date from death, 
only need it to be >=60 since interview data extends ~24 months back */

gen months_obs = n1_2_ivw + ivw_time + n1_2_death
replace months_obs = ceil(months_obs) // round up to keep integers. Makes subsequent math easier
label var months_obs "# of months person is observed in sample"

gen hrs_gte_84m = 0
replace hrs_gte_84m = 1 if months_obs>=83.5 & months_obs!=.
label var hrs_gte_84m ">=84 months of HRS ivw data"

gen hrs_gte_60m = 0
replace hrs_gte_60m = 1 if months_obs>=60 & months_obs!=.

levelsof id if hrs_gte_60m, local(moredata)
foreach x of local moredata {
replace hrs_gte_60m = 1 if id=="`x'"
}

gen hrs_lt_60m = .
replace hrs_lt_60m = 1 if hrs_gte_60m==0
label var hrs_lt_60m "<60m of HRS ivw data, to be dropped"



levelsof id if hrs_gte_84m, local(havedata)
foreach x of local havedata {
replace hrs_gte_84m = 1 if id=="`x'"
}

gen hrs_lt_84m = .
replace hrs_lt_84m = 1 if hrs_gte_84m==0
label var hrs_lt_84m "<84 months of HRS ivw data, to be dropped"

gen ffs_84m = 0
replace ffs_84m = 1 if cont_ffs_n_mos>=84 & cont_ffs_n_mos!=. & nflag==0
label var ffs_84m "84 months of continuous FFS prior to death"


gen ffs_60m = 0
replace ffs_60m = 1 if cont_ffs_n_mos>=60 & cont_ffs_n_mos!=. & nflag==0
label var ffs_84m "60 months of continuous FFS prior to death"



levelsof id if dem_cohort==0, local(demb)
foreach x of local demb {
replace dem_cohort=0 if id=="`x'"

}

levelsof id if dem_cohort==1, local(demc)
foreach x of local demc {
replace dem_cohort=1 if id=="`x'"
}

local samplevars age_lt_72 age_lt_70 no_exit miss_core no_core nocore4yr hrs_lt_84m hrs_lt_60m death_b4_core ffs_84m ffs_60m 

foreach x of local samplevars {

levelsof id if `x'==1, local(samp)

foreach y of local samp {

replace `x'=1 if id=="`y'"
replace `x'=0 if `x'!=1

}
} 
save R01_e.dta, replace


/************** Get State information *************/

use R01_e.dta, clear
keep id

duplicates drop id, force
tempfile id
save `id'


// pull tracker
use "E:\data\hrs_cleaned\restr_tracker_v2014.dta", clear
drop id
gen id=hhid+pn

merge 1:1 id using "`id'"
keep if _m==3

keep hhid pn stateusps* zipcode*

gen stateusps16 = stateusps14
gen zipcode16 = zipcode14

foreach x of varlist stateusps* {

replace `x' = "" if `x'=="ZZ"

}

gen stateusps97=""
gen stateusps99=""

forvalues i= 1(2)15{
gen stateusps`i'=""
gen zipcode`i' = ""
}

forvalues i=0(2)8{
rename stateusps0`i' stateusps`i'
rename zipcode0`i' zipcode`i'
}
reshape long stateusps zipcode, i(hhid pn) j(c_ivw_year)

forvalues i=0/99{
qui replace c_ivw_year=200`i' if c_ivw_year==`i' & c_ivw_year<=9
qui replace c_ivw_year=20`i' if c_ivw_year==`i' & inrange(c_ivw_year, 10,16)
qui replace c_ivw_year=19`i' if c_ivw_year==`i' & c_ivw_year>=90
}

gen id= hhid+pn
sort id c_ivw_year
drop if id==""
by id: carryforward stateusps, replace

gsort id -c_ivw_year
by id: carryforward stateusps, replace

gen nflag = 0
gen index_year = c_ivw_year

tempfile state
save "`state'"


use R01_e.dta, clear
merge m:1 id c_ivw_year using "`state'", keepus(stateusps)
drop if _m==2
drop _m
merge m:1 id index_year nflag using "`state'", keepus(stateusps) update
drop if _m==2
drop _m

preserve

//bring in Genworth NH night cost
import excel "E:\data\burden_dementia\ref_data\Cost Care Survey (Genworth-Metlife)\HHA_hourly_genworth.xlsx", ///
sheet("Sheet5") firstrow clear 
rename *, l
drop e f


gen cpi_rate = 1 if year==2016
replace cpi_rate=1.01262 if year==2015
replace cpi_rate=1.01382 if year==2014
replace cpi_rate=1.03026 if year==2013
replace cpi_rate=1.04535 if year==2012
replace cpi_rate=1.06699 if year==2011
replace cpi_rate=1.10067 if year==2010
replace cpi_rate=1.11872 if year<=2009


rename year index_year
rename state stateusps
gen genworth_nh_rate_cpi_adj=median*cpi_rate
drop if missing(index_year)

tempfile nhcosts
save `nhcosts'

restore
merge m:1 index_year stateusps using `nhcosts'
drop if _m==2
drop _m
//nat'l median in 2016 was $225, so replace with that if missing(state)
destring genworth_nh_rate_cpi_adj, replace
replace genworth_nh_rate_cpi_adj=225 if missing(genworth_nh_rate_cpi_adj)
save R01_i.dta, replace


H="Sample derivation"
clear all
capture log close

global datapath "E:\data\burden_dementia\int_data"
local logpath "E:\data\burden_dementia\logs"
global ooppath "E:\data\burden_dementia\oopdata"
global output "E:\projects\burden_dementia\archive logs"

*log using `logpath'\sample_derivation.txt, text replace
cd $datapath

use R01_i.dta, clear
*preserve

drop if dem_cohort==.

gen ffs_lt_60m = 0
replace ffs_lt_60m = 1 if ffs_60m==0

gen ffs_lt_84m = 0
replace ffs_lt_84m = 1 if ffs_84m==0

local deri age_lt_70 no_exit miss_core no_core nocore4yr hrs_lt_60m death_b4_core ffs_lt_60m


gen final = 1
label var final "5yr Sample Size, includes decedents w/imputed core"

foreach x of local deri {
replace final = 0 if `x'==1
}

gen final_7yr = 1 if final==1
label var final_7yr "7yr Sample Size, includes decedents w/imputed core"


foreach x of varlist age_lt_72 hrs_lt_84m ffs_lt_84m {
replace final_7yr = 0 if `x'==1
}


label var ffs_lt_60m "<60m continuous FFS prior to death"
label var ffs_lt_84m "<84m continuous FFS prior to death"


gen dropped_7yr = 0
replace dropped_7yr = 1 if final_7yr==0 & final==1


preserve
keep if nflag==0

gen all = 1
label var all "All HRS respondents Deceased 2004-2015"
/*
local full all age_lt_72 no_exit miss_core no_core nocore4yr death_b4_core hrs_lt_84m final final_noimp final_ffs final_noimp_ffs

local rd: word count `full'

mat tab1 = J(`rd',3,.)

local r = 1

foreach x of local full {

sum `x'
mat tab1[`r',1] = r(sum)

sum `x' if dem_cohort==1
mat tab1[`r',2] = r(sum)

sum `x' if dem_cohort==0
mat tab1[`r',3] = r(sum)

local ++r
}

mat rownames tab1 = `full'


frmttable using `logpath'\Sample_Derivation.doc, replace statmat(tab1) ///
varlabels title("Sample Derivation for R01 (Deceased 2004-2015, Age 72+)") ctitles("Reason for Exclusion" "All" "Dementia" "Non-Dementia") sdec(0) ///
annotate(stars) asymbol(*,**)note("Death Date was determined by NDI, Medicare MBSF or HRS Exit in that order. Reasons for exclusion are NOT mutally exclusive.")


 */


local full1 age_lt_70 death_b4_core no_exit miss_core no_core nocore4yr hrs_lt_60m ffs_lt_60m
local full2 final 
local full3 age_lt_72 hrs_lt_84m ffs_lt_84m 
local full4 final_7yr 

local rd: word count 1 `full1' `full2' `full3' `full4'

mat tab1 = J(`rd',3,.)

sum all
mat tab1[1,1] = r(sum)

sum all if dem_cohort==1
mat tab1[1,2] = r(sum)

sum all if dem_cohort==0
mat tab1[1,3] = r(sum)


local r = 2

foreach x of local full1 {

sum `x'
mat tab1[`r',1] = r(sum)

sum `x' if dem_cohort==1
mat tab1[`r',2] = r(sum)

sum `x' if dem_cohort==0
mat tab1[`r',3] = r(sum)

drop if `x'==1
local ++r
}

foreach x of local full2 {

sum `x'
mat tab1[`r',1] = r(sum)

sum `x' if dem_cohort==1
mat tab1[`r',2] = r(sum)

sum `x' if dem_cohort==0
mat tab1[`r',3] = r(sum)

local ++r
}

foreach x of local full3 {

sum `x'
mat tab1[`r',1] = r(sum)

sum `x' if dem_cohort==1
mat tab1[`r',2] = r(sum)

sum `x' if dem_cohort==0
mat tab1[`r',3] = r(sum)

drop if `x'==1
local ++r
}

foreach x of local full4 {

sum `x'
mat tab1[`r',1] = r(sum)

sum `x' if dem_cohort==1
mat tab1[`r',2] = r(sum)

sum `x' if dem_cohort==0
mat tab1[`r',3] = r(sum)

local ++r
}




mat rownames tab1 = all `full1' `full2' `full3' `full4'


frmttable using `logpath'\Sample_Derivation.doc, replace statmat(tab1) ///
varlabels title("Sample Derivation for R01 (Deceased 2004-2015, Age 72+)") ctitles("Reason for Exclusion" "All" "Dementia" "Non-Dementia") sdec(0) ///
annotate(stars) asymbol(*,**)note("Death Date was determined by NDI, Medicare MBSF or HRS Exit in that order. Reasons for exclusion are ARE mutally exclusive.")

cap log close


restore
keep if final==1
save R01_j.dta, replace




H="Annual Calculations"
global datapath "E:\data\burden_dementia\int_data"
*local logpath "E:\data\burden_dementia\logs"
global ooppath "E:\data\burden_dementia\oopdata"
global output "E:\projects\burden_dementia\archive logs"


/* Start with OOP dataset and then get interview dates for core and exit + death date */

use $ooppath\oopme_final_2016.dta, clear
drop nh_nights
rename *, l
gen id=hhid+pn

replace private_ltc=long_term_care if !missing(long_term_care)
foreach x in mc_b private_ltc {
	replace `x'_prem=`x'
	drop `x'
}



rename year core_year
merge 1:1 hhid pn core_year using "E:\data\hrs_cleaned\core_00_to_14.dta", keepus(c_ivw_date c_ivw_month c_ivw_year nh_nights)
gen core = 1 if _m==3
gen exit_year = core_year if iwtype==1

cap drop _m

merge m:1 hhid pn exit_year using "E:\data\hrs_cleaned\exit_02_to_16_dt.dta", keepus(e_ivw_date nh_nights_exit)
gen exit = 1 if _m==3
drop if _m==2
cap drop _m

replace nh_nights = nh_nights_exit if nh_nights==.

tempfile temp
save `temp'

use $datapath\R01_j.dta, clear
keep if nflag==0
tempfile ro1
save `ro1'

use `temp', clear

merge m:1 id using "`ro1'", keepus(index_date index_month index_year final final_7yr dem_cohort n1_2_death)
*keep if inrange(index_year,2004,2015)
*drop if _m==1
keep if _m==3

drop if core_year<1998 // dropping core interviews earlier than 1998

gsort id -core_year
by id: gen nflag = _n-1

/* dropping people with exit interviews before 2004 because earliest death year is 2004 */

gen droplist = 0
levelsof id if nflag==0 & iwtype==1 & exit_year<2004, local(drop) 

foreach x of local drop {
replace droplist = 1 if id=="`x'"
}

drop if droplist==1

gen year = core_year
drop _m
merge 1:1 id year using "E:\data\hrs_cleaned\helper_hours_2016.dta", keepus(n_i hlphrs_i)
drop if _m==2
drop _m

gsort id -year 
by id: gen next_date = c_ivw_date[_n+1]
format index_date next_date %td

gen death2_n1 = index_date - next_date if nflag==0

levelsof id if death2_n1<-30, local(drop)

foreach x of local drop {
replace droplist = 1 if id=="`x'"
}
drop if droplist==1

replace death2_n1 = death2_n1 * 0.0329
replace death2_n1 = ceil(death2_n1)
replace death2_n1 = 1 if death2_n1==0
replace months = death2_n1 if exit==1


/* Capping OOP RX spending to $300/month to bring in line with Medicare Part D and
previous OOP paper */

replace rx_oop = 0 if rx_oop==.
gen rx_per_mo = rx_oop/months
replace rx_per_mo = 300 if rx_per_mo>0 & rx_per_mo!=.

gen mod_rx_oop = rx_per_mo * months

replace total_oop = total_oop - rx_oop + mod_rx_oop

/* Modifying Helper HRS + Helper OOP to match Helper hours imputation in previous OOP paper */

gsort id -year

replace hlphrs_i = 720 if hlphrs_i>720 & hlphrs_i!=. // capping helperhrs reported to 24hrs(max)*30days per person

by id: gen prev_help_hrs = 1 if hlphrs_i[_n+1]>0 & hlphrs_i[_n+1]!=. //check for helper hrs at prev ivw
by id: gen prev_hrs = hlphrs_i[_n+1] if hlphrs_i[_n+1]>0
by id: gen prev_oop_yes = 1 if helper_oop[_n+1]>0 & helper_oop[_n+1]!=.
by id: gen prev_hlp_oop = (helper_oop[_n+1]/months[_n+1]) if helper_oop[_n+1]>0

gen helper_oop_per_mo = helper_oop/months
gen mod_helper_oop = helper_oop_per_mo * 4 if prev_oop_yes==. & months>=4
replace mod_helper_oop = helper_oop_per_mo * months if months<4
replace mod_helper_oop = (helper_oop_per_mo*4) + (months-4)*((helper_oop_per_mo+prev_hlp_oop)/2) ///
if prev_oop_yes==1 & months>=4
*replace mod_helper_oop = 

replace total_oop = total_oop - helper_oop + mod_helper_oop

/* Creating approximate 2/4 year helper hours based on above fomula */

gen total_hlp = hlphrs_i*4 if prev_help_hrs==. & months>=4
replace total_hlp=hlphrs_i*months if months<4
replace total_hlp = (hlphrs_i*4) + (months-4)*((hlphrs_i+prev_hrs)/2) ///
if prev_help_hrs==1 & months>=4

replace total_hlp = 0 if total_hlp==. // estimated total hours per interview



/* Create year variables to merge helper hours with yearly genworth costs */

gen c_ivw_year_n0 = c_ivw_year
replace c_ivw_year_n0 = index_year if nflag==0
gen c_ivw_year_n1 = c_ivw_year_n0 - 1
label var c_ivw_year_n1 "calendar year prior to ivw date"
gen c_ivw_year_n2 = c_ivw_year_n0 - 2
label var c_ivw_year_n2 "calendar year 2 yrs prior to ivw date"
gen c_ivw_year_n3 = c_ivw_year_n0 - 3
label var c_ivw_year_n3 "calendar year 3 yrs prior to ivw date"
gen c_ivw_year_n4 = c_ivw_year_n0 - 4
label var c_ivw_year_n4 "calendar year 4 yrs prior to ivw date"
gen c_ivw_year_n5 = c_ivw_year_n0 - 5
label var c_ivw_year_n5 "calendar year 5 yrs prior to ivw date"

cap drop stateusups

save $datapath/R01_cost_int.dta, replace


/************** Get State information from tracker to match with genworth *************/
cd $datapath

use r01_cost_int.dta, clear
keep id

duplicates drop id, force
tempfile id
save `id'

// creating CPI-U 
clear
set obs 21
gen obs = _n
gen year = .
gen cpi_rate = .

forvalues i=1/21 {

replace year = 2017 - `i' if obs==`i'

}

replace cpi_rate = 1 if year==2016
replace cpi_rate=1.01262 if year==2015
replace cpi_rate=1.01382 if year==2014
replace cpi_rate=1.03026 if year==2013
replace cpi_rate=1.04535 if year==2012
replace cpi_rate=1.06699 if year==2011
replace cpi_rate=1.10067 if year==2010
replace cpi_rate=1.11872 if year<=2009/*
replace cpi_rate=1.11474 if year==2008
replace cpi_rate=1.15754 if year==2007
replace cpi_rate=1.19051 if year==2006
replace cpi_rate=1.22891 if year==2005
replace cpi_rate=1.27055 if year==2004
replace cpi_rate=1.30439 if year==2003
replace cpi_rate=1.33411 if year==2002
replace cpi_rate=1.35521 if year==2001
replace cpi_rate=1.39377 if year==2000
replace cpi_rate=1.44062 if year==1999
replace cpi_rate=1.47244 if year<=1998
*/
rename year c_ivw_year
label var cpi_rate "Inflation adjustment factor"
tempfile cpi
save `cpi'

// pull tracker
use "E:\data\hrs_cleaned\restr_tracker_v2014.dta", clear
drop id
gen id=hhid+pn

merge 1:1 id using "`id'"
keep if _m==3

keep hhid pn stateusps* zipcode*

gen stateusps16 = stateusps14
gen zipcode16 = zipcode14

foreach x of varlist stateusps* {

replace `x' = "" if `x'=="ZZ"

}

gen stateusps97=""
gen stateusps99=""

forvalues i= 1(2)15{
gen stateusps`i'=""
gen zipcode`i' = ""
}

forvalues i=0(2)8{
rename stateusps0`i' stateusps`i'
rename zipcode0`i' zipcode`i'
}
reshape long stateusps zipcode, i(hhid pn) j(c_ivw_year)

forvalues i=0/99{
qui replace c_ivw_year=200`i' if c_ivw_year==`i' & c_ivw_year<=9
qui replace c_ivw_year=20`i' if c_ivw_year==`i' & inrange(c_ivw_year, 10,16)
qui replace c_ivw_year=19`i' if c_ivw_year==`i' & c_ivw_year>=90
}

gen id= hhid+pn
sort id c_ivw_year
drop if id==""
by id: carryforward stateusps, replace

gsort id -c_ivw_year
by id: carryforward stateusps, replace

gen e_ivw_year=c_ivw_year
merge m:1 c_ivw_year using "`cpi'", keepus(cpi_rate)
cap drop _m

rename c_ivw_year c_ivw_year_n0
tempfile state
save "`state'"


rename c_ivw_year_n0 c_ivw_year_n1
rename stateusps stateusps_n1
rename cpi_rate cpi_rate_n1
tempfile state_n1
save `state_n1'

rename c_ivw_year_n1 c_ivw_year_n2
rename stateusps_n1 stateusps_n2 
rename cpi_rate_n1 cpi_rate_n2
tempfile state_n2
save `state_n2'

rename c_ivw_year_n2 c_ivw_year_n3
rename stateusps_n2 stateusps_n3 
rename cpi_rate_n2 cpi_rate_n3
tempfile state_n3
save `state_n3'

rename c_ivw_year_n3 c_ivw_year_n4
rename stateusps_n3 stateusps_n4
rename cpi_rate_n3 cpi_rate_n4
tempfile state_n4
save `state_n4'

rename c_ivw_year_n4 c_ivw_year_n5
rename stateusps_n4 stateusps_n5
rename cpi_rate_n4 cpi_rate_n5
tempfile state_n5
save `state_n5'



use R01_cost_int.dta, clear
/*
gen e_ivw_year=year(e_ivw_date)
replace e_ivw_year=exit_year if missing(e_ivw_year)
merge m:1 id e_ivw_year using "`state'"
drop if _m==2
drop _m
*/

merge m:1 id c_ivw_year_n0 using "`state'"
drop if _m==2
cap drop _m
merge m:1 id c_ivw_year_n1 using "`state_n1'"
drop if _m==2
cap drop _m
merge m:1 id c_ivw_year_n2 using "`state_n2'"
drop if _m==2
cap drop _m
merge m:1 id c_ivw_year_n3 using "`state_n3'"
drop if _m==2
cap drop _m
merge m:1 id c_ivw_year_n4 using "`state_n4'"
drop if _m==2
cap drop _m
merge m:1 id c_ivw_year_n5 using "`state_n5'"
drop if _m==2
cap drop _m


save R01_cost_intb.dta, replace

//merging with the Genworth/Metlife hourly home health aide cost. 
import excel "E:\data\burden_dementia\ref_data\Cost Care Survey (Genworth-Metlife)\HHA_hourly_genworth.xlsx", sheet("Sheet1") firstrow clear

rename A c_ivw_year
rename B stateusps
rename HomeHealthAideServicesHourly state_hha
rename MedianHourlyRate hr_rate

drop if c_ivw_year==.
destring hr_rate, replace

expand 2 if c_ivw_year==1998, gen(duptag)

replace c_ivw_year = c_ivw_year - 1 if duptag==1
cap drop duptag

expand 2 if c_ivw_year==1997, gen(duptag)

replace c_ivw_year = c_ivw_year - 1 if duptag==1
drop duptag

//3/6/19-ebl-was not merging with exit data, so we were missing those years
gen e_ivw_year=c_ivw_year

rename c_ivw_year c_ivw_year_n0

tempfile rate
save "`rate'" // hourly rate for calendar c_ivw_year of i

rename c_ivw_year_n0 c_ivw_year_n1
rename stateusps stateusps_n1
rename state_hha state_hha_n1
rename hr_rate hr_rate_n1

tempfile rate_n1
save "`rate_n1'"

rename c_ivw_year_n1 c_ivw_year_n2
rename stateusps_n1 stateusps_n2
rename state_hha_n1 state_hha_n2
rename hr_rate_n1 hr_rate_n2

tempfile rate_n2
save "`rate_n2'"

rename c_ivw_year_n2 c_ivw_year_n3
rename stateusps_n2 stateusps_n3
rename state_hha_n2 state_hha_n3
rename hr_rate_n2 hr_rate_n3

tempfile rate_n3
save "`rate_n3'"

rename c_ivw_year_n3 c_ivw_year_n4
rename stateusps_n3 stateusps_n4
rename state_hha_n3 state_hha_n4
rename hr_rate_n3 hr_rate_n4

tempfile rate_n4
save "`rate_n4'"

rename c_ivw_year_n4 c_ivw_year_n5
rename stateusps_n4 stateusps_n5
rename state_hha_n4 state_hha_n5
rename hr_rate_n4 hr_rate_n5

tempfile rate_n5
save "`rate_n5'"


use R01_cost_intb.dta, clear
cap drop _m
merge m:1 c_ivw_year_n0 stateusps using "`rate'"
drop if _m==2
cap drop _m
/*
merge m:1 e_ivw_year stateusps using "`rate'"
drop if _m==2
cap drop _m
*/
merge m:1 c_ivw_year_n1 stateusps_n1 using "`rate_n1'"
drop if _m==2
cap drop _m
merge m:1 c_ivw_year_n2 stateusps_n2 using "`rate_n2'"
drop if _m==2
cap drop _m
merge m:1 c_ivw_year_n3 stateusps_n3 using "`rate_n3'"
drop if _m==2
cap drop _m
merge m:1 c_ivw_year_n4 stateusps_n4 using "`rate_n4'"
drop if _m==2
cap drop _m
merge m:1 c_ivw_year_n5 stateusps_n5 using "`rate_n5'"
drop if _m==2
cap drop _m


save R01_cost_intc.dta, replace

use R01_cost_intc.dta, replace

gen mar_n0 = . //months observed (aka "at risk") within a calendar year for helper hours cost imputation
gen mar_n1 = .
gen mar_n2 = .
gen mar_n3 = .
gen mar_n4 = .
gen mar_n5 = .


// exit ivw
replace mar_n0 = index_month if nflag==0
replace mar_n0 = death2_n1 if (death2_n1-mar_n0 < 0) & nflag==0 // if they died the same year as their N1 ivw, then

replace mar_n1 = death2_n1 - mar_n0 if nflag==0
replace mar_n1 = 0 if mar_n1<0 & nflag==0
replace mar_n1 = 12 if (mar_n1>12 & mar_n1!=.) & nflag==0

replace mar_n2 = death2_n1 - mar_n0 -mar_n1 if nflag==0
replace mar_n2 = 0 if mar_n2<0 & nflag==0
replace mar_n2 = 12 if (mar_n2>12 & mar_n2!=.) & nflag==0

replace mar_n3 = death2_n1 - mar_n0 -mar_n1 -mar_n2 if nflag==0
replace mar_n3 = 0 if mar_n3<0 & nflag==0
replace mar_n3 = 12 if (mar_n3>12 & mar_n3!=.) & nflag==0

replace mar_n4 = death2_n1 - mar_n0 -mar_n1 -mar_n2 - mar_n3 if nflag==0
replace mar_n4 = 0 if mar_n4<0 & nflag==0
replace mar_n4 = 12 if (mar_n4>12 & mar_n4!=.) & nflag==0

// core ivw

replace mar_n0 = c_ivw_month if nflag>0
replace mar_n1 = months - c_ivw_month if nflag>0
replace mar_n1 = 0 if mar_n1<0 & nflag>0
replace mar_n1 = 12 if (mar_n1>12 & mar_n1!=.) & nflag>0

replace mar_n2 = months - 12 - c_ivw_month if nflag>0
replace mar_n2 = 0 if mar_n2<0 & nflag>0
replace mar_n2 = 12 if (mar_n2>12 & mar_n2!=.) & nflag>0

replace mar_n3 = months - 24 - c_ivw_month if nflag>0
replace mar_n3 = 0 if mar_n3<0 & nflag>0
replace mar_n3 = 12 if (mar_n3>12 & mar_n3!=.) & nflag>0

replace mar_n4 = months - 36 - c_ivw_month if nflag>0
replace mar_n4 = 0 if mar_n4<0 & nflag>0
replace mar_n4 = 12 if (mar_n4>12 & mar_n4!=.) & nflag>0

replace mar_n5 = months - 48 - c_ivw_month if nflag>0
replace mar_n5 = 0 if mar_n5<0 & nflag>0
replace mar_n5 = 12 if (mar_n5>12 & mar_n5!=.) & nflag>0



// impute mean hourly rate for people missing states
//3/5/19-ebl-replace with national median in 2016
//3/6/19-ebl-hopefully fixed the merging issue with exits, so there shouldn't be missingness, leaving commented out for now
/*
foreach x in "" _n1 _n2 _n3 _n4 _n5 {
	replace cpi_rate`x'=1 if missing(cpi_rate`x')
	replace hr_rate`x'=20.25 if missing(hr_rate`x')
}

*/
foreach x of varlist mar_n0 mar_n1 mar_n2 mar_n3 mar_n4 mar_n5 hr_rate hr_rate_n1 hr_rate_n2 hr_rate_n3 hr_rate_n4 hr_rate_n5 cpi_rate cpi_rate_n1 cpi_rate_n2 cpi_rate_n3 cpi_rate_n4 cpi_rate_n5 {

replace `x' = 0 if `x'==.
}



foreach x of varlist total_hlp {

*replace `x' = `x'/months // average # of helpers per month after 4/20 split
replace `x' = (`x'*hr_rate*cpi_rate) 
}


foreach x in mc_b_prem private_ltc_prem nh_nights nh_oop {
	replace `x'=0 if missing(`x')
	replace `x' = `x'/months
}

save R01_cost_intd.dta, replace

use R01_cost_intd.dta, replace

cap drop hlp

gen hlp = total_hlp / months

cap drop oop 
gen oop = total_oop / months

keep id core_year nflag oop hlp months final final_7yr dem_cohort index_year mc_b_prem private_ltc_prem nh_nights nh_oop

reshape wide core_year oop hlp months mc_b_prem private_ltc_prem nh_nights nh_oop, i(id) j(nflag)

forvalues i = 1/7 {

foreach x in x in hlp oop mc_b_prem private_ltc_prem nh_nights nh_oop {

gen `x'_y`i'=.

}

}
// Annualized Costs - Year 1

* start with oop at exit if months < 12. Subtract months - 12 so that it can be pulled from N1
foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y1 = `x'0 * months0 if months0<12
}

replace months0 = months0 - 12 if months0<12

* Pulling the leftover months from N1 (if exit < 12)
foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y1 = `x'_y1 + (-months0)*`x'1 if months0<0
}

replace months1 = months1 + months0 if months0<0

*Using full exit if exit months==12
foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y1 = `x'0 * 12 if months0==12
}

replace months0 = 0 if months0==12

* Using 12 months from exit if exit months>12
foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y1 = `x'0 * 12 if months0>12 & months0!=.
}

replace months0 = months0 - 12 if months0>12 & months0!=.
replace months0 = . if months0 <=0

// Annualized Costs - Year 2

* People with leftover oop exit data
foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y2 = `x'0  * months0 if months0<12
}

replace months0 = months0 - 12 if months0<12


foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y2 = `x'_y2 + (-months0)*`x'1 if months0<0
}

replace months1 = months1 + months0 if months0<0

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y2 = `x'0 * 12 if months0==12
}

replace months0 = months0 - 12 if months0==12

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y2 = `x'0 * 12 if months0>12 & months0!=.
}

replace months0 = months0 - 12 if months0>12 & months0!=.


* People with no exit data leftover from y1

gen noop = 1 if oop_y2==.

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y2 = `x'1 * months1 if months1<12 & noop==1
}
replace months1 = months1 - 12 if months1<12 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y2 = `x'_y2 + (-months1)*`x'2 if months1<0 & noop==1
}

replace months2 = months2 + months1 if months1<0 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y2 = `x'1 * 12 if months1==12 & noop==1
}

replace months1 = months1 - 12 if months1==12 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y2 = `x'1 * 12 if months1>12 & months1!=. & noop==1
}
replace months1 = months1 - 12 if months1>12 & months1!=. & noop==1
replace months0 = . if months0<=0
replace months1 = . if months1<=0
drop noop

// oop_y3

* People with leftover oop exit data
foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y3 =  `x'0 * months0 if months0<12
}
replace months0 = months0 - 12 if months0<12

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y3 = `x'_y3 + (-months0)*`x'1 if months0<0
}
replace months1 = months1 + months0 if months0<0

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y3 = `x'0 * 12 if months0==12
}

replace months0 = months0 - 12 if months0==12

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y3 =  `x'0 * 12 if months0>12 & months0!=.
}

replace months0 = months0 - 12 if months0>12 & months0!=.

* People with leftover N1

gen noop = 1 if oop_y3==.

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y3 =  `x'1 * months1 if months1<12 & noop==1
}
replace months1 = months1 - 12 if months1<12 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y3 =  `x'_y3 + (-months1)*`x'2 if months1<0 & noop==1
}
replace months2 = months2 + months1 if months1<0 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y3 =  `x'1 * 12 if months1==12 & noop==1
}

replace months1 = months1 - 12 if months1==12 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y3 =  `x'1 * 12 if months1>12 & months1!=. & noop==1
}
replace months1 = months1 - 12 if months1>12 & months1!=. & noop==1

drop noop

* People who exhausted N0 & N1

gen noop = 1 if oop_y3==.

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y3 =   `x'2 * 12 if noop==1
}
replace months2 = months2 - 12 if noop==1

replace months0 = . if months0<=0
replace months1 = . if months1<=0
replace months2 = . if months2<=0

drop noop 

// Annual Costs - Year 4


* People with leftover oop exit data
foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y4 =  `x'0 * months0 if months0<12
}
replace months0 = months0 - 12 if months0<12

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y4 =  `x'_y4 + (-months0)*`x'1 if months0<0
}
replace months1 = months1 + months0 if months0<0

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y4 =  `x'0 * 12 if months0==12
}
replace months0 = months0 - 12 if months0==12

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y4 =  `x'0 * 12 if months0>12 & months0!=.
}
replace months0 = months0 - 12 if months0>12 & months0!=.

* People with leftover N1

gen noop = 1 if oop_y4==.

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y4 =   `x'1 * months1 if months1<12 & noop==1
}
replace months1 = months1 - 12 if months1<12 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y4 =  `x'_y4 + (-months1)*`x'2 if months1<0 & noop==1
}
replace months2 = months2 + months1 if months1<0 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y4 =  `x'1 * 12 if months1==12 & noop==1
}
replace months1 = months1 - 12 if months1==12 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y4 =  `x'1 * 12 if months1>12 & months1!=. & noop==1
}

replace months1 = months1 - 12 if months1>12 & months1!=. & noop==1

drop noop

* People who exhausted N0 & N1

gen noop = 1 if oop_y4==.

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y4 =  `x'2 * months2 if months2<12 & noop==1
}

replace months2 = months2 - 12 if months2<12 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y4 =  `x'_y4 + (-months2)*`x'3 if months2<0 & noop==1
}
replace months3 = months3 + months2 if months2<0 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y4 =  `x'2 * 12 if months2==12 & noop==1
}
replace months2 = months2 - 12 if months2==12 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y4 =  `x'2 * 12 if months2>12 & months2!=. & noop==1
}

replace months2 = months2 - 12 if months2>12 & months2!=. & noop==1

replace months0 = . if months0<=0
replace months1 = . if months1<=0
replace months2 = . if months2<=0

drop noop 


// oop_y5

* People with leftover oop exit data
foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y5 =  `x'0 * months0 if months0<12
}
replace months0 = months0 - 12 if months0<12

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y5 =  `x'_y5 + (-months0)*`x'1 if months0<0
}

replace months1 = months1 + months0 if months0<0

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y5 =  `x'0 * 12 if months0==12
}

replace months0 = months0 - 12 if months0==12

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y5 =  `x'0 * 12 if months0>12 & months0!=.
}
replace months0 = months0 - 12 if months0>12 & months0!=.

* People with leftover N1

gen noop = 1 if oop_y5==.

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y5 =  `x'1 * months1 if months1<12 & noop==1
}

replace months1 = months1 - 12 if months1<12 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y5 =  `x'_y5 + (-months1)*`x'2 if months1<0 & noop==1
}
replace months2 = months2 + months1 if months1<0 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y5 =  `x'1 * 12 if months1==12 & noop==1
}

replace months1 = months1 - 12 if months1==12 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y5 =  `x'1 * 12 if months1>12 & months1!=. & noop==1
}
replace months1 = months1 - 12 if months1>12 & months1!=. & noop==1

drop noop

* People who exhausted N0 & N1

gen noop = 1 if oop_y5==.

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y5 =  `x'2 * months2 if months2<12 & noop==1
}
replace months2 = months2 - 12 if months2<12 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y5 = `x'_y5 + (-months2)*`x'3 if months2<0 & noop==1
}

replace months3 = months3 + months2 if months2<0 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y5 = `x'2 * 12 if months2==12 & noop==1
}

replace months2 = months2 - 12 if months2==12 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y5 = `x'2 * 12  if months2>12 & months2!=. & noop==1
}

replace months2 = months2 - 12 if months2>12 & months2!=. & noop==1

drop noop 

* People who exhausted N0, N1 & N2

gen noop = 1 if oop_y5==.

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y5 = `x'3 * 12 if noop==1
}

replace months3 = months3 - 12 if noop==1


replace months0 = . if months0<=0
replace months1 = . if months1<=0
replace months2 = . if months2<=0
replace months3 = . if months3<=0

drop noop

// oop_y6

* People with leftover N1

gen noop = 1 if oop_y6==.

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y6 = `x'1 * months1 if months1<12 & noop==1
}

replace months1 = months1 - 12 if months1<12 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y6 = `x'_y6 + (-months1)*`x'2 if months1<0 & noop==1
}

replace months2 = months2 + months1 if months1<0 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y6 = `x'1 * 12 if months1==12 & noop==1
}

replace months1 = months1 - 12 if months1==12 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y6 = `x'1 * 12 if months1>12 & months1!=. & noop==1
}

replace months1 = months1 - 12 if months1>12 & months1!=. & noop==1

drop noop

* People who exhausted N0 & N1

gen noop = 1 if oop_y6==.


foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y6 = `x'2 * months2 if months2<12 & noop==1
}

replace months2 = months2 - 12 if months2<12 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y6 = `x'_y6 + (-months2)*`x'3 if months2<0 & noop==1
}

replace months3 = months3 + months2 if months2<0 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y6 = `x'2 * 12 if months2==12 & noop==1
}

replace months2 = months2 - 12 if months2==12 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y6 = `x'2 * 12 if months2>12 & months2!=. & noop==1
}

replace months2 = months2 - 12 if months2>12 & months2!=. & noop==1

drop noop 

* People who exhausted N0, N1 & N2

gen noop = 1 if oop_y6==.

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y6 = `x'3 * months3 if months3<12 & noop==1
}
replace months3 = months3 - 12 if months3<12 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y6 =  `x'_y6 + (-months3)*`x'4 if months3<0 & noop==1
}

replace months4 = months4 + months3 if months3<0 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y6 =  `x'3 * 12 if months3==12 & noop==1
}


replace months3 = months3 - 12 if months3==12 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y6 =  `x'3 * 12 if months3>12 & months3!=. & noop==1
}

replace months3 = months3 - 12 if months3>12 & months3!=. & noop==1


replace months0 = . if months0<=0
replace months1 = . if months1<=0
replace months2 = . if months2<=0
replace months3 = . if months3<=0

drop noop

// Annual Costs - Year 7

* People with leftover N1

gen noop = 1 if oop_y7==.

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y7 =  `x'1 * months1 if months1<12 & noop==1
}

replace months1 = months1 - 12 if months1<12 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y7 =`x'_y7 + (-months1)*`x'2 if months1<0 & noop==1
}

replace months2 = months2 + months1 if months1<0 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y7 = `x'1 * 12 if months1==12 & noop==1
}

replace months1 = months1 - 12 if months1==12 & noop==1


foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y7 = `x'1 * 12 if months1>12 & months1!=. & noop==1
}

replace months1 = months1 - 12 if months1>12 & months1!=. & noop==1

drop noop

* People who exhausted N0 & N1

gen noop = 1 if oop_y7==.

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y7 = `x'2 * months2 if months2<12 & noop==1
}
replace months2 = months2 - 12 if months2<12 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y7 = `x'_y7 + (-months2)*`x'3 if months2<0 & noop==1
}
replace months3 = months3 + months2 if months2<0 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y7 =  `x'2 * 12 if months2==12 & noop==1
}
replace months2 = months2 - 12 if months2==12 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y7 =  `x'2 * 12 if months2>12 & months2!=. & noop==1
}

replace months2 = months2 - 12 if months2>12 & months2!=. & noop==1

drop noop 

* People who exhausted N0, N1 & N2

gen noop = 1 if oop_y7==.

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y7 = `x'3 * months3 if months3<12 & noop==1
}

replace months3 = months3 - 12 if months3<12 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y7 =  `x'_y7 + (-months3)*`x'4 if months3<0 & noop==1
}
replace months4 = months4 + months3 if months3<0 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y7 = `x'3 * 12 if months3==12 & noop==1
}

replace months3 = months3 - 12 if months3==12 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y7 = `x'3 * 12 if months3>12 & months3!=. & noop==1
}

replace months3 = months3 - 12 if months3>12 & months3!=. & noop==1


replace months0 = . if months0<=0
replace months1 = . if months1<=0
replace months2 = . if months2<=0
replace months3 = . if months3<=0

drop noop
* People who exhausted N0, N1, N2 & N3

gen noop = 1 if oop_y7==.

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y7 = `x'4 * 12 if noop==1
}




gen oop_7yr = oop_y1+ oop_y2+ oop_y3+ oop_y4+ oop_y5 + oop_y6 + oop_y7
gen oop_6yr = oop_y1+ oop_y2+ oop_y3+ oop_y4+ oop_y5 + oop_y6
gen oop_5yr = oop_y1+ oop_y2+ oop_y3+ oop_y4+ oop_y5
gen oop_4yr = oop_y1+ oop_y2+ oop_y3+ oop_y4
gen oop_3yr = oop_y1+ oop_y2+ oop_y3
gen oop_2yr = oop_y1+ oop_y2

ttest oop_5yr, by(dem_cohort)
ttest oop_5yr if final_7yr==1, by(dem_cohort)
ttest oop_7yr if final_7yr==1, by(dem_cohort)

forvalues i = 1/7 {

rename hlp_y`i' informal_y`i'
}


gen informal_7yr = informal_y1+ informal_y2+ informal_y3+ informal_y4+ informal_y5 + informal_y6 + informal_y7
gen informal_6yr = informal_y1+ informal_y2+ informal_y3+ informal_y4+ informal_y5 + informal_y6
gen informal_5yr = informal_y1+ informal_y2+ informal_y3+ informal_y4+ informal_y5
gen informal_4yr = informal_y1+ informal_y2+ informal_y3+ informal_y4
gen informal_3yr = informal_y1+ informal_y2+ informal_y3
gen informal_2yr = informal_y1+ informal_y2

ttest informal_5yr, by(dem_cohort)
ttest informal_5yr if final_7yr==1, by(dem_cohort)
ttest informal_7yr if final_7yr==1, by(dem_cohort)

save R01_annualized.dta, replace




H="Final Sample & Table 1"

import excel "E:\data\hrs_restricted_2014\Ref Docs\Medicaid generosity.xlsx", sheet("Sheet1") firstrow case(lower) clear
rename location stateusps
tempfile generosity
save `generosity'

clear all
capture log close

global datapath "E:\data\burden_dementia\int_data"
global final "E:\data\burden_dementia\final_data"
local logpath "E:\data\burden_dementia\logs"
global ooppath "E:\data\burden_dementia\oopdata"
global output "E:\projects\burden_dementia\archive logs"

cd $datapath

use "E:\data\burden_dementia\int_data\predicted_annual_medicaid_costs.dta", clear

rename year index_year

tempfile predict
save `predict'


use R01_j.dta, clear

merge m:1 id using R01_annualized.dta, keepus(oop_5yr oop_7yr informal_5yr informal_7yr oop_y* informal_y* mc_b_prem_y* ///
private_ltc_prem_y* nh_nights_y* nh_oop_y*)
drop _m

merge m:1 id using tot_paid_maid.dta, keepus(tot_paid_m* tot_nf_days*)
rename tot_nf_days_maid_n* tot_nf_days_y*

drop if _m==2
cap drop _m

merge m:1 id index_year using `predict', keepus(buyin_mo generous ind_mcaid_imp)
drop if _m==2
cap drop _m

drop generous
merge m:1 stateusps using `generosity', gen(gm)
drop if gm==2

destring genworth_nh, replace

sort id nflag
by id: egen anychampus=max(champus)
replace champus_exit=anychampus if missing(champus_exit)

forvalues i=1/7 {
	foreach x in nh_nights n_snf_days private_ltc_prem nh_oop tot_nf_days {
		replace `x'_y`i'=0 if missing(`x'_y`i')
}
	replace nh_oop_y`i'=365*genworth if nh_oop_y`i'>365*genworth
	replace nh_nights_y`i'=365 if nh_nights_y`i'>365 
	gen imputed_nh_costs_a_y`i'=0
	gen imputed_nh_costs_b_y`i'=(nh_nights_y`i'-n_snf_days_y`i'-tot_nf_days_y`i'- ///
	(.8*private_ltc_prem_y`i'+nh_oop_y`i')/genworth)*genworth ///
	if champus_exit==1 | private_ltc_prem_y`i'>0 | ltc_ins_exit==1
	replace imputed_nh_costs_b_y`i'=0 if !champus_exit & !private_ltc_prem_y`i' 
	gen imputed_nh_costs_c_y`i'=(nh_nights_y`i'-n_snf_days_y`i'-tot_nf_days_y`i'- ///
	(.8*private_ltc_prem_y`i'+nh_oop_y`i')/genworth)*genworth	
	gen imputed_nh_costs_d_y`i'=(nh_nights_y`i'-n_snf_days_y`i'-tot_nf_days_y`i'- ///
	(.8*private_ltc_prem_y`i'+nh_oop_y`i')/genworth)*genworth
	foreach x in a b c d {
		if "`x'"!="c" replace imputed_nh_costs_`x'_y`i'=0 if imputed_nh_costs_`x'_y`i'<0
}
	replace imputed_nh_costs_b_y`i'=0 if !champus_exit & !private_ltc_prem_y`i' & ltc_ins_exit!=1
	label var imputed_nh_costs_a_y`i' "Imputed NH Costs, year `i': Conservative (0 for all)"
	label var imputed_nh_costs_b_y`i' "Imputed NH Costs, year `i': Moderate (only for those with LTC/VA coverage)"
	label var imputed_nh_costs_c_y`i' "Imputed NH Costs, year `i': SR nights as gold standard (all, allows negative values for SR nights)"
	label var imputed_nh_costs_d_y`i' "Imputed NH Costs, year `i': Comprehensive (imputed for all, no negative values)"
	gen unat_nights`i'=imputed_nh_costs_c_y`i'/genworth
	label var unat_nights`i' "Unattributed NH nights, year `i': Comprehensive"
	
}


gen ffs_7yr = 0 
replace ffs_7yr = 1 if cont_ffs_n_mos>=84 & cont_ffs_n_mos!=.

gen ffs_6yr = 0 
replace ffs_6yr = 1 if cont_ffs_n_mos>=72 & cont_ffs_n_mos!=.

gen ffs_5yr = 0
replace ffs_5yr = 1 if cont_ffs_n_mos>=60 & cont_ffs_n_mos!=.

gen ffs_4yr = 0
replace ffs_4yr = 1 if cont_ffs_n_mos>=48 & cont_ffs_n_mos!=.

gen ffs_3yr = 0
replace ffs_3yr = 1 if cont_ffs_n_mos>=36 & cont_ffs_n_mos!=.

gen ffs_2yr = 0
replace ffs_2yr = 1 if cont_ffs_n_mos>=24 & cont_ffs_n_mos!=.

gen ffs_1yr = 0
replace ffs_1yr = 1 if cont_ffs_n_mos>=12 & cont_ffs_n_mos!=.


gen white = 0
replace white = 1 if race==1 & hisp_eth==0

gen black = 0
replace black = 1 if race==2 & hisp_eth==0

gen other = 0 
replace other = 1 if white==0 & black==0 & hisp_eth==0

label var white "Non-Hispanic White"
label var black "Non-Hispanic Black"
label var other "Non-Hispanic Other"

label var tot_paid_maid_n1 "Total Medicaid Spending Y1"
label var tot_paid_maid_n2 "Total Medicaid Spending Y2"
label var tot_paid_maid_n3 "Total Medicaid Spending Y3"
label var tot_paid_maid_n4 "Total Medicaid Spending Y4"
label var tot_paid_maid_n5 "Total Medicaid Spending Y5"
label var tot_paid_maid_n6 "Total Medicaid Spending Y6"
label var tot_paid_maid_n7 "Total Medicaid Spending Y7"

label var oop_5yr "Cumulative 5yr OOP"
label var oop_7yr "Cumulative 7yr OOP"
label var informal_5yr "Cumulative 5yr informal"
label var informal_7yr "Cumulative 7yr informal"

forvalues i = 1/7 {
rename tot_paid_maid_n`i' tot_paid_maid_y`i'
}

local y = 1
forvalues i = 12(12)84 {



rename tot_paid_by_mc_`i'm tot_paid_by_mc_y`y'

//2/25/19-ebl-subtracting part b premium from mc expenditures
replace tot_paid_by_mc_y`y'=tot_paid_by_mc_y`y'-mc_b_prem_y`y'

label var tot_paid_by_mc_y`y' "Total Medicare Spending Y`y'"

local ++y
}

//get annual 3+ Elixhauser, dementia & baseline/per-ivw dementia


sort id nflag
forvalues i=1/7 {
	gen comorb_ge3_y`i'=inrange(comorb_all_`=(`i'-1)*12',3,31) if nflag==0
	label var comorb_ge3_y`i' "3+ Elixhauser comorbidities, `=`i'-1'-`i' years pre-death"
	rename comorb_31_`=(`i'-1)*12' comorb_31_y`i'
	replace comorb_31_y`i'=0 if missing(comorb_31_y`i') & nflag==0
	label var comorb_31_y`i' "Indicator dementia from claims, `=`i'-1'-`i' years pre-death"

}

forvalues i=1/9 {
	gen prob_dem`i'=inrange(pdem,0.5,1) if !missing(pdem) & inrange((index_date-ivw_date)/365.25,`=`i'-1',`i')
	by id: egen prob_dem_y`i'=max(prob_dem`i')
	by id: egen pdem_y`i'=max(cond(inrange((index_date-ivw_date)/365.25,`=`i'-1',`i'),pdem,.))
	drop prob_dem`i'
}

gen prob_dem=inrange(pdem,0.5,1) if !missing(pdem)
gen t2d=index_date-ivw_date
gen time_2_start=abs(t2d-floor(7*365.25))
by id: egen mint2s=min(time_2_start)
gen ind_baseline=mint2s==time_2_start
gen m2d=t2d/30.42
gen adl_dependent=!adl_independent_core
foreach x in smoke_curr married medicaid adl_dependent srh_pf prob_dem pdem m2d {
	by id: egen `x'_baseline=max(cond(ind_baseline==1,`x',.))
}

/*
carryforward age_at_death female married hseduc smoke_curr medicaid adl_dependent ///
srh_pf prob_dem_baseline pdem_baseline cum* race, replace
gen prob_dem_baseline=prob_dem_y9
gen pdem_baseline=pdem_y9
foreach x in pdem prob_dem {
	replace `x'_baseline=`x'_y8 if !missing(`x'_y8)
	//replace `x'_baseline=.
	foreach i in 7 6 {
	replace `x'_baseline=`x'_y`i' if !missing(`x'_y`i') ///
	 & missing(`x'_baseline)
}
forvalues i=8(-1)1 {
	replace `x'_y`i'=`x'_y`=`i'+1' if missing(`x'_y`i')
}
//note--50 people's baseline is year 6, so missing year 7
replace `x'_y7=`x'_baseline if missing(`x'_y7)
drop `x'_y8 `x'_y9
}
*/

save $final\R01_final.dta, replace

preserve 
keep if nflag==0
keep if final==1

gen all = 1

local ivars female white black other hospice_exit nhres_exit married_exit reschil_d_exit resspouse_exit livealone_exit adl_independent_exit adl_severe_exit medicare_exit medicareb_exit medicaid_exit champus_exit ffs_7yr ffs_6yr ffs_5yr ffs_4yr ffs_3yr ffs_2yr ffs_1yr

local medcost age_at_death tot_paid_maid_y1 tot_paid_maid_y2 tot_paid_maid_y3 tot_paid_maid_y4 tot_paid_maid_y5 tot_paid_maid_y6 tot_paid_maid_y7 tot_paid_by_mc_y1 tot_paid_by_mc_y2 tot_paid_by_mc_y3 tot_paid_by_mc_y4 tot_paid_by_mc_y5 tot_paid_by_mc_y6 tot_paid_by_mc_y7 ///
oop_y1 oop_y2 oop_y3 oop_y4 oop_y5 oop_y6 oop_y7 oop_5yr oop_7yr informal_y1 informal_y2 informal_y3 informal_y4 informal_y5 informal_y6 informal_y7 informal_5yr informal_7yr

local rd: word count `ivars' `medcost' 1

mat tab1=J(`rd', 3,.)
mat stars=J(`rd',3,0)
local r = 1

foreach x of local ivars {

sum `x' if all==1

mat tab1[`r',1] = r(mean)*100

sum `x' if all==1 & dem_cohort==1
mat tab1[`r',2] = r(mean)*100

sum `x' if all==1 & dem_cohort==0
mat tab1[`r',3] = r(mean)*100

tab `x' dem_cohort if all==1, chi2
mat stars[`r',2] = (r(p)<.01) + (r(p)<0.05)


local ++r
}

foreach x of local medcost {

sum `x' if all==1 

mat tab1[`r',1] = r(mean)

sum `x' if all==1 & dem_cohort==1
mat tab1[`r',2] = r(mean)

sum `x' if all==1 & dem_cohort==0
mat tab1[`r',3] = r(mean) 

ttest `x' if all==1, by(dem_cohort)
mat stars[`r',2] = (r(p)<.01) + (r(p)<.05)



local ++r
}


sum nflag if all==1
mat tab1[`r',1] = r(N)

sum nflag if all==1 & dem_cohort==1
mat tab1[`r',2] = r(N)

sum nflag if all==1 & dem_cohort==0
mat tab1[`r',3] = r(N)



mat rownames tab1 = `ivars' `medcost' N

frmttable using "E:\projects\burden_dementia\archive logs\R01_Table1.doc", replace statmat(tab1) ///
varlabels title("Summary Statistics For R01 Sample (Deceased 2004-2015, Age 70+ at Death, 5yr Cont. FFS)") ctitles("", "All","Dementia","No Dementia") sdec(2) ///
annotate(stars) asymbol(*,**)note("All costs have been inflation adjusted to 2016 dollars. <0.05*, p<0.01**")

/* FFS Only */


keep if final_7yr==1

local ivars female white black other hospice_exit nhres_exit married_exit reschil_d_exit resspouse_exit livealone_exit adl_independent_exit adl_severe_exit medicare_exit medicareb_exit medicaid_exit champus_exit ffs_7yr ffs_6yr ffs_5yr ffs_4yr ffs_3yr ffs_2yr ffs_1yr

local medcost age_at_death tot_paid_maid_y1 tot_paid_maid_y2 tot_paid_maid_y3 tot_paid_maid_y4 tot_paid_maid_y5 tot_paid_maid_y6 tot_paid_maid_y7 tot_paid_by_mc_y1 tot_paid_by_mc_y2 tot_paid_by_mc_y3 tot_paid_by_mc_y4 tot_paid_by_mc_y5 tot_paid_by_mc_y6 tot_paid_by_mc_y7 ///
oop_y1 oop_y2 oop_y3 oop_y4 oop_y5 oop_y6 oop_y7 oop_5yr oop_7yr informal_y1 informal_y2 informal_y3 informal_y4 informal_y5 informal_y6 informal_y7 informal_5yr informal_7yr


local rd: word count `ivars' `medcost' 1

mat tab1=J(`rd', 3,.)
mat stars=J(`rd',3,0)
local r = 1

foreach x of local ivars {

sum `x' if all==1

mat tab1[`r',1] = r(mean)*100

sum `x' if all==1 & dem_cohort==1
mat tab1[`r',2] = r(mean)*100

sum `x' if all==1 & dem_cohort==0
mat tab1[`r',3] = r(mean)*100

tab `x' dem_cohort if all==1, chi2
mat stars[`r',2] = (r(p)<.01) + (r(p)<0.05)


local ++r
}

foreach x of local medcost {

sum `x' if all==1 

mat tab1[`r',1] = r(mean)

sum `x' if all==1 & dem_cohort==1
mat tab1[`r',2] = r(mean)

sum `x' if all==1 & dem_cohort==0
mat tab1[`r',3] = r(mean) 

ttest `x' if all==1, by(dem_cohort)
mat stars[`r',2] = (r(p)<.01) + (r(p)<.05)



local ++r
}


sum nflag if all==1
mat tab1[`r',1] = r(N)

sum nflag if all==1 & dem_cohort==1
mat tab1[`r',2] = r(N)

sum nflag if all==1 & dem_cohort==0
mat tab1[`r',3] = r(N)



mat rownames tab1 = `ivars' `medcost' N

frmttable using "E:\projects\burden_dementia\archive logs\R01_Table1.doc", addtable statmat(tab1) ///
varlabels title("Summary Statistics For R01 Sample (Deceased 2004-2015, Age 72+ at Death & 7yrs Cont. FFS)") ctitles("", "All","Dementia","No Dementia") sdec(2) ///
annotate(stars) asymbol(*,**)note("All costs have been inflation adjusted to 2016 dollars. <0.05*, p<0.01**")


H="***************"


H="Merge Medicaid files and extract total cost"
libname raw 'E:\data\CMS_DUA_51675_2014\Received_20180307';
libname merged 'E:\data\CMS_DUA_51675_2014\Medicaid_merged';


/* Macro to pull raw individual years */

%macro import(source=);

%do i = 1999 %to 2012;

data max_&source._&i.;
set raw.hrs_max_&source._&i.;
type_of_claim1 = put(type_of_claim, $4.);
Com_based_LTC_flag1 = put(Com_based_LTC_flag, $4.);
run;

data max_&source._&i. (drop= type_of_claim Com_based_LTC_flag);
set max_&source._&i.;
run;


data max_&source._&i.;
set max_&source._&i. (rename=(type_of_claim1 = type_of_claim Com_based_LTC_flag1 = Com_based_LTC_flag));
run;

%end;



%mend import;


/* Macro to merge years into single file */

%macro merge(source=);

data merged.hrs_max_&source._99_12;
set max_&source._1999 max_&source._2000 max_&source._2001 max_&source._2002 max_&source._2003 max_&source._2004
max_&source._2005 max_&source._2006 max_&source._2007 max_&source._2008 max_&source._2009 max_&source._2010
max_&source._2011 max_&source._2012;
run;

%mend merge;


%import(source=ip);
%import(source=ot);
%import(source=lt);
%import(source=rx);

%merge(source=ip);
%merge(source=ot);
%merge(source=lt);
%merge(source=rx);

%macro importps(source=);

%do i = 1999 %to 2012;

data max_&source._&i.;
set raw.hrs_max_&source._&i.;
Restricted_benefits_mo_01a = strip(put(Restricted_benefits_mo_01, 8.));
Restricted_benefits_mo_02a = strip(put(Restricted_benefits_mo_02, 8.));
Restricted_benefits_mo_03a = strip(put(Restricted_benefits_mo_03, 8.));
Restricted_benefits_mo_04a = strip(put(Restricted_benefits_mo_04, 8.));
Restricted_benefits_mo_05a = strip(put(Restricted_benefits_mo_05, 8.));
Restricted_benefits_mo_06a = strip(put(Restricted_benefits_mo_06, 8.));
Restricted_benefits_mo_07a = strip(put(Restricted_benefits_mo_07, 8.));
Restricted_benefits_mo_08a = strip(put(Restricted_benefits_mo_08, 8.));
Restricted_benefits_mo_09a = strip(put(Restricted_benefits_mo_09, 8.));
Restricted_benefits_mo_10a = strip(put(Restricted_benefits_mo_10, 8.));
Restricted_benefits_mo_11a = strip(put(Restricted_benefits_mo_11, 8.));
Restricted_benefits_mo_12a = strip(put(Restricted_benefits_mo_12, 8.));
Eligible_months1 = strip(put(Eligible_months, 8.));
Private_insurance_months1 = strip(put(Private_insurance_months, 8.));
run;


data max_&source._&i. (drop= Restricted_benefits_mo_01 Restricted_benefits_mo_02 Restricted_benefits_mo_03 Restricted_benefits_mo_04 Restricted_benefits_mo_05 Restricted_benefits_mo_06
Restricted_benefits_mo_07 Restricted_benefits_mo_08 Restricted_benefits_mo_09 Restricted_benefits_mo_10 Restricted_benefits_mo_11 Restricted_benefits_mo_12 Eligible_months Private_insurance_months);
set max_&source._&i.;
run;

%end;



%mend importps;


%importps(source=ps);
%merge(source=ps);


H="Calculate annual Medicaid cost for years prior to death"
use "E:\data\burden_dementia\int_data\medicaid_cost_raw.dta", clear



/* Flag year markers, n1=[0,-12], n2=[-12,-24], n3=[-24,-36], etc. */

gen n1_flag = 0
replace n1_flag = 1 if (index_year==year) | (year==index_year-1)

gen n2_flag = 0
replace n2_flag = 1 if (year==index_year-1) | (year==index_year-2)

gen n3_flag = 0
replace n3_flag = 1 if (year==index_year-2) | (year==index_year-3)

gen n4_flag = 0
replace n4_flag = 1 if (year==index_year-3) | (year==index_year-4)

gen n5_flag = 0
replace n5_flag = 1 if (year==index_year-4) | (year==index_year-5)

gen index_day = day(index_date)

/* inflation adjustment */

gen rate = .

replace rate=1 if year==2014
replace rate=1.01622 if year==2013
replace rate=1.03111 if year==2012
replace rate=1.05245 if year==2011
replace rate=1.08567 if year==2010
replace rate=1.10347 if year==2009
replace rate=1.09955 if year==2008
replace rate=1.14177 if year==2007
replace rate=1.17429 if year==2006
replace rate=1.21217 if year==2005
replace rate=1.25323 if year==2004
replace rate=1.28661 if year==2003
replace rate=1.31593 if year==2002
replace rate=1.33674 if year==2001
replace rate=1.37477 if year==2000
replace rate=1.42098 if year==1999
replace rate=1.45237 if year==1998
forvalues p = 1/12 {

replace _`p' = _`p'*rate
}

*levelsof bid_hrs_23, local(bid_check)

*foreach x of local bid_check { 

forvalues t=1/12 {

preserve
keep if index_month==`t'

forvalues i=1/5 {

gen sum_n`i'_cyr= 0 if n`i'_flag==1 /*sum months before index month in current year*/

local j = index_month
local k = 1


	while `k' <= `j' { // while current month less than or equal index, add to past value
		while `k' < `j' {
			replace sum_n`i'_cyr = sum_n`i'_cyr + _`k' if sum_n`i'_cyr!=.
			local ++k
		}
	    replace sum_n`i'_cyr = sum_n`i'_cyr + (_`k')*(index_day/30.4) if sum_n`i'_cyr!=. // if current month = index, then prorate it
		local ++k
}

gen sum_n`i'_b4yr = 0 if n`i'_flag==1

local r = index_month
local s = 12
	while `s' >=`r' { // count backwards to get months before index in previous year
		while `s' > `r' {
		replace sum_n`i'_b4yr = sum_n`i'_b4yr + _`s' if sum_n`i'_b4yr!=.
		local --s
	}
	
	replace sum_n`i'_b4yr = sum_n`i'_b4yr + (_`s')*(1-(index_day/30.4)) if sum_n`i'_b4yr!=.
	local --s
	}
	


}
keep if n1_flag | n2_flag | n3_flag | n4_flag | n5_flag


gsort +id +year


forvalues i=1/5 {

gen tot_paid_maid_n`i' = sum_n`i'_cyr + sum_n`i'_b4yr[_n-1]
}

keep id index_date bid_hrs_23 index_year year n*_flag tot_paid_maid_n* 
save mc_costs_`t'.dta, replace

restore

}


H="Creating Medicaid files for 1-5 years prior to index"
libname clean 'E:\data\hrs_cleaned'; 
libname medi 'E:\data\CMS_DUA_51675_2014\Medicaid_merged';
libname dmouth 'E:\data\Dartmouth_misc';

/*rand data path*/
libname rand 'E:\data\hrs_public_2012\rand2012\main';

libname proj_int 'E:\data\burden_dementia\int_data';
libname proj_fin 'E:\data\burden_dementia\final_data';
libname proj_ref 'E:\data\burden_dementia\ref_data';



data hrs_max_1;
set proj_int.hrs_max_ip_meet_60m;
diff=index_date-bdos;
run;

data hrs_max_2;
set proj_int.hrs_max_lt_meet_60m;
diff=index_date-bdos;
run;

data hrs_max_3;
set proj_int.hrs_max_ot_meet_60m;
diff=index_date-bdos;
run;

data hrs_max_4;
set proj_int.hrs_max_rx_meet_60m;
diff=index_date-pfd;
bdos=pfd;
run;

%macro plus;
%do i=1 %to 4;

data a1yr&i.;
set hrs_max_&i.;
	where diff>0 and diff<365;
run;

data a2yr&i.;
set hrs_max_&i.;
	where diff>365 and diff<730;
run;

data a3yr&i.;
set hrs_max_&i.;
	where diff>730 and diff<1095;
run;

data a4yr&i.;
set hrs_max_&i.;
	where diff>1095 and diff<1460;
run;

data a5yr&i.;
set hrs_max_&i.;
	where diff>1460 and diff<1825;
run;



proc sort data= a1yr&i.; 
by bid_hrs_23 bdos;
run;

proc sort data= a2yr&i.; 
by bid_hrs_23 bdos;
run;

proc sort data= a3yr&i.; 
by bid_hrs_23 bdos;
run;

proc sort data= a4yr&i.; 
by bid_hrs_23 bdos;
run;

proc sort data= a5yr&i.; 
by bid_hrs_23 bdos;
run;


/*Creating a flag for the first observation and last observation in that year prior to index*/

data a1yr&i.;
set a1yr&i.; 
by bid_hrs_23;
	 first= first.bid_hrs_23;
	 last= last.bid_hrs_23;
run;

data a2yr&i.;
set a2yr&i.; 
by bid_hrs_23;
	 first= first.bid_hrs_23;
	 last= last.bid_hrs_23;
run;

data a3yr&i.;
set a3yr&i.; 
by bid_hrs_23;
	 first= first.bid_hrs_23;
	 last= last.bid_hrs_23;
run;

data a4yr&i.;
set a4yr&i.; 
by bid_hrs_23;
	 first= first.bid_hrs_23;
	 last= last.bid_hrs_23;
run;

data a5yr&i.;
set a5yr&i.; 
by bid_hrs_23;
	 first= first.bid_hrs_23;
	 last= last.bid_hrs_23;
run;


/* keeping the first and last observation in that year prior to index*/

data only_a1yr&i.;
set a1yr&i.;
	where first=1 or last=1;
run;

data only_a2yr&i.;
set a2yr&i.;
	where first=1 or last=1;
run;

data only_a3yr&i.;
set a3yr&i.;
	where first=1 or last=1;
run;

data only_a4yr&i.;
set a4yr&i.;
	where first=1 or last=1;
run;

data only_a5yr&i.;
set a5yr&i.;
	where first=1 or last=1;
run;

%end;

%mend;
%plus();





%macro plus;
%do i=1 %to 5;

data proj_int.ip_yrbk&i.; 
set only_a&i.yr1;
run;

data proj_int.lt_yrbk&i.; 
set only_a&i.yr2;
run;

data proj_int.ot_yrbk&i.; 
set only_a&i.yr3;
run;

data proj_int.rx_yrbk&i.; 
set only_a&i.yr4;
run;

%end;

%mend;
%plus();



H="Informal Caregiving Costs"
clear all
capture log close

//burden dementia data has the number of hours prorated. 
use "E:\data\burden_dementia\final_data\burden_dementia_sample_long.dta" , replace
 
sort id index_date
by id: carryforward index_date, replace

//formatting days to be in terms of index year instead of calendar year. 
format index_date %td
gen year_index= year(index_date)
gen day_index=day(index_date)
gen mon_index=month(index_date)
gen year_bef=year_index-yearfromdeath
gen date_bef=mdy(mon_index, day_index, year_bef) 
format date_bef %td

gen year_bef1=year_bef-1

gen beg_day=31
gen beg_mon=12
gen beg_date=mdy(beg_mon, beg_day, year_bef1) 
format beg_date %td

//getting the proportion of days in each calendar year, they were indexed for. 

gen leap_year=1 if inlist(year_bef, 2000,2004,2008,2012) 
gen leap_year1=1 if inlist(year_bef1, 1999,2003,2007,2011) 
gen leap_mon=1 if inlist(mon_index, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12)
gen leap_mon1=1 if inlist(mon_index, 1, 2)

gen leap=1 if leap_mon==1 & leap_year==1

gen leap1=1 if leap_mon1==1 & leap_year1==1

gen days= date_bef-beg_date
gen proportion=days/365 //if inlist(year_bef, 1998,1999,2001,2002,2003,2005,2006,2007,2009,2010,2011,2013,2014,2015) 
replace proportion=days/366 if /*inlist(year_bef, 2000,2004,2008,2012) &*/ leap==1

gen date_1_bef=mdy(mon_index, day_index, year_bef1)
format date_1_bef %td

gen days1=beg_date-date_1_bef
capture drop proportion1
gen proportion1=days1/365 //if inlist(year_bef1, 1998,1999,2001,2002,2003,2005,2006,2007,2009,2010,2011,2013,2014,2015) 
replace proportion1=days1/366 if /*inlist(year_bef1, 2000,2004,2008,2012) &*/ leap1==1

rename year_bef year

drop if index_date==.

tempfile index
save "`index'"

// merging together with the state information for each person
use "E:\data\hrs_cleaned\restricted_tracker_v2012.dta", replace

keep hhid pn stateusps*

gen stateusps97=""
gen stateusps99=""

forvalues i= 1(2)11{
gen stateusps`i'=""
}

forvalues i=0(2)8{
rename stateusps0`i' stateusps`i'
}
reshape long stateusps, i(hhid pn) j(year)

forvalues i=0/99{
qui replace year=200`i' if year==`i' & year<=9
qui replace year=20`i' if year==`i' & inrange(year, 10,12)
qui replace year=19`i' if year==`i' & year>=90
}

gen id= hhid+pn
sort id year
drop if id==""
by id: carryforward stateusps, replace

gsort id -year
by id: carryforward stateusps, replace

tempfile state
save "`state'"


use "`index'", replace

merge 1:1 id year using "`state'"
keep if _merge==3
drop hhid pn _merge

tempfile full
save "`full'"

//merging with the Genworth/Metlife hourly home health aide cost. 
import excel "E:\data\Cost Care Survey (Genworth-Metlife)\HHA_hourly_genworth.xlsx", sheet("Sheet1") firstrow clear

rename A year
rename B stateusps
rename HomeHealthAideServicesHourly state_hha
rename MedianHourlyRate hr_rate

drop if year==.
destring hr_rate, replace


tempfile rate
save "`rate'"

use "`full'", replace
merge m:1 year stateusps using "`rate'"
//Don't have full data on home health aide hourly rates. 
drop if id==""

//creating total cost of informal care within the index year( which spans between calendar years).
capture drop a
gen a=proportion*hlphrs_i*hr_rate

rename year year1
rename year_bef1 year
rename _merge merge1
rename hr_rate hr_rate1

merge m:1 year stateusps using "`rate'"

capture drop b
gen b= proportion1*hlphrs_i*hr_rate

// C represents the total cost of informal caregiving prorated to a year prior to the index. 
capture drop c
gen c=a+b

///need to fix names of vars
rename year year_bef1
label var year_bef1 "Year prior to index"
rename year1 year
label var year "Year of index"

rename c total

mat sum =J(6,7,.)
local r=1
foreach x in total hlphrs_i{
local c=1
forvalues i=0/6{
sum `x' if yearfromdeath==`i'
mat sum[`r',`c']=r(mean)
mat sum[`r'+1,`c']=r(min)
mat sum[`r'+2,`c']=r(max)
local c=`c'+1
}
local r=`r'+3
}



matrix colnames sum= "0" "1" "2" "3" "4" "5" "6"
/*"1999" "2000" "2001" "2002" "2003" "2004" "2005" "2006" "2007" ///
"2008" "2009" "2010" "2011" "2012" */

matrix rownames sum= "Mean Cost" "Min Cost" "Max Cost" "Mean Hours" "Min Hours" "Max Hours"

mat list sum 


frmttable using "E:\data\burden_dementia\logs\cost_hours.doc", statmat(sum) replace ///
title(Cost and Hours by Year from Death) sdec(2) note("Each column is a year from death")


H="*************"


H="graphs of spending over time"
clear all
set more off
capture log close

cd "E:\data\burden_dementia\logs"
use "E:\data\burden_dementia\final_data\R01_final.dta", clear
keep if ffs_5==1


	
keep if impute==1
drop tot_paid*p*

foreach x of varlist tot* oop* informal* {
	replace `x'=0 if missing(`x')
}


	forvalues i=12(12)60 {
		rename tot_paid_by_mc_`i'm tot_paid_by_mc`=`i'/12'
		rename tot_paid_maid_n`=`i'/12' tot_paid_by_mcaid`=`i'/12'
		rename oop_n`=`i'/12' tot_paid_oop`=`i'/12'
		rename informal_n`=`i'/12' tot_paid_informal`=`i'/12'
}

foreach x in by_mc by_mcaid oop informal{
	gen cum1_paid_`x'5=tot_paid_`x'5
	forvalues i=4(-1)1 {
		gen cum1_paid_`x'`i'=cum1_paid_`x'`=`i'+1'+tot_paid_`x'`i'
}
}

keep id tot_paid* cum1_* dem_cohort

reshape long tot_paid_by_mc tot_paid_by_mcaid tot_paid_oop cum1_paid_by_mc ///
cum1_paid_by_mcaid cum1_paid_oop tot_paid_informal cum1_paid_informal, i(id) j(year_bef_death)
replace tot_paid_by_mcaid=0 if missing(tot_paid_by_mcaid)

*preserve
replace year=-year+6
label define year 1 "5 yrs before death" 2 "4" 3 "3" 2 "4" 5 "year before death"
foreach x of varlist tot* cum* {
	*replace `x'=`x'/1.03^(year_bef-1)
}
label values year year

foreach x in tot cum1 {
	egen `x'_paid_by_all=rowtotal(`x'_paid_by_mc `x'_paid_by_mcaid `x'_paid_oop ///
	`x'_paid_informal)
}

foreach x in by_mc by_mcaid oop informal by_all {
	by dem_cohort year_bef_death, sort: egen annu_`x'=mean(tot_paid_`x')
	by dem_cohort year_bef_death, sort: egen cum_`x'=mean(cum1_paid_`x')
}

drop cum1*
preserve
drop id tot*
duplicates drop
format cum* %16.0g

foreach x of varlist annu* cum* {
	replace `x'=`x'/1000
}

label var dem_c "Dementia" 
label var year_bef "Years before death"
label var annu_by_mc "Annual Medicarenditures"
label var cum_by_mc "Cumulative Medicare "
label var annu_by_mca "Annual Medicaid "
label var cum_by_mca "Cumulative Medicaid "
label var annu_oop "Annual OOP"
label var cum_oop "Cumulative OOP"
label var annu_inf "Annual imputed inf. caregiving"
label var cum_inf "Cumulative imputed inf. caregiving "

format annu* cum* %9.2fc

log using spending_tables.txt, text replace
foreach x in by_mc by_mcaid oop inf by_all {
	list year_bef_death dem_cohort annu_`x' cum_`x', abbreviate(16)
}
log close


twoway (connected annu_by_mc year if dem_cohort==0) (connected annu_by_mc year if dem_cohort==1), ///
legend(label(1 "Non-dementia") label(2 "Probable dementia")) xlabel(1 "4-5" 2 "3-4" 3 "2-3" 4 "1-2" 5 "0-1")
graph save annu_mc_spending_over_time.gph, replace
graph export annu_mc_spending_over_time.pdf, replace
twoway (connected annu_by_mca year if dem_cohort==0) (connected annu_by_mca year if dem_cohort==1), ///
legend(label(1 "Non-dementia") label(2 "Probable dementia")) xlabel(1 "4-5" 2 "3-4" 3 "2-3" 4 "1-2" 5 "0-1")
graph save annu_mcaid_spending_over_time.gph, replace
graph export annu_mcaid_spending_over_time.pdf, replace
twoway (connected cum_by_mc year if dem_cohort==0) (connected cum_by_mc year if dem_cohort==1), ///
legend(label(1 "Non-dementia") label(2 "Probable dementia")) xlabel(1 "4-5" 2 "3-4" 3 "2-3" 4 "1-2" 5 "0-1")
graph save cum_mc_spending_over_time.gph, replace
graph export cum_mc_spending_over_time.pdf, replace
twoway (connected cum_by_mca year if dem_cohort==0) (connected cum_by_mca year if dem_cohort==1), ///
legend(label(1 "Non-dementia") label(2 "Probable dementia")) xlabel(1 "4-5" 2 "3-4" 3 "2-3" 4 "1-2" 5 "0-1")
graph save cum_mcaid_spending_over_time.gph, replace
graph export cum_mcaid_spending_over_time.pdf, replace

twoway (connected annu_oop year if dem_cohort==0) (connected annu_oop year if dem_cohort==1), ///
legend(label(1 "Non-dementia") label(2 "Probable dementia")) xlabel(1 "4-5" 2 "3-4" 3 "2-3" 4 "1-2" 5 "0-1")
graph save annu_oop_spending_over_time.gph, replace
graph export annu_oopid_spending_over_time.pdf, replace
twoway (connected cum_oop year if dem_cohort==0) (connected cum_oop year if dem_cohort==1), ///
legend(label(1 "Non-dementia") label(2 "Probable dementia")) xlabel(1 "4-5" 2 "3-4" 3 "2-3" 4 "1-2" 5 "0-1")
graph save cum_oop_spending_over_time.gph, replace
graph export cum_oop_spending_over_time.pdf, replace


twoway (connected annu_inf year if dem_cohort==0) (connected annu_inf year if dem_cohort==1), ///
legend(label(1 "Non-dementia") label(2 "Probable dementia")) xlabel(1 "4-5" 2 "3-4" 3 "2-3" 4 "1-2" 5 "0-1")
graph save annu_informal_spending_over_time.gph, replace
graph export annu_informal_spending_over_time.pdf, replace
twoway (connected cum_inf year if dem_cohort==0) (connected cum_inf year if dem_cohort==1), ///
legend(label(1 "Non-dementia") label(2 "Probable dementia")) xlabel(1 "4-5" 2 "3-4" 3 "2-3" 4 "1-2" 5 "0-1")
graph save cum_informal_spending_over_time.gph, replace
graph export cum_informal_spending_over_time.pdf, replace

twoway (connected annu_by_all year if dem_cohort==0) (connected annu_by_all year if dem_cohort==1), ///
legend(label(1 "Non-dementia") label(2 "Probable dementia")) xlabel(1 "4-5" 2 "3-4" 3 "2-3" 4 "1-2" 5 "0-1") 
graph save annu_all_spending_over_time.gph, replace
graph export annu_all_spending_over_time.pdf, replace
twoway (connected cum_by_all year if dem_cohort==0) (connected cum_by_all year if dem_cohort==1), ///
legend(label(1 "Non-dementia") label(2 "Probable dementia")) xlabel(1 "4-5" 2 "3-4" 3 "2-3" 4 "1-2" 5 "0-1")
graph save cum_all_spending_over_time.gph, replace
graph export cum_all_spending_over_time.pdf, replace


twoway (connected cum_by_mc year if dem_cohort==1) (connected cum_by_mca year if dem_cohort==1) (connected cum_oop year if dem_cohort==1) ///
(connected cum_inf year if dem_cohort==1), title("Dementia") ///
legend(label(1 "Medicare") label(2 "Medicaid") label(3 "OOP") label(4 "Informal")) ///
saving(cum_spending_diff_dem, replace) xlabel(1 "4-5" 2 "3-4" 3 "2-3" 4 "1-2" 5 "0-1") 


twoway (connected cum_by_mc year if dem_cohort==0) (connected cum_by_mca year if dem_cohort==0) (connected cum_oop year if dem_cohort==0) ///
(connected cum_inf year if dem_cohort==0), title("No Dementia") ///
legend(label(1 "Medicare") label(2 "Medicaid") label(3 "OOP") label(4 "Informal")) ///
saving(cum_spending_diff_no_dem, replace) xlabel(1 "4-5" 2 "3-4" 3 "2-3" 4 "1-2" 5 "0-1") 

graph combine cum_spending_diff_dem.gph cum_spending_diff_no_dem.gph, ycommon

graph combine annu_mc_spending_over_time.gph cum_mc_spending_over_time.gph, ycommon
graph combine annu_mcaid_spending_over_time.gph cum_mcaid_spending_over_time.gph, ycommon
graph combine annu_oop_spending_over_time.gph cum_oop_spending_over_time.gph, ycommon
graph combine annu_informal_spending_over_time.gph cum_informal_spending_over_time.gph, ycommon
graph combine annu_all_spending_over_time.gph cum_all_spending_over_time.gph, ycommon


H="experimental changes to informal calculations"
clear all
capture log close

local datapath "E:\data\burden_dementia\int_data"
local logpath "E:\data\burden_dementia\logs"
local ooppath "E:\data\burden_dementia\oopdata"

/****************** START WITH EXIT **********************/

use "E:\data\hrs_cleaned\exit_02_to_14_dt.dta", clear

foreach x of varlist * {

rename `x' `x'_exit
}

rename id_exit id

gen nflag = 0
cap drop _m
tempfile exit
gen year = exit_year_exit
save `exit' // all exit interviews 2002-14

/**************** MERGE TRACKER WITH DECEDENT DATASET ***********/

use "E:\data\hrs_cleaned\restr_tracker_v2014.dta", clear
drop id
gen id=hhid+pn
drop if id==""
keep id race hisp_eth birthmo birthday birthyr birth_date gender degree
tempfile track
save `track' // all restricted tracker

cd `datapath'

use decedent_dataset.dta if inrange(index_year,2004,2012), clear
drop year
cap drop _m
format %td index_date
merge m:1 id using "`track'"
keep if _m==3

replace birth_date=mdy(6,birthd,birthy) if missing(birth_date)
cap drop death_date
gen death_date = index_date
gen age_at_death=floor((death_date-birth_date)/365.25)

cap drop _m


/* Sample derivation Dataset 
tempfile sample
preserve
gen age_lt_70 = 0
replace age_lt_70 = 1 if age_at_death<70
label var age_lt_70 "Age at death <70"
save `sample'
restore 
*/

levelsof id if age_at_death<70, local(agedrop)

drop if age_at_death<70 /////////////// drop people <70 at death (800)

merge 1:1 id using "`exit'"

/* Sample derivation
preserve
gen no_exit = 1 if _m==1
keep if no_exit
keep id no_exit
tempfile noexit
save `noexit'

use "`sample'", clear
merge 1:1 id using "`noexit'", keepus(no_exit)
label var no_exit "No exit ivw 2002-2014"
cap drop _m
save `sample', replace
restore
************ */
levelsof id if _m==1, local(exitdrop) 
keep if _m==3 /////////// drop people with no exit (387)

cap drop _m

tempfile r01
save `r01'

keep id index_date index_year
tempfile id 
save `id' //decedents with exit 

/*************** MERGE WITH CORE INTERVIEW **************/

use "E:\data\hrs_cleaned\core_00_to_12.dta", clear

merge m:1 id using "`id'", keepus(index_date index_year)
levelsof id if _m==2, local(nocoredrop)
keep if _m==3 ///////////// 25 people no core interviews ever

cap drop _m

gsort id -core_year

by id: gen obs=_n

keep if obs<=4

gen ivw_date = c_ivw_date

by id: gen next_ivw_date = ivw_date[_n+1] // date prev ivw chronologically

by id: gen next_ivw_year = core_year[_n+1]

gen earliest = 0
replace earliest = 1 if next_ivw_year==.
label var earliest "flag for earliest observable core"


keep if obs<=3 // keep last 3 hrs interviews


by id: gen diff = core_year - core_year[_n-1] // -4 or higher denotes a gap year

bysort id: egen gap = min(diff)

replace gap = abs(gap) // max number of years between consecutive core
label var gap "max # of yrs between consecutive core ivw"
tab gap
preserve
keep if gap>4
keep id
duplicates drop 
levelsof id, local(misscore)
tempfile droplist
save `droplist' ///////// people with more than 4 year gap between cores

restore

drop obs gap diff
gen year = core_year

cap drop _m

/* merge with dementia dataset */

merge 1:1 id core_year using "E:\data\hrs_public_2012\dementia\pdem_withvarnames_ebl.dta", keepus(pdem)
drop if _m==2

gen dementia = 0
replace dementia = 1 if pdem>=.5 & pdem!=.
cap drop _m


tempfile core
save `core'

use "`r01'", clear
append using "`core'"

merge m:1 id using "`droplist'" //dropping people with >4 years between core

codebook id if _m==3
drop if _m==3
cap drop _m

codebook id

gsort id -year

by id: gen obs=_n

foreach x of local nocoredrop {

drop if obs==1 & id=="`x'" // dropping exit ivw for people with no core ever (2000-12)

}

gen nflag_ivw = obs - 1
label var nflag_ivw "Interview type, 0 = exit, 1 = N1, etc."

gen dem_cohort = 0

levelsof id if dementia==1 & nflag_ivw==1, local(demlist)

foreach x of local demlist {

replace dem_cohort = 1 if id=="`x'"

}




gen core_5yr = index_year - core_year if obs==2 
preserve 

keep if core_5yr>4 & obs==2
keep id
levelsof id, local(core4yr) 
tempfile core_2_far 
save `core_2_far' /////////////// no core ivw within 4yrs of death

restore

merge m:1 id using "`core_2_far'"
codebook id if _m==3
drop if _m==3 // dropping ppl with no core_ivw within 4 yrs
cap drop _m

gsort id -year


by id: gen diff = year - year[_n-1] // -4 or higher denotes a gap year

/*
gen ivw_date = c_ivw_date
replace ivw_date = e_ivw_date_exit if nflag_ivw==0

 by id: gen next_ivw_date = ivw_date[_n+1] */

gen ex2far = 0
replace ex2far = 1 if diff<-4 & obs==2

gen divide = 1
replace divide = 2 if diff<=-4  & ex2far==0

expand 2 if diff<=-4, gen(imputed) 

replace year = year + 2 if imputed==1 // imputed core interview

levelsof id if imputed==1, local(impu)

cap drop nflag

gsort id -year
by id: gen nflag = _n
replace nflag = nflag - 1

drop if nflag>3

cd "E:\data\burden_dementia\int_data"
save R01_int.dta, replace

use R01_int.dta, clear

keep if nflag_ivw==0
keep id index_date index_year exit_year_exit year
tempfile index
save `index'

/*
drop nflag obs

gsort id -year
by id: gen nflag==_n-1
*/

/**************** GET OOP DATA ********************/

local ooppath "E:\data\burden_dementia\oopdata"

use `ooppath'\oopme_final_2014.dta, clear
rename *, l
gen id=hhid+pn

merge m:1 id using "`index'", keepus(index_year index_date)
keep if _m==3 // only keep oop data for people in cohort

tab year if total_oop==.
drop if total_oop==.
preserve
*keep if iwtype==0 // keep non-imputed non-exit ivw
tempfile oop_mer
save `oop_mer' // original dataset, not imputed
restore 


gsort id -year

by id: gen obs=_n

keep if obs<=4

by id: gen diff = year - year[_n-1] // -4 or higher denotes a gap year


replace diff = -4 if diff<=-4 & obs==2 // recoding people with >4 gap between exit and N1 to be 4yrs


/*
bysort id: egen gap = min(diff)
keep if gap==-4 /* only keep people without consecutive missing interviews */
*/


expand 2 if diff==-4, gen(ooptag) //created imputed interview

replace year = year + 2 if ooptag==1

gsort id -year

cap drop obs
by id: gen obs=_n

by id: gen total_imp_a = total_oop[_n+1] if ooptag==1
by id: gen total_imp_b = (total_oop[_n+1] + total_oop[_n-1])/2 if ooptag==1

label var ooptag "imputed oop"

keep if ooptag==1

tempfile imputed
save `imputed'


use "`oop_mer'", clear

append using "`imputed'"
cap drop _m 
preserve
drop if iwtype==1

tempfile oop
save `oop'
restore 

keep if iwtype==1

gen nflag = 0

foreach x of varlist total* {

rename `x' `x'_exit
}
rename year exit_year_exit

tempfile oop_exit
save `oop_exit'

use R01_int.dta, clear
cap drop _m
merge 1:1 id year using "`oop'", keepus(total* ooptag)
*merge 1:1 id year using "`oop'", keepus(total* ooptag)
drop if _m==2
cap drop _m

merge 1:1 id nflag using "`oop_exit'", keepus(total* ooptag)

drop if _m==2
cap drop _m

save R01_int.dta, replace


use R01_int.dta, clear

keep if nflag_ivw==0
keep id index_date index_year exit_year_exit year
tempfile index
save `index'



/************ Get Helper data ***********/

use "E:\data\hrs_oop_2010\received_data\2012\helper_hours_2012.dta", clear
gen id=hhid+pn 
*rename year core_year
//cap number of hours at 720 (24 hrs for 30 days) for spouses and other informal
foreach x in s u {
replace hlphrs_`x'=720 if hlphrs_`x'>720
replace hlphrs_`x' = 0 if hlphrs_`x'==.
}
replace hlphrs_i=hlphrs_s+hlphrs_u
replace hlphrs_i= 720 if hlphrs_i>=720

merge m:1 id using "`index'", keepus(index_year index_date)
keep if _m==3 // only keep helper data for people in cohort
drop _m

tempfile hlp_mer

save `hlp_mer'

merge 1:1 id year using "`index'", keepus(id exit_year_exit year)

replace inx = 1 if _m==2
replace hlphrs_i = 0 if _m==2



gsort id -year

by id: gen obs=_n

tab inx if obs==2

by id: gen diff = year - year[_n-1] // -4 or higher denotes a gap year

replace diff = -4 if diff<=-4 & obs==2 // replacing obs where gap between exit and N1 was >4yrs, since we already kept people who had core in last years of life

expand 2 if diff==-4, gen(hlptag)



replace year = year + 2 if hlptag==1

replace hlptag=1 if _m==2

cap drop obs

gsort id -year

by id: gen obs=_n

by id: gen hlphrs_i_a = hlphrs_i[_n+1] if hlptag==1
by id: gen hlphrs_i_b = (hlphrs_i[_n+1] + hlphrs_i[_n-1])/2 if hlptag==1 // if there is no _n+1 then this returns missing





label var hlptag "imputed hlp hrs"

gen hlp_exit = 1 if hlptag==1 & _m==2
label var hlp_exit "hlp exit imputed"
replace hlptag = 0 if _m==2
preserve
keep if hlptag==1 

tempfile hlp
save `hlp'


use "`hlp_mer'", clear

append using "`hlp'"
cap drop _m

drop if inx==1


tempfile help
save `help'
restore 

keep if inx==1

gen nflag = 0

foreach x of varlist hlphrs_i* {

rename `x' `x'_exit
}

tempfile hlp_exit 
save `hlp_exit'


use R01_int.dta, clear
cap drop _m
merge 1:1 id year using "`help'", keepus(hlphrs_i* hlptag hlp_exit)
*merge 1:1 id year using "`help'", keepus(hlphrs_i* hlptag)
drop if _m==2

cap drop _m

merge 1:1 id nflag using "`hlp_exit'", keepus(hlphrs_i* hlptag hlp_exit) update

drop if _m==2
cap drop _m

foreach x of varlist hlphrs_i* {

replace `x' = 0 if (hlptag==1 & imputed==0)
replace `x' = 0 if `x'==.
}

gen year_n0 = year
replace year_n0 = index_year if nflag==0
gen year_n1 = year_n0 - 1
label var year_n1 "calendar year prior to ivw date"
gen year_n2 = year_n0 - 2
label var year_n2 "calendar year 2 yrs prior to ivw date"


save R01_int.dta, replace


use R01_int.dta, clear
keep id

duplicates drop id, force
tempfile id
save `id'

/************** Get State information *************/

use "E:\data\hrs_cleaned\restr_tracker_v2014.dta", clear
drop id
gen id=hhid+pn

merge 1:1 id using "`id'"
keep if _m==3

keep hhid pn stateusps* zipcode*

foreach x of varlist stateusps* {

replace `x' = "" if `x'=="ZZ"

}

gen stateusps97=""
gen stateusps99=""

forvalues i= 1(2)13{
gen stateusps`i'=""
gen zipcode`i' = ""
}

forvalues i=0(2)8{
rename stateusps0`i' stateusps`i'
rename zipcode0`i' zipcode`i'
}
reshape long stateusps zipcode, i(hhid pn) j(year)

forvalues i=0/99{
qui replace year=200`i' if year==`i' & year<=9
qui replace year=20`i' if year==`i' & inrange(year, 10,14)
qui replace year=19`i' if year==`i' & year>=90
}

gen id= hhid+pn
sort id year
drop if id==""
by id: carryforward stateusps, replace

gsort id -year
by id: carryforward stateusps, replace

/*
expand 2 if year==2012, gen(dupkey)

replace year = 2014 if dupkey==1


expand 2 if year==2014, gen(dup2)
replace year= 2013 if dup2==1
*/

tempfile state
save "`state'"

rename year year_n1
rename stateusps stateusps_n1
tempfile state_n1
save `state_n1'

rename year_n1 year_n2
rename stateusps_n1 stateusps_n2 
tempfile state_n2
save `state_n2'

use R01_int.dta, clear
merge 1:1 id year using "`state'"
keep if _m==3
cap drop _m
merge m:1 id year_n1 using "`state_n1'"
keep if _m==3
cap drop _m
merge m:1 id year_n2 using "`state_n2'"
keep if _m==3
cap drop _m


save R01_int.dta, replace

//merging with the Genworth/Metlife hourly home health aide cost. 
import excel "E:\data\burden_dementia\ref_data\Cost Care Survey (Genworth-Metlife)\HHA_hourly_genworth.xlsx", sheet("Sheet1") firstrow clear

rename A year
rename B stateusps
rename HomeHealthAideServicesHourly state_hha
rename MedianHourlyRate hr_rate

drop if year==.
destring hr_rate, replace

expand 2 if year==1998, gen(duptag)

replace year = year - 1 if duptag==1
cap drop duptag

expand 2 if year==1997, gen(duptag)

replace year = year - 1 if duptag==1
drop duptag

rename year year_n0

tempfile rate
save "`rate'"

rename year_n0 year_n1
rename stateusps stateusps_n1
rename state_hha state_hha_n1
rename hr_rate hr_rate_n1

tempfile rate_n1
save "`rate_n1'"

rename year_n1 year_n2
rename stateusps_n1 stateusps_n2
rename state_hha_n1 state_hha_n2
rename hr_rate_n1 hr_rate_n2

tempfile rate_n2
save "`rate_n2'"

use R01_int.dta, clear
cap drop _m
merge m:1 year_n0 stateusps using "`rate'"
keep if _m==3
cap drop _m
merge m:1 year_n1 stateusps_n1 using "`rate_n1'"
keep if _m==3
cap drop _m
merge m:1 year_n2 stateusps_n2 using "`rate_n2'"
keep if _m==3
cap drop _m

/**************** calculations *********************/

gen core_b4_death = 0
replace core_b4_death = 1 if nflag==1

gen n1_2_death = index_date - c_ivw_date if core_b4_death==1
replace n1_2_death = n1_2_death * 0.033
replace n1_2_death = ceil(n1_2_death)
replace n1_2_death = 24 if n1_2_death>=24 & n1_2_death!=.
replace n1_2_death = 1 if n1_2_death<=0


gen death_cat = .
replace death_cat = 1 if n1_2_death<12
replace death_cat = 2 if n1_2_death==12
replace death_cat = 3 if n1_2_death>12 & n1_2_death!=.

gsort id -core_b4_death

carryforward death_cat n1_2_death, replace

gen all = 1
bysort id: egen count = total(all)

codebook id if count==3
levelsof id if count==3 & death_cat==1, local(non3)

drop if count==3 & death_cat==1 /////////// dropping people with no N3 but death_cat ==1


cap drop ivw_time
gen ivw_time = ivw_date - next_ivw_date
*replace ivw_time = index_date - ivw_date if ex2far==1

replace ivw_time = ivw_time * 0.03
gen imp = core_year-next_ivw_year
replace ivw_time = 48 if imp>=6 & imp!=. // recode people with exit >2yrs from death  to cap it at 48m
replace ivw_time = 24 if earliest==1
replace imp = 1 if imp>=4 & imp!=.

replace ivw_time = ivw_time/2 if imp==1
replace ivw_time = ceil(ivw_time)

tab ivw_time
label var ivw_time "interview weight" 

cap drop mar_n0 mar_n1 mar_n2
cap drop mar

gen mar_n0 = . //months at risk
gen mar_n1 = .
gen mar_n2 = .

replace mar_n0 = index_month if nflag==0
*replace mar_n0 = n1_2_death if n1_2_death<12 & nflag==0
replace mar_n0 = n1_2_death if (n1_2_death-mar_n0 < 0) & nflag==0

replace mar_n1 = n1_2_death - mar_n0 if nflag==0
replace mar_n1 = 0 if mar_n1<0 & nflag==0
replace mar_n1 = 12 if (mar_n1>12 & mar_n1!=.) & nflag==0



replace mar_n2 = n1_2_death - mar_n0 -mar_n1 if nflag==0
replace mar_n2 = 0 if mar_n2<0
*replace mar_n2 = 12 if (mar_n2>12 & mar_n2!=.) & nflag==0



replace mar_n0 = c_ivw_month if nflag>0

replace mar_n1 = ivw_time - c_ivw_month if nflag>0
replace mar_n1 = 0 if mar_n1<0 & nflag>0
replace mar_n1 = 12 if (mar_n1>12 & mar_n1!=.) & nflag>0

replace mar_n2 = ivw_time - 12 - c_ivw_month if nflag>0
replace mar_n2 = 0 if mar_n2<0 & nflag>0
*replace mar_n2 = 12 if (mar_n2>12 & mar_n2!=.) & nflag>0

gen mar = mar_n0+mar_n1+mar_n2
corr mar n1_2_death if nflag==0
corr mar ivw_time if nflag>0 // checks to see if months at risk (mar) = months between ivw

gsort id +nflag

gen hlphrs_0 = hlphrs_i
replace hlphrs_0 = hlphrs_i_exit if nflag==0

gen hlphrs_a = hlphrs_i
replace hlphrs_a = hlphrs_i_a if imputed==1
replace hlphrs_a = hlphrs_i_exit if nflag==0

gen hlphrs_b = hlphrs_i
replace hlphrs_b = hlphrs_i_b if imputed==1
replace hlphrs_b = hlphrs_i_exit if nflag==0 



foreach x of varlist hlphrs_0 hlphrs_a hlphrs_b {

by id: gen `x'_n = `x'[_n+1]

replace `x'_n = 0 if `x'_n==. // stop gap, remove later 

} 


//start with nflag = 0

gen hlphrs_0_av = .
replace hlphrs_0_av = n1_2_death*hlphrs_0 if n1_2_death<=4 & nflag==0
replace hlphrs_0_av = (4*hlphrs_0) + (n1_2_death-4)*((hlphrs_0+hlphrs_0_n)/2) if n1_2_death>4 & nflag==0
replace hlphrs_0_av = (4*hlphrs_0) + (ivw_time-4)*((hlphrs_0+hlphrs_0_n)/2) if nflag>0

gen hlphrs_a_av = .
replace hlphrs_a_av = n1_2_death*hlphrs_a if n1_2_death<=4 & nflag==0
replace hlphrs_a_av = (4*hlphrs_a) + (n1_2_death-4)*((hlphrs_a+hlphrs_a_n)/2) if n1_2_death>4 & nflag==0
replace hlphrs_a_av = (4*hlphrs_a) + (ivw_time-4)*((hlphrs_a+hlphrs_a_n)/2) if nflag>0

gen hlphrs_b_av = .
replace hlphrs_b_av = n1_2_death*hlphrs_b if n1_2_death<=4 & nflag==0
replace hlphrs_b_av = (4*hlphrs_b) + (n1_2_death-4)*((hlphrs_b+hlphrs_b_n)/2) if n1_2_death>4 & nflag==0
replace hlphrs_b_av = (4*hlphrs_b) + (ivw_time-4)*((hlphrs_b+hlphrs_b_n)/2) if nflag>0







//st





foreach x of varlist *_av {

replace `x' = `x'/n1_2_death if nflag==0
replace `x' = `x'/ivw_time if nflag>0
replace `x' = (`x'*mar_n0*hr_rate) +  (`x'*mar_n1*hr_rate_n1) + (`x'*mar_n2*hr_rate_n2)

}

replace hlphrs_i = hlphrs_0_av if nflag>0
replace hlphrs_i_exit = hlphrs_0_av if nflag==0

replace hlphrs_i_a = hlphrs_a_av if nflag>0
replace hlphrs_i_a_exit = hlphrs_a_av if nflag==0

replace hlphrs_i_b = hlphrs_b_av if nflag>0
replace hlphrs_i_b_exit = hlphrs_b_av if nflag==0





gen has_imputed = 0
foreach x of local impu {

replace has_imputed=1 if id=="`x'"

}


save R01_int.dta, replace

/* Sample Derivation */

use decedent_dataset.dta if inrange(index_year,2004,2012), clear

gen age_lt_70 = 0
label var age_lt_70 "Dropped because age at death <70"
foreach x of local agedrop {

replace age_lt_70 = 1 if id=="`x'"

}

gen exdrop = 0
label var exdrop "Dropped because no Exit Ivw 2002-2014"
foreach x of local exitdrop {
replace exdrop = 1 if id=="`x'"
}

gen nocore = 0
label var nocore "Dropped because no Core Ivw 2000-2012"
foreach x of local nocoredrop {

replace nocore = 1 if id=="`x'"
}

gen misscore = 0
label var misscore "Dropped because missing consecutive cores"
foreach x of local misscore {

replace misscore = 1 if id=="`x'"
}

gen core4yr = 0
label var core4yr "Dropped because no Core within last 4 years of life"
foreach x of local core4yr {
replace core4yr = 1 if id=="`x'"
}

gen impu = 0
label var impu "Had a core imputed"
foreach x of local impu {
replace impu = 1 if id=="`x'"
}

gen non3 = 0
label var non3 "Dropped because Died <12m after N1 and missing N3"
foreach x of local non3 {

replace non3 = 1 if id=="`x'"

}

local deri age_lt_70 exdrop nocore misscore core4yr non3 

gen final = 1
label var final "Final Sample Size, includes decedents w/imputed core"

foreach x of local deri {

replace final = 0 if `x'==1

}

gen final_noimp = 0
replace final_noimp = 1 if final==1 & impu==0
label var final_noimp "Final Sample Size, excludes decedents with imputed core"

gen all = 1
label var all "All HRS respondents Deceased 2004-2012"

local full all age_lt_70 exdrop nocore misscore core4yr non3 final final_noimp

local rd: word count `full'

mat tab1 = J(`rd',1,.)

local r = 1

foreach x of local full {

sum `x'
mat tab1[`r',1] = r(sum)
local ++r
}

mat rownames tab1 = `full'


frmttable using "E:\projects\burden_dementia\archive logs\Sample_Derivation.doc", replace statmat(tab1) ///
varlabels title("Sample Derivation for R01 (Deceased 2004-2012, Age 70+)") ctitles("Reason for Exclusion" "N" ) sdec(0) ///
annotate(stars) asymbol(*,**)note("Death Date was determined by NDI, Medicare MBSF or HRS Exit in that order. //If NDI death date was after HRS Exit Interview and respondent had no subsequent data, then HRS death date was used.")




H="Experimental - checking discrepancies in DOD"
use check_id_xwalk.dta, clear

duplicates drop id, force


merge 1:1 id using "E:\data\hrs_cleaned\death_date_2015.dta", keep(match)

list index_date dod_ndi10 dod_basf15 dod_bene15 dod_exit14 c_ivw_date proxy_core no_exit death_exit

cap drop _m



cap drop bid_hrs_22
gen hhidpn = id
merge 1:1 hhidpn using "E:\data\CMS_DUA_51675_2014\Medicare Xref2015\CMSxref20151\stata\xref2015medicare.dta", keep(match)
drop _m
rename BID_HRS_22 bid_hrs_22

tempfile check
save `check'


use "E:\data\CMS_DUA_51675_2014\Merged\Stata\basf_1998_2015.dta", clear
duplicates drop bid_hrs_22, force
gen bene_female = 0
replace bene_female = 1 if sex=="2"
keep bid_hrs_22 bene_dob bene_female bene_dod

merge 1:1 bid_hrs_22 using "`check'", keep(match)

cap drop _m birth_date
merge 1:1 id using tracker.dta, keep(match)

format %td birth_date 

gen average = abs(birth_date - bene_dob)
replace average = average * 0.03
sum average // average discrepancy is 52 months


use tracker.dta, clear
gen hhidpn = id 
merge 1:1 hhidpn using "E:\data\CMS_DUA_51675_2014\Medicare Xref2015\CMSxref20151\stata\xref2015medicare.dta", keep(match)
drop _m
rename BID_HRS_22 bid_hrs_22 
merge 1:m bid_hrs_22 using "E:\data\CMS_DUA_51675_2014\Merged\Stata\basf_1998_2015.dta", keep(match) force
duplicates drop bid_hrs_22, force

gen average = abs(birth_date - bene_dob)
replace average = average * 0.03
sum average // average discrepancy is 52 months

/********** quick oop check***********/
use R01_i.dta, clear

merge m:1 id using R01_annualized_i.dta, keepus(oop_y* informal_y*)
drop _m

save R01_oopcosts_fullsample.dta, replace

merge m:1 id using oop_24m_60m, keepus(ind_60m_oop_yes total_oop_60m)
drop if _m==2

keep if nflag==1 & ffs_60m==1 & age_lt_70==0 index_year>=2005 & index_year<=2010
*keep if ffs_60m==1 & age_lt_70==0

gen oop_5yr = oop_y1 + oop_y2 + oop_y3 + oop_y4 + oop_y5

mean total_oop_60m , over(dem_cohort)

mean oop_5yr , over(dem_cohort)


mean total_oop_60m [aw=wgthh], over(dem_cohort)

mean oop_5yr [aw=wgthh], over(dem_cohort)


H="Experimental - Data aggreation"
clear all
capture log close

global datapath "E:\data\burden_dementia\int_data"
local logpath "E:\data\burden_dementia\logs"
global ooppath "E:\data\burden_dementia\oopdata"
global output "E:\projects\burden_dementia\archive logs"

*log using `logpath'\R01_aggregate.txt, text replace

* Constructs aggregate dataset and variables for R01 before people are dropped
* search "to be dropped" to find sample exclusion variables

/****************** START WITH EXIT **********************/

use "E:\data\hrs_cleaned\exit_02_to_16_dt.dta", clear

foreach x of varlist * {

rename `x' `x'_exit
}

rename id_exit id
gen nflag = 0
cap drop _m
gen year = exit_year_exit
save $datapath\exit.dta, replace // all exit interviews 2002-14

/**************** MERGE TRACKER WITH DECEDENT DATASET ***********/

cd $datapath

use decedent_dataset.dta if inrange(index_year,2004,2015), clear
cap drop _m
format %td index_date
merge m:1 id using tracker.dta 
keep if _m==3

replace birth_date=mdy(6,birthd,birthy) if missing(birth_date)
cap drop death_date
gen death_date = index_date
gen age_at_death=floor((death_date-birth_date)/365.25)

cap drop _m
merge 1:1 id using exit.dta
gen age_lt_72 = 1 if age_at_death<72
gen age_lt_70 = 1 if age_at_death<70
label var age_lt_72 "Age <72 at death, to be dropped"
label var age_lt_70 "Age <70 at death, to be dropped"

gen no_exit=1 if _m==1
label var no_exit "Decedents with no exit ivw 2002-16, to be dropped"
drop if _m==2
cap drop _m
save r01_a.dta, replace

/*************** MERGE WITH CORE INTERVIEW **************/

use r01_a.dta, clear
keep id index_date index_year exit_year_exit e_ivw_date_exit
tempfile id 
save `id' //decedents with exit 

use "E:\data\hrs_cleaned\core_00_to_14.dta", clear
merge m:1 id using "`id'", keepus(index_date index_year exit_year_exit e_ivw_date_exit)
levelsof id if _m==2, local(nocore)
global nocore1 "`nocore'"
keep if _m==3
cap drop _m
gsort id -core_year
by id: gen obs=_n
keep if obs<=5 // keeping last 5 core interviews (N1 - N4 + Baseline)

* I'm creating a single ivw date variable that has both the core ivw date and exit ivw date
gen ivw_date = c_ivw_date

* data is sorted in descending order by core year. I am carrying the date & year //
* of the previous (chronologically) interview into the current row
*by id: gen next_ivw_date_old = ivw_date[_n+1]
by id: gen next_ivw_year = core_year[_n+1]

by id: gen diff = core_year - core_year[_n-1] // -4 or higher denotes a gap year

bysort id: egen gap = min(diff) // using min because diff is negative
replace gap = abs(gap) // max number of years between consecutive core
levelsof id if gap>4, local(misscore)

gen miss_core = .
label var miss_core "Missing consecutive core ivw, to be dropped"
foreach x of local misscore {

replace miss_core = 1 if id=="`x'"
}

drop obs gap diff
gen year = core_year // combines exit_year & core_year into a single variable

* Merge with dementia dataset

merge 1:1 id core_year using "E:\data\hrs_public_2014\dementia\pdem_withvarnames_00_14.dta", keepus(pdem)
drop if _m==2

gsort id -core_year

by id: replace pdem = pdem[_n+1] if pdem==.

gen dementia = 0 if pdem!=.
replace dementia = 1 if pdem>=.5 & pdem!=.
cap drop _m

tempfile core
save `core'

use r01_a.dta, clear
append using "`core'" // appending to exit/tracker 
gen no_core = .
label var no_core "No core ivw 2000-14, to be dropped"
foreach x of global nocore1 {

replace no_core = 1 if id=="`x'"

}

* Data is currently in long form, with one row for exit and a row for each core

save r01_b.dta, replace

/****** Imputing core for people with a 4 year gap between ivws *******/

use r01_b.dta, clear

levelsof id if no_exit==1, local(noexit)

foreach x of local noexit {

replace no_exit = 1 if id=="`x'"
}

gen year_ci = core_year 
replace year_ci = index_year if nflag==0
label var year_ci "core_year(if nflag>0) or index_year(if nflag=0)"
gsort id -year_ci // year = combined core_year & index_year
by id: gen obs=_n

cap drop nflag 
gen nflag = obs - 1
label var nflag "Interview type, 0 = exit, 1 = N1, etc."

gen dem_cohort = 0 if dementia!=.
label var dem_cohort "Probable Dementia at N1"
levelsof id if dementia==1 & nflag==1, local(demlist)

foreach x of local demlist {
replace dem_cohort = 1 if id=="`x'"
}

gen core_4yr = index_year - c_ivw_year if obs==2

/* 

* Final R01 dataset requires everyone to have a core ivw within 4 (calendar) years of death
* But their exit ivw may be further away. The date of exit is irrelevant for ivw spacing
* so will use their date of death instead

Funky stuff: People who have a core ivw after they have died
keep if core_4yr < 0
c_ivw_date > index_date */

preserve
keep if c_ivw_date > index_date & c_ivw_date!=. // people with core dates after ivw
keep id index_date c_ivw_date core_year proxy_core no_exit female birth_date bid_hrs_22
save check_id_xwalk.dta, replace
restore

levelsof id if (core_4yr>4 & core_4yr!=.) | core_4yr<0, local(nocore4yr)

gen nocore4yr = .
label var nocore4yr "No Core ivw within 4 years of death, to be dropped"

gen death_b4_core = .
label var death_b4_core "Has NDI/Bene DOD before Core Ivw" 


levelsof id if c_ivw_date > index_date & c_ivw_date!=., local(diedb4core)

foreach x of local diedb4core {

replace death_b4_core = 1 if id=="`x'"
}

foreach x of local nocore4yr {
replace nocore4yr = 1 if id=="`x'"
}

*replace year = year_ci if nflag>0
label var year "core_year(if nflag>0), exit_year(if nflag=0), includes imputed cores"


levelsof id if miss_core==1, local(misscore)
foreach x of local misscore {

replace miss_core = 1 if id=="`x'"
}


save r01_c.dta, replace

/************ Get Helper data ***********/

/* Helper hours imputation follows the same logic as the OOP, but structure is
slighty different. Everyone has OOP data for their core ivw, so missing oop = missing core.
But not everyone has helper data for their core, so missing helper != missing core */

use r01_c.dta, clear

*dropping the people missing consecutive cores before merging with helper data

keep if miss_core==. & no_exit==. // keep only people not missing consecutive cores and have an exit
keep id index_date index_year exit_year_exit year imputed nflag
tempfile index
save `index'


use "E:\data\hrs_cleaned\helper_hours_2016.dta" , clear
*gen id=hhid+pn 
*rename year core_year
//cap number of hours at 720 (24 hrs for 30 days) for spouses and other informal
/*
foreach x in s u {
replace hlphrs_`x'=720 if hlphrs_`x'>720
replace hlphrs_`x' = 0 if hlphrs_`x'==.
}
*/

*replace hlphrs_i= 720 if hlphrs_i>=720 & hlphrs_i!=.

merge m:1 id year using "`index'"
drop if _m==1


* Imputing 0 helper hours for interviews with no helper data 
replace ivw_type = 2 if exit_year_exit==year //_m==2
foreach x in i u s k {
replace hlphrs_`x' = 0 if _m==2
}
*cap drop _m

gsort id -year
by id: gen obs=_n
* Imputations, Method A (Carry forward) and Method B (Ave prior and later ivws to fill gap)

foreach x in i u s k {

*by id: gen hlphrs_`x'_a = hlphrs_`x'[_n+1] if imputed==1
by id: gen hlphrs_`x'_b = (hlphrs_`x'[_n+1] + hlphrs_`x'[_n-1])/2 if imputed==1 // if there is no _n+1 then this returns missing

}

preserve
drop if ivw_type==2
tempfile help
save `help'
restore 

keep if ivw_type==2

foreach x of varlist hlphrs_* {

rename `x' `x'_exit
}

tempfile hlp_exit 
save `hlp_exit'

use r01_d.dta, clear
cap drop _m
merge 1:1 id nflag using "`help'", keepus(hlphrs_*)
drop if _m==2

cap drop _m

merge 1:1 id nflag using "`hlp_exit'", keepus(hlphrs_*) update

drop if _m==2
cap drop _m

save r01_e.dta, replace

/****** Imputing Interview dates for imputed core interviews ******/

use r01_e.dta, clear

*gen core_b4_death = 0
*replace core_b4_death = 1 if nflag==1

gsort id nflag
cap drop ivw_date
gen ivw_date = c_ivw_date
replace ivw_date = index_date if nflag==0
by id: gen old_ivw_date = ivw_date[_n-1] 

gen new_ivw_days = old_ivw_date - c_ivw_date
replace new_ivw_days = new_ivw_days/2
replace new_ivw_days = 730 if imputed==1 & new_ivw_days>730 & nflag==1 ////// capping interview gap to 2yrs.. possible gap in coverage?

replace new_ivw_days = ceil(new_ivw_days)
replace ivw_date = c_ivw_date + new_ivw_days if imputed==1 //c_ivw is date for core prior to gap
replace c_ivw_year = year(ivw_date)
replace c_ivw_month = month(ivw_date)
replace c_ivw_date = ivw_date if imputed==1

format %td ivw_date old_ivw_date

replace c_ivw_year=9999 if (miss_core==1 | no_exit==1) & c_ivw_year==. // need to create a value since cannot merge with missing values
/*
preserve
keep if miss_core==1 | no_exit==1
tempfile tempdrop
save `tempdrop'

restore
drop if miss_core==1 | no_exit==1
*/
* Get years before the interview to multiply by Genworth hourly rate  
gen c_ivw_year_n0 = c_ivw_year
replace c_ivw_year_n0 = index_year if nflag==0
gen c_ivw_year_n1 = c_ivw_year_n0 - 1
label var c_ivw_year_n1 "calendar year prior to ivw date"
gen c_ivw_year_n2 = c_ivw_year_n0 - 2
label var c_ivw_year_n2 "calendar year 2 yrs prior to ivw date"

save r01_f.dta, replace

/************** Get State information *************/

use r01_f.dta, clear
keep id

duplicates drop id, force
tempfile id
save `id'

// creating CPI-U 
clear
set obs 21
gen obs = _n
gen year = .
gen cpi_rate = .

forvalues i=1/21 {

replace year = 2017 - `i' if obs==`i'

}

replace cpi_rate = 1 if year==2016
replace cpi_rate=1.01262 if year==2015
replace cpi_rate=1.01382 if year==2014
replace cpi_rate=1.03026 if year==2013
replace cpi_rate=1.04535 if year==2012
replace cpi_rate=1.06699 if year==2011
replace cpi_rate=1.10067 if year==2010
replace cpi_rate=1.11872 if year==2009
replace cpi_rate=1.11474 if year==2008
replace cpi_rate=1.15754 if year==2007
replace cpi_rate=1.19051 if year==2006
replace cpi_rate=1.22891 if year==2005
replace cpi_rate=1.27055 if year==2004
replace cpi_rate=1.30439 if year==2003
replace cpi_rate=1.33411 if year==2002
replace cpi_rate=1.35521 if year==2001
replace cpi_rate=1.39377 if year==2000
replace cpi_rate=1.44062 if year==1999
replace cpi_rate=1.47244 if year<=1998

rename year c_ivw_year
label var cpi_rate "Inflation adjustment factor"
tempfile cpi
save `cpi'

// pull tracker
use "E:\data\hrs_cleaned\restr_tracker_v2014.dta", clear
drop id
gen id=hhid+pn

merge 1:1 id using "`id'"
keep if _m==3

keep hhid pn stateusps* zipcode*

gen stateusps16 = stateusps14
gen zipcode16 = zipcode14

foreach x of varlist stateusps* {

replace `x' = "" if `x'=="ZZ"

}

gen stateusps97=""
gen stateusps99=""

forvalues i= 1(2)15{
gen stateusps`i'=""
gen zipcode`i' = ""
}

forvalues i=0(2)8{
rename stateusps0`i' stateusps`i'
rename zipcode0`i' zipcode`i'
}
reshape long stateusps zipcode, i(hhid pn) j(c_ivw_year)

forvalues i=0/99{
qui replace c_ivw_year=200`i' if c_ivw_year==`i' & c_ivw_year<=9
qui replace c_ivw_year=20`i' if c_ivw_year==`i' & inrange(c_ivw_year, 10,16)
qui replace c_ivw_year=19`i' if c_ivw_year==`i' & c_ivw_year>=90
}

gen id= hhid+pn
sort id c_ivw_year
drop if id==""
by id: carryforward stateusps, replace

gsort id -c_ivw_year
by id: carryforward stateusps, replace

merge m:1 c_ivw_year using "`cpi'", keepus(cpi_rate)
cap drop _m

tempfile state
save "`state'"

rename c_ivw_year c_ivw_year_n1
rename stateusps stateusps_n1
rename cpi_rate cpi_rate_n1
tempfile state_n1
save `state_n1'

rename c_ivw_year_n1 c_ivw_year_n2
rename stateusps_n1 stateusps_n2 
rename cpi_rate_n1 cpi_rate_n2
tempfile state_n2
save `state_n2'

use R01_f.dta, clear
merge m:1 id c_ivw_year using "`state'"
drop if _m==2
cap drop _m
merge m:1 id c_ivw_year_n1 using "`state_n1'"
drop if _m==2
cap drop _m
merge m:1 id c_ivw_year_n2 using "`state_n2'"
drop if _m==2
cap drop _m

save R01_g.dta, replace

//merging with the Genworth/Metlife hourly home health aide cost. 
import excel "E:\data\burden_dementia\ref_data\Cost Care Survey (Genworth-Metlife)\HHA_hourly_genworth.xlsx", sheet("Sheet1") firstrow clear

rename A c_ivw_year
rename B stateusps
rename HomeHealthAideServicesHourly state_hha
rename MedianHourlyRate hr_rate

drop if c_ivw_year==.
destring hr_rate, replace

expand 2 if c_ivw_year==1998, gen(duptag)

replace c_ivw_year = c_ivw_year - 1 if duptag==1
cap drop duptag

expand 2 if c_ivw_year==1997, gen(duptag)

replace c_ivw_year = c_ivw_year - 1 if duptag==1
drop duptag

rename c_ivw_year c_ivw_year_n0

tempfile rate
save "`rate'" // hourly rate for calendar c_ivw_year of i

rename c_ivw_year_n0 c_ivw_year_n1
rename stateusps stateusps_n1
rename state_hha state_hha_n1
rename hr_rate hr_rate_n1

tempfile rate_n1
save "`rate_n1'"

rename c_ivw_year_n1 c_ivw_year_n2
rename stateusps_n1 stateusps_n2
rename state_hha_n1 state_hha_n2
rename hr_rate_n1 hr_rate_n2

tempfile rate_n2
save "`rate_n2'"

use R01_g.dta, clear
cap drop _m
merge m:1 c_ivw_year_n0 stateusps using "`rate'"
drop if _m==2
cap drop _m
merge m:1 c_ivw_year_n1 stateusps_n1 using "`rate_n1'"
drop if _m==2
cap drop _m
merge m:1 c_ivw_year_n2 stateusps_n2 using "`rate_n2'"
drop if _m==2
cap drop _m

save R01_h.dta, replace

/********** Final Calculations For Sample Derivation *********/

use R01_h.dta, clear

gsort id nflag

by id: gen next_ivw_date = ivw_date[_n+1] // bringing forward date from prior core away from death

format %td next_ivw_date

gen n1_2_death = index_date - c_ivw_date if nflag==1
replace n1_2_death = n1_2_death * 0.0329
replace n1_2_death = ceil(n1_2_death)
replace n1_2_death = 24 if n1_2_death>=24 & n1_2_death!=.
replace n1_2_death = 1 if n1_2_death<=0

gen core_b4_death = 0
replace core_b4_death = 1 if nflag==1

gsort id -core_b4_death

gen n1_ivw_date = c_ivw_date if nflag==1

by id: carryforward n1_2_death n1_ivw_date, replace



gen ivw_time = ivw_date - next_ivw_date
replace ivw_time = ivw_time * 0.0329
label var ivw_time "Months between previous ivw & current ivw"

gen n1_2_ivw = n1_ivw_date - ivw_date
replace n1_2_ivw = n1_2_ivw * 0.0329
label var n1_2_ivw "Months between current ivw & N1 interview"



gen last_core = 1 if ivw_time==. & nflag>0
label var last_core "Last observable core, ivw_time imputed at 24 months"
replace ivw_time = 24 if ivw_time==. & nflag>0

sum ivw_time if nflag>0
/*Average time between core ivws is 24 months. So if we subtract ivw date from death, 
only need it to be >=60 since interview data extends ~24 months back */

gen months_obs = n1_2_ivw + ivw_time + n1_2_death
replace months_obs = ceil(months_obs) // round up to keep integers. Makes subsequent math easier
label var months_obs "# of months person is observed in sample"

gen hrs_gte_84m = 0
replace hrs_gte_84m = 1 if months_obs>=83.5 & months_obs!=.
label var hrs_gte_84m ">=84 months of HRS ivw data"

gen hrs_gte_60m = 0
replace hrs_gte_60m = 1 if months_obs>=60 & months_obs!=.

levelsof id if hrs_gte_60m, local(moredata)
foreach x of local moredata {
replace hrs_gte_60m = 1 if id=="`x'"
}

gen hrs_lt_60m = .
replace hrs_lt_60m = 1 if hrs_gte_60m==0
label var hrs_lt_60m "<60m of HRS ivw data, to be dropped"



levelsof id if hrs_gte_84m, local(havedata)
foreach x of local havedata {
replace hrs_gte_84m = 1 if id=="`x'"
}

gen hrs_lt_84m = .
replace hrs_lt_84m = 1 if hrs_gte_84m==0
label var hrs_lt_84m "<84 months of HRS ivw data, to be dropped"

gen ffs_84m = 0
replace ffs_84m = 1 if cont_ffs_n_mos>=84 & cont_ffs_n_mos!=. & nflag==0
label var ffs_84m "84 months of continuous FFS prior to death"


gen ffs_60m = 0
replace ffs_60m = 1 if cont_ffs_n_mos>=60 & cont_ffs_n_mos!=. & nflag==0
label var ffs_84m "60 months of continuous FFS prior to death"


gen has_imputed = imputed
label var has_imputed "Has an imputed core ivw"

levelsof id if dem_cohort==0, local(demb)
foreach x of local demb {
replace dem_cohort=0 if id=="`x'"

}

levelsof id if dem_cohort==1, local(demc)
foreach x of local demc {
replace dem_cohort=1 if id=="`x'"
}

local samplevars age_lt_72 age_lt_70 no_exit miss_core no_core nocore4yr hrs_lt_84m hrs_lt_60m has_imputed death_b4_core ffs_84m ffs_60m 

foreach x of local samplevars {

levelsof id if `x'==1, local(samp)

foreach y of local samp {

replace `x'=1 if id=="`y'"
replace `x'=0 if `x'!=1

}
} 

save R01_i.dta, replace


H="Experimental - Simultaneous 5yr &  7yr Sample Derivation"
clear all
capture log close

global datapath "E:\data\burden_dementia\int_data"
local logpath "E:\data\burden_dementia\logs"
global ooppath "E:\data\burden_dementia\oopdata"
global output "E:\projects\burden_dementia\archive logs"

*log using `logpath'\sample_derivation.txt, text replace
cd $datapath

use R01_i.dta, clear
*preserve

drop if dem_cohort==.

gen ffs_lt_60m = 0
replace ffs_lt_60m = 1 if ffs_60m==0

gen ffs_lt_84m = 0
replace ffs_lt_84m = 1 if ffs_84m==0

local deri age_lt_70 no_exit miss_core no_core nocore4yr hrs_lt_60m death_b4_core ffs_lt_60m


gen final = 1
label var final "5yr Sample Size, includes decedents w/imputed core"

foreach x of local deri {
replace final = 0 if `x'==1
}

gen final_7yr = 1 if final==1
label var final_7yr "7yr Sample Size, includes decedents w/imputed core"


gen final_noimp = 0
replace final_noimp = 1 if final==1 & has_imputed==0
label var final_noimp "5yr Sample Size, excludes decedents w/imputed core"

foreach x of varlist age_lt_72 hrs_lt_84m ffs_lt_84m {
replace final_7yr = 0 if `x'==1
}

gen final_7yr_noimp = 0
replace final_7yr_noimp = 1 if final_7yr==1 & has_imputed==0
label var final_7yr_noimp "7yr Sample Size, excludes decedents w/imputed core"

label var ffs_lt_60m "<60m continuous FFS prior to death"
label var ffs_lt_84m "<84m continuous FFS prior to death"


gen dropped_7yr = 0
replace dropped_7yr = 1 if final_7yr==0 & final==1


preserve
keep if nflag==0

gen all = 1
label var all "All HRS respondents Deceased 2004-2015"
/*
local full all age_lt_72 no_exit miss_core no_core nocore4yr death_b4_core hrs_lt_84m final final_noimp final_ffs final_noimp_ffs

local rd: word count `full'

mat tab1 = J(`rd',3,.)

local r = 1

foreach x of local full {

sum `x'
mat tab1[`r',1] = r(sum)

sum `x' if dem_cohort==1
mat tab1[`r',2] = r(sum)

sum `x' if dem_cohort==0
mat tab1[`r',3] = r(sum)

local ++r
}

mat rownames tab1 = `full'


frmttable using "E:\projects\burden_dementia\archive logs\Sample_Derivation.doc", replace statmat(tab1) ///
varlabels title("Sample Derivation for R01 (Deceased 2004-2015, Age 72+)") ctitles("Reason for Exclusion" "All" "Dementia" "Non-Dementia") sdec(0) ///
annotate(stars) asymbol(*,**)note("Death Date was determined by NDI, Medicare MBSF or HRS Exit in that order. Reasons for exclusion are NOT mutally exclusive.")


 */


local full1 age_lt_70 death_b4_core no_exit miss_core no_core nocore4yr hrs_lt_60m ffs_lt_60m
local full2 final final_noimp
local full3 age_lt_72 hrs_lt_84m ffs_lt_84m 
local full4 final_7yr final_7yr_noimp

local rd: word count 1 `full1' `full2' `full3' `full4'

mat tab1 = J(`rd',3,.)

sum all
mat tab1[1,1] = r(sum)

sum all if dem_cohort==1
mat tab1[1,2] = r(sum)

sum all if dem_cohort==0
mat tab1[1,3] = r(sum)


local r = 2

foreach x of local full1 {

sum `x'
mat tab1[`r',1] = r(sum)

sum `x' if dem_cohort==1
mat tab1[`r',2] = r(sum)

sum `x' if dem_cohort==0
mat tab1[`r',3] = r(sum)

drop if `x'==1
local ++r
}

foreach x of local full2 {

sum `x'
mat tab1[`r',1] = r(sum)

sum `x' if dem_cohort==1
mat tab1[`r',2] = r(sum)

sum `x' if dem_cohort==0
mat tab1[`r',3] = r(sum)

local ++r
}

foreach x of local full3 {

sum `x'
mat tab1[`r',1] = r(sum)

sum `x' if dem_cohort==1
mat tab1[`r',2] = r(sum)

sum `x' if dem_cohort==0
mat tab1[`r',3] = r(sum)

drop if `x'==1
local ++r
}

foreach x of local full4 {

sum `x'
mat tab1[`r',1] = r(sum)

sum `x' if dem_cohort==1
mat tab1[`r',2] = r(sum)

sum `x' if dem_cohort==0
mat tab1[`r',3] = r(sum)

local ++r
}




mat rownames tab1 = all `full1' `full2' `full3' `full4'


frmttable using "E:\projects\burden_dementia\archive logs\Sample_Derivation.doc", replace statmat(tab1) ///
varlabels title("Sample Derivation for R01 (Deceased 2004-2015, Age 72+)") ctitles("Reason for Exclusion" "All" "Dementia" "Non-Dementia") sdec(0) ///
annotate(stars) asymbol(*,**)note("Death Date was determined by NDI, Medicare MBSF or HRS Exit in that order. Reasons for exclusion are ARE mutally exclusive.")

cap log close


restore
keep if final==1
save R01_j.dta, replace




H="Experimental - Annual Calculations Full Sample"

/**************** calculations *********************/
clear all
capture log close

global datapath "E:\data\burden_dementia\int_data"
local logpath "E:\data\burden_dementia\logs"
global ooppath "E:\data\burden_dementia\oopdata"
global output "E:\projects\burden_dementia\archive logs"


*log using `logpath'\R01_annual_calculations.txt, text replace

cd $datapath

use R01_j.dta, clear

/*
gen n1_2_death = index_date - c_ivw_date if nflag==1
replace n1_2_death = n1_2_death * 0.0329
replace n1_2_death = ceil(n1_2_death)
replace n1_2_death = 24 if n1_2_death>=24 & n1_2_death!=.
replace n1_2_death = 1 if n1_2_death<=0

gen core_b4_death = 0
replace core_b4_death = 1 if nflag==1

gsort id -core_b4_death

by id: carryforward n1_2_death, replace
*/
gen death_cat = .
replace death_cat = 1 if n1_2_death<12
replace death_cat = 2 if n1_2_death==12
replace death_cat = 3 if n1_2_death>12

cap drop mar_n0 mar_n1 mar_n2
cap drop mar

gen mar_n0 = . //months observed (aka "at risk") within a calendar year for helper hours cost imputation
gen mar_n1 = .
gen mar_n2 = .

replace mar_n0 = index_month if nflag==0
replace mar_n0 = n1_2_death if (n1_2_death-mar_n0 < 0) & nflag==0 // if they died the same year as their N1 ivw, then

replace mar_n1 = n1_2_death - mar_n0 if nflag==0
replace mar_n1 = 0 if mar_n1<0 & nflag==0
replace mar_n1 = 12 if (mar_n1>12 & mar_n1!=.) & nflag==0

replace mar_n2 = n1_2_death - mar_n0 -mar_n1 if nflag==0
replace mar_n2 = 0 if mar_n2<0


replace mar_n0 = c_ivw_month if nflag>0
replace mar_n1 = ivw_time - c_ivw_month if nflag>0
replace mar_n1 = 0 if mar_n1<0 & nflag>0
replace mar_n1 = 12 if (mar_n1>12 & mar_n1!=.) & nflag>0

replace mar_n2 = ivw_time - 12 - c_ivw_month if nflag>0
replace mar_n2 = 0 if mar_n2<0 & nflag>0
*replace mar_n2 = 12 if (mar_n2>12 & mar_n2!=.) & nflag>0

gen mar = mar_n0+mar_n1+mar_n2
corr mar n1_2_death if nflag==0
corr mar ivw_time if nflag>0 // checks to see if months at risk (mar) = months between ivw

gsort id +nflag

gen hlp_cost = hlphrs_i
replace hlp_cost = hlphrs_i_exit if nflag==0
replace hlp_cost = hlphrs_i_b if imputed==1

replace hlp_cost = 720 if hlp_cost>720 // capping hlphrs to 24 hours per day for each person

by id: gen hlp_cost_n = hlp_cost[_n+1]

/* Helper hours are currently 30 day estimates. Will create ~2 year totals using the
4 months at current ivw + remainder months*((current+previous)/2) */

gen hlp_cost_ivw = .
replace hlp_cost_ivw = n1_2_death*hlp_cost if n1_2_death<=4 & nflag==0
replace hlp_cost_ivw = (4*hlp_cost) + (n1_2_death-4)*((hlp_cost+hlp_cost_n)/2) if n1_2_death>4 & nflag==0
replace hlp_cost_ivw = (4*hlp_cost) + (ivw_time-4)*((hlp_cost+hlp_cost_n)/2) if nflag>0 & hlp_cost_n>0
replace hlp_cost_ivw = (4*hlp_cost) if nflag>0 & (hlp_cost_n==0 | hlp_cost_n==.)


egen hr_mean = mean(hr_rate)
egen hr_mean_n1 = mean(hr_rate_n1)
egen hr_mean_n2 = mean(hr_rate_n2)

replace hr_rate = hr_mean if hr_rate==.
replace hr_rate_n1 = hr_mean_n1 if hr_rate_n1==.
replace hr_rate_n2 = hr_mean_n2 if hr_rate_n2==.

foreach x of varlist hlp_cost_ivw  {

replace `x' = `x'/n1_2_death if nflag==0
replace `x' = `x'/ivw_time if nflag>0
replace `x' = (`x'*mar_n0*hr_rate) +  (`x'*mar_n1*hr_rate_n1) + (`x'*mar_n2*hr_rate_n2)

}


gen oop_cost = total_oop
replace oop_cost = total_imp_b if imputed==1
replace oop_cost = total_oop_exit if nflag==0

replace ivw_time = ceil(ivw_time)
replace ivw_time = 1 if ivw_time==0 & nflag==0

// Combining original OOP and imputed OOP into a single variable 


keep id death_cat nflag oop_cost hlp_cost_ivw n1_2_death c_ivw_year ivw_time

reshape wide oop_cost hlp_cost_ivw c_ivw_year ivw_time, i(id) j(nflag)


gen a = n1_2_death
gen b = ivw_time1
gen c = ivw_time2
gen d = ivw_time3
gen e = ivw_time4

*keep if death_cat<3

/* Year 1 cost imputation */


gen oop_y1 = ((a*oop_cost0)/ivw_time0) + (((12-a)*oop_cost1)/ivw_time1) if death_cat<=2
gen informal_y1 = ((a*hlp_cost_ivw0)/ivw_time0) + (((12-a)*hlp_cost_ivw1)/ivw_time1) if death_cat<=2

replace oop_y1 = ((12*oop_cost0)/ivw_time0) if death_cat==3
replace informal_y1 = ((12*hlp_cost_ivw0)/ivw_time0) if death_cat==3

replace b = b-(12-a) if death_cat<=2 // subtract the amount of months of N1 ivw that was used in Year 1
replace a = a - 12 if death_cat==3
replace a = 0 if death_cat<3

/* Year 2 cost */


gen oop_y2 = ((a*oop_cost0)/ivw_time0) +  (((12-a)*oop_cost1)/ivw_time1) if death_cat==3

gen informal_y2 = ((a*hlp_cost_ivw0)/ivw_time0) +  (((12-a)*hlp_cost_ivw1)/ivw_time1) if death_cat==3


replace b = b-(12-a) if death_cat==3

replace oop_y2 = ((b*oop_cost1)/ivw_time1) if b>=12 & death_cat<3
replace oop_y2 = ((b*oop_cost1)/ivw_time1) + (((12-b)*oop_cost2)/ivw_time2) if b<12 & death_cat<3


replace informal_y2 = ((b*hlp_cost_ivw1)/ivw_time1) if b>=12 & death_cat<3
replace informal_y2 = ((b*hlp_cost_ivw1)/ivw_time1) + (((12-b)*hlp_cost_ivw2)/ivw_time2) if b<12 & death_cat<3


replace c = c-(12-b) if b<12 & death_cat<2 // if b<12, part of the year came from N2 and needs to be subtracted
replace b = 0 if b<12 & death_cat<2 // recoding b to 0 to show that N1 interview will no longer contribute to cost
replace b = b-12 if b>=12 & death_cat<2 // if b>=12, used a full year of data from N1


/* Year 3 cost */

gen oop_y3 = ((b*oop_cost1)/ivw_time1) if b>=12
replace oop_y3 = ((b*oop_cost1)/ivw_time1) + (((12-b)*oop_cost2)/ivw_time2) if b<12


gen informal_y3 = ((b*hlp_cost_ivw1)/ivw_time1) if b>=12
replace informal_y3 = ((b*hlp_cost_ivw1)/ivw_time1) + (((12-b)*hlp_cost_ivw2)/ivw_time2) if b<12


replace c = c-(12-b) if b<12 // if b<12, part of the year came from N2 and needs to be subtracted
replace b = 0 if b<12 // recoding b to 0 to show that N1 interview will no longer contribute to cost
replace b = b-12 if b>=12 // if b>=12, used a full year of data from N1


/* Year 4 cost */

tab b
tab ivw_time1 /* not sure why so many people have >24 months attributed to 1 interview
there are weird cases e.g. 2010 core has a 2011 ivw date, so it ends up being ~ 3 years
between 2008 core and 2010. But expecting those to be in the minority */

*replace b = 12 if b>12 // need to remove and properly fix later

gen oop_y4 = ((b*oop_cost1)/ivw_time1) + (((12-b)*oop_cost2)/ivw_time2) if b>0 & b<=12 // if b = 12 the second term is zero
gen informal_y4 = ((b*hlp_cost_ivw1)/ivw_time1) + (((12-b)*hlp_cost_ivw2)/ivw_time2) if b>0 & b<=12 // if b = 12 the second term is zero

replace oop_y4 = ((b*oop_cost1)/ivw_time1) if b>=12
replace informal_y4 = ((b*hlp_cost_ivw1)/ivw_time1) if b>=12

gen tempflag = 1 if oop_y4!=.

replace c = c-(12-b) if b>0 & b<12 & tempflag==1 // if b<12, part of the year came from N2 and needs to be subtracted
replace b = 0 if b<12 & tempflag==1 // recoding b to 0 to show that N1 interview will no longer contribute to cost
replace b = b-12 if b>=12 & tempflag==1 // if b>=12, used a full year of data from N1

tab b


replace oop_y4 = ((c*oop_cost2)/ivw_time2) + (((12-c)*oop_cost3)/ivw_time3) if c<=12 & oop_y4==.
replace oop_y4 = ((c*oop_cost2)/ivw_time2) if c>12 & oop_y4==.

replace informal_y4 = ((c*hlp_cost_ivw2)/ivw_time2) + (((12-c)*hlp_cost_ivw3)/ivw_time3) if c<=12 & informal_y4==.
replace informal_y4 = ((c*hlp_cost_ivw2)/ivw_time2) if c>12 & informal_y4==.

replace d = d - (12-c) if c<12 & tempflag==.
replace c = 0 if c<12 & tempflag==.
replace c = c - 12 if c>=12 & tempflag==.

drop tempflag

/* Year 5 */

tab b

gen oop_y5 = ((b*oop_cost1)/ivw_time1) + (((12-b)*oop_cost2)/ivw_time2) if b>0 & b<=12
gen informal_y5 = ((b*hlp_cost_ivw1)/ivw_time1) + (((12-b)*hlp_cost_ivw2)/ivw_time2) if b>0 & b<=12 

replace oop_y5 = ((b*oop_cost1)/ivw_time1) if b>=12
replace informal_y5 = ((b*hlp_cost_ivw1)/ivw_time1) if b>=12

gen tempflag = 1 if oop_y5!=.

replace c = c-(12-b) if b>0 & b<12 & tempflag==1 // if b<12, part of the year came from N2 and needs to be subtracted
replace b = 0 if b<12 & tempflag==1 // recoding b to 0 to show that N1 interview will no longer contribute to cost
replace b = b-12 if b>=12 & tempflag==1 // if b>=12, used a full year of data from N1

replace oop_y5 = ((c*oop_cost2)/ivw_time2) + (((12-c)*oop_cost3)/ivw_time3) if c<=12 & oop_y5==.
replace oop_y5 = ((c*oop_cost2)/ivw_time2) if c>12 & oop_y5==.

replace informal_y5 = ((c*hlp_cost_ivw2)/ivw_time2) + (((12-c)*hlp_cost_ivw3)/ivw_time3) if c<=12 & informal_y5==.
replace informal_y5 = ((c*hlp_cost_ivw2)/ivw_time2) if c>12 & informal_y5==.

replace d = d - (12-c) if c<12 & tempflag==.
replace c = 0 if c<12 & tempflag==.
replace c = c - 12 if c>=12 & tempflag==.

drop tempflag

/* Year 6 */


gen oop_y6 = ((b*oop_cost1)/ivw_time1) + (((12-b)*oop_cost2)/ivw_time2) if b>0 & b<=12
gen informal_y6 = ((b*hlp_cost_ivw1)/ivw_time1) + (((12-b)*hlp_cost_ivw2)/ivw_time2) if b>0 & b<=12 

replace c = c-(12-b) if b>0 & b<12 & oop_y6!=. // if b<12, part of the year came from N2 and needs to be subtracted
replace b = 0 if b<12 & oop_y6!=. // recoding b to 0 to show that N1 interview will no longer contribute to cost
replace b = b-12 if b>=12 & oop_y6!=. // if b>=12, used a full year of data from N1

gen tempflag = 1 if c<=12 & oop_y6==.

replace oop_y6 = ((c*oop_cost2)/ivw_time2) + (((12-c)*oop_cost3)/ivw_time3) if c<=12 & oop_y6==.
replace informal_y6 = ((c*hlp_cost_ivw2)/ivw_time2) + (((12-c)*hlp_cost_ivw3)/ivw_time3) if c<=12 & informal_y6==.

replace d = d-(12-c) if c<12 & tempflag==1 // if b<12, part of the year came from N2 and needs to be subtracted
replace d = 0 if d<0 // temporary fix. 
replace c = 0 if c<12 & tempflag==1
replace c = c-12 if c>=12 & tempflag==1

gen tempflag1 = 1 if oop_y6==.

replace oop_y6 = ((d*oop_cost3)/ivw_time3) + (((12-d)*oop_cost4)/ivw_time4) if d<=12 & oop_y6==.
replace oop_y6 = ((d*oop_cost3)/ivw_time3) if d>12 & oop_y6==.

replace informal_y6 = ((d*hlp_cost_ivw3)/ivw_time3) + (((12-d)*hlp_cost_ivw4)/ivw_time4) if d<=12 & informal_y6==.
replace informal_y6 = ((d*hlp_cost_ivw3)/ivw_time3) if d>12 & informal_y6==.

replace e = e-(12-d) if d<12 & tempflag1==1
replace d = 0 if d<12 & tempflag1==1
replace d = d-12 if d>=12 & tempflag1==1

drop tempf*


/* Year 7 */

gen oop_y7 = ((c*oop_cost2)/ivw_time2) + (((12-c)*oop_cost3)/ivw_time3) if c>0 & c<=12 
replace oop_y7 = ((12*oop_cost2)/ivw_time2) if c>=12

replace oop_y7 = ((12*oop_cost3)/ivw_time3) if d>12 & oop_y7==.
replace oop_y7 = ((d*oop_cost3)/ivw_time3) + (((12-d)*oop_cost4)/ivw_time4) if d<=12 & oop_y7==.


gen informal_y7 = ((c*hlp_cost_ivw2)/ivw_time2) + (((12-c)*hlp_cost_ivw3)/ivw_time3) if c>0 & c<=12
replace informal_y7 = ((12*hlp_cost_ivw2)/ivw_time2) if c>12
replace informal_y7 = ((12*hlp_cost_ivw3)/ivw_time3) if d>12 & informal_y7==.
replace informal_y7 = ((d*hlp_cost_ivw3)/ivw_time3) + (((12-d)*hlp_cost_ivw4)/ivw_time4) if d<=12 & informal_y7==.




/* Visual check */

foreach x of varlist oop_y* informal_y* {

sum `x' 
}

save R01_annualized.dta, replace

*log close


H="experimental-oop setup"
global datapath "E:\data\burden_dementia\int_data"
*local logpath "E:\data\burden_dementia\logs"
global ooppath "E:\data\burden_dementia\oopdata"
global output "E:\projects\burden_dementia\archive logs"


/* Start with OOP dataset and then get interview dates for core and exit + death date */

use $ooppath\oopme_final_2016.dta, clear
rename *, l
gen id=hhid+pn

replace private_ltc=long_term_care if !missing(long_term_care)
foreach x in mc_b private_ltc {
	replace `x'_prem=`x'
	drop `x'
}



rename year core_year
merge 1:1 hhid pn core_year using "E:\data\hrs_cleaned\core_00_to_14.dta", keepus(c_ivw_date c_ivw_month c_ivw_year)
gen core = 1 if _m==3
gen exit_year = core_year if iwtype==1

cap drop _m

merge m:1 hhid pn exit_year using "E:\data\hrs_cleaned\exit_02_to_16_dt.dta", keepus(e_ivw_date)
gen exit = 1 if _m==3
drop if _m==2
cap drop _m

tempfile temp
save `temp'

use $datapath\R01_j.dta, clear
keep if nflag==0
tempfile ro1
save `ro1'

use `temp', clear

merge m:1 id using "`ro1'", keepus(index_date index_month index_year final final_7yr dem_cohort n1_2_death)
*keep if inrange(index_year,2004,2015)
*drop if _m==1
keep if _m==3

drop if core_year<1998 // dropping core interviews earlier than 1998

gsort id -core_year
by id: gen nflag = _n-1

/* dropping people with exit interviews before 2004 because earliest death year is 2004 */

gen droplist = 0
levelsof id if nflag==0 & iwtype==1 & exit_year<2004, local(drop) 

foreach x of local drop {
replace droplist = 1 if id=="`x'"
}

drop if droplist==1

gen year = core_year
drop _m
merge 1:1 id year using "E:\data\hrs_cleaned\helper_hours_2016.dta", keepus(n_i hlphrs_i)
drop if _m==2
drop _m

gsort id -year 
by id: gen next_date = c_ivw_date[_n+1]
format index_date next_date %td

gen death2_n1 = index_date - next_date if nflag==0

levelsof id if death2_n1<-30, local(drop)

foreach x of local drop {
replace droplist = 1 if id=="`x'"
}
drop if droplist==1

replace death2_n1 = death2_n1 * 0.0329
replace death2_n1 = ceil(death2_n1)
replace death2_n1 = 1 if death2_n1==0
replace months = death2_n1 if exit==1


/* Capping OOP RX spending to $300/month to bring in line with Medicare Part D and
previous OOP paper */

replace rx_oop = 0 if rx_oop==.
gen rx_per_mo = rx_oop/months
replace rx_per_mo = 300 if rx_per_mo>0 & rx_per_mo!=.

gen mod_rx_oop = rx_per_mo * months

replace total_oop = total_oop - rx_oop + mod_rx_oop

/* Modifying Helper HRS + Helper OOP to match Helper hours imputation in previous OOP paper */

gsort id -year

replace hlphrs_i = 720 if hlphrs_i>720 & hlphrs_i!=. // capping helperhrs reported to 24hrs(max)*30days per person

by id: gen prev_help_hrs = 1 if hlphrs_i[_n+1]>0 & hlphrs_i[_n+1]!=. //check for helper hrs at prev ivw
by id: gen prev_hrs = hlphrs_i[_n+1] if hlphrs_i[_n+1]>0
by id: gen prev_oop_yes = 1 if helper_oop[_n+1]>0 & helper_oop[_n+1]!=.
by id: gen prev_hlp_oop = (helper_oop[_n+1]/months[_n+1]) if helper_oop[_n+1]>0

gen helper_oop_per_mo = helper_oop/months
gen mod_helper_oop = helper_oop_per_mo * 4 if prev_oop_yes==. & months>=4
replace mod_helper_oop = helper_oop_per_mo * months if months<4
replace mod_helper_oop = (helper_oop_per_mo*4) + (months-4)*((helper_oop_per_mo+prev_hlp_oop)/2) ///
if prev_oop_yes==1 & months>=4
*replace mod_helper_oop = 

replace total_oop = total_oop - helper_oop + mod_helper_oop

/* Creating approximate 2/4 year helper hours based on above fomula */

gen total_hlp = hlphrs_i*4 if prev_help_hrs==. & months>=4
replace total_hlp=hlphrs_i*months if months<4
replace total_hlp = (hlphrs_i*4) + (months-4)*((hlphrs_i+prev_hrs)/2) ///
if prev_help_hrs==1 & months>=4

replace total_hlp = 0 if total_hlp==. // estimated total hours per interview



/* Create year variables to merge helper hours with yearly genworth costs */

gen c_ivw_year_n0 = c_ivw_year
replace c_ivw_year_n0 = index_year if nflag==0
gen c_ivw_year_n1 = c_ivw_year_n0 - 1
label var c_ivw_year_n1 "calendar year prior to ivw date"
gen c_ivw_year_n2 = c_ivw_year_n0 - 2
label var c_ivw_year_n2 "calendar year 2 yrs prior to ivw date"
gen c_ivw_year_n3 = c_ivw_year_n0 - 3
label var c_ivw_year_n3 "calendar year 3 yrs prior to ivw date"
gen c_ivw_year_n4 = c_ivw_year_n0 - 4
label var c_ivw_year_n4 "calendar year 4 yrs prior to ivw date"
gen c_ivw_year_n5 = c_ivw_year_n0 - 5
label var c_ivw_year_n5 "calendar year 5 yrs prior to ivw date"

cap drop stateusups

save $datapath/R01_cost_int.dta, replace


/************** Get State information from tracker to match with genworth *************/
cd $datapath

use r01_cost_int.dta, clear
keep id

duplicates drop id, force
tempfile id
save `id'

// creating CPI-U 
clear
set obs 21
gen obs = _n
gen year = .
gen cpi_rate = .

forvalues i=1/21 {

replace year = 2017 - `i' if obs==`i'

}

replace cpi_rate = 1 if year==2016
replace cpi_rate=1.01262 if year==2015
replace cpi_rate=1.01382 if year==2014
replace cpi_rate=1.03026 if year==2013
replace cpi_rate=1.04535 if year==2012
replace cpi_rate=1.06699 if year==2011
replace cpi_rate=1.10067 if year==2010
replace cpi_rate=1.11872 if year==2009
replace cpi_rate=1.11474 if year==2008
replace cpi_rate=1.15754 if year==2007
replace cpi_rate=1.19051 if year==2006
replace cpi_rate=1.22891 if year==2005
replace cpi_rate=1.27055 if year==2004
replace cpi_rate=1.30439 if year==2003
replace cpi_rate=1.33411 if year==2002
replace cpi_rate=1.35521 if year==2001
replace cpi_rate=1.39377 if year==2000
replace cpi_rate=1.44062 if year==1999
replace cpi_rate=1.47244 if year<=1998

rename year c_ivw_year
label var cpi_rate "Inflation adjustment factor"
tempfile cpi
save `cpi'

// pull tracker
use "E:\data\hrs_cleaned\restr_tracker_v2014.dta", clear
drop id
gen id=hhid+pn

merge 1:1 id using "`id'"
keep if _m==3

keep hhid pn stateusps* zipcode*

gen stateusps16 = stateusps14
gen zipcode16 = zipcode14

foreach x of varlist stateusps* {

replace `x' = "" if `x'=="ZZ"

}

gen stateusps97=""
gen stateusps99=""

forvalues i= 1(2)15{
gen stateusps`i'=""
gen zipcode`i' = ""
}

forvalues i=0(2)8{
rename stateusps0`i' stateusps`i'
rename zipcode0`i' zipcode`i'
}
reshape long stateusps zipcode, i(hhid pn) j(c_ivw_year)

forvalues i=0/99{
qui replace c_ivw_year=200`i' if c_ivw_year==`i' & c_ivw_year<=9
qui replace c_ivw_year=20`i' if c_ivw_year==`i' & inrange(c_ivw_year, 10,16)
qui replace c_ivw_year=19`i' if c_ivw_year==`i' & c_ivw_year>=90
}

gen id= hhid+pn
sort id c_ivw_year
drop if id==""
by id: carryforward stateusps, replace

gsort id -c_ivw_year
by id: carryforward stateusps, replace

gen e_ivw_year=c_ivw_year
merge m:1 c_ivw_year using "`cpi'", keepus(cpi_rate)
cap drop _m

rename c_ivw_year c_ivw_year_n0
tempfile state
save "`state'"


rename c_ivw_year_n0 c_ivw_year_n1
rename stateusps stateusps_n1
rename cpi_rate cpi_rate_n1
tempfile state_n1
save `state_n1'

rename c_ivw_year_n1 c_ivw_year_n2
rename stateusps_n1 stateusps_n2 
rename cpi_rate_n1 cpi_rate_n2
tempfile state_n2
save `state_n2'

rename c_ivw_year_n2 c_ivw_year_n3
rename stateusps_n2 stateusps_n3 
rename cpi_rate_n2 cpi_rate_n3
tempfile state_n3
save `state_n3'

rename c_ivw_year_n3 c_ivw_year_n4
rename stateusps_n3 stateusps_n4
rename cpi_rate_n3 cpi_rate_n4
tempfile state_n4
save `state_n4'

rename c_ivw_year_n4 c_ivw_year_n5
rename stateusps_n4 stateusps_n5
rename cpi_rate_n4 cpi_rate_n5
tempfile state_n5
save `state_n5'



use R01_cost_int.dta, clear
/*
gen e_ivw_year=year(e_ivw_date)
replace e_ivw_year=exit_year if missing(e_ivw_year)
merge m:1 id e_ivw_year using "`state'"
drop if _m==2
drop _m
*/

merge m:1 id c_ivw_year_n0 using "`state'"
drop if _m==2
cap drop _m
merge m:1 id c_ivw_year_n1 using "`state_n1'"
drop if _m==2
cap drop _m
merge m:1 id c_ivw_year_n2 using "`state_n2'"
drop if _m==2
cap drop _m
merge m:1 id c_ivw_year_n3 using "`state_n3'"
drop if _m==2
cap drop _m
merge m:1 id c_ivw_year_n4 using "`state_n4'"
drop if _m==2
cap drop _m
merge m:1 id c_ivw_year_n5 using "`state_n5'"
drop if _m==2
cap drop _m


save R01_cost_intb.dta, replace

//merging with the Genworth/Metlife hourly home health aide cost. 
import excel "E:\data\burden_dementia\ref_data\Cost Care Survey (Genworth-Metlife)\HHA_hourly_genworth.xlsx", sheet("Sheet1") firstrow clear

rename A c_ivw_year
rename B stateusps
rename HomeHealthAideServicesHourly state_hha
rename MedianHourlyRate hr_rate

drop if c_ivw_year==.
destring hr_rate, replace

expand 2 if c_ivw_year==1998, gen(duptag)

replace c_ivw_year = c_ivw_year - 1 if duptag==1
cap drop duptag

expand 2 if c_ivw_year==1997, gen(duptag)

replace c_ivw_year = c_ivw_year - 1 if duptag==1
drop duptag

//3/6/19-ebl-was not merging with exit data, so we were missing those years
gen e_ivw_year=c_ivw_year

rename c_ivw_year c_ivw_year_n0

tempfile rate
save "`rate'" // hourly rate for calendar c_ivw_year of i

rename c_ivw_year_n0 c_ivw_year_n1
rename stateusps stateusps_n1
rename state_hha state_hha_n1
rename hr_rate hr_rate_n1

tempfile rate_n1
save "`rate_n1'"

rename c_ivw_year_n1 c_ivw_year_n2
rename stateusps_n1 stateusps_n2
rename state_hha_n1 state_hha_n2
rename hr_rate_n1 hr_rate_n2

tempfile rate_n2
save "`rate_n2'"

rename c_ivw_year_n2 c_ivw_year_n3
rename stateusps_n2 stateusps_n3
rename state_hha_n2 state_hha_n3
rename hr_rate_n2 hr_rate_n3

tempfile rate_n3
save "`rate_n3'"

rename c_ivw_year_n3 c_ivw_year_n4
rename stateusps_n3 stateusps_n4
rename state_hha_n3 state_hha_n4
rename hr_rate_n3 hr_rate_n4

tempfile rate_n4
save "`rate_n4'"

rename c_ivw_year_n4 c_ivw_year_n5
rename stateusps_n4 stateusps_n5
rename state_hha_n4 state_hha_n5
rename hr_rate_n4 hr_rate_n5

tempfile rate_n5
save "`rate_n5'"


use R01_cost_intb.dta, clear
cap drop _m
merge m:1 c_ivw_year_n0 stateusps using "`rate'"
drop if _m==2
cap drop _m
/*
merge m:1 e_ivw_year stateusps using "`rate'"
drop if _m==2
cap drop _m
*/
merge m:1 c_ivw_year_n1 stateusps_n1 using "`rate_n1'"
drop if _m==2
cap drop _m
merge m:1 c_ivw_year_n2 stateusps_n2 using "`rate_n2'"
drop if _m==2
cap drop _m
merge m:1 c_ivw_year_n3 stateusps_n3 using "`rate_n3'"
drop if _m==2
cap drop _m
merge m:1 c_ivw_year_n4 stateusps_n4 using "`rate_n4'"
drop if _m==2
cap drop _m
merge m:1 c_ivw_year_n5 stateusps_n5 using "`rate_n5'"
drop if _m==2
cap drop _m


save R01_cost_intc.dta, replace

use R01_cost_intc.dta, replace

gen mar_n0 = . //months observed (aka "at risk") within a calendar year for helper hours cost imputation
gen mar_n1 = .
gen mar_n2 = .
gen mar_n3 = .
gen mar_n4 = .
gen mar_n5 = .


// exit ivw
replace mar_n0 = index_month if nflag==0
replace mar_n0 = death2_n1 if (death2_n1-mar_n0 < 0) & nflag==0 // if they died the same year as their N1 ivw, then

replace mar_n1 = death2_n1 - mar_n0 if nflag==0
replace mar_n1 = 0 if mar_n1<0 & nflag==0
replace mar_n1 = 12 if (mar_n1>12 & mar_n1!=.) & nflag==0

replace mar_n2 = death2_n1 - mar_n0 -mar_n1 if nflag==0
replace mar_n2 = 0 if mar_n2<0 & nflag==0
replace mar_n2 = 12 if (mar_n2>12 & mar_n2!=.) & nflag==0

replace mar_n3 = death2_n1 - mar_n0 -mar_n1 -mar_n2 if nflag==0
replace mar_n3 = 0 if mar_n3<0 & nflag==0
replace mar_n3 = 12 if (mar_n3>12 & mar_n3!=.) & nflag==0

replace mar_n4 = death2_n1 - mar_n0 -mar_n1 -mar_n2 - mar_n3 if nflag==0
replace mar_n4 = 0 if mar_n4<0 & nflag==0
replace mar_n4 = 12 if (mar_n4>12 & mar_n4!=.) & nflag==0

// core ivw

replace mar_n0 = c_ivw_month if nflag>0
replace mar_n1 = months - c_ivw_month if nflag>0
replace mar_n1 = 0 if mar_n1<0 & nflag>0
replace mar_n1 = 12 if (mar_n1>12 & mar_n1!=.) & nflag>0

replace mar_n2 = months - 12 - c_ivw_month if nflag>0
replace mar_n2 = 0 if mar_n2<0 & nflag>0
replace mar_n2 = 12 if (mar_n2>12 & mar_n2!=.) & nflag>0

replace mar_n3 = months - 24 - c_ivw_month if nflag>0
replace mar_n3 = 0 if mar_n3<0 & nflag>0
replace mar_n3 = 12 if (mar_n3>12 & mar_n3!=.) & nflag>0

replace mar_n4 = months - 36 - c_ivw_month if nflag>0
replace mar_n4 = 0 if mar_n4<0 & nflag>0
replace mar_n4 = 12 if (mar_n4>12 & mar_n4!=.) & nflag>0

replace mar_n5 = months - 48 - c_ivw_month if nflag>0
replace mar_n5 = 0 if mar_n5<0 & nflag>0
replace mar_n5 = 12 if (mar_n5>12 & mar_n5!=.) & nflag>0



// impute mean hourly rate for people missing states
//3/5/19-ebl-replace with national median in 2016
//3/6/19-ebl-hopefully fixed the merging issue with exits, so there shouldn't be missingness, leaving commented out for now
/*
foreach x in "" _n1 _n2 _n3 _n4 _n5 {
	replace cpi_rate`x'=1 if missing(cpi_rate`x')
	replace hr_rate`x'=20.25 if missing(hr_rate`x')
}

*/
foreach x of varlist mar_n0 mar_n1 mar_n2 mar_n3 mar_n4 mar_n5 hr_rate hr_rate_n1 hr_rate_n2 hr_rate_n3 hr_rate_n4 hr_rate_n5 cpi_rate cpi_rate_n1 cpi_rate_n2 cpi_rate_n3 cpi_rate_n4 cpi_rate_n5 {

replace `x' = 0 if `x'==.
}


/*
foreach x of varlist total_hlp {

replace `x' = `x'/months // average # of helpers per month after 4/20 split
replace `x' = (`x'*mar_n0*hr_rate*cpi_rate) +  (`x'*mar_n1*hr_rate_n1*cpi_rate_n1) ///
 + (`x'*mar_n2*hr_rate_n2*cpi_rate_n2) +  (`x'*mar_n3*hr_rate_n3*cpi_rate_n3) + ///
 (`x'*mar_n4*hr_rate_n4*cpi_rate_n4) + (`x'*mar_n5*hr_rate_n5*cpi_rate_n5) // total helper cost per ivw

}
*/

foreach x of varlist total_hlp {

*replace `x' = `x'/months // average # of helpers per month after 4/20 split
replace `x' = (`x'*hr_rate*cpi_rate) 
}


foreach x in mc_b_prem private_ltc_prem nh_nights nh_oop {
	replace `x'=0 if missing(`x')
	replace `x' = `x'/months
}

save R01_cost_intd.dta, replace

use R01_cost_intd.dta, replace

cap drop hlp

gen hlp = total_hlp / months

cap drop oop 
gen oop = total_oop / months

keep id core_year nflag oop hlp months final final_7yr dem_cohort index_year mc_b_prem private_ltc_prem nh_nights nh_oop

reshape wide core_year oop hlp months mc_b_prem private_ltc_prem nh_nights nh_oop, i(id) j(nflag)

forvalues i = 1/7 {

foreach x in x in hlp oop mc_b_prem private_ltc_prem nh_nights nh_oop {

gen `x'_y`i'=.

}

}
// Annualized Costs - Year 1

* start with oop at exit if months < 12. Subtract months - 12 so that it can be pulled from N1
foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y1 = `x'0 * months0 if months0<12
}

replace months0 = months0 - 12 if months0<12

* Pulling the leftover months from N1 (if exit < 12)
foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y1 = `x'_y1 + (-months0)*`x'1 if months0<0
}

replace months1 = months1 + months0 if months0<0

*Using full exit if exit months==12
foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y1 = `x'0 * 12 if months0==12
}

replace months0 = 0 if months0==12

* Using 12 months from exit if exit months>12
foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y1 = `x'0 * 12 if months0>12 & months0!=.
}

replace months0 = months0 - 12 if months0>12 & months0!=.
replace months0 = . if months0 <=0

// Annualized Costs - Year 2

* People with leftover oop exit data
foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y2 = `x'0  * months0 if months0<12
}

replace months0 = months0 - 12 if months0<12


foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y2 = `x'_y2 + (-months0)*`x'1 if months0<0
}

replace months1 = months1 + months0 if months0<0

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y2 = `x'0 * 12 if months0==12
}

replace months0 = months0 - 12 if months0==12

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y2 = `x'0 * 12 if months0>12 & months0!=.
}

replace months0 = months0 - 12 if months0>12 & months0!=.


* People with no exit data leftover from y1

gen noop = 1 if oop_y2==.

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y2 = `x'1 * months1 if months1<12 & noop==1
}
replace months1 = months1 - 12 if months1<12 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y2 = `x'_y2 + (-months1)*`x'2 if months1<0 & noop==1
}

replace months2 = months2 + months1 if months1<0 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y2 = `x'1 * 12 if months1==12 & noop==1
}

replace months1 = months1 - 12 if months1==12 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y2 = `x'1 * 12 if months1>12 & months1!=. & noop==1
}
replace months1 = months1 - 12 if months1>12 & months1!=. & noop==1
replace months0 = . if months0<=0
replace months1 = . if months1<=0
drop noop

// oop_y3

* People with leftover oop exit data
foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y3 =  `x'0 * months0 if months0<12
}
replace months0 = months0 - 12 if months0<12

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y3 = `x'_y3 + (-months0)*`x'1 if months0<0
}
replace months1 = months1 + months0 if months0<0

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y3 = `x'0 * 12 if months0==12
}

replace months0 = months0 - 12 if months0==12

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y3 =  `x'0 * 12 if months0>12 & months0!=.
}

replace months0 = months0 - 12 if months0>12 & months0!=.

* People with leftover N1

gen noop = 1 if oop_y3==.

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y3 =  `x'1 * months1 if months1<12 & noop==1
}
replace months1 = months1 - 12 if months1<12 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y3 =  `x'_y3 + (-months1)*`x'2 if months1<0 & noop==1
}
replace months2 = months2 + months1 if months1<0 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y3 =  `x'1 * 12 if months1==12 & noop==1
}

replace months1 = months1 - 12 if months1==12 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y3 =  `x'1 * 12 if months1>12 & months1!=. & noop==1
}
replace months1 = months1 - 12 if months1>12 & months1!=. & noop==1

drop noop

* People who exhausted N0 & N1

gen noop = 1 if oop_y3==.

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y3 =   `x'2 * 12 if noop==1
}
replace months2 = months2 - 12 if noop==1

replace months0 = . if months0<=0
replace months1 = . if months1<=0
replace months2 = . if months2<=0

drop noop 

// Annual Costs - Year 4


* People with leftover oop exit data
foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y4 =  `x'0 * months0 if months0<12
}
replace months0 = months0 - 12 if months0<12

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y4 =  `x'_y4 + (-months0)*`x'1 if months0<0
}
replace months1 = months1 + months0 if months0<0

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y4 =  `x'0 * 12 if months0==12
}
replace months0 = months0 - 12 if months0==12

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y4 =  `x'0 * 12 if months0>12 & months0!=.
}
replace months0 = months0 - 12 if months0>12 & months0!=.

* People with leftover N1

gen noop = 1 if oop_y4==.

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y4 =   `x'1 * months1 if months1<12 & noop==1
}
replace months1 = months1 - 12 if months1<12 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y4 =  `x'_y4 + (-months1)*`x'2 if months1<0 & noop==1
}
replace months2 = months2 + months1 if months1<0 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y4 =  `x'1 * 12 if months1==12 & noop==1
}
replace months1 = months1 - 12 if months1==12 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y4 =  `x'1 * 12 if months1>12 & months1!=. & noop==1
}

replace months1 = months1 - 12 if months1>12 & months1!=. & noop==1

drop noop

* People who exhausted N0 & N1

gen noop = 1 if oop_y4==.

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y4 =  `x'2 * months2 if months2<12 & noop==1
}

replace months2 = months2 - 12 if months2<12 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y4 =  `x'_y4 + (-months2)*`x'3 if months2<0 & noop==1
}
replace months3 = months3 + months2 if months2<0 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y4 =  `x'2 * 12 if months2==12 & noop==1
}
replace months2 = months2 - 12 if months2==12 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y4 =  `x'2 * 12 if months2>12 & months2!=. & noop==1
}

replace months2 = months2 - 12 if months2>12 & months2!=. & noop==1

replace months0 = . if months0<=0
replace months1 = . if months1<=0
replace months2 = . if months2<=0

drop noop 


// oop_y5

* People with leftover oop exit data
foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y5 =  `x'0 * months0 if months0<12
}
replace months0 = months0 - 12 if months0<12

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y5 =  `x'_y5 + (-months0)*`x'1 if months0<0
}

replace months1 = months1 + months0 if months0<0

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y5 =  `x'0 * 12 if months0==12
}

replace months0 = months0 - 12 if months0==12

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y5 =  `x'0 * 12 if months0>12 & months0!=.
}
replace months0 = months0 - 12 if months0>12 & months0!=.

* People with leftover N1

gen noop = 1 if oop_y5==.

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y5 =  `x'1 * months1 if months1<12 & noop==1
}

replace months1 = months1 - 12 if months1<12 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y5 =  `x'_y5 + (-months1)*`x'2 if months1<0 & noop==1
}
replace months2 = months2 + months1 if months1<0 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y5 =  `x'1 * 12 if months1==12 & noop==1
}

replace months1 = months1 - 12 if months1==12 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y5 =  `x'1 * 12 if months1>12 & months1!=. & noop==1
}
replace months1 = months1 - 12 if months1>12 & months1!=. & noop==1

drop noop

* People who exhausted N0 & N1

gen noop = 1 if oop_y5==.

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y5 =  `x'2 * months2 if months2<12 & noop==1
}
replace months2 = months2 - 12 if months2<12 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y5 = `x'_y5 + (-months2)*`x'3 if months2<0 & noop==1
}

replace months3 = months3 + months2 if months2<0 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y5 = `x'2 * 12 if months2==12 & noop==1
}

replace months2 = months2 - 12 if months2==12 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y5 = `x'2 * 12  if months2>12 & months2!=. & noop==1
}

replace months2 = months2 - 12 if months2>12 & months2!=. & noop==1

drop noop 

* People who exhausted N0, N1 & N2

gen noop = 1 if oop_y5==.

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y5 = `x'3 * 12 if noop==1
}

replace months3 = months3 - 12 if noop==1


replace months0 = . if months0<=0
replace months1 = . if months1<=0
replace months2 = . if months2<=0
replace months3 = . if months3<=0

drop noop

// oop_y6

* People with leftover N1

gen noop = 1 if oop_y6==.

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y6 = `x'1 * months1 if months1<12 & noop==1
}

replace months1 = months1 - 12 if months1<12 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y6 = `x'_y6 + (-months1)*`x'2 if months1<0 & noop==1
}

replace months2 = months2 + months1 if months1<0 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y6 = `x'1 * 12 if months1==12 & noop==1
}

replace months1 = months1 - 12 if months1==12 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y6 = `x'1 * 12 if months1>12 & months1!=. & noop==1
}

replace months1 = months1 - 12 if months1>12 & months1!=. & noop==1

drop noop

* People who exhausted N0 & N1

gen noop = 1 if oop_y6==.


foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y6 = `x'2 * months2 if months2<12 & noop==1
}

replace months2 = months2 - 12 if months2<12 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y6 = `x'_y6 + (-months2)*`x'3 if months2<0 & noop==1
}

replace months3 = months3 + months2 if months2<0 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y6 = `x'2 * 12 if months2==12 & noop==1
}

replace months2 = months2 - 12 if months2==12 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y6 = `x'2 * 12 if months2>12 & months2!=. & noop==1
}

replace months2 = months2 - 12 if months2>12 & months2!=. & noop==1

drop noop 

* People who exhausted N0, N1 & N2

gen noop = 1 if oop_y6==.

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y6 = `x'3 * months3 if months3<12 & noop==1
}
replace months3 = months3 - 12 if months3<12 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y6 =  `x'_y6 + (-months3)*`x'4 if months3<0 & noop==1
}

replace months4 = months4 + months3 if months3<0 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y6 =  `x'3 * 12 if months3==12 & noop==1
}


replace months3 = months3 - 12 if months3==12 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y6 =  `x'3 * 12 if months3>12 & months3!=. & noop==1
}

replace months3 = months3 - 12 if months3>12 & months3!=. & noop==1


replace months0 = . if months0<=0
replace months1 = . if months1<=0
replace months2 = . if months2<=0
replace months3 = . if months3<=0

drop noop

// Annual Costs - Year 7

* People with leftover N1

gen noop = 1 if oop_y7==.

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y7 =  `x'1 * months1 if months1<12 & noop==1
}

replace months1 = months1 - 12 if months1<12 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y7 =`x'_y7 + (-months1)*`x'2 if months1<0 & noop==1
}

replace months2 = months2 + months1 if months1<0 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y7 = `x'1 * 12 if months1==12 & noop==1
}

replace months1 = months1 - 12 if months1==12 & noop==1


foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y7 = `x'1 * 12 if months1>12 & months1!=. & noop==1
}

replace months1 = months1 - 12 if months1>12 & months1!=. & noop==1

drop noop

* People who exhausted N0 & N1

gen noop = 1 if oop_y7==.

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y7 = `x'2 * months2 if months2<12 & noop==1
}
replace months2 = months2 - 12 if months2<12 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y7 = `x'_y7 + (-months2)*`x'3 if months2<0 & noop==1
}
replace months3 = months3 + months2 if months2<0 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y7 =  `x'2 * 12 if months2==12 & noop==1
}
replace months2 = months2 - 12 if months2==12 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y7 =  `x'2 * 12 if months2>12 & months2!=. & noop==1
}

replace months2 = months2 - 12 if months2>12 & months2!=. & noop==1

drop noop 

* People who exhausted N0, N1 & N2

gen noop = 1 if oop_y7==.

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y7 = `x'3 * months3 if months3<12 & noop==1
}

replace months3 = months3 - 12 if months3<12 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y7 =  `x'_y7 + (-months3)*`x'4 if months3<0 & noop==1
}
replace months4 = months4 + months3 if months3<0 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y7 = `x'3 * 12 if months3==12 & noop==1
}

replace months3 = months3 - 12 if months3==12 & noop==1

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y7 = `x'3 * 12 if months3>12 & months3!=. & noop==1
}

replace months3 = months3 - 12 if months3>12 & months3!=. & noop==1


replace months0 = . if months0<=0
replace months1 = . if months1<=0
replace months2 = . if months2<=0
replace months3 = . if months3<=0

drop noop
* People who exhausted N0, N1, N2 & N3

gen noop = 1 if oop_y7==.

foreach x in oop hlp mc_b_prem private_ltc_prem nh_nights nh_oop {
replace `x'_y7 = `x'4 * 12 if noop==1
}




gen oop_7yr = oop_y1+ oop_y2+ oop_y3+ oop_y4+ oop_y5 + oop_y6 + oop_y7
gen oop_6yr = oop_y1+ oop_y2+ oop_y3+ oop_y4+ oop_y5 + oop_y6
gen oop_5yr = oop_y1+ oop_y2+ oop_y3+ oop_y4+ oop_y5
gen oop_4yr = oop_y1+ oop_y2+ oop_y3+ oop_y4
gen oop_3yr = oop_y1+ oop_y2+ oop_y3
gen oop_2yr = oop_y1+ oop_y2

ttest oop_5yr, by(dem_cohort)
ttest oop_5yr if final_7yr==1, by(dem_cohort)
ttest oop_7yr if final_7yr==1, by(dem_cohort)

forvalues i = 1/7 {

rename oop_y`i' oop_y`i'b
rename hlp_y`i' informal_y`i'b
}


gen informal_7yr = informal_y1+ informal_y2+ informal_y3+ informal_y4+ informal_y5 + informal_y6 + informal_y7
gen informal_6yr = informal_y1+ informal_y2+ informal_y3+ informal_y4+ informal_y5 + informal_y6
gen informal_5yr = informal_y1+ informal_y2+ informal_y3+ informal_y4+ informal_y5
gen informal_4yr = informal_y1+ informal_y2+ informal_y3+ informal_y4
gen informal_3yr = informal_y1+ informal_y2+ informal_y3
gen informal_2yr = informal_y1+ informal_y2

ttest informal_5yr, by(dem_cohort)
ttest informal_5yr if final_7yr==1, by(dem_cohort)
ttest informal_7yr if final_7yr==1, by(dem_cohort)

foreach x in oop informal {

rename `x'_5yr `x'_5yrb
rename `x'_7yr `x'_7yrb
}

save R01_annualized_b.dta, replace

use R01_annualized_b.dta, replace

merge 1:1 id using R01_annualized.dta


local ivars informal_y1 informal_y2 informal_y3 informal_y4 informal_y5 informal_y6 informal_y7 informal_5yr informal_7yr
local ivars2 informal_y1b informal_y2b informal_y3b informal_y4b informal_y5b informal_y6b informal_y7b informal_5yrb informal_7yrb

local rd: word count `ivars'

mat tab1=J(`rd',2,.)

local r = 1

foreach x of local ivars {

sum `x'
mat tab1[`r',1] = r(mean)

local ++r
}

local r = 1

foreach x of local ivars2 {

sum `x'
mat tab1[`r',2] = r(mean)

local ++r 
}
mat rownames tab1 = `ivars'

frmttable using "E:\data\burden_dementia\logs\R01_costs.doc", replace statmat(tab1) ///
varlabels title("Annualized ") ctitles("", "Complicated method ","Simple Method") sdec(2) ///
note("All costs have been inflation adjusted to 2016 dollars")




H="Experimental - Comparison of 5yr vs 7yr Sample"
clear all
capture log close

global datapath "E:\data\burden_dementia\int_data"
global final "E:\data\burden_dementia\final_data"
local logpath "E:\data\burden_dementia\logs"
global ooppath "E:\data\burden_dementia\oopdata"
global output "E:\projects\burden_dementia\archive logs"

cd $datapath

use "E:\data\burden_dementia\int_data\predicted_annual_medicaid_costs.dta", clear

rename year index_year

tempfile predict
save `predict'


use R01_j.dta, clear

merge m:1 id using R01_annualized.dta, keepus(oop_y* informal_y*)
drop _m

merge m:1 id using tot_paid_maid.dta, keepus(tot_paid_m*)
drop if _m==2
cap drop _m

merge m:1 id index_year using `predict', keepus(buyin_mo generous)
drop if _m==2
cap drop _m



gen ffs_7yr = 0 
replace ffs_7yr = 1 if cont_ffs_n_mos>=84 & cont_ffs_n_mos!=.

gen ffs_6yr = 0 
replace ffs_6yr = 1 if cont_ffs_n_mos>=72 & cont_ffs_n_mos!=.

gen ffs_5yr = 0
replace ffs_5yr = 1 if cont_ffs_n_mos>=60 & cont_ffs_n_mos!=.

gen ffs_4yr = 0
replace ffs_4yr = 1 if cont_ffs_n_mos>=48 & cont_ffs_n_mos!=.

gen ffs_3yr = 0
replace ffs_3yr = 1 if cont_ffs_n_mos>=36 & cont_ffs_n_mos!=.

gen ffs_2yr = 0
replace ffs_2yr = 1 if cont_ffs_n_mos>=24 & cont_ffs_n_mos!=.

gen ffs_1yr = 0
replace ffs_1yr = 1 if cont_ffs_n_mos>=12 & cont_ffs_n_mos!=.


gen white = 0 if nflag==0
replace white = 1 if race==1 & hisp_eth==0 & nflag==0

gen black = 0 if nflag==0
replace black = 1 if race==2 & hisp_eth==0 & nflag==0

gen other = 0 if nflag==0
replace other = 1 if white==0 & black==0 & hisp_eth==0 & nflag==0

label var white "Non-Hispanic White"
label var black "Non-Hispanic Black"
label var other "Non-Hispanic Other"

label var tot_paid_maid_n1 "Total Medicaid Spending Y1"
label var tot_paid_maid_n2 "Total Medicaid Spending Y2"
label var tot_paid_maid_n3 "Total Medicaid Spending Y3"
label var tot_paid_maid_n4 "Total Medicaid Spending Y4"
label var tot_paid_maid_n5 "Total Medicaid Spending Y5"
label var tot_paid_maid_n6 "Total Medicaid Spending Y6"
label var tot_paid_maid_n7 "Total Medicaid Spending Y7"

forvalues i = 1/7 {
rename tot_paid_maid_n`i' tot_paid_maid_y`i'
}

local y = 1
forvalues i = 12(12)84 {



rename tot_paid_by_mc_`i'm tot_paid_by_mc_y`y'

label var tot_paid_by_mc_y`y' "Total Medicare Spending Y`y'"

local ++y
}

gen adl_dep_n1 = 0 if nflag<=1 & adl_index_core!=.
replace adl_dep_n1 = 1 if adl_index_core>0 & adl_index_core!=. & nflag==1
label var adl_dep_n1 "ADL Dependent at N1"

gen iadl_dep_n1 = 0 if nflag<=1 & iadl_ind_core!=.
replace iadl_dep_n1 = 1 if nflag==1 & iadl_ind_core>0 & iadl_ind_core!=.
label var iadl_dep_n1 "IADL Dependent at N1"

levelsof id if adl_dep_n1==1, local(adldep)

foreach x of local adldep {
replace adl_dep_n1 = 1 if id=="`x'" & nflag==0
}

levelsof id if iadl_dep_n1==1, local(iadldep)
foreach x of local iadldep {
replace iadl_dep_n1 = 1 if id=="`x'" & nflag==0
}


local ivars female_exit hseduc white black hisp_eth other nhres_exit married_exit reschil_d_exit resspouse_exit livealone_exit adl_dep_n1 iadl_dep_n1 medicare_exit medicareb_exit medicaid_exit champus_exit dem_cohort ffs_7yr ffs_6yr ffs_5yr ffs_4yr ffs_3yr ffs_2yr ffs_1yr
local cvars age_at_death comor_in_hrs 
local medcost age_at_death tot_paid_maid_y1 tot_paid_maid_y2 tot_paid_maid_y3 tot_paid_maid_y4 tot_paid_maid_y5 tot_paid_maid_y6 tot_paid_maid_y7 tot_paid_by_mc_y1 tot_paid_by_mc_y2 tot_paid_by_mc_y3 tot_paid_by_mc_y4 tot_paid_by_mc_y5 tot_paid_by_mc_y6 tot_paid_by_mc_y7 ///
oop_y1 oop_y2 oop_y3 oop_y4 oop_y5 oop_y6 oop_y7 informal_y1 informal_y2 informal_y3 informal_y4 informal_y5 informal_y6 informal_y7 


gsort id nflag
by id: carryforward `ivars', replace



save $final\R01_final.dta, replace

preserve 
keep if nflag==1

gen all = 1



local rd: word count `ivars' `cvars' 1

mat tab1=J(`rd', 3,.)
mat stars=J(`rd',3,0)
local r = 1

foreach x of local ivars {

sum `x' if all==1

mat tab1[`r',1] = r(mean)*100

sum `x' if all==1 & final_7yr==1
mat tab1[`r',2] = r(mean)*100

sum `x' if all==1 & final_7yr==0
mat tab1[`r',3] = r(mean)*100

tab `x' final_7yr if all==1, chi2
mat stars[`r',2] = (r(p)<.01) + (r(p)<0.05)



local ++r
}

foreach x of local cvars {

sum `x' if all==1 

mat tab1[`r',1] = r(mean)

sum `x' if all==1 & final_7yr==1
mat tab1[`r',2] = r(mean)

sum `x' if all==1 & final_7yr==0
mat tab1[`r',3] = r(mean) 

ttest `x' if all==1, by(final_7yr)
mat stars[`r',2] = (r(p)<.01) + (r(p)<.05)


local ++r
}


sum nflag if all==1
mat tab1[`r',1] = r(N)

sum nflag if all==1 & final_7yr==1
mat tab1[`r',2] = r(N)

sum nflag if all==1 & final_7yr==0
mat tab1[`r',3] = r(N)





mat rownames tab1 = `ivars' `medcost' N

frmttable using "E:\projects\burden_dementia\archive logs\Sample_comparison.doc", replace statmat(tab1) ///
varlabels title("Summary Statistics For R01 Sample (Deceased 2004-2015, Age 72+ at Death)") ctitles("", "", "Full Sample", "", "Excludes Decedents", " w/Imputated Core", "" \"Variables", "All","Dementia","No Dementia", "All","Dementia","No Dementia"  ) sdec(2) ///
vlines(01001001) annotate(stars) asymbol(*,**)note("All costs have been inflation adjusted to 2016 dollars. <0.05*, p<0.01**")


H="Comparison table 5 v 7 yrs"
clear all
capture log close

global datapath "E:\data\burden_dementia\int_data"
global final "E:\data\burden_dementia\final_data"
local logpath "E:\data\burden_dementia\logs"
global ooppath "E:\data\burden_dementia\oopdata"
global output "E:\projects\burden_dementia\archive logs"

cd `logpath'

use ${final}\R01_final.dta, clear

gsort id -nflag
by id: carryforward pdem, replace

keep if nflag==0 & ffs_60==1 & age_at_death>=70 & !missing(dem_cohort) & ///
index_year>=2005
replace ffs_84=0 if age_at_death<72 |ab_mos<84
label var generous "Resident of a generous state"

forvalues i=1/17 {
	local charls `charls' charls_`i'_0d_n12m
}
gen ind_hs_12m=hs_paid_by_mc_12m & !missing(hs_paid_by_mc_12m)
label var ind_hs_12m "Any hospice in last 12m, from claims"

keep if !missing(pdem)

gen n=1

*gen age_lt_72=age_at_death<72
gen hmo_lt_84=0
forvalues i=1/28 {
	replace hmo_lt_84=1 if inrange(hmo`i',1,3)
}

gen ab_lt_84=ab_mos<84

label var age_lt_72 "Age <72"
label var hmo_lt_84 "HMO Medicare"
label var ab_lt_84 "<84 months of AB coverage"


preserve
mat tab=J(5,2,.)
local r=2
sum n
local samplevars age_lt_72 hmo_lt_84 ab_lt_84

mat tab[1,2]=r(N)
foreach x of local samplevars {
	sum `x'
	mat tab[`r',1]=r(mean)*r(N)
	drop if `x'==1
	sum `x'
	mat tab[`r',2]=r(N)
	local r=`r'+1
}
sum ffs_84
mat tab[5,1]=(1-r(mean))*r(N)
mat tab[5,2]=r(N)

mat rownames tab=ffs_60 `samplevars' ffs_84
restore
frmttable using characteristics_comparison_5_7_yrs_ffs.rtf, statmat(tab) ///
title("Comparison of those w/ 60m FFS only and 84m FFS") ///
ctitles("" "N dropped" "N remaining") ///
annotate(stars) asymbol(*,**) varlabels sdec(0) replace
 

label var adl_severe_exit "Severe dependence for ADLs (Help in 4+)"
local cvars1 age_at_death
local cvars2 pdem
local cvars3 charls_index_wt_0d_n12m
local ivars1 age_lt_70 age_lt_72 
local ivars2 dem_cohort female_exit white black hisp_eth other ind_hs_12m nhres_exit married_exit ///
reschil_d_exit resspouse_exit livealone_exit adl_independent_exit ///
adl_severe_exit medicare_exit medicareb_exit medicaid_exit champus_exit ltc_ins_exit `charls'
local ivars3 generous
local catvars1
local catvars2 
local catvars3

local rn : word count `cvars1' `cvars2' `cvars3' `ivars1' `ivars2' `ivars3'

mat tab=J(`rn'+1,3,.)
mat stars=J(`rn'+1,3,0)

local r=1
local c=1



forvalues i=1/3 {
	foreach x of local cvars`i' {
		forvalues j=0/1 {
			sum `x' if ffs_84==`j'
			mat tab[`r',`c']=r(mean)
			if `j'==1 {
				ttest `x', by(ffs_84)
				mat tab[`r',`c'+1]=r(p)
				mat stars[`r',`c'+1]=(r(p)<.05)+(r(p)<.01)
}
			local c=`c'+1
}
		local c=1
		local r=`r'+1
}
	foreach x of local ivars`i' {
		forvalues j=0/1 {
			sum `x' if ffs_84==`j'
			mat tab[`r',`c']=r(mean)*100
			if `c'==2 {
				tab `x' ffs_84, chi2
				mat tab[`r',`c'+1]=r(p)
				mat stars[`r',`c'+1]=(r(p)<.05)+(r(p)<.01)
}
			local c=`c'+1
}
		local c=1
		local r=`r'+1
		
}	
}	
forvalues i=0/1 {
	sum n if ffs_84==`i'
	mat tab[`r',`i'+1]=r(N)
}

mat rownames tab=`cvars1' `ivars1' `cvars2'  `ivars2' `cvars3' `ivars3'  N

frmttable using characteristics_comparison_5_7_yrs_ffs.rtf, statmat(tab) ///
title("Comparison of those w/ 60m FFS only and 84m FFS") ///
ctitles("" "60-83m FFS" "84+m FFS" "P-value") ///
annotate(stars) asymbol(*,**) varlabels sdec(2) addtable


mat tab=J(`rn'+1,6,.)
mat stars=J(`rn'+1,6,0)

local r=1
local c=1


forvalues j=0/1 {
	preserve
	keep if ffs_84==`j'
	forvalues k=0/1 {
		forvalues i=1/3 {
			foreach x of local cvars`i' {
				sum `x' if dem_cohort==`k'
				mat tab[`r',`c']=r(mean)
					if `k'==1 {
					ttest `x', by(dem_cohort)
					mat tab[`r',`c'+1]=r(p)
					mat stars[`r',`c'+1]=(r(p)<.05)+(r(p)<.01)
}
				local r=`r'+1
}
			foreach x of local ivars`i' {
				sum `x' if dem_cohort==`k'
				mat tab[`r',`c']=r(mean)*100
				if `k'==1 {
					tab `x' dem_cohort, chi2
					mat tab[`r',`c'+1]=r(p)
					mat stars[`r',`c'+1]=(r(p)<.05)+(r(p)<.01)
}
				local r=`r'+1
	
}
}
		sum n if dem_cohort==`k'
		mat tab[`r',`c']=r(N)
		local r=1
		local c=`c'+1
}	
	local c=`c'+1
	restore
}


mat rownames tab=`cvars1' `ivars1' `cvars2'  `ivars2' `cvars3' `ivars3'  N

frmttable using characteristics_comparison_5_7_yrs_ffs.rtf, statmat(tab) ///
title("Comparison of those w/ 60m FFS only and 84m FFS") ///
ctitles("" "60-83m FFS" "" "" "84+m FFS" "" "" \"" "Non-dementia" "Dementia" "P-value" ///
"Non-dementia" "Dementia" "P-value") ///
annotate(stars) asymbol(*,**) varlabels sdec(2) addtable


H="********************************"


H="Sample derivation"
clear all
capture log close

local datapath "E:\data\burden_dementia\int_data"
local logpath "E:\data\burden_dementia\logs"
local ooppath "E:\data\burden_dementia\oopdata"

/****************** START WITH EXIT **********************/

use "E:\data\hrs_cleaned\exit_02_to_14_dt.dta", clear

foreach x of varlist * {

rename `x' `x'_exit
}

rename id_exit id

gen nflag = 0
cap drop _m
tempfile exit
gen year = exit_year_exit
save `exit' // all exit interviews 2002-14

/**************** MERGE TRACKER WITH DECEDENT DATASET ***********/

use "E:\data\hrs_cleaned\restr_tracker_v2014.dta", clear
drop id
gen id=hhid+pn
drop if id==""
keep id race hisp_eth birthmo birthday birthyr birth_date gender degree
tempfile track
save `track' // all restricted tracker

cd `datapath'

use decedent_dataset.dta if inrange(index_year,2006,2015), clear
cap drop year
cap drop _m
format %td index_date
merge m:1 id using "`track'"
keep if _m==3

replace birth_date=mdy(6,birthd,birthy) if missing(birth_date)
cap drop death_date
gen death_date = index_date
gen age_at_death=floor((death_date-birth_date)/365.25)

cap drop _m


/* Sample derivation Dataset 
tempfile sample
preserve
gen age_lt_70 = 0
replace age_lt_70 = 1 if age_at_death<70
label var age_lt_70 "Age at death <70"
save `sample'
restore 
*/

levelsof id if age_at_death<72, local(agedrop)

drop if age_at_death<70 /////////////// drop people <70 at death (800)

merge 1:1 id using "`exit'"

/* Sample derivation
preserve
gen no_exit = 1 if _m==1
keep if no_exit
keep id no_exit
tempfile noexit
save `noexit'

use "`sample'", clear
merge 1:1 id using "`noexit'", keepus(no_exit)
label var no_exit "No exit ivw 2002-2014"
cap drop _m
save `sample', replace
restore
************ */
levelsof id if _m==1, local(exitdrop) 
keep if _m==3 /////////// drop people with no exit (387)

cap drop _m

tempfile r01
save `r01'

keep id index_date index_year
tempfile id 
save `id' //decedents with exit 

/*************** MERGE WITH CORE INTERVIEW **************/

use "E:\data\hrs_cleaned\core_00_to_14.dta", clear

merge m:1 id using "`id'", keepus(index_date index_year)
levelsof id if _m==2, local(nocoredrop)
keep if _m==3 ///////////// 25 people no core interviews ever

cap drop _m

gsort id -core_year

by id: gen obs=_n

keep if obs<=4

gen ivw_date = c_ivw_date

by id: gen next_ivw_date = ivw_date[_n+1] // date prev ivw chronologically

by id: gen next_ivw_year = core_year[_n+1]

gen earliest = 0
replace earliest = 1 if next_ivw_year==.
label var earliest "flag for earliest observable core"


keep if obs<=4 // keep last 3 hrs interviews


by id: gen diff = core_year - core_year[_n-1] // -4 or higher denotes a gap year

bysort id: egen gap = min(diff)

replace gap = abs(gap) // max number of years between consecutive core
label var gap "max # of yrs between consecutive core ivw"
tab gap
preserve
keep if gap>4
keep id
duplicates drop 
levelsof id, local(misscore)
tempfile droplist
save `droplist' ///////// people with more than 4 year gap between cores

restore

drop obs gap diff
gen year = core_year

cap drop _m

/* merge with dementia dataset */

merge 1:1 id core_year using "E:\data\hrs_public_2014\dementia\pdem_withvarnames_00_14", keepus(pdem)
drop if _m==2

gen dementia = 0
replace dementia = 1 if pdem>=.5 & pdem!=.
cap drop _m


tempfile core
save `core'

use "`r01'", clear
append using "`core'"

merge m:1 id using "`droplist'" //dropping people with >4 years between core

codebook id if _m==3
drop if _m==3
cap drop _m

codebook id

gsort id -year

by id: gen obs=_n

foreach x of local nocoredrop {

drop if obs==1 & id=="`x'" // dropping exit ivw for people with no core ever (2000-12)

}

gen nflag_ivw = obs - 1
label var nflag_ivw "Interview type, 0 = exit, 1 = N1, etc."

gen dem_cohort = 0

levelsof id if dementia==1 & nflag_ivw==1, local(demlist)

foreach x of local demlist {

replace dem_cohort = 1 if id=="`x'"

}




gen core_5yr = index_year - core_year if obs==2 
preserve 

keep if core_5yr>4 & obs==2
keep id
levelsof id, local(core4yr) 
tempfile core_2_far 
save `core_2_far' /////////////// no core ivw within 4yrs of death

restore

merge m:1 id using "`core_2_far'"
codebook id if _m==3
drop if _m==3 // dropping ppl with no core_ivw within 4 yrs
cap drop _m

gsort id -year


by id: gen diff = year - year[_n-1] // -4 or higher denotes a gap year

/*
gen ivw_date = c_ivw_date
replace ivw_date = e_ivw_date_exit if nflag_ivw==0

 by id: gen next_ivw_date = ivw_date[_n+1] */

gen ex2far = 0
replace ex2far = 1 if diff<-4 & obs==2

gen divide = 1
replace divide = 2 if diff<=-4  & ex2far==0

expand 2 if diff<=-4, gen(imputed) 

replace year = year + 2 if imputed==1 // imputed core interview

levelsof id if imputed==1, local(impu)

cap drop nflag

gsort id -year
by id: gen nflag = _n
replace nflag = nflag - 1

drop if nflag>4

cd "E:\data\burden_dementia\int_data"
save R01_int_2015.dta, replace

use R01_int_2015.dta, clear

keep if nflag_ivw==0
keep id index_date index_year exit_year_exit year
tempfile index
save `index'

/*
drop nflag obs

gsort id -year
by id: gen nflag==_n-1
*/

/**************** GET OOP DATA ********************/

local ooppath "E:\data\burden_dementia\oopdata"

use `ooppath'\oopme_final_2016.dta, clear
rename *, l
gen id=hhid+pn

merge m:1 id using "`index'", keepus(index_year index_date)
keep if _m==3 // only keep oop data for people in cohort

tab year if total_oop==.
drop if total_oop==.
preserve
*keep if iwtype==0 // keep non-imputed non-exit ivw
tempfile oop_mer
save `oop_mer' // original dataset, not imputed
restore 


gsort id -year

by id: gen obs=_n

keep if obs<=4

by id: gen diff = year - year[_n-1] // -4 or higher denotes a gap year


replace diff = -4 if diff<=-4 & obs==2 // recoding people with >4 gap between exit and N1 to be 4yrs


/*
bysort id: egen gap = min(diff)
keep if gap==-4 /* only keep people without consecutive missing interviews */
*/


expand 2 if diff==-4, gen(ooptag) //created imputed interview

replace year = year + 2 if ooptag==1

gsort id -year

cap drop obs
by id: gen obs=_n

by id: gen total_imp_a = total_oop[_n+1] if ooptag==1
by id: gen total_imp_b = (total_oop[_n+1] + total_oop[_n-1])/2 if ooptag==1

label var ooptag "imputed oop"

keep if ooptag==1

tempfile imputed
save `imputed'


use "`oop_mer'", clear

append using "`imputed'"
cap drop _m 
preserve
drop if iwtype==1

tempfile oop
save `oop'
restore 

keep if iwtype==1

gen nflag = 0

foreach x of varlist total* {

rename `x' `x'_exit
}
rename year exit_year_exit

tempfile oop_exit
save `oop_exit'

use R01_int_2015.dta, clear
cap drop _m
merge 1:1 id year using "`oop'", keepus(total* ooptag)
*merge 1:1 id year using "`oop'", keepus(total* ooptag)
drop if _m==2
cap drop _m

merge 1:1 id nflag using "`oop_exit'", keepus(total* ooptag)

drop if _m==2
cap drop _m

save R01_int_2015.dta, replace

/*
use R01_int_2015.dta, clear

keep if nflag_ivw==0
keep id index_date index_year exit_year_exit year
tempfile index
save `index'
*/


/************ Get Helper data ***********/

use id year ivw_type *_k *_s *_i *_u using "E:\data\hrs_cleaned\helper_hours_2014.dta", clear
*rename year core_year
//cap number of hours at 720 (24 hrs for 30 days) for spouses and other informal
gen hlphrs_nk=hlphrs_u-hlphrs_k

foreach x in s u k nk {
replace hlphrs_`x'=720 if hlphrs_`x'>720
replace hlphrs_`x' = 0 if hlphrs_`x'==.
}
replace hlphrs_i=hlphrs_s+hlphrs_u

merge m:1 id using "`index'", keepus(index_year index_date)
keep if _m==3 // only keep helper data for people in cohort
drop _m

tempfile hlp_mer

save `hlp_mer'

merge 1:1 id year using "`index'", keepus(id exit_year_exit year)

gen inx = ivw_type-1
replace inx = 1 if _m==2
foreach x in i s u k {
replace hlphrs_`x' = 0 if _m==2
}


gsort id -year

by id: gen obs=_n

tab inx if obs==2

by id: gen diff = year - year[_n-1] // -4 or higher denotes a gap year

replace diff = -4 if diff<=-4 & obs==2 // replacing obs where gap between exit and N1 was >4yrs, since we already kept people who had core in last years of life

expand 2 if diff==-4, gen(hlptag)



replace year = year + 2 if hlptag==1

replace hlptag=1 if _m==2

cap drop obs

gsort id -year

by id: gen obs=_n

foreach x in i s u k nk {
by id: gen hlphrs_`x'_a = hlphrs_i[_n+1] if hlptag==1
by id: gen hlphrs_`x'_b = (hlphrs_i[_n+1] + hlphrs_i[_n-1])/2 if hlptag==1
}

label var hlptag "imputed hlp hrs"

gen hlp_exit = 1 if hlptag==1 & _m==2
label var hlp_exit "hlp exit imputed"
replace hlptag = 0 if _m==2
preserve
keep if hlptag==1 

tempfile hlp
save `hlp'


use "`hlp_mer'", clear

append using "`hlp'"
cap drop _m

drop if inx==1


tempfile help
save `help'
restore 

keep if inx==1

gen nflag = 0

foreach x of varlist hlphrs_* {

rename `x' `x'_exit
}

tempfile hlp_exit 
save `hlp_exit'


use R01_int_2015.dta, clear
cap drop _m
merge 1:1 id year using "`help'", keepus(hlphrs_* hlptag hlp_exit)
*merge 1:1 id year using "`help'", keepus(hlphrs_* hlptag)
drop if _m==2

cap drop _m

merge 1:1 id nflag using "`hlp_exit'", keepus(hlphrs_* hlptag hlp_exit) update

drop if _m==2
cap drop _m

foreach x of varlist hlphrs_* {

replace `x' = 0 if (hlptag==1 & imputed==0)
replace `x' = 0 if `x'==.
}

gen year_n0 = year
replace year_n0 = index_year if nflag==0
gen year_n1 = year_n0 - 1
label var year_n1 "calendar year prior to ivw date"
gen year_n2 = year_n0 - 2
label var year_n2 "calendar year 2 yrs prior to ivw date"


save R01_int_2015.dta, replace


use R01_int_2015.dta, clear
keep id

duplicates drop id, force
tempfile id
save `id'

/************** Get State information *************/

use "E:\data\hrs_cleaned\restr_tracker_v2014.dta", clear
drop id
gen id=hhid+pn

merge 1:1 id using "`id'"
keep if _m==3

keep hhid pn stateusps* zipcode*

foreach x of varlist stateusps* {

replace `x' = "" if `x'=="ZZ"

}

gen stateusps97=""
gen stateusps99=""

forvalues i= 1(2)13{
gen stateusps`i'=""
gen zipcode`i' = ""
}

forvalues i=0(2)8{
rename stateusps0`i' stateusps`i'
rename zipcode0`i' zipcode`i'
}
reshape long stateusps zipcode, i(hhid pn) j(year)

forvalues i=0/99{
qui replace year=200`i' if year==`i' & year<=9
qui replace year=20`i' if year==`i' & inrange(year, 10,14)
qui replace year=19`i' if year==`i' & year>=90
}

gen id= hhid+pn
sort id year
drop if id==""
by id: carryforward stateusps, replace

gsort id -year
by id: carryforward stateusps, replace

/*
expand 2 if year==2012, gen(dupkey)

replace year = 2014 if dupkey==1


expand 2 if year==2014, gen(dup2)
replace year= 2013 if dup2==1
*/

tempfile state
save "`state'"

rename year year_n1
rename stateusps stateusps_n1
tempfile state_n1
save `state_n1'

rename year_n1 year_n2
rename stateusps_n1 stateusps_n2 
tempfile state_n2
save `state_n2'

use R01_int_2015.dta, clear
merge 1:1 id year using "`state'"
keep if _m==3
cap drop _m
merge m:1 id year_n1 using "`state_n1'"
keep if _m==3
cap drop _m
merge m:1 id year_n2 using "`state_n2'"
keep if _m==3
cap drop _m


save R01_int_2015.dta, replace

//merging with the Genworth/Metlife hourly home health aide cost. 
import excel "E:\data\burden_dementia\ref_data\Cost Care Survey (Genworth-Metlife)\HHA_hourly_genworth.xlsx", ///
sheet("Sheet1") firstrow clear

rename A year
rename B stateusps
rename HomeHealthAideServicesHourly state_hha
rename MedianHourlyRate hr_rate

drop if year==.
destring hr_rate, replace

expand 2 if year==1998, gen(duptag)

replace year = year - 1 if duptag==1
cap drop duptag

expand 2 if year==1997, gen(duptag)

replace year = year - 1 if duptag==1
drop duptag

rename year year_n0

tempfile rate
save "`rate'"

rename year_n0 year_n1
rename stateusps stateusps_n1
rename state_hha state_hha_n1
rename hr_rate hr_rate_n1

tempfile rate_n1
save "`rate_n1'"

rename year_n1 year_n2
rename stateusps_n1 stateusps_n2
rename state_hha_n1 state_hha_n2
rename hr_rate_n1 hr_rate_n2

tempfile rate_n2
save "`rate_n2'"

use R01_int_2015.dta, clear
cap drop _m
merge m:1 year_n0 stateusps using "`rate'"
keep if _m==3
cap drop _m
merge m:1 year_n1 stateusps_n1 using "`rate_n1'"
keep if _m==3
cap drop _m
merge m:1 year_n2 stateusps_n2 using "`rate_n2'"
keep if _m==3
cap drop _m

/**************** calculations *********************/

gen core_b4_death = 0
replace core_b4_death = 1 if nflag==1

gen n1_2_death = index_date - c_ivw_date if core_b4_death==1
replace n1_2_death = n1_2_death * 0.033
replace n1_2_death = ceil(n1_2_death)
replace n1_2_death = 24 if n1_2_death>=24 & n1_2_death!=.
replace n1_2_death = 1 if n1_2_death<=0


gen death_cat = .
replace death_cat = 1 if n1_2_death<12
replace death_cat = 2 if n1_2_death==12
replace death_cat = 3 if n1_2_death>12 & n1_2_death!=.

gsort id -core_b4_death

carryforward death_cat n1_2_death, replace

gen all = 1
bysort id: egen count = total(all)

codebook id if count==4
levelsof id if count==4 & death_cat==1, local(non4)

drop if count==4 & death_cat==1 /////////// dropping people with no N3 but death_cat ==1


cap drop ivw_time
gen ivw_time = ivw_date - next_ivw_date
*replace ivw_time = index_date - ivw_date if ex2far==1

replace ivw_time = ivw_time * 0.03
gen imp = core_year-next_ivw_year
replace ivw_time = 48 if imp>=6 & imp!=. // recode people with exit >2yrs from death  to cap it at 48m
replace ivw_time = 24 if earliest==1
replace imp = 1 if imp>=4 & imp!=.

replace ivw_time = ivw_time/2 if imp==1
replace ivw_time = ceil(ivw_time)

tab ivw_time
label var ivw_time "interview weight" 

cap drop mar_n0 mar_n1 mar_n2
cap drop mar

gen mar_n0 = . //months at risk
gen mar_n1 = .
gen mar_n2 = .
gen mar_n3 = .

replace mar_n0 = index_month if nflag==0
*replace mar_n0 = n1_2_death if n1_2_death<12 & nflag==0
replace mar_n0 = n1_2_death if (n1_2_death-mar_n0 < 0) & nflag==0

replace mar_n1 = n1_2_death - mar_n0 if nflag==0
replace mar_n1 = 0 if mar_n1<0 & nflag==0
replace mar_n1 = 12 if (mar_n1>12 & mar_n1!=.) & nflag==0



replace mar_n2 = n1_2_death - mar_n0 -mar_n1 if nflag==0
replace mar_n2 = 0 if mar_n2<0
*replace mar_n2 = 12 if (mar_n2>12 & mar_n2!=.) & nflag==0

replace mar_n3 = n1_2_death - mar_n0 -mar_n1 -mar_n2 if nflag==0
replace mar_n3 = 0 if mar_n3<0


replace mar_n0 = c_ivw_month if nflag>0


replace mar_n1 = ivw_time - c_ivw_month if nflag>0
replace mar_n1 = 0 if mar_n1<0 & nflag>0
replace mar_n1 = 12 if (mar_n1>12 & mar_n1!=.) & nflag>0

replace mar_n2 = ivw_time - 12 - c_ivw_month if nflag>0
replace mar_n2 = 0 if mar_n2<0 & nflag>0
*replace mar_n2 = 12 if (mar_n2>12 & mar_n2!=.) & nflag>0

replace mar_n3 = ivw_time - 12 - c_ivw_month if nflag>0
replace mar_n3 = 0 if mar_n3<0 & nflag>0

gen mar = mar_n0+mar_n1+mar_n2+mar_n3
corr mar n1_2_death if nflag==0
corr mar ivw_time if nflag>0 // checks to see if months at risk (mar) = months between ivw

foreach x of varlist hlphrs_* {

replace `x' = (`x'*mar_n0*hr_rate) +  (`x'*mar_n1*hr_rate_n1) + (`x'*mar_n2*hr_rate_n2)

}


gen has_imputed = 0
foreach x of local impu {

replace has_imputed=1 if id=="`x'"

}


save R01_int_2015.dta, replace

/* Sample Derivation */

use decedent_dataset.dta if inrange(index_year,2006,2015), clear

gen age_lt_70 = 0
label var age_lt_70 "Dropped because age at death <72"
foreach x of local agedrop {

replace age_lt_70 = 1 if id=="`x'"

}

gen exdrop = 0
label var exdrop "Dropped because no Exit Ivw 2002-2014"
foreach x of local exitdrop {
replace exdrop = 1 if id=="`x'"
}

gen nocore = 0
label var nocore "Dropped because no Core Ivw 2000-2012"
foreach x of local nocoredrop {

replace nocore = 1 if id=="`x'"
}

gen misscore = 0
label var misscore "Dropped because missing consecutive cores"
foreach x of local misscore {

replace misscore = 1 if id=="`x'"
}

gen core4yr = 0
label var core4yr "Dropped because no Core within last 4 years of life"
foreach x of local core4yr {
replace core4yr = 1 if id=="`x'"
}

gen impu = 0
label var impu "Had a core imputed"
foreach x of local impu {
replace impu = 1 if id=="`x'"
}

gen non4 = 0
label var non4 "Dropped because Died <12m after N1 and missing N4"
foreach x of local non4 {

replace non4 = 1 if id=="`x'"

}

local deri age_lt_70 exdrop nocore misscore core4yr non4 

gen final = 1
label var final "Final Sample Size, includes decedents w/imputed core"

foreach x of local deri {

replace final = 0 if `x'==1

}

gen final_noimp = 0
replace final_noimp = 1 if final==1 & impu==0
label var final_noimp "Final Sample Size, excludes decedents with imputed core"

gen all = 1
label var all "All HRS respondents Deceased 2006-2015"

local full all age_lt_70 exdrop nocore misscore core4yr non4 final final_noimp

local rd: word count `full'

mat tab1 = J(`rd',1,.)

local r = 1

foreach x of local full {

sum `x'
mat tab1[`r',1] = r(sum)
local ++r
}

mat rownames tab1 = `full'


frmttable using "E:\projects\burden_dementia\archive logs\Sample_Derivation_7yrs.doc", replace statmat(tab1) ///
varlabels title("Sample Derivation for R01 (Deceased 2006-2015, Age 72+)") ctitles("Reason for Exclusion" "N" ) sdec(0) ///
annotate(stars) asymbol(*,**)note("Death Date was determined by NDI, Medicare MBSF or HRS Exit in that order. //If NDI death date was after HRS Exit Interview and respondent had no subsequent data, then HRS death date was used.")




H="Dataset and table 1"

/********* Constructing Final Dataset *********/

use "E:\data\burden_dementia\int_data\R01_int_2015.dta", clear

*gen n_nk=n_u-n_k


forvalues j = 1/3 {

	preserve

	if `j'==1 local y "0"
	if `j'==2 local y "a"
	if `j'==3 local y "b"

	drop if has_imputed==1 & `j'==1 // 


	// replace total_oop_exit = total_imp_a_exit if `j'==2 no imputed exits
	replace total_oop = total_imp_a if `j'==2 & imputed==1
		foreach x in i s u k nk {
		replace hlphrs_`x'_exit = hlphrs_`x'_a_exit if `j'==2 & hlp_exit==1
		replace hlphrs_`x' = hlphrs_`x'_a if `j'==2 & imputed==1
}

	// replace total_oop_exit = total_imp_b_exit if `j'==3
	replace total_oop = total_imp_b if `j'==3 & imputed==1

	foreach x in i s u k nk {
		replace hlphrs_`x'_exit = hlphrs_`x'_b_exit if `j'==3 & hlp_exit==1
		replace hlphrs_`x' = hlphrs_`x'_b if `j'==3 & imputed==1
}


	keep id death_cat nflag total_* hlphrs_* n1_2_death year ivw_time
	 
	reshape wide total_* hlphrs_* year ivw_time, i(id) j(nflag)

	forvalues i = 1/7 {

		gen oop_n`i' = .
		gen informal_n`i' = .
		gen informal_i_n`i' = .
		gen informal_s_n`i' = .
		gen informal_u_n`i' = .
		gen informal_k_n`i' = .
		gen informal_nk_n`i'= .

}


	/* OOP */
	replace oop_n1 = total_oop_exit0 + ((12 - n1_2_death)*(total_oop1/ivw_time1)) if death_cat==1
	replace oop_n1 = total_oop_exit0 if death_cat==2
	replace oop_n1 = total_oop_exit0*(12/n1_2_death) if death_cat==3

	replace oop_n2 = ((12)*(total_oop1/ivw_time1)) if death_cat==1
	replace oop_n2 = ((12)*(total_oop1/ivw_time1)) if death_cat==2
	replace oop_n2 = ((n1_2_death-12)/n1_2_death)*total_oop_exit0 + (24-n1_2_death)*(total_oop1/ivw_time1) if death_cat==3

	replace oop_n3 = ((n1_2_death)*(total_oop1/ivw_time1)) + ((12-n1_2_death)*(total_oop2/ivw_time2)) if death_cat==1
	replace oop_n3 = ((12)*(total_oop1/ivw_time1)) if death_cat==2
	replace oop_n3 = ((12)*(total_oop1/ivw_time1)) if death_cat==3

	replace oop_n4 = ((12)*(total_oop2/ivw_time2)) if death_cat==1
	replace oop_n4 = ((12)*(total_oop2/ivw_time2)) if death_cat==2
	replace oop_n4 = (((n1_2_death-12)/ivw_time1))*(total_oop1) + ((24-n1_2_death)*(total_oop2/ivw_time2)) if death_cat==3

	replace oop_n5 = ((12)*(total_oop3/ivw_time3)) if death_cat==1
	replace oop_n5 = ((12)*(total_oop3/ivw_time3)) if death_cat==2
	replace oop_n5 = (((n1_2_death-12)/ivw_time2))*(total_oop2) + ((24-n1_2_death)*(total_oop3/ivw_time3)) if death_cat==3

	replace oop_n6 = ((12)*(total_oop3/ivw_time3)) if death_cat==1
	replace oop_n6 = ((12)*(total_oop3/ivw_time3)) if death_cat==2
	replace oop_n6 = (((n1_2_death-12)/ivw_time2))*(total_oop1) + ((24-n1_2_death)*(total_oop2/ivw_time2)) if death_cat==3

	replace oop_n7 = ((n1_2_death)*(total_oop3/ivw_time3)) + ((12-n1_2_death)*(total_oop4/ivw_time4)) if death_cat==1
	replace oop_n7 = ((12)*(total_oop4/ivw_time3)) if death_cat==2
	replace oop_n7 = ((12)*(total_oop4/ivw_time3)) if death_cat==3

	forvalues i=1/7 {

		sum oop_n`i'

}

/* Informal */

	foreach x in _i _s _u _k _nk {

		replace informal`x'_n1 = hlphrs`x'_exit0 + ((12 - n1_2_death)*(hlphrs`x'1/ivw_time1)) if death_cat==1
		replace informal`x'_n1 = hlphrs`x'_exit0 if death_cat==2
		replace informal`x'_n1 = hlphrs`x'_exit0*(12/n1_2_death) if death_cat==3

		replace informal`x'_n2 = ((12)*(hlphrs`x'1/ivw_time1)) if death_cat==1
		replace informal`x'_n2 = ((12)*(hlphrs`x'1/ivw_time1)) if death_cat==2
		replace informal`x'_n2 = ((n1_2_death-12)/n1_2_death)*hlphrs`x'_exit0 + (24-n1_2_death)*(hlphrs`x'1/ivw_time1) if death_cat==3

		replace informal`x'_n3 = ((n1_2_death)*(hlphrs`x'1/ivw_time1)) + ((12-n1_2_death)*(hlphrs`x'2/ivw_time2)) if death_cat==1
		replace informal`x'_n3 = ((12)*(hlphrs`x'1/ivw_time1)) if death_cat==2
		replace informal`x'_n3 = ((12)*(hlphrs`x'1/ivw_time1)) if death_cat==3

		replace informal`x'_n4 = ((12)*(hlphrs`x'2/ivw_time2)) if death_cat==1
		replace informal`x'_n4 = ((12)*(hlphrs`x'2/ivw_time2)) if death_cat==2
		replace informal`x'_n4 = (((n1_2_death-12)/ivw_time2))*(hlphrs`x'1) + ((24-n1_2_death)*(hlphrs`x'2/ivw_time2)) if death_cat==3

		replace informal`x'_n5 = ((12)*(hlphrs`x'2/ivw_time2)) if death_cat==1
		replace informal`x'_n5 = ((12)*(hlphrs`x'2/ivw_time2)) if death_cat==2
		replace informal`x'_n5 = (((n1_2_death-12)/ivw_time2))*(hlphrs`x'1) + ((24-n1_2_death)*(hlphrs`x'2/ivw_time2)) if death_cat==3

		replace informal`x'_n6 = ((12)*(hlphrs`x'3/ivw_time3)) if death_cat==1
		replace informal`x'_n6 = ((12)*(hlphrs`x'3/ivw_time3)) if death_cat==2
		replace informal`x'_n6 = (((n1_2_death-12)/ivw_time2))*(hlphrs`x'1) + ///
		((24-n1_2_death)*(hlphrs`x'3/ivw_time3)) if death_cat==3

		replace informal`x'_n7 = ((n1_2_death)*(hlphrs`x'4/ivw_time4)) + ((12-n1_2_death)*(hlphrs`x'3/ivw_time3)) if death_cat==1
		replace informal`x'_n7 = ((12)*(hlphrs`x'4/ivw_time4)) if death_cat==2
		replace informal`x'_n7 = ((12)*(hlphrs`x'4/ivw_time4)) if death_cat==3


		forvalues i=1/7 {

			replace informal`x'_n`i'= (informal`x'_n`i')*(20/19)
			sum informal`x'_n`i'

}
}
	forvalues i=1/7 {
		di `i'
		replace informal_n`i'=informal_i_n`i'
		drop informal_i_n`i'
}

	gen impute = `j'
	save "E:\data\burden_dementia\int_data\oop_impute_`y'.dta", replace
	restore

}






keep if nflag==0
expand 3

bysort id: gen impute = _n
cap drop _m
merge 1:1 id impute using "E:\data\burden_dementia\int_data\oop_impute_0.dta", keepus(oop_n* informal_*n*)
replace impute = . if impute==1 & _m==1
cap drop _m
merge 1:1 id impute using "E:\data\burden_dementia\int_data\oop_impute_a.dta", keepus(oop_n* informal_*n*) update
cap drop _m
merge 1:1 id impute using "E:\data\burden_dementia\int_data\oop_impute_b.dta", keepus(oop_n* informal_*n*) update
cap drop _m


merge m:1 id using "E:\data\burden_dementia\int_data\tot_paid_maid.dta", keepus(tot_paid_maid_*)
drop if _m==2

cd "E:\data\burden_dementia\final_data\"


forvalues i=1/7 {
	gen ffs_`i'yr=cont_ffs_n_mos>=`i'*12 & cont_ffs_n_mos!=.
}





gen white = 0
replace white = 1 if race==1 & hisp_eth==0

gen black = 0
replace black = 1 if race==2 & hisp_eth==0

gen other = 0 
replace other = 1 if white==0 & black==0 & hisp_eth==0

label var white "Non-Hispanic White"
label var black "Non-Hispanic Black"
label var other "Non-Hispanic Other"

label var tot_paid_maid_n1 "Total Medicaid Spending N1"
label var tot_paid_maid_n2 "Total Medicaid Spending N2"
label var tot_paid_maid_n3 "Total Medicaid Spending N3"
label var tot_paid_maid_n4 "Total Medicaid Spending N4"
label var tot_paid_maid_n5 "Total Medicaid Spending N5"

gen tot_paid_maid_7yr = tot_paid_maid_n1 + tot_paid_maid_n2 + tot_paid_maid_n3 + tot_paid_maid_n4 + tot_paid_maid_n5 ///
+ tot_paid_maid_n6 + tot_paid_maid_n7
gen tot_paid_mc_7yr = tot_paid_by_mc_12m + tot_paid_by_mc_24m + tot_paid_by_mc_36m + ///
tot_paid_by_mc_48m + tot_paid_by_mc_60m + tot_paid_by_mc_72m + tot_paid_by_mc_84m
gen oop_7yr = oop_n1 + oop_n2 + oop_n3 + oop_n4 + oop_n5 + oop_n6 + oop_n7
gen informal_7yr = informal_n1 + informal_n2 + informal_n3 + informal_n4 + informal_n5 ///
+ informal_n6 + informal_n7

gen tot_paid_maid_6yr = tot_paid_maid_n1 + tot_paid_maid_n2 + tot_paid_maid_n3 + tot_paid_maid_n4 + tot_paid_maid_n5 ///
+ tot_paid_maid_n6  
gen tot_paid_mc_6yr = tot_paid_by_mc_12m + tot_paid_by_mc_24m + tot_paid_by_mc_36m + ///
tot_paid_by_mc_48m + tot_paid_by_mc_60m + tot_paid_by_mc_72m  
gen oop_6yr = oop_n1 + oop_n2 + oop_n3 + oop_n4 + oop_n5 + oop_n6 
gen informal_6yr = informal_n1 + informal_n2 + informal_n3 + informal_n4 + informal_n5 ///
+ informal_n6 

gen tot_paid_maid_5yr = tot_paid_maid_n1 + tot_paid_maid_n2 + tot_paid_maid_n3 + tot_paid_maid_n4 + tot_paid_maid_n5
gen tot_paid_mc_5yr = tot_paid_by_mc_12m + tot_paid_by_mc_24m + tot_paid_by_mc_36m + tot_paid_by_mc_48m + tot_paid_by_mc_60m
gen oop_5yr = oop_n1 + oop_n2 + oop_n3 + oop_n4 + oop_n5
gen informal_5yr = informal_n1 + informal_n2 + informal_n3 + informal_n4 + informal_n5

gen tot_paid_maid_4yr = tot_paid_maid_n1 + tot_paid_maid_n2 + tot_paid_maid_n3 + tot_paid_maid_n4
gen tot_paid_mc_4yr = tot_paid_by_mc_12m + tot_paid_by_mc_24m + tot_paid_by_mc_36m + tot_paid_by_mc_48m
gen oop_4yr = oop_n1 + oop_n2 + oop_n3 + oop_n4
gen informal_4yr = informal_n1 + informal_n2 + informal_n3 + informal_n4

gen tot_paid_maid_3yr = tot_paid_maid_n1 + tot_paid_maid_n2 + tot_paid_maid_n3
gen tot_paid_mc_3yr = tot_paid_by_mc_12m + tot_paid_by_mc_24m + tot_paid_by_mc_36m
gen oop_3yr = oop_n1 + oop_n2 + oop_n3
gen informal_3yr = informal_n1 + informal_n2 + informal_n3

gen tot_paid_maid_2yr = tot_paid_maid_n1 + tot_paid_maid_n2
gen tot_paid_mc_2yr = tot_paid_by_mc_12m + tot_paid_by_mc_24m
gen oop_2yr = oop_n1 + oop_n2 
gen informal_2yr = informal_n1 + informal_n2




label var tot_paid_maid_5yr "Total 5yr Medicaid Spending"
label var tot_paid_mc_5yr "Total 5yr Medicare Spending"
label var oop_5yr "Total 5yr OOP Spending"
label var informal_5yr "Total 5yr Informal Cost"

label var tot_paid_maid_4yr "Aggregate 4yr Medicaid Spending"
label var tot_paid_mc_4yr "Aggregate 4yr Medicare Spending"
label var oop_4yr "Aggregate 4yr OOP Spending"
label var informal_4yr "Aggregate 4yr Informal Cost"

label var tot_paid_maid_3yr "Aggregate 3yr Medicaid Spending"
label var tot_paid_mc_3yr "Aggregate 3yr Medicare Spending"
label var oop_3yr "Aggregate 3yr OOP Spending"
label var informal_3yr "Aggregate 3yr Informal Cost"

forvalues i=2/7 {

	label var tot_paid_maid_`i'yr "Aggregate `i'yr Medicaid Spending"
	label var tot_paid_mc_`i'yr "Aggregate `i'yr Medicare Spending"
	label var oop_`i'yr "Aggregate `i'yr OOP Spending"
	label var informal_`i'yr "Aggregate `i'yr Informal Cost"
}

save R01_final_2015.dta, replace

local ivars female white black other hospice_exit nhres_exit married_exit reschil_d_exit resspouse_exit livealone_exit adl_independent_exit adl_severe_exit medicare_exit medicareb_exit medicaid_exit champus_exit ffs_5yr ffs_4yr ffs_3yr ffs_2yr ffs_1yr


local medcost age_at_death tot_paid_maid_n1 tot_paid_maid_n2 tot_paid_maid_n3 ///
tot_paid_maid_n4 tot_paid_maid_n5 tot_paid_maid_n6 tot_paid_maid_n7  ///
tot_paid_by_mc_12m tot_paid_by_mc_24m tot_paid_by_mc_36m tot_paid_by_mc_48m ///
tot_paid_by_mc_60m tot_paid_by_mc_72m tot_paid_by_mc_84m oop_n1 oop_n2 oop_n3 ///
oop_n4 oop_n5 oop_n6 oop_n7 ///
informal_n1 informal_n2 informal_n3 informal_n4 informal_n5 informal_n6 informal_n7 ///
tot_paid_maid_7yr tot_paid_mc_7yr oop_7yr informal_7yr ///
tot_paid_maid_6yr tot_paid_mc_6yr oop_6yr informal_6yr ///
tot_paid_maid_5yr tot_paid_mc_5yr oop_5yr informal_5yr ///
tot_paid_maid_4yr tot_paid_mc_4yr ///
oop_4yr informal_4yr tot_paid_maid_3yr tot_paid_mc_3yr oop_3yr informal_3yr tot_paid_maid_2yr ///
tot_paid_mc_2yr oop_2yr informal_2yr


local rd: word count `ivars' `medcost' 1

mat tab1=J(`rd', 9,.)
mat stars=J(`rd',9,0)
local r = 1

foreach x of local ivars {

sum `x' if impute==1

mat tab1[`r',1] = r(mean)*100

sum `x' if impute==1 & dem_cohort==1
mat tab1[`r',2] = r(mean)*100

sum `x' if impute==1 & dem_cohort==0
mat tab1[`r',3] = r(mean)*100

tab `x' dem_cohort if impute==1, chi2
mat stars[`r',2] = (r(p)<.01) + (r(p)<0.05)


sum `x' if impute==2

mat tab1[`r',4] = r(mean)*100

sum `x' if impute==2 & dem_cohort==1
mat tab1[`r',5] = r(mean)*100

sum `x' if impute==2 & dem_cohort==0
mat tab1[`r',6] = r(mean)*100

tab `x' dem_cohort if impute==2, chi2
mat stars[`r',5] = (r(p)<.01) + (r(p)<0.05)


sum `x' if impute==3

mat tab1[`r',7] = r(mean)*100

sum `x' if impute==3 & dem_cohort==1
mat tab1[`r',8] = r(mean)*100

sum `x' if impute==3 & dem_cohort==0
mat tab1[`r',9] = r(mean)*100

tab `x' dem_cohort if impute==3, chi2
mat stars[`r',8] = (r(p)<.01) + (r(p)<0.05)


local ++r
}

foreach x of local medcost {

sum `x' if impute==1 

mat tab1[`r',1] = r(mean)

sum `x' if impute==1 & dem_cohort==1
mat tab1[`r',2] = r(mean)

sum `x' if impute==1 & dem_cohort==0
mat tab1[`r',3] = r(mean) 

ttest `x' if impute==1, by(dem_cohort)
mat stars[`r',2] = (r(p)<.01) + (r(p)<.05)


sum `x' if impute==2

mat tab1[`r',4] = r(mean)

sum `x' if impute==2 & dem_cohort==1
mat tab1[`r',5] = r(mean)

sum `x' if impute==2 & dem_cohort==0
mat tab1[`r',6] = r(mean) 

ttest `x' if impute==2, by(dem_cohort)
mat stars[`r',5] = (r(p)<.01) + (r(p)<.05)


sum `x' if impute==3

mat tab1[`r',7] = r(mean)

sum `x' if impute==3 & dem_cohort==1
mat tab1[`r',8] = r(mean)

sum `x' if impute==3 & dem_cohort==0
mat tab1[`r',9] = r(mean) 

ttest `x' if impute==3, by(dem_cohort)
mat stars[`r',8] = (r(p)<.01) + (r(p)<.05)


local ++r
}


sum nflag_ivw if impute==1
mat tab1[`r',1] = r(N)

sum nflag_ivw if impute==1 & dem_cohort==1
mat tab1[`r',2] = r(N)

sum nflag_ivw if impute==1 & dem_cohort==0
mat tab1[`r',3] = r(N)

sum nflag_ivw if impute==2
mat tab1[`r',4] = r(N)

sum nflag_ivw if impute==2 & dem_cohort==1
mat tab1[`r',5] = r(N)

sum nflag_ivw if impute==2 & dem_cohort==0
mat tab1[`r',6] = r(N)

sum nflag_ivw if impute==3
mat tab1[`r',7] = r(N)

sum nflag_ivw if impute==3 & dem_cohort==1
mat tab1[`r',8] = r(N)

sum nflag_ivw if impute==3 & dem_cohort==0
mat tab1[`r',9] = r(N)



mat rownames tab1 = `ivars' `medcost' N

frmttable using "E:\projects\burden_dementia\archive logs\R01_imputed.doc", replace statmat(tab1) ///
varlabels title("Summary Statistics For R01 Sample (Deceased 2004-2012, Age 70+)") ctitles("", "", "No Imputation", "", "", "Imputed - Method A", "", "", "Imputed - Method B", "" \"Variables", "All","Dementia","No Dementia", "All","Dementia","No Dementia", "All","Dementia","No Dementia"  ) sdec(2) ///
vlines(01001001001) annotate(stars) asymbol(*,**)note("All costs have been inflation adjusted to 2014 dollars. <0.05*, p<0.01**")

/* FFS Only */

preserve
keep if ffs_7yr==1


mat tab1=J(`rd', 9,.)
mat stars=J(`rd',9,0)
local r = 1

foreach x of local ivars {

sum `x' if impute==1

mat tab1[`r',1] = r(mean)*100

sum `x' if impute==1 & dem_cohort==1
mat tab1[`r',2] = r(mean)*100

sum `x' if impute==1 & dem_cohort==0
mat tab1[`r',3] = r(mean)*100

tab `x' dem_cohort if impute==1, chi2
mat stars[`r',2] = (r(p)<.01) + (r(p)<0.05)


sum `x' if impute==2

mat tab1[`r',4] = r(mean)*100

sum `x' if impute==2 & dem_cohort==1
mat tab1[`r',5] = r(mean)*100

sum `x' if impute==2 & dem_cohort==0
mat tab1[`r',6] = r(mean)*100

tab `x' dem_cohort if impute==2, chi2
mat stars[`r',5] = (r(p)<.01) + (r(p)<0.05)


sum `x' if impute==3

mat tab1[`r',7] = r(mean)*100

sum `x' if impute==3 & dem_cohort==1
mat tab1[`r',8] = r(mean)*100

sum `x' if impute==3 & dem_cohort==0
mat tab1[`r',9] = r(mean)*100

tab `x' dem_cohort if impute==3, chi2
mat stars[`r',8] = (r(p)<.01) + (r(p)<0.05)


local ++r
}

foreach x of local medcost {

sum `x' if impute==1 

mat tab1[`r',1] = r(mean)

sum `x' if impute==1 & dem_cohort==1
mat tab1[`r',2] = r(mean)

sum `x' if impute==1 & dem_cohort==0
mat tab1[`r',3] = r(mean) 

ttest `x' if impute==1, by(dem_cohort)
mat stars[`r',2] = (r(p)<.01) + (r(p)<.05)


sum `x' if impute==2

mat tab1[`r',4] = r(mean)

sum `x' if impute==2 & dem_cohort==1
mat tab1[`r',5] = r(mean)

sum `x' if impute==2 & dem_cohort==0
mat tab1[`r',6] = r(mean) 

ttest `x' if impute==2, by(dem_cohort)
mat stars[`r',5] = (r(p)<.01) + (r(p)<.05)


sum `x' if impute==3

mat tab1[`r',7] = r(mean)

sum `x' if impute==3 & dem_cohort==1
mat tab1[`r',8] = r(mean)

sum `x' if impute==3 & dem_cohort==0
mat tab1[`r',9] = r(mean) 

ttest `x' if impute==3, by(dem_cohort)
mat stars[`r',8] = (r(p)<.01) + (r(p)<.05)


local ++r
}


sum nflag_ivw if impute==1
mat tab1[`r',1] = r(N)

sum nflag_ivw if impute==1 & dem_cohort==1
mat tab1[`r',2] = r(N)

sum nflag_ivw if impute==1 & dem_cohort==0
mat tab1[`r',3] = r(N)

sum nflag_ivw if impute==2
mat tab1[`r',4] = r(N)

sum nflag_ivw if impute==2 & dem_cohort==1
mat tab1[`r',5] = r(N)

sum nflag_ivw if impute==2 & dem_cohort==0
mat tab1[`r',6] = r(N)

sum nflag_ivw if impute==3
mat tab1[`r',7] = r(N)

sum nflag_ivw if impute==3 & dem_cohort==1
mat tab1[`r',8] = r(N)

sum nflag_ivw if impute==3 & dem_cohort==0
mat tab1[`r',9] = r(N)



mat rownames tab1 = `ivars' `medcost' N

frmttable using "E:\projects\burden_dementia\archive logs\R01_imputed.doc", addtable statmat(tab1) ///
varlabels title("Summary Statistics For R01 Sample (Deceased 2004-2012, Age 72+, Continuous FFS 84 months prior)") ctitles("", "", "No Imputation", "", "", "Imputed - Method A", "", "", "Imputed - Method B", "" \"Variables", "All","Dementia","No Dementia", "All","Dementia","No Dementia", "All","Dementia","No Dementia" ) sdec(2) ///
vlines(01001001001) annotate(stars) asymbol(*,**)note("All costs have been inflation adjusted to 2014 dollars. p<0.05*, p<0.01** No imputation = anyone with gap ivw dropped. Method A = Carry forward prev ivw. Method B = Average prev and later ivw.")


H="Graphs"

use "E:\data\hrs_cleaned\core_00_to_14.dta", clear
sort id core_year
by id: keep if _n==_N
keep id reschil_d
rename reschil_d reschil_d_n1
tempfile core
save `core'

clear all
set more off
capture log close

cd "E:\data\burden_dementia\logs"
use "E:\data\burden_dementia\final_data\R01_final_2015.dta", clear
keep if ffs_7==1

	
keep if impute==2
drop tot_paid*p*
merge 1:1 id using `core', keep(match master) nogen

foreach x of varlist tot* oop* informal* {
	replace `x'=0 if missing(`x')
}


	forvalues i=12(12)60 {
		rename tot_paid_by_mc_`i'm tot_paid_by_mc`=`i'/12'
		rename tot_paid_maid_n`=`i'/12' tot_paid_by_mcaid`=`i'/12'
		rename oop_n`=`i'/12' tot_paid_oop`=`i'/12'
		foreach x in "" _s _u _k _nk {
			rename informal`x'_n`=`i'/12' tot_paid_informal`x'`=`i'/12'
}
}

foreach x in by_mc by_mcaid oop informal informal_s informal_u informal_k informal_nk {
	gen cum1_paid_`x'5=tot_paid_`x'5
	forvalues i=4(-1)1 {
		gen cum1_paid_`x'`i'=cum1_paid_`x'`=`i'+1'+tot_paid_`x'`i'
}
}

keep id tot_paid* cum1_* dem_cohort reschil_d_n1 married_or_part


reshape long tot_paid_by_mc tot_paid_by_mcaid tot_paid_oop cum1_paid_by_mc ///
cum1_paid_by_mcaid cum1_paid_oop tot_paid_informal cum1_paid_informal ///
tot_paid_informal_u cum1_paid_informal_u tot_paid_informal_s cum1_paid_informal_s ///
tot_paid_informal_k cum1_paid_informal_k tot_paid_informal_nk cum1_paid_informal_nk ///
, i(id) j(year_bef_death)
replace tot_paid_by_mcaid=0 if missing(tot_paid_by_mcaid)


*preserve
replace year=-year+6
label define year 1 "4-5" 2 "3-4" 3 "2-3" 4 "1-2" 5 "0-1"
foreach x of varlist tot* cum* {
	*replace `x'=`x'/1.03^(year_bef-1)
}
label values year year

foreach x in tot cum1 {
	egen `x'_paid_by_all=rowtotal(`x'_paid_by_mc `x'_paid_by_mcaid `x'_paid_oop ///
	`x'_paid_informal)
}

foreach x in by_mc by_mcaid oop informal informal_s informal_u informal_k informal_nk by_all {
	by dem_cohort year_bef_death, sort: egen annu_`x'=mean(tot_paid_`x')
	by dem_cohort year_bef_death, sort: egen cum_`x'=mean(cum1_paid_`x')
	by dem_cohort year_bef_death reschil_d_n1, sort: egen annu_resch_`x'=mean(tot_paid_`x')
	by dem_cohort year_bef_death married_or_part, sort: egen annu_married_`x'=mean(tot_paid_`x')
}


	
foreach x in by_mc by_mcaid oop informal informal_s informal_u informal_k informal_nk by_all {
	by dem_cohort year_bef_death, sort: egen annu_sd_`x'=sd(tot_paid_`x')
	by dem_cohort year_bef_death, sort: egen cum_sd_`x'=sd(cum1_paid_`x')
}


foreach x in s u k nk {
	foreach y in "" resch_ married_ {
		gen hlphrs_`y'`x'=((annu_`y'informal_`x'/20)/12)
}	
}

by dem_cohort year_bef_death: gen n=_N

rename *informal* *inf*
drop cum1*
*preserve
drop id tot*
duplicates drop
format cum* %16.0g

foreach x of varlist annu* cum* {
	replace `x'=`x'/1000
}

label var dem_c "Dementia" 
label var year_bef "Years before death"
label var annu_by_mc "Annual Medicarenditures"
label var cum_by_mc "Cumulative Medicare "
label var annu_by_mca "Annual Medicaid "
label var cum_by_mca "Cumulative Medicaid "
label var annu_oop "Annual OOP"
label var cum_oop "Cumulative OOP"
label var annu_inf "Annual imputed inf. caregiving"
label var cum_inf "Cumulative imputed inf. caregiving "

format annu* cum* %9.2fc

log using spending_tables.txt, text replace
foreach x in by_mc by_mcaid oop inf by_all {
	list year_bef_death dem_cohort annu_`x' cum_`x', abbreviate(16)
}
log close

foreach x in annu_ cum_ {
	gen hi_`x'all=`x'by_all+ invttail(n-1,0.025)*(`x'sd_by_all/sqrt(n))
	gen lo_`x'all=`x'by_all-invttail(n-1,0.025)*(`x'sd_by_all/sqrt(n))
}

/* error bars (can we do serrbar?)
twoway (rcap lo_annu hi_annu year if dem_cohort==0) (connected annu_by_all year if dem_cohort==0) (connected annu_by_all year if dem_cohort==1), ///
legend(label(1 "Non-dementia") label(2 "Probable dementia")) xlabel(1 "4-5" 2 "3-4" 3 "2-3" 4 "1-2" 5 "0-1") 



graph save annu_all_spending_over_time.gph, replace
graph export annu_all_spending_over_time.pdf, replace
*/






twoway (connected annu_by_mc year if dem_cohort==0) (connected annu_by_mc year if dem_cohort==1), ///
legend(label(1 "Non-dementia") label(2 "Probable dementia")) xlabel(1 "4-5" 2 "3-4" 3 "2-3" 4 "1-2" 5 "0-1")
graph save annu_mc_spending_over_time.gph, replace
graph export annu_mc_spending_over_time.pdf, replace
twoway (connected annu_by_mca year if dem_cohort==0) (connected annu_by_mca year if dem_cohort==1), ///
legend(label(1 "Non-dementia") label(2 "Probable dementia")) xlabel(1 "4-5" 2 "3-4" 3 "2-3" 4 "1-2" 5 "0-1")
graph save annu_mcaid_spending_over_time.gph, replace
graph export annu_mcaid_spending_over_time.pdf, replace
twoway (connected cum_by_mc year if dem_cohort==0) (connected cum_by_mc year if dem_cohort==1), ///
legend(label(1 "Non-dementia") label(2 "Probable dementia")) xlabel(1 "4-5" 2 "3-4" 3 "2-3" 4 "1-2" 5 "0-1")
graph save cum_mc_spending_over_time.gph, replace
graph export cum_mc_spending_over_time.pdf, replace
twoway (connected cum_by_mca year if dem_cohort==0) (connected cum_by_mca year if dem_cohort==1), ///
legend(label(1 "Non-dementia") label(2 "Probable dementia")) xlabel(1 "4-5" 2 "3-4" 3 "2-3" 4 "1-2" 5 "0-1")
graph save cum_mcaid_spending_over_time.gph, replace
graph export cum_mcaid_spending_over_time.pdf, replace

twoway (connected annu_oop year if dem_cohort==0) (connected annu_oop year if dem_cohort==1), ///
legend(label(1 "Non-dementia") label(2 "Probable dementia")) xlabel(1 "4-5" 2 "3-4" 3 "2-3" 4 "1-2" 5 "0-1")
graph save annu_oop_spending_over_time.gph, replace
graph export annu_oopid_spending_over_time.pdf, replace
twoway (connected cum_oop year if dem_cohort==0) (connected cum_oop year if dem_cohort==1), ///
legend(label(1 "Non-dementia") label(2 "Probable dementia")) xlabel(1 "4-5" 2 "3-4" 3 "2-3" 4 "1-2" 5 "0-1")
graph save cum_oop_spending_over_time.gph, replace
graph export cum_oop_spending_over_time.pdf, replace


twoway (connected annu_inf year if dem_cohort==0) (connected annu_inf year if dem_cohort==1), ///
legend(label(1 "Non-dementia") label(2 "Probable dementia")) xlabel(1 "4-5" 2 "3-4" 3 "2-3" 4 "1-2" 5 "0-1")
graph save annu_informal_spending_over_time.gph, replace
graph export annu_informal_spending_over_time.pdf, replace
twoway (connected cum_inf year if dem_cohort==0) (connected cum_inf year if dem_cohort==1), ///
legend(label(1 "Non-dementia") label(2 "Probable dementia")) xlabel(1 "4-5" 2 "3-4" 3 "2-3" 4 "1-2" 5 "0-1")
graph save cum_informal_spending_over_time.gph, replace
graph export cum_informal_spending_over_time.pdf, replace

twoway (connected annu_by_all year if dem_cohort==0) (connected annu_by_all year if dem_cohort==1), ///
legend(label(1 "Non-dementia") label(2 "Probable dementia")) xlabel(1 "4-5" 2 "3-4" 3 "2-3" 4 "1-2" 5 "0-1") 
graph save annu_all_spending_over_time.gph, replace
graph export annu_all_spending_over_time.pdf, replace
twoway (connected cum_by_all year if dem_cohort==0) (connected cum_by_all year if dem_cohort==1), ///
legend(label(1 "Non-dementia") label(2 "Probable dementia")) xlabel(1 "4-5" 2 "3-4" 3 "2-3" 4 "1-2" 5 "0-1")
graph save cum_all_spending_over_time.gph, replace
graph export cum_all_spending_over_time.pdf, replace


twoway (connected cum_by_mc year if dem_cohort==1) (connected cum_by_mca year if dem_cohort==1) ///
(connected cum_oop year if dem_cohort==1) ///
(connected cum_inf year if dem_cohort==1), title("Dementia") ///
legend(label(1 "Medicare") label(2 "Medicaid") label(3 "OOP") label(4 "Informal")) ///
saving(cum_spending_diff_dem, replace) xlabel(1 "4-5" 2 "3-4" 3 "2-3" 4 "1-2" 5 "0-1") 


twoway (connected cum_by_mc year if dem_cohort==0) (connected cum_by_mca year if dem_cohort==0) ///
(connected cum_oop year if dem_cohort==0) ///
(connected cum_inf year if dem_cohort==0), title("No Dementia") ///
legend(label(1 "Medicare") label(2 "Medicaid") label(3 "OOP") label(4 "Informal")) ///
saving(cum_spending_diff_no_dem, replace) xlabel(1 "4-5" 2 "3-4" 3 "2-3" 4 "1-2" 5 "0-1") 



graph bar annu_by_mca annu_by_mc annu_oop annu_inf, over(dem_cohort)  over(year) ///
 stack saving(annu_stack_1, replace)
graph export annu_stack_1.pdf, replace

graph bar annu_by_mca annu_by_mc annu_oop annu_inf,over(year)  over(dem_cohort)  ///
saving(annu_stack_2, replace) stack
graph export annu_stack_2.pdf, replace

preserve
tokenize inf oop by_mc by_mca 
forvalues i=2/4 {
	replace annu_``i''=annu_``=`i'-1''+annu_``i''
	replace cum_``i''=cum_``=`i'-1''+cum_``i''
}


foreach x in cum annu {
	twoway (area `x'_by_mca year if dem_cohort==1) (area `x'_by_mc year if dem_cohort==1) (area `x'_oop year if dem_cohort==1) ///
	(area `x'_inf year if dem_cohort==1), title("Dementia") ///
	legend(label(1 "Medicaid") label(2 "Medicare") label(3 "OOP") label(4 "Informal")) ///
	saving(`x'_spending_diff_dem_stacked, replace) xlabel(1 "4-5" 2 "3-4" 3 "2-3" 4 "1-2" 5 "0-1") 


	twoway (area `x'_by_mca year if dem_cohort==0) (area `x'_by_mc year if dem_cohort==0) ///
	(area `x'_oop year if dem_cohort==0) ///
	(area `x'_inf year if dem_cohort==0), title("No Dementia") ///
	legend(label(1 "Medicaid") label(2 "Medicare") label(3 "OOP") label(4 "Informal")) ///
	saving(`x'_spending_diff_no_dem_stacked, replace) xlabel(1 "4-5" 2 "3-4" 3 "2-3" 4 "1-2" 5 "0-1") 


	graph combine `x'_spending_diff_no_dem_stacked.gph `x'_spending_diff_dem_stacked.gph, ///
	ycommon saving(`x'_spending_stacked, replace)
	graph export `x'_spending_stacked.pdf, replace

	twoway (connected `x'_inf_s year if dem_cohort==0) (connected `x'_inf_u year if dem_cohort==0), ///
	legend(label(1 "Spouses") label(2 "Other informal helpers")) xlabel(1 "4-5" 2 "3-4" 3 "2-3" 4 "1-2" 5 "0-1") ///
	name(`x'_no_dem_basic, replace) title("No Dementia")

	twoway (connected `x'_inf_s year if dem_cohort==1) (connected `x'_inf_u year if dem_cohort==1), ///
	legend(label(1 "Spouses") label(2 "Other informal helpers")) xlabel(1 "4-5" 2 "3-4" 3 "2-3" 4 "1-2" 5 "0-1") ///
	name(`x'_dem_basic, replace) title("Dementia")

	graph combine `x'_no_dem_basic `x'_dem_basic, ycommon
	graph save `x'_informal_spending_by_type_basic.gph, replace
	graph export `x'_informal_spending_by_type_basic.pdf, replace



	twoway (connected `x'_inf_s year if dem_cohort==0) (connected `x'_inf_k year if dem_cohort==0) ///
	(connected `x'_inf_nk year if dem_cohort==0), ///
	legend(label(1 "Spouses") label(2 "Kids") label(3 "Other informal helpers")) ///
	xlabel(1 "4-5" 2 "3-4" 3 "2-3" 4 "1-2" 5 "0-1") ///
	name(`x'_no_dem_kids, replace) title("No Dementia")

	twoway (connected `x'_inf_s year if dem_cohort==1) (connected `x'_inf_k year if dem_cohort==1) ///
	(connected `x'_inf_nk year if dem_cohort==1), ///
	legend(label(1 "Spouses") label(2 "Kids") label(3 "Other informal helpers")) ///
	xlabel(1 "4-5" 2 "3-4" 3 "2-3" 4 "1-2" 5 "0-1") ///
	name(`x'_dem_kids, replace) title("Dementia")

	graph combine `x'_no_dem_kids `x'_dem_kids, ycommon
	graph save `x'_informal_spending_by_type_kids.gph, replace
	graph export `x'_informal_spending_by_type_kids.pdf, replace


/*
	twoway (connected `x'_inf_s year if dem_cohort==0 & reschil_d_n1==1) ///
	(connected `x'_inf_k year if dem_cohort==0 & reschil_d_n1==1) ///
	(connected `x'_inf_nk year if dem_cohort==0 & reschil_d_n1==1), ///
	legend(label(1 "Spouses") label(2 "Kids") label(3 "Other informal helpers")) xlabel(1 "4-5" 2 "3-4" 3 "2-3" 4 "1-2" 5 "0-1") ///
	name(`x'_no_dem_res_kids, replace) title("No Dementia")

	twoway (connected `x'_inf_s year if dem_cohort==1 & reschil_d_n1==1) ///
	(connected `x'_inf_k year if dem_cohort==1 & reschil_d_n1==1) ///
	(connected `x'_inf_nk year if dem_cohort==1 & reschil_d_n1==1), ///
	legend(label(1 "Spouses") label(2 "Kids") label(3 "Other informal helpers")) xlabel(1 "4-5" 2 "3-4" 3 "2-3" 4 "1-2" 5 "0-1") ///
	name(`x'_dem_res_kids, replace) title("Dementia")

	graph combine `x'_no_dem_res_kids `x'_dem_res_kids, ycommon
	graph save `x'_informal_spending_by_type_res_kids.gph, replace
	graph export `x'_informal_spending_by_type_res_kids.pdf, replace




	twoway (connected `x'_inf_s year if dem_cohort==0 & married_or==1) ///
	(connected `x'_inf_k year if dem_cohort==0 & married_or==1) ///
	(connected `x'_inf_nk year if dem_cohort==0 & married_or==1), ///
	legend(label(1 "Spouses") label(2 "Kids") label(3 "Other informal helpers")) xlabel(1 "4-5" 2 "3-4" 3 "2-3" 4 "1-2" 5 "0-1") ///
	name(`x'_no_dem_married, replace) title("No Dementia")

	twoway (connected `x'_inf_s year if dem_cohort==1 & married_or==1) ///
	(connected `x'_inf_k year if dem_cohort==1 & married_or==1) ///
	(connected `x'_inf_nk year if dem_cohort==1 & married_or==1), ///
	legend(label(1 "Spouses") label(2 "Kids") label(3 "Other informal helpers")) xlabel(1 "4-5" 2 "3-4" 3 "2-3" 4 "1-2" 5 "0-1") ///
	name(`x'_dem_married, replace) title("Dementia")

	graph combine `x'_no_dem_married `x'_dem_married, ycommon
	graph save `x'_informal_spending_by_type_married.gph, replace
	graph export `x'_informal_spending_by_type_married.pdf, replace	
*/

}

	twoway (connected hlphrs_s year if dem_cohort==0) (connected hlphrs_u year if dem_cohort==0), ///
	legend(label(1 "Spouses") label(2 "Other informal helpers")) xlabel(1 "4-5" 2 "3-4" 3 "2-3" 4 "1-2" 5 "0-1") ///
	name(`x'_no_dem, replace) title("No Dementia")

	twoway (connected hlphrs_s year if dem_cohort==1) (connected hlphrs_u year if dem_cohort==1), ///
	legend(label(1 "Spouses") label(2 "Other informal helpers")) xlabel(1 "4-5" 2 "3-4" 3 "2-3" 4 "1-2" 5 "0-1") ///
	name(`x'_dem, replace) title("Dementia")

	graph combine `x'_no_dem `x'_dem, ycommon
	graph save hlphrs_hrs_by_type_basic.gph, replace
	graph export hlphrs_hrs_by_type_basic.pdf, replace




	twoway (connected hlphrs_s year if dem_cohort==0) (connected hlphrs_k year if dem_cohort==0) ///
	(connected hlphrs_nk year if dem_cohort==0), ///
	legend(label(1 "Spouses") label(2 "Kids") label(3 "Other informal helpers")) ///
	xlabel(1 "4-5" 2 "3-4" 3 "2-3" 4 "1-2" 5 "0-1") ///
	name(`x'_no_dem, replace) title("No Dementia")

	twoway (connected hlphrs_s year if dem_cohort==1) (connected hlphrs_k year if dem_cohort==1) ///
	(connected hlphrs_nk year if dem_cohort==1), ///
	legend(label(1 "Spouses") label(2 "Kids") label(3 "Other informal helpers")) ///
	xlabel(1 "4-5" 2 "3-4" 3 "2-3" 4 "1-2" 5 "0-1") ///
	name(`x'_dem, replace) title("Dementia")

	graph combine `x'_no_dem `x'_dem, ycommon
	graph save hlphrs_hrs_by_type_kids.gph, replace
	graph export hlphrs_hrs_by_type_kids.pdf, replace




	twoway (connected hlphrs_resch_s year if dem_cohort==0 & reschil_d_n1==1) (connected hlphrs_resch_k year if dem_cohort==0 & reschil_d_n1==1) ///
	(connected hlphrs_resch_nk year if dem_cohort==0 & reschil_d_n1==1), ///
	legend(label(1 "Spouses") label(2 "Kids") label(3 "Other informal helpers")) xlabel(1 "4-5" 2 "3-4" 3 "2-3" 4 "1-2" 5 "0-1") ///
	name(`x'_no_dem, replace) title("No Dementia")

	twoway (connected hlphrs_resch_s year if dem_cohort==1 & reschil_d_n1==1) ///
	(connected hlphrs_resch_k year if dem_cohort==1 & reschil_d_n1==1) ///
	(connected hlphrs_resch_nk year if dem_cohort==1 & reschil_d_n1==1), ///
	legend(label(1 "Spouses") label(2 "Kids") label(3 "Other informal helpers")) xlabel(1 "4-5" 2 "3-4" 3 "2-3" 4 "1-2" 5 "0-1") ///
	name(`x'_dem, replace) title("Dementia")

	graph combine `x'_no_dem `x'_dem, ycommon
	graph save hlphrs_hrs_by_type_res_kids.gph, replace
	graph export hlphrs_hrs_by_type_res_kids.pdf, replace

	

	twoway (connected hlphrs_married_s year if dem_cohort==0 & married_or==1) (connected hlphrs_married_k year if dem_cohort==0 & married_or==1) ///
	(connected hlphrs_married_nk year if dem_cohort==0 & married_or==1), ///
	legend(label(1 "Spouses") label(2 "Kids") label(3 "Other informal helpers")) xlabel(1 "4-5" 2 "3-4" 3 "2-3" 4 "1-2" 5 "0-1") ///
	name(`x'_no_dem, replace) title("No Dementia")

	twoway (connected hlphrs_married_s year if dem_cohort==1 & married_or==1) ///
	(connected hlphrs_married_k year if dem_cohort==1 & married_or==1) ///
	(connected hlphrs_married_nk year if dem_cohort==1 & married_or==1), ///
	legend(label(1 "Spouses") label(2 "Kids") label(3 "Other informal helpers"))  xlabel(1 "4-5" 2 "3-4" 3 "2-3" 4 "1-2" 5 "0-1") ///
	name(`x'_dem, replace) title("Dementia")

	graph combine `x'_no_dem `x'_dem, ycommon
	graph save hlphrs_hrs_by_type_married.gph, replace
	graph export hlphrs_hrs_by_type_married.pdf, replace	




graph dir, m

graph combine annu_spending_diff_no_dem_stacked.gph annu_spending_diff_dem_stacked.gph ///
cum_spending_diff_no_dem_stacked.gph cum_spending_diff_dem_stacked.gph, ycommon ///
saving(spending_stacked, replace) rows(1) ysize(4) xsize(12)
graph export spending_stacked.pdf, replace

graph combine annu_mc_spending_over_time.gph cum_mc_spending_over_time.gph, ycommon
graph combine annu_mcaid_spending_over_time.gph cum_mcaid_spending_over_time.gph, ycommon
graph combine annu_oop_spending_over_time.gph cum_oop_spending_over_time.gph, ycommon
graph combine annu_informal_spending_over_time.gph cum_informal_spending_over_time.gph, ycommon
graph combine annu_all_spending_over_time.gph cum_all_spending_over_time.gph, ycommon






restore


H="Table 1"



use "E:\data\serious_ill\int_data\core_ids_1yr_criteria_5.dta", clear
sort id core_year
by id: keep if _n==_N
keep id wage*
duplicates drop
tempfile t1
save `t1'

use "E:\data\burden_dementia\final_data\R01_final.dta", clear
merge m:1 id using `t1', nogen keep(match master)
cd "E:\data\burden_dementia\logs"

/*for table 1

age, race, hs education, female, married, medicaid, dementia, ADL  dependence, 
SRH, smoke currently, 4+ health conditions
*/


keep if ffs_84==1
keep if final_7yr==1
*gen adl_dependent=!adl_independent_core
label var adl_dependent "ADL dependent"
label var age_at_death "Age at death"
label var prob_dem_baseline "% Probable dementia at baseline ivw"
replace prob_dem_y1=0 if !dem_cohort
gen n=1
drop race
gen race=1 if hisp_e==1
replace race=2 if black==1
replace race=3 if white==1
replace white=3 if missing(race)
label define race 1 "Hispanic" 2 "Non-Hispanic Black" 3 "Non-Hispanic White/Other"
label values race race

preserve

tokenize tot_paid_by_mc_y tot_paid_maid_y informal_y oop_y imputed_nh_costs_b_y

forvalues i=1/5 {
	di "``i''"
	egen cum`i'=rowtotal(``i''*)
	replace cum`i'=. if nflag!=0
}

egen cumall=rowtotal(cum1-cum5)
replace cumall=. if nflag!=0

label var cumall "Total Social Spending over 7 years pre-death"
label var cum1 "Medicare Expenditures"
label var cum2 "Medicaid Expenditures"
label var cum3 "Social Cost of Informal Care"
label var cum4 "OOP"
label var cum5 "Otherwise Unattributed NH Costs"
label var pdem_baseline "Mean probability of dementia at baseline"
gsort id nflag
carryforward age_at_death female married hseduc smoke_curr medicaid adl_dependent ///
srh_pf prob_dem_baseline pdem_baseline cum* race comorb*, replace

gsort id -nflag
carryforward age_at_death female married hseduc smoke_curr medicaid adl_dependent ///
srh_pf prob_dem_baseline pdem_baseline cum* race comorb*, replace





keep if nflag==1
local cvars1 age_at_death
local ivars1 female married married_baseline
local ivars2 hseduc smoke_curr smoke_curr_baseline medicaid medicaid_baseline ///
adl_dependent adl_dependent_baseline srh_pf srh_pf_baseline comorb_ge3_y1 ///
comorb_ge3_y7 prob_dem prob_dem_baseline 
local cvars3 pdem pdem_baseline cumall cum1 cum2 cum3 cum4 cum5
local catvars1 race
local catvars2 //comor_c_hrs

forvalues i=1/3 {
	foreach x of local catvars`i' {
		di "`x'"
		local `x'
		levelsof `x', local(levels)
		foreach l of local levels {
			gen `x'`l'=`x'==`l' if !missing(`x')
			local lab : label `x' `l'
			label var `x'`l' "`lab'"
			local `x' ``x'' `x'`l'
}
		di "``x''"
		local cativars`i' `cativars`i'' ``x''
}
}

di "`catvars1'"
di "`cativars1'"

local rn : word count `cvars1' `ivars1' `cativars1' `ivars2' `cativars2' `cvars3' 1
local r=1
local c=1

mat tab=J(`rn',4,.)
mat stars=J(`rn',4,0)

foreach y in "0,1" 0 1 {
	forvalues i=1/3 {
		foreach x of local cvars`i' {
			sum `x' if inlist(dem_cohort,`y')
			mat tab[`r',`c']=r(mean)
			if "`y'"=="1" {
				ttest `x', by(dem_cohort)
				mat tab[`r',`c'+1]=r(p)
				mat stars[`r',`c'+1]=(r(p)<.05)+(r(p)<.01)
}
			local r=`r'+1
}
		foreach x of local ivars`i' {
			sum `x' if inlist(dem_cohort,`y')
			mat tab[`r',`c']=r(mean)*100
			if "`y'"=="1" {
				tab `x' dem_cohort, chi2
				mat tab[`r',`c'+1]=r(p)
				mat stars[`r',`c'+1]=(r(p)<.05)+(r(p)<.01)
}
			local r=`r'+1
}
		foreach x of local catvars`i' {
			if "`y'"=="1" {
				tab `x' dem_cohort, chi2
				mat tab[`r',4]=r(p)
				mat stars[`r',4]=(r(p)<.05)+(r(p)<.01)
}
			foreach z of local `x' {
				sum `z' if inlist(dem_cohort,`y')
				mat tab[`r',`c']=r(mean)*100
				local r=`r'+1
}
}
}
	sum n if inlist(dem_cohort,`y')
	mat tab[`r',`c']=r(N)
	
	local r=1
	local c=`c'+1
}

mat rownames tab=`cvars1' `ivars1' `cativars1' `ivars2' `cativars2' `cvars3' N

frmttable using "E:\data\burden_dementia\logs\table_1_`c(current_date)'.rtf", ///
statmat(tab) title("Characteristics of Decedents, by Dementia Status") ///
ctitles("" "Full Sample" "No Dementia" "Dementia" "P-value") varlabels ///
sdec(2) note("Values except for age and baseline dementia taken from N1 interview" \ ///
"Baseline dementia status taken at interview closest  years prior to death, in that order") ///
annotate(stars) asymbol(*,**) replace


restore
preserve
keep if nflag==0

local tabvars comorb_ge3_y pdem_y prob_dem_y 
local titlecomorb_ge3_y "3+ Elixhauser Comorbidities by year before death"
local titlepdem_y "Mean Probability of dementia by year before death"
local titleprob_dem_y "Percent with probable dementia by year before death"
local note "Elixhauser comorbidities from claims"

foreach x of local tabvars {
	mat tab=J(7,4,.)
	mat stars=J(7,4,0)
	local r=1
	local c=1
	
	foreach y in "0,1" 0 1 {
		forvalues i=1/7 {
			sum `x'`i' if inlist(dem_cohort,`y')
			if "`x'"=="pdem_y" {
				mat tab[`r',`c']=r(mean)
				ttest `x'`i', by(dem_cohort)
}
			else {
				mat tab[`r',`c']=r(mean)*100
				tab `x'`i' dem_cohort, chi2
}
			mat tab[`r',`c'+1]=r(p)
			mat stars[`r',4]=(r(p)<.05)+(r(p)<.01)
			local r=`r'+1
}
		local r=1
		local c=`c'+1
}
frmttable using "E:\data\burden_dementia\logs\table_1_`c(current_date)'.rtf", statmat(tab) ///
	ctitles("Year before death" "Full Sample" "No Dementia" "Dementia" "P-value") ///
	rtitles("0-1"\"1-2"\"2-3"\"3-4"\"4-5"\"5-6"\"6-7") ///
	title(`title`x'') note(`note') sdec(2) annotate(stars) asymbol(*,**) addtable
	
	local note "Dementia probability from in-year interview or most recent interview if none in-year"
}

		
keep id tot_paid_by_mc_y* tot_paid_maid_y* oop_y* informal_y* dem_cohort ///
imputed_nh_costs_b_y*

rename tot_paid_by_mc_y* mc*
rename tot_paid_maid_y* mcaid*

foreach x of varlist mcaid* {
	replace `x'=0 if missing(`x')
}

rename (oop_y* informal_y* imputed_nh_costs_b_y*) (oop* informal* nh*)

foreach x in mc mcaid oop informal nh {
	forvalues i=1/7 {
		replace `x'`i'=`x'`i'/1000
}
	gen cum`x'7=`x'7
	forvalues i=6(-1)1 {
		gen cum`x'`i'=cum`x'`=`i'+1'+`x'`i'
}
}

keep id mc* mcaid* oop* informal* cum* dem_cohort nh*

forvalues i=1/7 {
	egen all`i'=rowtotal(mc`i' mcaid`i' oop`i' informal`i' nh`i')
	egen cumall`i'=rowtotal(cum*`i')
	foreach x in mc mcaid oop informal nh all {
		gen pct`x'`i'=100*`x'`i'/all`i'
		gen pctcum`x'`i'=100*cum`x'`i'/cumall`i'
		replace pctcum`x'`i'=100 if cumall`i'==0
}
}

foreach y in "" cum pct pctcum {
	local tablevars`y'
	foreach x in all oop informal mc mcaid nh {
		forvalues i=1/7 {
			local tablevars`y' `tablevars'`y' `y'`x'`i'
}
}
}		

local rn : word count `tablevars' 1



local title "Annual Expenditures"
local replace replace

foreach y in "" cum /*pct pctcum*/ {
	mat tab=J(`rn',5,.)
	mat stars=J(`rn',5,0)
	local r=1
	local c=1	
	if "`y'"=="cum" local title "Cumulative Expenditures"
	if "`y'"=="pct" local title "Percent of Total Annual Expenditures" 
	if "`y'"=="pctcum" local title "Percent of Total Cumulative Expenditures"
	
	foreach z in "0,1" 0 1 {
		foreach x in all oop informal mc mcaid nh {	
			forvalues i=1/7 {
				sum `y'`x'`i' if inlist(dem_cohort,`z')
				mat tab[`r',`c']=r(mean)
				if "`z'"=="1" {
					ttest `y'`x'`i', by(dem_cohort)
					mat tab[`r',`c'+1]=r(p)
					mat tab[`r',`c'+2]=r(p)/*/(`rn'-1)*/
					mat stars[`r',`c'+1]=(r(p)<.05)+(r(p)<.01)
					mat stars[`r',`c'+2]=(r(p)<(.05/(`rn'-1)))+(r(p)<(.01/(`rn'-1)))
}
				local r=`r'+1
}
}			
		sum dem_cohort if inlist(dem_cohort,`z')
		mat tab[`r',`c']=r(N)
		local c=`c'+1
		local r=1

}

	mat rownames tab=`tablevars' N

	frmttable using "E:\data\burden_dementia\logs\exp_with_p_value.rtf", statmat(tab) ///
	title("Total Spending Last 7 Years of Life by Dementia Status:" \"`title'") ///
	ctitles("" "Full Sample" "Non-dementia" "Dementia" "P-value" "Bonferonni") ///
	sdec(2,2,2,3) annotate(stars) asymbol(*,**) `replace'
	local replace addtable varlabels ///
	note("*,** = P significant at <.05,<.01 without the Bonferonni correction and <`=0.05/(`rn'-1)', <`=0.01/(`rn'-1)' with")
	
}


H="7 year graphs"
/*note--it takes forever to run through the whole thing, but if you don't need
everything done it's possible to run chunks by selecting imp, commenting out 
graphs you don't need, and/or dropping anything not needed from the varlist
*/

/*loop through each type of NH night imputation*/

set trace off

foreach imp in a b c d {
use "E:\data\serious_ill\int_data\core_ids_1yr_criteria_5.dta", clear
sort id core_year
by id: keep if _n==_N
keep id wage*
duplicates drop
tempfile t1
save `t1'

use "E:\data\burden_dementia\final_data\R01_final.dta", clear
merge m:1 id using `t1', nogen keep(match master)
cd "E:\data\burden_dementia\logs\graphs"

keep if nflag==0
keep if ffs_84==1
keep if final_7yr==1

forvalues i=1/7 {
	gen wi_mc`i'=tot_paid_by_mc_y`i'/wage_index_2012
}

keep id tot_paid_by_mc_y* tot_paid_maid_y* oop_y* informal_y* dem_cohort wi_* ///
imputed_nh_costs_`imp'_y*

rename tot_paid_by_mc_y* mc*
rename tot_paid_maid_y* mcaid*

foreach x of varlist mcaid* {
	replace `x'=0 if missing(`x')
}

rename (oop_y* informal_y* imputed_nh_costs_`imp'_y*) (oop* informal* nh*)

foreach x in mc mcaid oop informal nh wi_mc {
	forvalues i=1/7 {
		replace `x'`i'=`x'`i'/1000
}
	gen cum`x'7=`x'7
	forvalues i=6(-1)1 {
		gen cum`x'`i'=cum`x'`=`i'+1'+`x'`i'
}
}

keep id mc* mcaid* oop* informal* cum* dem_cohort wi* nh*


reshape long mc mcaid oop informal cummc cummcaid cumoop cuminformal nh cumnh wi_mc, ///
i(id) j(year_before_death)

replace year=-year+8

label define year 1 "6-7" 2 "5-6" 3 "4-5" 4 "3-4" 5 "2-3" 6 "1-2" 7 "0-1"
label values year year

foreach x in "" cum {
	egen `x'all=rowtotal(`x'mc `x'mcaid `x'oop `x'informal `x'nh)
}

local se
foreach x in mc mcaid oop informal all cummc cummcaid cumoop cuminformal cumall ///
nh cumnh wi_mc {
	local se `se' se_`x'=`x'
}

collapse (mean) mc mcaid oop informal all cummc cummcaid cumoop cuminformal cumall ///
nh cumnh wi_mc (semean) `se', by(dem_cohort year_before_death)

foreach x in mc mcaid oop informal all cummc cummcaid cumoop cuminformal cumall ///
nh cumnh wi_mc {
		gen `x'_ul=`x'+1.96*se_`x'
		gen `x'_ll=`x'-1.96*se_`x'
}
/*
foreach x in mc mcaid oop informal nh all {
	twoway (rarea `x'_ul `x'_ll year if dem_cohort==0, astyle(ci)) ///
	(rarea `x'_ul `x'_ll year if dem_cohort==1, astyle(ci)) ///
	(line `x' year if dem_cohort==0) (line `x' year if dem_cohort==1), ///
	legend(order(3 4) label(1 "") label(2 "") label(3 "Non-dementia") label(4 "Probable dementia")) ///
	xlabel(1 "6-7" 2 "5-6" 3 "4-5" 4 "3-4" 5 "2-3" 6 "1-2" 7 "0-1") ytitle("")
	graph save annu_`x'_spending_over_time.gph, replace
	graph export annu_`x'_spending_over_time_nh`imp'.pdf, replace
	
	twoway (rarea cum`x'_ul cum`x'_ll year if dem_cohort==0, astyle(ci)) ///
	(rarea cum`x'_ul cum`x'_ll year if dem_cohort==1, astyle(ci)) ///
	(line cum`x' year if dem_cohort==0) (line cum`x' year if dem_cohort==1), ///
	legend(order(3 4) label(1 "") label(2 "") label(3 "Non-dementia") label(4 "Probable dementia")) ///
	xlabel(1 "6-7" 2 "5-6" 3 "4-5" 4 "3-4" 5 "2-3" 6 "1-2" 7 "0-1") ytitle("")
	graph save cum_`x'_spending_over_time.gph, replace
	graph export cum_`x'_spending_over_time_nh`imp'.pdf, replace
	
	graph combine annu_`x'_spending_over_time.gph cum_`x'_spending_over_time.gph, ycommon
	graph save `x'_spending_7yrs.gph, replace
	graph export `x'_spending_7yrs_nh`imp'.pdf, replace
}

twoway (line mc year if dem_cohort==0) (line mc year if dem_cohort==1) ///
(line wi_mc year if dem_cohort==0) (line wi_mc year if dem_cohort==1), ///
legend(label(1 "MC, No-D") label(2 "MC-D") label(3 "WIMC, No-D") label(4 "WIMC-D")) ///
xlabel(1 "6-7" 2 "5-6" 3 "4-5" 4 "3-4" 5 "2-3" 6 "1-2" 7 "0-1") ytitle("")
graph save annu_`x'_spending_over_time_wi.gph, replace
graph export annu_`x'_spending_over_time_wi_nh`imp'.pdf, replace
*/

foreach x in mc mcaid oop informal all nh {
	rename `x' annu`x'
}

preserve




graph bar annumcaid annunh annumc annuoop annuinf, over(dem_cohort)  over(year) ///
stack saving(annu_stack_1, replace) percent 
graph export annu_stack_1_nh`imp'.pdf, replace

graph bar  annunh annumcaid annumc annuoop annuinformal if dem_cohort==0, over(year) stack percent ///
saving(annu_stack_no_dem, replace)  title("No dementia" "Annual") ///
legend(label(2 "Medicaid") label(3 "Medicare") label(4 "OOP") label(5 "Informal") ///
	label(1 "Imputed NH Cost")) //legend(row(1))
graph bar annunh annumcaid annumc annuoop annuinformal if dem_cohort==1,over(year)  ///
saving(annu_stack_dem, replace) stack percent title("Dementia" "Annual") ///
legend(label(2 "Medicaid") label(3 "Medicare") label(4 "OOP") label(5 "Informal") ///
	label(1 "Imputed NH Cost")) 

graph bar cumnh cummcaid  cummc cumoop cuminformal if dem_cohort==0,over(year)  ///
saving(cum_stack_no_dem, replace) stack percent  title("No dementia" "Cumulative") ///
legend(label(2 "Medicaid") label(3 "Medicare") label(4 "OOP") label(5 "Informal") ///
	label(1 "Imputed NH Cost")) 
graph bar cumnh  cummcaid cummc cumoop cuminformal if dem_cohort==1,over(year)  ///
saving(cum_stack_dem, replace) stack percent  title("Dementia" "Cumulative") ///
legend(label(2 "Medicaid") label(3 "Medicare") label(4 "OOP") label(5 "Informal") ///
	label(1 "Imputed NH Cost")) 

graph combine annu_stack_no_dem.gph annu_stack_dem.gph cum_stack_no_dem.gph cum_stack_dem.gph, ///
rows(1) xsize(12) ysize(4)  ycommon 
graph save stacked_percentage_bars_7yrs.gph, replace
graph export stacked_percentage_bars_7yrs_nh`imp'.pdf, replace


tokenize informal oop mc mcaid  nh
forvalues i=2/5 {
	replace annu``i''=annu``=`i'-1''+annu``i''
	replace cum``i''=cum``=`i'-1''+cum``i''
}

foreach x in annu cum {
	twoway (area `x'nh year if dem_cohort==0)  (area `x'mcaid year if dem_cohort==0) ///
	(area `x'mc year if dem_cohort==0) ///
	(area `x'oop year if dem_cohort==0) (area `x'informal year if dem_cohort==0), ///
	title("No Dementia") legend(label(1 "Imputed NH Cost") label(2 "Medicaid") ///
	label(3 "Medicare") label(4 "OOP") label(5 "Informal")) ///
	saving(`x'_spending_diff_no_dem_stacked, replace) ///
	xlabel(1 "6-7" 2 "5-6" 3 "4-5" 4 "3-4" 5 "2-3" 6 "1-2" 7 "0-1") ytitle("")

	twoway (area `x'nh year if dem_cohort==1)  (area `x'mcaid year if dem_cohort==1) ///
	(area `x'mc year if dem_cohort==1) ///
	(area `x'oop year if dem_cohort==1) (area `x'informal year if dem_cohort==1), ///
	title("Dementia") legend(label(1 "Imputed NH Cost")label(2 "Medicaid") ///
	label(3 "Medicare") label(4 "OOP") label(5 "Informal")) ///
	saving(`x'_spending_diff_dem_stacked, replace) ///
	xlabel(1 "6-7" 2 "5-6" 3 "4-5" 4 "3-4" 5 "2-3" 6 "1-2" 7 "0-1") ytitle("")

	graph combine `x'_spending_diff_no_dem_stacked.gph `x'_spending_diff_dem_stacked.gph, ///
	ycommon saving(`x'_spending_stacked_7yrs, replace)
	graph export `x'_spending_stacked_7yrs_nh`imp'.pdf, replace	
}


graph combine cum_spending_diff_no_dem_stacked.gph cum_spending_diff_dem_stacked.gph, ///
ycommon saving(cum_spending_stacked_7yrs, replace) rows(1)
graph export cum_spending_stacked_7yrs_nh`imp'.pdf, replace


graph combine cum_spending_diff_no_dem_stacked.gph cum_spending_diff_dem_stacked.gph, ///
ycommon saving(cum_spending_stacked_7yrs, replace) rows(1)
graph export cum_spending_stacked_7yrs_nh`imp'.pdf, replace

graph combine annu_spending_diff_no_dem_stacked.gph annu_spending_diff_dem_stacked.gph ///
cum_spending_diff_no_dem_stacked.gph cum_spending_diff_dem_stacked.gph, ycommon ///
saving(spending_stacked_7yrs, replace) rows(1) ysize(4) xsize(12)
graph export spending_stacked_7yrs_nh`imp'.pdf, replace

drop *se_* *ul *ll
export excel using "E:\data\burden_dementia\logs\graphs\graphs_data.xls", ///
firstrow(variables) sheet(`imp', replace) 
restore
}


H="7 year table with p-values"
/*note--it takes forever to run through the whole thing, but if you don't need
everything done it's possible to run chunks by selecting imp, commenting out 
graphs you don't need, and/or dropping anything not needed from the varlist
*/

/*loop through each type of NH night imputation*/

set trace off

*foreach imp in a b c d {
use "E:\data\serious_ill\int_data\core_ids_1yr_criteria_5.dta", clear
sort id core_year
by id: keep if _n==_N
keep id wage*
duplicates drop
tempfile t1
save `t1'

use "E:\data\burden_dementia\final_data\R01_final.dta", clear
merge m:1 id using `t1', nogen keep(match master)
cd "E:\data\burden_dementia\logs\graphs"

keep if nflag==0
keep if ffs_84==1
keep if final_7yr==1

forvalues i=1/7 {
	gen wi_mc`i'=tot_paid_by_mc_y`i'/wage_index_2012
}

keep id tot_paid_by_mc_y* tot_paid_maid_y* oop_y* informal_y* dem_cohort wi_* ///
imputed_nh_costs_b_y*

rename tot_paid_by_mc_y* mc*
rename tot_paid_maid_y* mcaid*

foreach x of varlist mcaid* {
	replace `x'=0 if missing(`x')
}

rename (oop_y* informal_y* imputed_nh_costs_b_y*) (oop* informal* nh*)

foreach x in mc mcaid oop informal nh wi_mc {
	forvalues i=1/7 {
		replace `x'`i'=`x'`i'/1000
}
	gen cum`x'7=`x'7
	forvalues i=6(-1)1 {
		gen cum`x'`i'=cum`x'`=`i'+1'+`x'`i'
}
}

keep id mc* mcaid* oop* informal* cum* dem_cohort nh*

forvalues i=1/7 {
	egen all`i'=rowtotal(mc`i' mcaid`i' oop`i' informal`i' nh`i')
	egen cumall`i'=rowtotal(cum*`i')
	foreach x in mc mcaid oop informal nh all {
		gen pct`x'`i'=100*`x'`i'/all`i'
		gen pctcum`x'`i'=100*cum`x'`i'/cumall`i'
		replace pctcum`x'`i'=100 if cumall`i'==0
}
}

foreach y in "" cum pct pctcum {
	local tablevars`y'
	foreach x in all oop informal mc mcaid nh {
		forvalues i=1/7 {
			local tablevars`y' `tablevars'`y' `y'`x'`i'
}
}
}		

local rn : word count `tablevars' 1



local title "Annual Expenditures"
local replace replace

foreach y in "" cum /*pct pctcum*/ {
	mat tab=J(`rn',5,.)
	mat stars=J(`rn',5,0)
	local r=1
	local c=1	
	if "`y'"=="cum" local title "Cumulative Expenditures"
	if "`y'"=="pct" local title "Percent of Total Annual Expenditures" 
	if "`y'"=="pctcum" local title "Percent of Total Cumulative Expenditures"
	
	foreach z in "0,1" 0 1 {
		foreach x in all oop informal mc mcaid nh {	
			forvalues i=1/7 {
				sum `y'`x'`i' if inlist(dem_cohort,`z')
				mat tab[`r',`c']=r(mean)
				if "`z'"=="1" {
					ttest `y'`x'`i', by(dem_cohort)
					mat tab[`r',`c'+1]=r(p)
					mat tab[`r',`c'+2]=r(p)/*/(`rn'-1)*/
					mat stars[`r',`c'+1]=(r(p)<.05)+(r(p)<.01)
					mat stars[`r',`c'+2]=(r(p)<(.05/(`rn'-1)))+(r(p)<(.01/(`rn'-1)))
}
				local r=`r'+1
}
}			
		sum dem_cohort if inlist(dem_cohort,`z')
		mat tab[`r',`c']=r(N)
		local c=`c'+1
		local r=1

}

	mat rownames tab=`tablevars' N

	frmttable using "E:\data\burden_dementia\logs\exp_with_p_value.rtf", statmat(tab) ///
	title("Total Spending Last 7 Years of Life by Dementia Status:" \"`title'") ///
	ctitles("" "Full Sample" "Non-dementia" "Dementia" "P-value" "Bonferonni") ///
	sdec(2,2,2,3) annotate(stars) asymbol(*,**) `replace'
	local replace addtable varlabels ///
	note("*,** = P significant at <.05,<.01 without the Bonferonni correction and <`=0.05/(`rn'-1)', <`=0.01/(`rn'-1)' with")
	
}
			
/*
reshape long mc mcaid oop informal nh cummc cummcaid cumoop cuminformal cumnh wi_mc, ///
i(id) j(year_before_death)

replace year=-year+8

label define year 1 "6-7" 2 "5-6" 3 "4-5" 4 "3-4" 5 "2-3" 6 "1-2" 7 "0-1"
label values year year
*/


H="Graphs split by NH status"
/*note--it takes forever to run through the whole thing, but if you don't need
everything done it's possible to run chunks by selecting imp, commenting out 
graphs you don't need, and/or dropping anything not needed from the varlist
*/

/*loop through each type of NH night imputation*/

set trace off

foreach imp in b {
foreach nh in 0 1 {
use "E:\data\serious_ill\int_data\core_ids_1yr_criteria_5.dta", clear
sort id core_year
by id: keep if _n==_N
keep id wage*
duplicates drop
tempfile t1
save `t1'

use "E:\data\burden_dementia\final_data\R01_final.dta", clear
merge m:1 id using `t1', nogen keep(match master)
cd "E:\data\burden_dementia\logs\graphs"

by id, sort: egen nh_n1=max(cond(nflag==1,nhres,.))
by id: egen nh_any=max(nhres)
replace nh_any=1 if nhres_exit==1
egen nh_hundo=rowtotal(nh_nights_y*)
replace nh_hundo=nh_hundo>=100 & !missing(nh_hundo)

keep if nflag==0
keep if ffs_84==1
keep if final_7yr==1

preserve
keep if nh_n1==`nh'
forvalues i=1/7 {
	gen wi_mc`i'=tot_paid_by_mc_y`i'/wage_index_2012
}

keep id tot_paid_by_mc_y* tot_paid_maid_y* oop_y* informal_y* dem_cohort wi_* ///
imputed_nh_costs_`imp'_y*

rename tot_paid_by_mc_y* mc*
rename tot_paid_maid_y* mcaid*

foreach x of varlist mcaid* {
	replace `x'=0 if missing(`x')
}

rename (oop_y* informal_y* imputed_nh_costs_`imp'_y*) (oop* informal* nh*)

foreach x in mc mcaid oop informal nh wi_mc {
	forvalues i=1/7 {
		replace `x'`i'=`x'`i'/1000
}
	gen cum`x'7=`x'7
	forvalues i=6(-1)1 {
		gen cum`x'`i'=cum`x'`=`i'+1'+`x'`i'
}
}

keep id mc* mcaid* oop* informal* cum* dem_cohort wi* nh*


reshape long mc mcaid oop informal cummc cummcaid cumoop cuminformal nh cumnh wi_mc, ///
i(id) j(year_before_death)

replace year=-year+8

label define year 1 "6-7" 2 "5-6" 3 "4-5" 4 "3-4" 5 "2-3" 6 "1-2" 7 "0-1"
label values year year

foreach x in "" cum {
	egen `x'all=rowtotal(`x'mc `x'mcaid `x'oop `x'informal `x'nh)
}

local se
foreach x in mc mcaid oop informal all cummc cummcaid cumoop cuminformal cumall ///
nh cumnh wi_mc {
	local se `se' se_`x'=`x'
}

collapse (mean) mc mcaid oop informal all cummc cummcaid cumoop cuminformal cumall ///
nh cumnh wi_mc (semean) `se', by(dem_cohort year_before_death)

foreach x in mc mcaid oop informal all cummc cummcaid cumoop cuminformal cumall ///
nh cumnh wi_mc {
		gen `x'_ul=`x'+1.96*se_`x'
		gen `x'_ll=`x'-1.96*se_`x'
}

foreach x in mc mcaid oop informal all nh {
	rename `x' annu`x'
}






graph bar annumcaid annunh annumc annuoop annuinf, over(dem_cohort)  over(year) ///
stack saving(annu_stack_1_nh`imp'_`nh', replace) percent 
graph export annu_stack_1_nh`imp'_`nh'.pdf, replace

graph bar  annunh annumcaid annumc annuoop annuinformal if dem_cohort==0, over(year) stack percent ///
saving(annu_stack_no_dem_`nh', replace)  title("No dementia" "Annual") ///
legend(label(2 "Medicaid") label(3 "Medicare") label(4 "OOP") label(5 "Informal") ///
	label(1 "Imputed NH Cost")) //legend(row(1))
graph bar annunh annumcaid annumc annuoop annuinformal if dem_cohort==1,over(year)  ///
saving(annu_stack_dem_`nh', replace) stack percent title("Dementia" "Annual") ///
legend(label(2 "Medicaid") label(3 "Medicare") label(4 "OOP") label(5 "Informal") ///
	label(1 "Imputed NH Cost")) 

graph bar cumnh cummcaid  cummc cumoop cuminformal if dem_cohort==0,over(year)  ///
saving(cum_stack_no_dem_`nh', replace) stack percent  title("No dementia" "Cumulative") ///
legend(label(2 "Medicaid") label(3 "Medicare") label(4 "OOP") label(5 "Informal") ///
	label(1 "Imputed NH Cost")) 
graph bar cumnh  cummcaid cummc cumoop cuminformal if dem_cohort==1,over(year)  ///
saving(cum_stack_dem_`nh', replace) stack percent  title("Dementia" "Cumulative") ///
legend(label(2 "Medicaid") label(3 "Medicare") label(4 "OOP") label(5 "Informal") ///
	label(1 "Imputed NH Cost")) 

graph combine annu_stack_no_dem_`nh'.gph annu_stack_dem_`nh'.gph cum_stack_no_dem_`nh'.gph cum_stack_dem_`nh'.gph, ///
rows(1) xsize(12) ysize(4)  ycommon 
graph save stacked_percentage_bars_7yrs_`nh'.gph, replace
graph export stacked_percentage_bars_7yrs_nh`imp'_`nh'.pdf, replace

drop *se_* *ul *ll
export excel using "E:\data\burden_dementia\logs\graphs\graphs_data_nh.xls", ///
firstrow(variables) sheet(`imp'_`nh', replace) 
restore
}
}



H="Medicaid graphs"


cd "E:\data\burden_dementia\logs\graphs"

use bid_hrs_22 ffs_84 using "E:\data\burden_dementia\final_data\R01_final.dta", clear
keep if ffs_84==1
drop if missing(bid)
duplicates drop
merge 1:m bid_hrs_22 using "E:\data\CMS_DUA_51675_2014\Merged\Stata\basf_1998_2015.dta", ///
keep(match) nogen
keep bid buyin_mo start_dt
gen year=year(start_dt)
drop if missing(bid_hrs)
tempfile mbsf
save `mbsf'

import excel "E:\data\hrs_restricted_2014\Ref Docs\Medicaid generosity.xlsx", sheet("Sheet1") firstrow case(lower) clear
rename location stateusps
tempfile generosity
save `generosity'

use "E:\data\burden_dementia\final_data\R01_final.dta" if ffs_84==1, clear
drop buyin_mo
sort id nflag
by id: carryforward bid_hrs_22, replace
replace year=index_year if nflag==0
sort id year nflag
by id year: keep if _n==1
merge m:1 stateusps using `generosity', gen(gm)
drop if gm==2
duplicates report bid_hrs_22 year
merge 1:1 bid_hrs_22 year using `mbsf', gen(mbsf)
drop if mbsf==2
tab mbsf
tab medicaid
gen mbsf_medicaid=buyin_mo>=1 if !missing(buyin_mo)
tab mbsf_medicaid
tab nflag
gen t2d=index_date-c_ivw_date
replace t2d=0 if index_year==year
sum t2d
gen y2d=ceil(t2d/365.25)
tab y2d
gen baseline=1 if year>=7
replace baseline=y2d>=7
sort id baseline y2d
by id baseline: drop if baseline & _n>1
replace y2d=7 if y2d>7
replace year=-y2d+8
replace medicaid=medicaid_exit if missing(medicaid)
replace medicaid=0 if missing(medicaid)
preserve
collapse (mean) medicaid mbsf_medicaid generous (count) nmcaid=medicaid nmbsf=mbsf_medicaid n=generous, by(year)



twoway (connected medicaid year) (connected mbsf_ year) (connected generous year), ///
xlabel(1 "6-7" 2 "5-6" 3 "4-5" 4 "3-4" 5 "2-3" 6 "1-2" 7 "0-1" 8 "at death")xtitle("")  ytitle("") ///
legend(label(1 "SR Medicaid") label(2 "Medicaid from Buy-in") ///
label(3 "Resides in Generous State")) saving(medicaid_over_time, replace)

restore
preserve
collapse (mean) medicaid mbsf_medicaid generous (count) ///
nmcaid=medicaid nmbsf=mbsf_medicaid n=generous, by(year dem_cohort)

twoway (connected medicaid year if dem_cohort==1) (connected mbsf_ year if dem_cohort==1) (connected generous year if dem_cohort==1), ///
xlabel(1 "6-7" 2 "5-6" 3 "4-5" 4 "3-4" 5 "2-3" 6 "1-2" 7 "0-1" 8 "at death")xtitle("")  ytitle("") ///
legend(label(1 "SR Medicaid") label(2 "Medicaid from Buy-in") ///
label(3 "Resides in Generous State")) saving(medicaid_over_time_dem, replace) ///
title("No Dementia")

twoway (connected medicaid year if dem_cohort==0) (connected mbsf_ year if dem_cohort==0) (connected generous year if dem_cohort==0), ///
xlabel(1 "6-7" 2 "5-6" 3 "4-5" 4 "3-4" 5 "2-3" 6 "1-2" 7 "0-1" 8 "at death")xtitle("")  ytitle("") ///
legend(label(1 "SR Medicaid") label(2 "Medicaid from Buy-in") ///
label(3 "Resides in Generous State")) saving(medicaid_over_time_no_dem, replace) title("Dementia") 

graph combine medicaid_over_time_no_dem.gph medicaid_over_time_dem.gph, ycommon ///
saving(medicaid_combined, replace)
graph export medicaid_combined.pdf, replace

twoway (connected medicaid year if dem_cohort==1) (connected mbsf_ year if dem_cohort==1) ///
(connected medicaid year if dem_cohort==0) (connected mbsf_ year if dem_cohort==0), ///
xlabel(1 "6-7" 2 "5-6" 3 "4-5" 4 "3-4" 5 "2-3" 6 "1-2" 7 "0-1" 8 "at death")xtitle("")  ytitle("") ///
legend(label(1 "SR Medicaid-Dem") label(2 "Medicaid from Buy-in-Dem") ///
label(3 "SR Medicaid-no-Dem") label(4 "Medicaid from Buy-in-no-Dem")) ///
saving(medicaid_over_time_7yrs, replace)
graph export medicaid_over_time_7yrs.pdf, replace



H="*********************************"


H="long form dataset"
/******************
things from the exit, need to figure this out
-death date, adls/iadls, location of death, hospice medicaid/gap/va, value estate
	
things that are t:
-MC expenditures
-i

things that are in waves, need to be converted to annual:
-fixed characteristics
    -gender, birth date, death date, race, education
-mutable
	-age (computed at each year, from birth date above, rather than filled)
	-net worth, financial wealth, adl/iadls, srh, medicaid, champus, medigap, married or partnered
	-nursing home resident
	-dementia
	-region
	-family vars-resident children, transfers, help from kids 
	-out of pocket spending
	-number of helpers, helper hours, any helpers, imputed social costs

******************/
clear all
set more off
capture log close

local datapath "E:\data\burden_dementia\int_data"
local fdpath "E:\data\burden_dementia\final_data"
local logpath "E:\data\burden_dementia\logs"
local ooppath "E:\data\burden_dementia\oopdata"

cd `datapath'

/*first pull an index file from the decedent dataset*/
use id index_date index_year cont_ffs_n_mos using decedent_dataset.dta if inrange(index_year,2006,2014), clear
gen ffs_yrs=floor(cont_ffs_n_mos/12)
*keep if ffs_y==5
tempfile index
save `index'


/*2nd, connect decedent dataset to exit*/
local vars female married_or_ medicaid champus medigap nhres hospice ///
e_ivw* *year loc_hosp adl_independent iadl_independent reschil_d livealone ///
comor_c_hrs 

use id `vars' using "E:\data\hrs_cleaned\exit_02_to_14_dt.dta" if !missing(e_ivw_date)
foreach x in married_o medicaid champus medigap nhres hospice loc_hosp ///
adl_independent iadl_independent reschil_d livealone {
rename `x' `x'_x
}
tempfile exit1
save `exit1'

merge 1:1 id using `index', nogen keep(match)
//set time=0 so it can be appended to the core
gen t2=0
drop if e_ivw_date<index_date
tempfile exit
save `exit'

/*3rd, save tracker, oop, dementia, rand family, and helpers*/


use "E:\data\hrs_public_2014\dementia\pdem_withvarnames_ebl.dta", clear
gsort id -core_year 
replace pdem=prob_hurd if !missing(prob_hurd)
by id: egen firstdem=min(cond(inrange(pdem,0.5,1),core_year,.))
by id: keep if _n<5
tempfile dem
save `dem'

use "E:\data\hrs_cleaned\restr_tracker_v2014.dta", clear
drop id
gen id=hhid+pn
tempfile track
save `track'


use `ooppath'\oopme_final_2014.dta, clear
rename *, l
gen id=hhid+pn
/*gsort id -year
by id: gen n=_n
keep if n<5
by id: gen lastyear=year[1]
keep id lastyear total_oop n year
rename year core_year
*reshape wide total_oop year, i(id) j(n)*/
tempfile oop
save `oop'


use "E:\data\hrs_cleaned\helper_hours_2014.dta", clear
gen id=hhid+pn 
//cap number of hours at 720 (24 hrs for 30 days) for spouses and other informal
foreach x in s u {
replace hlphrs_`x'=720 if hlphrs_`x'>720
}
replace hlphrs_i=hlphrs_s+hlphrs_u
tempfile help
save `help'


/*5th, connect decedent dataset to core
	1) merge 1:m to restrict to decedents
	2) flag those that have two+ cores within 5 years
	3) keep all within 5 years and the one before for baseline
	4) merge by core year with dementia prob, rand fam, helpers, oop datasets
	5) reset so that it's in annual long format
*/

use `index', clear
merge 1:m id using "E:\data\hrs_cleaned\core_00_to_14.dta", nogen ///
keep(match master)
sort id core_year
replace wgthh=. if wgthh==0
carryforward wgthh, replace
gsort id -core_year
carryforward wgthh, replace
by id: gen n=_n
gen time=(index_date-c_ivw_date)/365.25
gen t2=ceil(time)
by id: egen yes=min(time)
gen y1=inrange(yes,0,5)
gen inn=n if time<=7
gen outn=n if time>7
by id: egen y2=max(inn)
//get the first interview outside the window
by id: egen y3=min(outn)

/*keep all ivws within 5 years and a baseline for those who have at least one 
ivw w/in 5 years*/
keep if y1 & (inrange(time,0.00001,7) | y3==n)

/*drop baselines if >9 years out*/
drop if time>9

//locals to keep relevant vars
local corevars networth_adj2012 finwealth_adj2012 medicaid champus medigap srh_pf adl_independent_core ///
iadl_independent_core nhres reschil_d wgthh comor_c smoke_ever smoke_curr
local helpvars n_hp hlphrs_i n_i hlphrs_u hlphrs_s
local famvars resd_kid_ind help_adls_kid_adult help_iadls_kid_adult ///
transf_from_kid_adult_ind
local oopvars total_oop
local trackvars birth_date hisp_eth white black other_na_api cause_death degree
local demvars pdem ldem firstdem prob_hurd
keep id `corevars' core_year c_ivw_* index_date t2 time

append using `exit'

//keep only those with an exit
sort id t2
by id: egen min=min(t2)
keep if min==0
drop min

//keep only those with at least one core
by id: gen n=_n
by id: gen obs=_N
by id: drop if _N==1

//gen year to merge with oop & helper
gen year=core_year
replace year=exit_year if missing(year)

merge 1:1 id year using `oop', gen(oopmerge) keep(match master)  ///
keepusing(`oopvars')
merge 1:1 id year using `help', gen(helpmerge) keep(match master) ///
keepusing(`helpvars')
merge 1:1 id core_year using `dem', gen(demmerge) keep(match master) ///
keepusing(`demvars')
merge m:1 id core_year using ///
"E:\data\hrs_public_2014\rand2014\family\family_r_clean_98_12.dta", ///
gen(randfammerge) keep(match master) keepusing(`famvars')
merge m:1 id using `track', nogen keep(match) keepusing(`trackvars')

//hs+ (including ged)
gen hseduc=degree>0
label var hseduc "HS Degree+ (including GED)"

replace t2=8 if t2>8
gsort id -year
by id: replace pdem=pdem[_n+1] if t2==0
gen no=0
by id: replace no=1 if year>year[_n+1]+2 & _n!=_N
by id: replace no=1 if _n==_N & t2<4
by id: egen anyno=max(no)
*drop if anyno==1 | obs==3
/*
foreach x of varlist * {
	if !inlist("`x'","id","t2") local allvars `allvars' `x'
}

reshape wide `allvars', i(id) j(t2)
*/

foreach x in `helpvars' {
	replace `x'=0 if missing(`x')
}
drop year
gen yearfromdeath=t2
tempfile t1
save `t1'

keep id t2 time *oop c_ivw_date n hlphrs_*
replace time=0 if t2==0
sort id t2 
by id: gen timetonext=time[_n+1]-time
by id: replace timetonext=7-time if missing(timetonext) & time<3
by id: replace timetonext=2 if missing(timetonext) & time>=3
replace timetonext=0 if t2==8
gen wave_oop=total_oop
gen og=wave_oop
//convert total oop to annual measure
replace total_oop=total_oop/timetonext
by id: gen timefromlast=time-time[_n-1]
by id: gen yearnext=t2[_n+1]
by id: gen lastoop=total_oop[_n-1]
by id: replace lastoop=lastoop[_n-1] if missing(lastoop)
replace total_oop=0 if t2==6
/*helper hours--get previous and do the same as oop, but avg between two
from OOP code--use 4 months if previous wave there was no help, otherwise use 4 
months at current and rest between*/

foreach x in _u _s {
by id: gen last`x'=hlphrs`x'[_n-1]
by id: gen next`x'=hlphrs`x'[_n+1]
replace next`x'=0 if missing(next`x')
replace last`x'=hlphrs`x' if missing(last`x')
replace last`x'=0 if missing(last`x')
gen avg`x'=(hlphrs`x'+next`x')/2
}
gen hlphrs_ann=(avg_u+avg_s)*12
by id: gen lasthelp=hlphrs_ann[_n-1]
replace lasthelp=hlphrs_ann if t2==0
by id: gen nexthelp=hlphrs_ann[_n+1]
replace hlphrs_ann=0 if missing(nexthelp)
replace nexthelp=hlphrs_ann if missing(nexthelp)
reshape wide og time total_oop c_ivw_date hlphrs_ann hlphrs_i hlphrs_u hlphrs_s last_u last_s next_u next_s ///
avg_u avg_s lasthelp nexthelp timetonext timefromlast yearnext lastoop wave_oop n, i(id) j(t2)
reshape long time og total_oop c_ivw_date hlphrs_ann hlphrs_i hlphrs_u hlphrs_s last_u last_s next_u next_s ///
avg_u avg_s l lasthelp nexthelp timetonext timefromlast yearnext lastoop wave_oop n, i(id) j(year)

sort id year
*by id: carryforward total_oop, gen(annual_oop)
by id: carryforward time, gen(antime)
by id: replace lastoop=total_oop[_n-1] if missing(lastoop)
by id: replace lastoop=lastoop[_n-1] if missing(lastoop)
by id: carryforward timetonext timefromlast lasthelp hlphrs_ann, replace
gsort id -year
by id: carryforward nexthelp, replace
sort id year
gen pct1=(year-time) if year<6
gen pct2=1-(year-time) if year<6
by id: replace pct2=1 if missing(time) & year<6


gen annual_oop=pct2*lastoop if inrange(year,1,5)
replace annual_oop=annual_oop+pct1*total_oop if !missing(pct1)
/*for annual helper hours 
-4 months at current
-if any at previous, 4 months at current and 8 months at avg current and former*/
gen annual_hlphrs=hlphrs_ann*2/3 + hlphrs_i*12/3
replace annual_hlphrs=hlphrs_ann if missing(annual_hlphrs) 
replace annual_hlphrs=. if inlist(year,0,6)
/*gen annual_hlphrs=hlphrs_ann/3+(hlphrs_ann+nexthelp)/3
replace annual_hlphrs=(lasthelp+nexthelp)/2 if missing(n)
gen annual_hlphrs=(nexthelp) if inrange(year,1,5) & missing(n)
replace annual_hlphrs=pct2*lasthelp if  missing(annual_h) & inrange(year,1,5)
replace annual_hlphrs=annual_h+pct1*hlphrs_a if !missing(pct1)*/
replace wave_oop=wave_oop*timetonext/(time[_n+1]-time) if time[_n+1]>5 & ///
!missing(time[_n+1])
replace wave_oop=wave_oop*(5-time)/2 if missing(time[_n+1]) & time>=3
replace wave_oop=0 if time>5

by id: egen all=total(wave)
by id: egen a2=total(annual_oop)
sum all a2
sum all a2 if year==0
keep id all a2 year annual_* hlphrs*

rename (year ) (yearfromdeath )
tempfile t2
save `t2'

use decedent_dataset.dta if inrange(index_year,2001,2012), clear
drop *bef

gen ffs_yrs=floor(cont_ffs_n_mos/12)
foreach x in 12 24 36 48 60 {
rename tot_paid_by_mc_`x'm tot_paid_by_mc`=`x'/12'
}

forvalues i=1/5 {
replace tot_paid_by_mc`i'=. if ffs_yrs<`i'
}

reshape long tot_paid_by_mc, i(id) j(yearfromdeath)
keep id tot* yearfr
tempfile t3
save `t3'
/*
merge 1:1 id yearfromdeath using `t2', gen(oopme2) keep(match using)
merge 1:1 id yearfromdeath using `t1', gen(fullmerge)
*/
use `t1', clear
merge 1:1 id yearfromdeath using `t2', gen(oopme2) keep(match using)
merge 1:1 id yearfromdeath using `t3', gen(mcmerge) keep(match master)
sort id yearf

by id: replace ffs_y=ffs_y[_n+1] if missing(ffs_y)
by id: replace pdem=pdem[_n+1] if n==1 & missing(pdem)
gen likely_dem=inrange(pdem,.5,1) if !missing(pdem)
by id: egen pdem_gt50_n1=max(cond(n==2,likely_dem,.))
drop if missing(pdem_g) 
gen age_at_death=floor((index_dat-birth_date)/365.25)
drop if age_<70
label var age_ "Age at death"
foreach x of varlist `helpvars' {
replace `x'=0 if missing(`x')
}
gen ind_hp=n_hp>0
label var ind_hp "any helpers"
gen comorb_modsev=comor_c>=2 if !missing(comor_c)
label var comorb_modsev "4+ SR conditions"
label var likely_dem "Probable demntia (Pr>.5)"
label var time "Time from ivw to death, years"
foreach x in pdem likely_dem medicaid adl_independent_core iadl_independent_core ///
smoke_curr comorb_modsev time ind_hp `helpvars' networth_adj2012 finwealth_adj2012 {
gen `x'_ba=`x' if n==obs
by id: egen `x'_b=max(`x'_ba)
drop `x'_ba
local lab : var label `x'
label var `x'_b "`lab' at baseline"
}
replace networth_adj2012_b=1 if networth_adj2012_b<=0
//discounting--why?
forvalues i=1/5 {
	foreach x in tot_paid_by_mc annual_oop annual_hlp {
		*replace `x'=`x'/1.03^`=`i'-1' if year==`i'
}
}
by id: egen tottot=total(tot_paid_by_mc)
by id: egen alloop=total(annual_oop)
by id: egen allhelp=total(annual_hlp)
replace allhelp=allhelp*20
label var allhelp "Imputed informal help over 5 years (at $20/hr)"
label var tottot "Total paid by MC over 5 years"
label var alloop "Total paid OOP over 5 years"
gen time_x=(e_ivw_date-index_date)/365.25
label var time_x "Time from death to exit, years"
gen baseline_out=time_b>=5
label var baseline_out "% with a baseline outside the 5 year window"

replace likely_dem=pdem_g if year==0



gen oopsofar=0
forvalues i=7(-1)1 {
by id: replace oopsofar=annual_oop+oopsofar[_n+1] if year==`i'
}
replace oopsofar=alloop if year==0
gen oop_gt_nw=oopsofar>=networth_adj2012_b
gen nw_remaining=100*(networth_adj2012_b-oopsofar)/networth_adj2012_b
replace nw_r=0 if nw_r<0
replace nw_r=0 if networth_adj2012_b<0
//table
local cvars1 time_x time_b 
local ivars1 baseline_out
local cvars2 age_at_death
local cvars3 n_i n_i_b pdem pdem_b
local ivars2 white black hisp_eth other_na_api_race female married_o_x hseduc medicaid_x medicaid_b ///
medigap_x champus_x ind_hp ind_hp_b 
local ivars3 likely_dem likely_dem_b ///
adl_independent_x adl_independent_core_b iadl_independent_x ///
iadl_independent_core_b smoke_curr_b comorb_modsev comorb_modsev_b
local coutcomes3 tottot alloop allhelp
local rn : word count `cvars1' `cvars2' `ivars1' `ivars2' `cvars3' `ivars3' `coutcomes3' 1

mat tab=J(`rn',4,.)
local r=1
local c=1
gsort id -year
by id: carryforward wgthh, replace
sort id year
preserve

keep if n==1
foreach group in "0,1" 0 1 {
	sum likely_dem if inlist(likely_dem,`group')
	local denom=r(N)
	foreach round in 1 2 3 {
		foreach x of local cvars`round' {
			sum `x' if inlist(likely_dem,`group') [aw=wgthh]
			if !inrange(r(N),1,10) mat tab[`r',`c']=r(mean)
			if "`group'"=="0,1" & !inrange(`denom'-r(N),1,10) mat tab[`r',`c'+3]=`denom'-r(N)
			local r=`r'+1
}
		foreach x of local ivars`round' {
			sum `x' if inlist(likely_dem,`group') [aw=wgthh]
			if !inrange(r(mean)*r(N),1,10) mat tab[`r',`c']=r(mean)*100
			if "`group'"=="0,1" & !inrange(`denom'-r(N),1,10) mat tab[`r',`c'+3]=`denom'-r(N)
			local r=`r'+1
}
		foreach x of local coutcomes`round' {
			sum `x' if inlist(likely_dem,`group') [aw=wgthh]
			if !inrange(r(N),1,10) mat tab[`r',`c']=r(mean)
			if "`group'"=="0,1" & !inrange(`denom'-r(N),1,10) mat tab[`r',`c'+3]=`denom'-r(N)
			local r=`r'+1
}


}	
	mat tab[`r',`c']=`denom'
	local r=1
	local c=`c'+1
}
mat rownames tab=`cvars1' `ivars1'  `cvars2' `ivars2' `cvars3' `ivars3' `coutcomes3' N

frmttable using "E:\data\burden_dementia\logs\table_baseline_death.rtf", replace ///
statmat(tab) title("Sample Characteristics by dementia status at n1 ivw") ///
ctitles("" "Full Sample" "No dementia" "Dementia" "N missing") sdec(2,2,2,0) ///
varlabels note("Decedents 2006-2012 with 60m continuous FFS pre-death, an exit and all core ivws" ///
"Household weights applied")

restore
preserve

egen totalpaid=rowtotal(tot_paid_by_mc total_oop annual_hlp)
collapse tot_paid_by_mc total_oop annual_hlp pdem likely_dem totalpaid networth_adj2012_b ///
oopsofar oop_gt_nw nw_remaining [pw=wgthh], by(pdem_gt50_n1 year)
replace year=-year+6

label define year 0 "Baseline" 6 "Death"
label values year year

twoway (line pdem year if pdem_g==1) (line pdem year if pdem_g==0) ///
(line likely_dem year if pdem_g==1) (line likely_dem year if pdem_g==0) if year<6, ///
xlabel(0.1 "Baseline" 1 2 3 4  5 "Death") xtitle("")
graph save "E:\data\burden_dementia\logs\dementia_prob_over_time", replace
graph export "E:\data\burden_dementia\logs\dementia_prob_over_time.pdf", replace

twoway (line nw_remaining yearfromdeath if pdem_g==1)(line nw_remaining yearfromdeath if pdem_g==0) ///
(line oop_gt yearfromdeath if pdem_g==1 , yaxis(2)) (line oop_gt yearfromdeath if pdem_g==0, yaxis(2)) ///
if year<6, xlabel(0.1 "Baseline" 1 2 3 4  5 "Death") xtitle("") ///
legend(label(1 "% NW remaining, demented") label(2 "% remaining, nondemented") ///
label(3 "% OOP>NW, demented") label(4 "% OOP>NW, nondemented"))
graph save "E:\data\burden_dementia\logs\networth_oop_over_time", replace
graph export "E:\data\burden_dementia\logs\networth_oop_over_time.pdf", replace
restore
save "`fdpath'/burden_dementia_sample_long.dta", replace


H="changelog"
04/18/19 - Added baseline values to Table 1 and Final Sample headers. Evan

04/16/19 - Added "Table 1" header. Evan

04/12/19 - Added "annual diagnoses before" and Elishuaser headers. Evan

04/11/19 - Added table with p-values. Evan 

03/12/19 - Also adjusted CPI for NH costs from Genworth. Evan

03/12/19 - Removed CPI and HR rate adjustments for informal costs in years prior to 2009, and also scrapped "months-at-risk" approach in favor of sticking to calendar year. Omari

03/06/19 - Corrected a merge where the Genworth and CPI weren't merging correctly with the exit in "Annual Calculations" header. Evan

03/05/19 - Altered formula for helpers to reflect times when months<4, because it was resulting in a few negatives, and changed Genworth rates to Medians in 2016 where state was missing. Evan

02/28/19 - Added model of Medicaid Nursing Home nights into the Model and Calculate Medicaid headers and removed mean imputation from the Final sample header. Evan

02/27/19 - Added 4th bucket (SR nights is gold standard) to unattributed NH costs in Final Sample & Table 1 header and updated 7 year graphs to run for all 4. Evan

02/26/19 - Updated 7 year graphs to include nursing home imputations and CIs. Evan

02/26/19 - Fixed SNF days error and improved nursing home bucketing in Final Sample header.  Evan

02/25/19 - Added SNF days and Nursing home nights buckets in Cleaning/Merging, Annual Calculations, and Final Sample headers. Evan

02/13/19 - Corrected "MC Spending" header by pulling for 84 months of claims instead of 60. Evan

02/08/19 - Added header "Charlson comorbodities" for comorbidities in the last year of life and amended "Model Medicaid spending" to bring in the predictions from the two-part model instead of the linear random effects model.  Evan

02/05/19 - Added header "Comparison table 5 v 7 yrs." Evan

01/29/19 - Brought the predicted Medicaid into the sample.  Evan

01/22/19 - Updated the graphs and added graph of Medicaid over time. Evan

01/17/19 - Added the predicted Medicaid. Evan

01/16/2019 - Calculating annualized costs for the 7 years prior to death. Omari

01/15/2019 - Inflation adjusted all figures 2016 and correct sample derivation. Omari

01/11/2019 - Updated Sample to include death dates to 2015, Exit 2016 and 7 year lookback. Omari

01/04/19 - Continued working on separating the Dataset construction from Sample Derivation. Omari

01/03/19 - Continued working on separating the Dataset construction from Sample Derivation. Omari

01/02/19 - Continued working on separating the Dataset construction from Sample Derivation. Omari

12/31/18 - Worked on separating the Dataset construction from Sample Derivation. Omari

12/20/18-finished update for 2015 claims and worked on 7-years.


