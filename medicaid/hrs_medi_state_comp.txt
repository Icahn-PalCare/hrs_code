//HRS Medicaid State comparison used to check if states in HRS are in Medicaid. 
//RO1-Amy

//HRS 
use "E:\data\hrs_cleaned\restr_tracker_v2014.dta" , replace
keep hhid pn stateusps*
sort hhid pn

foreach x of varlist * {
replace `x'="" if `x'=="."
replace `x'="" if `x'=="ZZ"
replace `x'="" if `x'=="NA"
replace `x'="" if `x'=="AE"
replace `x'="" if `x'=="AP"
}
rename stateusps00 stateusps0
rename stateusps02 stateusps2 
rename stateusps04 stateusps4
rename stateusps06 stateusps6
rename stateusps08 stateusps8


**Don't need collapse
//collapse (firstnm) stateusps*, by(hhid pn)
reshape long stateusps, i(hhid pn) j(year)
drop if hhid=="."

forvalues i=92/98{
replace year=19`i' if year==`i'
} 

forvalues i=0/8{
replace year=200`i' if year==`i'
} 

forvalues i=10/12{
replace year=20`i' if year==`i'
} 
drop if hhid==""

sort hhid pn year
by hhid pn: carryforward stateusps, replace


capture drop a
bys hhid pn: gen a=_n==1
sum a if a==1
local a=r(N)
di `a'

tempfile track
save "`track'"

//HRS core
use "E:\data\hrs_cleaned\core_00_to_14.dta" , replace

gen year=core_year

sort hhid year

//HRS core merged with tracker
merge 1:1 hhid pn year using "`track'"
keep if _merge==3
drop _merge
rename hhidpn hhidpn_hrs

capture drop b
bys hhid pn: gen b=_n==1
sum b if b==1 
local b=r(N)
di `b'

//HRS merged with Medicaid crosswalk
merge m:1 hhid pn using "E:\data\CMS_DUA_51675_2014\Medicaid_merged\MedicaidXref2012.dta"
keep if _merge==3
drop _merge

capture drop d
bys bid_hrs_23: gen d=_n==1
sum d if d==1 
local d=r(N)
di `d'

tempfile hrsxmedi
save "`hrsxmedi'"


//Medicaid HRS
use "E:\data\CMS_DUA_51675_2014\Medicaid_merged\hrs_max_ps_99_12.dta", replace


//dropping dups
sort bid_hrs_23 year
capture drop tag
by bid_hrs_23 year, sort: gen tag=_n==1
//drop if tag==0

//Merge Medicaid with HRS file
merge m:1 bid_hrs_23 year using "`hrsxmedi'" 

sort bid_hrs_23 year
by bid_hrs_23: carryforward stateusps, replace

gsort bid_hrs_23 -year
by bid_hrs_23: carryforward stateusps, replace

capture drop er
by bid_hrs_23: gen er=1 if stateusps!=stateusps[_n+1] & bid_hrs_23==bid_hrs_23[_n+1] & stateusps!="" & stateusps[_n+1]!=""
tab er

sort bid_hrs_23 year
by bid_hrs_23: carryforward state, replace
gsort bid_hrs_23 -year
by bid_hrs_23: carryforward state, replace


//keep if _merge==3
drop _merge

capture drop e
bys bid_hrs_23: gen e=_n==1
sum e if e==1 
local e=r(N)
di `e'

by stateusps year, sort: gen state_hrs=_n==1
replace state_hrs=0 if stateusps==""
tab year state_hrs

by state year,sort: gen state_med=_n==1
replace state_med=0 if state==""
tab year state_med

tab stateusps state

capture drop comp
bys year: gen comp=1 if stateusps!=state
bys year: tab stateusps state_hrs if comp==1
bys year: tab state state_med if comp==1

by year: tab comp
/*
capture drop comp1
keep if year==2004
sort comp
gen comp1=1 if comp==1 & stateusps[_n]!=state[_N]
!inlist(stateusps, state[_n_]) 

tab year comp1

gen comp1=1 if inlist(stateusps,state)
*/
capture drop comp1
gen comp1=.

forvalues i= 1999/2012{
levelsof state if year==`i'

foreach lev in `r(levels)' {
replace comp1=1 if stateusps=="`lev'" & year==`i'
}
}
replace comp1=0 if comp1==.

bys year: tab stateusps if comp1==0 & comp==1 & state!=""

di `d'
mat tab=J(5,1,.)
local r=1
local c=1
foreach x in `a' `b' `d' `e' {
mat tab[`r',`c']=`x'
local r=`r'+1
}
mat list tab 

frmttable using "E:\Files to move out\Mohammed\20180418\medicaidxhrs_states.doc", replace statmat(tab) ///
sdec(0) ctitle(" ", "Number of Unique Individuals") rtitle("HRS Tracker" \ "HRS core with Tracker" \ "Medicaid Crosswalk merged" \ "Medicaid with HRS" ) ///
title("Sample Derivation") note("Keeping Individuals who Merged with Medicaid Crosswalk")

tab stateusps if comp1==0 & comp==1 & year==2000 & state!="", matcell(a)
tab stateusps if comp1==0 & comp==1 & year==2001 & state!="", matcell(b)
tab stateusps if comp1==0 & comp==1 & year==2002 & state!="", matcell(c)
tab stateusps if comp1==0 & comp==1 & year==2003 & state!="", matcell(d)
tab stateusps if comp1==0 & comp==1 & year==2004 & state!="", matcell(e)
tab stateusps if comp1==0 & comp==1 & year==2005 & state!="", matcell(f)
tab stateusps if comp1==0 & comp==1 & year==2006 & state!="", matcell(g)
//tab stateusps if comp1==0 & comp==1 & year==2012 & state!="", matcell(h)


frmttable using "E:\Files to move out\Mohammed\20180418\medicaidxhrs_states.doc", replace statmat(a) ///
sdec(0) ctitle("Missing State", Frequency) rtitle(DE) addtable ///
title("Missing States in 2000 Medicaid") note("Missing in Medicaid for 2000, but in HRS Tracker" )

frmttable using "E:\Files to move out\Mohammed\20180418\medicaidxhrs_states.doc", replace statmat(b) ///
sdec(0) ctitle("Missing State", Frequency) rtitle(DE) addtable ///
title("Missing States in 2001 Medicaid") note("Missing in Medicaid for 2001, but in HRS Tracker" )

frmttable using "E:\Files to move out\Mohammed\20180418\medicaidxhrs_states.doc", replace statmat(c) ///
sdec(0) ctitle("Missing State", Frequency) rtitle(DE) addtable ///
title("Missing States in 2002 Medicaid") note("Missing in Medicaid for 2002, but in HRS Tracker" )

frmttable using "E:\Files to move out\Mohammed\20180418\medicaidxhrs_states.doc", replace statmat(d) ///
sdec(0) ctitle("Missing State", Frequency) rtitle(DE) addtable ///
title("Missing States in 2003 Medicaid") note("Missing in Medicaid for 2003, but in HRS Tracker" )

frmttable using "E:\Files to move out\Mohammed\20180418\medicaidxhrs_states.doc", replace statmat(e) ///
sdec(0) ctitle("Missing State", Frequency) rtitle(HI \ PR) addtable ///
title("Missing States in 2004 Medicaid") note("Missing in Medicaid for 2004, but in HRS Tracker" )

frmttable using "E:\Files to move out\Mohammed\20180418\medicaidxhrs_states.doc", replace statmat(f) ///
sdec(0) ctitle("Missing State", Frequency) rtitle(HI \ PR) addtable ///
title("Missing States in 2005 Medicaid") note("Missing in Medicaid for 2005, but in HRS Tracker" )

frmttable using "E:\Files to move out\Mohammed\20180418\medicaidxhrs_states.doc", replace statmat(g) ///
sdec(0) ctitle("Missing State", Frequency) rtitle(PR) addtable ///
title("Missing States in 2006 Medicaid") note("Missing in Medicaid for 2006, but in HRS Tracker" )

/*frmttable using "E:\Files to move out\Mohammed\20180418\medicaidxhrs_states.doc", replace statmat(h) ///
sdec(0) ctitle("Missing State", Frequency) rtitle(CO \ KS) addtable ///
title("Missing States in 2012 Medicaid") note("Missing in Medicaid for 2012, but in HRS Tracker" )


mat tab1=J(50,50,.)
local r=1
local c=1
//forvalues i= 2000(2)2012{
levelsof state if year==2000, local(levels)
mat tab1[`r',`c']="`levels'"
//}

mat list tab1


