= V4 Outline MultiLine NoSorting TabWidth=30

H="Medicare costs last 2 years to merge with oop costs"
/* 
Medicare claims 2000-2010
Core Interviews 1998-2010
Exit interviews 2002-2010
OOP data 1992-2010

This file gets OOP costs in last 2 years of life and Medicare costs last 2 years of life
Merges with exit, restricted, n1 and n2 core interviews from HRS

All $ are adjusted for inflation to 2010 dollars

Workflow is as follows:
1. Get dataset of interviews with mc xwalk for all decedents, exit+restricted+mc xwalk
+core n1 + core n2 (dataset is oop_int.r_x_r_n1_n2)
	(Core interviews include dementia probability from Hurd et al paper)
2. Check Medicare and HMO status 2 years before death and define sample size
3. Determine nursing home nights not paid by Medicare, assign costs based on 
	Medicaid status (self reported)
4. Get dataset of OOP data for all decedents from exit and core n1 and n2 core ivws
5. Get additional information from claims
	Elixhuaser comorbidities, chronic conditions 2 years before death from dx codes
	Hospital, etc LOS 2 years before death
6. Totals of Medicare payments for last 2 years of life
*/


/*Set up file paths that will be used*/

/*source dataset for OOP information 1992-2010*/
libname oop_src "E:\data\hrs_oop_2010\received_data";

/*Project working data directory */
libname oop_int "E:\data\hrs_oop_2010\int_data";

/*Final data directory */
libname oop_fnl "E:\data\hrs_oop_2010\final_data";

/*Medicare claims files - 2010*/
libname medi 'E:\data\cms_DUA_25000_2010';
proc contents data=medi.cmsxref2010;
run;

/*Cleaned HRS 2000-2010 datasets (core, exit and restricted SAS datasets)*/
libname hrs_cln 'E:\data\hrs_cleaned';

/*dementia probabilities*/
libname hrs_dem 'E:\data\hrs_public_2010\dementia';

/*File path for raw data
Some are copied from the Hospice impact project documents saved here:
C:\projects\Hospice_impact_on_utilization\raw_data
Copied over on 9/26/2013 by RG
Folder contains reference wage index adjustment files
Wage index 2010 downloaded from CMS 3/24/14*/

libname oop_wi "E:\data\hrs_oop_2010\ref_data\wage_index";
libname oop_nh "E:\data\hrs_oop_2010\ref_data\nh_costs_by_state";
libname oop_ref "E:\data\hrs_oop_2010\ref_data";


H="Pull exit and restricted interviews and mc xwalk id"
/*
Create respondant dataset with exit, restricted HRS,
and medicare xwalk

Resulting dataset is:
oop_int.exit_restricted_02_to_10_v1
*/

/*******************************************************************/
/*******************************************************************/
/*  Bring medicare xwalk id to exit interview dataset              */
/*******************************************************************/
/*******************************************************************/

proc contents data=hrs_cln.exit_02_to_10_dt(keep=id);
run;

data exit_1;
set hrs_cln.exit_02_to_10_dt;
run;

/*just keep cleaned variables from exit interview*/
data exit;
set exit_1(keep=ID EXIT_YEAR PROXY_EXIT FEMALE MARITAL MARRIED MARITAL_SEP MARITAL_DIV MARITAL_WID MARITAL_NEV
MARITAL_SD MARITAL_MISSING MEDICARE MEDICAREB MEDICAID CHAMPUS HMO MEDIGAP CATINSUR NHRES
HOSPICE FREQRELG CHILD GCHIL ALLCHIL RESCHIL RESCHIL_D RESSPOUSE HHM LIVEALONE LOCATION LOC_HOSP
ICU VENT DIALYSIS DEC_ALL DEC_LIM DEC_WHLD DEC_COMF DEC_CAT DEXP EOLDEC CAPACITY DURATION ADAPP
ADPROB DECMAKER LWILL LW_ALL LW_LIM LW_WHLD LW_COMF LW_CAT HCP DISCUSS ADVDIR EOLPLAN
ADL_BEDBOUND DAYS_BED_ILL ADL_DR ADL_WK ADL_BH ADL_E ADL_TX ADL_T ADL_INDEX ADL_CAT ADL_INDEPENDENT
ADL_PARTIAL ADL_SEVERE IADL_MP IADL_GR IADL_PH IADL_RX IADL_M IADL_IND IADL_CAT IADL_INDEPENDENT
IADL_PARTIAL IADL_SEVERE ADL_SP_HELPER ADL_OTH_HELPER IADL_SP_HELPER IADL_OTH_HELPER adl_helper_count iadl_helper_count adl_helper_1-adl_helper_7 iadl_helper_1-iadl_helper_6 HH_WORKER CANCER_HRS LUNG_HRS HEART_HRS CHF_HRS STROKE_HRS MEMORY_HRS FALLS_HRS
INCONT_HRS PAIN_HRS HTN_HRS DM_HRS PSYCH_HRS ARTH_HRS COMOR_IN_HRS COMOR_C_HRS 
nhres_2yr_exit nh_stays_exit nh_nights_exit nh_ins_exit e_ivw_day e_ivw_month e_ivw_year 
e_ivw_date e_ivw_day_imp) ;
run;


/*HRS - CMS 2010 crosswalk initial processing 
xwalk file: cmsxref2010.sas7bdat*/

data crosswalk_1;
set medi.cmsxref2010;
keep bid_hrs_19 hhid pn;
run;

/*get 2 variables bid_hrs = claims id, id=HRS id*/
data crosswalk_2;
set crosswalk_1;
bid_hrs=bid_hrs_19;
id=trim(hhid)||trim(pn);
drop hhid pn;
drop bid_hrs_19;
run;

proc sort data= crosswalk_2;
by bid_hrs;
run;

proc sort data=exit_1;
by id;
run;

/*bring in xwalk id to exit interview dataset*/
proc sql;
create table exit_xwalk as select
a.*,b.bid_hrs from
exit a
left join
crosswalk_2 b
on a.id=b.id;
quit;

/*check for missing xwalk ids
913 r's with exit interviews are missing xwalk ids*/
data check1;
set exit_xwalk ;
if bid_hrs ='';
run;

/*create indicator for having xwalk id*/
data exit_xwalk_1;
set exit_xwalk;
xwalk_yes=.;
if bid_hrs ='' then xwalk_yes=0;
if bid_hrs~='' then xwalk_yes=1;
run;

proc freq;
table xwalk_yes*exit_year /missprint;
run;

/*keep a version before renaming so can use it later to get spouse exit*/
data exit_xwalk_2;
set exit_xwalk_1;
run;


/*******************************************************************/
/*******************************************************************/
/* Rename variables with  _x suffix for exit dataset  */
/*******************************************************************/
/*******************************************************************/
*options macrogen mprint mlogic;
%macro rename2(lib,dsn,pre,first);
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "Before Renaming All Variables";
run;
proc sql noprint;
select nvar into :num_vars
from dictionary.tables
where libname="&LIB" and
memname="&DSN";
select distinct(name) into :var1-
:var%TRIM(%LEFT(&num_vars))
from dictionary.columns
where libname="&LIB" and
memname="&DSN" ;
quit;
run;
proc datasets library=&LIB;
modify &DSN;
rename
%do i=1 %to &num_vars;

&&var&i=&first.&&var&i.&&pre.
%end;
;
quit;
run;
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "After Renaming All Variables";
run;
%mend ;
%rename2(WORK,EXIT_XWALK_2,_x,);

data exit_xwalk_3;
set exit_xwalk_2;
rename id_x=id;
rename bid_hrs_x=BID_hrs;
rename xwalk_yes_x=xwalk_yes;
run;

proc print data=exit_xwalk_3(keep=id BID_hrs xwalk_yes obs=10);
run;
proc sort data=exit_xwalk_3;
by id;
run;

/*******************************************************************/
/*******************************************************************/
/*  Merge the exit w/ mc xwalk with the restricted dataset         */
/*******************************************************************/
/*******************************************************************/

proc contents data=hrs_cln.restricted_v2010(keep=id);
run;

data restricted;
set hrs_cln.restricted_v2010;
if id~='';
run;

proc sort data=exit_xwalk_3 nodupkey;
by id;
run;

/*replace id with character id so restricted dataset can be merged in
to the exit dataset*/
data restricted_2;
set restricted;
length id_new $9 hhid $6 pn $3;
id_new=hhid||pn;
drop id;
rename id_new=id;
run;

/*get restricted dataset that is just decedents*/
proc sql;
create table restricted_r as select a.*,b.exit_year_x from
restricted_2 a join
exit_xwalk_3 b on a.id=b.id;
quit;

/*get zip code at time of death to use for wage index adjustment*/
data id_zip;
set restricted_r(rename=(ZIP10_2000=ZIP10));
length zip_exit $5;
/*use zip code variable from restricted dataset for year of exit interview*/
zip_exit=vvaluex("zip"||substr(trim(left(exit_year_x)),3,2) );
run;

/*2 obs have missing zip in exit year
They have zip in previous wave so use that*/
data zztestzip1;
set id_zip;
if zip_exit = "";
run;

/*if no zip in exit year, then use zip from wave prior to exit*/
data id_zip_2;
set id_zip;
if zip_exit="" then zip_exit=vvaluex("zip"||substr(trim(left(exit_year_x-2)),3,2)  );
run;

/*check to see if obs still have missing zip - none*/
data zztestzip2;
set id_zip_2;
if zip_exit = "";
run;

/*save a version of the dataset before renaming*/
data restricted_r_1;
set id_zip_2;
run;

/*rename variables in restricted dataset with  _e suffix*/
%rename2(WORK,RESTRICTED_R_1,_e,);

data restricted_r3;
set restricted_r_1;
rename id_e=id;
age_at_death_e=(death_date_e-birth_date_e)/365.25;
label age_at_death_e="Age at death";
death_year_e=year(death_date_e);
run;
proc print data=restricted_r3(keep=id obs=10);
run;
proc sort data=restricted_r3 nodupkey;
by id;
run;

/*this dataset = 6814 decedents from 2002 - 2010 exit interviews
containst exit, mc xwalk id, and restricted info*/
proc sql;
create table exit_restricted_02_to_10 as 
select *
from  exit_xwalk_3 a
left join
restricted_r3 b
on a.id=b.id;
quit;

/*this dataset = 6814 decedents from 2002 - 2010 exit interviews*/
data oop_int.exit_restricted_02_to_10_v1;
set exit_restricted_02_to_10;
if id<0 or id=. then delete;
run;

/*141 decedents missing a cause of death*/
proc freq;
table CAUSE_DEATH_12_N_e;
run;

proc freq;
table death_year_e*EXIT_YEAR_x /missprint;
run;



H="Pull core interviews"
/*Get r's n1 and n2 core interviews*/

libname hrs_cln 'E:\data\hrs_cleaned';
libname oop_int 'E:\data\hrs_oop_2010\int_data';


/*******************************************************************/
/*******************************************************************/
/*  get the negative one core variables for the respondent         */
/*******************************************************************/
/*******************************************************************/

/*full core interview dataset 1998-2010 core ivws*/
proc contents data=hrs_cln.core_00_to_10;
run;

/*list of all core interviews before death date*/
proc sql;
create table r_n1_core_before_death
as select b.*
 from oop_int.exit_restricted_02_to_10_v1 a 
 inner join
hrs_cln.core_00_to_10 b
  on a.id=b.id and a.death_date_e>b.c_ivw_date;
  quit;

proc sort data=r_n1_core_before_death ;
by id c_ivw_date;
run;

/*keep only the n1 core interview
6509 interviews identified
of these, 143 are in 1998 so will not have n2 core*/
data resp_core_n1;
set r_n1_core_before_death;
by id c_ivw_date;
if last.id;
run;
proc freq;
table core_year;
run;

/*******************************************************************/
/*******************************************************************/
/*  get the negative 2 core variables for the respondent         */
/*******************************************************************/
/*******************************************************************/
/*list of all core interviews before n1 interview*/
proc sql;
create table r_n2_core_before_death
as select b.*
 from resp_core_n1 a 
 inner join
hrs_cln.core_00_to_10 b
  on a.id=b.id and a.c_ivw_date>b.c_ivw_date;
  quit;

proc sort data=r_n2_core_before_death ;
by id c_ivw_date;
run;

/*keep only the n2 core interview
6222 interviews identified*/
data resp_core_n2;
set r_n2_core_before_death;
by id c_ivw_date;
if last.id;
run;
proc freq;
table core_year;
run;

/*******************************************************************/
/*******************************************************************/
/*  get the negative 3 core education variable for the respondent   */
/*******************************************************************/
/*******************************************************************/
/*need to do this since education is only asked during r's
first core interview and only backfilled for an overall education
level through 2004*/
proc sql;
create table r_n3_core_before_death
as select b.educ,b.c_ivw_date,b.core_year,b.id
 from resp_core_n2 a 
 inner join
hrs_cln.core_00_to_10 b
  on a.id=b.id and a.c_ivw_date>b.c_ivw_date;
  quit;

proc sort data=r_n3_core_before_death ;
by id c_ivw_date;
run;

/*keep only the n3 core interview
4692 interviews identified*/
data resp_core_n3;
set r_n3_core_before_death;
by id c_ivw_date;
if last.id;
run;
proc freq;
table core_year;
run;

/*******************************************************************/
/* Dementia probabilities */
/*******************************************************************/
/*merge in the HRS dementia probabilities at each core year
Use dementia year - 1 to get the core year that the probability is based on*/
proc contents data=hrs_dem.pdem_withvarnames;
run;

data dem_1;
set hrs_dem.pdem_withvarnames;
core_year_imp = prediction_year-1;
/*create id variable as concat of hhid and pn*/
length id $9 hhid $6 pn $3;
id=hhid||pn;
run;

/*dementia probablility 1998-2006 core years*/
proc freq;
table core_year_imp;
run;

proc sort data=dem_1 nodupkey;
by id core_year_imp;
run;

proc sort data=resp_core_n1 nodupkey;
by id core_year;
run;

/*n1 core interviews*/
proc sql;
create table resp_dem_core_n1
as select a.*,b.prob_dementia from 
resp_core_n1 a left join
dem_1 b
on a.id=b.id and a.core_year=b.core_year_imp;
quit;

proc sort data=resp_core_n2 nodupkey;
by id core_year;
run;

/*n2 core interviews*/
proc sql;
create table resp_dem_core_n2
as select a.*,b.prob_dementia from 
resp_core_n2 a left join
dem_1 b
on a.id=b.id and a.core_year=b.core_year_imp;
quit;



H="Merge HRS interview datasets, get n1, n2, restr, exit, mc xw"
/*merges the restricted/exit/xwalk dataset with the n1, n2 and n3 core datasets
resulting dataset is saved as
oop_int.r_x_r_n1_n2
*/

/*First rename variables*/

%rename2(WORK,RESP_DEM_CORE_N1,_n1,);
%rename2(WORK,RESP_DEM_CORE_N2,_n2,);
%rename2(WORK,RESP_CORE_N3,_n3,);

/*r's n1 core*/
data resp_core_n1_a;
set RESP_DEM_CORE_N1;
rename id_n1 = id;
run;

proc sort data=resp_core_n1_a nodupkey;
by id;
run;

/*r's n2 core*/
data resp_core_n2_a;
set RESP_DEM_CORE_N2;
rename id_n2 = id; 
run;

proc sort data=resp_core_n2_a nodupkey;
by id;
run;

/*r's n3 core*/
data resp_core_n3_a;
set RESP_CORE_N3;
rename id_n3 = id; 
run;

proc sort data=resp_core_n3_a nodupkey;
by id;
run;

/*merge datasets*/
/*Merge r's interviews with exit/restricted dataset*/
/*Sort r's exit and restricted dataset including r and s xwalk ids*/
proc sort data=oop_int.exit_restricted_02_to_10_v1 out=r_ex_restr;
by id;
run;

data oop_int.r_x_r_n1_n2;
merge r_ex_restr resp_core_n1_a resp_core_n2_a resp_core_n3_a;
by id;
run;


H="Set up denominator file data, check vs interview dataset, keep age ge 67 at death"
/************************************************************************
Use merged Medicare denominator file 2000-2010,
Merged and initial cleaning done in file HRS_2010_MC_claims.txt saved
saved under general HRS processing directory
************************************************************************/

proc sort data=medi.dn_2000_2010 out=dn_2000_20102  nodupkey;
by BID year;
run;

*Last (latest year) entry in denominator file;
data dn_last_year;
set dn_2000_20102(rename=bid=bid_hrs);
by BID_hrs year;
if last.BID_hrs then output;
run;

*Frequency table from denominator file of last entries;
*11,000+ obs in 2010 for last year, because those are people who don't have a death date;
proc freq data=dn_last_year;
table death_year year;
run;

/*5764 meet the age >=67
create table of observations 67 or older of age when died per the restricted dataset*/
proc sql;
create table oop_re_age_ge67 as
select * from oop_int.exit_restricted_02_to_10_v1
where age_at_death_e>=67;
quit;

proc freq;
table xwalk_yes;
run;

/*5375 ids of 5764 have the cross walk ids.*/
*create table of observations that have died that have xwalk id;
data oop_age_ge67_in_mc ;
set oop_re_age_ge67 ;
if xwalk_yes=1;
if age_at_death_e>=70 then age_ge_70=1;
if age_at_death_e<70 and age_at_death_e~=. then age_ge_70=0;
run;

*frequency of merged_year variable from oop_re_age_ge67_in_mc above;
proc freq;
table exit_year_x age_ge_70;
run;

/*get a dataset with just decedents exit year, death_year, death date and ids
Limited to those with xwalk id and age 67+ at death*/
data oop_int.oop_sample;
set oop_age_ge67_in_mc ;
keep id bid_hrs exit_year_x death_year_e death_date_e;
run;

H="Check to see if medicare and no hmo for 2 and 5 yrs before death"
/***********************************************************
************************************************************
Determine which observations get dropped from sample because they either 
(a) don't have medicare the whole 24 months before death or 
(b) have HMO sometime in the last 24 months before death

Save to datasets:
oop_int.meet_criteria_2yr, insurance status variables only, this also has the 5 year variables
oop_int.interviews_ffs_mc_2yr, interviews (x, e, n1, n2, n3) of those decedents
	with ffs medicare the last 2 years of life
************************************************************
***********************************************************/

/*new table adding mc monthly buyin and hmo status to hrs file w/ xwalk id added, 
for year of death per hrs
Count observations in denominator file with death year: 5192*/
proc sql;
create table dn_death_y as select
a.*,b.buyin12,b.year,b.HMOIND12,b.bid_n
from oop_int.oop_sample a inner join
dn_2000_20102 b
on trim(left(a.BID_hrs))=trim(left(b.BID_HRS_19))
and a.death_year_e=b.year;
quit;

proc freq data=dn_death_y;
table death_year_e;
run;
proc sql;
select count(distinct bid_n) from dn_death_y;
quit;

/*Since look back is 2 years, create table of observations with death year is 2002 and later: 4477 observations left*/
proc sql;
create table dn_death_y_02 as
select * from dn_death_y 
where death_year_e>2001 ;
quit;

/*note death month should from restricted file
This trims the buyin12 and hmo12 variables to only have values
entered prior to the patient's death using the death date from HRS*/
data dn_death_y2;
set dn_death_y_02;
death_month_e=month(death_date_e);
if length(trim(left(buyin12)))=12 and death_month_e>0 then do;
buyin_dy=substr(trim(left(buyin12)),1,death_month_e);
hmo_dy=substr(trim(left(HMOIND12)),1,death_month_e);
end;
else do;
buyin_dy=trim(left(buyin12));
hmo_dy=trim(left(HMOIND12));
end;
run;

*all observations have death month;
proc means n;
var death_month_e;
run;
*freq table of death month;
proc freq data=dn_death_y2;
table death_month_e;
run;

/*Now match dn files from 1 year before death
Matches hrs entry for year died with the previous year's mc denominator file, 
pulling in buy in and hmo indicator
to determine mc elgible throughout study time period*/
proc sql;
create table dn_death_y_1bef as select
a.*,
b.year as death_year_l1,
b.buyin12 as buyin12_l1,
b.HMOIND12 as HMOIND12_l1
from dn_death_y2 a inner join
dn_2000_20102 b
on trim(left(a.BID_hrs))=trim(left(b.BID_hrs_19))
and 0<a.year-b.year<=1 order by a.bid_n,year;
quit;

/*Now match dn files from 2 years before death
Matches hrs entry for year died with the previous year's mc denominator file, pulling in buy in and hmo indicator
to determine mc elgible throughout study time period
Use _l2 to denote year prior to death (death year less 2)
3 observations do not have 2 year before denominator file*/
proc sql;
create table dn_death_y_2bef as select
a.*,
b.year as death_year_l2,
b.buyin12 as buyin12_l2,
b.HMOIND12 as HMOIND12_l2
from dn_death_y_1bef a inner join
dn_2000_20102 b
on trim(left(a.BID_hrs))=trim(left(b.BID_hrs_19))
and 1<a.year-b.year<=2 order by a.bid_n,year;
quit;

/*Now match dn files from 3 years before death
Matches hrs entry for year died with the previous year's mc denominator file, pulling in buy in and hmo indicator
to determine mc elgible throughout study time period
Use _l3 to denote 3 years prior to death (death year less 3)
694 observations don't have _l3 denominator file*/
proc sql;
create table dn_death_y_3bef as select
a.*,
b.year as death_year_l3,
b.buyin12 as buyin12_l3,
b.HMOIND12 as HMOIND12_l3
from dn_death_y_2bef a inner join
dn_2000_20102 b
on trim(left(a.BID_hrs))=trim(left(b.BID_hrs_19))
and 2<a.year-b.year<=3 order by a.bid_n,year;
quit;

/*Now match dn files from 4 years before death
Matches hrs entry for year died with the previous year's mc denominator file, pulling in buy in and hmo indicator
to determine mc elgible throughout study time period
Use _l3 to denote 3 years prior to death (death year less 2)
Lose 551 observations: 3429*/
proc sql;
create table dn_death_y_4bef as select
a.*,
b.year as death_year_l4,
b.buyin12 as buyin12_l4,
b.HMOIND12 as HMOIND12_l4
from dn_death_y_3bef a inner join
dn_2000_20102 b
on trim(left(a.BID_hrs))=trim(left(b.BID_hrs_19))
and 3<a.year-b.year<=4 order by a.bid_n,year;
quit;

/*Finally, match dn files from 5 years before death
Matches hrs entry for year died with the previous year's mc denominator file, pulling in buy in and hmo indicator
to determine mc elgible throughout study time period
Use _l5 to denote 5 years prior to death (death year less 5)
557 obs don't have l5 denominator entry n=2872*/
proc sql;
create table dn_death_y_5bef as select
a.*,
b.year as death_year_l5,
b.buyin12 as buyin12_l5,
b.HMOIND12 as HMOIND12_l5
from dn_death_y_4bef a inner join
dn_2000_20102 b
on trim(left(a.BID_hrs))=trim(left(b.BID_hrs_19))
and 4<a.year-b.year<=5 order by a.bid_n,year;
quit;

/**************************************************/
/**************************************************/
/*create variables that have entries for full 24m and 60m pre-death for buyin and hmo variables by combining death year and years prior to death*/
data all_insurance_24m;
set dn_death_y_2bef;

*merge individual year variables into single variable;
buyin_24_l=trim(left(buyin12_l2))||trim(left(buyin12_l1))||trim(left(buyin_dy));
hmo_24_l=trim(left(hmoind12_l2))||trim(left(hmoind12_l1))||trim(left(hmo_dy));
buylength=length(buyin_24_l);
hlength=length(hmo_24_l);

*trim so merged variable is 24 char long to reflect months before death;
buyin_24_lr=reverse(trim(buyin_24_l));
hmo_24_lr=reverse(trim(hmo_24_l));

buyin_24r=substr(trim(left(buyin_24_lr)),1,24);
hmo_24r=substr(trim(left(hmo_24_lr)),1,24);

buyin_24=reverse(trim(buyin_24r));
hmo_24=reverse(trim(hmo_24r));

buylength2_24=length(buyin_24);
hlength2_24=length(hmo_24);

*create indicator variable for mc coverage 0=no, 1=yes;
if length(buyin_24)=24 then do;
if indexc(buyin_24,"0","1","2","A","B") then part_ab_2y=0;
if indexc(buyin_24,"0","1","2","A","B")=0 then part_ab_2y=1;
end;

*create indicator variable for hmo coverage 0=no, 1=yes;
if length(hmo_24)=24 then do;
if index(hmo_24,"000000000000000000000000") then hmo_2y=0;
if index(hmo_24,"000000000000000000000000")=0 then hmo_2y=1;
end;
run;

proc freq data=all_insurance_24m; table part_ab_2y*hmo_2y; run;

data all_insurance_60m;
set dn_death_y_5bef;

*merge individual year variables into single variable;
buyin_60_l=trim(left(buyin12_l5))||trim(left(buyin12_l4))||trim(left(buyin12_l3))||trim(left(buyin12_l2))||trim(left(buyin12_l1))||trim(left(buyin_dy));
hmo_60_l=trim(left(hmoind12_l5))||trim(left(hmoind12_l4))||trim(left(hmoind12_l3))||trim(left(hmoind12_l2))||trim(left(hmoind12_l1))||trim(left(hmo_dy));
buylength=length(buyin_60_l);
hlength=length(hmo_60_l);

*trim so merged variable is 24 or 60 char long to reflect months before death;
buyin_60_lr=reverse(trim(buyin_60_l));
hmo_60_lr=reverse(trim(hmo_60_l));

buyin_60r=substr(trim(left(buyin_60_lr)),1,60);
hmo_60r=substr(trim(left(hmo_60_lr)),1,60);

buyin_60=reverse(trim(buyin_60r));
hmo_60=reverse(trim(hmo_60r));

buylength2_60=length(buyin_60);
hlength2_60=length(hmo_60);


*create indicator variable for mc coverage 0=no, 1=yes;
if length(buyin_60)=60 then do;
if indexc(buyin_60,"0","1","2","A","B") then part_ab_5y=0;
if indexc(buyin_60,"0","1","2","A","B")=0 then part_ab_5y=1;
end;

*create indicator variable for hmo coverage 0=no, 1=yes;
if length(hmo_60)=60 then do;
if index(hmo_60,"000000000000000000000000000000000000000000000000000000000000") then hmo_5y=0;
if index(hmo_60,"000000000000000000000000000000000000000000000000000000000000")=0 then hmo_5y=1;
end;
run;

proc freq data=all_insurance_60m; table part_ab_5y*hmo_5y; run;

/*merge the 2 year and 5 year indicators into a single dataset
Save insurance information to merge with main interview dataset*/
proc sql;
create table oop_int.all_insurance as select
a.id,a.bid_hrs,a.death_year_e,a.death_date_e,a.part_ab_2y,a.hmo_2y,a.hmo_24,a.buyin_24,b.part_ab_5y,b.hmo_5y from
all_insurance_24m a left join
all_insurance_60m b
on a.id=b.id;
quit;


proc freq;
table death_year_e*hmo_2y death_year_e*hmo_5y;
run;

proc freq;
table death_year_e*part_ab_2y death_year_e*part_ab_5y;
run;

proc freq;
table part_ab_2y*hmo_2y part_ab_5y*hmo_5y;
run;


proc sql outobs=100;
select hmo_24,buyin_24,count(*) from oop_int.all_insurance
where  part_ab_2y=1 and hmo_2y=0;
quit;

proc means n;
var hmo_2y part_ab_2y hmo_5y part_ab_5y;
run;

/*3330 of the 4474 observations meet the mc parts a and b coverage and no hmo criteria
Save this as a permanent dataset*/
*create table of observations meeting mc and no hmo requirement;
/***********************************************************************/
/*Need to add the interview info into this table from the oop dataset
want to include nh_nights, curr_iw_date, prev_iw_date, months, md_cov private_ltc 
/***********************************************************************/
proc sql;
create table oop_int.meet_criteria_2yr(drop=hmo_24 buyin_24) as
select * from oop_int.all_insurance
where part_ab_2y=1 and hmo_2y=0;
quit;

/*get count of subsample that also meets 5 year criteria *1923, 57.7%*/
proc sql;
select count(distinct id) from oop_int.meet_criteria_2yr
where part_ab_5y=1 and hmo_5y=0;
quit;

/***********************************************************************/
/*Get an interview dataset that is just observations with ffs medicare
2 years prior to death */
/***********************************************************************/
proc sql;
create table oop_int.interviews_ffs_mc_2yr 
as select * from oop_int.r_x_r_n1_n2 
where id in (select id from oop_int.meet_criteria_2yr);
quit;


H="Report on how to get final sample size"
/*report on how to get to final sample size
Requirements are:
1. age at death => 67
2. have xwalk id
3. have medicare parts a and b for 34 months prior to death
4. do not have hmo coverage for 34 months prior to death*/

ods rtf body ="E:\data\hrs_oop_2010\logs\oop_N_ids_eligible.rtf";
proc sql;
title "Number of decedents 2002-2010 exit interview dataset";
select count(*) from oop_int.exit_restricted_02_to_10_v1;

*age requirement;
title "meet age>=67";
select count(*) from oop_int.exit_restricted_02_to_10_v1
where age_at_death_e>=67;

*mc xwalk id requirement;
title "have the corresponding cross walk bid-hrsid";
select count(*) from oop_int.exit_restricted_02_to_10_v1 
where (xwalk_yes=1 and age_at_death_e>=67);

*death date Jan 1 2002 and later to get full 24 month mc claims information;
title "those who died on or after 01/01/2002 since the earliest available cms data is 2000";
select count(*) from dn_death_y 
where death_year_e>2001 ;

*have insurance information for last 24 months of life;
title "have dn information on last 24 months insurance ";
select count(*) from oop_int.all_insurance;
title "those with hmo in the last 24 months";
select count(*) from oop_int.all_insurance where hmo_2y=1 ;
title "those with no hmo without part a and part b in the whole last 24 months";
select count(*) from oop_int.all_insurance where hmo_2y<1 and part_ab_2y<=0 ;

title "final N, 4474-986-158=3330";
select count(*) from oop_int.meet_criteria_2yr; 

title "number of N that also meet 5 year insurance criteria";
select count(*) from oop_int.meet_criteria_2yr
where hmo_5y=0 and part_ab_5y=1;
quit;

ods rtf close;


H="Initial set up of OOP dataset (create id, drop unneeded vars)"
/*brings oop dataset into sas
Creates id variable
Drops variables not needed*/

libname oop_src "E:\data\hrs_oop_2010\received_data";
libname oop_int "E:\data\hrs_oop_2010\int_data";
libname hrs_cln 'E:\data\hrs_cleaned';

proc import datafile="E:\data\hrs_oop_2010\received_data\oopme_final_oldv.dta"  
out=oop_1 replace; 
run;

/*only keep years 1998 and later since those are the years in our core dataset*/
data oop_int.oop_2 (keep=id year curr_iw_date prev_iw_date months total_OOP hospital_OOP NH_OOP 
doctor_OOP dental_OOP patient_OOP hospice_OOP RX_OOP home_OOP special_OOP non_med_OOP helper_OOP 
insurance_costs sr_nh_nights md_cov iwtype numpaidhelpers numhelpers);
set oop_1;
if year>=1998;
length id $9 hhid $6 pn $3;
id=hhid||pn;
rename NH_NIGHTS = sr_nh_nights;

array list total_OOP hospital_OOP NH_OOP 
doctor_OOP dental_OOP patient_OOP hospice_OOP RX_OOP home_OOP special_OOP non_med_OOP helper_OOP 
insurance_costs sr_nh_nights;
do over list;
if list=. then list=0;
end;
run;

proc freq; table year; run;

/*helper dataset*/
proc import datafile="E:\data\hrs_oop_2010\received_data\helper_hours_oldv.dta"  
out=helper_1 replace; 
run;

/*helper dataset 2000-2010*/
proc freq; table year; run;

data oop_int.helper_2;
set helper_1;
length id $9 hhid $6 pn $3;
id=hhid||pn;
run;

proc sort data=oop_int.oop_2; by id year; run;
proc sort data=oop_int.helper_2; by id year; run;

proc sql;
create table oop_helper_1(drop=id2 year2) as select * from
oop_int.oop_2 a left join
oop_int.helper_2(rename=(id=id2) rename=(year=year2)) b
on a.id=b.id2 and a.year=b.year2;
quit;

data oop_int.oop_helper;
set oop_helper_1;

if hhid='' then do;
helper_missing_yes=1;
end;
else helper_missing_yes=0;
label helper_missing_yes='Indicator for no entry in helper dataset';

/*replace missing helper info with 0*/
array list_hlp hlphrs hlphrs_p hlphrs_s hlphrs_e hlphrs_u hlphrs_d hlphrs_m 
n_hp n_p n_s n_e n_u n_d n_m ;
do over list_hlp;
if list_hlp=. then list_hlp=0;
end;

run;

proc freq; table helper_missing_yes*iwtype; run;


H="Accounting for missing nh nights, part 1"
/*There are nursing home nights self reported in the interviews
that don't have expenses accounted for in either the OOP spending or
the Medicare claims. So method to account for them:

1. Use self reported nursing home nights from oop dataset
2. Determine nursing home nights from claims for each interview
	2.a Determine nursing home nights paid by medicare and also total nights
		reported in the claims
3. Use either SR nights or Medicare nights, whichever is greater
4. If there are nights not in the claims, assign a price per night and divide
	oop nh spending / price to get #oop paid nights
	4.a Price per night is either medicaid price if R reports having
		Medicaid coverage in the interview or private price if no Medicaid
		is reported
5. If there are remaining nights not medicare or OOP, assign a price to get
	additonal spending - either Medicaid or private payer spending

/*list of decedents with mc id, for those with ffs mc last 2 years of life*/
data exit_nh_1;
set oop_int.interviews_ffs_mc_2yr;
keep id bid_hrs exit_year_x death_date_e ;
run;

proc sort data=exit_nh_1 out=exit_nh_2 nodupkey; by id; run;

/*get interview dates, nh use, md coverage variables from oop dataset*/
proc sort data=oop_int.oop_helper nodupkey; by id curr_iw_date; run;

/*drop oop interview data for those without ffs medicare*/
proc sql;
create table oop_meet_2 as select * from oop_int.oop_helper
where id in (select id from exit_nh_1);
quit;

proc sort data=oop_meet_2 ; by id curr_iw_date; run;

proc sql;
create table oop_bid_dec_1(drop=id2) as select * from
oop_meet_2 a left join
exit_nh_2(rename=(id=id2)) b 
on a.id=b.id2;
quit;

proc freq data=oop_bid_dec_1; table exit_year_x; run;

proc sort data=oop_bid_dec_1; by id year; run;

proc sql; select count(unique id) from oop_bid_dec_1; quit;

/*****************************************************************/
/*Get actual interview dates from core and restricted datasets
interview dates in oop dataset are just by month*/
/*****************************************************************/

/*get interview dates from core datasets, ultimately from restricted data*/
data core_dates;
set hrs_cln.core_00_to_10;
keep id core_year c_ivw_date c_ivw_year c_ivw_month c_ivw_day ;
rename core_year=year;
rename c_ivw_date=ivw_date_e;
rename c_ivw_year=ivw_year_e;
rename c_ivw_month=ivw_month_e;
rename c_ivw_day=ivw_day_e;
run;

/*use dod=exit interview date to match oop dataset*/
data exit_dates;
set oop_int.exit_restricted_02_to_10_v1;
keep id exit_year_x death_date_e ;
rename exit_year_x=year;
rename death_date_e=ivw_date_e;
run;

data ivw_dates;
set core_dates exit_dates;
label year="Wave year"
ivw_date_e="Interview date, from restricted"
ivw_year_e="Interview year, restricted"
ivw_month_e="Interview month, restricted"
ivw_day_e="Interview day, restricted";
run;

proc sort data=ivw_dates; by id year;
run;

data ivw_dates_2;
set ivw_dates;
by id;
prev_ivw_date_e=lag(ivw_date_e);
label prev_ivw_date_e="Previous interview date";
if first.id then prev_ivw_date_e=.;
format prev_ivw_date_e date9.;
run;

/*****************************************************************/
/*Merge interview dates into oop interview dataset*/
/*****************************************************************/
proc sql;
create table oop_bid_dec_3 as select a.*,b.ivw_date_e,b.prev_ivw_date_e from
oop_bid_dec_1 a left join
ivw_dates_2 b
on a.id=b.id and a.year=b.year;
quit;

/*only keep interviews within 5 years of death date*/
data oop_bid_dec_4;
set oop_bid_dec_3;
if death_date_e-(365.25*5)<=ivw_date_e and ivw_date_e~=.;
format death_date_e date9.;
run;

/*if previous interview date is missing, b/c not in my dataset, assign to be x months
before current interview to match the oop dataset*/
data oop_bid_dec_5;
set oop_bid_dec_4;
prev_ivw_date_e_imp=0;
if prev_ivw_date_e=. then do;
	 prev_ivw_date_e=ivw_date_e-(months*30.5);
	prev_ivw_date_e_imp=1;
end;
label prev_ivw_date_e_imp="Imputed previous interview date, not in restricted ds";
run;
proc freq; table prev_ivw_date_e_imp; run;

/*****************************************************************/
/*Get SNF nights from claims, between interview dates*/
/*****************************************************************/

/*get snf claims only from full medpar dataset*/
data snf_2000_2010;
set medi.mp_2000_2010(where=(trim(left(SSLSSNF))="N"));
run;

/*identify claims where entire claim is within the interview window*/
proc sql;
create table snf_meet as select a.*,b.ivw_date_e,b.prev_ivw_date_e
from snf_2000_2010 a inner join
oop_bid_dec_5 b
on trim(left(a.BID_HRS_19))=trim(left(b.BID_hrs))
and b.prev_ivw_date_e<=a.admit_date and a.disch_date<=b.ivw_date_e;
quit;

/*identify claims that start before the previous interview 
but go into the interview window per the discharge date*/
proc sql;
create table snf_meet2 as select a.*,b.ivw_date_e,b.prev_ivw_date_e
from snf_2000_2010 a inner join
oop_bid_dec_5 b
on trim(left(a.BID_HRS_19))=trim(left(b.BID_hrs))
and a.admit_date<b.prev_ivw_date_e and a.disch_date>b.prev_ivw_date_e ;
quit;

/*Create indicators for admit , discharge dates to be manually reset
No claims span both the current and previous interview dates!*/
data snf_meet3;
set snf_meet2;
admit_trunc=1;
disch_trunc=0;
if disch_date>ivw_date_e then disch_trunc=1;
label admit_trunc="admit outside interview window = yes";
label disch_trunc="disch outside interview window = yes";
run;

proc freq; table admit_trunc disch_trunc; run;

/*identify claims that start after the previous interview
but go past the current interview date*/
proc sql;
create table snf_meet4 as select a.*,b.prev_ivw_date_e,b.ivw_date_e
from snf_2000_2010 a inner join
oop_bid_dec_5 b
on trim(left(a.BID_HRS_19))=trim(left(b.BID_hrs))
and (b.prev_ivw_date_e<=a.admit_date) and (b.ivw_date_e<a.disch_date) 
and (a.admit_date<b.ivw_date_e);
quit;

data snf_meet5;
set snf_meet4;
disch_trunc=1;
run;

/*merge the three snf claims lists into single dataset
and determine mc paid days within window for each claim*/
data snf_all;
set snf_meet snf_meet3 snf_meet5;
if admit_trunc=. then admit_trunc=0;
if disch_trunc=. then disch_trunc=0;
if admit_trunc=0 and disch_trunc=0 then do;
	snf_days_mc_paid=util_day;
	total_snf_los=LOSCNT;
	end;
if admit_trunc=1 and disch_trunc=0 then do;
	mc_paid_thru_dt=admit_date+util_day;
	total_snf_los=LOSCNT-(prev_ivw_date_e-admit_date);
	if prev_ivw_date_e=mc_paid_thru_dt then total_snf_los=1;
	if mc_paid_thru_dt < prev_ivw_date_e then do;
		snf_days_mc_paid=0;
		end;
	if mc_paid_thru_dt > prev_ivw_date_e then do;
		snf_days_mc_paid= mc_paid_thru_dt - prev_ivw_date_e;
		end;
	if mc_paid_thru_dt = prev_ivw_date_e then do;
		snf_days_mc_paid=1;
		end;
	end;
if admit_trunc=0 and disch_trunc=1 then do;
	mc_paid_thru_dt=admit_date+util_day;
	total_snf_los=LOSCNT-(disch_date-ivw_date_e);
	if prev_ivw_date_e=mc_paid_thru_dt then total_snf_los=1;
	if mc_paid_thru_dt < ivw_date_e then do;
		snf_days_mc_paid=util_day;
		end;
	if mc_paid_thru_dt >= ivw_date_e then do;
		snf_days_mc_paid= ivw_date_e - admit_date;
		end;
	end;
format mc_paid_thru_dt date10.;
label mc_paid_thru_dt="Medicaid covered through this date";
label total_snf_los="Total claim SNF LOS";
label snf_days_mc_paid="Claim days paid for by Medicare";

if total_snf_los=snf_days_mc_paid then mc_full=1;
if total_snf_los>snf_days_mc_paid then mc_full=0;
label mc_full="Indicator that stay fully paid for by MC";

run;

proc freq; table admit_trunc disch_trunc total_snf_los snf_days_mc_paid mc_full;
run;

proc means; var total_snf_los snf_days_mc_paid; run;

/*sum over all claims by interview window*/
proc sort data=snf_all; by bid_hrs_19 ivw_date_e; run;

proc sql;
create table snf_ivw as select distinct bid_hrs_19, ivw_date_e,
sum(total_snf_los) as snf_stay_all_ivw ,
sum(snf_days_mc_paid) as los_snf_paid_by_mc_ivw ,
sum(util_day) as tot_util_days_ivw
from snf_all group by bid_hrs_19 , ivw_date_e;
quit;

proc means; var snf_stay_all_ivw los_snf_paid_by_mc_ivw tot_util_days_ivw; run;

/************************************************************/
/*merge snf nights data with the oop dataset*/
/************************************************************/
proc sort data=oop_bid_dec_5; by bid_hrs ivw_date_e; run;

proc sort data=snf_ivw ; by bid_hrs_19 ivw_date_e; run;

proc sql;
create table oop_bid_dec_nh(drop=ivw_date_e2 bid_hrs_19) as select * from
oop_bid_dec_5 a left join
snf_ivw(rename=(ivw_date_e=ivw_date_e2)) b 
on a.bid_hrs=b.bid_hrs_19 and a.ivw_date_e=b.ivw_date_e2;
quit;

proc sql; select count( distinct id) from oop_bid_dec_nh ; quit;

data oop_bid_dec_nh_2;
set oop_bid_dec_nh;
if snf_stay_all_ivw =. then snf_stay_all_ivw =0;
if los_snf_paid_by_mc_ivw =. then los_snf_paid_by_mc_ivw =0;
if tot_util_days_ivw = . then tot_util_days_ivw=0;
run;

ods rtf body="E:\data\hrs_oop_2010\logs\nh_by_ivw_dataset.rtf";
title "OOP+Medicare snf nights, those obs with ffs medicare last 2 years of life, obs at interview level";
proc contents data=oop_bid_dec_nh_2;
run;

proc sql; select count(distinct id) from oop_bid_dec_nh_2; quit;

proc means; var snf_stay_all_ivw los_snf_paid_by_mc_ivw ; run;

ods rtf close;

/************************************************************/
/*Determine total nh nights during the time from the previous
interview to the current interview (multiple rows per R)*/
/************************************************************/
data oop_int.oop_bid_dec_nh_3;
set oop_bid_dec_nh_2;
if sr_nh_nights=. then sr_nh_nights=0;
label sr_nh_nights="Self reported nh nights, from interview";
if sr_nh_nights>=snf_stay_all_ivw then nh_nights=sr_nh_nights;
else nh_nights=snf_stay_all_ivw;
label nh_nights="NH nights, source=self report or claims";
label los_snf_paid_by_mc_ivw="NH nights, paid by Medicare";

nh_ni_not_mc = 0;
if (nh_nights - los_snf_paid_by_mc_ivw)>0 then 
	nh_ni_not_mc=(nh_nights - los_snf_paid_by_mc_ivw); 
label nh_ni_not_mc="NH Nights not paid by Medicare";

if nh_ni_not_mc=0 then nh_pmt_imp=0;
if nh_ni_not_mc~=0 then nh_pmt_imp=1;
label nh_pmt_imp="Nursing home payments imputed = yes";

run;

proc means; var nh_nights sr_nh_nights los_snf_paid_by_mc_ivw nh_ni_not_mc nh_pmt_imp; run;


H="Missing nh nights, part 2, assign prices"
/*This section pulls in 3 sets of prices:
1. Private nursing home nightly rate from MetLife survey
2. Medicaid nursing home nightly rate from various sources
3. Private home health aide from MetLife 

pull in Private nursing home nightly rate

Note: Have to run the code in previous 2 heading sections (starting with Initial
set up of OOP dataset...) prior to running this because of formats from the 
oop dataset in Stata, if skip those steps, get error that formats are missing
for a few of the variables when run in SAS*/

proc import 
datafile='E:\data\hrs_oop_2010\ref_data\nh_costs_by_state\from_mmi_2010_nh_cost_by_state.xls'
out=private_nh_rate dbms=xls replace;
run;

/*proc import datafile='H:\OOP\data\nh_costs_by_state\from_mmi_2010_nh_cost_by_state.xls'
out=private_nh_rate dbms=xls replace;
run;
*/

/*keep overall state average price, drop those for metro areas*/
data private_nh_rate_1;
set private_nh_rate;
if state_usps_code~=' ';
run;

data private_nh_rate_2(keep=state_usps_code avg_private_rm_rate avg_semi_rm_rate);
set private_nh_rate_1(rename=(i=priv_rate f=semi_rate));
format priv_rate 3.;
format semi_rate 3.;
avg_private_rm_rate=priv_rate+0;
avg_semi_rm_rate=semi_rate+0;

label avg_private_rm_rate='Private room avg rate';
label avg_semi_rm_rate='Semi-private room avg rate';

run;

proc sort data=private_nh_rate_2; by state_usps_code; run;

/*get Medicaid nursing home nightly rate*/
proc import 
datafile='E:\data\hrs_oop_2010\ref_data\nh_costs_by_state\medicaid_to_import.xls'
out=medicaid_nh_rate dbms=xls replace;
run;


/*proc import datafile='H:\OOP\data\nh_costs_by_state\medicaid_to_import.xls'
out=medicaid_nh_rate dbms=xls replace;
run;*/

/*convert for inflation 2010 dollars
Uses CPI for Medical Services from 
BLS website, accessed 3/14/2014*/
data medicaid_nh_rate_1;
set medicaid_nh_rate(drop=_2010_cost _2010_difference);
if Year>=2010 then medicaid_rate=1*rate_per_night;
if year=2009 then medicaid_rate=1.0350*rate_per_night;
if year=2008 then medicaid_rate=1.06823*rate_per_night;
if year=2007 then medicaid_rate=1.11347*rate_per_night;
if year=2006 then medicaid_rate=1.17287*rate_per_night;
if year=2005 then medicaid_rate=1.22119*rate_per_night;
if year=2004 then medicaid_rate=1.27983*rate_per_night;
if year=2003 then medicaid_rate=1.34381*rate_per_night;
if year=2002 then medicaid_rate=1.40392*rate_per_night;
if year=2001 then medicaid_rate=1.47492*rate_per_night;
if year=2000 then medicaid_rate=1.54589*rate_per_night;
if year<=1999 then medicaid_rate=1.61195*rate_per_night;
label medicaid_rate='Medicaid rate per night, adj to 2010 prices';
run;

proc sort data=medicaid_nh_rate_1; by usps_code; run;

/*merge the two price lists into a single dataset*/
proc sql;
create table nh_rates as select a.*,b.medicaid_rate from
private_nh_rate_2 a left join
medicaid_nh_rate_1 b
on a.state_usps_code=b.usps_code;
quit;

/*get private home health aide rate, from MetLife Survey, 2010*/

proc import 
datafile='E:\data\hrs_oop_2010\ref_data\nh_costs_by_state\from_mmi_2010_hhaide_cost_by_state.xls'
out=hhaide_rate dbms=xls replace;
run;

data hhaide_rate_1;
set hhaide_rate;
if state_usps_code~=' ';
run;

data hhaide_rate_2(keep=state_usps_code avg_hh_aide_rate );
set hhaide_rate_1;
format HHAIDE_AVG 3.;
avg_hh_aide_rate=HHAIDE_AVG+0;

label avg_hh_aide_rate='Home health aide avg rate per hour';

run;

proc sort data=hhaide_rate_2; by state_usps_code; run;

/*merge with the nursing home price lists*/
proc sql;
create table nh_hh_rates as select a.*,b.avg_hh_aide_rate from
nh_rates a left join
hhaide_rate_2 b
on a.state_usps_code=b.state_usps_code;
quit;

/******************************************************/
/*Get state of residence for each interview time period,
from restricted dataset*/
/******************************************************/
/*merge all waves, state of residence variables*/
proc sort data=oop_int.oop_bid_dec_nh_3 out=oop_bid_dec_nh_3; by id year; run;

data state_res;
set oop_int.exit_restricted_02_to_10_v1;
keep id stateusps: ;
run;

/*get list of first and last interview years, from oop dataset*/
data ivw_years_1;
set oop_bid_dec_nh_3;
by id; 
if first.id then first_ivw_year=year;
if last.id then last_ivw_year=year;
run;

data ivw_years_1a;
set ivw_years_1;
if first_ivw_year~=.;
run;

data ivw_years_1b;
set ivw_years_1;
if last_ivw_year~=.;
run;

proc sql;
create table ivw_years_2 as select a.id,a.first_ivw_year,b.last_ivw_year
from ivw_years_1a a left join
ivw_years_1b b
on a.id=b.id;
run;

proc freq; table first_ivw_year last_ivw_year; run;

/*merge into dataset with state residence variables added
note only merges in interview years for those with ffs medicare 2 years prior to death*/
proc sql;
create table state_res_2 as select
a.*, b.first_ivw_year,b.last_ivw_year from
state_res a left join
ivw_years_2 b
on a.id=b.id;
run;

proc freq; table first_ivw_year last_ivw_year; run;

/*clean up missing state variables
1. if missing, use interview prior
2. if still missing, use interview after
3. if still missing, use interview 2x prior...*/

data state_res_3;
set state_res_2;
/*1998 updates, use 2000 state*/
if (stateusps98_e='ZZ' | stateusps98_e='' ) & first_ivw_year<=1998<=last_ivw_year then do;
	state_98_imp_yes=1;
	stateusps98_e=stateusps00_e;
	end;
/*2000 updates, use 1998 state*/
if (stateusps00_e='ZZ' | stateusps00_e='' ) & first_ivw_year<=2000<=last_ivw_year then do;
	state_00_imp_yes=1;
	stateusps00_e=stateusps98_e;
	end;
/*2002 updates, use 2000 or 2004 state*/
if (stateusps02_e='ZZ' | stateusps02_e='' ) & first_ivw_year<=2002<=last_ivw_year then do;
	state_02_imp_yes=1;
	stateusps02_e=stateusps00_e;
		if (stateusps02_e='ZZ' | stateusps02_e='' ) then do;
		stateusps02_e=stateusps04_e;
		end;
	end;
/*2004 updates, use 2002 or 2006 state*/
if (stateusps04_e='ZZ' | stateusps04_e='' ) & first_ivw_year<=2004<=last_ivw_year then do;
	state_04_imp_yes=1;
	stateusps04_e=stateusps02_e;
		if (stateusps04_e='ZZ' | stateusps04_e='' ) then do;
		stateusps04_e=stateusps06_e;
		end; /*1 obs still missing, use 1998 state for this person*/
				if (stateusps04_e='ZZ' | stateusps04_e='' ) then do;
				stateusps04_e=stateusps98_e;
				end; 
	end;
/*2006 updates, use 2004 or 2008 state*/
if (stateusps06_e='ZZ' | stateusps06_e='' ) & first_ivw_year<=2006<=last_ivw_year then do;
	state_06_imp_yes=1;
	stateusps06_e=stateusps04_e;
		if (stateusps06_e='ZZ' | stateusps06_e='' ) then do;
		stateusps06_e=stateusps08_e;
		end; /*1 obs still missing, use 1998 state for this person*/
				if (stateusps06_e='ZZ' | stateusps06_e='' ) then do;
				stateusps06_e=stateusps98_e;
				end; 
	end;
/*2008 updates, use 2006 state*/
if (stateusps08_e='ZZ' | stateusps08_e='' ) & first_ivw_year<=2008<=last_ivw_year then do;
	state_08_imp_yes=1;
	stateusps08_e=stateusps06_e;
	end;
/*2010 updates, use 2008 state*/
if (stateusps10_e='ZZ' | stateusps10_e='' ) & first_ivw_year<=2010<=last_ivw_year then do;
	state_10_imp_yes=1;
	stateusps10_e=stateusps08_e;
	end;

run;

proc freq data=state_res_3; table state_:; run;

proc sort data=state_res_3; by id; run;

/*merge in the complete state of residence dataset to the oop dataset*/
proc sql;
create table oop_add_state(drop=id2) as select * from
oop_bid_dec_nh_3 a left join
state_res_3(rename=(id=id2)) b
on a.id=b.id2;
quit;

proc freq; table year; run;


data oop_add_state_1;
set oop_add_state;
state_wave=vvaluex("stateusps"||substr(trim(left(year)),3,2)||"_e" );
run;

proc freq; table state_wave; run;

/******************************************************/
/*Merge prices in to the oop dataset by state*/
/******************************************************/
proc sql;
create table oop_add_price as select a.*,b.avg_private_rm_rate,b.medicaid_rate,b.avg_hh_aide_rate
from oop_add_state_1 a left join
nh_hh_rates b
on a.state_wave=b.state_usps_code;
quit;

proc means; var avg_private_rm_rate medicaid_rate avg_hh_aide_rate; run;

/*1 bid is missing prices b/c state of residence = Puerto Rico
Drop this R in the next step*/
data zzzmissprice; set oop_add_price; if avg_private_rm_rate=.; run;

/******************************************************/
/*Need to divide oop nh payments by rate (either medicaid or private)
and then get a number of nights, these are oop reported nights

Then any nights left get assigned to medicaid or private insurance payer*/
/******************************************************/

/******************************************************/
/*Assign missing nights prices, 
First deduct any nights accounted for with OOP spending
Then remaining nights get assigned additional costs
for the interview time period*/
/******************************************************/

proc freq data=oop_add_price ; table nh_pmt_imp*md_cov /missprint; run;

/*first get nights associated with the OOP costs reported in the interviews*/
data oop_nh_costs_1;
set oop_add_price;
if avg_private_rm_rate~=.;
/*if there are no nursing home nights that aren't paid by medicare, then set oop nights=0
If missing medicaid coverage, assume medicaid coverage and use the lower medicaid price
*/
if nh_pmt_imp=0 then oop_nh_nights=0;
/*if there are some non medicare nights and report medicaid coverage, use medicaid price*/
if nh_pmt_imp=1 and (md_cov=1 or md_cov=.) then do;
	oop_nh_nights=floor(NH_OOP/medicaid_rate);
	end;
/*if there are some non medicare nights and do not report medicaid coverage, use private price*/
if nh_pmt_imp=1 and md_cov=0 then do;
	oop_nh_nights=floor(NH_OOP/avg_private_rm_rate);
	end;
/*check calculated oop nights vs self reported nights not paid by medicare
	reset oop nights to total not medicare nights if calculated oop nights
	is higher than self report nights*/
if oop_nh_nights>nh_ni_not_mc then do;
	oop_nh_nights_adj=1;
	oop_nh_nights=nh_ni_not_mc;
	end;

/*variable for nursing home nights not covered by Medicare or OOP reported spending
	If number of nights computed for OOP is greater than the self reported nights, then set this to zero*/
if nh_ni_not_mc<=oop_nh_nights and oop_nh_nights~=. then other_nh_nights=0;
if nh_ni_not_mc>oop_nh_nights then other_nh_nights=floor(nh_ni_not_mc-oop_nh_nights);

label oop_nh_nights="Imputed nh nights paid OOP, ivw pd";
label oop_nh_nights_adj="OOP nights set to balance of self report nights-MC paid nights";
label other_nh_nights="Imputed nh nights not medicare or OOP, ivw pd";
run;	

proc freq; table oop_nh_nights oop_nh_nights_adj other_nh_nights; run;

/*look at obs that had to have oop nights adjusted down*/
data zzz_oop_nights_adj;
set oop_nh_costs_1;
if nh_pmt_imp=1;
run;

/*n=280 of 2338 had OOP nights adjusted down to be balance of non-medicare paid nights
 (total nights - snf_medicare=oop)*/
proc freq; table oop_nh_nights_adj /missprint; run;

/*now assign medicaid or private insurance payments for remaining nights*/
data oop_int.oop_nh_costs_2;
set oop_nh_costs_1;
if other_nh_nights=0 then do;
nh_cost_medicaid=0;
nh_cost_private=0;
end;

if other_nh_nights>0 then do;
	if md_cov=1 | md_cov=. then do;
		nh_cost_medicaid=other_nh_nights*medicaid_rate;
		nh_cost_private=0;
		end;
	if md_cov=0 then do;
		nh_cost_private=other_nh_nights*avg_private_rm_rate;
		nh_cost_medicaid=0;
		end;
end;

label nh_cost_medicaid="Imputed medicaid paid nh payments, ivw pd";
label nh_cost_private="Imputed private ins paid nh payments, ivw pd";

run;
	
proc means; var nh_nights nh_ni_not_mc oop_nh_nights other_nh_nights snf_stay_all_ivw ;
run;

proc means; var nh_OOP nh_cost_medicaid nh_cost_private; 
run;

proc contents; run;

data zztestnights; set  oop_int.oop_nh_costs_2; if nh_nights>730; 
nights_from_months = months*30.5;
pct_in_nh = nh_nights/nights_from_months;
run;

proc means; var pct_in_nh months; run;

H="Accounting for informal home care"
/*use private home health aide rate, from MetLife Survey, 2010
Merged into dataset in previous heading section

helper_OOP includes helpers in the n_p n_d n_m categories
so when impute informal care, should be for helpers in n_s and n_u only

Preliminary methodology:
1. Cost/month_s and _u = hours/month * hourly rate
	Capped at $15,000/month (essentially 24/hr per day care)
2. Use previous wave helper info to determine length of care
	If no helper needed the interview prior, then 4 months costs assigned
	If helper needed prior interview, then full interview
	time period helper costs are assigned
		Use 4 months at reported hours/month and then remaining months in
		ivw period are assigned mean hours/month between current and previous ivw
3. For cases where full interview costs are assigned, need to 
	revise the OOP_helper cost as well for consistency
	since original dataset caps all at 4 months
*/

proc sort data=oop_int.oop_nh_costs_2 out=hh_costs_1;
by id year;
run; 

/*get cost/month using helper hours*/
data hh_costs_2;
set hh_costs_1(keep=id months year iwtype n_s n_u numpaidhelpers hlphrs_s hlphrs_u helper_OOP avg_hh_aide_rate);
if avg_hh_aide_rate~=.;

if hlphrs_s~=. then hh_s_capped=0;
if hlphrs_u~=. then hh_u_capped=0;
if helper_OOP~=. then ind_helper_OOP_mod=0;

/*imputed costs per month for spouse and other unpaid helpers
cost/helper capped at $15000 per month, same as it was in the OOP dataset*/
hh_s_cost_per_mo=hlphrs_s*avg_hh_aide_rate;
if hh_s_cost_per_mo>15000 & hh_s_cost_per_mo~=. then do;
	hh_s_cost_per_mo=15000;
	hh_s_capped=1;
	end;
hh_u_cost_per_mo=hlphrs_u*avg_hh_aide_rate;
if hh_u_cost_per_mo>15000 & hh_u_cost_per_mo~=. then do;
	hh_u_cost_per_mo=15000;
	hh_u_capped=1;
	end;

if months>=4 then helper_OOP_per_mo=helper_OOP/4;
else helper_OOP_per_mo=helper_OOP/months;

label hh_s_cost_per_mo="Spouse helpers cost per month";
label hh_u_cost_per_mo="Other unpaid helpers cost per month";
label helper_OOP_per_mo="OOP helpers per month";

run;

proc means print nway;
class iwtype;
var hh_s_capped hh_u_capped hh_s_cost_per_mo hh_u_cost_per_mo helper_OOP_per_mo;
run;

/*get helpers, cost/month previous interview period*/
data hh_costs_3;
set hh_costs_2;

by id;
n_s_1bef=lag(n_s);
n_u_1bef=lag(n_u);
numpaidhelpers_1bef=lag(numpaidhelpers);
hh_s_cost_per_mo_1bef=lag(hh_s_cost_per_mo);
hh_u_cost_per_mo_1bef=lag(hh_u_cost_per_mo);
helper_OOP_per_mo_1bef=lag(helper_OOP_per_mo);

array list n_s_1bef n_u_1bef numpaidhelpers_1bef hh_s_cost_per_mo_1bef hh_u_cost_per_mo_1bef helper_OOP_per_mo_1bef;
do over list;
if first.id then list=.;
end;
run;

proc freq; table n_s*n_s_1bef n_u*n_u_1bef numpaidhelpers*numpaidhelpers_1bef; run;


/*Use previous interview to determine months
1. If No helper that type previous interview, do 4 months at curr ivw hours
2. If helper that type previous interview, do 4 months at curr ivw hours + 
		remaining months at mean hours between current and previous interview
This also adjusts helper_OOP imputation of >4 months is required with same methodology*/
data hh_costs_4;
set hh_costs_3;

/*if ivw period is less than 4 months, assign cost for full no. months*/
if (months<4) then do;
	hh_s_cost_ivw=hh_s_cost_per_mo*months;
	hh_u_cost_ivw=hh_u_cost_per_mo*months;
	helper_OOP_adj=helper_OOP;
	s_cost_total_mos = 1;
	u_cost_total_mos = 1;
	helper_OOP_mod=0;
	s_months_used=months;
	u_months_used=months;
	OOP_months_used=months;
	end;

/*spouse helpers*/
	else if n_s_1bef~=0 & n_s_1bef~='' then do; /*if spouse helped period before*/
		hh_s_cost_ivw=hh_s_cost_per_mo*4 + mean(hh_s_cost_per_mo,hh_s_cost_per_mo_1bef)*(months-4);
		s_cost_total_mos = 2;
		s_months_used=months;
		end;
	else do; /*if spouse did not help prev ivw, set to 4 months*/
		hh_s_cost_ivw=hh_s_cost_per_mo*4;
		s_cost_total_mos = 3;
		s_months_used= 4 ;
	end;

/*for other unpaid helpers*/
if months>=4 then do;
	if n_u_1bef~=0 & n_u_1bef~='' then do; /*if u helped period before*/
		hh_u_cost_ivw=hh_u_cost_per_mo*4 + mean(hh_u_cost_per_mo,hh_u_cost_per_mo_1bef)*(months-4);
		u_cost_total_mos = 2;
		u_months_used=months;
		end;
	else do; /*if no unpaid helpers did not help prev ivw, set to 4 months*/
		hh_u_cost_ivw=hh_u_cost_per_mo*4;
		u_cost_total_mos = 3;
		u_months_used= 4 ;
		end;
	end;

/*for paid helpers, OOP cost adjustment*/
if months>=4 then do;
	if numpaidhelpers_1bef~=0 & numpaidhelpers_1bef~='' then do; /*if paid helped period before*/
		helper_OOP_adj=helper_OOP_per_mo*4 + mean(helper_OOP_per_mo,helper_OOP_per_mo_1bef)*(months-4);
		helper_OOP_mod = 1;
		OOP_months_used=months;
		end;
	else do; /*if paid helpers did not help prev ivw, no adjustment needed, use 4 months OOP cost*/
		helper_OOP_adj=helper_OOP;
		helper_OOP_mod = 0;
		OOP_months_used = 4;
		end;
	end;

/*reset months used to 0 in cases where 0 costs assigned*/
	if hh_s_cost_ivw=0 then s_months_used=0;
	if hh_u_cost_ivw=0 then u_months_used=0;
	if helper_OOP_adj=0 then OOP_months_used=0;

label hh_s_cost_ivw="Spouse helpers cost ivw time period";
label hh_u_cost_ivw="Other unpaid helpers cost ivw time period";
label s_cost_total_mos="S cost imputed 1=lt 4mo 2=mean pd bef 3=4 mo";
label u_cost_total_mos="U cost imputed 1=lt 4mo 2=mean pd bef 3=4 mo";

label s_months_used="S helper months attributed";
label u_months_used="Other unpaid helper months attributed";
label OOP_months_used="OOP Paid helper months attributed";

label helper_OOP_adj="Adjusted Helper OOP cost";
label helper_OOP_mod="Helper OOP cost modified, 1=yes";

run;

proc freq; table s_cost_total_mos u_cost_total_mos helper_OOP_mod; run;

proc freq; table months s_months_used u_months_used OOP_months_used; run;

proc means; vars hh_s_cost_ivw hh_u_cost_ivw helper_OOP_adj helper_OOP ; run;

/*merge new variables into final dataset*/
proc sql;
create table oop_nh_hh_costs_1 as select a.*,b.hh_s_cost_ivw,b.hh_u_cost_ivw,b.helper_OOP_adj,
b.s_months_used,b.u_months_used,b.OOP_months_used,
b.s_cost_total_mos,b.u_cost_total_mos,b.helper_OOP_mod
from
oop_int.oop_nh_costs_2 a left join
hh_costs_4(rename=(id=id2) rename=(year=year2)) b
on a.id=b.id2 and a.year=b.year2;
quit;

/*recalculate total OOP and other OOP given the new helper OOP adjustement*/
data oop_int.oop_nh_hh_costs;
set oop_nh_hh_costs_1(rename=(helper_OOP=helper_OOP_old));

helper_OOP=helper_OOP_adj;

total_old=total_OOP;

total_OOP=total_old-helper_OOP_old+helper_OOP;

other_OOP=total_OOP -insurance_costs- hospital_OOP -doctor_OOP -rx_OOP- nh_OOP -helper_OOP;

drop helper_OOP_adj;
run;

proc means; 
var months hh_s_cost_ivw hh_u_cost_ivw helper_OOP helper_OOP_old total_OOP total_old other_OOP;
run;

proc freq; table s_cost_total_mos u_cost_total_mos helper_OOP_mod; run;

H="Get OOP data for exit, n1, n2 and n3 cores"
/*
Collects OOP data for decedents from exit, n1, n2, and n3 core interview imputations
Dataset is oop_int.oop_x_n1_n2_n3
*/
libname oop_int "E:\data\hrs_oop_2010\int_data";
libname hrs_cln 'E:\data\hrs_cleaned';

/*OOP dataset with added nursing home stay, costs information
This dataset is limited to those decedents with ffs medicare last 2 years of life*/

/*clean up dataset prior to adding suffix, merging*/
data oop_nh_costs_3(drop=hhid pn inx STATEUSPS: state_0: state_98_imp_yes state_10_imp_yes);
set oop_int.oop_nh_hh_costs;

if year=exit_year_x then exit_int_yes=1;
else exit_int_yes=0;
label exit_int_yes='Indicator for exit interview';

run;

proc freq; table helper_missing_yes; run;

/*only 3288 exit interviews in oop dataset*/
proc freq; table exit_int_yes; run;

proc sort data=oop_nh_costs_3 out=oop_nh_costs_4 nodupkey;
by id year;
run;

/*interview dataset is limited to those decedents with ffs medicare last 2 years
and age is 67 and older at death*/
data exit_meet_2;
set oop_int.interviews_ffs_mc_2yr;
keep id exit_year_x death_date_e;
run;

proc sort data=exit_meet_2 nodupkey;
by id exit_year_x;
run;

proc sql;
create table exit_oop(drop=id2)
as select * from 
exit_meet_2 a left join
oop_nh_costs_4(rename=(id=id2) drop=exit_year_x death_date_e) b
on a.id=b.id2 and a.exit_year_x=b.year;
quit;

/*42 decedents do not have OOP imputed data from exit interviews*/
proc freq data=exit_oop;
table year helper_missing_yes;
run;

data exit_oop_3;
set exit_oop;
run;

/*rename variable macro*/
*options macrogen mprint mlogic;
%macro rename2(lib,dsn,pre,first);
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "Before Renaming All Variables";
run;
proc sql noprint;
select nvar into :num_vars
from dictionary.tables
where libname="&LIB" and
memname="&DSN";
select distinct(name) into :var1-
:var%TRIM(%LEFT(&num_vars))
from dictionary.columns
where libname="&LIB" and
memname="&DSN" ;
quit;
run;
proc datasets library=&LIB;
modify &DSN;
rename
%do i=1 %to &num_vars;

&&var&i=&first.&&var&i.&&pre.
%end;
;
quit;
run;
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "After Renaming All Variables";
run;
%mend ;

/*rename exit oop variables with _x suffix*/
%rename2(WORK,EXIT_OOP_3,_x,);

data EXIT_OOP_4;
set EXIT_OOP_3;
rename id_x=id;
rename BID_hrs_x=bid_hrs;
run;

/***************************************************************************/
/***************************************************************************/
/*Get OOP data from n1 and n2 core interviews before death*/
/***************************************************************************/
/***************************************************************************/

proc sort data=exit_oop_4; by id curr_iw_date_x; run;
proc sort data=oop_nh_costs_4; by id curr_iw_date; run;

/*first get all OOP data for decedents for their core interviews (before the exit ivw)*/
proc sql;
create table all_c_oop_deced
as select b.* from
exit_oop_4 a inner join
oop_nh_costs_4 b
on a.id=b.id and a.curr_iw_date_x>b.curr_iw_date;
quit;

proc sort data=all_c_oop_deced;
by id curr_iw_date;
run;

/*keep the n1 core interview n=3213 interviews*/
data oop_n1;
set all_c_oop_deced;
by id curr_iw_date;
if last.id;
run;

proc freq;
table year;
run;

/*now get the n2 core interview*/
proc sql;
create table oop_n2_1
as select b.* from
oop_n1 a inner join
all_c_oop_deced b
on a.id=b.id and a.curr_iw_date>b.curr_iw_date;
quit;

proc sort data=oop_n2_1;
by id curr_iw_date;
run;

/*keep the n2 core interview n=3022*/
data oop_n2;
set oop_n2_1;
by id curr_iw_date;
if last.id;
run;

proc freq;
table year;
run;

/*now get the n3 core interview*/
proc sql;
create table oop_n3_1
as select b.* from
oop_n2 a inner join
all_c_oop_deced b
on a.id=b.id and a.curr_iw_date>b.curr_iw_date;
quit;

proc sort data=oop_n3_1;
by id curr_iw_date;
run;

/*keep the n3 core interview n=1045*/
data oop_n3;
set oop_n3_1;
by id curr_iw_date;
if last.id;
run;

proc freq;
table year;
run;


/*rename the n1-n3 oop dataset variables*/
%rename2(WORK,OOP_N1,_n1,);
%rename2(WORK,OOP_N2,_n2,);
%rename2(WORK,OOP_N3,_n3,);

data OOP_N1_2;
set OOP_N1;
rename id_n1=id;
run;

data OOP_N2_2;
set OOP_N2;
rename id_n2=id;
run;

data OOP_N3_2;
set OOP_N3;
rename id_n3=id;
run;

/*merge the 3 OOP datasets so one observation per row, exit, n1 and n2 OOP year data*/
proc sort data=EXIT_OOP_4 nodupkey;
by id;
run;

proc sort data=OOP_N1_2 nodupkey;
by id;
run;

proc sort data=OOP_N2_2 nodupkey;
by id;
run;

proc sort data=OOP_N3_2 nodupkey;
by id;
run;

proc sql;
create table oop_x_n1(drop=id2) as select * from 
exit_oop_4 a left join
oop_n1_2(rename=(id=id2)) b
on a.id=b.id2 ;
quit;

proc sql;
create table oop_x_n1_n2(drop=id2) as select * from
oop_x_n1 a left join
oop_n2_2(rename=(id=id2)) b
on a.id=b.id2 ;
quit;

proc sql;
create table oop_int.oop_x_n1_n2_n3(drop=id2) as select * from
oop_x_n1_n2 a left join
oop_n3_2(rename=(id=id2)) b
on a.id=b.id2 ;
quit;

/*********************************************************/
/*It is fine that so many are missing the n3 oop data
because they don't need to go back that far to look back
five years for the most part */
/*********************************************************/

/*42 missing exit OOP data, 117 missing n1, 308 missing n2, 2285 missing n3*/
proc freq;
table year_x year_n1 year_n2 year_n3;
run;

proc freq;
table md_cov_x md_cov_n1;
run;

/*********************************************************/
/*check missing helper information in OOP dataset
vs adl / iadl impairment, interview level check    	 */
/*********************************************************/
proc sql;
create table ivws_oop as select * from
oop_int.r_x_r_n1_n2 a left join
oop_int.oop_x_n1_n2_n3 b
on a.id=b.id;
quit;

proc freq; table ADL_INDEPENDENT_x*helper_missing_yes_x 
	ADL_INDEPENDENT_CORE_n1*helper_missing_yes_n1
	ADL_INDEPENDENT_CORE_n2*helper_missing_yes_n2; 
run;

/*most of missingness in helper files is for those
that are adl independent per their interview, this makes sense*/

H="OOP spending totals 24,60 months before death"
/*Start with dataset of OOP data exit, core n1 and n2 and n3
Adjust all OOP spending for inflation to 2010 dollars
Get totals by OOP spending type over the 24 and 60 months prior to death date

Also gets nursing home nights (self reported) over the 24 and 60m prior to death

Final dataset is oop_int.oop_24m_60m
*/

/**********************************************************************/
/**********************************************************************/
/*RG Note 5/22/14 - Per codebook, OOP spending is already adjusted for 
2010 dollars, this step is not required, commented out here
First adjust all spending for inflation to 2010 dollars
Uses CPI for Medical Services from BLS website, accessed 2/5/2014*/
/**********************************************************************/
/**********************************************************************/

/*create macro to run through all OOP variables to adjust for inflation
Adjustment already made for imputed NH costs based on Medicaid / private rates
so not done here
data adjust_oop_start;
set oop_int.oop_x_n1_n2_n3;
run;

%macro infl(wave,start);
data adjust_oop&wave.;
set adjust_oop&start.;
Array list
           NH_OOP&wave.
           RX_OOP&wave.
           dental_OOP&wave.
           doctor_OOP&wave.
           helper_OOP&wave.
           home_OOP&wave.
           hospice_OOP&wave.
           hospital_OOP&wave.
           non_med_OOP&wave.
           patient_OOP&wave.
           special_OOP&wave.
           total_OOP&wave.
	   insurance_costs&wave. 
;
Do over list;
if year&wave.=1998 then List=list*1.66616;
if year&wave.=2000 then List=list*1.54589;
if year&wave.=2002 then List=list*1.40392;
if year&wave.=2004 then List=list*1.27983;
if year&wave.=2006 then List=list*1.17287;
if year&wave.=2008 then List=list*1.06823;
end;
run;
%mend;

%infl(wave=_x,start=_start);
%infl(wave=_n1,start=_x);
%infl(wave=_n2,start=_n1);
%infl(wave=_n3,start=_n2);

final dataset is adjust_oop_n3 with all adjused for inflation
proc means data=adjust_oop_start;
var NH_OOP_x home_OOP_n1 total_OOP_n2 total_OOP_n3;
run;

proc means data=adjust_oop_n3;
var NH_OOP_x home_OOP_n1 total_OOP_n2 total_OOP_n3;
run;*/

/**********************************************************************/
/**********************************************************************/
/*Adjust RX OOP and totals
RX is capped at $300/month to mimic cap set once 
Medicare Part D was implemented*/
/**********************************************************************/
/**********************************************************************/
data adjust_rx_start;
*set adjust_oop_n3;
set oop_int.oop_x_n1_n2_n3;
run;

%macro rxadj(wave,start);
data adjust_rx&wave.;
set adjust_rx&start.;
rx_old&wave.=rx_OOP&wave.;
total_old&wave.=total_OOP&wave.;
if rx_OOP&wave./months&wave.>300 then rx_OOP&wave.=months&wave.*300;
total_OOP&wave.=total_old&wave.-rx_old&wave.+rx_OOP&wave.;
other_oop&wave.=total_oop&wave. -insurance_costs&wave.- hospital_oop&wave. -doctor_oop&wave. -rx_oop&wave.- nh_oop&wave. -helper_oop&wave.;
run;
%mend;

%rxadj(wave=_x,start=_start);
%rxadj(wave=_n1,start=_x);
%rxadj(wave=_n2,start=_n1);
%rxadj(wave=_n3,start=_n2);

proc means data=adjust_rx_n3;
var RX_OOP_x RX_old_x other_oop_x;
run;

data check_rx_adj;
set adjust_rx_n3;
rx_per_mo_x=RX_OOP_x/months_x;
run;

proc means; var rx_per_mo_x; run;

/**********************************************************************/
/**********************************************************************/
/*Get totals over 24 and 60 month periods*/
/**********************************************************************/
/**********************************************************************/
/*exit months range 1-202, n1 months=14-145, n2 months=13-152, n3 months=13-98*/
proc means data=adjust_rx_n3;
var months_x months_n1 months_n2 months_n3;
run;

data check_months;
set adjust_rx_n3;
total_mos= sum(months_x,months_n1,months_n2,months_n3);
run;

proc means;
var total_mos;
run;

/*1 obs missing oop_nh_nights_x other_nh_nights_x b/c PR resident, no matched price*/
proc means data=adjust_rx_n3;
var total_OOP: helper_OOP: hospital_OOP: nh_OOP: doctor_OOP: rx_OOP:
 insurance_costs: other_oop: total_old: rx_old: sr_nh_nights: nh_nights: 
los_snf_paid_by_mc_ivw: nh_ni_not_mc:
 oop_nh_nights: other_nh_nights: nh_cost_medicaid: nh_cost_private:  ;
run;


/*get totals of waves OOP for 24 months and 60 months
Check this variable list, I think all of these are needed but need to check
when see the actual dataset
add helper variables!*/

%macro all(su=,months=);

%let list=total_OOP helper_OOP helper_OOP_old hospital_OOP nh_OOP doctor_OOP rx_OOP
 insurance_costs other_oop total_old rx_old sr_nh_nights nh_nights 
los_snf_paid_by_mc_ivw nh_ni_not_mc
 oop_nh_nights other_nh_nights nh_cost_medicaid nh_cost_private 
 hh_s_cost_ivw hh_u_cost_ivw s_months_used u_months_used OOP_months_used;

/*for variables where sum over all interviews*/
%do i=1 %to 24;
%let var=%scan(&list,&i);

data temp_&su._&i;
set adjust_rx_n3;

/*if all 24 months accounted for in exit interview*/
if months_x>=&months.  then do;
&var._&su.=&var._x*&months./months_x;
end;

/*if need n1+ exit*/
if months_x+months_n1>=&months. and &var._&su.=. then do;
&var._&su.=&var._x+&var._n1*(&months.-months_x)/(months_n1);
end;

/*if need n1+n2+ exit*/
if months_x+months_n1+months_n2>=&months. and &var._&su.=. then do;
&var._&su.=&var._x+&var._n1+&var._n2*((&months.-months_x-months_n1)/months_n2);
end;

/*if need n1+n2+n3+ exit*/
if months_x+months_n1+months_n2+months_n3>=&months. and &var._&su.=. then do;
&var._&su.=&var._x+&var._n1+&var._n2+&var._n3*((&months.-months_x-months_n1-months_n2)/months_n3);
end;

keep id &var._&su.;
run;

proc sort data=temp_&su._&i;
by id;
run;

%end;

/*for variables where average over interviews - helper dataset
Takes average of hours/month and number of helpers, weighting by months 
covered by the interview time period
If missing hours, then the variable is left blank in final dataset*/
%let list2=hlphrs hlphrs_p hlphrs_s hlphrs_e hlphrs_u hlphrs_d hlphrs_m 
n_hp n_p n_s n_e n_u n_d n_m;

%do i=25 %to 38;
%let var=%scan(&list2,(&i-24));

data temp_&su._&i;
set adjust_rx_n3;

/*if all 24 months accounted for in exit interview*/
if months_x>=&months. and nomisshrs_x~=0 then do;
&var._&su.=&var._x;
end;

/*if need n1+ exit*/
if months_x+months_n1>=&months. and &var._&su.=. and nomisshrs_x~=0 and nomisshrs_n1~=0 then do;
&var._&su.=&var._x*(months_x/&months.)+&var._n1*(&months.-months_x)/(&months.);
end;

/*if need n1+n2+ exit*/
if months_x+months_n1+months_n2>=&months. and &var._&su.=. and nomisshrs_x~=0 
	and nomisshrs_n1~=0 and nomisshrs_n2~=0 then do;
&var._&su.=&var._x*(months_x/&months.)+&var._n1*(months_n1/&months.)+
	&var._n2*((&months.-months_x-months_n1)/&months.);
end;

/*if need n1+n2+n3+ exit*/
if months_x+months_n1+months_n2+months_n3>=&months. and &var._&su.=. and nomisshrs_x~=0 
	and nomisshrs_n1~=0 and nomisshrs_n2~=0 and nomisshrs_n3~=0  then do;
&var._&su.=&var._x*(months_x/&months.)+&var._n1*(months_n1/&months.)+
	&var._n2*(months_n2/&months.)+&var._n3*((&months.-months_x-months_n1-months_n2)/&months.);
end;

keep id &var._&su.;
run;

proc sort data=temp_&su._&i;
by id;
run;

%end;

%mend;

%all(su=24m,months=24);
%all(su=60m,months=60);

/*merge the temporary datasets back together*/
/*so dataset all_2 has variables for OOP spending last 24 months of life*/
data all_2;
merge temp_24m_1-temp_24m_38 temp_60m_1-temp_60m_38;
by id;
run;

proc means data=all_2(drop=id);
var _all_;
run;

/*bring in the total months oop data available variables, create indicator for complete
data 24m and 60m*/
proc sql;
create table complete_oop as select a.*,b.total_mos,b.months_x,b.months_n1,b.months_n2,b.months_n3 from
all_2 a left join
check_months b
on a.id=b.id;
quit;

proc means;
var total_mos months_x months_n1 months_n2 months_n3;
run;

data complete_oop_1;
set complete_oop;
ind_24m_oop_yes=0;
ind_60m_oop_yes=0;
if total_mos>=24 & total_mos~=. then ind_24m_oop_yes=1 ;
if total_mos>=60 & total_mos~=. then ind_60m_oop_yes=1 ;
label ind_24m_oop_yes="Indicator for 24m OOP data available";
label ind_60m_oop_yes="Indicator for 60m OOP data available";
run;

proc freq;
table ind_24m_oop_yes ind_60m_oop_yes;
run;

/*save this dataset*/
data oop_int.oop_24m_60m;
set complete_oop_1;
label n_p_24m='Avg no. other paid helpers last 24m'
	n_s_24m='Avg no. spouse helpers last 24m'
	n_e_24m='Avg no. employee of inst. helpers last 24m'
	n_u_24m='Avg no. other unpaid helpers last 24m'
	n_d_24m='Avg no. helpers, DN/NA/RF if paid, last 24m'
	n_m_24m='Avg no. helpers, unknown if paid, last 24m'
	n_hp_60m='Avg no. total helpers last 60m'
	n_p_60m='Avg no. other paid helpers last 60m'
	n_s_60m='Avg no. spouse helpers last 60m'
	n_e_60m='Avg no. employee of inst. helpers last 60m'
	n_u_60m='Avg no. other unpaid helpers last 60m'
	n_d_60m='Avg no. helpers, DN/NA/RF if paid, last 60m'
	n_m_60m='Avg no. helpers, unknown if paid, last 60m'
	n_hp_60m='Avg no. total helpers last 60m'
	hlphrs_24m='Avg total hours/month help	last 24m'
	hlphrs_p_24m='Avg hours/month other paid help last 24m'
	hlphrs_s_24m='Avg hours/month spouse help last 24m'
	hlphrs_e_24m='Avg hours/month employee of inst paid help last 24m'
	hlphrs_u_24m='Avg hours/month other unpaid help last 24m'
	hlphrs_d_24m='Avg hours/month, DN/NA/RF paid, help last 24m'
	hlphrs_m_24m='Avg hours/month, missing paid, help last 24m'
	hlphrs_60m='Avg total hours/month help	last 60m'
	hlphrs_p_60m='Avg hours/month other paid help last 60m'
	hlphrs_s_60m='Avg hours/month spouse help last 60m'
	hlphrs_e_60m='Avg hours/month employee of inst paid help last 60m'
	hlphrs_u_60m='Avg hours/month other unpaid help last 60m'
	hlphrs_d_60m='Avg hours/month, DN/NA/RF paid, help last 60m'
	hlphrs_m_60m='Avg hours/month, missing paid, help last 60m'
;

label 
hh_s_cost_ivw_24m='Imputed spouse helper replacement cost last 24m'
hh_u_cost_ivw_24m='Imputed other unpaid helper replacement cost last 24m'
hh_s_cost_ivw_60m='Imputed spouse helper replacement cost last 60m'
hh_u_cost_ivw_60m='Imputed other unpaid helper replacement cost last 60m'
;

run;

proc means data=oop_int.oop_24m_60m;
vars hlphrs_p_24m hlphrs_s_24m ind_24m_oop_yes;
run;

proc means; vars s_months_used_24m u_months_used_24m OOP_months_used_24m; run;
proc means; vars s_months_used_60m u_months_used_60m OOP_months_used_60m; run;


H="Merge interviews with OOP totals"

proc sort data=oop_int.oop_24m_60m out=oop nodupkey;
by id;
run;

proc sort data=oop_int.r_x_r_n1_n2 out=ivws nodupkey;
by id;
run;

/*merge oop with HRS interviews*/
proc sql;
create table oop_int.hrs_oop_ivws(drop=id2) as select * from
ivws a left join
oop(rename=(id=id2))  b
on a.id=b.id2;
quit;



H="Merge meet criteria with oop, ivw dataset and save"
proc sort data=oop_int.hrs_oop_ivws out=oop_ivws nodupkey;
by id;
run;

proc sort data=oop_int.all_insurance out=meet nodupkey;
by id;
run;

/*merge oop / HRS interview dataset with meet criteria variables*/
proc sql;
create table oop_fnl.hrs_oop_ivws_meet(drop=id2) as select * from
oop_ivws a left join
meet(rename=(id=id2) drop=death_year_e death_date_e bid_hrs hmo_24 buyin_24) b
on a.id=b.id2;
quit;

proc freq; table part_ab_2y*hmo_2y part_ab_5y*hmo_5y; run;

H="Elix, cc's 24m prior to death - part 1, get all dx codes"
/*******************************************************************/
/*******************************************************************/
/*First get dx codes across all claims for the 2 years before death*/
/*******************************************************************/
/*******************************************************************/

/*******************************************************************/
/*Step 1, get all claims 2 yrs prior to death*/
/*******************************************************************/

/*Macro for all claims except medpar
Run this twice to get two sets of files: xx_meet_###
xx = claim type
### days before death */
%macro other(days_start=,days_bef_death=,source=);

/*Identify claims within certain time from death date defined when run macro*/
proc sql;
create table &source._meet_&days_bef_death. as select a.*,b.death_date_e
from medi.&source._2000_2010 a inner join
oop_int.meet_criteria_2yr b
on trim(left(a.bid_hrs_19))=trim(left(b.bid_hrs))
and &days_start<=b.death_date_e-a.admit_date<=&days_bef_death;
quit;
run;

%mend;

/*Macro for medpar claims
Creates file mp_meet3_###
where ### = days before death */
%macro mp(days_start=,days_bef_death=,source=);
%let source0=mp;

/*Identify claims within certain time from death date*/
proc sql;
create table &source._meet_&days_bef_death. as select a.*,b.death_date_e
from medi.&source0._2000_2010 a inner join
oop_int.meet_criteria_2yr b
on trim(left(a.bid_hrs_19))=trim(left(b.bid_hrs)) 
and &days_start<=b.death_date_e-a.admit_date<=&days_bef_death ;
quit;

/*Identify claims that are partially within the time from death date*/
proc sql;
create table &source._meet2_&days_bef_death. as select a.*,b.death_date_e
from medi.&source0._2000_2010 a inner join
oop_int.meet_criteria_2yr b
on trim(left(a.bid_hrs_19))=trim(left(b.bid_hrs))
and b.death_date_e-a.admit_date>&days_bef_death and b.death_date_e-a.disch_date<=&days_bef_death;
quit;

data &source._meet3_&days_bef_death.;
set &source._meet_&days_bef_death &source._meet2_&days_bef_death;
run;

run;

%mend;

/*Run macros to identify claims that are within 2 years of the death date*/
%mp(days_start=0,days_bef_death=730,source=mp );
%other(days_start=0,days_bef_death=730,source=hh );
%other(days_start=0,days_bef_death=730,source=hs );
%other(days_start=0,days_bef_death=730,source=dm );
%other(days_start=0,days_bef_death=730,source=op );
%other(days_start=0,days_bef_death=730,source=pb );

/*******************************************************************/
/*Step 2, pull out dx codes*/
/*******************************************************************/
/* File created: dx_0_n24m: dx 2 years before dod

Saved in E:\data\oop_2010\int_data

One macro runs through all claim types to determine dx codes present

range1 = 0 - name for final output file
range2 = n24m - name for final output file
days_bef_death = 365*2 - identifies claims dataset to start with*/

%macro dx_time_range(range1=, range2=, days_bef_death=);

/*Process carrier medicare claims to pull out dx codes
Starts with pb_meet which is list of claims 24 months pre-death
Multiple lines per each BID*/
data pb_last_&range2._dx(keep=bid_hrs_19 diag);
set pb_meet_&days_bef_death.(keep=bid_hrs_19 PDGNS_CD DGNS_CD1-DGNS_CD12 );
array dx PDGNS_CD DGNS_CD1-DGNS_CD12;
do over dx;
diag=dx ;
output;
end;
run;
/*check for and remove duplicates, note this doesn't remove blanks*/
proc sort data=pb_last_&range2._dx out=pb_last_&range2._dx2 nodupkey;
by bid_hrs_19 diag;
run;

/*Process outpatient medicare claims to pull out dx codes
Dataset being created: op_last_&range2._dx2*/
data op_last_&range2._dx(keep=bid_hrs_19 diag);
set op_meet_&days_bef_death.(keep=bid_hrs_19 PDGNS_CD DGNSCD01-DGNSCD25  );
array dx PDGNS_CD DGNSCD01-DGNSCD25 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=op_last_&range2._dx out=op_last_&range2._dx2 nodupkey;
by bid_hrs_19 diag;
run;

/*Process medpar medicare claims to pull out dx codes
Dataset being created: mp_last_&range2._dx2*/
data mp_last_&range2._dx(keep=bid_hrs_19 diag);
set mp_meet3_&days_bef_death.(keep=bid_hrs_19 AD_DGNS DGNS_CD01-DGNS_CD25 );
array dx AD_DGNS DGNS_CD01-DGNS_CD25 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=mp_last_&range2._dx out=mp_last_&range2._dx2 nodupkey;
by bid_hrs_19 diag;
run;

/*Process dme medicare claims to pull out dx codes
Dataset being created: dm_last_&range2._dx2*/
data dm_last_&range2._dx(keep=bid_hrs_19 diag);
set dm_meet_&days_bef_death.(keep=bid_hrs_19 PDGNS_CD DGNS_CD1-DGNS_CD12 );
array dx PDGNS_CD DGNS_CD1-DGNS_CD12 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=dm_last_&range2._dx out=dm_last_&range2._dx2 nodupkey;
by bid_hrs_19 diag;
run;

/*Process hh medicare claims to pull out dx codes
Dataset being created: dm_last_&range2._dx2*/
data hh_last_&range2._dx(keep=bid_hrs_19 diag);
set hh_meet_&days_bef_death.(keep=bid_hrs_19 PDGNS_CD DGNSCD01-DGNSCD25 );
array dx PDGNS_CD DGNSCD01-DGNSCD25 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=hh_last_&range2._dx out=hh_last_&range2._dx2 nodupkey;
by bid_hrs_19 diag;
run;

/*Process hs medicare claims to pull out dx codes
Dataset being created: dm_last_&range2._dx2*/
data hs_last_&range2._dx(keep=bid_hrs_19 diag);
set hs_meet_&days_bef_death.(keep=bid_hrs_19 PDGNS_CD DGNSCD01-DGNSCD25 );
array dx PDGNS_CD DGNSCD01-DGNSCD25 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=hs_last_&range2._dx out=hs_last_&range2._dx2 nodupkey;
by bid_hrs_19 diag;
run;


/*set diag variable length = 7 chars since that's the max length from the mc claims
Need to do this because length varies across the different mc claim types*/
data hs_last_&range2._dx3;
length diag $7;
set hs_last_&range2._dx2;
run;
data hh_last_&range2._dx3;
length diag $7;
set hh_last_&range2._dx2;
run;
data mp_last_&range2._dx3;
length diag $7;
set mp_last_&range2._dx2;
run;
data dm_last_&range2._dx3;
length diag $7;
set dm_last_&range2._dx2;
run;
data op_last_&range2._dx3;
length diag $7;
set op_last_&range2._dx2;
run;
data pb_last_&range2._dx3;
length diag $7;
set pb_last_&range2._dx2;
run;


/*merge diagnoses from each claim type into single dataset*/
data dx_all_last_&range2.;
set hs_last_&range2._dx3
hh_last_&range2._dx3
mp_last_&range2._dx3
dm_last_&range2._dx3
op_last_&range2._dx3
pb_last_&range2._dx3;
run;
proc sort data=dx_all_last_&range2.(where=(diag~="")) out=oop_int.dx_&range1._&range2 nodupkey;
by bid_hrs_19 diag;
run;

%mend;


/*run the macro - 24 months pre-death - get sas dataset oop_int.dx_0d_n24m*/
%dx_time_range(range1=0d, range2=n24m, days_bef_death=730);

proc sql;
select count(*) from oop_int.dx_0d_n24m where bid_hrs_19='.';
quit;


H="Elix, etc. - part 2, create elix indicators"
/*Elixhauser index created, added to interview, OOP dataset

oop_fin.hrs_oop_ivws_meet_el_n24m

CAD defined with ICD-9 codes as defined by CMS here:
http://www.mdinteractive.com/files/uploaded/file/cms2013group/CAD_2013_CMS.pdf
*/

/*    Macro rename 
lib=library
dsn=dataset name
pre=suffix to be added to all of the variable names
*/


%macro rename(lib,dsn,pre);
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "Before Renaming All Variables";
run;

proc sql noprint;
select nvar into :num_vars
from dictionary.tables
where libname="&LIB" and
memname="&DSN";
select distinct(name) into :var1-
:var%TRIM(%LEFT(&num_vars))
from dictionary.columns
where libname="&LIB" and
memname="&DSN";
quit;
run;

proc datasets library=&LIB;
modify &DSN;
rename
%do i=1 %to &num_vars;
&&var&i=&&var&i.._&pre 
%end;
;
quit;
run;
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "After Renaming All Variables";
run;
%mend rename;


/*Elixhauser index macro
Note includes additional 2 comorbidities: Dementia and Coronary Artery Disease*/

%macro elixhauser(range1=, range2=);

data dx_31_comor_&range2;
set oop_int.dx_&range1._&range2.(rename=(diag=dx_0));
dx=trim(left(dx_0));

if dx~="" then do;

comorbi_1=0;
comorbi_2=0;
comorbi_3=0;
comorbi_4=0;
comorbi_5=0;
comorbi_6=0;
comorbi_7=0;
comorbi_8=0;
comorbi_9=0;
comorbi_10=0;
comorbi_11=0;
comorbi_12=0;
comorbi_13=0;
comorbi_14=0;
comorbi_15=0;
comorbi_16=0;
comorbi_17=0;
comorbi_18=0;
comorbi_19=0;
comorbi_20=0;
comorbi_21=0;
comorbi_22=0;
comorbi_23=0;
comorbi_24=0;
comorbi_25=0;
comorbi_26=0;
comorbi_27=0;
comorbi_28=0;
comorbi_29=0;
comorbi_30=0;
*end of intialize of 30 binary variables;
*add dementia and CAD;
dementia=0;
cad=0;

*do over dx;
	*Congestive Heart Failure;
	if (substr(dx,1,5)='39891' or
		substr(dx,1,5)='40211' or
		substr(dx,1,5)='40291' or
		substr(dx,1,5)='40411' or
		substr(dx,1,5)='40413' or
		substr(dx,1,5)='40491' or
		substr(dx,1,5)='40493' or
		substr(dx,1,3)='428') 
		and comorbi_1=0 
		then comorbi_1=1;*add one binary variables here.;
	*Cardiac Arrhythmias;
	if (substr(dx,1,5)='42610' or
		substr(dx,1,5)='42611' or
		substr(dx,1,5)='42613' or
		substr(dx,1,4)='4262' or
		substr(dx,1,4)='4263' or
		substr(dx,1,4)='4264' or
		substr(dx,1,5)='42650' or
		substr(dx,1,5)='42651' or
		substr(dx,1,5)='42652' or
		substr(dx,1,5)='42653' or
		substr(dx,1,4)='4266' or
		substr(dx,1,4)='4267' or
		substr(dx,1,4)='4268' or
		substr(dx,1,4)='4270' or
		substr(dx,1,4)='4272' or
		substr(dx,1,5)='42731' or
		substr(dx,1,5)='42760' or
		substr(dx,1,4)='4279' or
		substr(dx,1,4)='7850' or
		substr(dx,1,4)='V450' or
		substr(dx,1,4)='V533')
			and comorbi_2=0 
		then comorbi_2=1;
	* Valvular Disease ;
	if (substr(dx,1,5)='09320' or
		substr(dx,1,5)='09321' or
		substr(dx,1,5)='09322' or
		substr(dx,1,5)='09323' or
		substr(dx,1,5)='09324' or
		substr(dx,1,3)='394' or
		substr(dx,1,3)='395' or
		substr(dx,1,3)='396' or
		substr(dx,1,4)='3970' or
		substr(dx,1,4)='3971' or
		substr(dx,1,4)='4240' or
		substr(dx,1,4)='4241' or
		substr(dx,1,4)='4242' or
		substr(dx,1,4)='4243' or
		substr(dx,1,4)='4244' or
		substr(dx,1,4)='4245' or
		substr(dx,1,4)='4246' or
		substr(dx,1,4)='4247' or
		substr(dx,1,4)='4248' or
		substr(dx,1,5)='42490' or
		substr(dx,1,5)='42491' or
		substr(dx,1,4)='7463' or
		substr(dx,1,4)='7464' or
		substr(dx,1,4)='7465' or
		substr(dx,1,4)='7466' or
		substr(dx,1,4)='V422' or
		substr(dx,1,5)='V433')
			and comorbi_3=0 
		then comorbi_3=1;
	*Pulmonary Circulation Disorders;
	if (substr(dx,1,3)='416' or
		substr(dx,1,4)='4179')
			and comorbi_4=0 
		then comorbi_4=1;
	*Peripheral Vascular Disorders;
	if (substr(dx,1,3)='440' or
		substr(dx,1,4)='4412' or
		substr(dx,1,4)='4414' or
		substr(dx,1,4)='4417' or
		substr(dx,1,4)='4419' or
		substr(dx,1,4)='4431' or
		substr(dx,1,4)='4432' or
		substr(dx,1,4)='4438' or
		substr(dx,1,4)='4439' or
		substr(dx,1,4)='4471' or
		substr(dx,1,4)='5571' or
		substr(dx,1,4)='5579' or
		substr(dx,1,4)='V434')
			and comorbi_5=0 
		then comorbi_5=1;
	*Hypertension;
	if ((substr(dx,1,4)='4011' or
		substr(dx,1,4)='4019')) or
	   ((substr(dx,1,5)='40210' or
		substr(dx,1,5)='40290' or
		substr(dx,1,5)='40410' or
		substr(dx,1,5)='40490' or
		substr(dx,1,5)='40511' or
		substr(dx,1,5)='40519' or
		substr(dx,1,5)='40591' or
		substr(dx,1,5)='40599')) 
			and comorbi_6=0 
		then comorbi_6=1;
	*Paralysis;	
	if (substr(dx,1,4)='3420' or
		substr(dx,1,5)='34210' or
		substr(dx,1,5)='34211' or
		substr(dx,1,5)='34212' or
		substr(dx,1,4)='3429' or
		substr(dx,1,3)='343' or
		substr(dx,1,3)='344')
			and comorbi_7=0 
		then comorbi_7=1;
	*Other Neurological Disorders;
	if (substr(dx,1,4)='3319' or
		substr(dx,1,4)='3320' or
		substr(dx,1,4)='3334' or
		substr(dx,1,4)='3335' or
		substr(dx,1,3)='334' or
		substr(dx,1,3)='335' or
		substr(dx,1,3)='340' or
		substr(dx,1,4)='3411' or
		substr(dx,1,4)='3418' or
		substr(dx,1,4)='3419' or
		substr(dx,1,5)='34500' or
		substr(dx,1,5)='34501' or
		substr(dx,1,5)='34510' or
		substr(dx,1,5)='34511' or
		substr(dx,1,4)='3454' or
		substr(dx,1,5)='34550' or
		substr(dx,1,5)='34551' or
		substr(dx,1,4)='3458' or
		substr(dx,1,5)='34590' or
		substr(dx,1,5)='34591' or
		substr(dx,1,4)='3481' or
		substr(dx,1,4)='3483' or
		substr(dx,1,4)='7803' or
		substr(dx,1,4)='7843') 
			and comorbi_8=0 
		then comorbi_8=1;	
	*Chronic Pulmonary Disease;
	if (substr(dx,1,3)='490' or
		substr(dx,1,3)='491' or
		substr(dx,1,3)='492' or
		substr(dx,1,4)='4930' or
		substr(dx,1,4)='4931' or
		substr(dx,1,4)='4932' or
		substr(dx,1,4)='4938' or
		substr(dx,1,5)='49390' or
		substr(dx,1,5)='49391' or
		substr(dx,1,3)='494' or
		substr(dx,1,3)='495' or
		substr(dx,1,3)='496' or
		substr(dx,1,3)='497' or
		substr(dx,1,3)='498' or
		substr(dx,1,3)='499' or
		substr(dx,1,3)='500' or
		substr(dx,1,3)='501' or
		substr(dx,1,3)='502' or
		substr(dx,1,3)='503' or
		substr(dx,1,3)='504' or
		substr(dx,1,3)='505' or
		substr(dx,1,4)='5064') 
			and comorbi_9=0 
		then comorbi_9=1;	
	*Diabetes, uncomplicated;
	if (substr(dx,1,4)='2500' or
		substr(dx,1,4)='2501' or
		substr(dx,1,4)='2502' or
		substr(dx,1,4)='2503') 
			and comorbi_10=0 
		then comorbi_10=1;
	*Diabetes, complicated;
	if (substr(dx,1,4)='2504' or
		substr(dx,1,4)='2505' or
		substr(dx,1,4)='2506' or
		substr(dx,1,4)='2507' or
		substr(dx,1,4)='2509') 
			and comorbi_11=0 
		then comorbi_11=1;
	*Hypothyroidism;
	if (substr(dx,1,3)='243' or
		substr(dx,1,4)='2440' or
		substr(dx,1,4)='2441' or
		substr(dx,1,4)='2442' or
		substr(dx,1,4)='2448' or
		substr(dx,1,4)='2449') 	
			and comorbi_12=0 
		then comorbi_12=1;
	*Renal Failure;
	if (substr(dx,1,5)='40311' or
		substr(dx,1,5)='40391' or
		substr(dx,1,5)='40412' or
		substr(dx,1,5)='40492' or
		substr(dx,1,3)='585' or
		substr(dx,1,3)='586' or
		substr(dx,1,4)='V420' or
		substr(dx,1,4)='V451' or
		substr(dx,1,4)='V560' or
		substr(dx,1,4)='V568') 
			and comorbi_13=0 
		then comorbi_13=1;
	*Liver Disease;
	if (substr(dx,1,5)='07032' or
		substr(dx,1,5)='07033' or
		substr(dx,1,5)='07054' or
		substr(dx,1,4)='4560' or
		substr(dx,1,4)='4561' or
		substr(dx,1,5)='45620' or
		substr(dx,1,5)='45621' or
		substr(dx,1,4)='5710' or
		substr(dx,1,4)='5712' or
		substr(dx,1,4)='5713' or
		substr(dx,1,4)='5714' or
		substr(dx,1,4)='5715' or
		substr(dx,1,4)='5716' or
		substr(dx,1,4)='5718' or
		substr(dx,1,4)='5719' or
		substr(dx,1,4)='5723' or
		substr(dx,1,4)='5728' or
		substr(dx,1,4)='V427') 
			and comorbi_14=0 
		then comorbi_14=1;
	*Peptic Ulcer Disease excluding bleeding;
	if (substr(dx,1,5)='53170' or
		substr(dx,1,5)='53190' or
		substr(dx,1,5)='53270' or
		substr(dx,1,5)='53290' or
		substr(dx,1,5)='53370' or
		substr(dx,1,5)='53390' or
		substr(dx,1,5)='53470' or
		substr(dx,1,5)='53490' or
		substr(dx,1,5)='V1271') 
			and comorbi_15=0 
		then comorbi_15=1;
	*AIDS;
	if (substr(dx,1,3)='042' or
		substr(dx,1,3)='043' or
		substr(dx,1,3)='044') 
			and comorbi_16=0 
		then comorbi_16=1;
	*Lymphoma;
	if (substr(dx,1,3)='200' or
		substr(dx,1,4)='201' or
		substr(dx,1,4)='2020' or
		substr(dx,1,4)='2021' or
		substr(dx,1,4)='2022' or
		substr(dx,1,4)='2023' or
		substr(dx,1,4)='2025' or
		substr(dx,1,4)='2026' or
		substr(dx,1,4)='2027' or
		substr(dx,1,4)='2028' or
		substr(dx,1,4)='2029' or
		substr(dx,1,4)='2030' or
		substr(dx,1,4)='2038' or
		substr(dx,1,4)='2386' or
		substr(dx,1,4)='2733' or
		substr(dx,1,4)='V1071' or
		substr(dx,1,4)='V1072' or
		substr(dx,1,4)='V1079')
			and comorbi_17=0 
		then comorbi_17=1;
	*Metastatic Cancer;
	if (substr(dx,1,3)='196' or
		substr(dx,1,3)='197' or
		substr(dx,1,3)='198' or
		substr(dx,1,4)='199') 
			and comorbi_18=0 
		then comorbi_18=1;	
	*Solid Tumor without Metastisis;
	if (substr(dx,1,2)='14' or
		substr(dx,1,2)='15' or
		substr(dx,1,2)='16' or
		substr(dx,1,3)='170' or
		substr(dx,1,3)='171' or
		substr(dx,1,3)='172' or
		substr(dx,1,3)='174' or
		substr(dx,1,3)='175' or
		substr(dx,1,3)='179' or
		substr(dx,1,2)='18' or
		substr(dx,1,3)='190' or
		substr(dx,1,3)='191' or
		substr(dx,1,3)='192' or
		substr(dx,1,3)='193' or
		substr(dx,1,3)='194' or
		substr(dx,1,3)='195' or
		substr(dx,1,3)='V10')
			and comorbi_19=0 
		then comorbi_19=1;
	*Rheumatoid Arthritis/Collagen Vascular Diseases;
	if (substr(dx,1,4)='7010' or
		substr(dx,1,3)='710' or
		substr(dx,1,3)='714' or
		substr(dx,1,3)='720' or
		substr(dx,1,3)='725') 
			and comorbi_20=0 
		then comorbi_20=1;
	*Coagulopathy;
	if (substr(dx,1,3)='286' or
		substr(dx,1,4)='2871' or
		substr(dx,1,4)='2873' or
		substr(dx,1,4)='2874' or
		substr(dx,1,4)='2875') 
			and comorbi_21=0 
		then comorbi_21=1;
	*Obesity;
	if (substr(dx,1,4)='2780')  
			and comorbi_22=0 
		then comorbi_22=1;
	*Weight Loss;
	if (substr(dx,1,3)='260' or
		substr(dx,1,3)='261' or
		substr(dx,1,3)='262' or
		substr(dx,1,3)='263') 
			and comorbi_23=0 
		then comorbi_23=1;	
	*Fluid and Electrolyte Disorders;
	if (substr(dx,1,3)='276') 
			and comorbi_24=0 
		then comorbi_24=1;
	*Blood Loss Anemia;
	if (substr(dx,1,4)='2800') 
			and comorbi_25=0 
		then comorbi_25=1;
	*Deficiency Anemias;
	if (substr(dx,1,4)='2801' or
		substr(dx,1,4)='2808' or
		substr(dx,1,4)='2809' or
		substr(dx,1,4)='2859') 
			and comorbi_26=0 
		then comorbi_26=1;
	*Alcohol Abuse;
	if (substr(dx,1,4)='2911' or
		substr(dx,1,4)='2912' or
		substr(dx,1,4)='2915' or
		substr(dx,1,4)='2918' or
		substr(dx,1,4)='2919' or
		substr(dx,1,4)='3039' or
		substr(dx,1,4)='3050' or
		substr(dx,1,4)='V113') 
			and comorbi_27=0 
		then comorbi_27=1;
	*Drug Abuse;
	if (substr(dx,1,4)='2920' or
		substr(dx,1,5)='29282' or
		substr(dx,1,5)='29283' or
		substr(dx,1,5)='29284' or
		substr(dx,1,5)='29289' or
		substr(dx,1,4)='2929' or
		substr(dx,1,3)='304' or
		substr(dx,1,4)='3052' or
		substr(dx,1,4)='3053' or
		substr(dx,1,4)='3054' or
		substr(dx,1,4)='3055' or
		substr(dx,1,4)='3056' or
		substr(dx,1,4)='3057' or
		substr(dx,1,4)='3058' or
		substr(dx,1,4)='3059')
			and comorbi_28=0 
		then comorbi_28=1;	
	*Psychoses;
	if (substr(dx,1,3)='295' or
		substr(dx,1,3)='296' or
		substr(dx,1,3)='297' or
		substr(dx,1,3)='298' or
		substr(dx,1,4)='2991') 
			and comorbi_29=0 
		then comorbi_29=1;
	*Depression;
	if (substr(dx,1,4)='3004' or
		substr(dx,1,5)='30112' or
		substr(dx,1,4)='3090' or
		substr(dx,1,4)='3091' or
		substr(dx,1,3)='311')
			and comorbi_30=0 
		then comorbi_30=1;


	*Dementia;
	if (substr(dx,1,4) in ('3310','3311','3312','2900','2901',
             '2902','2903','2912','2948','2949') or
		substr(dx,1,5) in ('29410','29411','29040','29041','29042','29043')) 
		and dementia=0 
          then dementia=1;

	*CAD coronary artery disease;
	if (substr(dx,1,4) in ('4140','4142','4143','4148','4149') or 
		substr(dx,1,3) in ('410','411','412','413') or
		substr(dx,1,5) in ('V4581','V4582'))
		and cad=0 
          then cad=1;

/* CAD list
410.00-410.92
411.0-411.89
412
413.0-413.9
414.00-414.07
414.2
414.3
414.8
414.9
V45.81
V45.82 */

end;
run;


/*check sums of each comorbidity for each ID*/
proc sql;
create table com_test1_&range2 as
select distinct BID_hrs_19,
sum(comorbi_1) as com_1,
sum(comorbi_2) as com_2,
sum(comorbi_3) as com_3,
sum(comorbi_4) as com_4,
sum(comorbi_5) as com_5,
sum(comorbi_6) as com_6,
sum(comorbi_7) as com_7,
sum(comorbi_8) as com_8,
sum(comorbi_9) as com_9,
sum(comorbi_10) as com_10,
sum(comorbi_11) as com_11,
sum(comorbi_12) as com_12,
sum(comorbi_13) as com_13,
sum(comorbi_14) as com_14,
sum(comorbi_15) as com_15,
sum(comorbi_16) as com_16,
sum(comorbi_17) as com_17,
sum(comorbi_18) as com_18,
sum(comorbi_19) as com_19,
sum(comorbi_20) as com_20,
sum(comorbi_21) as com_21,
sum(comorbi_22) as com_22,
sum(comorbi_23) as com_23,
sum(comorbi_24) as com_24,
sum(comorbi_25) as com_25,
sum(comorbi_26) as com_26,
sum(comorbi_27) as com_27,
sum(comorbi_28) as com_28,
sum(comorbi_29) as com_29,
sum(comorbi_30) as com_30,
sum(dementia) as com_31,
sum(cad) as com_32
from dx_31_comor_&range2
group by BID_hrs_19;
quit;

/*define comorbidities as binary indicators*/
data comorbidity_&range2.(keep=BID_hrs_19 comorb_1-comorb_32 comorb_all);
set com_test1_&range2;
array list_com com_1-com_30 com_31 com_32;
array list_com_bin comorb_1-comorb_30 comorb_31 comorb_32;

/*note this defines comorbidity 31 = dementia & 32 = cad*/
do over list_com;
  list_com_bin=0;

  if list_com>0 then do;
    list_com_bin=1;
   end;

end;


/*define aggregate comorbidity as sum of 31 individual indicator vars.
note: CAD not included in this aggregate score*/
comorb_all=comorb_1+comorb_2+comorb_3+comorb_4+comorb_5+comorb_6+comorb_7+
comorb_8+comorb_9+comorb_10+comorb_11+comorb_12+comorb_13+comorb_14+
comorb_15+comorb_16+comorb_17+comorb_18+comorb_19+comorb_20+comorb_21+
comorb_22+comorb_23+comorb_24+comorb_25+comorb_26+comorb_27+comorb_28+
comorb_29+comorb_30+comorb_31;
run;


proc sort data=comorbidity_&range2. nodupkey;
by BID_hrs_19;
run;

proc sort data=oop_int.meet_criteria_2yr out=meettomerge nodupkey;
by bid_hrs;
run;

/*merges with decedent dataset that has mc ffs 2 years pre-death by id
Note if this has to be run on a different dataset (another time period for example
need to rewrite this system since the file name suffixes aren't consistent!*/
proc sql;
create table ids_meet_criteria_&range2.13(drop bid_hrs_19) as
select *
from meettomerge
a left join
comorbidity_&range2. b
on a.BID_hrs=b.BID_hrs_19;
quit;

/*if comorbidity=null, set to zero*/
data oop_int.elix_&range1._&range2;
set ids_meet_criteria_&range2.13;
array list comorb_1-comorb_32 comorb_all;
do over list;
if list=. then list=0;
end;

label comorb_1 ="Congestive Heart Failure";
label comorb_2 ="Cardiac Arrhythmias";
label comorb_3 ="Valvular Disease";
label comorb_4 ="Pulmonary Circulation Disorders";
label comorb_5 ="Peripheral Vascular Disorders";
label comorb_6 ="Hypertension";
label comorb_7 ="Paralysis";
label comorb_8 ="Other Neurological Disorders";
label comorb_9 ="Chronic Pulmonary Disease";
label comorb_10 ="Diabetes, uncomplicated";
label comorb_11 ="Diabetes, complicated";
label comorb_12 ="Hypothyroidism";
label comorb_13 ="Renal Failure";
label comorb_14 ="Liver Disease";
label comorb_15 ="Peptic Ulcer Disease excluding bleeding";
label comorb_16 ="AIDS";
label comorb_17 ="Lymphoma";
label comorb_18 ="Metastatic Cancer";
label comorb_19 ="Solid Tumor without Metastisis";
label comorb_20 ="Rheumatoid Arthritis/Collagen Vascular Diseases";
label comorb_21 ="Coagulopathy";
label comorb_22 ="Obesity";
label comorb_23 ="Weight Loss";
label comorb_24 ="Fluid and Electrolyte Disorders";
label comorb_25 ="Blood Loss Anemia";
label comorb_26 ="Deficiency Anemias";
label comorb_27 ="Alcohol Abuse";
label comorb_28 ="Drug Abuse";
label comorb_29 ="Psychoses";
label comorb_30 ="Depression";
label comorb_31 ="Dementia";
label comorb_32 ="Coronary Artery Disease";
run;


data test;
set oop_int.elix_&range1._&range2;
run;

/*calls rename macro*/
%rename(WORK,TEST,&range1._&range2);

/*rename bid_hrs_&range1._&range2=bid_hrs*/
data oop_int.elix_&range1._&range2._2(rename =(bid_hrs_&range1._&range2=bid_hrs));
set test;
keep bid_hrs_&range1._&range2 comorb:;
run;
proc sort data=oop_int.elix_&range1._&range2._2;
by bid_hrs;
run;

%mend;


/*run macro to get elixhauser comorbidities 24 months pre-death*/
%elixhauser(range1=0d, range2=n24m);

proc freq;
table comorb:;
run;

/*make sure no obs have missing bid field*/
data bid_miss_test;
 set oop_int.elix_0d_n24m_2;
 if bid_hrs = '';
run;


proc contents data=oop_int.elix_0d_n24m_2;
run;


/* merge interview+OOP dataset and elixhauser comorbidities 
Resulting file is:
oop_fin.surgery_ids_last_n24m 
Comorbidites are missing if don't have ffs mc 2 years prior to death*/ 

%macro mergeel(range2=);

proc sort data=oop_fnl.hrs_oop_ivws_meet out=full_merge;
by BID_hrs;
run;

proc sort data=oop_int.elix_0d_&range2._2 out=el_merge_&range2. nodupkey;
by BID_hrs;
run;

proc sql;
create table oop_fnl.hrs_oop_ivws_meet_el_&range2(drop=BID_hrs2) as select * from 
full_merge a left join
el_merge_&range2.(rename=(BID_hrs=BID_hrs2)) b
on trim(left(a.BID_hrs))=trim(left(b.BID_hrs2));
quit;
%mend;

%mergeel(range2=n24m);

proc freq data=oop_fnl.hrs_oop_ivws_meet_el_n24m;
table comorb:;
run;




H="Elix, etc. - part 3, create cc indicators"
/*begin of chronic 21 conditions.

Note this pulls from a list of icd-9 codes associated with each of the chronic
conditions. The file path may need to be updated depending on the PC the
code is run from
*/

/*export list of diagnosis codes to stata*/

proc export data=oop_int.dx_0d_n24m
outfile="E:\data\hrs_oop_2010\int_data\dx_0d_n24m.dta" replace;
run;

/*******************************************************************/
/*put the sas data to stata in to dot format
This is STATA code*/
/*
/*******************************************************************/

clear all
set memory 500m

//process diagnosis codes 24 months pre-surgery
use "E:\data\hrs_oop_2010\int_data\dx_0d_n24m.dta",clear

// convert diagnosis codes to string variables, tostring diag,gen(icd9_c)
gen new=ltrim(diag)
icd9 check new,gen(icd9_c)
replace new="" if icd9_c>0 
// convert into dot format (ex 12.1 instead of 121)
icd9 clean new,dots 

replace diag=new
drop icd9_c new

save "E:\data\hrs_oop_2010\int_data\dx_0d_n24m_2.dta",replace


/*******************************************************************/
//Convert back to SAS
//This is SAS Code
/* to the cms 21 chronic comorbidity*/ 
/*******************************************************************/

/*bring in formatted Stata dataset of dx codes*/
proc import 
datafile="E:\data\hrs_oop_2010\int_data\dx_0d_n24m_2.dta" 
out=dx_0d_n24m_2 replace;
run;


/*bring in excel list of dx codes associated with each chronic condition*/
proc import /*datafile="C:\projects\Hospice_impact_on_utilization\raw_data\chronic_21_condition_icd9.xls" */
datafile='E:\data\hrs_oop_2010\ref_data\chronic_21_condition_icd9.xls'
out=icd9_21_chronic dbms=xls replace;
run;

proc contents data=icd9_21_chronic;
run;

/*creates macro variables of each of the chronic conditions listing of dx codes*/
proc sql;
select icd_9 into :chronic_desc1-:chronic_desc21 from icd9_21_chronic;
quit;
%put &chronic_desc10;
%put &chronic_desc5;

/*******************************************************************/
/*Generate chronic conditions indicator variables using dx
codes 24 months pre-death */
/*******************************************************************/

/*macro to create indicator variables for 21 chronic conditions
predeath = n24m  */

%macro cc(predeath=);

/*initialize the chronic conditions variables*/
data list_&predeath._dx;
set dx_0d_&predeath._2;
array list CC_1_AMI
CC_2_ALZH
CC_3_ALZHDMTA
CC_4_ATRIALFB
CC_5_CATARACT
CC_6_CHRNKIDN
CC_7_COPD
CC_8_CHF
CC_9_DIABETES
CC_10_GLAUCOMA
CC_11_HIPFRAC
CC_12_ISCHMCHT
CC_13_DEPRESSN
CC_14_OSTEOPRS
CC_15_RA_OA
CC_16_STRKETIA
CC_17_CNCRBRST
CC_18_CNCRCLRC
CC_19_CNCRPRST
CC_20_CNCRLUNG
CC_21_CNCREndM
;
do over list ;
list=0;
end;

diag_string=diag;

/* for dx codes that begin with numbers, process chronic cond variables*/
if anydigit(substr(trim(left(diag_string)),1,1))=1 then do;
diag=diag_string+0;

if diag in (&chronic_desc1) then CC_1_AMI=1;
if diag in (&chronic_desc2)  then CC_2_ALZH=1;
if diag in (&chronic_desc3)  then CC_3_ALZHDMTA=1;
if diag in (&chronic_desc4) then CC_4_ATRIALFB=1;
if diag in (&chronic_desc5) then CC_5_CATARACT=1;
if diag in (&chronic_desc6) then CC_6_CHRNKIDN=1;
if diag in (&chronic_desc7) then CC_7_COPD=1;
if diag in (&chronic_desc8) then CC_8_CHF=1;
if diag in (&chronic_desc9) then CC_9_DIABETES=1;
if diag in (&chronic_desc10) then CC_10_GLAUCOMA=1;
if diag in (&chronic_desc11) then CC_11_HIPFRAC=1;
if diag in (&chronic_desc12) then CC_12_ISCHMCHT=1;
if diag in (&chronic_desc13) then CC_13_DEPRESSN=1;
if diag in (&chronic_desc14) then CC_14_OSTEOPRS=1;
if diag in (&chronic_desc15) then CC_15_RA_OA=1;
if diag in (&chronic_desc16) then CC_16_STRKETIA=1;
if diag in (&chronic_desc17) then CC_17_CNCRBRST=1;
if diag in (&chronic_desc18) then CC_18_CNCRCLRC=1;
if diag in (&chronic_desc19) then CC_19_CNCRPRST=1;
if diag in (&chronic_desc20) then CC_20_CNCRLUNG=1;
if diag in (&chronic_desc21) then CC_21_CNCREndM=1;
end;

/*deal with dx codes that start with letters
Only two of them in the list we have to worry about*/
if anydigit(substr(trim(left(diag_string)),1,1))=0 then do;
if trim(left(diag_string)) in ("V431") then CC_5_CATARACT=1;
if trim(left(diag_string)) in ("V801") then CC_10_GLAUCOMA=1;
end;

run;

/*aggregate all chronic condition variables by bid*/
proc sql;
create table bid_dx_0_&predeath.(rename=(bid_hrs_19=bid)) as
select distinct bid_hrs_19,
sum(CC_1_AMI) as CC_1_AMI,
sum(CC_2_ALZH) as CC_2_ALZH,
sum(CC_3_ALZHDMTA) as CC_3_ALZHDMTA,
sum(CC_4_ATRIALFB) as CC_4_ATRIALFB,
sum(CC_5_CATARACT) as CC_5_CATARACT,
sum(CC_6_CHRNKIDN) as CC_6_CHRNKIDN,
sum(CC_7_COPD) as CC_7_COPD,
sum(CC_8_CHF) as CC_8_CHF,
sum(CC_9_DIABETES) as CC_9_DIABETES,
sum(CC_10_GLAUCOMA) as CC_10_GLAUCOMA,
sum(CC_11_HIPFRAC) as CC_11_HIPFRAC,
sum(CC_12_ISCHMCHT) as CC_12_ISCHMCHT,
sum(CC_13_DEPRESSN) as CC_13_DEPRESSN,
sum(CC_14_OSTEOPRS) as CC_14_OSTEOPRS,
sum(CC_15_RA_OA) as CC_15_RA_OA,
sum(CC_16_STRKETIA) as CC_16_STRKETIA,
sum(CC_17_CNCRBRST) as CC_17_CNCRBRST,
sum(CC_18_CNCRCLRC) as CC_18_CNCRCLRC,
sum(CC_19_CNCRPRST) as CC_19_CNCRPRST,
sum(CC_20_CNCRLUNG) as CC_20_CNCRLUNG,
sum(CC_21_CNCREndM) as CC_21_CNCREndM

from list_&predeath._dx group by bid_hrs_19;
quit;

/*merge chronic conditions decedent list bid's by bid
This is now a list of those bids with ffs mc last 2 years of life only*/
proc sort data=bid_dx_0_&predeath. nodupkey;
by BID;
run;

proc sort data=oop_int.meet_criteria_2yr out=meettomerge nodupkey;
by bid_hrs;
run;

 proc sql;
 create table bid_dx_0_&predeath.2(drop=bid) as select a.bid_hrs,b.*
 from meettomerge a
 left join
  bid_dx_0_&predeath. b 
 on trim(left(a.bid_hrs))=trim(left(b.bid));
 quit;

/*convert to chronic condition vars. to binary variables*/
 data bid_dx_0_&predeath.3;
 set bid_dx_0_&predeath.2;
 array list CC_1_AMI
CC_2_ALZH
CC_3_ALZHDMTA
CC_4_ATRIALFB
CC_5_CATARACT
CC_6_CHRNKIDN
CC_7_COPD
CC_8_CHF
CC_9_DIABETES
CC_10_GLAUCOMA
CC_11_HIPFRAC
CC_12_ISCHMCHT
CC_13_DEPRESSN
CC_14_OSTEOPRS
CC_15_RA_OA
CC_16_STRKETIA
CC_17_CNCRBRST
CC_18_CNCRCLRC
CC_19_CNCRPRST
CC_20_CNCRLUNG
CC_21_CNCREndM
;
do over list ;
if list>0 then list=1;
if list<=0 then list=0;
end;

/*create aggregated indicators*/
CC_AMI_isch=CC_1_AMI|CC_12_ISCHMCHT;
CC_alzheim=CC_2_ALZH|CC_3_ALZHDMTA;
CC_cncr_chronic=CC_17_CNCRBRST | CC_18_CNCRCLRC | CC_19_CNCRPRST | CC_20_CNCRLUNG | 
	CC_21_CNCREndM ;
run;


proc means;
var CC_1_AMI
CC_2_ALZH
CC_3_ALZHDMTA
CC_4_ATRIALFB
CC_5_CATARACT
CC_6_CHRNKIDN
CC_7_COPD
CC_8_CHF
CC_9_DIABETES
CC_10_GLAUCOMA
CC_11_HIPFRAC
CC_12_ISCHMCHT
CC_13_DEPRESSN
CC_14_OSTEOPRS
CC_15_RA_OA
CC_16_STRKETIA
CC_17_CNCRBRST
CC_18_CNCRCLRC
CC_19_CNCRPRST
CC_20_CNCRLUNG
CC_21_CNCREndM;
run;

%mend;

%cc(predeath=n24m);

/*so resulting datastet is bid_dx_0_n24m3 */

/************************************************************/
/*rename the 12 month pre-surgery chronic condition vars*/
/************************************************************/

/*creates dataset to use in the rename macro below*/
data test;
set bid_dx_0_n24m3;
run;

/*rename macro to add _n24mn0 suffix to the chronic conditions variable names
Data file is still work.test but variables renamed after running this macro*/
%rename(WORK,TEST,n24mn0);

/*Changes name of bid_hrs variable so no _n24mn0*/
data oop_int.chronic_21_n24m_n0_0;
set test;
bid_hrs=bid_hrs_n24mn0;
drop bid_hrs_n24mn0;
run;

proc freq data=oop_int.chronic_21_n24m_n0_0;
table cc: ;
run;
proc contents;
run;

/***************************************************************************/
/* merging chronic conditions variables with the main data file
that also contains the Elixhauser comorbidities */
/***************************************************************************/

%macro mergecc(predeath=);

proc sql;
create table oop_fnl.hrs_oop_ivws_meet_el_cc_&predeath(drop=bid_hrs2)
as select * from
oop_fnl.hrs_oop_ivws_meet_el_&predeath. a
left join
oop_int.chronic_21_&predeath._n0_0(rename=(bid_hrs=bid_hrs2)) b 
on (a.bid_hrs)=(b.bid_hrs2);
quit;

%mend;

%mergecc(predeath=n24m);

/* the above file contains decedents oop and HRS interview data
elixhauser and chronic conditions and insurance data 

File names are:
oop_fin.hrs_oop_ivws_meet_el_cc_n24m
*/

proc contents data=oop_fnl.hrs_oop_ivws_meet_el_cc_n24m;
run;


proc freq data=oop_fnl.hrs_oop_ivws_meet_el_cc_n24m;
table cc_:;
run;


H="Merge in Dartmouth EOL MC spending by HRR"
/*This section brings in the regional (HRR) medicare reimbursement in the 
last 2 years of life from the Dartmouth Atlas

This will serve as a check for our distributiosn of Medicare spending by region*/

/*first get HRR - ZIP crosswalk, 2007 since using the 2003-2007 eol spending data*/
proc import
	/*datafile="H:\OOP\data\HRR_ZIP_xwalk\ziphsahrr07.xls"*/
datafile="E:\data\hrs_oop_2010\ref_data\HRR_ZIP_xwalk\ziphsahrr07.xls"
out=ziphsahrr07 dbms=xls replace;	
run;

data ziphsahrr07_1;
set ziphsahrr07(rename=(zipcode07=zip));
zip_n = put(zip,z5.);
label zip_n="Zip code for HRR xwalk";
drop zip;
run;

proc freq; table hrrnum; run;

/*merge in Dartmouth eol spending (2003-2007) by zip code*/
proc import
	/*datafile="H:\OOP\data\EOL_mc_2yrs_HRR\Total Medicare Reimbursements per Decedent, by Interval Before Death.xls"*/
datafile="E:\data\hrs_oop_2010\ref_data\EOL_mc_2yrs_HRR\DAP_HRR_03_07_to_merge.xls"
out=EOL_dartmouth dbms=xls replace;
run;

data EOL_dartmouth_1;
set EOL_dartmouth;
rename HRR = HRR_number; /*note this is not the right HRR number, not sure what it is*/
rename TOTAL_MEDICARE_SPENDING=tot_eol_spending_hrr;
label TOTAL_MEDICARE_SPENDING="EOL MC spend last 2 yr of life HRR level";
run;

proc freq; table HRR_number; run;

/*merge the eol spending into the zip code/hrr list*/
proc sql;
create table zip_eol_2 as select a.*,b.tot_eol_spending_hrr
from ziphsahrr07_1 a left join
 EOL_dartmouth_1 b
on a.hrrnum=b.HRR_number;
quit;

/*all matched using hrr number to link*/
proc means; var tot_eol_spending_hrr; run;

/*merge into the overall dataset by zip code*/
proc sql;
create table hrs_oop_hrr_1 as select
a.*,b.hrrnum,b.tot_eol_spending_hrr from
oop_fnl.hrs_oop_ivws_meet_el_cc_n24m a left join
zip_eol_2 b
on a.zip_exit_e=b.zip_n;
quit;

data oop_fnl.hrs_oop_ivws_meet_el_cc_n24m_hrr;
set hrs_oop_hrr_1;
tot_eol_hrr_miss=0;
if tot_eol_spending_hrr='' then tot_eol_hrr_miss=1; 
label tot_eol_hrr_miss="Dartmouth total eol for HRR missing";
run;

proc freq; table tot_eol_hrr_miss; run;

/*those that are missing mostly have invalid zip codes*/
data miss_hrr;
set oop_fnl.hrs_oop_ivws_meet_el_cc_n24m_hrr;
if tot_eol_hrr_miss=1;
run;

proc freq; table zip_exit_e; run;

/*save version to Stata*/
proc export data=oop_fnl.hrs_oop_ivws_meet_el_cc_n24m_hrr 
outfile="E:\data\hrs_oop_2010\final_data\hrs_oop_ivws_meet_el_cc_n24m.dta" replace;
run;





H="xxxxxGet nights SNF paid for by MC"
/*this creates the dataset oop_fnl.hrs_oop_with_nh_nights with
1. HRS interviews (exit, core n1, n2, n3 and restricted data)
2. OOP spending, nh nights totaled by 24m and 60m
3. Indicators for ffs mc last 2y and 5y
4. Elixhauser comorbidity indicators, last 2 years of life
5. Chronic conditions indicators, last 2 years of life
6. SNF nights, total and paid for by mc, from MC claims
This dataset is then merged with the MC claims payments totals datset 
created in the next few heading sections


REVISION 4/18
Need to get nursing home nights by interview cycle!
working code is in the next heading section*/

/*get list of all interview dates for decedents, use the oop dataset and merge in xwalk id*/
bid_hrs


/*first pull all snf claims x years before death*/

%macro snfnights(days_start=,days_bef_death=,name=);

/*identify claims where entire claim is within the x months prior to death*/
proc sql;
create table snf_meet as select a.*,b.death_date_e
from medi.mp_2000_2010(where=(trim(left(SSLSSNF))="N")) a inner join
oop_int.meet_criteria_2yr b
on trim(left(a.BID_HRS_19))=trim(left(b.BID_hrs))
and &days_start<=b.death_date_e-a.admit_date<=&days_bef_death;
quit;

/*identify claims that span x months prior to death (admission date is prior to start 
of x months but discharge date is within the x month window*/
proc sql;
create table snf_meet2 as select a.*,b.death_date_e
from medi.mp_2000_2010(where=(trim(left(SSLSSNF))="N")) a inner join
oop_int.meet_criteria_2yr b
on trim(left(a.BID_HRS_19))=trim(left(b.BID_hrs))
and b.death_date_e-a.admit_date>&days_bef_death and b.death_date_e-a.disch_date<=&days_bef_death;
quit;

/*Reset the start date = x months before death to just capture part of stay that was 
during the final x months*/
data snf_meet3;
set snf_meet2;
early_admit=1;
label early_admit="admit outside study window = yes";
run;


data snf_meet_4_&name.;
set snf_meet snf_meet3;

window_start=death_date_e-&days_bef_death.;
/*determine days paid for by mc and total snf days for claims fully in the window*/
if early_admit~=1 then do;
snf_days_mc_paid=util_day;
total_snf_los=LOSCNT;
end;

/*for those that claim starts earlier than time window*/
if early_admit=1 then do;
	mc_paid_thru_dt=admit_date+util_day;
	total_snf_los=LOSCNT-(window_start-admit_date);
	if window_start=mc_paid_thru_dt then total_snf_los=1;
	if mc_paid_thru_dt < window_start then do;
		snf_days_mc_paid=0;
	end;
	if mc_paid_thru_dt > window_start then do;
		snf_days_mc_paid= mc_paid_thru_dt - window_start;
	end;
	if mc_paid_thru_dt = window_start then do;
		snf_days_mc_paid=1;
	end;

end;

format admit_date date10.;
format disch_date date10.;
format mc_paid_thru_dt date10.;
format death_date_e date10.;
format window_start date10.;
label mc_paid_thru_dt="Medicaid covered through this date";
label total_snf_los="Total claim SNF LOS";
label snf_days_mc_paid="Claim days paid for by Medicare";

if total_snf_los=snf_days_mc_paid then mc_full=1;
if total_snf_los>snf_days_mc_paid then mc_full=0;
label mc_full="Indicator that stay fully paid for by MC";

run; 

proc freq; table mc_full; run;

proc means; var total_snf_los snf_days_mc_paid; run;

/*sum over all claims*/
proc sql;
create table snf_&name. as select distinct bid_hrs_19,
sum(total_snf_los) as snf_stay_all_&name. ,
sum(snf_days_mc_paid) as los_snf_paid_by_mc_&name. ,
sum(util_day) as tot_util_days_&name.
from snf_meet_4_&name. group by bid_hrs_19;
quit;

proc means; var snf_stay_all_&name. los_snf_paid_by_mc_&name. tot_util_days_&name.; run;

%mend;

%snfnights(days_start=0,days_bef_death=730,name=2y);
%snfnights(days_start=0,days_bef_death=(5*365),name=5y);

/*merge snf nights into the overall dataset*/
%macro mergenh(predeath=);

proc sql;
create table add_nh_&predeath._1
as select a.*,b.snf_stay_all_2y, b.los_snf_paid_by_mc_2y from
oop_fnl.hrs_oop_ivws_meet_el_cc_&predeath. a
left join
snf_2y b 
on (a.bid_hrs)=(b.bid_hrs_19);
quit;

proc sql;
create table add_nh_&predeath._2
as select a.*,b.snf_stay_all_5y, b.los_snf_paid_by_mc_5y from
add_nh_&predeath._1 a
left join
snf_5y b 
on (a.bid_hrs)=(b.bid_hrs_19);
quit;

%mend;

%mergenh(predeath=n24m);

/*if FFS medicare for the full time period, assign snf stay infrmation as no use*/
data add_nh_final;
set add_nh_n24m_2;
if part_ab_5y=1 and hmo_5y=0 and los_snf_paid_by_mc_5y=. then do;
	los_snf_paid_by_mc_5y=0; snf_stay_all_5y=0;
	end;
if part_ab_2y=1 and hmo_2y=0 and los_snf_paid_by_mc_2y=. then do;
	los_snf_paid_by_mc_2y=0; snf_stay_all_2y=0;
	end;
run;

data oop_fnl.hrs_oop_with_nh_nights;
set add_nh_final;
run;

proc freq; table los_snf_paid_by_mc_2y snf_stay_all_2y; run;



H="Medpar mc spending total"
/*Totals are from merged claims files from 2000-2010
Initial claims merging, processing done in HRS_2010_MC_claims.txt code
Filed in general HRS processing code directory
*/

/**********************************************************/
/**********************************************************/
/*totals from mp file*/
/*Note: variable SSLSSNF from mp claims is N=Skilled nursing facility*/
/*Two totals are calculated - one for skilled nursing facility claims
and one for all other claims in the mp file (inpatient claims)*/
/**********************************************************/
/**********************************************************/

%macro mp(month_n=,days_start=,days_bef_death=,source=,equ=,name=);
%let source0=mp;

/*identify claims where entire claim is within the x months prior to death*/
proc sql;
create table &source._meet as select a.*,b.death_date_e
from medi.&source0._2000_2010(where=(trim(left(SSLSSNF))&equ.="N")) a inner join
oop_int.meet_criteria_2yr b
on trim(left(a.BID_HRS_19))=trim(left(b.BID_hrs))
and &days_start<=b.death_date_e-a.admit_date<=&days_bef_death;
quit;

/*identify claims that span x months prior to death (admission date is prior to start 
of x months but discharge date is within the x month window*/
proc sql;
create table &source._meet2 as select a.*,b.death_date_e
from medi.&source0._2000_2010(where=(trim(left(SSLSSNF))&equ.="N")) a inner join
oop_int.meet_criteria_2yr b
on trim(left(a.BID_HRS_19))=trim(left(b.BID_hrs))
and b.death_date_e-a.admit_date>&days_bef_death and b.death_date_e-a.disch_date<=&days_bef_death;
quit;

/*identify fraction of claims that span x month period that should be 
attributed to the x month period
by just using the fraction of time that was included in the span*/
data &source._meet3;
set &source._meet2;
pct_xm=(disch_date-(death_date_e-&days_bef_death))/(disch_date-admit_date);
array list pmt_amt passthru;
do over list;
if list=. then list=0;
/*scale the partial claims by the time within the x month period*/
list=list*pct_xm;
end;

run;

/*adjust for inflation, Uses CPI for Medical Services from 
BLS website, accessed 3/14/2014*/

/*create table merging both the claims fully in the 2 year period 
and those partially in that time
adjust for inflation here also*/
data &source._cost;
set &source._meet &source._meet3;
array list pmt_amt passthru;
do over list;
if list=. then list=0;
end;

if year(admit_date)>=2010 then rate=1;
if year(admit_date)=2009 then rate=1.0350;
if year(admit_date)=2008 then rate=1.06823;
if year(admit_date)=2007 then rate=1.11347;
if year(admit_date)=2006 then rate=1.17287;
if year(admit_date)=2005 then rate=1.22119;
if year(admit_date)=2004 then rate=1.27983;
if year(admit_date)=2003 then rate=1.34381;
if year(admit_date)=2002 then rate=1.40392;
if year(admit_date)=2001 then rate=1.47492;
if year(admit_date)=2000 then rate=1.54589;
if year(admit_date)<=1999 then rate=1.61195;


&source._paid_by_mc=rate*(pmt_amt+passthru);
run;

*calculates total of mc charges for the claim type by hrs bid;
proc sql;
create table &source._pay as select distinct bid_hrs_19,
sum(&source._paid_by_mc) as &source._paid_by_mc 
from &source._cost group by BID_HRS_19;
quit;

*merges the totals above with the hrs dataset that meets the 2 year criteria;
proc sql;
create table &source._&name. as select
a.BID_hrs,a.id,coalesce(b.&source._paid_by_mc,0) as &source._paid_by_mc_&name.
from oop_int.meet_criteria_2yr a
left join
 &source._pay b
 on trim(left(a.BID_hrs))=trim(left(b.bid_hrs_19));
 quit;

 proc sort data=&source._&name. ;
 by BID_hrs;
 run;
%mend;

/*Runs macro to get total for the SNF claims*/
%mp(days_start=0,days_bef_death=(365.25*2),source=snf,equ=,name=24m );
%mp(days_start=0,days_bef_death=(365.25*5),source=snf,equ=,name=60m );
/*Runs macro to get total for the inpatient (not SNF) claims*/
%mp(days_start=0,days_bef_death=(365.25*2),source=ip,equ=~,name=24m );
%mp(days_start=0,days_bef_death=(365.25*5),source=ip,equ=~,name=60m );

/*************************************************************************/
/*Simple check to view one of the HRS id's claims that are totaled to get the snf number
Just picked an ID number to use*/
/*************************************************************************/

proc sql;
create table test25 as
select * from medi.mp_2000_2010 
where bid_hrs_19="H100000006";
quit;

proc sql;
create table test26 as
select * from test25 
where SSLSSNF="N";
quit;


H="Other types of mc spending totals"
/*macro to calculate totals for the claims that are not in medpar files*/
%macro all_other(source=,month_n=,days_start=,days_bef_death=);

/*identify claims where entire claim is within the x months prior to death*/
proc sql;
create table &source._meet as select a.*
from medi.&source._2000_2010(keep=admit_date BID_hrs_19 pmt_amt) a inner join
oop_int.meet_criteria_2yr b
on trim(left(a.BID_hrs_19))=trim(left(b.BID_hrs))
and &days_start<=b.death_date_e-a.admit_date<=&days_bef_death;
quit;

/*Adjust for inflation*/
data &source._meet2;
set &source._meet;
/*adjust to 2010 dollars*/
if year(admit_date)>=2010 then rate=1;
if year(admit_date)=2009 then rate=1.0350;
if year(admit_date)=2008 then rate=1.06823;
if year(admit_date)=2007 then rate=1.11347;
if year(admit_date)=2006 then rate=1.17287;
if year(admit_date)=2005 then rate=1.22119;
if year(admit_date)=2004 then rate=1.27983;
if year(admit_date)=2003 then rate=1.34381;
if year(admit_date)=2002 then rate=1.40392;
if year(admit_date)=2001 then rate=1.47492;
if year(admit_date)=2000 then rate=1.54589;
if year(admit_date)<=1999 then rate=1.61195;

&source._paid_by_mc=rate*(pmt_amt);
run;

/*Calculate total mc payments by ID*/
proc sql;
create table &source._pay as select distinct BID_hrs_19,sum(&source._paid_by_mc) as &source._paid_by_mc
from &source._meet2 group by BID_hrs_19;
quit;

/*merge in mc totals with full oop dataset*/
proc sql;
create table &source.&month_n as select
a.BID_hrs,coalesce(b.&source._paid_by_mc,0) as &source._paid_by_mc&month_n 
from oop_int.meet_criteria_2yr a
left join
 &source._pay b
 on trim(left(a.BID_hrs))=trim(left(b.BID_hrs_19));
 quit;

 proc sort data=&source&month_n ;
 by BID_hrs;
 run;
 %mend;

/******************************************************************/
/* Run the macro over the mc claims files for 2 years prior to death*/
/******************************************************************/

 %all_other(source=op,month_n=_24m,days_start=0,days_bef_death=(365*2));
  %all_other(source=pb,month_n=_24m,days_start=0,days_bef_death=(365*2));
   %all_other(source=hh,month_n=_24m,days_start=0,days_bef_death=(365*2));
    %all_other(source=hs,month_n=_24m,days_start=0,days_bef_death=(365*2));
     %all_other(source=dm,month_n=_24m,days_start=0,days_bef_death=(365*2));

/******************************************************************/
/* Run the macro over the mc claims files for 5 years prior to death*/
/******************************************************************/

 %all_other(source=op,month_n=_60m,days_start=0,days_bef_death=(365*5));
  %all_other(source=pb,month_n=_60m,days_start=0,days_bef_death=(365*5));
   %all_other(source=hh,month_n=_60m,days_start=0,days_bef_death=(365*5));
    %all_other(source=hs,month_n=_60m,days_start=0,days_bef_death=(365*5));
     %all_other(source=dm,month_n=_60m,days_start=0,days_bef_death=(365*5));


H="Merge mc spending subtotals into single data file"
/******************************************************************/
/* Merge all subtotals into a single data file */
/******************************************************************/
	 data oop_int.costs_all;
	 merge ip_24m snf_24m hh_24m hs_24m pb_24m op_24m dm_24m
		ip_60m snf_60m hh_60m hs_60m pb_60m op_60m dm_60m;
	 by BID_hrs;
	 run;







H="Adjust for wage index by patient zip code"
/******************************************************************/
/* Adjust subtotals for wage index */
/******************************************************************/

/******************************************************************/
/* Pull in wage index file and clean up for states that are missing WI*/
/******************************************************************/
/*bring in 2010 wage index file*/
proc import datafile="E:\data\hrs_oop_2010\ref_data\wage_index\wage_index_cbsa_2010.xls"
out=oop_int.wage_index 
replace;
run;

/*get RI average*/
data wi_ri;
set oop_int.wage_index;
if index(trim(left(Area_Title)),", RI")>0;
run;

proc means;
var wage_index;
run;

/*deal with states that were missing wage index values in the 2010 file
These values are the state averages using the individual cbsa values 
data in the 2010 excel file came from
Note in switching from 2008 to 2010, RI is the only missing state*/
data wage_index2;
set oop_int.wage_index;
cbsa_n=cbsa_code+0;
if trim(left(cbsa_code))~="";
wage_index_2010=Wage_Index;
if index(trim(left(Area_Title)),", RI")>0 then RI=1;
*state 44=RI;
if state_in_wage_index=44 then wage_index_2010=1.0783000; 
run;

*Look at observations from Rhode Island;
proc freq data=wage_index2(where=(ri=1));
table Area_Title;
run;

%let var=ri;
proc means data=wage_index2;
class &var;
var wage_index_2010;
run;

/******************************************************************/
/* Link CBSA codes and zip codes from the WI file*/
/******************************************************************/
/*Bring in xwalk file between CBSA codes and zip codes
Note only keep variables needed from xwalk file because formats 
are missing for some of the other text variables*/
data zip_cb;
set oop_ref.xtract(keep=zip5 cbsa state);
zip_n=zip5+0;
cbsa_n=cbsa+0;
/*If zip code is not missing, add state code*/
if zip_n~=.;
state_n=state+0;
run;

*Remove duplicate entries for zip5 and cbsa from xwalk file;
*Goes from 399045 to 49289 rows;
proc sort data=zip_cb out=zip_cb2 nodupkey;
by zip_n cbsa_n;
run;

*Check to see zip codes in a cbsa code for Rochester, NY;
proc sql;
select zip5, cbsa from zip_cb2
where cbsa_n in (40380);
quit;

/*note several zip codes have multiple cbsa*/
/*create dataset with just one entry for each zip code
8029 zip codes have more than one cbsa code
Just use the first one when sort*/
proc sort data=zip_cb2 out=cbsa_zip_final nodupkey;
by zip_n;
run;

*Check to see zip codes in a cbsa code for Rochester, NY;
proc sql;
select zip_n, cbsa from cbsa_zip_final
where cbsa_n in (40380);
quit;

/******************************************************************/
/* Create dataset with cbsa, wage index and zip code */
/******************************************************************/

/*for zip codes with no cbsa, wage index is left missing
there are also many cbsas with missing wage index*/
proc sql;
create table zip_cbsa_wage_index as
select a.*,b.wage_index_2010 from
cbsa_zip_final a
left join
wage_index2 b
on a.cbsa_n=b.cbsa_n;
quit;

/*Check for and remove duplicates by zip, keep first entry*/
proc sort data=zip_cbsa_wage_index out=zip_cbsa_wage_index2 nodupkey;
by zip_n;
run;


/******************************************************************/
/* Pull in zip code from restricted data */
/******************************************************************/

/*Add zip code to the cost table by id*/
proc sql;
create table cost_zip as
select a.*,b.zip_exit_e from 
oop_int.costs_all a
left join 
oop_int.exit_restricted_02_to_10_v1 b
on a.id=b.id;
quit;


/******************************************************************/
/* Check zip codes in oop data for matching entries in the cbsa file*/
/******************************************************************/

/* 5 observation has a zip code without an associated cbsa */
proc sql; 
select count(distinct cbsa) from cbsa_zip_final;
quit;

proc sql;
select count(distinct zip_exit_e) from cost_zip
where zip_exit_e not in 
(select ZIP5 from cbsa_zip_final);
quit;

proc sql; 
select count(distinct zip_n) from zip_cbsa_wage_index2
where wage_index_2010 is null ;
quit;

proc sql; 
select count(distinct zip_exit_e) from cost_zip
where zip_exit_e not in 
(select ZIP5 from zip_cbsa_wage_index2);
quit;


/******************************************************************/
/* Bring wage index and state code into cost file by zip-cbsa*/
/******************************************************************/
proc sql;
create table cost_id_wage_index as
select a.*,b.wage_index_2010,b.state_n from 
cost_zip a
left join 
zip_cbsa_wage_index2 b
on a.zip_exit_e=b.ZIP5;
quit;

/*1604 observations do not have wage id by cbsa-zip*/
proc sql; 
select count(distinct id) from cost_id_wage_index
where wage_index_2010 is null ;
quit;

/******************************************************************/
/* Bring wage index into cost file by state if missing above*/
/******************************************************************/
/*Get dataset with one wage index per state*/
proc sort data=wage_index2 out=wage_index3 nodupkey;
by state_in_wage_index;
run;

/*Merges in wage index if there's one for the state but was missing for the zip*/
proc sql;
create table cost_id_wage_index2 
as select a.*,coalesce(a.wage_index_2010,b.wage_index_2010) as wage_index_20102
from
cost_id_wage_index a
left join
wage_index3 b
on a.state_n=b.state_in_wage_index;
quit;

/*check for missing values*/
proc means;
var wage_index_2010 wage_index_20102;
run;

/*23 obs have missing state so can't backfill using state wage index*/
proc sql;
select distinct state_n ,count(*) from cost_id_wage_index2
where wage_index_20102=. group by state_n;
quit;

/*********************************************************/
/* Commented out, try to backfill in more manually later */
/*********************************************************/
/*most of these have invalid zip codes too*/
proc sql;
select distinct zip_exit ,count(*) from cost_id_wage_index2
where wage_index_20102=. group by zip_exit;
quit;

/*manually fill in state where zip code is valid and rematch on state*/
data cost_id_wage_index2a;
set cost_id_wage_index2;
if wage_index_20102=. and zip_exit=10065 then state_n=36; /*NY*/
if wage_index_20102=. and zip_exit=33596 then state_n=12; /*FL*/
if wage_index_20102=. and zip_exit=77498 then state_n=48; /*TX*/
if wage_index_20102=. and zip_exit=78542 then state_n=48; /*TX*/
run;

proc sql;
create table cost_id_wage_index2b 
as select a.*,coalesce(a.wage_index_20102,b.wage_index_20102) as wage_index_20102
from
cost_id_wage_index2 a
left join
cost_id_wage_index2a b
on a.state_n=b.state_in_wage_index;
quit;

/*most of these have invalid zip codes too*/
proc sql;
select distinct zip_exit ,count(*) from cost_id_wage_index2b
where wage_index_20082=. group by zip_exit;
quit;
/*********************************************************/
/* End of Commented out                                  */
/*********************************************************/


/******************************************************************/
/* Scale individual costs by wage index*/
/******************************************************************/

/*if missing wage index, set to 1 and create indicator to note no
wage index present b/c bad zip code and missing state
23 observations with wage index assigned = 1*/
data cost_id_wage_index3; 
set cost_id_wage_index2;
wi_missing_yes=0;
if wage_index_20102=. then wi_missing_yes=1;
if wage_index_20102=. then wage_index_20102=1;
label wi_missing_yes="Indicator missing wage index, set to 1";
run;

proc freq data=cost_id_wage_index3; table wi_missing_yes; run;

proc sort data=cost_id_wage_index3 ;
by BID_hrs;
run;

/*macro to adjust prices by wage index
Have two subtotals now - one without wage index adjustment and one with _wi is adjusted*/
%macro wageind(ctype=);
data costs_&ctype._wi (keep=BID_HRS id &ctype._paid_by_mc_24m &ctype._paid_by_mc_24m_wi
	&ctype._paid_by_mc_60m &ctype._paid_by_mc_60m_wi);
set cost_id_wage_index3;
&ctype._paid_by_mc_24m_wi=&ctype._paid_by_mc_24m/wage_index_20102;
&ctype._paid_by_mc_60m_wi=&ctype._paid_by_mc_60m/wage_index_20102;
run;

proc sort data=costs_&ctype._wi ;
by BID_hrs id;
run;

%mend;

%wageind(ctype=ip);
%wageind(ctype=snf);
%wageind(ctype=hh);
%wageind(ctype=hs);
%wageind(ctype=pb);
%wageind(ctype=op);
%wageind(ctype=dm);

/*merge individual adjusted costs into single dataset*/
data costs_all_wi_1;
merge costs_ip_wi costs_snf_wi costs_hh_wi costs_hs_wi costs_pb_wi
 costs_op_wi costs_dm_wi;
by BID_hrs id;
run;

/*bring in indicator for having the wage index*/
proc sort data=costs_all_wi_1; by BID_hrs ; run;
proc sort data=cost_id_wage_index3; by BID_hrs ; run;

proc sql;
create table oop_int.costs_all_wi as select a.*,b.zip_exit_e,b.wi_missing_yes,b.wage_index_20102 from
costs_all_wi_1 a left join
cost_id_wage_index3 b
on a.BID_hrs=b.BID_hrs;
quit;

proc freq; table wi_missing_yes ; run;






H="Calculate total spending "
/******************************************************************/
/* Create new variable for total mc spending of all types */
/******************************************************************/

/*note this final dataset drops observations with missing wage index*/

data oop_fnl.mc_costs_2and5yr;
set oop_int.costs_all_wi;
/*total not adjusted for wage index*/
tot_paid_by_mc_24m=sum(of ip_paid_by_mc_24m snf_paid_by_mc_24m hh_paid_by_mc_24m hs_paid_by_mc_24m
pb_paid_by_mc_24m op_paid_by_mc_24m dm_paid_by_mc_24m);
tot_paid_by_mc_60m=sum(of ip_paid_by_mc_60m snf_paid_by_mc_60m hh_paid_by_mc_60m hs_paid_by_mc_60m
pb_paid_by_mc_60m op_paid_by_mc_60m dm_paid_by_mc_60m);
/*total adjusted for wage index*/
tot_paid_by_mc_24m_wi=sum(of ip_paid_by_mc_24m_wi snf_paid_by_mc_24m_wi hh_paid_by_mc_24m_wi hs_paid_by_mc_24m_wi
pb_paid_by_mc_24m_wi op_paid_by_mc_24m_wi dm_paid_by_mc_24m_wi);
tot_paid_by_mc_60m_wi=sum(of ip_paid_by_mc_60m_wi snf_paid_by_mc_60m_wi hh_paid_by_mc_60m_wi hs_paid_by_mc_60m_wi
pb_paid_by_mc_60m_wi op_paid_by_mc_60m_wi dm_paid_by_mc_60m_wi);
run;

/*save version to Stata*/
proc export data=oop_fnl.mc_costs_2and5yr
outfile="E:\data\hrs_oop_2010\final_data\mc_costs_2and5yr.dta" replace;
run;

H="Merge mc spending into oop file"
/* 
Merges subtotals and total medicare spending in last 2, 5 years
of life into oop dataset

Two sets of medicare totals are brought in:
1. Adjusted for inflation only (2010 dollars)
2. Adjusetd for inflation and 2010 wage index

Note: This step is done in Stata

*/


capture log close
clear all
set mem 500m
set more off

local logpath E:\data\hrs_oop_2010\logs
local datapath E:\data\hrs_oop_2010\final_data

log using `logpath'\1-mc_oop_2and5yr_merge-LOG.txt, text replace

cd `datapath'
use hrs_oop_ivws_meet_el_cc_n24m.dta

merge 1:1 id using mc_costs_2and5yr.dta
//check merge to see that observations with costs were merged
sum _merge if(tot_paid_by_mc_24m==.)
sum _merge if(tot_paid_by_mc_24m~=.)

//Create indicator variable to indciate medicare totals present
gen mc_total_d=0
replace mc_total_d=1 if(_merge==3)
drop _merge
tab mc_total_d

//23 have wi=1 because no link to wage index
tab wi_missing_yes if ( part_ab_2y==1 &  hmo_2y==0)
tab wi_missing_yes core_year_n1 if ( part_ab_2y==1 &  hmo_2y==0)

//Label variables for mc spending totals
la var tot_paid_by_mc_24m "Total mc payments in last 2 years of life"
la var ip_paid_by_mc_24m "Inpatient mc payments in last 2 years of life"
la var snf_paid_by_mc_24m "SNF mc payments in last 2 years of life"
la var hh_paid_by_mc_24m "Home health mc payments in last 2 years of life"
la var hs_paid_by_mc_24m "Hospice mc payments in last 2 years of life"
la var pb_paid_by_mc_24m "Carrier mc payments in last 2 years of life"
la var op_paid_by_mc_24m "Outpatient mc payments in last 2 years of life"
la var dm_paid_by_mc_24m "DME mc payments in last 2 years of life"

la var tot_paid_by_mc_24m_wi "Total wage index adj. mc payments in last 2 years of life"
la var ip_paid_by_mc_24m_wi "Wage index adj. Inpatient mc payments in last 2 years of life"
la var snf_paid_by_mc_24m_wi "Wage index adj. SNF mc payments in last 2 years of life"
la var hh_paid_by_mc_24m_wi "Wage index adj. Home health mc payments in last 2 years of life"
la var hs_paid_by_mc_24m_wi "Wage index adj. Hospice mc payments in last 2 years of life"
la var pb_paid_by_mc_24m_wi "Wage index adj. Carrier mc payments in last 2 years of life"
la var op_paid_by_mc_24m_wi "Wage index adj. Outpatient mc payments in last 2 years of life"
la var dm_paid_by_mc_24m_wi "Wage index adj. DME mc payments in last 2 years of life"

la var tot_paid_by_mc_60m "Total mc payments in last 5 years of life"
la var ip_paid_by_mc_60m "Inpatient mc payments in last 5 years of life"
la var snf_paid_by_mc_60m "SNF mc payments in last 5 years of life"
la var hh_paid_by_mc_60m "Home health mc payments in last 5 years of life"
la var hs_paid_by_mc_60m "Hospice mc payments in last 5 years of life"
la var pb_paid_by_mc_60m "Carrier mc payments in last 5 years of life"
la var op_paid_by_mc_60m "Outpatient mc payments in last 5 years of life"
la var dm_paid_by_mc_60m "DME mc payments in last 5 years of life"

la var tot_paid_by_mc_60m_wi "Total wage index adj. mc payments in last 5 years of life"
la var ip_paid_by_mc_60m_wi "Wage index adj. Inpatient mc payments in last 5 years of life"
la var snf_paid_by_mc_60m_wi "Wage index adj. SNF mc payments in last 5 years of life"
la var hh_paid_by_mc_60m_wi "Wage index adj. Home health mc payments in last 5 years of life"
la var hs_paid_by_mc_60m_wi "Wage index adj. Hospice mc payments in last 5 years of life"
la var pb_paid_by_mc_60m_wi "Wage index adj. Carrier mc payments in last 5 years of life"
la var op_paid_by_mc_60m_wi "Wage index adj. Outpatient mc payments in last 5 years of life"
la var dm_paid_by_mc_60m_wi "Wage index adj. DME mc payments in last 5 years of life"

//save dataset with costs merged in
save oop_resp_sp_restri_24mand60m_mc.dta,replace

//local for mc costs adjusted by wage index
local mccost2 tot_paid_by_mc_24m_wi ip_paid_by_mc_24m_wi snf_paid_by_mc_24m_wi ///
hh_paid_by_mc_24m_wi hs_paid_by_mc_24m_wi pb_paid_by_mc_24m_wi op_paid_by_mc_24m_wi ///
 dm_paid_by_mc_24m_wi 
local mccost5 tot_paid_by_mc_60m_wi ip_paid_by_mc_60m_wi snf_paid_by_mc_60m_wi ///
hh_paid_by_mc_60m_wi hs_paid_by_mc_60m_wi pb_paid_by_mc_60m_wi op_paid_by_mc_60m_wi ///
 dm_paid_by_mc_60m_wi  
tabstat `mccost2' `mccost5' if(mc_total_d==1), stat(mean sd count) col(stat)

tabout death_year_e female_x race_e /*age_at_death_e*/ if(mc_total_d==1) ///
using `logpath'\sumstats1.csv, ///
replace sum c(mean tot_paid_by_mc_24m_wi N tot_paid_by_mc_24m_wi ) style(csv)

/*
//local for comorbidities present in last 24 months
local comorb comorb_1_0d_n24m comorb_2_0d_n24m comorb_3_0d_n24m ///
comorb_4_0d_n24m comorb_5_0d_n24m comorb_6_0d_n24m comorb_7_0d_n24m ///
comorb_8_0d_n24m comorb_9_0d_n24m comorb_10_0d_n24m comorb_11_0d_n24m ///
comorb_12_0d_n24m comorb_13_0d_n24m comorb_14_0d_n24m comorb_15_0d_n24m ///
comorb_16_0d_n24m comorb_17_0d_n24m comorb_18_0d_n24m comorb_19_0d_n24m ///
comorb_20_0d_n24m comorb_21_0d_n24m ///
comorb_22_0d_n24m comorb_23_0d_n24m comorb_24_0d_n24m comorb_25_0d_n24m ///
comorb_26_0d_n24m comorb_27_0d_n24m comorb_28_0d_n24m comorb_29_0d_n24m ///

tabout `comorb'  if(mc_total_d==1) ///
using `logpath'\sumstats2.csv, ///
replace sum c(mean tot_paid_by_mc_24m_wi N tot_paid_by_mc_24m_wi ) style(csv)
*/
log close


H="Table with sample size 2 and 5yr lookbacks"
/*there are likely observations that had nursing home costs that
don't appear in the Medicare paid costs or OOP reported spending
Try to account for that here*/


capture log close
clear all
set mem 500m
set more off

local logpath E:\data\hrs_oop_2010\logs
local datapath E:\data\hrs_oop_2010\final_data

log using `logpath'\2-oop_sample_size-LOG.txt, text replace

cd `datapath'

//full dataset, all decedents
use oop_resp_sp_restri_24mand60m_mc.dta 

mat samp=J(7,2,.)

//total number of decedents, same initial sample 2 and 5yr lookback
sum exit_year_x
mat samp[1,1]=r(N)
mat samp[1,2]=r(N)

*****************************************************
//2 year lookback column
sum exit_year_x if age_at_death_e>=67 & age!=. //decedents 67 and older
mat samp[2,1]=r(N)

sum exit_year_x if age_at_death_e>=67 & age!=. & xwalk_yes==1 //with mc xwalk
mat samp[3,1]=r(N)

sum exit_year_x if age_at_death_e>=67 & age!=. & xwalk_yes==1 & part_ab_2y!=. //with full insur info
mat samp[4,1]=r(N)

sum exit_year_x if age_at_death_e>=67 & age!=. & part_ab_2y==1  // with parts a and  b
mat samp[5,1]=r(N)

sum exit_year_x if age_at_death_e>=67 & age!=. & part_ab_2y==1 &  hmo_2y==0 // with ffs mc
mat samp[6,1]=r(N)

// with ffs mc and full oop data
sum exit_year_x if age_at_death_e>=67 & age!=. & part_ab_2y==1 & hmo_2y==0 & ind_24m_oop_yes==1 
mat samp[7,1]=r(N)

gen byte ind_sample_2yr = 0
replace ind_sample_2yr=1 if age_at_death_e>=67 & age!=. & part_ab_2y==1 & hmo_2y==0 & ind_24m_oop_yes==1
tab ind_sample_2yr, missing
label var ind_sample_2yr "Indicator in 2 yr lookback sample"

*****************************************************
//5 year lookback column
sum exit_year_x if age_at_death_e>=70 & age!=.  //decedents 70 and older
mat samp[2,2]=r(N)

sum exit_year_x if age_at_death_e>=70 & age!=. & xwalk_yes==1 //with mc xwalk
mat samp[3,2]=r(N)

sum exit_year_x if age_at_death_e>=70 & age!=. & xwalk_yes==1 & part_ab_5y!=. //with full insur info
mat samp[4,2]=r(N)

sum exit_year_x if age_at_death_e>=70 & age!=. & part_ab_5y==1  // with parts a and  b
mat samp[5,2]=r(N)

sum exit_year_x if age_at_death_e>=70 & age!=. & part_ab_5y==1 &  hmo_5y==0 // with ffs mc
mat samp[6,2]=r(N)

// with ffs mc and full oop data
sum exit_year_x if age_at_death_e>=70 & age!=. & part_ab_5y==1 & hmo_5y==0 & ind_60m_oop_yes==1 
mat samp[7,2]=r(N)

gen byte ind_sample_5yr = 0
replace ind_sample_5yr=1 if age_at_death_e>=70 & age!=. & part_ab_5y==1 & hmo_5y==0 & ind_60m_oop_yes==1
tab ind_sample_5yr, missing
label var ind_sample_5yr "Indicator in 5 yr lookback sample"


save oop_mc_sample.dta, replace

*****************************************************

mat rownames samp="All decedents, 2002-2010" "Age at death 67+, 70+" "With Medicare link" ///
"Will full insurance info" "With Medicare Parts A&B" "With No HMO" "With full OOP data"

mat colnames samp="2 years" "5 years"

frmttable using `logpath'\2-oop_sample, statmat(samp) ///
title("Sample size determination" \ ///
"2 and 5 year lookback at HRS and Claims") ///
sdec(0) replace

tab part_ab_2y hmo_2y, missing

log close


H="xxxxxAccount for missing nh nights"
/*there are likely observations that had nursing home costs that
don't appear in the Medicare paid costs or OOP reported spending
Try to account for that here*/


capture log close
clear all
set mem 500m
set more off

local logpath E:\data\hrs_oop_2010\logs
local datapath E:\data\hrs_oop_2010\final_data

log using `logpath'\3-add_nh_costs-LOG.txt, text replace

cd `datapath'

//just use dataset where ffs mc last 2 years of life
use oop_mc_sample.dta if ind_sample_2yr==1

//n=3330
tab exit_year_x, missing
sum nh_nights_24m //check for full oop data on nh nights 2 yrs
sum snf_stay_all_2y //check for full SNF claims data on nh nights 2 yrs

//get self reported nursing home nights last 2, 5 years of life/
rename nh_nights_24m nh_nights_sr_24m
rename nh_nights_60m nh_nights_sr_60m
label var nh_nights_sr_24m "Self Report NH nights 2yrs prior to death"
label var nh_nights_sr_60m "Self Report NH nights 5yrs prior to death"

sum nh_nights_sr_24m , detail

sum nh_nights_sr_60m , detail

//medicare reported nursing home nights
sum  snf_stay_all_2y , detail
sum los_snf_paid_by_mc_2y , detail

//if medicare reports more days than self report, assign total days as mc days
//otherwise, keep just the oop days
gen nh_nights_24m = nh_nights_sr_24m if (nh_nights_sr_24m>=snf_stay_all_2y | snf_stay_all_2y==.)
replace nh_nights_24m=snf_stay_all_2y if nh_nights_24m==. & snf_stay_all_2y~=.
label var nh_nights_24m "Total NH nights 2yrs before death, source=self report or claims"
sum nh_nights_24m, detail

gen nh_nights_60m = nh_nights_sr_60m if (nh_nights_sr_60m>=snf_stay_all_5y | snf_stay_all_5y==.)
replace nh_nights_60m=snf_stay_all_5y if nh_nights_60m==. & snf_stay_all_5y~=.
replace nh_nights_60m=. if ind_sample_5yr == 0
label var nh_nights_60m "Total NH nights 5yrs before death, source=self report or claims"
sum nh_nights_60m, detail

//check for nights not paid for by medicare
gen nh_ni_not_mc_24m = 0
replace nh_ni_not_mc_24m=(nh_nights_24m - los_snf_paid_by_mc_2y) if (nh_nights_24m - los_snf_paid_by_mc_2y)>0
label var nh_ni_not_mc_24m "NH Nights not Medicare paid last 2 yrs of life"
sum nh_ni_not_mc_24m, detail

gen nh_ni_not_mc_60m = 0
replace nh_ni_not_mc_60m=(nh_nights_60m - los_snf_paid_by_mc_5y) if (nh_nights_60m - los_snf_paid_by_mc_5y)>0
replace nh_ni_not_mc_60m = . if ind_sample_5yr==0
label var nh_ni_not_mc_60m "NH Nights not Medicare paid last 5 yrs of life"
sum nh_ni_not_mc_60m, detail

//indicator variable for nh total payments imputed
gen byte nh_total_imp_24m = .
replace nh_total_imp_24m =1 if nh_ni_not_mc_24m > 0
replace nh_total_imp_24m =1 if nh_ni_not_mc_24m == 0
label var nh_total_imp_24m "Total HN nights payments (2yrs) imputed = yes"

gen byte nh_total_imp_60m = .
replace nh_total_imp_60m =1 if nh_ni_not_mc_60m > 0
replace nh_total_imp_60m =1 if nh_ni_not_mc_60m == 0
label var nh_total_imp_60m "Total HN nights payments (5yrs) imputed = yes"

//payments for non medicare nights


//label for cause of death
la def cause_death_12_n_e 1 "Infectious Disease (not HIV/AIDS/viral hepatitis)" ///
2 "HIV/AIDS" 3 "Cardiovascular Disease" 4"Chronic Lower Respiratory Disease" ///
5"Other Respiratory Disease" 6"Diabetes" 7"Alzheimers Disease" 9"Neoplasms" ///
10"Kidney Disease (not infectious)" ///
11"Liver, Gallbladder, Stomach and/or Intestinal Disease" ///
12"Accidents, Suicide, Homicide" 13"Other" 14"Unknown"
la val  cause_death_12_n_e cause_death_12_n_e
replace cause_death_12_n_e=14 if cause_death_12_n_e==.
tab cause_death_12_n_e, missing

save oop_24mand60m_mc_add_nh.dta, replace

log close


H="xxxxx Notes - Accounting for other payer SNF days"
Dear Amy et al,

At long last. Here's my proposal for the implicit measurement of Medicaid and private pay spending for individuals in the HRS.  Revisions welcome.
For the period spanning date of death and 2 year look back (possibly 5 yr look back for subgroup):
1.        Count up the total number of nursing home days (self-reported).
Variables created in the "OOP Spending Totals 24,60months before death" section
nh_nights_24m nh_nights_60m , renamed to nh_nights_sr_24m, nh_nights_sr_60m

2.       I believe that the Medicare claims data has the number of nursing home days.  Subtract this number from the self-reported number of days.  If Medicare reports more days than the self-report, use the Medicare number.
Medicare claims nursing home days created in "Get nights SNF paid for by MC" section
Total reported SNF days from Medicare claims:  snf_stay_all_2y , snf_stay_all_5y 
SNF days paid for by Medicare: los_snf_paid_by_mc_2y , los_snf_paid_by_mc_5y

Nursing home days variables used: nh_nights_24m nh_nights_60m

3.       Begin with Medicare-financed nursing home payments as our first component of nursing home payments (total SNF expenditures).  If this is also equal or greater than the self-reported days, then we're done.  We add up Medicare spending with OOP spending for nursing homes, and that's the total. 
If los_snf_paid_by_mc_2y = nh_nights_24m then total NH spending = OOP + MC totals

4.       Suppose that Medicare days do not come close to total nursing home days.  Then we move to impute the total costs of those additional days (that is, total reported days MINUS Medicare-reported days).
If los_snf_paid_by_mc_2y < nh_nights_24m, need to impute!

5.       We also have OOP spending, but we don't know whether some of that was the copay for the Medicare-funded days or whether it was for private-pay days.  So let's ignore for now the copays for Medicare-funded nursing home days. (also those with medi-gap may not have copays as oop expense)
6.       So we take the total number of days not funded by Medicare, and multiply by an average cost of nursing home beds (by state if available Where might we find state-average NH costs? If we do find by-state averages we should not price-adjust those costs, correct?; if not adjusted by our Medicare price index - see below).   Subtract off the patient OOP spending for nursing home care. What is left over is Medicaid spending plus private insurance payments. Should we use the self-report of Medicaid or Private insurance coverage to attribute these costs to one or the other?
nights not funded by medicare: nh_ni_not_mc_24m
imputed cost of remaining nights = nh_ni_not_mc_24m*state average price

Private insurance costs, per Hurd, use 2010 MetLife Mature Market Survey private room rates, by state - use for those that say no medicaid

If medicaid, ust state medicaid rate, from various sources, following Hurd source list


7.       Of course, Medicaid pays less for nursing homes; so we've added back in the implicit "tax" that they impose on nursing homes.  
8.       Regarding the price index - this would be the ratio of unadjusted per capita spending to price-adjusted per capita Medicare spending, both from the Dartmouth Atlas data (side-by-side in the excel spreadsheet in fact).  It's not a perfect price adjustment for nursing home days, but it's a start.
9.       Question: would you want to take the SAS code from Dartmouth to run the price-adjustment for the HRS Medicare claims data? I think it would be better to run the SAS code on these datacould you send it to us?  Then we're not imputing the price adjustment, but we're actually getting in in real terms.  Of course, we'd still need to adjust OOP for regional price level variations. To do this we'd still use the ratio, but it would now be based on these HRS-Medicare data, not the overall Medicare data, right?


H="Look at dementia samples"
capture log close
clear all
set mem 500m
set more off

local logpath E:\data\hrs_oop_2010\logs
local datapath E:\data\hrs_oop_2010\final_data

log using `logpath'\4-mc_oop_dementia_initial-LOG.txt, text replace

cd `datapath'

//this dataset is already limited to ffs, full info last 2 years of life
use oop_mc_sample.dta

// look at dementia probability sample sizes

gen byte dem_miss_n1 = .
replace dem_miss_n1=1 if prob_dementia_n1==.
replace dem_miss_n1=0 if prob_dementia_n1!=.

gen byte dem_miss_n2 = .
replace dem_miss_n2=1 if prob_dementia_n2==.
replace dem_miss_n2=0 if prob_dementia_n2!=.

tab dem_miss_n1 dem_miss_n2, missing

//if missing, carry forward n2 probability
gen prob_dem_n1n2 = prob_dementia_n1
replace prob_dem_n1n2=prob_dementia_n2 if prob_dementia_n1==.

//histogram prob_dem_n1n2

gen byte pr_dem_gt50 = .
replace pr_dem_gt50 = 0 if prob_dem_n1n2<=.5 & prob_dem_n1n2!=.
replace pr_dem_gt50 = 1 if prob_dem_n1n2>.5 & prob_dem_n1n2!=.
la var pr_dem_gt50 "Indicator dementia prob gt 0.5"
tab pr_dem_gt50, missing

gen byte pr_dem_gt30 = .
replace pr_dem_gt30 = 0 if prob_dem_n1n2<=.3 & prob_dem_n1n2!=.
replace pr_dem_gt30 = 1 if prob_dem_n1n2>.3 & prob_dem_n1n2!=.
la var pr_dem_gt30 "Indicator dementia prob gt 0.3"
tab pr_dem_gt30, missing

gen byte pr_dem_gt70 = .
replace pr_dem_gt70 = 0 if prob_dem_n1n2<=.7 & prob_dem_n1n2!=.
replace pr_dem_gt70 = 1 if prob_dem_n1n2>.7 & prob_dem_n1n2!=.
la var pr_dem_gt70 "Indicator dementia prob gt 0.7"
tab pr_dem_gt70, missing

//get tables comparing mean spending at different dementia probability cutoffs
mat p50=J(17,2,.)
//first row n each group
tab pr_dem_gt50, missing matcell(r1_50)
mat p50[1,1]=r1_50[2,1] //with dem prob > 50% col 1
mat p50[1,2]=r1_50[1,1] //with dem prob < 50% col 2

//mc vars
local spvars tot_paid_by_mc_24m_wi ip_paid_by_mc_24m_wi snf_paid_by_mc_24m_wi ///
hh_paid_by_mc_24m_wi hs_paid_by_mc_24m_wi pb_paid_by_mc_24m_wi op_paid_by_mc_24m_wi ///
dm_paid_by_mc_24m_wi total_oop_24m helper_oop_24m hospital_oop_24m nh_oop_24m ///
doctor_oop_24m rx_oop_24m insurance_costs_24m other_oop_24m 

//total mc 2 years, wage index adjusted
local r = 2
foreach v in `spvars'{
sum `v' if pr_dem_gt50==1
mat p50[`r',1]=r(mean)
sum `v' if pr_dem_gt50==0
mat p50[`r',2]=r(mean)
local r = `r'+1
}

mat rownames p50= "N" "Total medicare" "Medicare IP" "Medicare SNF" "Medicare HH" ///
"Medicare hospice" "Medicare Carrier" "Medicare OP" "Medicare DME" ///
"OOP Total" "OOP Helper" "OOP Hospital" "OOP NH" "OOP Doctor" "OOP Rx" "OOP Insurance Costs" "OOP Other"
mat colnames p50="Prob dem > 50%" "Prob dem <=50%"

mat list p50

frmttable using `logpath'\oop_dem_initial_tables, statmat(p50) ///
title("Dementia, P=.5 cutoff, Medicare and OOP Spending") ///
note("Medicare spending totals are adjusted for the CMS wage index" \ ///
"All $ values adjusted for inflation to 2010$") ///
sdec(0) replace

//get tables comparing mean spending at different dementia probability cutoffs
mat p30=J(17,2,.)
//first row n each group
tab pr_dem_gt30, missing matcell(r1_30)
mat p30[1,1]=r1_30[2,1] //with dem prob > 50% col 1
mat p30[1,2]=r1_30[1,1] //with dem prob < 50% col 2
//total mc 2 years, wage index adjusted
local r = 2
foreach v in `spvars'{
sum `v' if pr_dem_gt30==1
mat p30[`r',1]=r(mean)
sum `v' if pr_dem_gt30==0
mat p30[`r',2]=r(mean)
local r = `r'+1
}

mat rownames p30= "N" "Total medicare" "Medicare IP" "Medicare SNF" "Medicare HH" ///
"Medicare hospice" "Medicare Carrier" "Medicare OP" "Medicare DME" ///
"OOP Total" "OOP Helper" "OOP Hospital" "OOP NH" "OOP Doctor" "OOP Rx" "OOP Insurance Costs" "OOP Other"
mat colnames p30="Prob dem > 30%" "Prob dem <=30%"

mat list p30

frmttable using `logpath'\oop_dem_initial_tables, statmat(p30) ///
title("Dementia, P=.3 cutoff, Medicare and OOP Spending") ///
note("Medicare spending totals are adjusted for the CMS wage index" \ ///
"All $ values adjusted for inflation to 2010$") ///
sdec(0) addtable

log close


H="Compare dementia to cancer and heart disease groups"
/*Compares spending for dementia patients (defined as probability of dementia = 50%)
with that of cancer, heart disease, infectious disease and sudden death (accidents, etc.)

2 sets of tables, 2 and 5 year look backs
*/

capture log close
clear all
set mem 500m
set more off

local logpath E:\data\hrs_oop_2010\logs
local datapath E:\data\hrs_oop_2010\final_data

log using `logpath'\5-mc_oop_dementia_initial-LOG.txt, text replace

cd `datapath'

//use just sample that meet 2 year criteria (full mc and oop data 2 years from death)
use oop_mc_sample.dta if (age_at_death_e>=67 & part_ab_2y==1 & hmo_2y==0  & ind_24m_oop_yes==1) 


// look at dementia probability sample sizes

gen byte dem_miss_n1 = .
replace dem_miss_n1=1 if prob_dementia_n1==.
replace dem_miss_n1=0 if prob_dementia_n1!=.

gen byte dem_miss_n2 = .
replace dem_miss_n2=1 if prob_dementia_n2==.
replace dem_miss_n2=0 if prob_dementia_n2!=.

tab dem_miss_n1 dem_miss_n2, missing

//if missing, carry forward n2 probability
gen prob_dem_n1n2 = prob_dementia_n1
replace prob_dem_n1n2=prob_dementia_n2 if prob_dementia_n1==.

//histogram prob_dem_n1n2

gen byte pr_dem_gt50 = .
replace pr_dem_gt50 = 0 if prob_dem_n1n2<=.5 & prob_dem_n1n2!=.
replace pr_dem_gt50 = 1 if prob_dem_n1n2>.5 & prob_dem_n1n2!=.
la var pr_dem_gt50 "Indicator dementia prob gt 0.5"
tab pr_dem_gt50, missing

gen byte cancer_grp = .
replace cancer_grp=1 if comorb_17_0d_n24m==1 | comorb_18_0d_n24m==1 | comorb_19_0d_n24m==1
replace cancer_grp=0 if comorb_17_0d_n24m==0 & comorb_18_0d_n24m==0 & comorb_19_0d_n24m==0
la var cancer_grp "Indicator cancer, per elix 17, 18, 19)
tab cancer_grp, missing

gen byte heartdis_grp = .
replace heartdis_grp =1 if comorb_1_0d_n24m==1 | comorb_2_0d_n24m==1 | ///
	comorb_3_0d_n24m==1  | comorb_32_0d_n24m==1 
replace heartdis_grp =0 if comorb_1_0d_n24m==0 & comorb_2_0d_n24m==0 & ///
	comorb_3_0d_n24m==0 & comorb_32_0d_n24m==0
la var heartdis_grp "Indicator heart disease, per elix 1,2,3,32)
tab heartdis_grp , missing

gen byte cause_death_sudden = 0
replace cause_death_sudden = 1 if cause_death_12_n_e==12
la var cause_death_sudden "Cause of death = Accidents, Suicide, Homicide" 
tab cause_death_sudden, missing

gen byte cause_death_inf = 0
replace cause_death_inf = 1 if cause_death_12_n_e==1
la var cause_death_inf "Cause of death = Infectious Disease (not HIV/AIDS/viral hepatitis)" 
tab cause_death_inf, missing

table pr_dem_gt50 cancer_grp heartdis_grp , contents(freq)

//total nursing home payments
gen total_nh_costs_24m=snf_paid_by_mc_24m_wi+nh_oop_24m+nh_cost_medicaid_24m+nh_cost_private_24m
gen total_nh_costs_60m=snf_paid_by_mc_60m_wi+nh_oop_60m+nh_cost_medicaid_60m+nh_cost_private_60m


*****************************************************************************
//Dementia compared with cancer and heart disease, 2 year lookback
*****************************************************************************

//get tables comparing mean, median spending for different disease groups
mat dg_2y=J(27,6,.)
//first row n each group
tab pr_dem_gt50, missing matcell(r1_50)
mat dg_2y[1,1]=r1_50[2,1] //with dem prob > 50% col 1
tab cancer_grp, missing matcell(r1_c)
mat dg_2y[1,3]=r1_c[2,1] //with cancer col 2
tab heartdis_grp , missing matcell(r1_h)
mat dg_2y[1,5]=r1_h[2,1] //with heart disease col 3

//mc vars
local spvars age_at_death_e tot_paid_by_mc_24m_wi ip_paid_by_mc_24m_wi snf_paid_by_mc_24m_wi ///
hh_paid_by_mc_24m_wi hs_paid_by_mc_24m_wi pb_paid_by_mc_24m_wi op_paid_by_mc_24m_wi ///
dm_paid_by_mc_24m_wi total_oop_24m helper_oop_24m hospital_oop_24m nh_oop_24m ///
doctor_oop_24m rx_oop_24m insurance_costs_24m other_oop_24m nh_nights_24m  ///
los_snf_paid_by_mc_ivw_24m nh_ni_not_mc_24m ///
oop_nh_nights_24m other_nh_nights_24m nh_cost_medicaid_24m nh_cost_private_24m total_nh_costs_24m ///
medicaid_x

//totals 2 years, wage index adjusted mc payments, oop spend and nh nights
local c=1
foreach d in pr_dem_gt50 cancer_grp heartdis_grp {
	local r = 2
	foreach v in `spvars'{
		sum `v' if `d'==1, detail
		mat dg_2y[`r',`c']=r(mean)
		mat dg_2y[`r',`c'+1]=r(p50)
		local r = `r'+1
		}
	local c = `c'+2
	}
//convert medicaid rate to percent
forvalues i = 1/6{
mat dg_2y[`r'-1,`i']=dg_2y[`r'-1,`i']*100	
}	
	
mat rownames dg_2y= "N" "Age at death" "Total Medicare payments" "Medicare IP" "Medicare SNF" "Medicare HH" ///
"Medicare hospice" "Medicare Carrier" "Medicare OP" "Medicare DME" ///
"OOP Total" "OOP Helper" "OOP Hospital" "OOP NH" "OOP Doctor" "OOP Rx" ///
"OOP Insurance Costs" "OOP Other" ///
"Total NH nights, SR or claims" "Nights paid by Medicare" "Nights not Medicare" ///
"OOP Nights, imputed" "Medicaid or private payer nights" "Medicaid NH Payments" ///
"Private payer NH Payments" "Total NH costs, all payers" "Medicaid at death? (percent)"

mat colnames dg_2y="Prob dem > 50%" "median" "Cancer" "median" "Heart disease" "median" 

mat list dg_2y

frmttable using `logpath'\5-oop_dem_initial_tables, statmat(dg_2y) ///
title("Dementia, Cancer and Heart Disease Patients" \ ///
"Medicare and OOP Spending Last 2 years of life") ///
note("Medicare spending totals are adjusted for the 2010 CMS wage index" \ ///
"All $ values adjusted for inflation to 2010$")  ///
sdec(0) landscape replace 

*****************************************************************************
//Dementia compared with cancer and heart disease, 2 year lookback
//Helper counts
*****************************************************************************

gen hlphrs_dm_24m=hlphrs_d_24m+hlphrs_m_24m
gen n_dm_24m=n_d_24m+n_m_24m

gen hlphrs_informal_24m=hlphrs_s_24m+hlphrs_u_24m
gen n_informal_24m=n_s_24m+n_u_24m

//get tables comparing mean, median number of helpers/hours for different disease groups
mat dg_2y_h=J(16,6,.)
//first row n each group
tab pr_dem_gt50, missing matcell(r1_50)
mat dg_2y_h[1,1]=r1_50[2,1] //with dem prob > 50% col 1
tab cancer_grp, missing matcell(r1_c)
mat dg_2y_h[1,3]=r1_c[2,1] //with cancer col 2
tab heartdis_grp , missing matcell(r1_h)
mat dg_2y_h[1,5]=r1_h[2,1] //with heart disease col 3

//mc vars
local helpvars age_at_death_e hlphrs_24m hlphrs_p_24m hlphrs_s_24m hlphrs_e_24m ///
hlphrs_u_24m hlphrs_dm_24m hlphrs_informal_24m n_hp_24m n_p_24m n_s_24m n_e_24m ///
 n_u_24m n_dm_24m n_informal_24m

//average 2 years, helper counts and hours/month
local c=1
foreach d in pr_dem_gt50 cancer_grp heartdis_grp {
	local r = 2
	foreach v in `helpvars'{
		sum `v' if `d'==1, detail
		mat dg_2y_h[`r',`c']=r(mean)
		mat dg_2y_h[`r',`c'+1]=r(N)
		local r = `r'+1
		}
	local c = `c'+2
	}

mat rownames dg_2y_h= "N" "Age at death" "Hours/month all helpers" ///
"Hr/mo other paid helpers" "Hr/mo spouse helper" "Hr/mo employee of inst helper" ///
"Hr/mo other unpaid helpers" "Hr/mo helper paid status unk" "Hr/mo informal helpers" ///
"Number helpers, all types" ///
"Number other paid helpers" "Number spouse helper" "Number employee of inst helper" ///
"Number other unpaid helpers" "Number helper paid status unk" "Number informal helpers"

mat colnames dg_2y_h="Prob dem > 50%" "n" "Cancer" "n" "Heart disease" "n" 

mat list dg_2y_h

frmttable using `logpath'\5-oop_dem_initial_tables, statmat(dg_2y_h) ///
title("Dementia, Cancer and Heart Disease Patients" \ ///
"Average helper burden, last 2 years of life") ///
note("n columns show number of helpers for which we have full information" \ ///
"If hours were missing in dataset, then variable is missing from mean calculation" \ ///
"Hours/month and number of helpers are mean reported over the last 2 years of life") ///
sdec(2) landscape addtable 


*****************************************************************************
//Dementia compared with sudden death and infections disease, 2 year lookback
*****************************************************************************
//get tables comparing mean, median spending for different disease groups
mat dg_cd_2y=J(27,6,.)
//first row n each group
tab pr_dem_gt50, missing matcell(r1_50)
mat dg_cd_2y[1,1]=r1_50[2,1] //with dem prob > 50% col 1
tab cause_death_sudden , missing matcell(r1_s)
mat dg_cd_2y[1,3]=r1_s[2,1] //with heart disease col 3
tab cause_death_inf , missing matcell(r1_i)
mat dg_cd_2y[1,5]=r1_i[2,1] //with heart disease col 5


//totals 2 years, wage index adjusted mc payments, oop spend and nh nights
local c=1
foreach d in pr_dem_gt50 cause_death_sudden cause_death_inf{
	local r = 2
	foreach v in `spvars'{
		sum `v' if `d'==1, detail
		mat dg_cd_2y[`r',`c']=r(mean)
		mat dg_cd_2y[`r',`c'+1]=r(p50)
		local r = `r'+1
		}
	local c = `c'+2
	}

//convert medicaid rate to percent
forvalues i = 1/6{
mat dg_cd_2y[`r'-1,`i']=dg_cd_2y[`r'-1,`i']*100	
}	

mat rownames dg_cd_2y= "N" "Age at death" "Total Medicare payments" "Medicare IP" "Medicare SNF" "Medicare HH" ///
"Medicare hospice" "Medicare Carrier" "Medicare OP" "Medicare DME" ///
"OOP Total" "OOP Helper" "OOP Hospital" "OOP NH" "OOP Doctor" "OOP Rx" ///
"OOP Insurance Costs"  "OOP Other" ///
"Total NH nights, SR or claims" "Nights paid by Medicare" "Nights not Medicare" ///
"OOP Nights, imputed" "Medicaid or private payer nights" "Medicaid NH Payments" ///
"Private payer NH Payments" "Total NH Costs, all payers" "Medicaid at death? (percent)"

mat colnames dg_cd_2y="Prob dem > 50%" "median" "Sudden death" "median" "Infect disease" "median"


mat list dg_cd_2y

frmttable using `logpath'\5-oop_dem_initial_tables, statmat(dg_cd_2y) ///
title("Dementia, Sudden death and Infectious diseases Patients" \ ///
"Medicare and OOP Spending Last 2 years of life") ///
note("Medicare spending totals are adjusted for the 2010 CMS wage index" \ ///
"All $ values adjusted for inflation to 2010$")  ///
sdec(0) landscape addtable 


******************************************************************************
//Table last 5 years spending
******************************************************************************
keep if part_ab_5y==1 & hmo_5y==0 & ind_60m_oop_yes==1

//get tables comparing mean, median spending for different disease groups
mat dg_5y=J(27,6,.)
//first row n each group
tab pr_dem_gt50, missing matcell(r2_d)
mat dg_5y[1,1]=r2_d[2,1] //with dem prob > 50% col 1
tab cancer_grp, missing matcell(r2_c)
mat dg_5y[1,3]=r2_c[2,1] //with cancer col 2
tab heartdis_grp , missing matcell(r2_h)
mat dg_5y[1,5]=r2_h[2,1] //with heart disease col 3

//mc vars
local spvars5 age_at_death_e tot_paid_by_mc_60m_wi ip_paid_by_mc_60m_wi snf_paid_by_mc_60m_wi ///
hh_paid_by_mc_60m_wi hs_paid_by_mc_60m_wi pb_paid_by_mc_60m_wi op_paid_by_mc_60m_wi ///
dm_paid_by_mc_60m_wi total_oop_60m helper_oop_60m hospital_oop_60m nh_oop_60m ///
doctor_oop_60m rx_oop_60m insurance_costs_60m other_oop_60m nh_nights_60m ///
los_snf_paid_by_mc_ivw_60m ///
nh_ni_not_mc_60m oop_nh_nights_60m other_nh_nights_60m nh_cost_medicaid_60m ///
nh_cost_private_60m total_nh_costs_60m medicaid_x

//total mc 2 years, wage index adjusted
local c=1
foreach d in pr_dem_gt50 cancer_grp heartdis_grp{
	local r = 2
	foreach v in `spvars5'{
		sum `v' if `d'==1, detail
		mat dg_5y[`r',`c']=r(mean)
		mat dg_5y[`r',`c'+1]=r(p50)
		local r = `r'+1
		}
	local c = `c'+2
	}
//convert medicaid rate to percent
forvalues i = 1/6{
mat dg_5y[`r'-1,`i']=dg_5y[`r'-1,`i']*100	
}	

mat rownames dg_5y= "N" "Age at death" "Total Medicare payments" "Medicare IP" "Medicare SNF" "Medicare HH" ///
"Medicare hospice" "Medicare Carrier" "Medicare OP" "Medicare DME" ///
"OOP Total" "OOP Helper" "OOP Hospital" "OOP NH" "OOP Doctor" "OOP Rx" ///
"OOP Insurance Costs" "OOP Other" ///
"Total NH nights, SR or claims" "Nights paid by Medicare" "Nights not Medicare" ///
"OOP Nights, imputed" "Medicaid or private payer nights" "Medicaid NH Payments" ///
"Private payer NH Payments" "Total NH costs, all payers" "Medicaid at death? (percent)"

mat colnames dg_5y="Prob dem > 50%" "median" "Cancer" "median" "Heart disease" "median"

mat list dg_5y

frmttable using `logpath'\5-oop_dem_initial_tables, statmat(dg_5y) ///
title("Dementia, Cancer and Heart Disease Patients" \ ///
"Medicare and OOP Spending Last 5 years of life") ///
note("Medicare spending totals are adjusted for the 2010 CMS wage index" \ ///
"All $ values adjusted for inflation to 2010$" ) ///
sdec(0) landscape addtable

*****************************************************************************
//Dementia compared with cancer and heart disease, 5 year lookback
//Helper counts
*****************************************************************************

gen hlphrs_dm_60m=hlphrs_d_60m+hlphrs_m_60m
gen n_dm_60m=n_d_60m+n_m_60m

gen hlphrs_informal_60m=hlphrs_s_60m+hlphrs_u_60m
gen n_informal_60m=n_s_24m+n_u_60m

//get tables comparing mean, median number of helpers/hours for different disease groups
mat dg_5y_h=J(16,6,.)
//first row n each group
tab pr_dem_gt50, missing matcell(r1_50)
mat dg_5y_h[1,1]=r1_50[2,1] //with dem prob > 50% col 1
tab cancer_grp, missing matcell(r1_c)
mat dg_5y_h[1,3]=r1_c[2,1] //with cancer col 2
tab heartdis_grp , missing matcell(r1_h)
mat dg_5y_h[1,5]=r1_h[2,1] //with heart disease col 3

//mc vars
local helpvars age_at_death_e hlphrs_60m hlphrs_p_60m hlphrs_s_60m hlphrs_e_60m ///
hlphrs_u_60m hlphrs_dm_60m hlphrs_informal_60m n_hp_60m n_p_60m n_s_60m n_e_60m ///
 n_u_60m n_dm_60m n_informal_60m

//Average 5 years, hours/mo and number of helpers
local c=1
foreach d in pr_dem_gt50 cancer_grp heartdis_grp {
	local r = 2
	foreach v in `helpvars'{
		sum `v' if `d'==1, detail
		mat dg_5y_h[`r',`c']=r(mean)
		mat dg_5y_h[`r',`c'+1]=r(N)
		local r = `r'+1
		}
	local c = `c'+2
	}

mat rownames dg_5y_h= "N" "Age at death" "Hours/month all helpers" ///
"Hr/mo other paid helpers" "Hr/mo spouse helper" "Hr/mo employee of inst helper" ///
"Hr/mo other unpaid helpers" "Hr/mo helper paid status unk" "Hr/mo informal helpers" ///
"Number helpers, all types" ///
"Number other paid helpers" "Number spouse helper" "Number employee of inst helper" ///
"Number other unpaid helpers" "Number helper paid status unk" "Number informal helpers"

mat colnames dg_5y_h="Prob dem > 50%" "n" "Cancer" "n" "Heart disease" "n" 

mat list dg_5y_h

frmttable using `logpath'\5-oop_dem_initial_tables, statmat(dg_5y_h) ///
title("Dementia, Cancer and Heart Disease Patients" \ ///
"Average helper burden, last 5 years of life") ///
note("n columns show number of helpers for which we have full information" \ ///
"If hours were missing in dataset, then variable is missing from mean calculation" \ ///
"Hours/month and number of helpers are mean reported over the last 5 years of life") ///
sdec(2) landscape addtable 



*****************************************************************************
//Dementia compared with sudden death and infections disease, 5 year lookback
*****************************************************************************
//get tables comparing mean, median spending for different disease groups
mat dg_cd_5y=J(27,6,.)
//first row n each group
tab pr_dem_gt50, missing matcell(r2_d)
mat dg_cd_5y[1,1]=r2_d[2,1] //with dem prob > 50% col 1
tab cause_death_sudden, missing matcell(r2_s)
mat dg_cd_5y[1,3]=r2_s[2,1] //with cancer col 2
tab cause_death_inf , missing matcell(r2_i)
mat dg_cd_5y[1,5]=r2_i[2,1] //with heart disease col 3


//total mc 2 years, wage index adjusted
local c=1
foreach d in pr_dem_gt50 cause_death_sudden cause_death_inf{
	local r = 2
	foreach v in `spvars5'{
		sum `v' if `d'==1, detail
		mat dg_cd_5y[`r',`c']=r(mean)
		mat dg_cd_5y[`r',`c'+1]=r(p50)
		local r = `r'+1
		}
	local c = `c'+2
	}
	
//convert medicaid rate to percent
forvalues i = 1/6{
mat dg_cd_5y[`r'-1,`i']=dg_cd_5y[`r'-1,`i']*100	
}	

mat rownames dg_cd_5y= "N" "Age at death" "Total Medicare payments" "Medicare IP" "Medicare SNF" "Medicare HH" ///
"Medicare hospice" "Medicare Carrier" "Medicare OP" "Medicare DME" ///
"OOP Total" "OOP Helper" "OOP Hospital" "OOP NH" "OOP Doctor" "OOP Rx" ///
"OOP Insurance Costs" "OOP Other" ///
"Total NH nights, SR or claims" "Nights paid by Medicare" "Nights not Medicare" ///
"OOP Nights, imputed" "Medicaid or private payer nights" "Medicaid NH Payments" ///
"Private payer NH Payments" "Total NH costs, all payers" "Medicaid at death? (percent)"

mat colnames dg_cd_5y="Prob dem > 50%" "median" "Sudden death" "median" "Infect disease" "median"

mat list dg_cd_5y

frmttable using `logpath'\5-oop_dem_initial_tables, statmat(dg_cd_5y) ///
title("Dementia, Sudden death and Infectious diseases Patients" \ ///
"Medicare and OOP Spending Last 5 years of life") ///
note("Medicare spending totals are adjusted for the 2010 CMS wage index" \ ///
"All $ values adjusted for inflation to 2010$" ) ///
sdec(0) landscape addtable


log close


H="Create new variables for disease groups, demo char"
capture log close
clear all
set mem 500m
set more off

local logpath E:\data\hrs_oop_2010\logs
local datapath E:\data\hrs_oop_2010\final_data

log using `logpath'\6-mc_oop_dementia_cleanvars-LOG.txt, text replace

cd `datapath'

//use just sample that meet 2 year criteria (full mc and oop data 2 years from death)
use oop_mc_sample.dta if (age_at_death_e>=67 & part_ab_2y==1 & hmo_2y==0 & ind_24m_oop_yes==1) 

//look at dementia probability sample sizes
gen byte dem_miss_n1 = .
replace dem_miss_n1=1 if prob_dementia_n1==.
replace dem_miss_n1=0 if prob_dementia_n1!=.

gen byte dem_miss_n2 = .
replace dem_miss_n2=1 if prob_dementia_n2==.
replace dem_miss_n2=0 if prob_dementia_n2!=.

tab dem_miss_n1 dem_miss_n2, missing

tab core_year_n1 dem_miss_n1 , missing
tab core_year_n2 dem_miss_n2 , missing

//if missing, carry forward n2 probability
gen prob_dem_n1n2 = prob_dementia_n1
replace prob_dem_n1n2=prob_dementia_n2 if prob_dementia_n1==.

//histogram prob_dem_n1n2

gen miss_prob_dem_n1n2=0
replace miss_prob_dem_n1n2=1 if prob_dem_n1n2==.
tab miss_prob_dem_n1n2, missing

tab exit_year_x core_year_n1 if prob_dem_n1n2==.
tab core_year_n1 core_year_n2 if prob_dem_n1n2==.

//look at those missing dementia probability, why is this the case?
//dementia prob only calculated if age>=70 at the interview
gen age_at_n1_ivw = (c_ivw_date_n1 - birth_date_e)/365.25

gen byte age_n1_lt70 = .
replace age_n1_lt70 = 1 if age_at_n1_ivw < 70
replace age_n1_lt70 = 0 if age_at_n1_ivw >=70 & age_at_n1_ivw!=.

// n=318 of 402 missing dementia were younger than 70 at the n1 ivw
// n=23 had no n1 or n2 interview
// n=61 are left
tab age_n1_lt70 miss_prob_dem_n1n2, missing

// of n=61, n=49 had their n1 interview in 2008 so prob not imputed in 2008
tab core_year_n1 if miss_prob_dem_n1n2==1 & age_n1_lt70==0, missing

// n=23 with age at n1 do not have an n1 interview
tab c_ivw_date_n1 if age_at_n1_ivw==., missing
tab birth_date_e if age_at_n1_ivw==., missing
tab exit_year_x core_year_n1 if age_at_n1_ivw==., missing
tab ind_24m_oop_yes if age_at_n1_ivw==., missing
tab months_x if age_at_n1_ivw==., missing

gen age_at_n2_ivw = (c_ivw_date_n2 - birth_date_e)/365.25

gen byte age_n2_lt70 = .
replace age_n2_lt70 = 1 if age_at_n2_ivw < 70
replace age_n2_lt70 = 0 if age_at_n2_ivw >=70 & age_at_n2_ivw!=.

tab age_n2_lt70 miss_prob_dem_n1n2, missing
//n=78 have no n2 core interview

//of n=49 w/ n1 ivw in 2008
//n=3 have no n2 interview, n=39 are less than 70 at n2 interview
//remaining n=7 are 70+ at n2 ivw and core n1 is 2006, not sure why these 7 don't have the n2 dementia prob
tab age_n2_lt70 if miss_prob_dem_n1n2==1 & age_n1_lt70==0 & core_year_n1==2008, missing
tab core_year_n2 if miss_prob_dem_n1n2==1 & age_n1_lt70==0 & core_year_n1==2008 & age_n2_lt70==0, missing

//look at other variables relating to dementia - cause of death
la def cause_death 1 "Infectious disease" 2 "HIV/AIDS" ///
3 "Cardiovascular disease" 4 "Chronic lower resperiatory disease" ///
5 "Other Respiratory disease" 6 "Diabetes" 7 "Alzheimers Disease" ///
8 "N/A" 9 "Neoplasms" 10 "Kidney Disease (not infectious)" ///
11 "Liver, Gallbladder, Stomach and/or Intestinal disease" ///
12 "Accidents, Suicide, Homicide" 13 "Other" ///
14 "Unknown (coded as 999 in original data)"
la val cause_death_12_n_e cause_death 

replace cause_death_12_n_e=14 if cause_death_12_n_e==.

tab cause_death_12_n_e , missing

//n=8 of 402 have cause of death=dementia so assign to dementia group?
tab cause_death_12_n_e miss_prob_dem_n1n2, missing

//tics score
gen tics_cat_n1 = .
replace tics_cat_n1 = 1 if (tics_tot_n1 > 8 & tics_tot_n1~=.)
replace tics_cat_n1 = 2 if (tics_tot_n1 >= 5 & tics_tot_n1 <= 8)
replace tics_cat_n1 = 3 if (tics_tot_n1 <= 4 & tics_tot_n1~=.)
la var tics_cat_n1 "TICS, n1 ivw - categorical"
la def tics_cat_n1 1 "9-35 Normal" 2 "5-8 MCI" 3 "0-4 Demented"
la val tics_cat_n1 tics_cat_n1
tab tics_cat_n1 miss_prob_dem_n1n2, missing //note that score is missing for proxy ivws
//n=1 has demented, n=4 has MCI from tics score categories n1 ivw
tab tics_cat_n1 miss_prob_dem_n1n2 if cause_death_12_n_e~=7, missing

gen tics_cat_n2 = .
replace tics_cat_n2 = 1 if (tics_tot_n2 > 8 & tics_tot_n2~=.)
replace tics_cat_n2 = 2 if (tics_tot_n2 >= 5 & tics_tot_n2 <= 8)
replace tics_cat_n2 = 3 if (tics_tot_n2 <= 4 & tics_tot_n2~=.)
la var tics_cat_n2 "TICS, n2 ivw - categorical"
la def tics_cat_n2 1 "9-35 Normal" 2 "5-8 MCI" 3 "0-4 Demented"
la val tics_cat_n2 tics_cat_n2
tab tics_cat_n2 miss_prob_dem_n1n2, missing //note that score is missing for proxy ivws

//n=1 has tics in n2 indicating dementia where cause death and n1 tics
//does not identify dementia
tab tics_cat_n2 miss_prob_dem_n1n2 if cause_death_12_n_e~=7 & tics_cat_n1==., missing
tab tics_cat_n2 miss_prob_dem_n1n2 if cause_death_12_n_e~=7 & tics_cat_n1==1, missing

//self report memory disease diagnosis

tab memory_hrs_x miss_prob_dem_n1n2, missing
//n=22 had proxy report of memory disease in exit interview
tab memory_hrs_x if miss_prob_dem_n1n2==1 & cause_death_12_n_e~=7 & tics_cat_n1==1, missing
tab memory_hrs_n1 miss_prob_dem_n1n2, missing
//n=3 self report memory disease in n1 ivw (but don't have it reported in exit)
tab memory_hrs_n1 if miss_prob_dem_n1n2==1 & cause_death_12_n_e~=7 & tics_cat_n1==1 & memory_hrs_x==0, missing
tab memory_hrs_n2 miss_prob_dem_n1n2, missing

tab memory_hrs_x memory_hrs_n1 if miss_prob_dem_n1n2==1, missing
//could potentially assign 8 + 5 + 1 + 22 + 3=39 of the 402 missing dementia prob to the dementia group

**************************************************************
//Disease group categories
**************************************************************
gen byte pr_dem_gt50 = .
replace pr_dem_gt50 = 0 if prob_dem_n1n2<=.5 & prob_dem_n1n2!=.
replace pr_dem_gt50 = 1 if prob_dem_n1n2>.5 & prob_dem_n1n2!=.
la var pr_dem_gt50 "Indicator dementia prob gt 0.5"
tab pr_dem_gt50, missing
tab cause_death_12_n_e pr_dem_gt50 , missing

//cancer as cause of death
gen byte cancer_grp = 0
replace cancer_grp=1 if cause_death_12_n_e==9 & pr_dem_gt50!=1
la var cancer_grp "Indicator cancer, per cause of death)"
tab cancer_grp, missing

//heart disease as cause of death
gen byte heartdis_grp  = 0
replace heartdis_grp =1 if cause_death_12_n_e==3 & pr_dem_gt50!=1
la var heartdis_grp  "Indicator heart disease, per cause of death)"
tab heartdis_grp , missing

//other group
gen byte other_grp = 0
replace other_grp=1 if inlist(pr_dem_gt50,0,.) & cancer_grp==0 & heartdis_grp==0
la var other_grp "Comparison group, other cause of death"
tab other_grp, missing

//categorical variable for disease groups
gen dis_group_cat = .
replace dis_group_cat=1 if pr_dem_gt50==1
replace dis_group_cat=2 if cancer_grp==1
replace dis_group_cat=3 if heartdis_grp==1
replace dis_group_cat=4 if other_grp==1
la var dis_group_cat "Disease group, categorical"
la def dis_group_cat 1 "Dementia" 2 "Cancer" 3 "Heart disease" 4 "Other"
la val dis_group_cat dis_group_cat
tab dis_group_cat, missing

// 1 obs has no price assigned because Puerto Rico resident, therefore, drop from sample
drop if nh_cost_medicaid_24m==.

//total nursing home payments
//11 obs don't have full oop data 5 year so that's why missing obs
gen total_nh_costs_24m=snf_paid_by_mc_24m_wi+nh_oop_24m+nh_cost_medicaid_24m+nh_cost_private_24m
gen total_nh_costs_60m=snf_paid_by_mc_60m_wi+nh_oop_60m+nh_cost_medicaid_60m+nh_cost_private_60m

//imputed informal care replacement costs 
local imp hh_s_cost_ivw_24m hh_u_cost_ivw_24m hh_s_cost_ivw_60m hh_u_cost_ivw_60m
foreach v in `imp'{
replace `v'=0 if `v'==.
}
gen inf_care_costs_24m=hh_s_cost_ivw_24m+hh_u_cost_ivw_24m
gen inf_care_costs_60m=hh_s_cost_ivw_60m+hh_u_cost_ivw_60m

//total payments all types
gen total_costs_24m = tot_paid_by_mc_24m_wi+total_oop_24m+nh_cost_medicaid_24m+nh_cost_private_24m+inf_care_costs_24m
gen total_costs_60m = tot_paid_by_mc_60m_wi+total_oop_60m+nh_cost_medicaid_60m+nh_cost_private_60m+inf_care_costs_60m

****************************************************************
//demo variables set up
****************************************************************
gen age_at_death_cat=.
replace age_at_death_cat=1 if age_at_death_e<75
replace age_at_death_cat=2 if age_at_death_e>=75 & age_at_death_e<80
replace age_at_death_cat=3 if age_at_death_e>=80 & age_at_death_e<85
replace age_at_death_cat=4 if age_at_death_e>=85 & age_at_death_e<90
replace age_at_death_cat=5 if age_at_death_e>=90 & age_at_death_e!=.
la var age_at_death_cat "Age at death, categorical"
la def age_at_death_cat 1"Age 67-74" 2"Age 75-79" 3"Age 80-84" 4"Age 85-89" 5"Age 90+"
la val age_at_death_cat age_at_death_cat
tab age_at_death_cat, missing

gen age_lt75=0
replace age_lt75=1 if age_at_death_cat==1
la var age_lt75 "Age 67-74" 
gen age_75_79=0
replace age_75_79=1 if age_at_death_cat==2
la var age_75_79 "Age 75-79"
gen age_80_84=0
replace age_80_84=1 if age_at_death_cat==3
la var age_80_84 "Age 80-84"
gen age_85_89=0
replace age_85_89=1 if age_at_death_cat==4
la var age_85_89 "Age 85-89"
gen age_gt90=0
replace age_gt90=1 if age_at_death_cat==5
la var age_gt90 "Age 90+"

la def female 0"Male" 1"Female"
la val female_x female
tab female_x, missing

//clean up race/ethnicity variables where can fill in missing, still have 3 miss obs
replace white_e=0 if hisp_eth_e==1 & white_e==.
replace black_e=0 if hisp_eth_e==1 & black_e==.
replace other_na_api_race_e=0 if hisp_eth_e==1 & other_na_api_race_e==.

gen race_eth_cat=.
replace race_eth_cat=1 if hisp_eth_e==1 & white_e~=.
replace race_eth_cat=2 if white_e==1
replace race_eth_cat=3 if black_e==1
replace race_eth_cat=4 if other_na_api_race_e==1
la def race_eth_cat 1"Hispanic" 2"White" 3"Black" 4"Other"
la val race_eth_cat race_eth_cat
tab race_eth_cat, missing

//create clean indicator vars from categorical variable
gen byte hisp_eth=0
replace hisp_eth=1 if race_eth_cat==1

gen byte white=0
replace white=1 if race_eth_cat==2

gen byte black=0
replace black=1 if race_eth_cat==3

gen byte other_re=0
replace other_re=1 if race_eth_cat==4

foreach v in hisp_eth white black other_re{
replace `v'=. if race_eth_cat==.
}

la def yn 0"No" 1"Yes", modify
la val married_x hisp_eth white black other_re yn
tab married_x, missing
tab hisp_eth, missing
tab white, missing
tab black, missing
tab other_re, missing

//education variables
gen educ=educ_n1
replace educ=educ_n2 if educ_n1==.
replace educ=educ_n3 if educ_n1==. & educ_n2==.
label define educ 0 "No Formal Education" 1 "Grades 1-11" 2 "High School" 3 "Some College" 4 "College" ///
      5 "Post College", modify
la val educ educ 
tab educ, missing
 
gen byte educ_lt_hs=.
replace educ_lt_hs=1 if inlist(educ,0,1)
replace educ_lt_hs=0 if inlist(educ,2,3,4,5)
la var educ_lt_hs "Education: Less than high school degree"

gen byte educ_hsdeg=.
replace educ_hsdeg=1 if educ==2
replace educ_hsdeg=0 if educ!=2 & educ!=.
la var educ_hsdeg "Education: High school degree"

gen byte educ_some_coll=.
replace educ_some_coll=1 if educ==3
replace educ_some_coll=0 if educ!=3 & educ!=.
la var educ_some_coll "Education: Some college, not 4 yr degree"

gen byte educ_coll=.
replace educ_coll=1 if inlist(educ,4,5)
replace educ_coll=0 if inlist(educ,0,1,2,3)
la var educ_coll "Education: 4 year College degree+"

tab educ educ_lt_hs , missing
tab educ educ_hsdeg , missing
tab educ educ_some_coll , missing
tab educ educ_coll , missing
***************************************************************************
//create spending category for total government spending
gen tot_gov_pay_24m = tot_paid_by_mc_24m_wi + nh_cost_medicaid_24m 
gen tot_gov_pay_60m = tot_paid_by_mc_60m_wi + nh_cost_medicaid_60m 

la var tot_gov_pay_24m "Government spending 2yr EOL, Medicare+Medicaid NH"
la var tot_gov_pay_60m "Government spending 5yr EOL, Medicare+Medicaid NH"

***************************************************************************
//inflation adjust dartmouth data to 2010 prices from 2007
//also adjust for the 2010 wage index
gen tot_eol_spending_hrr_2010 = tot_eol_spending_hrr*1.11347/wage_index_20102
la var tot_eol_spending_hrr_2010 "Wage index and inflation adj DA EOL spending 2yr"
sum tot_eol_spending_hrr_2010, detail

***************************************************************************
//adjust spending categories for the wage index
local adj_wi helper_oop_24m hospital_oop_24m nh_oop_24m ///
doctor_oop_24m rx_oop_24m insurance_costs_24m other_oop_24m  ///
nh_cost_medicaid_24m nh_cost_private_24m inf_care_costs_24m ///
 helper_oop_60m hospital_oop_60m nh_oop_60m ///
doctor_oop_60m rx_oop_60m insurance_costs_60m other_oop_60m  ///
nh_cost_medicaid_60m nh_cost_private_60m inf_care_costs_60m 

//note 11 missing values are those without full 5 year data, but have full 2 year data
foreach v in `adj_wi'{
gen `v'_wi = `v'/wage_index_20102
sum `v'_wi
}

foreach i in 24 60{
gen total_oop_`i'm_wi = helper_oop_`i'm_wi + hospital_oop_`i'm_wi + nh_oop_`i'm_wi + ///
	doctor_oop_`i'm_wi + rx_oop_`i'm_wi + insurance_costs_`i'm_wi + other_oop_`i'm_wi

gen total_nh_costs_`i'm_wi = snf_paid_by_mc_`i'm_wi + nh_oop_`i'm_wi + nh_cost_medicaid_`i'm_wi + ///
nh_cost_private_`i'm_wi 

gen total_costs_`i'm_wi = tot_paid_by_mc_`i'm_wi + total_oop_`i'm_wi + nh_cost_medicaid_`i'm_wi + ///
nh_cost_private_`i'm_wi + inf_care_costs_`i'm_wi 
}

//verify missingness in wage index adjusted spending is b/c not in 5 year lookback sample
tab ind_sample_5yr if helper_oop_60m_wi==., missing

//create spending category for total government spending
gen tot_gov_pay_24m_wi = tot_paid_by_mc_24m_wi + nh_cost_medicaid_24m_wi 
gen tot_gov_pay_60m_wi = tot_paid_by_mc_60m_wi + nh_cost_medicaid_60m_wi 

la var tot_gov_pay_24m_wi "WI adj Government spending 2yr EOL, Medicare+Medicaid NH"
la var tot_gov_pay_60m_wi "WI adj Government spending 5yr EOL, Medicare+Medicaid NH"


***************************************************************************
//save dataset
save oop_mc_sample_addedvars.dta, replace

***************************************************************************
/*save version of dataset excluding restricted variables/xwalks*/
preserve

drop e_ivw_month_x e_ivw_day_x e_ivw_year_x e_ivw_day_imp_x e_ivw_date_x bid_hrs *_e ///
 c_ivw_month_* c_ivw_day_* c_ivw_year_* c_ivw_day_imp_* c_ivw_date_* hisp_eth white black other_re 

save oop_mc_sample_public.dta, replace

restore

***************************************************************************
log close


H="Mutually exclusive comparison groups"
/*Define the groups as follows:
1. All obs where prob dementia > 50%
2. Of remaining obs, where cause of death = cancer
3. , where cause of death = heart disease
4. Everyone else

2 and 5 year lookbacks 

Note:Sample limited to those with Age 67+ when die, FFS medicare last 2/5 years of life,
full OOP spending data last 2/5 years of life and resident of 50 States + DC (drops PR resident)

For 5 year lookback, sample also drops those observations with missing dementia probability*/

capture log close
clear all
set mem 500m
set more off

local logpath E:\data\hrs_oop_2010\logs
local datapath E:\data\hrs_oop_2010\final_data

log using `logpath'\7-mc_oop_dementia-LOG.txt, text replace

cd `datapath'

//use just sample that meet 2 year criteria (full mc and oop data 2 years from death)
//with new variables added
use oop_mc_sample_addedvars.dta

******************************************************************************
//get tables comparing mean, median spending for different disease groups
mat dg_2y=J(26,8,.)
//first row n each group
tab pr_dem_gt50, missing matcell(r1_50)
mat dg_2y[1,1]=r1_50[2,1] //with dem prob > 50% col 1
tab cancer_grp, missing matcell(r1_c)
mat dg_2y[1,3]=r1_c[2,1] //with cancer col 2
tab heartdis_grp , missing matcell(r1_h)
mat dg_2y[1,5]=r1_h[2,1] //with heart disease col 3
tab other_grp , missing matcell(r1_o)
mat dg_2y[1,7]=r1_o[2,1] //with other disease col 4

//mc vars
local spvars age_at_death_e total_costs_24m tot_gov_pay_24m tot_paid_by_mc_24m_wi ///
ip_paid_by_mc_24m_wi snf_paid_by_mc_24m_wi ///
hh_paid_by_mc_24m_wi hs_paid_by_mc_24m_wi pb_paid_by_mc_24m_wi op_paid_by_mc_24m_wi ///
dm_paid_by_mc_24m_wi total_oop_24m helper_oop_24m hospital_oop_24m nh_oop_24m ///
doctor_oop_24m rx_oop_24m insurance_costs_24m other_oop_24m nh_nights_24m ///
nh_cost_medicaid_24m nh_cost_private_24m total_nh_costs_24m inf_care_costs_24m ///
medicaid_x

//totals 2 years, wage index adjusted mc payments, oop spend and nh nights
local c=1
foreach d in pr_dem_gt50 cancer_grp heartdis_grp other_grp{
	local r = 2
	foreach v in `spvars'{
		sum `v' if `d'==1, detail
		mat dg_2y[`r',`c']=r(mean)
		mat dg_2y[`r',`c'+1]=r(p50)
		local r = `r'+1
		}
	local c = `c'+2
	}
//convert medicaid rate to percent
forvalues i = 1/8{
mat dg_2y[`r'-1,`i']=dg_2y[`r'-1,`i']*100	
}	
	
mat rownames dg_2y= "N" "Age at death" "Total payments, all types" "Total government payments" "Total Medicare payments" ///
"Medicare IP" "Medicare SNF" "Medicare HH" ///
"Medicare Hospice" "Medicare Carrier" "Medicare OP" "Medicare DME" ///
"OOP Total" "OOP Helper" "OOP Hospital" "OOP NH" "OOP Doctor" "OOP Rx" ///
"OOP Insurance Costs" "OOP Other" ///
"Total NH nights, SR or claims" "Medicaid NH Payments" ///
"Private payer NH Payments" "Total NH costs, all payers" "Imputed informal care costs" "Medicaid at death? (percent)"

mat list dg_2y

frmttable using `logpath'\7-oop_dem_tables, statmat(dg_2y) ///
title("Dementia, Cancer and Heart Disease Patients, Medicare and OOP Spending Last 2 years of life") ///
note("Medicare spending totals are adjusted for the 2010 CMS wage index" \ ///
"All $ values adjusted for inflation to 2010$" \ ///
"Total government payments = Medicare + Medicaid nursing home" \ ///
"Total NH spending = Medicare + OOP + Medicaid or Private Payer" \ ///
"Informal caregivers are spouses and other unpaid (mainly children), replacemnt wage imputation")  ///
ctitles("" "Prob dem" " > 50%" "Cancer" "" "Heart disease" "" "Other" "" \ ///
"" "Mean" "Median" "Mean" "Median" "Mean" "Median" "Mean" "Median" ) ///
sdec(0) landscape replace 

******************************************************************************
//Table looking at imputations, 2 year look back
******************************************************************************
//n=400 have missing helper information
sum hlphrs_p_24m
sum hlphrs_d_24m

//for hours/month variables and number of helpers, if missing, set to 0 prior to 
//creating the table
local setzero hlphrs_d_24m hlphrs_m_24m n_d_24m n_m_24m hlphrs_s_24m hlphrs_u_24m ///
n_s_24m n_u_24m hlphrs_p_24m
foreach v in `setzero'{
replace `v'=0 if `v'==.
}

gen hlphrs_dm_24m=hlphrs_d_24m+hlphrs_m_24m
gen n_dm_24m=n_d_24m+n_m_24m

gen hlphrs_informal_24m=hlphrs_s_24m+hlphrs_u_24m
gen n_informal_24m=n_s_24m+n_u_24m
gen hlpmonths_inf_24m=s_months_used_24m+u_months_used_24m

local ivars nh_nights_24m los_snf_paid_by_mc_ivw_24m nh_ni_not_mc_24m ///
oop_nh_nights_24m other_nh_nights_24m total_nh_costs_24m ///
snf_paid_by_mc_24m_wi nh_oop_24m nh_cost_medicaid_24m nh_cost_private_24m ///
hlphrs_p_24m hlphrs_dm_24m oop_months_used_24m helper_oop_24m helper_oop_old_24m ///
hlphrs_s_24m s_months_used_24m hlphrs_u_24m u_months_used_24m hlphrs_informal_24m ///
hlpmonths_inf_24m inf_care_costs_24m 



//get tables comparing mean, median variables for imputations for different disease groups
mat imp_2y=J(23,8,.)
//first row n each group
tab pr_dem_gt50, missing matcell(r1_50)
mat imp_2y[1,1]=r1_50[2,1] //with dem prob > 50% col 1
tab cancer_grp, missing matcell(r1_c)
mat imp_2y[1,3]=r1_c[2,1] //with cancer col 2
tab heartdis_grp , missing matcell(r1_h)
mat imp_2y[1,5]=r1_h[2,1] //with heart disease col 3
tab other_grp , missing matcell(r1_o)
mat imp_2y[1,7]=r1_o[2,1] //with other disease col 4

//2 year lookback, variables to get imputed costs
local c=1
foreach d in pr_dem_gt50 cancer_grp heartdis_grp other_grp{
	local r = 2
	foreach v in `ivars'{
		sum `v' if `d'==1, detail
		mat imp_2y[`r',`c']=r(mean)
		mat imp_2y[`r',`c'+1]=r(p50)
		local r = `r'+1
		}
	local c = `c'+2
	}

mat rownames imp_2y="N" "Total nursing home nights" "NH nights paid by MC" ///
"Non-medicare nights" "Imputed OOP nights" "Remaining nights" "Total NH Payments" ///
"SNF Medicare payments" "OOP Payments" "Medicaid payments" "Private payer NH" ///
"Paid helpers hrs/month" "Unk paid ,imp in OOP, hrs/mo" "OOP helper months" ///
"Adjusted OOP Helper costs" "Orig OOP Helper costs" "Spouse helper hrs/mo" ///
"S helper months attributed" "Other unpaid helper hrs/mo" "other unpaid helper months" ///
"Informal helpers hours/mo" "Informal helpers months" "Imp replacement cost infor help" ///


frmttable using `logpath'\7-oop_dem_tables, statmat(imp_2y) ///
title("Dementia, Cancer and Heart Disease Patients, Imputations Spending Last 2 years of life") ///
note("Medicare spending totals are adjusted for the 2010 CMS wage index" \ ///
"All $ values adjusted for inflation to 2010$" \ ///
"Total NH spending = Medicare + OOP + Medicaid or Private Payer" \ ///
"Informal caregivers are spouses and other unpaid (mainly children), replacement wage imputation")  ///
ctitles("" "Prob dem" " > 50%" "Cancer" "" "Heart disease" "" "Other" "" \ ///
"" "Mean" "Median" "Mean" "Median" "Mean" "Median" "Mean" "Median" ) ///
sdec(0) landscape addtable

//note, for helper imputation, need to bring months help received in
//will be 4 for many, but then with continous care, get help accounted for
//over much longer span of time!

******************************************************************************
//Demo, missing dementia for subgroups
******************************************************************************
mat demo_2y=J(19,5,.)
//first row n each group
sum exit_year_x
mat demo_2y[1,1]=r(N) //overall sample, all groups
tab pr_dem_gt50, missing matcell(r1_50)
mat demo_2y[1,2]=r1_50[2,1] //with dem prob > 50% col 1
tab cancer_grp, missing matcell(r1_c)
mat demo_2y[1,3]=r1_c[2,1] //with cancer col 2
tab heartdis_grp , missing matcell(r1_h)
mat demo_2y[1,4]=r1_h[2,1] //with heart disease col 3
tab other_grp , missing matcell(r1_o)
mat demo_2y[1,5]=r1_o[2,1] //with other disease col 4

//mc vars
local dvars age_lt75 age_75_79 age_80_84 age_85_89 age_gt90 ///
female_x married_x hisp_eth white black other_re educ_lt_hs educ_hsdeg ///
educ_some_coll educ_coll miss_prob_dem_n1n2

//2 year look back , full sample
local c = 1
local r = 2
sum age_at_death_e , detail
		mat demo_2y[`r',`c']=r(mean)
		mat demo_2y[`r'+1,`c']=r(p50)
local r = 4		
	foreach v in `dvars'{
		sum `v' , detail
		mat demo_2y[`r',`c']=r(mean)
		local r = `r'+1
		}


//2 year look back sample, by disease groups
local c=2
foreach d in pr_dem_gt50 cancer_grp heartdis_grp other_grp{
	local r = 2
	sum age_at_death_e  if `d'==1, detail
		mat demo_2y[`r',`c']=r(mean)
		mat demo_2y[`r'+1,`c']=r(p50)
	local r = 4		
	foreach v in `dvars'{
		sum `v' if `d'==1, detail
		mat demo_2y[`r',`c']=r(mean)
		local r = `r'+1
		}
	local c = `c'+1
	}
	
mat rownames demo_2y= "N" "Age at death, mean" "Median age" "Age 67-74" "Age 75-79" "Age 80-84" "Age 85-89" "Age 90+" ///
"Female" "Married at time of death" "Hispanic ethnicity" "White" "Black" "Other race/ethnicity" ///
"Less than HS educ" "HS degree" "Some college, not 4yr deg" "College grad" "Missing dementia probability"

mat list demo_2y

frmttable using `logpath'\7-oop_dem_tables, statmat(demo_2y) ///
title("Dementia, Cancer and Heart Disease Patients, Demo characteristics, 2 year lookback sample") ///
note("n=3 obs missing race/ethnicity, n=26 missing education attainment") ///
ctitles("" "Full Sample" "Prob dem > 50%" "Cancer" "Heart disease" "Other") ///
sdec(0 \ 1 \ 0 \ 3) landscape addtable

******************************************************************************
//Last 5 years spending
******************************************************************************

keep if part_ab_5y==1 & hmo_5y==0 & ind_60m_oop_yes==1 & age_at_death_e>=70

******************************************************************************
//Who is missing probability of dementia in this sample?
******************************************************************************
mat md=J(6,2,.)
sum exit_year_x
mat md[1,1]=r(N) //overall sample n

tab miss_prob_dem_n1n2, missing matcell(md1)
mat md[2,1]=md1[2,1] //n missing dementia
mat md[2,2]=md[2,1]/md[1,1]*100 //percent

tab age_n1_lt70 if miss_prob_dem_n1n2==1, missing matcell(md2)
mat md[3,1]=md2[2,1] //n age < 70 at n1 interview
mat md[3,2]=md[3,1]/md[2,1]*100 //percent
mat md[4,1]=md2[3,1] //n where exit months>60, so no n1 interview pulled (confirmed by next tabs)
mat md[4,2]=md[4,1]/md[2,1]*100

tab core_year_n1 if miss_prob_dem_n1n2==1, missing
tab months_x exit_year_x if  core_year_n1==. & miss_prob_dem_n1n2==1, missing

tab core_year_n1 if age_n1_lt70==0 & miss_prob_dem_n1n2==1, missing

tab age_n2_lt70 if age_n1_lt70==0 & miss_prob_dem_n1n2==1 & core_year_n1==2008, missing matcell(md3)
mat md[5,1]=md3[2,1] //n where 2008 n1 interview, less than 70 at n2 ivw
mat md[5,2]=md[5,1]/md[2,1]*100

//remaining are just missing, not in the Hurd dataset and don't know why, maybe missing contributing variables?
mat md[6,1]=md[2,1]-md[3,1]-md[4,1]-md[5,1]
mat md[6,2]=md[6,1]/md[2,1]*100

frmttable using `logpath'\7-oop_dem_tables, statmat(md) ///
title("Missing dementia probability - 5 year lookback sample") ///
ctitles("" "n" "percent" ) ///
rtitles("Overall sample" \ "Missing dementia" \ "Age < 70 at n1 interview" \ ///
"No core interview, exit months > 60" \ "2008 n1 interview and age < 70 at n2 ivw" \ ///
"Missing from Hurd dataset for unknown reasons" ) ///
sdec(0,2) landscape addtable 

drop if miss_prob_dem_n1n2==1

******************************************************************************
//Table last 5 years spending
******************************************************************************
//get tables comparing mean, median spending for different disease groups
mat dg_5y=J(26,8,.)
//first row n each group
tab pr_dem_gt50, missing matcell(r1_50)
mat dg_5y[1,1]=r1_50[2,1] //with dem prob > 50% col 1
tab cancer_grp, missing matcell(r1_c)
mat dg_5y[1,3]=r1_c[2,1] //with cancer col 2
tab heartdis_grp , missing matcell(r1_h)
mat dg_5y[1,5]=r1_h[2,1] //with heart disease col 3
tab other_grp , missing matcell(r1_o)
mat dg_5y[1,7]=r1_o[2,1] //with other disease col 4

//mc vars
local spvars_5y age_at_death_e total_costs_60m tot_gov_pay_60m tot_paid_by_mc_60m_wi ///
ip_paid_by_mc_60m_wi snf_paid_by_mc_60m_wi ///
hh_paid_by_mc_60m_wi hs_paid_by_mc_60m_wi pb_paid_by_mc_60m_wi op_paid_by_mc_60m_wi ///
dm_paid_by_mc_60m_wi total_oop_60m helper_oop_60m hospital_oop_60m nh_oop_60m ///
doctor_oop_60m rx_oop_60m insurance_costs_60m other_oop_60m nh_nights_60m ///
nh_cost_medicaid_60m nh_cost_private_60m total_nh_costs_60m ///
inf_care_costs_60m medicaid_x

//totals 5 years, wage index adjusted mc payments, oop spend and nh nights
local c=1
foreach d in pr_dem_gt50 cancer_grp heartdis_grp other_grp{
	local r = 2
	foreach v in `spvars_5y'{
		sum `v' if `d'==1, detail
		mat dg_5y[`r',`c']=r(mean)
		mat dg_5y[`r',`c'+1]=r(p50)
		local r = `r'+1
		}
	local c = `c'+2
	}
//convert medicaid rate to percent
forvalues i = 1/8{
mat dg_5y[`r'-1,`i']=dg_5y[`r'-1,`i']*100	
}	
	
mat rownames dg_5y= "N" "Age at death" "Total payments, all types" "Total government payments" "Total Medicare payments" ///
 "Medicare IP" "Medicare SNF" "Medicare HH" ///
"Medicare Hospice" "Medicare Carrier" "Medicare OP" "Medicare DME" ///
"OOP Total" "OOP Helper" "OOP Hospital" "OOP NH" "OOP Doctor" "OOP Rx" ///
"OOP Insurance Costs" "OOP Other" ///
"Total NH nights, SR or claims" "Medicaid NH Payments" ///
"Private payer NH Payments" "Total NH costs, all payers" "Imputed informal care costs" "Medicaid at death? (percent)"

mat list dg_5y

frmttable using `logpath'\7-oop_dem_tables, statmat(dg_5y) ///
title("Dementia, Cancer and Heart Disease Patients, Medicare and OOP Spending Last 5 years of life") ///
note("Medicare spending totals are adjusted for the 2010 CMS wage index" \ ///
"All $ values adjusted for inflation to 2010$" \ ///
"Total government payments = Medicare + Medicaid nursing home" \ ///
"Total NH spending = Medicare + OOP + Medicaid or Private Payer" \ ///
"Informal caregivers are spouses and other unpaid (mainly children), replacement wage imputation")  ///
ctitles("" "Prob dem" " > 50%" "Cancer" "" "Heart disease" "" "Other" "" \ ///
"" "Mean" "Median" "Mean" "Median" "Mean" "Median" "Mean" "Median" ) ///
sdec(0) landscape addtable 

******************************************************************************
//Table looking at imputations, 5 year look back
******************************************************************************
//n=306 have missing helper information
sum hlphrs_p_60m
sum hlphrs_d_60m
sum hlphrs_m_60m

//for hours/month variables and number of helpers, if missing, set to 0 prior to 
//creating the table
local setzero hlphrs_d_60m hlphrs_m_60m n_d_60m n_m_60m hlphrs_s_60m hlphrs_u_60m ///
n_s_60m n_u_60m hlphrs_p_60m
foreach v in `setzero'{
replace `v'=0 if `v'==.
}

gen hlphrs_dm_60m=hlphrs_d_60m+hlphrs_m_60m
gen n_dm_60m=n_d_24m+n_m_60m

gen hlphrs_informal_60m=hlphrs_s_60m+hlphrs_u_60m
gen n_informal_60m=n_s_24m+n_u_60m
gen hlpmonths_inf_60m=s_months_used_60m+u_months_used_60m

local ivars nh_nights_60m los_snf_paid_by_mc_ivw_60m nh_ni_not_mc_60m ///
oop_nh_nights_60m other_nh_nights_60m total_nh_costs_60m ///
snf_paid_by_mc_60m_wi nh_oop_60m nh_cost_medicaid_60m nh_cost_private_60m ///
hlphrs_p_60m hlphrs_dm_60m oop_months_used_60m helper_oop_60m helper_oop_old_60m ///
hlphrs_s_60m s_months_used_60m hlphrs_u_60m u_months_used_60m hlphrs_informal_60m ///
hlpmonths_inf_60m inf_care_costs_60m 
  

//get tables comparing mean, median variables for imputations for different disease groups
mat imp_5y=J(23,8,.)
//first row n each group
tab pr_dem_gt50, missing matcell(r1_50)
mat imp_5y[1,1]=r1_50[2,1] //with dem prob > 50% col 1
tab cancer_grp, missing matcell(r1_c)
mat imp_5y[1,3]=r1_c[2,1] //with cancer col 2
tab heartdis_grp , missing matcell(r1_h)
mat imp_5y[1,5]=r1_h[2,1] //with heart disease col 3
tab other_grp , missing matcell(r1_o)
mat imp_5y[1,7]=r1_o[2,1] //with other disease col 4

//2 year lookback, variables to get imputed costs
local c=1
foreach d in pr_dem_gt50 cancer_grp heartdis_grp other_grp {
	local r = 2
	foreach v in `ivars'{
		sum `v' if `d'==1, detail
		mat imp_5y[`r',`c']=r(mean)
		mat imp_5y[`r',`c'+1]=r(p50)
		local r = `r'+1
		}
	local c = `c'+2
	}

mat rownames imp_5y="N" "Total nursing home nights" "NH nights paid by MC" ///
"Non-medicare nights" "Imputed OOP nights" "Remaining nights" "Total NH Payments" ///
"SNF Medicare payments" "OOP Payments" "Medicaid payments" "Private payer NH" ///
"Paid helpers hrs/month" "Unk paid ,imp in OOP, hrs/mo" "OOP helper months" ///
"Adjusted OOP Helper costs" "Orig OOP Helper costs" "Spouse helper hrs/mo" ///
"S helper months attributed" "Other unpaid helper hrs/mo" "other unpaid helper months" ///
"Informal helpers hours/mo" "Informal helpers months" "Imp replacement cost infor help" ///


frmttable using `logpath'\7-oop_dem_tables, statmat(imp_5y) ///
title("Dementia, Cancer and Heart Disease Patients, Imputations Spending Last 5 years of life") ///
note("Medicare spending totals are adjusted for the 2010 CMS wage index" \ ///
"All $ values adjusted for inflation to 2010$" \ ///
"Total NH spending = Medicare + OOP + Medicaid or Private Payer" \ ///
"Informal caregivers are spouses and other unpaid (mainly children), replacement wage imputation")  ///
ctitles("" "Prob dem" " > 50%" "Cancer" "" "Heart disease" "" "Other" "" \ ///
"" "Mean" "Median" "Mean" "Median" "Mean" "Median" "Mean" "Median" ) ///
sdec(0) landscape addtable

******************************************************************************
//Demo for subgroups
******************************************************************************
mat demo_5y=J(18,5,.)
//first row n each group
sum exit_year_x
mat demo_5y[1,1]=r(N) //overall sample, all groups
tab pr_dem_gt50, missing matcell(r1_50)
mat demo_5y[1,2]=r1_50[2,1] //with dem prob > 50% col 1
tab cancer_grp, missing matcell(r1_c)
mat demo_5y[1,3]=r1_c[2,1] //with cancer col 2
tab heartdis_grp , missing matcell(r1_h)
mat demo_5y[1,4]=r1_h[2,1] //with heart disease col 3
tab other_grp , missing matcell(r1_o)
mat demo_5y[1,5]=r1_o[2,1] //with other disease col 4

//mc vars
local dvars age_lt75 age_75_79 age_80_84 age_85_89 age_gt90 ///
female_x married_x hisp_eth white black other_re educ_lt_hs educ_hsdeg ///
educ_some_coll educ_coll 

//5 year look back , full sample
local c = 1
local r = 2
sum age_at_death_e , detail
		mat demo_5y[`r',`c']=r(mean)
		mat demo_5y[`r'+1,`c']=r(p50)
local r = 4		
	foreach v in `dvars'{
		sum `v' , detail
		mat demo_5y[`r',`c']=r(mean)
		local r = `r'+1
		}


//5 year look back sample, by disease groups
local c=2
foreach d in pr_dem_gt50 cancer_grp heartdis_grp other_grp{
	local r = 2
	sum age_at_death_e  if `d'==1, detail
		mat demo_5y[`r',`c']=r(mean)
		mat demo_5y[`r'+1,`c']=r(p50)
	local r = 4		
	foreach v in `dvars'{
		sum `v' if `d'==1, detail
		mat demo_5y[`r',`c']=r(mean)
		local r = `r'+1
		}
	local c = `c'+1
	}
	
mat rownames demo_5y= "N" "Age at death, mean" "Median age" "Age 70-74" "Age 75-79" "Age 80-84" "Age 85-89" "Age 90+" ///
"Female" "Married at time of death" "Hispanic ethnicity" "White" "Black" "Other race/ethnicity" ///
"Less than HS educ" "HS degree" "Some college, not 4yr deg" "College grad"

mat list demo_5y

frmttable using `logpath'\7-oop_dem_tables, statmat(demo_5y) ///
title("Dementia, Cancer and Heart Disease Patients, Demo characteristics, 5 year lookback sample") ///
note("n=3 obs missing education attainment") ///
ctitles("" "Full Sample" "Prob dem > 50%" "Cancer" "Heart disease" "Other") ///
sdec(0 \ 1 \ 0 \ 3) landscape addtable


******************************************************************************
log close


H="Quintiles Medicare spending last 2 years"
/*Divides into quintiles by total Medicare spending last 2 years of life

2 year lookbacks 

Note:Sample limited to those with Age 67+ when die, FFS medicare last 2 years of life,
 resident of 50 States + DC (drops PR resident)

Check 2 year lookback calculated Medicare spending quintiles in our dataset
with that using the Dartmouth Atlas 2 year lookback spending at the HRR level
to see if we have similar distributions

Try to get as close to the same sample as possible so do not
require full OOP data in order to be includedi in the sample for this
comparison*/

capture log close
clear all
set mem 500m
set more off

local logpath E:\data\hrs_oop_2010\logs
local datapath E:\data\hrs_oop_2010\final_data

log using `logpath'\8-mc_oop_dementia_quintiles_2yr-LOG.txt, text replace

cd `datapath'

//use just sample that meet 2 year criteria (full mc 2 years from death)
//with new variables added
use oop_mc_sample_addedvars.dta if part_ab_2y==1 & hmo_2y==0 /*& ind_24m_oop_yes==1*/ & age_at_death_e>=67
*******************************************************
tab exit_year_x, missing

//dartmouth eol spending hrr level averages, no adjustments made
sum tot_eol_spending_hrr, detail

//calculated eol spending 2 year, individual level, before wage index adjustment
sum tot_paid_by_mc_24m, detail

//dartmouth data is adjusted for gender, age, race, chronic condition
//use dartmouth atlas list of chronic conditions as a start, elixhauser index
//Malignant Cancer/Leukemia 17+18
//CHF 1
//Chronic Pulmonary Disease 4
//Dementia 31
//Diabetes with end organ damage 11
//Peripheral vascular disease 5
//Chronic renal failure 13
//Severe Chronic Liver Disease 14
//CAD 32
//this isn't ideal because they also categorize patients by their primary
//comorbidity which I do not have coded now...
gen comorb_da_total = comorb_17_0d_n24m + comorb_18_0d_n24m + comorb_1_0d_n24m + ///
comorb_4_0d_n24m + comorb_31_0d_n24m + comorb_11_0d_n24m + comorb_5_0d_n24m + ///
comorb_13_0d_n24m + comorb_14_0d_n24m + comorb_32_0d_n24m
tab comorb_da_total, missing

gen byte comorb_da_yes = 1
replace comorb_da_yes = 0 if comorb_da_total==0
tab comorb_da_yes , missing

//adjust HRS claims eol spending for age, gender, race, comorbidities to be more
//comparable to the Dartmouth Atlas data
//note areg, absorb(comorb_da_total) command runs a linear regressing, treating each
//value of comorb_da_total as an indicator variable so this controls for count of
//comorbidities as well as age, gender and race
egen mean_mc_24m=mean(tot_paid_by_mc_24m)

areg tot_paid_by_mc_24m age_at_death_e female_x white  ///
comorb_17_0d_n24m comorb_18_0d_n24m comorb_1_0d_n24m  ///
comorb_4_0d_n24m comorb_31_0d_n24m comorb_11_0d_n24m comorb_5_0d_n24m ///
comorb_13_0d_n24m comorb_14_0d_n24m comorb_32_0d_n24m, absorb(comorb_da_total)

predict resid_mc, d 
//3 missing values generated, b/c missing race

gen adj_mc_24m= mean_mc_24m +resid_mc
la var adj_mc_24m "Medicare spending 2yr, adjusted for age, sex ,race and comorbidities"
sum adj_mc_24m, detail 
sum adj_mc_24m if hrrnum!=., detail

//dartmouth eol spending, for same sample
sum tot_eol_spending_hrr if white!=., detail

//unadjusted HRS claims totals for comparison
sum tot_paid_by_mc_24m, detail

//get hhr level means of adjusted spending using HRS claims to compare w/ DA data
//use if criteria so don't generate values where we don't have the adjusted
//2 year medicare spending
egen mean_adj_mc_24m=mean(adj_mc_24m) if white!=. & hrrnum!=. , by(hrrnum)

sum mean_adj_mc_24m , detail
sum tot_eol_spending_hrr if white!=., detail

************************************************************
//quintile of adjusted 2yr spending, HRS sample
sort mean_adj_mc_24m

//calculate quintiles
centile mean_adj_mc_24m , centile(20(20)80)
sca m_qui_20=r(c_1)
sca m_qui_40=r(c_2)
sca m_qui_60=r(c_3)
sca m_qui_80=r(c_4)

gen quintile_adj_mc_mean_2yr=.
replace quintile_adj_mc_mean_2yr=1 if mean_adj_mc_24m <=m_qui_20 & mean_adj_mc_24m <.
replace quintile_adj_mc_mean_2yr=2 if mean_adj_mc_24m >m_qui_20 & mean_adj_mc_24m <=m_qui_40
replace quintile_adj_mc_mean_2yr=3 if mean_adj_mc_24m >m_qui_40 & mean_adj_mc_24m <=m_qui_60
replace quintile_adj_mc_mean_2yr=4 if mean_adj_mc_24m >m_qui_60 & mean_adj_mc_24m <=m_qui_80
replace quintile_adj_mc_mean_2yr=5 if mean_adj_mc_24m >m_qui_80 & mean_adj_mc_24m <.
tab quintile_adj_mc_mean_2yr, missing
la var quintile_adj_mc_mean_2yr"Quintiles of 2 year EOL Medicare Spending HRS sample, mean HRR level"

sum mean_adj_mc_24m if quintile_adj_mc_mean_2yr==1
sum mean_adj_mc_24m if quintile_adj_mc_mean_2yr==2
sum mean_adj_mc_24m if quintile_adj_mc_mean_2yr==3
sum mean_adj_mc_24m if quintile_adj_mc_mean_2yr==4
sum mean_adj_mc_24m if quintile_adj_mc_mean_2yr==5

************************************************************
//quintile of DA 2 year eol spending
sort tot_eol_spending_hrr

//calculate quintiles
centile tot_eol_spending_hrr , centile(20(20)80)
sca d_qui_20=r(c_1)
sca d_qui_40=r(c_2)
sca d_qui_60=r(c_3)
sca d_qui_80=r(c_4)

gen quintile_DA_2yr=.
replace quintile_DA_2yr=1 if  tot_eol_spending_hrr <=d_qui_20 & tot_eol_spending_hrr <.
replace quintile_DA_2yr=2 if  tot_eol_spending_hrr >d_qui_20 & tot_eol_spending_hrr <=d_qui_40
replace quintile_DA_2yr=3 if  tot_eol_spending_hrr >d_qui_40 & tot_eol_spending_hrr <=d_qui_60
replace quintile_DA_2yr=4 if  tot_eol_spending_hrr >d_qui_60 & tot_eol_spending_hrr <=d_qui_80
replace quintile_DA_2yr=5 if  tot_eol_spending_hrr >d_qui_80 & tot_eol_spending_hrr <.
tab quintile_DA_2yr, missing
la var quintile_DA_2yr"Quintiles of 2 year DA EOL Medicare Spending, mean HRR level (within this sample)"

sum tot_eol_spending_hrr if quintile_DA_2yr==1
sum tot_eol_spending_hrr if quintile_DA_2yr==2
sum tot_eol_spending_hrr if quintile_DA_2yr==3
sum tot_eol_spending_hrr if quintile_DA_2yr==4
sum tot_eol_spending_hrr if quintile_DA_2yr==5
************************************************************
//difference in quintiles??
gen quint_diff = quintile_adj_mc_mean_2yr-quintile_DA_2yr
tab quint_diff , missing

histogram quintile_adj_mc_mean_2yr, by(quintile_DA_2yr)
graph save `logpath'/hist_quintile_compar, replace
graph export `logpath'/hist_quintile_compar.tif, replace

************************************************************
//Look at how our sample is distributed among the HRRs
generate order = _n
by hrrnum (order) , sort: generate hrrcount = _n ==1

egen total_hrr_cnt = sum(hrrcount)

sum total_hrr_cnt

tab hrrnum, missing

*******************************************************
log close


H="Quintiles work, check DA vs HRS"
/*created this section to look at quintiles of spending by region
to check for internal validity, compare quintiles generated with
Dartmouth data (last 2 years of life, EOL medicare spending) and 
HRS data (last 2 years of life, EOL medicare spending, all unadjusted)

Did a few versions:
1. Raw data, by DA quintiles, HRS 2 and 5 year spending
2. Wage index adjusted DA quintiles, Wage index adjusted HRS 2 and 5 year spending
3. Wage index adjusted DA quintiles, Wage index and age,sex, race adjusted HRS 2 and 5 year spending
*/

capture log close
clear all
set mem 500m
set more off

local logpath E:\data\hrs_oop_2010\logs
local datapath E:\data\hrs_oop_2010\final_data
//local logpath H:\OOP\local_logs
//local datapath C:\Users\gorger01\Desktop\oop

log using `logpath'\8a-mc_quintiles_work-LOG.txt, text replace

cd `datapath'

//use just sample that meet 5 year criteria (full mc 5 years from death)
//with new variables added
use oop_mc_sample_addedvars.dta if part_ab_5y==1 & hmo_5y==0 & ind_60m_oop_yes==1 & age_at_death_e>=70 & miss_prob_dem_n1n2==0

//use oop_mc_sample_public if part_ab_5y==1 & hmo_5y==0 & ind_60m_oop_yes==1 & age_at_death_cat>1 & miss_prob_dem_n1n2==0

*************************************************************

gen ind_hrr_yes = 0
replace ind_hrr_yes=1 if hrrnum!=.
tab ind_hrr_yes, missing

//drop n=6 obs with no hrr link, cannot be sorted into a quintile
drop if ind_hrr_yes == 0

sum tot_eol_spending_hrr, detail

***********************************************
//create dartmouth regional quintiles, no adjustments
centile tot_eol_spending_hrr, centile(20(20)80)
sca d_qui_20=r(c_1)
sca d_qui_40=r(c_2)
sca d_qui_60=r(c_3)
sca d_qui_80=r(c_4)

gen quintile_dm_2yr=.
replace quintile_dm_2yr=1 if tot_eol_spending_hrr<d_qui_20 & tot_eol_spending_hrr<.
replace quintile_dm_2yr=2 if tot_eol_spending_hrr>d_qui_20 & tot_eol_spending_hrr<=d_qui_40
replace quintile_dm_2yr=3 if tot_eol_spending_hrr>d_qui_40 & tot_eol_spending_hrr<=d_qui_60
replace quintile_dm_2yr=4 if tot_eol_spending_hrr>d_qui_60 & tot_eol_spending_hrr<=d_qui_80
replace quintile_dm_2yr=5 if tot_eol_spending_hrr>d_qui_80 & tot_eol_spending_hrr<.
tab quintile_dm_2yr, missing
la var quintile_dm_2yr"Quintiles of 2 year Dartmouth EOL Medicare Spending, HRR level (within this sample)"
la def quint 1 "Quintile 1 (low)" 2 "Quintile 2" 3 "Quintile 3" 4 "Quintile 4" 5 "Quintile 5 (High)" 
la val quintile_dm_2yr quint

**************************************************************************
**************************************************************************
//Table 1 - unadjusted quintiles, means
**************************************************************************
**************************************************************************
//means unadjusted, hrs sample split by dartmouth quintiles
mat unadj_1=J(5,3,.)
forvalues i = 1/5 {
sum tot_eol_spending_hrr if quintile_dm_2yr==`i', detail
mat unadj_1[`i',1]=r(mean)
sum tot_paid_by_mc_24m if quintile_dm_2yr==`i', detail
mat unadj_1[`i',2]=r(mean)
sum tot_paid_by_mc_60m if quintile_dm_2yr==`i', detail
mat unadj_1[`i',3]=r(mean)
}

frmttable using"`logpath'\8-Quintile_work", statmat(unadj_1) ///
title("Using means by HRR- 2 and 5 year EOL spending quintiles" \ ///
"HRS data split by Dartmouth quintiles" \ ///
"Dartmouth data vs HRS data for the 5 year lookback sample" \ ///
"No adjustments made to spending except those done by Dartmouth" ) ///
ctitle("","Dartmouth data","HRS data 2 yr", "HRS data 5 yr") ///
rtitle("Quintile 1 (low)" \ "Quintile 2" \ "Quintile 3" \ "Quintile 4" \ ///
"Quintile 5 (high)") ///
note("HRS data is adjusted for inflation to 2010 dollars," \ ///
"Dartmouth data in 2003-2007 dollars.") ///
sdec(0) replace

**************************************************************************
//Now with wage index adjustment and run again
***********************************************
//create dartmouth regional quintiles using Dartmouth adjusted for wage index
gen da_hrr_wi = tot_eol_spending_hrr/wage_index_20102
sum da_hrr_wi, detail
centile da_hrr_wi, centile(20(20)80)
sca dw_qui_20=r(c_1)
sca dw_qui_40=r(c_2)
sca dw_qui_60=r(c_3)
sca dw_qui_80=r(c_4)
sca list

gen quintile_dw_2yr=.
replace quintile_dw_2yr=1 if da_hrr_wi<=dw_qui_20 & da_hrr_wi<.
replace quintile_dw_2yr=2 if da_hrr_wi>dw_qui_20 & da_hrr_wi<=dw_qui_40
replace quintile_dw_2yr=3 if da_hrr_wi>dw_qui_40 & da_hrr_wi<=dw_qui_60
replace quintile_dw_2yr=4 if da_hrr_wi>dw_qui_60 & da_hrr_wi<=dw_qui_80
replace quintile_dw_2yr=5 if da_hrr_wi>dw_qui_80 & da_hrr_wi<.
tab quintile_dw_2yr, missing
la var quintile_dw_2yr"Quintiles of 2 year Wage index adj Dartmouth EOL Medicare Spending, HRR level (within this sample)"
la val quintile_dw_2yr quint

**************************************************************************
**************************************************************************
//Table 2 - adding wage index adjustment, quintiles, means
**************************************************************************
**************************************************************************
//wage index adjusted, HRS split by dartmouth quintiles
mat wiadj_2=J(5,3,.)
forvalues i = 1/5 {
sum da_hrr_wi if quintile_dw_2yr==`i', detail //dartmouth data
mat wiadj_2[`i',1]=r(mean)
sum tot_paid_by_mc_24m_wi if quintile_dw_2yr==`i', detail //2 year HRS
mat wiadj_2[`i',2]=r(mean)
sum tot_paid_by_mc_60m_wi if quintile_dw_2yr==`i', detail //5 year HRS
mat wiadj_2[`i',3]=r(mean)
}
frmttable using"`logpath'\8-Quintile_work", statmat(wiadj_2) ///
title("2 and 5 year EOL spending quintiles" \ ///
"HRS data split by Dartmouth quintiles" \ ///
"Dartmouth data vs HRS data for the 5 year lookback sample" \ ///
"Wage index adjustments made to Dartmouth data prior to splitting into quintiles" ) ///
ctitle("","Dartmouth data","HRS data 2 yr", "HRS data 5 yr") ///
rtitle("Quintile 1 (low)" \ "Quintile 2" \ "Quintile 3" \ "Quintile 4" \ ///
"Quintile 5 (high)") ///
note("HRS data is adjusted for inflation to 2010 dollars and for the wage index," \ ///
"Dartmouth data in 2003-2007 dollars, wage index adjusted") ///
sdec(0) addtable

mat wi=J(5,1,.)
forvalues i = 1/5 {
sum wage_index_20102 if quintile_dw_2yr==`i', detail
mat wi[`i',1]=r(mean)
}
mat list wi

**************************************************************************
**************************************************************************
//Table 3 - adding age,race,sex adjustment for HRS data, quintiles, means
**************************************************************************
**************************************************************************
//use wage index adjusted components of medicare spending, 2 and 5 year
local toadj ip_paid_by_mc_24m_wi snf_paid_by_mc_24m_wi ///
hh_paid_by_mc_24m_wi hs_paid_by_mc_24m_wi pb_paid_by_mc_24m_wi op_paid_by_mc_24m_wi ///
dm_paid_by_mc_24m_wi ip_paid_by_mc_60m_wi snf_paid_by_mc_60m_wi ///
hh_paid_by_mc_60m_wi hs_paid_by_mc_60m_wi pb_paid_by_mc_60m_wi op_paid_by_mc_60m_wi ///
dm_paid_by_mc_60m_wi

//gen black = 0
//replace black = 1 if race_eth_cat==3
//gen hisp_eth = 0
//replace hisp_eth = 1 if race_eth_cat==1

foreach v in `toadj'{
	egen mean_`v'=mean(`v')

	reg `v' i.age_at_death_cat i.black i.hisp_eth i.female_x

	predict resid_`v', residual

	gen adj_`v'=mean_`v'+resid_`v'
	sum adj_`v', detail
	sum `v', detail
	}

//now calculate totals using the adjusted values
foreach i in 24 60{
gen adj_tot_paid_by_mc_`i'm_wi = adj_ip_paid_by_mc_`i'm_wi + adj_snf_paid_by_mc_`i'm_wi ///
+ adj_hh_paid_by_mc_`i'm_wi + adj_hs_paid_by_mc_`i'm_wi + adj_pb_paid_by_mc_`i'm_wi  ///
+ adj_op_paid_by_mc_`i'm_wi + adj_dm_paid_by_mc_`i'm_wi 
}


//now look at HRS spending by wage index adjusted DA quintile
//age,race,sex, wage index adjusted, HRS split by dartmouth quintiles
mat adj=J(5,3,.)
forvalues i = 1/5 {
sum da_hrr_wi if quintile_dw_2yr==`i', detail //dartmouth data
mat adj[`i',1]=r(mean)
sum adj_tot_paid_by_mc_24m_wi if quintile_dw_2yr==`i', detail //2 year HRS
mat  adj[`i',2]=r(mean)
sum adj_tot_paid_by_mc_60m_wi if quintile_dw_2yr==`i', detail //5 year HRS
mat adj[`i',3]=r(mean)
}

frmttable using"`logpath'\8-Quintile_work", statmat( adj) ///
title("2 and 5 year EOL spending quintiles" \ ///
"HRS data split by Dartmouth quintiles" \ ///
"Dartmouth data vs HRS data for the 5 year lookback sample" \ ///
"Wage index adjustments made to Dartmouth data prior to splitting into quintiles" \ ///
"HRS data adjusted for wage index, age,sex,race" ) ///
ctitle("","Dartmouth data","HRS data 2 yr", "HRS data 5 yr") ///
rtitle("Quintile 1 (low)" \ "Quintile 2" \ "Quintile 3" \ "Quintile 4" \ ///
"Quintile 5 (high)") ///
note("HRS data is adjusted for inflation to 2010 dollars and for the wage index, race,sex and age" \ ///
"Dartmouth data in 2003-2007 dollars, wage index adjusted") ///
sdec(0) addtable

**************************************************************************
**************************************************************************
//Table 4 - adding further adjustments for HRS data, quintiles, means
**************************************************************************
**************************************************************************
label define adl_cat_x 0 "Independent" 1 "Partial Dependence" 2 "Severe Dependence" ///
      3 "Restricted to Bed", modify
label values adl_cat_x adl_cat_x
tab adl_cat_x, missing

local adjvars age_at_death_cat black hisp_eth female_x educ_hsdeg smoke_ever_n1 ///
adl_cat_x comorb_all_0d_n24m

foreach v in `adjvars'{
tab `v', missing
}


foreach v in `toadj'{
	areg `v' i.age_at_death_cat i.black i.hisp_eth i.female_x i.educ_hsdeg i.smoke_ever_n1 ///
		ib0.adl_cat_x, absorb(comorb_all_0d_n24m)
		
	predict resid_fa_`v', residual

	gen fadj_`v'=mean_`v'+resid_fa_`v'
	sum fadj_`v', detail
	sum `v', detail
	}

//now calculate totals using the adjusted values
foreach i in 24 60{
gen fadj_tot_paid_by_mc_`i'm_wi = fadj_ip_paid_by_mc_`i'm_wi + fadj_snf_paid_by_mc_`i'm_wi ///
+ fadj_hh_paid_by_mc_`i'm_wi + fadj_hs_paid_by_mc_`i'm_wi + fadj_pb_paid_by_mc_`i'm_wi  ///
+ fadj_op_paid_by_mc_`i'm_wi + fadj_dm_paid_by_mc_`i'm_wi 
}


//now look at HRS spending by wage index adjusted DA quintile
//age,race,sex,educ, smoking,adl,comorbid count wage index adjusted, HRS split by dartmouth quintiles
mat fadj=J(5,3,.)
forvalues i = 1/5 {
sum da_hrr_wi if quintile_dw_2yr==`i', detail //dartmouth data
mat fadj[`i',1]=r(mean)
sum fadj_tot_paid_by_mc_24m_wi if quintile_dw_2yr==`i', detail //2 year HRS
mat  fadj[`i',2]=r(mean)
sum fadj_tot_paid_by_mc_60m_wi if quintile_dw_2yr==`i', detail //5 year HRS
mat fadj[`i',3]=r(mean)
}

frmttable using"`logpath'\8-Quintile_work", statmat( fadj) ///
title("2 and 5 year EOL spending quintiles" \ ///
"HRS data split by Dartmouth quintiles" \ ///
"Dartmouth data vs HRS data for the 5 year lookback sample" \ ///
"Wage index adjustments made to Dartmouth data prior to splitting into quintiles" \ ///
"HRS data adjusted for wage index, age,sex,race,ever smoke, ADL status, count elix comor and educ" ) ///
ctitle("","Dartmouth data","HRS data 2 yr", "HRS data 5 yr") ///
rtitle("Quintile 1 (low)" \ "Quintile 2" \ "Quintile 3" \ "Quintile 4" \ ///
"Quintile 5 (high)") ///
note("HRS data is adjusted for inflation to 2010 dollars and for the wage index, race,sex, " \ ///
"ever smoke, ADL status(independ=base,partial,severe,bedbound at exit, count elix comorbidities "\ ///
"and whether or not has hs degree" \ ///
"Dartmouth data in 2003-2007 dollars, wage index adjusted") ///
sdec(0) addtable

**************************************************************************

//look at wage index by quintile
//now look at HRS spending by wage index adjusted DA quintile
//age,race,sex, wage index adjusted, HRS split by dartmouth quintiles
mat adj=J(5,1,.)
forvalues i = 1/5 {
sum wage_index_20102 if quintile_dw_2yr==`i', detail //dartmouth data
mat adj[`i',1]=r(mean)
}

log close


H="25%, middle, 75% split - check DA vs HRS"
/*created this section to look at split of spending into 3 groups by region
to check for internal validity, compare quartiles generated with
Dartmouth data (last 2 years of life, EOL medicare spending) and 
HRS data (last 2 years of life, EOL medicare spending, all unadjusted)

Splits are bottom 25%, middle 25-75% and top 75%

Did a few versions:
1. Raw data, by DA quintiles, HRS 2 and 5 year spending
2. Wage index adjusted DA quintiles, Wage index adjusted HRS 2 and 5 year spending
3. Wage index adjusted DA quintiles, Wage index and age,sex, race adjusted HRS 2 and 5 year spending
*/

capture log close
clear all
set mem 500m
set more off

local logpath E:\data\hrs_oop_2010\logs
local datapath E:\data\hrs_oop_2010\final_data
//local logpath H:\OOP\local_logs
//local datapath C:\Users\gorger01\Desktop\oop

log using `logpath'\8b-mc_25_75split_work-LOG.txt, text replace

cd `datapath'

//use just sample that meet 5 year criteria (full mc 5 years from death)
//with new variables added
use oop_mc_sample_addedvars.dta if part_ab_5y==1 & hmo_5y==0 & ind_60m_oop_yes==1 & age_at_death_e>=70 & miss_prob_dem_n1n2==0

//use oop_mc_sample_public if part_ab_5y==1 & hmo_5y==0 & ind_60m_oop_yes==1 & age_at_death_cat>1 & miss_prob_dem_n1n2==0

*************************************************************

gen ind_hrr_yes = 0
replace ind_hrr_yes=1 if hrrnum!=.
tab ind_hrr_yes, missing

//drop n=6 obs with no hrr link, cannot be sorted into a quintile
drop if ind_hrr_yes == 0

sum tot_eol_spending_hrr, detail

***********************************************
//create dartmouth regional quartiles, no adjustments
centile tot_eol_spending_hrr, centile(25 75)
sca d_qui_25=r(c_1)
sca d_qui_75=r(c_2)

gen quart3_dm_2yr=.
replace quart3_dm_2yr=1 if tot_eol_spending_hrr<=d_qui_25 & tot_eol_spending_hrr<.
replace quart3_dm_2yr=2 if tot_eol_spending_hrr>d_qui_25 & tot_eol_spending_hrr<d_qui_75
replace quart3_dm_2yr=3 if tot_eol_spending_hrr>=d_qui_75 & tot_eol_spending_hrr<.

tab quart3_dm_2yr, missing
la var quart3_dm_2yr"Quartiles of 2 year Dartmouth EOL Medicare Spending, HRR level (within this sample)"
la def quart 1 "Bottom 25%" 2 "25-75%" 3 "Top 75%" 
la val quart3_dm_2yr quart

**************************************************************************
**************************************************************************
//Table 1 - unadjusted quartiles, means
**************************************************************************
**************************************************************************
//means unadjusted, hrs sample split by dartmouth quartiles
mat unadj_1=J(3,3,.)
forvalues i = 1/3 {
sum tot_eol_spending_hrr if quart3_dm_2yr==`i', detail
mat unadj_1[`i',1]=r(mean)
sum tot_paid_by_mc_24m if quart3_dm_2yr==`i', detail
mat unadj_1[`i',2]=r(mean)
sum tot_paid_by_mc_60m if quart3_dm_2yr==`i', detail
mat unadj_1[`i',3]=r(mean)
}

frmttable using"`logpath'\8b-Quartile_split_work", statmat(unadj_1) ///
title("Using means by HRR- 2 and 5 year EOL spending quartiles" \ ///
"HRS data split by Dartmouth quintiles" \ ///
"Dartmouth data vs HRS data for the 5 year lookback sample" \ ///
"No adjustments made to spending except those done by Dartmouth" ) ///
ctitle("","Dartmouth data","HRS data 2 yr", "HRS data 5 yr") ///
rtitle("Quartile 1 (low)" \ "Quartiles 2&3" \ "Quartile 4(high)") ///
note("HRS data is adjusted for inflation to 2010 dollars," \ ///
"Dartmouth data in 2003-2007 dollars.") ///
sdec(0) replace


**************************************************************************
//Now with wage index adjustment and run again
***********************************************
//create dartmouth regional quintiles using Dartmouth adjusted for wage index
gen da_hrr_wi = tot_eol_spending_hrr/wage_index_20102
sum da_hrr_wi, detail
centile da_hrr_wi, centile(25 75)
sca dw_qui_25=r(c_1)
sca dw_qui_75=r(c_2)
sca list

gen quart3_dw_2yr=.
replace quart3_dw_2yr=1 if da_hrr_wi<=dw_qui_25 & da_hrr_wi<.
replace quart3_dw_2yr=2 if da_hrr_wi>dw_qui_25 & da_hrr_wi<dw_qui_75
replace quart3_dw_2yr=3 if da_hrr_wi>=dw_qui_75 & da_hrr_wi<.

tab quart3_dw_2yr, missing
la var quart3_dw_2yr "Quintiles of 2 year Wage index adj Dartmouth EOL Medicare Spending, HRR level (within this sample)"
la val quart3_dw_2yr quart

**************************************************************************
**************************************************************************
//Table 2 - adding wage index adjustment, quartiles, means
**************************************************************************
**************************************************************************
//wage index adjusted, HRS split by dartmouth wage index adjusted quartiles
mat wiadj_2=J(3,3,.)
forvalues i = 1/3 {
sum da_hrr_wi if quart3_dw_2yr==`i', detail //dartmouth data
mat wiadj_2[`i',1]=r(mean)
sum tot_paid_by_mc_24m_wi if quart3_dw_2yr==`i', detail //2 year HRS
mat wiadj_2[`i',2]=r(mean)
sum tot_paid_by_mc_60m_wi if quart3_dw_2yr==`i', detail //5 year HRS
mat wiadj_2[`i',3]=r(mean)
}
frmttable using"`logpath'\8b-Quartile_split_work", statmat(wiadj_2) ///
title("2 and 5 year EOL spending quartiles" \ ///
"HRS data split by Dartmouth quartiles" \ ///
"Dartmouth data vs HRS data for the 5 year lookback sample" \ ///
"Wage index adjustments made to Dartmouth data prior to splitting into quartiles" ) ///
ctitle("","Dartmouth data","HRS data 2 yr", "HRS data 5 yr") ///
rtitle("Quartile 1 (low)" \ "Quartiles 2&3" \ "Quartile 4(high)") ///
note("HRS data is adjusted for inflation to 2010 dollars and for the wage index," \ ///
"Dartmouth data in 2003-2007 dollars, wage index adjusted") ///
sdec(0) addtable

mat wi=J(3,1,.)
forvalues i = 1/3 {
sum wage_index_20102 if quart3_dw_2yr==`i', detail
mat wi[`i',1]=r(mean)
}
mat list wi

**************************************************************************
**************************************************************************
//Table 3 - adding age,race,sex adjustment for HRS data, quintiles, means
**************************************************************************
**************************************************************************
//use wage index adjusted components of medicare spending, 2 and 5 year
local toadj ip_paid_by_mc_24m_wi snf_paid_by_mc_24m_wi ///
hh_paid_by_mc_24m_wi hs_paid_by_mc_24m_wi pb_paid_by_mc_24m_wi op_paid_by_mc_24m_wi ///
dm_paid_by_mc_24m_wi ip_paid_by_mc_60m_wi snf_paid_by_mc_60m_wi ///
hh_paid_by_mc_60m_wi hs_paid_by_mc_60m_wi pb_paid_by_mc_60m_wi op_paid_by_mc_60m_wi ///
dm_paid_by_mc_60m_wi

//gen black = 0
//replace black = 1 if race_eth_cat==3
//gen hisp_eth = 0
//replace hisp_eth = 1 if race_eth_cat==1

foreach v in `toadj'{
	egen mean_`v'=mean(`v')

	reg `v' i.age_at_death_cat i.black i.hisp_eth i.female_x

	predict resid_`v', residual

	gen adj_`v'=mean_`v'+resid_`v'
	sum adj_`v', detail
	sum `v', detail
	}

//now calculate totals using the adjusted values
foreach i in 24 60{
gen adj_tot_paid_by_mc_`i'm_wi = adj_ip_paid_by_mc_`i'm_wi + adj_snf_paid_by_mc_`i'm_wi ///
+ adj_hh_paid_by_mc_`i'm_wi + adj_hs_paid_by_mc_`i'm_wi + adj_pb_paid_by_mc_`i'm_wi  ///
+ adj_op_paid_by_mc_`i'm_wi + adj_dm_paid_by_mc_`i'm_wi 
}


//now look at HRS spending by wage index adjusted DA quintile
//age,race,sex, wage index adjusted, HRS split by dartmouth quintiles
mat adj=J(3,3,.)
forvalues i = 1/3 {
sum da_hrr_wi if quart3_dw_2yr==`i', detail //dartmouth data
mat adj[`i',1]=r(mean)
sum adj_tot_paid_by_mc_24m_wi if quart3_dw_2yr==`i', detail //2 year HRS
mat  adj[`i',2]=r(mean)
sum adj_tot_paid_by_mc_60m_wi if quart3_dw_2yr==`i', detail //5 year HRS
mat adj[`i',3]=r(mean)
}

frmttable using"`logpath'\8b-Quartile_split_work", statmat( adj) ///
title("2 and 5 year EOL spending quartiles" \ ///
"HRS data split by Dartmouth quartiles" \ ///
"Dartmouth data vs HRS data for the 5 year lookback sample" \ ///
"Wage index adjustments made to Dartmouth data prior to splitting into quartiles" \ ///
"HRS data adjusted for wage index, age,sex,race" ) ///
ctitle("","Dartmouth data","HRS data 2 yr", "HRS data 5 yr") ///
rtitle("Quartile 1 (low)" \ "Quartiles 2&3" \ "Quartile 4(high)") ///
note("HRS data is adjusted for inflation to 2010 dollars and for the wage index, race,sex and age" \ ///
"Dartmouth data in 2003-2007 dollars, wage index adjusted") ///
sdec(0) addtable

**************************************************************************
**************************************************************************
//Table 4 - adding further adjustments for HRS data, quartiles, means
**************************************************************************
**************************************************************************
label define adl_cat_x 0 "Independent" 1 "Partial Dependence" 2 "Severe Dependence" ///
      3 "Restricted to Bed", modify
label values adl_cat_x adl_cat_x
tab adl_cat_x, missing

foreach v in `toadj'{
	areg `v' i.age_at_death_cat i.black i.hisp_eth i.female_x i.educ_hsdeg i.smoke_ever_n1 ///
		ib0.adl_cat_x, absorb(comorb_all_0d_n24m)
		
	predict resid_fa_`v', residual

	gen fadj_`v'=mean_`v'+resid_fa_`v'
	sum fadj_`v', detail
	sum `v', detail
	}

//now calculate totals using the adjusted values
foreach i in 24 60{
gen fadj_tot_paid_by_mc_`i'm_wi = fadj_ip_paid_by_mc_`i'm_wi + fadj_snf_paid_by_mc_`i'm_wi ///
+ fadj_hh_paid_by_mc_`i'm_wi + fadj_hs_paid_by_mc_`i'm_wi + fadj_pb_paid_by_mc_`i'm_wi  ///
+ fadj_op_paid_by_mc_`i'm_wi + fadj_dm_paid_by_mc_`i'm_wi 
}


//now look at HRS spending by wage index adjusted DA quartiles
//age,race,sex,educ, smoking,adl,comorbid count wage index adjusted, HRS split by dartmouth quartiles
mat fadj=J(3,3,.)
forvalues i = 1/3 {
sum da_hrr_wi if quart3_dw_2yr==`i', detail //dartmouth data
mat fadj[`i',1]=r(mean)
sum fadj_tot_paid_by_mc_24m_wi if quart3_dw_2yr==`i', detail //2 year HRS
mat  fadj[`i',2]=r(mean)
sum fadj_tot_paid_by_mc_60m_wi if quart3_dw_2yr==`i', detail //5 year HRS
mat fadj[`i',3]=r(mean)
}

frmttable using"`logpath'\8b-Quartile_split_work", statmat( fadj) ///
title("2 and 5 year EOL spending quartiles" \ ///
"HRS data split by Dartmouth quartiles" \ ///
"Dartmouth data vs HRS data for the 5 year lookback sample" \ ///
"Wage index adjustments made to Dartmouth data prior to splitting into quartiles" \ ///
"HRS data adjusted for wage index, age,sex,race,ever smoke, ADL impairment, count elix comor and educ" ) ///
ctitle("","Dartmouth data","HRS data 2 yr", "HRS data 5 yr") ///
rtitle("Quartile 1 (low)" \ "Quartiles 2&3" \ "Quartile 4(high)") ///
note("HRS data is adjusted for inflation to 2010 dollars and for the wage index, race,sex, " \ ///
"ever smoke, ADL status(independ=base,partial,severe,bedbound at exit, count elix comorbidities "\ ///
"and whether or not has hs degree" \ ///
"Dartmouth data in 2003-2007 dollars, wage index adjusted") ///
sdec(0) addtable

**************************************************************************

//look at wage index by quartile
//now look at HRS spending by wage index adjusted DA quartile
//age,race,sex, wage index adjusted, HRS split by dartmouth quartile
mat adj=J(3,1,.)
forvalues i = 1/3 {
sum wage_index_20102 if quart3_dw_2yr==`i', detail //dartmouth data
mat adj[`i',1]=r(mean)
}

log close


H="Break out 5 year EOL Spending by HRR quintiles "
/*Define the groups as follows:
1. All obs where prob dementia > 50%
2. Of remaining obs, where cause of death = cancer
3. , where cause of death = heart disease
4. Everyone else

Divides into quintiles by HRR level DA 2 year EOL medicare spending, 2003-2007

5 year lookbacks 

Note:Sample limited to those with Age 70+ when die, FFS medicare last 5 years of life,
full OOP spending data last 5 years of life and resident of 50 States + DC (drops PR resident)*/

capture log close
clear all
set mem 500m
set more off

local logpath E:\data\hrs_oop_2010\logs
local datapath E:\data\hrs_oop_2010\final_data
//local logpath H:\OOP\local_logs
//local datapath C:\Users\gorger01\Desktop\oop

log using `logpath'\9-mc_oop_dementia_quintiles-LOG.txt, text replace

cd `datapath'

//use just sample that meet 5 year criteria (full mc and oop data 5 years from death)
//with new variables added
use oop_mc_sample_addedvars.dta if part_ab_5y==1 & hmo_5y==0 & ind_60m_oop_yes==1 & age_at_death_e>=70 & miss_prob_dem_n1n2==0
//use oop_mc_sample_public if part_ab_5y==1 & hmo_5y==0 & ind_60m_oop_yes==1 & age_at_death_cat>1 & miss_prob_dem_n1n2==0

*********************************************************
//split into quintiles by wage index adjusted DA hrr medicare spending

gen ind_hrr_yes = 0
replace ind_hrr_yes=1 if hrrnum!=.
tab ind_hrr_yes, missing

//drop n=6 obs with no hrr link, cannot be sorted into a quintile
drop if ind_hrr_yes == 0
sum tot_eol_spending_hrr_2010  , detail

sort tot_eol_spending_hrr_2010  

//calculate quintiles based on the 2010 wage index, inflation adjusted DA 2yr EOL spending
centile tot_eol_spending_hrr_2010 , centile(20(20)80)
sca d_qui_20=r(c_1)
sca d_qui_40=r(c_2)
sca d_qui_60=r(c_3)
sca d_qui_80=r(c_4)

gen quintile_dm_2yr=.
replace quintile_dm_2yr=1 if tot_eol_spending_hrr_2010 <=d_qui_20 & tot_eol_spending_hrr_2010 <.
replace quintile_dm_2yr=2 if tot_eol_spending_hrr_2010 >d_qui_20 & tot_eol_spending_hrr_2010 <=d_qui_40
replace quintile_dm_2yr=3 if tot_eol_spending_hrr_2010 >d_qui_40 & tot_eol_spending_hrr_2010 <=d_qui_60
replace quintile_dm_2yr=4 if tot_eol_spending_hrr_2010 >d_qui_60 & tot_eol_spending_hrr_2010 <=d_qui_80
replace quintile_dm_2yr=5 if tot_eol_spending_hrr_2010 >d_qui_80 & tot_eol_spending_hrr_2010 <.
tab quintile_dm_2yr, missing
la var quintile_dm_2yr"Quintiles of 2 year Dartmouth EOL Medicare Spending, HRR level (within this sample)"
la val quintile_dm_2yr quint

sum tot_eol_spending_hrr_2010 if quintile_dm_2yr==1, detail
sum tot_eol_spending_hrr_2010 if quintile_dm_2yr==2, detail
sum tot_eol_spending_hrr_2010 if quintile_dm_2yr==3, detail
sum tot_eol_spending_hrr_2010 if quintile_dm_2yr==4, detail
sum tot_eol_spending_hrr_2010 if quintile_dm_2yr==5, detail

*********************************************************
*********************************************************
//Create tables of spending by quintile, overall sample (unadjusted)
local spvars age_at_death_e total_costs_60m tot_gov_pay_60m tot_paid_by_mc_60m_wi ip_paid_by_mc_60m_wi snf_paid_by_mc_60m_wi ///
hh_paid_by_mc_60m_wi hs_paid_by_mc_60m_wi pb_paid_by_mc_60m_wi op_paid_by_mc_60m_wi ///
dm_paid_by_mc_60m_wi nh_cost_medicaid_60m total_oop_60m helper_oop_60m hospital_oop_60m nh_oop_60m ///
doctor_oop_60m rx_oop_60m insurance_costs_60m other_oop_60m nh_nights_60m ///
 nh_cost_private_60m total_nh_costs_60m inf_care_costs_60m ///
medicaid_x

mat mean_unadj1 = J(26,10,.)

//first row - get n each quintile
local c=1
forvalues i=1/5{
sum exit_year_x if(quintile_dm_2yr==`i')
mat mean_unadj1[1,`c'] = r(N)
local c = `c'+2
}

local r=2
foreach v in `spvars' {
	local c=1
	forvalues i = 1/5 {
		sum(`v') if(quintile_dm_2yr==`i'), detail
		mat mean_unadj1[`r',`c'] = r(mean)
		mat mean_unadj1[(`r'),`c'+1] = r(p50)
		local c = `c' + 2
	}
	local r=`r'+1
}

//for medicaid percent, multiply mean by 100
forvalues c = 1/10{
mat mean_unadj1[`r'-1,`c']=mean_unadj1[`r'-1,`c']*100	
}	

mat rownames mean_unadj1= "N" "Age at death" "Total payments, all types" "Total government payments" ///
"Total Medicare payments" "Medicare IP" "Medicare SNF" "Medicare HH" ///
"Medicare Hospice" "Medicare Carrier" "Medicare OP" "Medicare DME" "Medicaid NH Payments" ///
"OOP Total" "OOP Helper" "OOP Hospital" "OOP NH" "OOP Doctor" "OOP Rx" ///
"OOP Insurance Costs" "OOP Other" ///
"Total NH nights, SR or claims" ///
"Private payer NH Payments" "Total NH costs, all payers" "Imputed informal care costs" "Medicaid at death? (percent)"

mat list mean_unadj1

frmttable using "`logpath'\9-5yr_HRR_Quintiles" , statmat(mean_unadj1) ///
	title("Five Year EOL Spending by Quintiles of HRR-level Medicare EOL Spending" \ ///
	"(within this sample) (NOT adjusted for age, race, gender)") ///
	ctitle("","Quintile 1 (lowest)", "2", "3", "4", "5 (highest)") ///
	note("Medicare spending totals are adjusted for the 2010 CMS wage index" \ ///
	"All $ values adjusted for inflation to 2010$" \ ///
	"Total government payments = Medicare + Medicaid nursing home" \ ///
	"Total NH spending = Medicare + OOP + Medicaid or Private Payer" \ ///
	"Informal caregivers are spouses and other unpaid (mainly children), replacement wage imputation")  ///
	sdec(0) substat(1) replace
************************************************************
//Now create quintile tables for each of the 4 disease groups
foreach d in pr_dem_gt50 cancer_grp heartdis_grp other_grp{
	mat mean_`d' = J(26,10,.)

	//first row - get n each quintile
	local c=1
	forvalues i=1/5{
		sum exit_year_x if(quintile_dm_2yr==`i' & `d'==1)
		mat mean_`d'[1,`c'] = r(N)
		local c = `c'+2
		}

	local r=2
	foreach v in `spvars' {
		local c=1
		forvalues i = 1/5 {
			sum(`v') if(quintile_dm_2yr==`i'& `d'==1), detail
			mat mean_`d'[`r',`c'] = r(mean)
			mat mean_`d'[(`r'),`c'+1] = r(p50)
			local c = `c' + 2
		}
		local r=`r'+1
	}

	//for medicaid percent, multiply mean by 100
	forvalues c = 1/10{
		mat mean_`d'[`r'-1,`c']=mean_`d'[`r'-1,`c']*100	
	}	

mat rownames mean_`d'= "N" "Age at death" "Total payments, all types" "Total government payments" "Total Medicare payments" ///
"Medicare IP" "Medicare SNF" "Medicare HH" "Medicare Hospice" "Medicare Carrier" "Medicare OP"  ///
"Medicare DME" "Medicaid NH Payments" "OOP Total" "OOP Helper" "OOP Hospital" "OOP NH" "OOP Doctor" "OOP Rx" ///
"OOP Insurance Costs" "OOP Other" ///
"Total NH nights, SR or claims" "Private payer NH Payments" ///
"Total NH costs, all payers" "Imputed informal care costs" "Medicaid at death? (percent)"

mat list mean_unadj1

frmttable using "`logpath'\9-5yr_HRR_Quintiles" , statmat(mean_`d') ///
	title("`d' Five Year EOL Spending by Quintiles of HRR-level Medicare EOL" \ ///
	"Spending (within this sample) (NOT adjusted for age, race, gender)") ///
	ctitle("","Quintile 1 (lowest)", "2", "3", "4", "5 (highest)") ///
	note("Medicare spending totals are adjusted for the 2010 CMS wage index" \ ///
	"All $ values adjusted for inflation to 2010$" \ ///
	"Total government payments = Medicare + Medicaid nursing home" \ ///
	"Total NH spending = Medicare + OOP + Medicaid or Private Payer" \ ///
	"Informal caregivers are spouses and other unpaid (mainly children), replacement wage imputation")  ///
	sdec(0) substat(1) addtable

}
************************************************************
//Create single table looking at the high/low quintiles 
//for each of the disease groups for an easier comparison
mat mean_hilo = J(26,16,.)


//first row - get n each quintile
local c=1
foreach d in pr_dem_gt50 cancer_grp heartdis_grp other_grp{	
	foreach i of numlist 1 5{
		sum exit_year_x if(quintile_dm_2yr==`i' & `d'==1)
		mat mean_hilo[1,`c'] = r(N)
		local c = `c'+2
		}
}

local r=2

foreach v in `spvars' {
		local c=1
		foreach i of numlist 1 5{
			sum(`v') if(quintile_dm_2yr==`i'& pr_dem_gt50==1), detail
			mat mean_hilo[`r',`c'] = r(mean)
			mat mean_hilo[(`r'),`c'+1] = r(p50)
		
			sum(`v') if(quintile_dm_2yr==`i'& cancer_grp==1), detail
			mat mean_hilo[`r',`c'+4] = r(mean)
			mat mean_hilo[(`r'),`c'+5] = r(p50)
		
			sum(`v') if(quintile_dm_2yr==`i'& heartdis_grp==1), detail
			mat mean_hilo[`r',`c'+8] = r(mean)
			mat mean_hilo[(`r'),`c'+9] = r(p50)

			sum(`v') if(quintile_dm_2yr==`i'& other_grp==1), detail
			mat mean_hilo[`r',`c'+12] = r(mean)
			mat mean_hilo[(`r'),`c'+13] = r(p50)
		
			local c = `c' + 2		
		}
		local r=`r'+1
}


	//for medicaid percent, multiply mean by 100
	forvalues c = 1/16{
		mat mean_hilo[`r'-1,`c']=mean_hilo[`r'-1,`c']*100		
}
mat list mean_hilo

mat rownames mean_hilo= "N" "Age at death" "Total payments, all types" "Total government payments" "Total Medicare payments" ///
"Medicare IP" "Medicare SNF" "Medicare HH" "Medicare Hospice" "Medicare Carrier" "Medicare OP"  ///
"Medicare DME" "Medicaid NH Payments" "OOP Total" "OOP Helper" "OOP Hospital" "OOP NH" "OOP Doctor" "OOP Rx" ///
"OOP Insurance Costs" "OOP Other" ///
"Total NH nights, SR or claims" "Private payer NH Payments" ///
"Total NH costs, all payers" "Imputed informal care costs" "Medicaid at death? (percent)"

mat list mean_hilo

frmttable using "`logpath'\9-5yr_HRR_Quintiles" , statmat(mean_hilo) ///
	title("1 / 5th Quintile 5yr EOL Spending for the 4 disease groups" \ ///
	"(Quintiles DA 2y EOL MC spending within this sample, NOT adjusted for age, race, gender)") ///
	ctitle("","Dementia","","Cancer","","Heart Disease","","Other disease","" \ ///
	"","Q1","Q5","Q1","Q5","Q1","Q5","Q1","Q5") ///
	note("Medicare spending totals are adjusted for the 2010 CMS wage index" \ ///
	"All $ values adjusted for inflation to 2010$" \ ///
	"Total government payments = Medicare + Medicaid nursing home" \ ///
	"Total NH spending = Medicare + OOP + Medicaid or Private Payer" \ ///
	"Informal caregivers are spouses and other unpaid (mainly children), replacement wage imputation")  ///
	sdec(0) substat(1) landscape addtable


************************************************************
//Pie charts of spending by category by quintile and disease group
//OA sample
//local logpath H:\OOP\local_logs
cd "`logpath'\graphs"
//OA sample - all disease groups included
sum total_costs_60m
sca oa_tot=r(mean)
local oatot = round(oa_tot)
di `oatot'

local slices tot_paid_by_mc_60m_wi nh_cost_medicaid_60m nh_cost_private_60m total_oop_60m inf_care_costs_60m

//relabel spending categories so labels can be used in the legends
la var tot_paid_by_mc_60m_wi "Medicare"
la var nh_cost_medicaid_60m "Medicaid NH"
la var nh_cost_private_60m "Private Payer NH"
la var total_oop_60m "OOP"
la var inf_care_costs_60m "Informal care"

graph pie `slices' ///
, plabel(_all percent) subtitle("Overall, All Q's",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`oatot'",ring(0) position(7)) legend(cols(3))
graph save oa_spend, replace

forvalues i=1/5{ 
sum total_costs_60m if quintile_dm_2yr ==`i'
sca oa_q_`i'=r(mean)
local oa_q`i' = round(oa_q_`i')

graph pie `slices' ///
if quintile_dm_2yr ==`i' , plabel(_all percent) subtitle("Overall, Q-`i'",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`oa_q`i''",ring(0) position(7))	
graph save oa_quint_`i', replace
}
//Dementia sample
sum total_costs_60m if pr_dem_gt50==1
sca d_all=r(mean)
local d_all = round(d_all)
	
graph pie `slices' ///
if pr_dem_gt50==1, plabel(_all percent) subtitle("Dementia, All Q's",ring(0) position(11)) ///
note("Total 5y EOL" "spending=`d_all'",ring(0) position(7))
graph save pr_dem_gt50_spend, replace

forvalues i=1/5{
	sum total_costs_60m if  pr_dem_gt50==1 & quintile_dm_2yr ==`i'
	sca d_q_`i'=r(mean)
	local d_q`i' = round(d_q_`i')

	graph pie `slices' ///
	if pr_dem_gt50==1 & quintile_dm_2yr ==`i' , plabel(_all percent)  ///
	subtitle("Dementia, Q-`i'",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`d_q`i''",ring(0) position(7))	
	graph save pr_dem_gt50_quint_`i', replace
}

//Cancer sample
sum total_costs_60m if cancer_grp==1
sca c_all=r(mean)
local c_all = round(c_all)

graph pie `slices' ///
if cancer_grp==1, plabel(_all percent) subtitle("Cancer, All Q's",ring(0) position(11)) ///
note("Total 5y EOL" "spending=`c_all'",ring(0) position(7))
graph save cancer_grp_spend, replace

forvalues i=1/5{ 
	sum total_costs_60m if  cancer_grp==1 & quintile_dm_2yr ==`i'
	sca c_q_`i'=r(mean)
	local c_q`i' = round(c_q_`i')

	graph pie `slices' ///
	if cancer_grp==1 & quintile_dm_2yr ==`i' , plabel(_all percent) ///
	subtitle("Cancer, Q-`i'",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`c_q`i''",ring(0) position(7))
	graph save cancer_grp_quint_`i', replace
}

//Heart disease sample
sum total_costs_60m if heartdis_grp==1
sca h_all=r(mean)
local h_all = round(h_all)

graph pie `slices' ///
if heartdis_grp==1, plabel(_all percent) subtitle("Heart Disease, All Q's",ring(0) position(11)) ///
note("Total 5y EOL" "spending=`h_all'",ring(0) position(7))
graph save heartdis_grp_spend, replace

forvalues i=1/5{ 
	sum total_costs_60m if  heartdis_grp==1 & quintile_dm_2yr ==`i'
	sca h_q_`i'=r(mean)
	local h_q`i' = round(h_q_`i')
	
	graph pie `slices' ///
	if heartdis_grp==1 & quintile_dm_2yr ==`i' , plabel(_all percent) ///
	subtitle("Heart Disease, Q-`i'",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`h_q`i''",ring(0) position(7))
	graph save heartdis_grp_quint_`i', replace
}

//Other diseases sample
sum total_costs_60m if other_grp==1
sca o_all=r(mean)
local o_all = round(o_all)

graph pie `slices' ///
if other_grp==1, plabel(_all percent) subtitle("Other disease, All Q's",ring(0) position(11)) ///
note("Total 5y EOL" "spending=`o_all'",ring(0) position(7))
graph save other_grp_spend, replace

forvalues i=1/5{ 
	sum total_costs_60m if  other_grp==1 & quintile_dm_2yr ==`i'
	sca o_q_`i'=r(mean)
	local o_q`i' = round(o_q_`i')
	
	graph pie `slices' ///
	if other_grp==1 & quintile_dm_2yr ==`i' , plabel(_all percent) ///
	subtitle("Other disease, Q-`i'",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`o_q`i''",ring(0) position(7))	
	graph save other_grp_quint_`i', replace
}

cd `logpath'\graphs

grc1leg oa_spend.gph oa_quint_1.gph  oa_quint_2.gph  oa_quint_3.gph  oa_quint_4.gph  oa_quint_5.gph ///
 pr_dem_gt50_spend.gph pr_dem_gt50_quint_1.gph pr_dem_gt50_quint_2.gph pr_dem_gt50_quint_3.gph ///
 pr_dem_gt50_quint_4.gph pr_dem_gt50_quint_5.gph ///
 cancer_grp_spend.gph cancer_grp_quint_1.gph cancer_grp_quint_2.gph cancer_grp_quint_3.gph ///
 cancer_grp_quint_4.gph cancer_grp_quint_5.gph ///
 heartdis_grp_spend.gph heartdis_grp_quint_1.gph heartdis_grp_quint_2.gph heartdis_grp_quint_3.gph ///
 heartdis_grp_quint_4.gph heartdis_grp_quint_5.gph ///
 other_grp_spend.gph other_grp_quint_1.gph other_grp_quint_2.gph other_grp_quint_3.gph ///
 other_grp_quint_4.gph other_grp_quint_5.gph, ///
  col(6)
graph save panel_quint_1leg, replace
graph export panel_quint_1leg.tif, replace

************************************************************
//Look at how our sample is distributed among the HRRs
generate order = _n
by hrrnum (order) , sort: generate hrrcount = _n ==1

egen total_hrr_cnt = sum(hrrcount)

sum total_hrr_cnt

tab hrrnum, missing
*********************************************************
log close


H="Adjust spending categories by age, sex, race"
/*Divides sample into quartiles and quintiles by HRR level 
DA 2 year EOL medicare spending, 2003-2007

5 year lookbacks 

Note:Sample limited to those with Age 70+ when die, FFS medicare last 5 years of life,
full OOP spending data last 5 years of life and resident of 50 States + DC (drops PR resident)

Adjust all spending categories for age, race, gender

2nd adjustment done adding ever smoke cigarettes?, ADL impairment, count of elixhauser comorbidites,
	high school degree (education)

For Medicare spending categories, adjusts wage index adjusted spending only
For other spending categories (OOP, nursing home and informal care imputed) adjusts
both wage index adj and not adjusted spending*/

capture log close
clear all
set mem 500m
set more off

local logpath E:\data\hrs_oop_2010\logs
local datapath E:\data\hrs_oop_2010\final_data
//local logpath H:\OOP\local_logs
//local datapath C:\Users\gorger01\Desktop\oop

log using `logpath'\10-mc_oop_5yr_adjust_age_etc-LOG.txt, text replace

cd `datapath'

//use just sample that meet 5 year criteria (full mc and oop data 5 years from death)
//with new variables added
use oop_mc_sample_addedvars.dta if part_ab_5y==1 & hmo_5y==0 & ind_60m_oop_yes==1 & age_at_death_e>=70 & miss_prob_dem_n1n2==0
//use oop_mc_sample_public if part_ab_5y==1 & hmo_5y==0 & ind_60m_oop_yes==1 & age_at_death_cat>1 & miss_prob_dem_n1n2==0

********************************************************************
//first assign quintiles (same as in previous header section)
//split into quintiles by wage index adjusted DA hrr medicare spending

gen ind_hrr_yes = 0
replace ind_hrr_yes=1 if hrrnum!=.
tab ind_hrr_yes, missing

//drop n=6 obs with no hrr link, cannot be sorted into a quintile
drop if ind_hrr_yes == 0
sum tot_eol_spending_hrr_2010  , detail

sort tot_eol_spending_hrr_2010  

//calculate quintiles based on the 2010 wage index, inflation adjusted DA 2yr EOL spending
centile tot_eol_spending_hrr_2010 , centile(20(20)80)
sca d_qui_20=r(c_1)
sca d_qui_40=r(c_2)
sca d_qui_60=r(c_3)
sca d_qui_80=r(c_4)

gen quintile_dm_2yr=.
replace quintile_dm_2yr=1 if tot_eol_spending_hrr_2010 <=d_qui_20 & tot_eol_spending_hrr_2010 <.
replace quintile_dm_2yr=2 if tot_eol_spending_hrr_2010 >d_qui_20 & tot_eol_spending_hrr_2010 <=d_qui_40
replace quintile_dm_2yr=3 if tot_eol_spending_hrr_2010 >d_qui_40 & tot_eol_spending_hrr_2010 <=d_qui_60
replace quintile_dm_2yr=4 if tot_eol_spending_hrr_2010 >d_qui_60 & tot_eol_spending_hrr_2010 <=d_qui_80
replace quintile_dm_2yr=5 if tot_eol_spending_hrr_2010 >d_qui_80 & tot_eol_spending_hrr_2010 <.
tab quintile_dm_2yr, missing
la var quintile_dm_2yr"Quintiles of 2 year Dartmouth EOL Medicare Spending, HRR level (within this sample)"
la val quintile_dm_2yr quint

sum tot_eol_spending_hrr_2010 if quintile_dm_2yr==1, detail
sum tot_eol_spending_hrr_2010 if quintile_dm_2yr==2, detail
sum tot_eol_spending_hrr_2010 if quintile_dm_2yr==3, detail
sum tot_eol_spending_hrr_2010 if quintile_dm_2yr==4, detail
sum tot_eol_spending_hrr_2010 if quintile_dm_2yr==5, detail

********************************************************************
//next assign quartiles (same as in previous header section)
//split into quartiles by wage index adjusted DA hrr medicare spending

sort tot_eol_spending_hrr_2010  

//calculate quartiles based on the 2010 wage index, inflation adjusted DA 2yr EOL spending
centile tot_eol_spending_hrr_2010 , centile(25 75)
sca d_qui_25=r(c_1)
sca d_qui_75=r(c_2)

gen quart3_dm_2yr=.
replace quart3_dm_2yr=1 if tot_eol_spending_hrr_2010<=d_qui_25 & tot_eol_spending_hrr_2010<.
replace quart3_dm_2yr=2 if tot_eol_spending_hrr_2010>d_qui_25 & tot_eol_spending_hrr_2010<d_qui_75
replace quart3_dm_2yr=3 if tot_eol_spending_hrr_2010>=d_qui_75 & tot_eol_spending_hrr_2010<.

tab quart3_dm_2yr, missing
la var quart3_dm_2yr"Quartiles of 2 year Dartmouth EOL Medicare Spending, HRR level (within this sample)"
la def quart 1 "Bottom 25%" 2 "25-75%" 3 "Top 75%" 
la val quart3_dm_2yr quart

sum tot_eol_spending_hrr_2010 if quart3_dm_2yr==1, detail
sum tot_eol_spending_hrr_2010 if quart3_dm_2yr==2, detail
sum tot_eol_spending_hrr_2010 if quart3_dm_2yr==3, detail

********************************************************************
//next adjust each of the components by age, gender, race
//age is 5 year age at death categories
//race is black, hispanic, base=white+other
local toadj ip_paid_by_mc_60m_wi snf_paid_by_mc_60m_wi ///
hh_paid_by_mc_60m_wi hs_paid_by_mc_60m_wi pb_paid_by_mc_60m_wi op_paid_by_mc_60m_wi ///
dm_paid_by_mc_60m_wi helper_oop_60m hospital_oop_60m nh_oop_60m ///
doctor_oop_60m rx_oop_60m insurance_costs_60m other_oop_60m  ///
nh_cost_medicaid_60m nh_cost_private_60m inf_care_costs_60m ///
helper_oop_60m_wi hospital_oop_60m_wi nh_oop_60m_wi ///
doctor_oop_60m_wi rx_oop_60m_wi insurance_costs_60m_wi other_oop_60m_wi  ///
nh_cost_medicaid_60m_wi nh_cost_private_60m_wi inf_care_costs_60m_wi 

foreach v in `toadj'{
	egen mean_`v'=mean(`v')

	reg `v' i.age_at_death_cat i.black i.hisp_eth i.female_x

	predict resid_`v', residual

	gen adj_`v'=mean_`v'+resid_`v'
	sum adj_`v', detail
	sum `v', detail
	}

//now calculate totals using the adjusted values
//just medicare is wage index adjusted
gen adj_tot_paid_by_mc_60m_wi = adj_ip_paid_by_mc_60m_wi + adj_snf_paid_by_mc_60m_wi ///
+ adj_hh_paid_by_mc_60m_wi + adj_hs_paid_by_mc_60m_wi + adj_pb_paid_by_mc_60m_wi + adj_op_paid_by_mc_60m_wi ///
+ adj_dm_paid_by_mc_60m_wi 

gen adj_total_oop_60m = adj_helper_oop_60m + adj_hospital_oop_60m + adj_nh_oop_60m ///
+ adj_doctor_oop_60m + adj_rx_oop_60m + adj_insurance_costs_60m + adj_other_oop_60m

gen adj_tot_gov_pay_60m = adj_tot_paid_by_mc_60m_wi + adj_nh_cost_medicaid_60m

gen adj_total_nh_costs_60m = adj_nh_cost_medicaid_60m + adj_nh_cost_private_60m + ///
adj_snf_paid_by_mc_60m_wi + adj_nh_oop_60m

gen adj_total_costs_60m = adj_tot_paid_by_mc_60m_wi + adj_total_oop_60m + adj_nh_cost_medicaid_60m ///
+ adj_nh_cost_private_60m + adj_inf_care_costs_60m

sum adj_tot_paid_by_mc_60m_wi, detail
sum tot_paid_by_mc_60m_wi, detail
sum adj_total_oop_60m, detail
sum total_oop_60m, detail
sum adj_tot_gov_pay_60m, detail
sum tot_gov_pay_60m, detail
sum adj_total_nh_costs_60m, detail
sum total_nh_costs_60m, detail
sum adj_total_costs_60m, detail
sum total_costs_60m, detail

//all categories are wage index adjusted
gen adj_total_oop_60m_wi = adj_helper_oop_60m_wi + adj_hospital_oop_60m_wi + adj_nh_oop_60m_wi ///
+ adj_doctor_oop_60m_wi + adj_rx_oop_60m_wi + adj_insurance_costs_60m_wi + adj_other_oop_60m_wi

gen adj_tot_gov_pay_60m_wi = adj_tot_paid_by_mc_60m_wi + adj_nh_cost_medicaid_60m_wi

gen adj_total_nh_costs_60m_wi = adj_nh_cost_medicaid_60m_wi + adj_nh_cost_private_60m_wi + ///
adj_snf_paid_by_mc_60m_wi + adj_nh_oop_60m_wi

gen adj_total_costs_60m_wi = adj_tot_paid_by_mc_60m_wi + adj_total_oop_60m_wi + adj_nh_cost_medicaid_60m_wi ///
+ adj_nh_cost_private_60m_wi + adj_inf_care_costs_60m_wi

sum adj_total_oop_60m_wi, detail
sum total_oop_60m_wi, detail
sum adj_tot_gov_pay_60m_wi, detail
sum tot_gov_pay_60m_wi, detail
sum adj_total_nh_costs_60m_wi, detail
sum total_nh_costs_60m_wi, detail
sum adj_total_costs_60m_wi, detail
sum total_costs_60m_wi, detail
********************************************************************

********************************************************************
//finally add additional adjustment variables
// adjust by age, gender, race, ever smoked cigarettes, ADL status from exit, 
// count of comorbidities, education level
//adl status partial dependence, severe dependence or bedbound (indpendend=base category)
//age is 5 year age at death categories
//race is black, hispanic, base=white+other 

label define adl_cat_x 0 "Independent" 1 "Partial Dependence" 2 "Severe Dependence" ///
      3 "Restricted to Bed", modify
label values adl_cat_x adl_cat_x
tab adl_cat_x, missing


foreach v in `toadj'{

	areg `v' i.age_at_death_cat i.black i.hisp_eth i.female_x i.educ_hsdeg i.smoke_ever_n1 ///
		ib0.adl_cat_x, absorb(comorb_all_0d_n24m)

	predict resid_fa_`v', residual

	gen fadj_`v'=mean_`v'+resid_fa_`v'
	sum fadj_`v', detail
	sum `v', detail
	}

//now calculate totals using the adjusted values
//just medicare is wage index adjusted
gen fadj_tot_paid_by_mc_60m_wi = fadj_ip_paid_by_mc_60m_wi + fadj_snf_paid_by_mc_60m_wi ///
+ fadj_hh_paid_by_mc_60m_wi + fadj_hs_paid_by_mc_60m_wi + fadj_pb_paid_by_mc_60m_wi + fadj_op_paid_by_mc_60m_wi ///
+ fadj_dm_paid_by_mc_60m_wi 

gen fadj_total_oop_60m = fadj_helper_oop_60m + fadj_hospital_oop_60m + fadj_nh_oop_60m ///
+ fadj_doctor_oop_60m + fadj_rx_oop_60m + fadj_insurance_costs_60m + fadj_other_oop_60m

gen fadj_tot_gov_pay_60m = fadj_tot_paid_by_mc_60m_wi + fadj_nh_cost_medicaid_60m

gen fadj_total_nh_costs_60m = fadj_nh_cost_medicaid_60m + fadj_nh_cost_private_60m + ///
fadj_snf_paid_by_mc_60m_wi + fadj_nh_oop_60m

gen fadj_total_costs_60m = fadj_tot_paid_by_mc_60m_wi + fadj_total_oop_60m + fadj_nh_cost_medicaid_60m ///
+ fadj_nh_cost_private_60m + fadj_inf_care_costs_60m

sum fadj_tot_paid_by_mc_60m_wi, detail
sum tot_paid_by_mc_60m_wi, detail
sum fadj_total_oop_60m, detail
sum total_oop_60m, detail
sum fadj_tot_gov_pay_60m, detail
sum tot_gov_pay_60m, detail
sum fadj_total_nh_costs_60m, detail
sum total_nh_costs_60m, detail
sum fadj_total_costs_60m, detail
sum total_costs_60m, detail

//all categories are wage index adjusted
gen fadj_total_oop_60m_wi = fadj_helper_oop_60m_wi + fadj_hospital_oop_60m_wi + fadj_nh_oop_60m_wi ///
+ fadj_doctor_oop_60m_wi + fadj_rx_oop_60m_wi + fadj_insurance_costs_60m_wi + fadj_other_oop_60m_wi

gen fadj_tot_gov_pay_60m_wi = fadj_tot_paid_by_mc_60m_wi + fadj_nh_cost_medicaid_60m_wi

gen fadj_total_nh_costs_60m_wi = fadj_nh_cost_medicaid_60m_wi + fadj_nh_cost_private_60m_wi + ///
fadj_snf_paid_by_mc_60m_wi + fadj_nh_oop_60m_wi

gen fadj_total_costs_60m_wi = fadj_tot_paid_by_mc_60m_wi + fadj_total_oop_60m_wi + fadj_nh_cost_medicaid_60m_wi ///
+ fadj_nh_cost_private_60m_wi + fadj_inf_care_costs_60m_wi

sum fadj_total_oop_60m_wi, detail
sum total_oop_60m_wi, detail
sum fadj_tot_gov_pay_60m_wi, detail
sum tot_gov_pay_60m_wi, detail
sum fadj_total_nh_costs_60m_wi, detail
sum total_nh_costs_60m_wi, detail
sum fadj_total_costs_60m_wi, detail
sum total_costs_60m_wi, detail
********************************************************************

//save the dataset at this point, create tables by quintile in the next header section
save oop_mc_sample_adj_age_etc.dta, replace
********************************************************************
log close


H="Quintile spending 5yr EOL adjusted"
/*This section creates tables by DA 2 year EOL HRR quintiles
of age,sex, race adjusted 5 year EOL spending per the HRS dataset

Also creates pie charts comparing the spending across quintiles

Note Spending is NOT wage index adjusted across all categories in this version*/


capture log close
clear all
set mem 500m
set more off

local logpath E:\data\hrs_oop_2010\logs
local datapath E:\data\hrs_oop_2010\final_data
//local logpath H:\OOP\local_logs
//local datapath C:\Users\gorger01\Desktop\oop

log using `logpath'\11-mc_oop_5yr_adjust_quintiles-LOG.txt, text replace

cd `datapath'

use oop_mc_sample_adj_age_etc.dta
**************************************************
//Create tables of spending by quintile, overall sample (unadjusted)
local spvars age_at_death_e adj_total_costs_60m adj_tot_gov_pay_60m adj_tot_paid_by_mc_60m_wi ///
adj_ip_paid_by_mc_60m_wi adj_snf_paid_by_mc_60m_wi adj_hh_paid_by_mc_60m_wi ///
adj_hs_paid_by_mc_60m_wi adj_pb_paid_by_mc_60m_wi adj_op_paid_by_mc_60m_wi ///
adj_dm_paid_by_mc_60m_wi adj_nh_cost_medicaid_60m adj_total_oop_60m adj_helper_oop_60m ///
adj_hospital_oop_60m adj_nh_oop_60m ///
adj_doctor_oop_60m adj_rx_oop_60m adj_insurance_costs_60m adj_other_oop_60m nh_nights_60m ///
 adj_nh_cost_private_60m adj_total_nh_costs_60m adj_inf_care_costs_60m ///
medicaid_x

mat mean_adj1 = J(26,10,.)

//first row - get n each quintile
local c=1
forvalues i=1/5{
sum exit_year_x if(quintile_dm_2yr==`i')
mat mean_adj1[1,`c'] = r(N)
local c = `c'+2
}

local r=2
foreach v in `spvars' {
	local c=1
	forvalues i = 1/5 {
		sum(`v') if(quintile_dm_2yr==`i'), detail
		mat mean_adj1[`r',`c'] = r(mean)
		mat mean_adj1[(`r'),`c'+1] = r(p50)
		local c = `c' + 2
	}
	local r=`r'+1
}

//for medicaid percent, multiply mean by 100
forvalues c = 1/10{
mat mean_adj1[`r'-1,`c']=mean_adj1[`r'-1,`c']*100	
}	

mat rownames mean_adj1= "N" "Age at death" "Total payments, all types" "Total government payments" ///
"Total Medicare payments" "Medicare IP" "Medicare SNF" "Medicare HH" ///
"Medicare Hospice" "Medicare Carrier" "Medicare OP" "Medicare DME" "Medicaid NH Payments" ///
"OOP Total" "OOP Helper" "OOP Hospital" "OOP NH" "OOP Doctor" "OOP Rx" ///
"OOP Insurance Costs" "OOP Other" ///
"Total NH nights, SR or claims" ///
"Private payer NH Payments" "Total NH costs, all payers" "Imputed informal care costs" "Medicaid at death? (percent)"

mat list mean_adj1

frmttable using "`logpath'\11-Adj_5yr_HRR_Quintiles" , statmat(mean_adj1) ///
	title("Five Year EOL Spending by Quintiles of HRR-level Medicare EOL Spending" \ ///
	"(within this sample) Adjusted for age, race, gender") ///
	ctitle("","Quintile 1 (lowest)", "2", "3", "4", "5 (highest)") ///
	note("Medicare spending totals are adjusted for the 2010 CMS wage index" \ ///
	"All $ values adjusted for inflation to 2010$" \ ///
	"Spending amounts are adjusted using linear regression for age (5 year categories)" \ ///
	"gender and race (black, Hispanic, other)." \ ///
	"Total government payments = Medicare + Medicaid nursing home" \ ///
	"Total NH spending = Medicare + OOP + Medicaid or Private Payer" \ ///
	"Informal caregivers are spouses and other unpaid (mainly children), replacement wage imputation")  ///
	sdec(0) substat(1) replace
************************************************************
//Now create quintile tables for each of the 4 disease groups
foreach d in pr_dem_gt50 cancer_grp heartdis_grp other_grp{
	mat mean_`d' = J(26,10,.)

	//first row - get n each quintile
	local c=1
	forvalues i=1/5{
		sum exit_year_x if(quintile_dm_2yr==`i' & `d'==1)
		mat mean_`d'[1,`c'] = r(N)
		local c = `c'+2
		}

	local r=2
	foreach v in `spvars' {
		local c=1
		forvalues i = 1/5 {
			sum(`v') if(quintile_dm_2yr==`i'& `d'==1), detail
			mat mean_`d'[`r',`c'] = r(mean)
			mat mean_`d'[(`r'),`c'+1] = r(p50)
			local c = `c' + 2
		}
		local r=`r'+1
	}

	//for medicaid percent, multiply mean by 100
	forvalues c = 1/10{
		mat mean_`d'[`r'-1,`c']=mean_`d'[`r'-1,`c']*100	
	}	

mat rownames mean_`d'= "N" "Age at death" "Total payments, all types" "Total government payments" "Total Medicare payments" ///
"Medicare IP" "Medicare SNF" "Medicare HH" "Medicare Hospice" "Medicare Carrier" "Medicare OP"  ///
"Medicare DME" "Medicaid NH Payments" "OOP Total" "OOP Helper" "OOP Hospital" "OOP NH" "OOP Doctor" "OOP Rx" ///
"OOP Insurance Costs" "OOP Other" ///
"Total NH nights, SR or claims" "Private payer NH Payments" ///
"Total NH costs, all payers" "Imputed informal care costs" "Medicaid at death? (percent)"

mat list mean_`d'

frmttable using "`logpath'\11-Adj_5yr_HRR_Quintiles" , statmat(mean_`d') ///
	title("`d' Five Year EOL Spending by Quintiles of HRR-level Medicare" \ ///
	"EOL Spending (within this sample) Adjusted for age, race, gender") ///
	ctitle("","Quintile 1 (lowest)", "2", "3", "4", "5 (highest)") ///
	note("Medicare spending totals are adjusted for the 2010 CMS wage index" \ ///
	"All $ values adjusted for inflation to 2010$" \ ///
	"Spending amounts are adjusted using linear regression for age (5 year categories)" \ ///
	"gender and race (black, Hispanic, other)." \ ///
	"Total government payments = Medicare + Medicaid nursing home" \ ///
	"Total NH spending = Medicare + OOP + Medicaid or Private Payer" \ ///
	"Informal caregivers are spouses and other unpaid (mainly children), replacement wage imputation")  ///
	sdec(0) substat(1) addtable

}
************************************************************
//Create single table looking at the high/low quintiles 
//for each of the disease groups for an easier comparison
mat mean_hilo = J(26,16,.)


//first row - get n each quintile
local c=1
foreach d in pr_dem_gt50 cancer_grp heartdis_grp other_grp{	
	foreach i of numlist 1 5{
		sum exit_year_x if(quintile_dm_2yr==`i' & `d'==1)
		mat mean_hilo[1,`c'] = r(N)
		local c = `c'+2
		}
}

local r=2

foreach v in `spvars' {
		local c=1
		foreach i of numlist 1 5{
			sum(`v') if(quintile_dm_2yr==`i'& pr_dem_gt50==1), detail
			mat mean_hilo[`r',`c'] = r(mean)
			mat mean_hilo[(`r'),`c'+1] = r(p50)
		
			sum(`v') if(quintile_dm_2yr==`i'& cancer_grp==1), detail
			mat mean_hilo[`r',`c'+4] = r(mean)
			mat mean_hilo[(`r'),`c'+5] = r(p50)
		
			sum(`v') if(quintile_dm_2yr==`i'& heartdis_grp==1), detail
			mat mean_hilo[`r',`c'+8] = r(mean)
			mat mean_hilo[(`r'),`c'+9] = r(p50)

			sum(`v') if(quintile_dm_2yr==`i'& other_grp==1), detail
			mat mean_hilo[`r',`c'+12] = r(mean)
			mat mean_hilo[(`r'),`c'+13] = r(p50)
		
			local c = `c' + 2		
		}
		local r=`r'+1
}


	//for medicaid percent, multiply mean by 100
	forvalues c = 1/16{
		mat mean_hilo[`r'-1,`c']=mean_hilo[`r'-1,`c']*100		
}
mat list mean_hilo

mat rownames mean_hilo= "N" "Age at death" "Total payments, all types" "Total government payments" "Total Medicare payments" ///
"Medicare IP" "Medicare SNF" "Medicare HH" "Medicare Hospice" "Medicare Carrier" "Medicare OP"  ///
"Medicare DME" "Medicaid NH Payments" "OOP Total" "OOP Helper" "OOP Hospital" "OOP NH" "OOP Doctor" "OOP Rx" ///
"OOP Insurance Costs" "OOP Other" ///
"Total NH nights, SR or claims" "Private payer NH Payments" ///
"Total NH costs, all payers" "Imputed informal care costs" "Medicaid at death? (percent)"

mat list mean_hilo

frmttable using "`logpath'\11-Adj_5yr_HRR_Quintiles" , statmat(mean_hilo) ///
	title("1 / 5th Quintile 5yr EOL Spending for the 4 disease groups" \ ///
	"(Quintiles DA 2y EOL MC spending within this sample) Adjusted for age, race, gender") ///
	ctitle("","Dementia","","Cancer","","Heart Disease","","Other disease","" \ ///
	"","Q1","Q5","Q1","Q5","Q1","Q5","Q1","Q5") ///
	note("Medicare spending totals are adjusted for the 2010 CMS wage index" \ ///
	"All $ values adjusted for inflation to 2010$" \ ///
	"Spending amounts are adjusted using linear regression for age (5 year categories)" \ ///
	"gender and race (black, Hispanic, other)." \ ///
	"Total government payments = Medicare + Medicaid nursing home" \ ///
	"Total NH spending = Medicare + OOP + Medicaid or Private Payer" \ ///
	"Informal caregivers are spouses and other unpaid (mainly children), replacement wage imputation")  ///
	sdec(0) substat(1) landscape addtable


************************************************************
//Pie charts of spending by category by quintile and disease group
//OA sample
//local logpath H:\OOP\local_logs
cd "`logpath'\graphs"
//OA sample - all disease groups included
sum adj_total_costs_60m
sca oa_tot=r(mean)
local oatot = round(oa_tot)
di `oatot'

local slices adj_tot_paid_by_mc_60m_wi adj_nh_cost_medicaid_60m adj_nh_cost_private_60m ///
adj_total_oop_60m adj_inf_care_costs_60m

//relabel spending categories so labels can be used in the legends
la var adj_tot_paid_by_mc_60m_wi "Adj Medicare"
la var adj_nh_cost_medicaid_60m "Adj Medicaid NH"
la var adj_nh_cost_private_60m "Adj Private Payer NH"
la var adj_total_oop_60m "Adj OOP"
la var adj_inf_care_costs_60m "Adj Informal care"

graph pie `slices' ///
, plabel(_all percent) subtitle("Overall, All Q's",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`oatot'",ring(0) position(7)) legend(cols(3))
graph save adj_oa_spend, replace

forvalues i=1/5{ 
sum adj_total_costs_60m if quintile_dm_2yr ==`i'
sca oa_q_`i'=r(mean)
local oa_q`i' = round(oa_q_`i')

graph pie `slices' ///
if quintile_dm_2yr ==`i' , plabel(_all percent) subtitle("Overall, Q-`i'",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`oa_q`i''",ring(0) position(7))	
graph save adj_oa_quint_`i', replace
}
//Dementia sample
sum adj_total_costs_60m if pr_dem_gt50==1
sca d_all=r(mean)
local d_all = round(d_all)
	
graph pie `slices' ///
if pr_dem_gt50==1, plabel(_all percent) subtitle("Dementia, All Q's",ring(0) position(11)) ///
note("Total 5y EOL" "spending=`d_all'",ring(0) position(7))
graph save adj_pr_dem_gt50_spend, replace

forvalues i=1/5{
	sum adj_total_costs_60m if  pr_dem_gt50==1 & quintile_dm_2yr ==`i'
	sca d_q_`i'=r(mean)
	local d_q`i' = round(d_q_`i')

	graph pie `slices' ///
	if pr_dem_gt50==1 & quintile_dm_2yr ==`i' , plabel(_all percent)  ///
	subtitle("Dementia, Q-`i'",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`d_q`i''",ring(0) position(7))	
	graph save adj_pr_dem_gt50_quint_`i', replace
}

//Cancer sample
sum adj_total_costs_60m if cancer_grp==1
sca c_all=r(mean)
local c_all = round(c_all)

graph pie `slices' ///
if cancer_grp==1, plabel(_all percent) subtitle("Cancer, All Q's",ring(0) position(11)) ///
note("Total 5y EOL" "spending=`c_all'",ring(0) position(7))
graph save adj_cancer_grp_spend, replace

forvalues i=1/5{ 
	sum adj_total_costs_60m if  cancer_grp==1 & quintile_dm_2yr ==`i'
	sca c_q_`i'=r(mean)
	local c_q`i' = round(c_q_`i')

	graph pie `slices' ///
	if cancer_grp==1 & quintile_dm_2yr ==`i' , plabel(_all percent) ///
	subtitle("Cancer, Q-`i'",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`c_q`i''",ring(0) position(7))
	graph save adj_cancer_grp_quint_`i', replace
}

//Heart disease sample
sum adj_total_costs_60m if heartdis_grp==1
sca h_all=r(mean)
local h_all = round(h_all)

graph pie `slices' ///
if heartdis_grp==1, plabel(_all percent) subtitle("Heart Disease, All Q's",ring(0) position(11)) ///
note("Total 5y EOL" "spending=`h_all'",ring(0) position(7))
graph save adj_heartdis_grp_spend, replace

forvalues i=1/5{ 
	sum adj_total_costs_60m if  heartdis_grp==1 & quintile_dm_2yr ==`i'
	sca h_q_`i'=r(mean)
	local h_q`i' = round(h_q_`i')
	
	graph pie `slices' ///
	if heartdis_grp==1 & quintile_dm_2yr ==`i' , plabel(_all percent) ///
	subtitle("Heart Disease, Q-`i'",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`h_q`i''",ring(0) position(7))
	graph save adj_heartdis_grp_quint_`i', replace
}

//Other diseases sample
sum adj_total_costs_60m if other_grp==1
sca o_all=r(mean)
local o_all = round(o_all)

graph pie `slices' ///
if other_grp==1, plabel(_all percent) subtitle("Other disease, All Q's",ring(0) position(11)) ///
note("Total 5y EOL" "spending=`o_all'",ring(0) position(7))
graph save adj_other_grp_spend, replace

forvalues i=1/5{ 
	sum adj_total_costs_60m if  other_grp==1 & quintile_dm_2yr ==`i'
	sca o_q_`i'=r(mean)
	local o_q`i' = round(o_q_`i')
	
	graph pie `slices' ///
	if other_grp==1 & quintile_dm_2yr ==`i' , plabel(_all percent) ///
	subtitle("Other disease, Q-`i'",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`o_q`i''",ring(0) position(7))	
	graph save adj_other_grp_quint_`i', replace
}

cd `logpath'\graphs

grc1leg adj_oa_spend.gph adj_oa_quint_1.gph adj_oa_quint_2.gph adj_oa_quint_3.gph adj_oa_quint_4.gph adj_oa_quint_5.gph ///
 adj_pr_dem_gt50_spend.gph adj_pr_dem_gt50_quint_1.gph adj_pr_dem_gt50_quint_2.gph adj_pr_dem_gt50_quint_3.gph ///
 adj_pr_dem_gt50_quint_4.gph adj_pr_dem_gt50_quint_5.gph ///
 adj_cancer_grp_spend.gph adj_cancer_grp_quint_1.gph adj_cancer_grp_quint_2.gph adj_cancer_grp_quint_3.gph ///
 adj_cancer_grp_quint_4.gph adj_cancer_grp_quint_5.gph ///
 adj_heartdis_grp_spend.gph adj_heartdis_grp_quint_1.gph adj_heartdis_grp_quint_2.gph adj_heartdis_grp_quint_3.gph ///
 adj_heartdis_grp_quint_4.gph adj_heartdis_grp_quint_5.gph ///
 adj_other_grp_spend.gph adj_other_grp_quint_1.gph adj_other_grp_quint_2.gph adj_other_grp_quint_3.gph ///
 adj_other_grp_quint_4.gph adj_other_grp_quint_5.gph, ///
  col(6)
graph save adj_panel_quint_1leg, replace
graph export adj_panel_quint_1leg.tif, replace

*********************************************************
log close


H="Quintiles spending, wage index, age,sex,race adj"
/*This section creates tables by DA 2 year EOL HRR quintiles
of age,sex, race adjusted 5 year EOL spending per the HRS dataset

Also creates pie charts comparing the spending across quintiles

Note Spending is wage index adjusted across all categories in this version*/

capture log close
clear all
set mem 500m
set more off

local logpath E:\data\hrs_oop_2010\logs
local datapath E:\data\hrs_oop_2010\final_data
//local logpath H:\OOP\local_logs
//local datapath C:\Users\gorger01\Desktop\oop

log using `logpath'\12-mc_oop_5yr_adjust_wi_quintiles-LOG.txt, text replace

cd `datapath'

use oop_mc_sample_adj_age_etc.dta
**************************************************
local spvars age_at_death_e adj_total_costs_60m_wi adj_tot_gov_pay_60m_wi adj_tot_paid_by_mc_60m_wi ///
adj_ip_paid_by_mc_60m_wi adj_snf_paid_by_mc_60m_wi adj_hh_paid_by_mc_60m_wi ///
adj_hs_paid_by_mc_60m_wi adj_pb_paid_by_mc_60m_wi adj_op_paid_by_mc_60m_wi ///
adj_dm_paid_by_mc_60m_wi adj_nh_cost_medicaid_60m_wi adj_total_oop_60m_wi adj_helper_oop_60m_wi ///
adj_hospital_oop_60m_wi adj_nh_oop_60m_wi ///
adj_doctor_oop_60m_wi adj_rx_oop_60m_wi adj_insurance_costs_60m_wi adj_other_oop_60m_wi nh_nights_60m ///
 adj_nh_cost_private_60m_wi adj_total_nh_costs_60m_wi adj_inf_care_costs_60m_wi ///
medicaid_x

**************************************************
//create tables of spending categories, by disease group (prior
//tables by quintiles of spending)

//get tables comparing mean, median spending for different disease groups
mat dg_5y=J(26,8,.)
//first row n each group
tab pr_dem_gt50, missing matcell(r1_50)
mat dg_5y[1,1]=r1_50[2,1] //with dem prob > 50% col 1
tab cancer_grp, missing matcell(r1_c)
mat dg_5y[1,3]=r1_c[2,1] //with cancer col 2
tab heartdis_grp , missing matcell(r1_h)
mat dg_5y[1,5]=r1_h[2,1] //with heart disease col 3
tab other_grp , missing matcell(r1_o)
mat dg_5y[1,7]=r1_o[2,1] //with other disease col 4

//totals 5 years, wage index adjusted mc payments, oop spend and nh nights
local c=1
foreach d in pr_dem_gt50 cancer_grp heartdis_grp other_grp{
	local r = 2
	foreach v in `spvars'{
		sum `v' if `d'==1, detail
		mat dg_5y[`r',`c']=r(mean)
		mat dg_5y[`r',`c'+1]=r(p50)
		local r = `r'+1
		}
	local c = `c'+2
	}
//convert medicaid rate to percent
forvalues i = 1/8{
mat dg_5y[`r'-1,`i']=dg_5y[`r'-1,`i']*100	
}	
	
mat rownames dg_5y= "N" "Age at death" "Total payments, all types" "Total government payments" "Total Medicare payments" ///
"Medicare IP" "Medicare SNF" "Medicare HH" ///
"Medicare Hospice" "Medicare Carrier" "Medicare OP" "Medicare DME" ///
"OOP Total" "OOP Helper" "OOP Hospital" "OOP NH" "OOP Doctor" "OOP Rx" ///
"OOP Insurance Costs" "OOP Other" ///
"Total NH nights, SR or claims" "Medicaid NH Payments" ///
"Private payer NH Payments" "Total NH costs, all payers" "Imputed informal care costs" "Medicaid at death? (percent)"

mat list dg_5y

frmttable using `logpath'\12-Adj_wi_5yr_HRR_Quintiles, statmat(dg_5y) ///
title("Dementia, Cancer and Heart Disease Patients, Medicare and OOP Spending Last 5 years of life" \ ///
"Adjusted for wage index, age, race, gender") ///
note("All spending categories are adjusted for the 2010 CMS wage index" \ ///
"All $ values adjusted for inflation to 2010$" \ ///
"Total government payments = Medicare + Medicaid nursing home" \ ///
"Total NH spending = Medicare + OOP + Medicaid or Private Payer" \ ///
"Informal caregivers are spouses and other unpaid (mainly children), replacemnt wage imputation")  ///
ctitles("" "Prob dem"  "Cancer" "Heart disease" "Other" \ ///
"" " > 50%" "" "" "" \ ///
"" "Mean"  "Mean" "Mean" "Mean" \ "" "Median"  "Median" "Median" "Median"  ) ///
sdec(0) substat(1) replace 

**************************************************
//Create tables of spending by quintile, overall sample (unadjusted)
mat mean_adj1 = J(26,10,.)

//first row - get n each quintile
local c=1
forvalues i=1/5{
sum exit_year_x if(quintile_dm_2yr==`i')
mat mean_adj1[1,`c'] = r(N)
local c = `c'+2
}

local r=2
foreach v in `spvars' {
	local c=1
	forvalues i = 1/5 {
		sum(`v') if(quintile_dm_2yr==`i'), detail
		mat mean_adj1[`r',`c'] = r(mean)
		mat mean_adj1[(`r'),`c'+1] = r(p50)
		local c = `c' + 2
	}
	local r=`r'+1
}

//for medicaid percent, multiply mean by 100
forvalues c = 1/10{
mat mean_adj1[`r'-1,`c']=mean_adj1[`r'-1,`c']*100	
}	

mat rownames mean_adj1= "N" "Age at death" "Total payments, all types" "Total government payments" ///
"Total Medicare payments" "Medicare IP" "Medicare SNF" "Medicare HH" ///
"Medicare Hospice" "Medicare Carrier" "Medicare OP" "Medicare DME" "Medicaid NH Payments" ///
"OOP Total" "OOP Helper" "OOP Hospital" "OOP NH" "OOP Doctor" "OOP Rx" ///
"OOP Insurance Costs" "OOP Other" ///
"Total NH nights, SR or claims" ///
"Private payer NH Payments" "Total NH costs, all payers" "Imputed informal care costs" "Medicaid at death? (percent)"

mat list mean_adj1

frmttable using "`logpath'\12-Adj_wi_5yr_HRR_Quintiles" , statmat(mean_adj1) ///
	title("Five Year EOL Spending by Quintiles of HRR-level Medicare EOL Spending" \ ///
	"(within this sample) Adjusted for wage index, age, race, gender") ///
	ctitle("","Quintile 1 (lowest)", "2", "3", "4", "5 (highest)") ///
	note("All spending categories are adjusted for the 2010 CMS wage index" \ ///
	"All $ values adjusted for inflation to 2010$" \ ///
	"Spending amounts are adjusted using linear regression for age (5 year categories)" \ ///
	"gender and race (black, Hispanic, other)." \ ///
	"Total government payments = Medicare + Medicaid nursing home" \ ///
	"Total NH spending = Medicare + OOP + Medicaid or Private Payer" \ ///
	"Informal caregivers are spouses and other unpaid (mainly children), replacement wage imputation")  ///
	sdec(0) substat(1) addtable

************************************************************
//Now create quintile tables for each of the 4 disease groups
foreach d in pr_dem_gt50 cancer_grp heartdis_grp other_grp{
	mat mean_`d' = J(26,10,.)

	//first row - get n each quintile
	local c=1
	forvalues i=1/5{
		sum exit_year_x if(quintile_dm_2yr==`i' & `d'==1)
		mat mean_`d'[1,`c'] = r(N)
		local c = `c'+2
		}

	local r=2
	foreach v in `spvars' {
		local c=1
		forvalues i = 1/5 {
			sum(`v') if(quintile_dm_2yr==`i'& `d'==1), detail
			mat mean_`d'[`r',`c'] = r(mean)
			mat mean_`d'[(`r'),`c'+1] = r(p50)
			local c = `c' + 2
		}
		local r=`r'+1
	}

	//for medicaid percent, multiply mean by 100
	forvalues c = 1/10{
		mat mean_`d'[`r'-1,`c']=mean_`d'[`r'-1,`c']*100	
	}	

mat rownames mean_`d'= "N" "Age at death" "Total payments, all types" "Total government payments" "Total Medicare payments" ///
"Medicare IP" "Medicare SNF" "Medicare HH" "Medicare Hospice" "Medicare Carrier" "Medicare OP"  ///
"Medicare DME" "Medicaid NH Payments" "OOP Total" "OOP Helper" "OOP Hospital" "OOP NH" "OOP Doctor" "OOP Rx" ///
"OOP Insurance Costs" "OOP Other" ///
"Total NH nights, SR or claims" "Private payer NH Payments" ///
"Total NH costs, all payers" "Imputed informal care costs" "Medicaid at death? (percent)"

mat list mean_`d'

frmttable using "`logpath'\12-Adj_wi_5yr_HRR_Quintiles" , statmat(mean_`d') ///
	title("`d' Five Year EOL Spending by Quintiles of HRR-level Medicare" \ ///
	"EOL Spending (within this sample) Adjusted for wage index, age, race, gender") ///
	ctitle("","Quintile 1 (lowest)", "2", "3", "4", "5 (highest)") ///
	note("All spending categories are adjusted for the 2010 CMS wage index" \ ///
	"All $ values adjusted for inflation to 2010$" \ ///
	"Spending amounts are adjusted using linear regression for age (5 year categories)" \ ///
	"gender and race (black, Hispanic, other)." \ ///
	"Total government payments = Medicare + Medicaid nursing home" \ ///
	"Total NH spending = Medicare + OOP + Medicaid or Private Payer" \ ///
	"Informal caregivers are spouses and other unpaid (mainly children), replacement wage imputation")  ///
	sdec(0) substat(1) addtable

}
************************************************************
//Create single table looking at the high/low quintiles 
//for each of the disease groups for an easier comparison
mat mean_hilo = J(26,16,.)


//first row - get n each quintile
local c=1
foreach d in pr_dem_gt50 cancer_grp heartdis_grp other_grp{	
	foreach i of numlist 1 5{
		sum exit_year_x if(quintile_dm_2yr==`i' & `d'==1)
		mat mean_hilo[1,`c'] = r(N)
		local c = `c'+2
		}
}

local r=2

foreach v in `spvars' {
		local c=1
		foreach i of numlist 1 5{
			sum(`v') if(quintile_dm_2yr==`i'& pr_dem_gt50==1), detail
			mat mean_hilo[`r',`c'] = r(mean)
			mat mean_hilo[(`r'),`c'+1] = r(p50)
		
			sum(`v') if(quintile_dm_2yr==`i'& cancer_grp==1), detail
			mat mean_hilo[`r',`c'+4] = r(mean)
			mat mean_hilo[(`r'),`c'+5] = r(p50)
		
			sum(`v') if(quintile_dm_2yr==`i'& heartdis_grp==1), detail
			mat mean_hilo[`r',`c'+8] = r(mean)
			mat mean_hilo[(`r'),`c'+9] = r(p50)

			sum(`v') if(quintile_dm_2yr==`i'& other_grp==1), detail
			mat mean_hilo[`r',`c'+12] = r(mean)
			mat mean_hilo[(`r'),`c'+13] = r(p50)
		
			local c = `c' + 2		
		}
		local r=`r'+1
}


	//for medicaid percent, multiply mean by 100
	forvalues c = 1/16{
		mat mean_hilo[`r'-1,`c']=mean_hilo[`r'-1,`c']*100		
}
mat list mean_hilo

mat rownames mean_hilo= "N" "Age at death" "Total payments, all types" "Total government payments" "Total Medicare payments" ///
"Medicare IP" "Medicare SNF" "Medicare HH" "Medicare Hospice" "Medicare Carrier" "Medicare OP"  ///
"Medicare DME" "Medicaid NH Payments" "OOP Total" "OOP Helper" "OOP Hospital" "OOP NH" "OOP Doctor" "OOP Rx" ///
"OOP Insurance Costs" "OOP Other" ///
"Total NH nights, SR or claims" "Private payer NH Payments" ///
"Total NH costs, all payers" "Imputed informal care costs" "Medicaid at death? (percent)"

mat list mean_hilo

frmttable using "`logpath'\12-Adj_wi_5yr_HRR_Quintiles" , statmat(mean_hilo) ///
	title("1 / 5th Quintile 5yr EOL Spending for the 4 disease groups" \ ///
	"(Quintiles DA 2y EOL MC spending within this sample) Adjusted for wage index, age, race, gender") ///
	ctitle("","Dementia","","Cancer","","Heart Disease","","Other disease","" \ ///
	"","Q1","Q5","Q1","Q5","Q1","Q5","Q1","Q5") ///
	note("All spending categories are adjusted for the 2010 CMS wage index" \ ///
	"All $ values adjusted for inflation to 2010$" \ ///
	"Spending amounts are adjusted using linear regression for age (5 year categories)" \ ///
	"gender and race (black, Hispanic, other)." \ ///
	"Total government payments = Medicare + Medicaid nursing home" \ ///
	"Total NH spending = Medicare + OOP + Medicaid or Private Payer" \ ///
	"Informal caregivers are spouses and other unpaid (mainly children), replacement wage imputation")  ///
	sdec(0) substat(1) landscape addtable


************************************************************
//Pie charts of spending by category by quintile and disease group
//OA sample
//local logpath H:\OOP\local_logs
cd "`logpath'\graphs"
//OA sample - all disease groups included
sum adj_total_costs_60m_wi
sca oa_tot=r(mean)
local oatot = round(oa_tot)
di `oatot'

local slices adj_tot_paid_by_mc_60m_wi adj_nh_cost_medicaid_60m_wi adj_nh_cost_private_60m_wi ///
adj_total_oop_60m_wi adj_inf_care_costs_60m_wi

//relabel spending categories so labels can be used in the legends
la var adj_tot_paid_by_mc_60m_wi "WI Adj Medicare"
la var adj_nh_cost_medicaid_60m_wi "WI Adj Medicaid NH"
la var adj_nh_cost_private_60m_wi "WI Adj Private Payer NH"
la var adj_total_oop_60m_wi "WI Adj OOP"
la var adj_inf_care_costs_60m_wi "WI Adj Informal care"

graph pie `slices' ///
, plabel(_all percent) subtitle("Overall, All Q's",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`oatot'",ring(0) position(7)) legend(cols(3))
graph save adj_wi_oa_spend, replace

forvalues i=1/5{ 
sum adj_total_costs_60m if quintile_dm_2yr ==`i'
sca oa_q_`i'=r(mean)
local oa_q`i' = round(oa_q_`i')

graph pie `slices' ///
if quintile_dm_2yr ==`i' , plabel(_all percent) subtitle("Overall, Q-`i'",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`oa_q`i''",ring(0) position(7))	
graph save adj_wi_oa_quint_`i', replace
}
//Dementia sample
sum adj_total_costs_60m_wi if pr_dem_gt50==1
sca d_all=r(mean)
local d_all = round(d_all)
	
graph pie `slices' ///
if pr_dem_gt50==1, plabel(_all percent) subtitle("Dementia, All Q's",ring(0) position(11)) ///
note("Total 5y EOL" "spending=`d_all'",ring(0) position(7))
graph save adj_wi_pr_dem_gt50_spend, replace

forvalues i=1/5{
	sum adj_total_costs_60m if  pr_dem_gt50==1 & quintile_dm_2yr ==`i'
	sca d_q_`i'=r(mean)
	local d_q`i' = round(d_q_`i')

	graph pie `slices' ///
	if pr_dem_gt50==1 & quintile_dm_2yr ==`i' , plabel(_all percent)  ///
	subtitle("Dementia, Q-`i'",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`d_q`i''",ring(0) position(7))	
	graph save adj_wi_pr_dem_gt50_quint_`i', replace
}

//Cancer sample
sum adj_total_costs_60m_wi if cancer_grp==1
sca c_all=r(mean)
local c_all = round(c_all)

graph pie `slices' ///
if cancer_grp==1, plabel(_all percent) subtitle("Cancer, All Q's",ring(0) position(11)) ///
note("Total 5y EOL" "spending=`c_all'",ring(0) position(7))
graph save adj_wi_cancer_grp_spend, replace

forvalues i=1/5{ 
	sum adj_total_costs_60m if  cancer_grp==1 & quintile_dm_2yr ==`i'
	sca c_q_`i'=r(mean)
	local c_q`i' = round(c_q_`i')

	graph pie `slices' ///
	if cancer_grp==1 & quintile_dm_2yr ==`i' , plabel(_all percent) ///
	subtitle("Cancer, Q-`i'",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`c_q`i''",ring(0) position(7))
	graph save adj_wi_cancer_grp_quint_`i', replace
}

//Heart disease sample
sum adj_total_costs_60m_wi if heartdis_grp==1
sca h_all=r(mean)
local h_all = round(h_all)

graph pie `slices' ///
if heartdis_grp==1, plabel(_all percent) subtitle("Heart Disease, All Q's",ring(0) position(11)) ///
note("Total 5y EOL" "spending=`h_all'",ring(0) position(7))
graph save adj_wi_heartdis_grp_spend, replace

forvalues i=1/5{ 
	sum adj_total_costs_60m if  heartdis_grp==1 & quintile_dm_2yr ==`i'
	sca h_q_`i'=r(mean)
	local h_q`i' = round(h_q_`i')
	
	graph pie `slices' ///
	if heartdis_grp==1 & quintile_dm_2yr ==`i' , plabel(_all percent) ///
	subtitle("Heart Disease, Q-`i'",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`h_q`i''",ring(0) position(7))
	graph save adj_wi_heartdis_grp_quint_`i', replace
}

//Other diseases sample
sum adj_total_costs_60m_wi if other_grp==1
sca o_all=r(mean)
local o_all = round(o_all)

graph pie `slices' ///
if other_grp==1, plabel(_all percent) subtitle("Other disease, All Q's",ring(0) position(11)) ///
note("Total 5y EOL" "spending=`o_all'",ring(0) position(7))
graph save adj_wi_other_grp_spend, replace

forvalues i=1/5{ 
	sum adj_total_costs_60m if  other_grp==1 & quintile_dm_2yr ==`i'
	sca o_q_`i'=r(mean)
	local o_q`i' = round(o_q_`i')
	
	graph pie `slices' ///
	if other_grp==1 & quintile_dm_2yr ==`i' , plabel(_all percent) ///
	subtitle("Other disease, Q-`i'",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`o_q`i''",ring(0) position(7))	
	graph save adj_wi_other_grp_quint_`i', replace
}

cd `logpath'\graphs

grc1leg adj_wi_oa_spend.gph adj_wi_oa_quint_1.gph adj_wi_oa_quint_2.gph adj_wi_oa_quint_3.gph ///
 adj_wi_oa_quint_4.gph adj_wi_oa_quint_5.gph ///
 adj_wi_pr_dem_gt50_spend.gph adj_wi_pr_dem_gt50_quint_1.gph adj_wi_pr_dem_gt50_quint_2.gph adj_wi_pr_dem_gt50_quint_3.gph ///
 adj_wi_pr_dem_gt50_quint_4.gph adj_wi_pr_dem_gt50_quint_5.gph ///
 adj_wi_cancer_grp_spend.gph adj_wi_cancer_grp_quint_1.gph adj_wi_cancer_grp_quint_2.gph adj_wi_cancer_grp_quint_3.gph ///
 adj_wi_cancer_grp_quint_4.gph adj_wi_cancer_grp_quint_5.gph ///
 adj_wi_heartdis_grp_spend.gph adj_wi_heartdis_grp_quint_1.gph adj_wi_heartdis_grp_quint_2.gph adj_wi_heartdis_grp_quint_3.gph ///
 adj_wi_heartdis_grp_quint_4.gph adj_wi_heartdis_grp_quint_5.gph ///
 adj_wi_other_grp_spend.gph adj_wi_other_grp_quint_1.gph adj_wi_other_grp_quint_2.gph adj_wi_other_grp_quint_3.gph ///
 adj_wi_other_grp_quint_4.gph adj_wi_other_grp_quint_5.gph, ///
  col(6)
graph save adj_wi_panel_quint_1leg, replace
graph export adj_wi_panel_quint_1leg.tif, replace

*********************************************************
log close


H="Quartile spending, 5 year wi, EOL adjusted"
/*This section creates tables by DA 2 year EOL HRR quartiles 
in three groups (0-25%, 25-75%, 75-100%)
of age,sex, race adjusted 5 year EOL spending per the HRS dataset

Also creates pie charts comparing the spending across quartiles

Note Spending is wage index adjusted across all categories in this version*/

capture log close
clear all
set mem 500m
set more off

local logpath E:\data\hrs_oop_2010\logs
local datapath E:\data\hrs_oop_2010\final_data
//local logpath H:\OOP\local_logs
//local datapath C:\Users\gorger01\Desktop\oop

log using `logpath'\13-mc_oop_5yr_adjust_wi_quartiles-LOG.txt, text replace

cd `datapath'

use oop_mc_sample_adj_age_etc.dta
**************************************************
local spvars age_at_death_e adj_total_costs_60m_wi adj_tot_gov_pay_60m_wi adj_tot_paid_by_mc_60m_wi ///
adj_ip_paid_by_mc_60m_wi adj_snf_paid_by_mc_60m_wi adj_hh_paid_by_mc_60m_wi ///
adj_hs_paid_by_mc_60m_wi adj_pb_paid_by_mc_60m_wi adj_op_paid_by_mc_60m_wi ///
adj_dm_paid_by_mc_60m_wi adj_nh_cost_medicaid_60m_wi adj_total_oop_60m_wi adj_helper_oop_60m_wi ///
adj_hospital_oop_60m_wi adj_nh_oop_60m_wi ///
adj_doctor_oop_60m_wi adj_rx_oop_60m_wi adj_insurance_costs_60m_wi adj_other_oop_60m_wi nh_nights_60m ///
 adj_nh_cost_private_60m_wi adj_total_nh_costs_60m_wi adj_inf_care_costs_60m_wi ///
medicaid_x

**************************************************
//create tables of spending categories, by disease group (prior
//tables by quartiles of HRR spending)

//get tables comparing mean, median spending for different disease groups
mat dg_5y=J(26,8,.)
//first row n each group
tab pr_dem_gt50, missing matcell(r1_50)
mat dg_5y[1,1]=r1_50[2,1] //with dem prob > 50% col 1
tab cancer_grp, missing matcell(r1_c)
mat dg_5y[1,3]=r1_c[2,1] //with cancer col 2
tab heartdis_grp , missing matcell(r1_h)
mat dg_5y[1,5]=r1_h[2,1] //with heart disease col 3
tab other_grp , missing matcell(r1_o)
mat dg_5y[1,7]=r1_o[2,1] //with other disease col 4

//totals 5 years, wage index adjusted mc payments, oop spend and nh nights
local c=1
foreach d in pr_dem_gt50 cancer_grp heartdis_grp other_grp{
	local r = 2
	foreach v in `spvars'{
		sum `v' if `d'==1, detail
		mat dg_5y[`r',`c']=r(mean)
		mat dg_5y[`r',`c'+1]=r(p50)
		local r = `r'+1
		}
	local c = `c'+2
	}
//convert medicaid rate to percent
forvalues i = 1/8{
mat dg_5y[`r'-1,`i']=dg_5y[`r'-1,`i']*100	
}	
	
mat rownames dg_5y= "N" "Age at death" "Total payments, all types" "Total government payments" ///
"Total Medicare payments" "Medicare IP" "Medicare SNF" "Medicare HH" ///
"Medicare Hospice" "Medicare Carrier" "Medicare OP" "Medicare DME" ///
"Medicaid NH payments" "OOP Total" "OOP Helper" "OOP Hospital" "OOP NH" ///
"OOP Doctor" "OOP Rx" "OOP Insurance Costs" "OOP Other" ///
"Total NH nights, SR or claims" "Private payer NH Payments"  ///
"Total NH costs, all payers" "Imputed informal care costs" "Medicaid at death? (percent)"

mat list dg_5y

frmttable using `logpath'\13-Adj_wi_5yr_HRR_Quartiles, statmat(dg_5y) ///
title("Dementia, Cancer and Heart Disease Patients, Medicare and OOP Spending Last 5 years of life" \ ///
"Adjusted for wage index, age, race, gender") ///
note("All spending categories are adjusted for the 2010 CMS wage index" \ ///
"All $ values adjusted for inflation to 2010$" \ ///
"Total government payments = Medicare + Medicaid nursing home" \ ///
"Total NH spending = Medicare + OOP + Medicaid or Private Payer" \ ///
"Informal caregivers are spouses and other unpaid (mainly children), replacemnt wage imputation")  ///
ctitles("" "Prob dem"  "Cancer" "Heart disease" "Other" \ ///
"" " > 50%" "" "" "" \ ///
"" "Mean"  "Mean" "Mean" "Mean" \ "" "Median"  "Median" "Median" "Median"  ) ///
sdec(0) substat(1) replace 

**************************************************
//Create tables of spending by quartile, overall sample (unadjusted)
mat mean_adj1 = J(26,6,.)

//first row - get n each quartile
local c=1
forvalues i=1/3{
sum exit_year_x if(quart3_dm_2yr==`i')
mat mean_adj1[1,`c'] = r(N)
local c = `c'+2
}

local r=2
foreach v in `spvars' {
	local c=1
	forvalues i = 1/3 {
		sum(`v') if(quart3_dm_2yr==`i'), detail
		mat mean_adj1[`r',`c'] = r(mean)
		mat mean_adj1[(`r'),`c'+1] = r(p50)
		local c = `c' + 2
	}
	local r=`r'+1
}

//for medicaid percent, multiply mean by 100
forvalues c = 1/6{
mat mean_adj1[`r'-1,`c']=mean_adj1[`r'-1,`c']*100	
}	

mat rownames mean_adj1= "N" "Age at death" "Total payments, all types" "Total government payments" ///
"Total Medicare payments" "Medicare IP" "Medicare SNF" "Medicare HH" ///
"Medicare Hospice" "Medicare Carrier" "Medicare OP" "Medicare DME" "Medicaid NH Payments" ///
"OOP Total" "OOP Helper" "OOP Hospital" "OOP NH" "OOP Doctor" "OOP Rx" ///
"OOP Insurance Costs" "OOP Other" ///
"Total NH nights, SR or claims" "Private payer NH Payments" ///
"Total NH costs, all payers" "Imputed informal care costs" "Medicaid at death? (percent)"

mat list mean_adj1

frmttable using `logpath'\13-Adj_wi_5yr_HRR_Quartiles , statmat(mean_adj1) ///
	title("Five Year EOL Spending by Quartiles of HRR-level Medicare EOL Spending" \ ///
	"(within this sample) Adjusted for wage index, age, race, gender") ///
	ctitle("","Quartile 1 (lowest)", "2&3", "4 (highest)") ///
	note("All spending categories are adjusted for the 2010 CMS wage index" \ ///
	"All $ values adjusted for inflation to 2010$" \ ///
	"Spending amounts are adjusted using linear regression for age (5 year categories)" \ ///
	"gender and race (black, Hispanic, other)." \ ///
	"Total government payments = Medicare + Medicaid nursing home" \ ///
	"Total NH spending = Medicare + OOP + Medicaid or Private Payer" \ ///
	"Informal caregivers are spouses and other unpaid (mainly children), replacement wage imputation")  ///
	sdec(0) substat(1) addtable

************************************************************
//Now create quartile tables for each of the 4 disease groups
foreach d in pr_dem_gt50 cancer_grp heartdis_grp other_grp{
	mat mean_`d' = J(26,6,.)

	//first row - get n each quintile
	local c=1
	forvalues i=1/3{
		sum exit_year_x if(quart3_dm_2yr==`i' & `d'==1)
		mat mean_`d'[1,`c'] = r(N)
		local c = `c'+2
		}

	local r=2
	foreach v in `spvars' {
		local c=1
		forvalues i = 1/3 {
			sum(`v') if(quart3_dm_2yr==`i'& `d'==1), detail
			mat mean_`d'[`r',`c'] = r(mean)
			mat mean_`d'[(`r'),`c'+1] = r(p50)
			local c = `c' + 2
		}
		local r=`r'+1
	}

	//for medicaid percent, multiply mean by 100
	forvalues c = 1/6{
		mat mean_`d'[`r'-1,`c']=mean_`d'[`r'-1,`c']*100	
	}	

mat rownames mean_`d'= "N" "Age at death" "Total payments, all types" "Total government payments" ///
"Total Medicare payments" "Medicare IP" "Medicare SNF" "Medicare HH" ///
"Medicare Hospice" "Medicare Carrier" "Medicare OP" "Medicare DME" "Medicaid NH Payments" ///
"OOP Total" "OOP Helper" "OOP Hospital" "OOP NH" "OOP Doctor" "OOP Rx" ///
"OOP Insurance Costs" "OOP Other" ///
"Total NH nights, SR or claims" "Private payer NH Payments" ///
"Total NH costs, all payers" "Imputed informal care costs" "Medicaid at death? (percent)"

mat list mean_`d'

frmttable using "`logpath'\13-Adj_wi_5yr_HRR_Quartiles" , statmat(mean_`d') ///
	title("`d' Five Year EOL Spending by Quartiles of HRR-level Medicare" \ ///
	"EOL Spending (within this sample) Adjusted for wage index, age, race, gender") ///
	ctitle("","Quartile 1 (lowest)", "2&3", "4 (highest)") ///
	note("All spending categories are adjusted for the 2010 CMS wage index" \ ///
	"All $ values adjusted for inflation to 2010$" \ ///
	"Spending amounts are adjusted using linear regression for age (5 year categories)" \ ///
	"gender and race (black, Hispanic, other)." \ ///
	"Total government payments = Medicare + Medicaid nursing home" \ ///
	"Total NH spending = Medicare + OOP + Medicaid or Private Payer" \ ///
	"Informal caregivers are spouses and other unpaid (mainly children), replacement wage imputation")  ///
	sdec(0) substat(1) addtable

}

************************************************************
//Pie charts of spending by category by quartile and disease group
//OA sample
//local logpath H:\OOP\local_logs
cd "`logpath'\graphs"
//OA sample - all disease groups included
sum adj_total_costs_60m_wi
sca oa_tot=r(mean)
local oatot = round(oa_tot)
di `oatot'

local slices adj_tot_paid_by_mc_60m_wi adj_nh_cost_medicaid_60m_wi adj_nh_cost_private_60m_wi ///
adj_total_oop_60m_wi adj_inf_care_costs_60m_wi

//relabel spending categories so labels can be used in the legends
la var adj_tot_paid_by_mc_60m_wi "WI Adj Medicare"
la var adj_nh_cost_medicaid_60m_wi "WI Adj Medicaid NH"
la var adj_nh_cost_private_60m_wi "WI Adj Private Payer NH"
la var adj_total_oop_60m_wi "WI Adj OOP"
la var adj_inf_care_costs_60m_wi "WI Adj Informal care"

graph pie `slices' ///
, plabel(_all percent) subtitle("Overall, All Q's",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`oatot'",ring(0) position(7)) legend(cols(3))
graph save adj_wi_oa_spend_quart, replace

**********************************
//now by quartile groups
sum adj_total_costs_60m_wi if quart3_dm_2yr ==1
sca oa_q_1=r(mean)
local oa_q1 = round(oa_q_1)

graph pie `slices' if quart3_dm_2yr ==1 , ///
plabel(_all percent) subtitle("Overall, Q-1",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`oa_q1'",ring(0) position(7))	
graph save adj_wi_oa_quart_1, replace

sum adj_total_costs_60m_wi if quart3_dm_2yr ==2
sca oa_q_2=r(mean)
local oa_q2 = round(oa_q_2)

graph pie `slices' if quart3_dm_2yr ==2 , ///
plabel(_all percent) subtitle("Overall, Q-2&3",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`oa_q2'",ring(0) position(7))	
graph save adj_wi_oa_quart_2, replace

sum adj_total_costs_60m_wi if quart3_dm_2yr ==3
sca oa_q_3=r(mean)
local oa_q3 = round(oa_q_3)

graph pie `slices' if quart3_dm_2yr ==3 , ///
plabel(_all percent) subtitle("Overall, Q-4",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`oa_q3'",ring(0) position(7))	
graph save adj_wi_oa_quart_3, replace

**********************************
//Dementia sample
sum adj_total_costs_60m_wi if pr_dem_gt50==1
sca d_all=r(mean)
local d_all = round(d_all)
	
graph pie `slices' ///
if pr_dem_gt50==1, plabel(_all percent) subtitle("Dementia, All Q's",ring(0) position(11)) ///
note("Total 5y EOL" "spending=`d_all'",ring(0) position(7))
graph save adj_wi_pr_dem_gt50_spend_quart, replace

******************************
	sum adj_total_costs_60m_wi if  pr_dem_gt50==1 & quart3_dm_2yr ==1
	sca d_q_1=r(mean)
	local d_q1 = round(d_q_1)

	graph pie `slices' ///
	if pr_dem_gt50==1 & quart3_dm_2yr ==1 , plabel(_all percent)  ///
	subtitle("Dementia, Q-1",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`d_q1'",ring(0) position(7))	
	graph save adj_wi_pr_dem_gt50_quart_1, replace

	sum adj_total_costs_60m_wi if  pr_dem_gt50==1 & quart3_dm_2yr ==2
	sca d_q_2=r(mean)
	local d_q2 = round(d_q_2)

	graph pie `slices' ///
	if pr_dem_gt50==1 & quart3_dm_2yr ==2 , plabel(_all percent)  ///
	subtitle("Dementia, Q-2&3",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`d_q2'",ring(0) position(7))	
	graph save adj_wi_pr_dem_gt50_quart_2, replace

	sum adj_total_costs_60m_wi if  pr_dem_gt50==1 & quart3_dm_2yr ==3
	sca d_q_3=r(mean)
	local d_q3 = round(d_q_3)

	graph pie `slices' ///
	if pr_dem_gt50==1 & quart3_dm_2yr ==3 , plabel(_all percent)  ///
	subtitle("Dementia, Q-4",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`d_q3'",ring(0) position(7))	
	graph save adj_wi_pr_dem_gt50_quart_3, replace

********************************

//Cancer sample
sum adj_total_costs_60m_wi if cancer_grp==1
sca c_all=r(mean)
local c_all = round(c_all)

graph pie `slices' ///
if cancer_grp==1, plabel(_all percent) subtitle("Cancer, All Q's",ring(0) position(11)) ///
note("Total 5y EOL" "spending=`c_all'",ring(0) position(7))
graph save adj_wi_cancer_grp_spend_quart, replace

********************************
	sum adj_total_costs_60m_wi if  cancer_grp==1 & quart3_dm_2yr ==1
	sca c_q_1=r(mean)
	local c_q1 = round(c_q_1)

	graph pie `slices' ///
	if cancer_grp==1 & quart3_dm_2yr ==1 , plabel(_all percent) ///
	subtitle("Cancer, Q-1",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`c_q1'",ring(0) position(7))
	graph save adj_wi_cancer_grp_quart_1, replace

	sum adj_total_costs_60m_wi if  cancer_grp==1 & quart3_dm_2yr ==2
	sca c_q_2=r(mean)
	local c_q2 = round(c_q_2)

	graph pie `slices' ///
	if cancer_grp==1 & quart3_dm_2yr ==2 , plabel(_all percent) ///
	subtitle("Cancer, Q-2&3",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`c_q2'",ring(0) position(7))
	graph save adj_wi_cancer_grp_quart_2, replace

	sum adj_total_costs_60m_wi if  cancer_grp==1 & quart3_dm_2yr ==3
	sca c_q_3=r(mean)
	local c_q3 = round(c_q_3)

	graph pie `slices' ///
	if cancer_grp==1 & quart3_dm_2yr ==3 , plabel(_all percent) ///
	subtitle("Cancer, Q-4",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`c_q3'",ring(0) position(7))
	graph save adj_wi_cancer_grp_quart_3, replace
********************************

//Heart disease sample
sum adj_total_costs_60m_wi if heartdis_grp==1
sca h_all=r(mean)
local h_all = round(h_all)

graph pie `slices' ///
if heartdis_grp==1, plabel(_all percent) subtitle("Heart Disease, All Q's",ring(0) position(11)) ///
note("Total 5y EOL" "spending=`h_all'",ring(0) position(7))
graph save adj_wi_heartdis_grp_spend_quart, replace

*************************
	sum adj_total_costs_60m_wi if  heartdis_grp==1 & quart3_dm_2yr ==1
	sca h_q_1=r(mean)
	local h_q1 = round(h_q_1)
	
	graph pie `slices' ///
	if heartdis_grp==1 & quart3_dm_2yr ==1 , plabel(_all percent) ///
	subtitle("Heart Disease, Q-1",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`h_q1'",ring(0) position(7))
	graph save adj_wi_heartdis_grp_quart_1, replace

	sum adj_total_costs_60m_wi if heartdis_grp==1 & quart3_dm_2yr ==2
	sca h_q_2=r(mean)
	local h_q2 = round(h_q_2)
	
	graph pie `slices' ///
	if heartdis_grp==1 & quart3_dm_2yr ==2 , plabel(_all percent) ///
	subtitle("Heart Disease, Q-2&3",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`h_q2'",ring(0) position(7))
	graph save adj_wi_heartdis_grp_quart_2, replace

	sum adj_total_costs_60m_wi if heartdis_grp==1 & quart3_dm_2yr ==3
	sca h_q_3=r(mean)
	local h_q3 = round(h_q_3)
	
	graph pie `slices' ///
	if heartdis_grp==1 & quart3_dm_2yr ==3 , plabel(_all percent) ///
	subtitle("Heart Disease, Q-4",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`h_q3'",ring(0) position(7))
	graph save adj_wi_heartdis_grp_quart_3, replace
*************************

//Other diseases sample
sum adj_total_costs_60m_wi if other_grp==1
sca o_all=r(mean)
local o_all = round(o_all)

graph pie `slices' ///
if other_grp==1, plabel(_all percent) subtitle("Other disease, All Q's",ring(0) position(11)) ///
note("Total 5y EOL" "spending=`o_all'",ring(0) position(7))
graph save adj_wi_other_grp_spend_quart, replace

*************************
	sum adj_total_costs_60m_wi if  other_grp==1 & quart3_dm_2yr ==1
	sca o_q_1=r(mean)
	local o_q1 = round(o_q_1)
	
	graph pie `slices' ///
	if other_grp==1 & quart3_dm_2yr ==1 , plabel(_all percent) ///
	subtitle("Other disease, Q-1",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`o_q1'",ring(0) position(7))	
	graph save adj_wi_other_grp_quart_1, replace

	sum adj_total_costs_60m_wi if  other_grp==1 & quart3_dm_2yr ==2
	sca o_q_2=r(mean)
	local o_q2 = round(o_q_2)
	
	graph pie `slices' ///
	if other_grp==1 & quart3_dm_2yr ==2 , plabel(_all percent) ///
	subtitle("Other disease, Q-2&3",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`o_q2'",ring(0) position(7))	
	graph save adj_wi_other_grp_quart_2, replace

	sum adj_total_costs_60m_wi if  other_grp==1 & quart3_dm_2yr ==3
	sca o_q_3=r(mean)
	local o_q3 = round(o_q_3)
	
	graph pie `slices' ///
	if other_grp==1 & quart3_dm_2yr ==3 , plabel(_all percent) ///
	subtitle("Other disease, Q-4",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`o_q3'",ring(0) position(7))	
	graph save adj_wi_other_grp_quart_3, replace
*************************

cd `logpath'\graphs

grc1leg adj_wi_oa_spend_quart.gph adj_wi_oa_quart_1.gph adj_wi_oa_quart_2.gph adj_wi_oa_quart_3.gph ///
 adj_wi_pr_dem_gt50_spend_quart.gph adj_wi_pr_dem_gt50_quart_1.gph adj_wi_pr_dem_gt50_quart_2.gph ///
 adj_wi_pr_dem_gt50_quart_3.gph ///
 adj_wi_cancer_grp_spend_quart.gph adj_wi_cancer_grp_quart_1.gph adj_wi_cancer_grp_quart_2.gph ///
 adj_wi_cancer_grp_quart_3.gph ///
 adj_wi_heartdis_grp_spend_quart.gph adj_wi_heartdis_grp_quart_1.gph adj_wi_heartdis_grp_quart_2.gph ///
 adj_wi_heartdis_grp_quart_3.gph ///
 adj_wi_other_grp_spend_quart.gph adj_wi_other_grp_quart_1.gph adj_wi_other_grp_quart_2.gph ///
 adj_wi_other_grp_quart_3.gph, col(4)
graph save adj_wi_panel_quart_1leg, replace
graph export adj_wi_panel_quart_1leg.tif, replace

*********************************************************
log close


H="Full adjustment, quintiles"
/*This section creates tables by DA 2 year EOL HRR quintiles
of age,sex, race adjusted 5 year EOL spending per the HRS dataset

Also creates pie charts comparing the spending across quintiles

Note Spending is wage index adjusted across all categories in this version*/

capture log close
clear all
set mem 500m
set more off

local logpath E:\data\hrs_oop_2010\logs
local datapath E:\data\hrs_oop_2010\final_data
//local logpath H:\OOP\local_logs
//local datapath C:\Users\gorger01\Desktop\oop

log using `logpath'\14-oop_more_risk_adjust_quintiles-LOG.txt, text replace

cd `datapath'

use oop_mc_sample_adj_age_etc.dta
**************************************************
local spvars age_at_death_e fadj_total_costs_60m_wi fadj_tot_gov_pay_60m_wi fadj_tot_paid_by_mc_60m_wi ///
fadj_ip_paid_by_mc_60m_wi fadj_snf_paid_by_mc_60m_wi fadj_hh_paid_by_mc_60m_wi ///
fadj_hs_paid_by_mc_60m_wi fadj_pb_paid_by_mc_60m_wi fadj_op_paid_by_mc_60m_wi ///
fadj_dm_paid_by_mc_60m_wi fadj_nh_cost_medicaid_60m_wi fadj_total_oop_60m_wi fadj_helper_oop_60m_wi ///
fadj_hospital_oop_60m_wi fadj_nh_oop_60m_wi ///
fadj_doctor_oop_60m_wi fadj_rx_oop_60m_wi fadj_insurance_costs_60m_wi fadj_other_oop_60m_wi nh_nights_60m ///
 fadj_nh_cost_private_60m_wi fadj_total_nh_costs_60m_wi fadj_inf_care_costs_60m_wi ///
medicaid_x

**************************************************
//create tables of spending categories, by disease group (prior
//tables by quintiles of spending)

//get tables comparing mean, median spending for different disease groups
mat dg_5y=J(26,8,.)
//first row n each group
tab pr_dem_gt50, missing matcell(r1_50)
mat dg_5y[1,1]=r1_50[2,1] //with dem prob > 50% col 1
tab cancer_grp, missing matcell(r1_c)
mat dg_5y[1,3]=r1_c[2,1] //with cancer col 2
tab heartdis_grp , missing matcell(r1_h)
mat dg_5y[1,5]=r1_h[2,1] //with heart disease col 3
tab other_grp , missing matcell(r1_o)
mat dg_5y[1,7]=r1_o[2,1] //with other disease col 4

//totals 5 years, wage index adjusted mc payments, oop spend and nh nights
local c=1
foreach d in pr_dem_gt50 cancer_grp heartdis_grp other_grp{
	local r = 2
	foreach v in `spvars'{
		sum `v' if `d'==1, detail
		mat dg_5y[`r',`c']=r(mean)
		mat dg_5y[`r',`c'+1]=r(p50)
		local r = `r'+1
		}
	local c = `c'+2
	}
//convert medicaid rate to percent
forvalues i = 1/8{
mat dg_5y[`r'-1,`i']=dg_5y[`r'-1,`i']*100	
}	
	
mat rownames dg_5y= "N" "Age at death" "Total payments, all types" "Total government payments" "Total Medicare payments" ///
"Medicare IP" "Medicare SNF" "Medicare HH" ///
"Medicare Hospice" "Medicare Carrier" "Medicare OP" "Medicare DME" ///
"OOP Total" "OOP Helper" "OOP Hospital" "OOP NH" "OOP Doctor" "OOP Rx" ///
"OOP Insurance Costs" "OOP Other" ///
"Total NH nights, SR or claims" "Medicaid NH Payments" ///
"Private payer NH Payments" "Total NH costs, all payers" "Imputed informal care costs" "Medicaid at death? (percent)"

mat list dg_5y

frmttable using `logpath'\14-More_risk_adj_Quintiles, statmat(dg_5y) ///
title("Dementia, Cancer and Heart Disease Patients, Medicare and OOP Spending Last 5 years of life" \ ///
"Adjusted for wage index, age, race, sex, ever smoked cigarettes" \ ///
"Adl impairment, comorbidity count and education level (high school degree).") ///
note("All spending categories are adjusted for the 2010 CMS wage index and risk adjustment factors above" \ ///
"All $ values adjusted for inflation to 2010$" \ ///
"Total government payments = Medicare + Medicaid nursing home" \ ///
"Total NH spending = Medicare + OOP + Medicaid or Private Payer" \ ///
"Informal caregivers are spouses and other unpaid (mainly children), replacemnt wage imputation")  ///
ctitles("" "Prob dem"  "Cancer" "Heart disease" "Other" \ ///
"" " > 50%" "" "" "" \ ///
"" "Mean"  "Mean" "Mean" "Mean" \ "" "Median"  "Median" "Median" "Median"  ) ///
sdec(0) substat(1) replace 

**************************************************
//Create tables of spending by quintile, overall sample (unadjusted)
mat mean_adj1 = J(26,10,.)

//first row - get n each quintile
local c=1
forvalues i=1/5{
sum exit_year_x if(quintile_dm_2yr==`i')
mat mean_adj1[1,`c'] = r(N)
local c = `c'+2
}

local r=2
foreach v in `spvars' {
	local c=1
	forvalues i = 1/5 {
		sum(`v') if(quintile_dm_2yr==`i'), detail
		mat mean_adj1[`r',`c'] = r(mean)
		mat mean_adj1[(`r'),`c'+1] = r(p50)
		local c = `c' + 2
	}
	local r=`r'+1
}

//for medicaid percent, multiply mean by 100
forvalues c = 1/10{
mat mean_adj1[`r'-1,`c']=mean_adj1[`r'-1,`c']*100	
}	

mat rownames mean_adj1= "N" "Age at death" "Total payments, all types" "Total government payments" ///
"Total Medicare payments" "Medicare IP" "Medicare SNF" "Medicare HH" ///
"Medicare Hospice" "Medicare Carrier" "Medicare OP" "Medicare DME" "Medicaid NH Payments" ///
"OOP Total" "OOP Helper" "OOP Hospital" "OOP NH" "OOP Doctor" "OOP Rx" ///
"OOP Insurance Costs" "OOP Other" ///
"Total NH nights, SR or claims" ///
"Private payer NH Payments" "Total NH costs, all payers" "Imputed informal care costs" "Medicaid at death? (percent)"

mat list mean_adj1

frmttable using "`logpath'\14-More_risk_adj_Quintiles" , statmat(mean_adj1) ///
	title("Five Year EOL Spending by Quintiles of HRR-level Medicare EOL Spending" \ ///
	"(within this sample) Adjusted for wage index, age, race, gender," \ ///
	"ever smoked cigarettes, Adl impairment, comorbidity count and education level (HS degree).") ///
	ctitle("","Quintile 1 (lowest)", "2", "3", "4", "5 (highest)") ///
	note("All spending categories are adjusted for the 2010 CMS wage index and risk factors above" \ ///
	"All $ values adjusted for inflation to 2010$" \ ///
	"Spending amounts are adjusted using linear regression for age (5 year categories)" \ ///
	"gender and race (black, Hispanic, other)." \ ///
	"Total government payments = Medicare + Medicaid nursing home" \ ///
	"Total NH spending = Medicare + OOP + Medicaid or Private Payer" \ ///
	"Informal caregivers are spouses and other unpaid (mainly children), replacement wage imputation")  ///
	sdec(0) substat(1) addtable

************************************************************
//Now create quintile tables for each of the 4 disease groups
foreach d in pr_dem_gt50 cancer_grp heartdis_grp other_grp{
	mat mean_`d' = J(26,10,.)

	//first row - get n each quintile
	local c=1
	forvalues i=1/5{
		sum exit_year_x if(quintile_dm_2yr==`i' & `d'==1)
		mat mean_`d'[1,`c'] = r(N)
		local c = `c'+2
		}

	local r=2
	foreach v in `spvars' {
		local c=1
		forvalues i = 1/5 {
			sum(`v') if(quintile_dm_2yr==`i'& `d'==1), detail
			mat mean_`d'[`r',`c'] = r(mean)
			mat mean_`d'[(`r'),`c'+1] = r(p50)
			local c = `c' + 2
		}
		local r=`r'+1
	}

	//for medicaid percent, multiply mean by 100
	forvalues c = 1/10{
		mat mean_`d'[`r'-1,`c']=mean_`d'[`r'-1,`c']*100	
	}	

mat rownames mean_`d'= "N" "Age at death" "Total payments, all types" "Total government payments" "Total Medicare payments" ///
"Medicare IP" "Medicare SNF" "Medicare HH" "Medicare Hospice" "Medicare Carrier" "Medicare OP"  ///
"Medicare DME" "Medicaid NH Payments" "OOP Total" "OOP Helper" "OOP Hospital" "OOP NH" "OOP Doctor" "OOP Rx" ///
"OOP Insurance Costs" "OOP Other" ///
"Total NH nights, SR or claims" "Private payer NH Payments" ///
"Total NH costs, all payers" "Imputed informal care costs" "Medicaid at death? (percent)"

mat list mean_`d'

frmttable using "`logpath'\14-More_risk_adj_Quintiles" , statmat(mean_`d') ///
	title("`d' Five Year EOL Spending by Quintiles of HRR-level Medicare" \ ///
	"EOL Spending (within this sample) Adjusted for wage index, age, race, gender," \ ///
	"ever smoked cigarettes, Adl impairment, comorbidity count and education level (HS degree).") ///
	ctitle("","Quintile 1 (lowest)", "2", "3", "4", "5 (highest)") ///
	note("All spending categories are adjusted for the 2010 CMS wage index and risk factors above" \ ///
	"All $ values adjusted for inflation to 2010$" \ ///
	"Spending amounts are adjusted using linear regression for age (5 year categories)" \ ///
	"gender and race (black, Hispanic, other)." \ ///
	"Total government payments = Medicare + Medicaid nursing home" \ ///
	"Total NH spending = Medicare + OOP + Medicaid or Private Payer" \ ///
	"Informal caregivers are spouses and other unpaid (mainly children), replacement wage imputation")  ///
	sdec(0) substat(1) addtable

}


************************************************************
//Pie charts of spending by category by quintile and disease group
//OA sample
//local logpath H:\OOP\local_logs
cd "`logpath'\graphs"
//OA sample - all disease groups included
sum fadj_total_costs_60m_wi
sca oa_tot=r(mean)
local oatot = round(oa_tot)
di `oatot'

local slices fadj_tot_paid_by_mc_60m_wi fadj_nh_cost_medicaid_60m_wi fadj_nh_cost_private_60m_wi ///
fadj_total_oop_60m_wi fadj_inf_care_costs_60m_wi

//relabel spending categories so labels can be used in the legends
la var fadj_tot_paid_by_mc_60m_wi "WI & Risk Adj Medicare"
la var fadj_nh_cost_medicaid_60m_wi "WI & Risk Adj Medicaid NH"
la var fadj_nh_cost_private_60m_wi "WI & Risk Adj Private Payer NH"
la var fadj_total_oop_60m_wi "WI & Risk Adj OOP"
la var fadj_inf_care_costs_60m_wi "WI & Risk Adj Informal care"

graph pie `slices' ///
, plabel(_all percent) subtitle("Overall, All Q's",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`oatot'",ring(0) position(7)) legend(cols(3))
graph save fadj_wi_oa_spend, replace

forvalues i=1/5{ 
sum adj_total_costs_60m if quintile_dm_2yr ==`i'
sca oa_q_`i'=r(mean)
local oa_q`i' = round(oa_q_`i')

graph pie `slices' ///
if quintile_dm_2yr ==`i' , plabel(_all percent) subtitle("Overall, Q-`i'",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`oa_q`i''",ring(0) position(7))	
graph fsave adj_wi_oa_quint_`i', replace
}
//Dementia sample
sum fadj_total_costs_60m_wi if pr_dem_gt50==1
sca d_all=r(mean)
local d_all = round(d_all)
	
graph pie `slices' ///
if pr_dem_gt50==1, plabel(_all percent) subtitle("Dementia, All Q's",ring(0) position(11)) ///
note("Total 5y EOL" "spending=`d_all'",ring(0) position(7))
graph save fadj_wi_pr_dem_gt50_spend, replace

forvalues i=1/5{
	sum fadj_total_costs_60m if  pr_dem_gt50==1 & quintile_dm_2yr ==`i'
	sca d_q_`i'=r(mean)
	local d_q`i' = round(d_q_`i')

	graph pie `slices' ///
	if pr_dem_gt50==1 & quintile_dm_2yr ==`i' , plabel(_all percent)  ///
	subtitle("Dementia, Q-`i'",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`d_q`i''",ring(0) position(7))	
	graph save fadj_wi_pr_dem_gt50_quint_`i', replace
}

//Cancer sample
sum fadj_total_costs_60m_wi if cancer_grp==1
sca c_all=r(mean)
local c_all = round(c_all)

graph pie `slices' ///
if cancer_grp==1, plabel(_all percent) subtitle("Cancer, All Q's",ring(0) position(11)) ///
note("Total 5y EOL" "spending=`c_all'",ring(0) position(7))
graph save fadj_wi_cancer_grp_spend, replace

forvalues i=1/5{ 
	sum fadj_total_costs_60m if  cancer_grp==1 & quintile_dm_2yr ==`i'
	sca c_q_`i'=r(mean)
	local c_q`i' = round(c_q_`i')

	graph pie `slices' ///
	if cancer_grp==1 & quintile_dm_2yr ==`i' , plabel(_all percent) ///
	subtitle("Cancer, Q-`i'",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`c_q`i''",ring(0) position(7))
	graph save fadj_wi_cancer_grp_quint_`i', replace
}

//Heart disease sample
sum fadj_total_costs_60m_wi if heartdis_grp==1
sca h_all=r(mean)
local h_all = round(h_all)

graph pie `slices' ///
if heartdis_grp==1, plabel(_all percent) subtitle("Heart Disease, All Q's",ring(0) position(11)) ///
note("Total 5y EOL" "spending=`h_all'",ring(0) position(7))
graph save fadj_wi_heartdis_grp_spend, replace

forvalues i=1/5{ 
	sum fadj_total_costs_60m if  heartdis_grp==1 & quintile_dm_2yr ==`i'
	sca h_q_`i'=r(mean)
	local h_q`i' = round(h_q_`i')
	
	graph pie `slices' ///
	if heartdis_grp==1 & quintile_dm_2yr ==`i' , plabel(_all percent) ///
	subtitle("Heart Disease, Q-`i'",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`h_q`i''",ring(0) position(7))
	graph save fadj_wi_heartdis_grp_quint_`i', replace
}

//Other diseases sample
sum fadj_total_costs_60m_wi if other_grp==1
sca o_all=r(mean)
local o_all = round(o_all)

graph pie `slices' ///
if other_grp==1, plabel(_all percent) subtitle("Other disease, All Q's",ring(0) position(11)) ///
note("Total 5y EOL" "spending=`o_all'",ring(0) position(7))
graph save fadj_wi_other_grp_spend, replace

forvalues i=1/5{ 
	sum fadj_total_costs_60m if  other_grp==1 & quintile_dm_2yr ==`i'
	sca o_q_`i'=r(mean)
	local o_q`i' = round(o_q_`i')
	
	graph pie `slices' ///
	if other_grp==1 & quintile_dm_2yr ==`i' , plabel(_all percent) ///
	subtitle("Other disease, Q-`i'",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`o_q`i''",ring(0) position(7))	
	graph save fadj_wi_other_grp_quint_`i', replace
}

cd `logpath'\graphs

grc1leg fadj_wi_oa_spend.gph fadj_wi_oa_quint_1.gph fadj_wi_oa_quint_2.gph fadj_wi_oa_quint_3.gph ///
 fadj_wi_oa_quint_4.gph fadj_wi_oa_quint_5.gph ///
 fadj_wi_pr_dem_gt50_spend.gph fadj_wi_pr_dem_gt50_quint_1.gph fadj_wi_pr_dem_gt50_quint_2.gph fadj_wi_pr_dem_gt50_quint_3.gph ///
 fadj_wi_pr_dem_gt50_quint_4.gph fadj_wi_pr_dem_gt50_quint_5.gph ///
 fadj_wi_cancer_grp_spend.gph fadj_wi_cancer_grp_quint_1.gph fadj_wi_cancer_grp_quint_2.gph fadj_wi_cancer_grp_quint_3.gph ///
 fadj_wi_cancer_grp_quint_4.gph fadj_wi_cancer_grp_quint_5.gph ///
 fadj_wi_heartdis_grp_spend.gph fadj_wi_heartdis_grp_quint_1.gph fadj_wi_heartdis_grp_quint_2.gph fadj_wi_heartdis_grp_quint_3.gph ///
 fadj_wi_heartdis_grp_quint_4.gph fadj_wi_heartdis_grp_quint_5.gph ///
 fadj_wi_other_grp_spend.gph fadj_wi_other_grp_quint_1.gph fadj_wi_other_grp_quint_2.gph fadj_wi_other_grp_quint_3.gph ///
 fadj_wi_other_grp_quint_4.gph fadj_wi_other_grp_quint_5.gph, ///
  col(6)
graph save fadj_wi_panel_quint_1leg, replace
graph export fadj_wi_panel_quint_1leg.tif, replace

*********************************************************
log close


H="Full adjustment, quartiles"
/*This section creates tables by DA 2 year EOL HRR quartiles 
in three groups (0-25%, 25-75%, 75-100%)
of age,sex, race adjusted 5 year EOL spending per the HRS dataset

Also creates pie charts comparing the spending across quartiles

Note Spending is wage index adjusted across all categories in this version*/

capture log close
clear all
set mem 500m
set more off

local logpath E:\data\hrs_oop_2010\logs
local datapath E:\data\hrs_oop_2010\final_data
//local logpath H:\OOP\local_logs
//local datapath C:\Users\gorger01\Desktop\oop

log using `logpath'\15-oop_more_risk_adjust_quartiles-LOG.txt, text replace

cd `datapath'

use oop_mc_sample_adj_age_etc.dta
**************************************************
local spvars age_at_death_e fadj_total_costs_60m_wi fadj_tot_gov_pay_60m_wi fadj_tot_paid_by_mc_60m_wi ///
fadj_ip_paid_by_mc_60m_wi fadj_snf_paid_by_mc_60m_wi fadj_hh_paid_by_mc_60m_wi ///
fadj_hs_paid_by_mc_60m_wi fadj_pb_paid_by_mc_60m_wi fadj_op_paid_by_mc_60m_wi ///
fadj_dm_paid_by_mc_60m_wi fadj_nh_cost_medicaid_60m_wi fadj_total_oop_60m_wi fadj_helper_oop_60m_wi ///
fadj_hospital_oop_60m_wi fadj_nh_oop_60m_wi ///
fadj_doctor_oop_60m_wi fadj_rx_oop_60m_wi fadj_insurance_costs_60m_wi fadj_other_oop_60m_wi nh_nights_60m ///
 fadj_nh_cost_private_60m_wi fadj_total_nh_costs_60m_wi fadj_inf_care_costs_60m_wi ///
medicaid_x

**************************************************
//create tables of spending categories, by disease group (prior
//tables by quartiles of HRR spending)

//get tables comparing mean, median spending for different disease groups
mat dg_5y=J(26,8,.)
//first row n each group
tab pr_dem_gt50, missing matcell(r1_50)
mat dg_5y[1,1]=r1_50[2,1] //with dem prob > 50% col 1
tab cancer_grp, missing matcell(r1_c)
mat dg_5y[1,3]=r1_c[2,1] //with cancer col 2
tab heartdis_grp , missing matcell(r1_h)
mat dg_5y[1,5]=r1_h[2,1] //with heart disease col 3
tab other_grp , missing matcell(r1_o)
mat dg_5y[1,7]=r1_o[2,1] //with other disease col 4

//totals 5 years, wage index adjusted mc payments, oop spend and nh nights
local c=1
foreach d in pr_dem_gt50 cancer_grp heartdis_grp other_grp{
	local r = 2
	foreach v in `spvars'{
		sum `v' if `d'==1, detail
		mat dg_5y[`r',`c']=r(mean)
		mat dg_5y[`r',`c'+1]=r(p50)
		local r = `r'+1
		}
	local c = `c'+2
	}
//convert medicaid rate to percent
forvalues i = 1/8{
mat dg_5y[`r'-1,`i']=dg_5y[`r'-1,`i']*100	
}	
	
mat rownames dg_5y= "N" "Age at death" "Total payments, all types" "Total government payments" ///
"Total Medicare payments" "Medicare IP" "Medicare SNF" "Medicare HH" ///
"Medicare Hospice" "Medicare Carrier" "Medicare OP" "Medicare DME" ///
"Medicaid NH payments" "OOP Total" "OOP Helper" "OOP Hospital" "OOP NH" ///
"OOP Doctor" "OOP Rx" "OOP Insurance Costs" "OOP Other" ///
"Total NH nights, SR or claims" "Private payer NH Payments"  ///
"Total NH costs, all payers" "Imputed informal care costs" "Medicaid at death? (percent)"

mat list dg_5y

frmttable using `logpath'\15-More_risk_adj_Quartiles, statmat(dg_5y) ///
title("Dementia, Cancer and Heart Disease Patients, Medicare and OOP Spending Last 5 years of life" \ ///
"Adjusted for wage index, age, race, sex, ever smoked cigarettes" \ ///
"Adl impairment, comorbidity count and education level (high school degree).") ///
note("All spending categories are adjusted for the 2010 CMS wage index and risk factors above" \ ///
"All $ values adjusted for inflation to 2010$" \ ///
"Total government payments = Medicare + Medicaid nursing home" \ ///
"Total NH spending = Medicare + OOP + Medicaid or Private Payer" \ ///
"Informal caregivers are spouses and other unpaid (mainly children), replacemnt wage imputation")  ///
ctitles("" "Prob dem"  "Cancer" "Heart disease" "Other" \ ///
"" " > 50%" "" "" "" \ ///
"" "Mean"  "Mean" "Mean" "Mean" \ "" "Median"  "Median" "Median" "Median"  ) ///
sdec(0) substat(1) replace 

**************************************************
//Create tables of spending by quartile, overall sample (unadjusted)
mat mean_adj1 = J(26,6,.)

//first row - get n each quartile
local c=1
forvalues i=1/3{
sum exit_year_x if(quart3_dm_2yr==`i')
mat mean_adj1[1,`c'] = r(N)
local c = `c'+2
}

local r=2
foreach v in `spvars' {
	local c=1
	forvalues i = 1/3 {
		sum(`v') if(quart3_dm_2yr==`i'), detail
		mat mean_adj1[`r',`c'] = r(mean)
		mat mean_adj1[(`r'),`c'+1] = r(p50)
		local c = `c' + 2
	}
	local r=`r'+1
}

//for medicaid percent, multiply mean by 100
forvalues c = 1/6{
mat mean_adj1[`r'-1,`c']=mean_adj1[`r'-1,`c']*100	
}	

mat rownames mean_adj1= "N" "Age at death" "Total payments, all types" "Total government payments" ///
"Total Medicare payments" "Medicare IP" "Medicare SNF" "Medicare HH" ///
"Medicare Hospice" "Medicare Carrier" "Medicare OP" "Medicare DME" "Medicaid NH Payments" ///
"OOP Total" "OOP Helper" "OOP Hospital" "OOP NH" "OOP Doctor" "OOP Rx" ///
"OOP Insurance Costs" "OOP Other" ///
"Total NH nights, SR or claims" "Private payer NH Payments" ///
"Total NH costs, all payers" "Imputed informal care costs" "Medicaid at death? (percent)"

mat list mean_adj1

frmttable using `logpath'\15-More_risk_adj_Quartiles , statmat(mean_adj1) ///
	title("Five Year EOL Spending by Quartiles of HRR-level Medicare EOL Spending" \ ///
	"(within this sample) Adjusted for wage index, age, race, gender," \ ///
	"ever smoked cigarettes, Adl impairment, comorbidity count and education level (HS degree).") ///
	ctitle("","Quartile 1 (lowest)", "2&3", "4 (highest)") ///
	note("All spending categories are adjusted for the 2010 CMS wage index and risk factors above" \ ///
	"All $ values adjusted for inflation to 2010$" \ ///
	"Spending amounts are adjusted using linear regression for age (5 year categories)" \ ///
	"gender and race (black, Hispanic, other)." \ ///
	"Total government payments = Medicare + Medicaid nursing home" \ ///
	"Total NH spending = Medicare + OOP + Medicaid or Private Payer" \ ///
	"Informal caregivers are spouses and other unpaid (mainly children), replacement wage imputation")  ///
	sdec(0) substat(1) addtable

************************************************************
//Now create quartile tables for each of the 4 disease groups
foreach d in pr_dem_gt50 cancer_grp heartdis_grp other_grp{
	mat mean_`d' = J(26,6,.)

	//first row - get n each quintile
	local c=1
	forvalues i=1/3{
		sum exit_year_x if(quart3_dm_2yr==`i' & `d'==1)
		mat mean_`d'[1,`c'] = r(N)
		local c = `c'+2
		}

	local r=2
	foreach v in `spvars' {
		local c=1
		forvalues i = 1/3 {
			sum(`v') if(quart3_dm_2yr==`i'& `d'==1), detail
			mat mean_`d'[`r',`c'] = r(mean)
			mat mean_`d'[(`r'),`c'+1] = r(p50)
			local c = `c' + 2
		}
		local r=`r'+1
	}

	//for medicaid percent, multiply mean by 100
	forvalues c = 1/6{
		mat mean_`d'[`r'-1,`c']=mean_`d'[`r'-1,`c']*100	
	}	

mat rownames mean_`d'= "N" "Age at death" "Total payments, all types" "Total government payments" ///
"Total Medicare payments" "Medicare IP" "Medicare SNF" "Medicare HH" ///
"Medicare Hospice" "Medicare Carrier" "Medicare OP" "Medicare DME" "Medicaid NH Payments" ///
"OOP Total" "OOP Helper" "OOP Hospital" "OOP NH" "OOP Doctor" "OOP Rx" ///
"OOP Insurance Costs" "OOP Other" ///
"Total NH nights, SR or claims" "Private payer NH Payments" ///
"Total NH costs, all payers" "Imputed informal care costs" "Medicaid at death? (percent)"

mat list mean_`d'

frmttable using "`logpath'\15-More_risk_adj_Quartiles" , statmat(mean_`d') ///
	title("`d' Five Year EOL Spending by Quartiles of HRR-level Medicare" \ ///
	"EOL Spending (within this sample) Adjusted for wage index, age, race, gender," \ ///
	"ever smoked cigarettes, Adl impairment, comorbidity count and education level (HS degree).") ///
	ctitle("","Quartile 1 (lowest)", "2&3", "4 (highest)") ///
	note("All spending categories are adjusted for the 2010 CMS wage index and risk factors above." \ ///
	"All $ values adjusted for inflation to 2010$" \ ///
	"Spending amounts are adjusted using linear regression for age (5 year categories)" \ ///
	"gender and race (black, Hispanic, other)." \ ///
	"Total government payments = Medicare + Medicaid nursing home" \ ///
	"Total NH spending = Medicare + OOP + Medicaid or Private Payer" \ ///
	"Informal caregivers are spouses and other unpaid (mainly children), replacement wage imputation")  ///
	sdec(0) substat(1) addtable

}

************************************************************
//Pie charts of spending by category by quartile and disease group
//OA sample
//local logpath H:\OOP\local_logs
cd "`logpath'\graphs"
//OA sample - all disease groups included
sum fadj_total_costs_60m_wi
sca oa_tot=r(mean)
local oatot = round(oa_tot)
di `oatot'

local slices fadj_tot_paid_by_mc_60m_wi fadj_nh_cost_medicaid_60m_wi fadj_nh_cost_private_60m_wi ///
fadj_total_oop_60m_wi fadj_inf_care_costs_60m_wi

//relabel spending categories so labels can be used in the legends
la var fadj_tot_paid_by_mc_60m_wi "Risk & WI Adj Medicare"
la var fadj_nh_cost_medicaid_60m_wi "Risk & WI Adj Medicaid NH"
la var fadj_nh_cost_private_60m_wi "Risk & WI Adj Private Payer NH"
la var fadj_total_oop_60m_wi "Risk & WI Adj OOP"
la var fadj_inf_care_costs_60m_wi "Risk & WI Adj Informal care"

graph pie `slices' ///
, plabel(_all percent) subtitle("Overall, All Q's",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`oatot'",ring(0) position(7)) legend(cols(3))
graph save fadj_wi_oa_spend_quart, replace

**********************************
//now by quartile groups
sum fadj_total_costs_60m_wi if quart3_dm_2yr ==1
sca oa_q_1=r(mean)
local oa_q1 = round(oa_q_1)

graph pie `slices' if quart3_dm_2yr ==1 , ///
plabel(_all percent) subtitle("Overall, Q-1",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`oa_q1'",ring(0) position(7))	
graph save fadj_wi_oa_quart_1, replace

sum fadj_total_costs_60m_wi if quart3_dm_2yr ==2
sca oa_q_2=r(mean)
local oa_q2 = round(oa_q_2)

graph pie `slices' if quart3_dm_2yr ==2 , ///
plabel(_all percent) subtitle("Overall, Q-2&3",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`oa_q2'",ring(0) position(7))	
graph fsave adj_wi_oa_quart_2, replace

sum fadj_total_costs_60m_wi if quart3_dm_2yr ==3
sca oa_q_3=r(mean)
local oa_q3 = round(oa_q_3)

graph pie `slices' if quart3_dm_2yr ==3 , ///
plabel(_all percent) subtitle("Overall, Q-4",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`oa_q3'",ring(0) position(7))	
graph save fadj_wi_oa_quart_3, replace

**********************************
//Dementia sample
sum fadj_total_costs_60m_wi if pr_dem_gt50==1
sca d_all=r(mean)
local d_all = round(d_all)
	
graph pie `slices' ///
if pr_dem_gt50==1, plabel(_all percent) subtitle("Dementia, All Q's",ring(0) position(11)) ///
note("Total 5y EOL" "spending=`d_all'",ring(0) position(7))
graph save fadj_wi_pr_dem_gt50_spend_quart, replace

******************************
	sum fadj_total_costs_60m_wi if  pr_dem_gt50==1 & quart3_dm_2yr ==1
	sca d_q_1=r(mean)
	local d_q1 = round(d_q_1)

	graph pie `slices' ///
	if pr_dem_gt50==1 & quart3_dm_2yr ==1 , plabel(_all percent)  ///
	subtitle("Dementia, Q-1",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`d_q1'",ring(0) position(7))	
	graph fsave adj_wi_pr_dem_gt50_quart_1, replace

	sum fadj_total_costs_60m_wi if  pr_dem_gt50==1 & quart3_dm_2yr ==2
	sca d_q_2=r(mean)
	local d_q2 = round(d_q_2)

	graph pie `slices' ///
	if pr_dem_gt50==1 & quart3_dm_2yr ==2 , plabel(_all percent)  ///
	subtitle("Dementia, Q-2&3",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`d_q2'",ring(0) position(7))	
	graph save fadj_wi_pr_dem_gt50_quart_2, replace

	sum fadj_total_costs_60m_wi if  pr_dem_gt50==1 & quart3_dm_2yr ==3
	sca d_q_3=r(mean)
	local d_q3 = round(d_q_3)

	graph pie `slices' ///
	if pr_dem_gt50==1 & quart3_dm_2yr ==3 , plabel(_all percent)  ///
	subtitle("Dementia, Q-4",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`d_q3'",ring(0) position(7))	
	graph save fadj_wi_pr_dem_gt50_quart_3, replace

********************************

//Cancer sample
sum fadj_total_costs_60m_wi if cancer_grp==1
sca c_all=r(mean)
local c_all = round(c_all)

graph pie `slices' ///
if cancer_grp==1, plabel(_all percent) subtitle("Cancer, All Q's",ring(0) position(11)) ///
note("Total 5y EOL" "spending=`c_all'",ring(0) position(7))
graph save fadj_wi_cancer_grp_spend_quart, replace

********************************
	sum fadj_total_costs_60m_wi if  cancer_grp==1 & quart3_dm_2yr ==1
	sca c_q_1=r(mean)
	local c_q1 = round(c_q_1)

	graph pie `slices' ///
	if cancer_grp==1 & quart3_dm_2yr ==1 , plabel(_all percent) ///
	subtitle("Cancer, Q-1",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`c_q1'",ring(0) position(7))
	graph save fadj_wi_cancer_grp_quart_1, replace

	sum fadj_total_costs_60m_wi if  cancer_grp==1 & quart3_dm_2yr ==2
	sca c_q_2=r(mean)
	local c_q2 = round(c_q_2)

	graph pie `slices' ///
	if cancer_grp==1 & quart3_dm_2yr ==2 , plabel(_all percent) ///
	subtitle("Cancer, Q-2&3",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`c_q2'",ring(0) position(7))
	graph save fadj_wi_cancer_grp_quart_2, replace

	sum fadj_total_costs_60m_wi if  cancer_grp==1 & quart3_dm_2yr ==3
	sca c_q_3=r(mean)
	local c_q3 = round(c_q_3)

	graph pie `slices' ///
	if cancer_grp==1 & quart3_dm_2yr ==3 , plabel(_all percent) ///
	subtitle("Cancer, Q-4",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`c_q3'",ring(0) position(7))
	graph save fadj_wi_cancer_grp_quart_3, replace
********************************

//Heart disease sample
sum fadj_total_costs_60m_wi if heartdis_grp==1
sca h_all=r(mean)
local h_all = round(h_all)

graph pie `slices' ///
if heartdis_grp==1, plabel(_all percent) subtitle("Heart Disease, All Q's",ring(0) position(11)) ///
note("Total 5y EOL" "spending=`h_all'",ring(0) position(7))
graph save fadj_wi_heartdis_grp_spend_quart, replace

*************************
	sum fadj_total_costs_60m_wi if  heartdis_grp==1 & quart3_dm_2yr ==1
	sca h_q_1=r(mean)
	local h_q1 = round(h_q_1)
	
	graph pie `slices' ///
	if heartdis_grp==1 & quart3_dm_2yr ==1 , plabel(_all percent) ///
	subtitle("Heart Disease, Q-1",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`h_q1'",ring(0) position(7))
	graph save fadj_wi_heartdis_grp_quart_1, replace

	sum fadj_total_costs_60m_wi if heartdis_grp==1 & quart3_dm_2yr ==2
	sca h_q_2=r(mean)
	local h_q2 = round(h_q_2)
	
	graph pie `slices' ///
	if heartdis_grp==1 & quart3_dm_2yr ==2 , plabel(_all percent) ///
	subtitle("Heart Disease, Q-2&3",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`h_q2'",ring(0) position(7))
	graph save fadj_wi_heartdis_grp_quart_2, replace

	sum fadj_total_costs_60m_wi if heartdis_grp==1 & quart3_dm_2yr ==3
	sca h_q_3=r(mean)
	local h_q3 = round(h_q_3)
	
	graph pie `slices' ///
	if heartdis_grp==1 & quart3_dm_2yr ==3 , plabel(_all percent) ///
	subtitle("Heart Disease, Q-4",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`h_q3'",ring(0) position(7))
	graph save fadj_wi_heartdis_grp_quart_3, replace
*************************

//Other diseases sample
sum fadj_total_costs_60m_wi if other_grp==1
sca o_all=r(mean)
local o_all = round(o_all)

graph pie `slices' ///
if other_grp==1, plabel(_all percent) subtitle("Other disease, All Q's",ring(0) position(11)) ///
note("Total 5y EOL" "spending=`o_all'",ring(0) position(7))
graph save fadj_wi_other_grp_spend_quart, replace

*************************
	sum fadj_total_costs_60m_wi if  other_grp==1 & quart3_dm_2yr ==1
	sca o_q_1=r(mean)
	local o_q1 = round(o_q_1)
	
	graph pie `slices' ///
	if other_grp==1 & quart3_dm_2yr ==1 , plabel(_all percent) ///
	subtitle("Other disease, Q-1",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`o_q1'",ring(0) position(7))	
	graph save fadj_wi_other_grp_quart_1, replace

	sum fadj_total_costs_60m_wi if  other_grp==1 & quart3_dm_2yr ==2
	sca o_q_2=r(mean)
	local o_q2 = round(o_q_2)
	
	graph pie `slices' ///
	if other_grp==1 & quart3_dm_2yr ==2 , plabel(_all percent) ///
	subtitle("Other disease, Q-2&3",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`o_q2'",ring(0) position(7))	
	graph save fadj_wi_other_grp_quart_2, replace

	sum fadj_total_costs_60m_wi if  other_grp==1 & quart3_dm_2yr ==3
	sca o_q_3=r(mean)
	local o_q3 = round(o_q_3)
	
	graph pie `slices' ///
	if other_grp==1 & quart3_dm_2yr ==3 , plabel(_all percent) ///
	subtitle("Other disease, Q-4",ring(0) position(11)) ///
	note("Total 5y EOL" "spending=`o_q3'",ring(0) position(7))	
	graph save fadj_wi_other_grp_quart_3, replace
*************************

cd `logpath'\graphs

grc1leg fadj_wi_oa_spend_quart.gph fadj_wi_oa_quart_1.gph fadj_wi_oa_quart_2.gph fadj_wi_oa_quart_3.gph ///
 fadj_wi_pr_dem_gt50_spend_quart.gph fadj_wi_pr_dem_gt50_quart_1.gph fadj_wi_pr_dem_gt50_quart_2.gph ///
 fadj_wi_pr_dem_gt50_quart_3.gph ///
 fadj_wi_cancer_grp_spend_quart.gph fadj_wi_cancer_grp_quart_1.gph fadj_wi_cancer_grp_quart_2.gph ///
 fadj_wi_cancer_grp_quart_3.gph ///
 fadj_wi_heartdis_grp_spend_quart.gph fadj_wi_heartdis_grp_quart_1.gph fadj_wi_heartdis_grp_quart_2.gph ///
 fadj_wi_heartdis_grp_quart_3.gph ///
 fadj_wi_other_grp_spend_quart.gph fadj_wi_other_grp_quart_1.gph fadj_wi_other_grp_quart_2.gph ///
 fadj_wi_other_grp_quart_3.gph, col(4)
graph save fadj_wi_panel_quart_1leg, replace
graph export fadj_wi_panel_quart_1leg.tif, replace

*********************************************************
log close


H="Bar graph"
/*Try bar chart to show magnitude differences as an alternative to the pie charts

Split by Quartiles
5 year wage index, age,sex,race adjusted EOL spending
By the mutually exclusive disease groups
*/

capture log close
clear all
set mem 500m
set more off

local logpath E:\data\hrs_oop_2010\logs
local datapath E:\data\hrs_oop_2010\final_data
local graphpath E:\data\hrs_oop_2010\logs\bar_graph

log using `logpath'\16-oop_bar_quartiles-LOG.txt, text replace

cd `datapath'

use oop_mc_sample_adj_age_etc.dta

//create categorical variable for disease group and quartile
gen dg_quar_cat = .
forvalues i=1/3{
replace dg_quar_cat=`i' if pr_dem_gt50==1 &  quart3_dm_2yr==`i'
}  
forvalues i=1/3{
replace dg_quar_cat=`i'+3 if cancer_grp==1 &  quart3_dm_2yr==`i'
}  
forvalues i=1/3{
replace dg_quar_cat=`i'+6 if heartdis_grp==1 &  quart3_dm_2yr==`i'
} 
forvalues i=1/3{
replace dg_quar_cat=`i'+9 if other_grp==1 &  quart3_dm_2yr==`i'
} 
tab dg_quar_cat, missing
la var dg_quar_cat "Quartiles by Disease Group"
la def dgquar 1 "Dementia 1Q" 2 "Dementia 2&3Q" 3 "Dementia 4Q" ///
4 "Cancer 1Q" 5 "Cancer 2&3Q" 6 "Cancer 4Q" ///
7 "Heart Dis. 1Q" 8 "Heart Dis. 2&3Q" 9 "Heart Dis. 4Q" ///
10 "Other Dis. 1Q" 11 "Other Dis. 2&3Q" 12 "Other Dis. 4Q" 
la val dg_quar_cat dgquar

collapse (mean) adj_tot_paid_by_mc_60m_wi adj_nh_cost_medicaid_60m ///
 adj_nh_cost_private_60m adj_total_oop_60m adj_inf_care_costs_60m , by(dg_quar_cat)
 
 graph hbar tot_paid_by_mc_60m_wi nh_cost_medicaid_60m ///
 nh_cost_private_60m total_oop_60m inf_care_costs_60m , ///
 over(dg_quar_cat) stack ///
 legend(label(1 "Medicare") label(2 "Medicaid NH") label(3 "Private Payer NH") ///
label(4 "OOP") label(5 "Informal Care") cols(3)) ///
title("5 year EOL spending by disease group") ///
subtitle("Adjusted for wage index, age, race and gender")

graph save `graphpath'\bar_quart, replace

***********************************************************
log close