= V4 Outline MultiLine NoSorting TabWidth=30

H="Serious illness cohort definition development"
HRS variables are processed in file HRS_Processing.txt
1998-2010 Core interviews
2002-2010 Exit interviews
Restricted data received in November 2013

Note elixhauser comorbidities diagnosis lists are modified for the 
purposes of this project, do not copy and paste this Elixhauser code 
for use in other projects!!

******************************************************************

/*hrs cleaned path*/
libname hrs_fnl 'E:\data\hrs_cleaned';

/*medicare xwalk and claims path*/
libname medi 'E:\data\cms_DUA_25000_2010';

/*project data paths*/
libname sic_int 'E:\data\serious_ill\int_data';
libname sic_fin 'E:\data\serious_ill\final_data';
libname sic_ref 'E:\data\serious_ill\ref_data';

%let logdir=%str(E:\data\serious_ill\logs);


H="Initial core criteria"
/***********************************************************************/
/*Core interview dataset, merge variables from restricted              */
/***********************************************************************/

/*proc printto new 
log="&logdir.\sas_1_sic_core_criteria_log.log"
	print="&logdir.\sas_1_sic_core_criteria_out.lst"; 
run;*/

libname hrs_fnl 'E:\data\hrs_cleaned';

data core;
set hrs_fnl.core_00_to_10;
label c_ivw_year="Core interview year";
run;

proc sort data=core nodupkey;
by id core_year;
run;

data restr(rename=(ZIP10_2000=ZIP10));
set hrs_fnl.restricted_v2010(keep=hhid pn id birth_date death_date white black hisp_eth native_amer 
asian_pi other_race other_na_api_race zip: stateusps: cause_death_12_n );
id_c=trim(hhid)||trim(pn);
drop id;
rename id_c=id;
restr_yes=1;
run;

proc sort data=restr nodupkey;
by id;
run;

proc contents data=restr; run;

proc sql;
create table core_dob(drop=id2) as select * from core a left join
restr(rename=(id=id2) drop=hhid pn) b 
on a.id=b.id2;
quit;

*5 obs have no match in the restricted dataset;
*These obs each only have 1 inteview, so can't use them anyway;
proc freq data=core_dob; table restr_yes /missprint; run;

data restr_test;
set core_dob;
if restr_yes=.;
run;

data core_age_1;
set core_dob;
format death_date date9.;
age_at_core=(c_ivw_date-birth_date)/365.25;
label age_at_core="Age at core interview";
if age_at_core>=65 then age_ge_65=1;
if age_at_core<65 then age_ge_65=0;
label age_ge_65="Age at core interview > 65";

core_to_death=(death_date-c_ivw_date)/365.25;
label core_to_death="Time from core ivw to death, years";
if core_to_death<=1 and core_to_death~=. then core_to_dod_1yr=1;
if core_to_death>1 or core_to_death=. then core_to_dod_1yr=0;
label core_to_dod_1yr="Died within 1 year of core interview";
run;

proc freq data=core_age_1;
table age_ge_65 core_to_dod_1yr /missprint;
run;


****************************************************************;
*get clean zip code variable by wave;
proc sort data=core_age_1; by id core_year; run;

/*get list of first and last interview years*/
data ivw_years_1;
set core_age_1;
by id; 
if first.id then first_ivw_year=core_year;
if last.id then last_ivw_year=core_year;
run;

data ivw_years_1a;
set ivw_years_1;
if first_ivw_year~=.;
run;

data ivw_years_1b;
set ivw_years_1;
if last_ivw_year~=.;
run;

proc sql;
create table ivw_years_2 as select a.id,a.first_ivw_year,b.last_ivw_year
from ivw_years_1a a left join
ivw_years_1b b
on a.id=b.id;
quit;

proc freq; table first_ivw_year last_ivw_year; run;

*merge into overall dataset;
proc sql;
create table core_age_zip_1 as select
a.*, b.first_ivw_year,b.last_ivw_year from
core_age_1 a left join
ivw_years_2 b
on a.id=b.id;
quit;

proc freq; table first_ivw_year last_ivw_year; run;

/*clean up missing zip variables
1. if missing, use interview prior
2. if still missing, use interview after
3. if still missing, use interview 2x prior...*/

data core_age_zip_2 ;
set core_age_zip_1 ;
/*1998 updates, use 2000 zip
1 obs only has one interview in our dataset for 1998 and is missing zip that year, won't be
in the final sample so leave as missing now*/
if zip98='' & first_ivw_year<=1998<=last_ivw_year then do;
	zip_98_imp_yes=1;
	zip98=zip00;
	end;
/*2000 updates, use 1998 zip
2 obs only have one interview in the dataset for 2000, missing zip that year, again not
in final sample so leave missing here*/
if zip00='' & first_ivw_year<=2000<=last_ivw_year then do;
	zip_00_imp_yes=1;
	zip00=zip98;
	end;
/*2002 updates, use 2000 or 2004 zip
1 obs has only the 2002 interview, leave zip missing for that person*/
if zip02='' & first_ivw_year<=2002<=last_ivw_year then do;
	zip_02_imp_yes=1;
	zip02=zip00;
		if zip02='' then do;
		zip02=zip04;
		end;
	end;
/*2004 updates, use 2002 or 2006 zip
13 obs has only the 2004 interview, leave zip missing for those observations*/
if zip04='' & first_ivw_year<=2004<=last_ivw_year then do;
	zip_04_imp_yes=1;
	zip04=zip02;
		if zip04='' then do;
		zip04=zip06;
		end; /*1 obs still missing, use 1998 zip for this person*/
				if zip04='' then do;
				zip04=zip98;
				end; 
	end;
/*2006 updates, use 2004 or 2008 zip
no observations missing*/
if zip06='' & first_ivw_year<=2006<=last_ivw_year then do;
	zip_06_imp_yes=1;
	zip06=zip04;
		if zip06='' then do;
		zip06=zip08;
		end; 
	end;
/*2008 updates, use 2006 zip
no observations missing*/
if zip08='' & first_ivw_year<=2008<=last_ivw_year then do;
	zip_08_imp_yes=1;
	zip08=zip06;
	end;
/*2010 updates, use 2008 zip
1 obs has only 2010 interview and missing zip that year, so leave missing*/
if zip10='' & first_ivw_year<=2010<=last_ivw_year then do;
	zip_10_imp_yes=1;
	zip10=zip08;
	end;
run;

****************************************************************;

*get clean state code variable by wave;
data core_age_zip_state;
set core_age_zip_2;
/*1998 state - n=1 obs only has one interview with missing zip,state, leave blank*/
if stateusps98='' & first_ivw_year<=1998<=last_ivw_year then do;
	st_98_imp_yes=1;
	stateusps98=stateusps00;
	end;
/*2000 state - n=2 obs only single interview so leave missing*/ 
if stateusps00='' & first_ivw_year<=2000<=last_ivw_year then do;
	st_00_imp_yes=1;
	stateusps00=stateusps98;
	end;
/*2002 state - n=1 obs only single interview so leave missing*/ 
if stateusps02='' & first_ivw_year<=2002<=last_ivw_year then do;
	st_02_imp_yes=1;
	stateusps02=stateusps00;
	if stateusps02='' then do;
		stateusps02=stateusps04;
		end;
	end;
/*2004 updates, use 2002 or 2006 state
13 obs has only the 2004 interview, leave state missing for those observations*/
if stateusps04='' & first_ivw_year<=2004<=last_ivw_year then do;
	st_04_imp_yes=1;
	stateusps04=stateusps02;
		if stateusps04='' then do;
		stateusps04=stateusps06;
		end; /*1 obs still missing, use 1998 state for this person*/
				if stateusps04='' then do;
				stateusps04=stateusps98;
				end; 
	end;
/*2006 updates, use 2004 or 2008 state
no observations missing*/
if stateusps06='' & first_ivw_year<=2006<=last_ivw_year then do;
	st_06_imp_yes=1;
	stateusps06=stateusps04;
		if stateusps06='' then do;
		stateusps06=stateusps08;
		end; 
	end;
/*2008 updates, use 2006 state
no observations missing*/
if stateusps08='' & first_ivw_year<=2008<=last_ivw_year then do;
	st_08_imp_yes=1;
	stateusps08=stateusps06;
	end;
/*2010 updates, use 2008 state
1 obs has only 2010 interview and missing state that year, so leave missing*/
if stateusps10='' & first_ivw_year<=2010<=last_ivw_year then do;
	st_10_imp_yes=1;
	stateusps10=stateusps08;
	end;
run;

proc sort data=core_age_zip_state; by id core_year; run;

*save dataset and drop raw zip code variables;
data sic_int.core_age_zip;
set core_age_zip_state;
zip_wave=vvaluex("zip"||substr(trim(left(core_year)),3,2) );
zip_imputed=vvaluex("zip_"||substr(trim(left(core_year)),3,2)||"_imp_yes" );
drop zip9: zip0: zip1: ;
label zip_wave="ZIP code, residence at time of interview";
label zip_imputed="ZIP code imputed";

state_wave=vvaluex("stateusps"||substr(trim(left(core_year)),3,2) );
state_imputed=vvaluex("st_"||substr(trim(left(core_year)),3,2)||"_imp_yes" );
drop stateusps: ;
label state_wave="State, residence at time of interview";
label state_imputed="State imputed";
run;

proc freq; table zip_wave state_wave data=sic_int.core_age_zip /missprint ; run;

proc freq; table zip_imputed state_imputed /missprint ; run;

****************************************************************;

ods rtf body=" E:\data\serious_ill\logs\core_00_to_08_meet_criteria.rtf" ;
proc sql;
title "serious illness cohort, initial core interview criteria";
title "meet age>=65 at core interview,2000-2008";
select count(distinct id) from sic_int.core_age_zip
where age_ge_65=1 and core_year in (2000,2002,2004,2006,2008);
create table age_ge_65 as 
select * from sic_int.core_age_zip
where age_ge_65=1 and core_year in (2000,2002,2004,2006,2008);

title "those meet age>=65,srf(poor,fair)";
select count(distinct id) from age_ge_65 
where srh_pf=1 ;

title "those meet age>=65,chf";
select count(distinct id) from age_ge_65 
where chf_hrs=1 ;

title "those meet age>=65,lung";
select count(distinct id) from age_ge_65 
where lung_hrs=1 ;

title "those meet age>=65,diabetes";
select count(distinct id) from age_ge_65 
where dm_hrs=1 ;

title "those meet age>=65,cancer";
select count(distinct id) from age_ge_65 
where cancer_hrs=1 ;

title "those meet age>=65,chf or lung or diabetes or cancer";
select count(distinct id) from age_ge_65 
where  chf_hrs=1 or lung_hrs=1 or dm_hrs=1 or cancer_hrs=1 ;

title "those meet age>=65,hosp_last_2yr,since last interview";
select count(distinct id) from age_ge_65 
where hosp_last_2yr=1 ;

title "those meet age>=65,meet at least one,fair or poor self report/chf/lung/diabet/cancer/hosp_last_2yr";
select count(distinct id) from age_ge_65 
where  srh_pf=1 or chf_hrs=1 or lung_hrs=1 or dm_hrs=1 or cancer_hrs=1 or hosp_last_2yr=1 ;

title "age>=65,meet at least one,fair or poor self report/chf/lung/diabet/cancer/hosp_last_2yr/1 adl";
select count(distinct id) from age_ge_65 
where  srh_pf=1 or chf_hrs=1 or lung_hrs=1 or dm_hrs=1 or cancer_hrs=1 or hosp_last_2yr=1 
or adl_independent_core=0;

quit;
ods rtf close;

H="Link in Wage Index by Zip Code or State"
/*Note that the raw data with the wage index is saved in the out of pocket
(OOP) spending project folders rather than duplicating it for this project*/

/******************************************************************/
/* Adjust subtotals for wage index */
/******************************************************************/

/******************************************************************/
/* Pull in wage index file and clean up for states that are missing WI*/
/******************************************************************/
/*bring in 2010 wage index file*/
proc import datafile="E:\data\hrs_oop_2010\ref_data\wage_index\wage_index_cbsa_2010.xls"
out=sic_int.wage_index 
replace;
run;

/*get RI average*/
data wi_ri;
set sic_int.wage_index;
if index(trim(left(Area_Title)),", RI")>0;
run;

proc means;
var wage_index;
run;

/*get DC average*/
data wi_dc;
set sic_int.wage_index;
if index(trim(left(Area_Title)),", DC")>0;
run;

proc means;
var wage_index;
run;

/*deal with states that were missing wage index values in the 2010 file
These values are the state averages using the individual cbsa values 
data in the 2010 excel file came from
Note in switching from 2008 to 2010, RI, DC are missing
Manually added in blank DC line to Excel sheet so entry can match rest of other states*/
data wage_index2;
set sic_int.wage_index;
cbsa_n=cbsa_code+0;
if trim(left(cbsa_code))~="";
wage_index_2010=Wage_Index;
if index(trim(left(Area_Title)),", RI")>0 then RI=1;
if index(trim(left(Area_Title)),", DC")>0 then DC=1;
*state 44=RI ,state 11=DC;
if state_in_wage_index=44 then wage_index_2010=1.0783000; 
if state_in_wage_index=11 then wage_index_2010=1.0701250; *replace this with the avg!;
run;

*Look at observations from Rhode Island;
proc freq data=wage_index2(where=(ri=1));
table Area_Title;
run;

%let var=ri;
proc means data=wage_index2;
class &var;
var wage_index_2010;
run;

*Look at observations from DC;
proc freq data=wage_index2(where=(DC=1));
table Area_Title;
run;

%let var=DC;
proc means data=wage_index2;
class &var;
var wage_index_2010;
run;


/******************************************************************/
/* Link CBSA codes and zip codes from the WI file*/
/******************************************************************/
/*Bring in xwalk file between CBSA codes and zip codes
Note only keep variables needed from xwalk file because formats 
are missing for some of the other text variables*/

libname oop_ref "E:\data\hrs_oop_2010\ref_data";

data zip_cb;
set oop_ref.xtract(keep=zip5 cbsa state);
zip_n=zip5+0;
cbsa_n=cbsa+0;
/*If zip code is not missing, add state code*/
if zip_n~=.;
state_n=state+0;
run;

*Remove duplicate entries for zip5 and cbsa from xwalk file;
*Goes from 399045 to 49289 rows;
proc sort data=zip_cb out=zip_cb2 nodupkey;
by zip_n cbsa_n;
run;

*Check to see zip codes in a cbsa code for Rochester, NY;
proc sql;
select zip5, cbsa from zip_cb2
where cbsa_n in (40380);
quit;

/*note several zip codes have multiple cbsa*/
/*create dataset with just one entry for each zip code
8029 zip codes have more than one cbsa code
Just use the first one when sort*/
proc sort data=zip_cb2 out=cbsa_zip_final nodupkey;
by zip_n;
run;

*Check to see zip codes in a cbsa code for Rochester, NY;
proc sql;
select zip_n, cbsa from cbsa_zip_final
where cbsa_n in (40380);
quit;

/******************************************************************/
/* Create dataset with cbsa, state, wage index and zip code */
/******************************************************************/

/*for zip codes with no cbsa, wage index is left missing
there are also many cbsas with missing wage index*/
proc sql;
create table zip_cbsa_wage_index as
select a.*,b.wage_index_2010 from
cbsa_zip_final a
left join
wage_index2 b
on a.cbsa_n=b.cbsa_n;
quit;

/*Check for and remove duplicates by zip, keep first entry*/
proc sort data=zip_cbsa_wage_index out=zip_cbsa_wage_index2 nodupkey;
by zip_n;
run;

/******************************************************************/
/* Merge the wage index into the interview dataset by the cleaned zip */
/******************************************************************/

/*change zip in interview dataset to a number*/
data core_age_zip_1 ;
set sic_int.core_age_zip;
zip_wave_n=zip_wave+0;
run;

proc contents; run;

proc sql;
create table core_age_zip_wi as select a.*,b.wage_index_2010 from
core_age_zip_1 a
left join
zip_cbsa_wage_index2 b
on a.zip_wave_n=b.zip_n;
quit;

/*n=60886 ivws are missing the wage index when matched just by zip*/
data miss_wi;
set core_age_zip_wi;
if wage_index_2010 =.;
run;

/******************************************************************/
/* Bring in  WI by state if missing by zip (b/c not in a metro area) */
/******************************************************************/
proc sort data=wage_index2 out=wage_index3 nodupkey;
by state_in_wage_index;
run;

proc freq data=wage_index3; table State_; run;

/*Merges in wage index if there's one for the state but was missing for the zip*/
proc sql;
create table sic_int.core_age_zip_wi_2
as select a.*,coalesce(a.wage_index_2010,b.wage_index_2010) as wage_index_20102
from
core_age_zip_wi a
left join
wage_index3 b
on a.state_wave=b.State_;
quit;

/*check for missing values*/
proc means;
var wage_index_2010 wage_index_20102;
run;

proc sql;
select distinct state_wave ,count(*) from sic_int.core_age_zip_wi_2
where wage_index_20102=. group by state_wave;
quit;

proc sql;
select distinct zip_wave_n ,count(*) from sic_int.core_age_zip_wi_2
where wage_index_20102=. group by zip_wave_n;
quit;

proc freq data=sic_int.core_age_zip_wi_2; table  state_wave  /missprint ; run;

H="Create frequency tables of core variables"
/*creates log file to review with Amy for new variables*/

capture log close

clear all
set mem 1g
set matsize 800
set more off

//Need to create project file paths for new dataset, logs!
//Amy's PC
local logpath E:\data\serious_ill\logs
local datapath E:\data\hrs_cleaned\working

//RG PC
//local logpath C:\data\serious_illness_cohort\logs
//local datapath C:\HRS\hrs_cleaned\working

log using "`logpath'\1_sic_new_variables.txt", text replace
cd `datapath'

***********************************************************************
//Core interview dataset
***********************************************************************
use core_98_10_nw_tics.dta //dataset without core interview dates added (all public)

//indicator, categorical variables local, want frequency tables
local catvars alz_hrs dem_hrs cancer_hrs cancer_treat_hrs heart_hrs chf_hrs chfadmit_hrs ///
lung_hrs lung_o2_hrs lung_lim_hrs dm_hrs dm_ins_hrs dm_kidn_hrs hip_frac_hrs nhres ///
nhres_start_mo nhres_start_yr nhres_2yr  hh_worker hosp_last_2yr pain_hrs pain_level_hrs ///
pain_limit_act_hrs cesd_tot cesd_tot_ge3 dyspnea_hrs swelling_feet_hrs dizzy_hrs ///
back_pain_hrs headache_hrs fatigue_hrs cough_hrs depr_2_wks_hrs insom_falling_asleep insom_waking_up ///
insom_too_early insom_rested insom_med_sleep insom_med_dr sr_memory sr_mem_change ///
pr_memory pr_mem_change adl_diff_dr adl_dr_core adl_diff_wk adl_equip_wk adl_wk_core adl_diff_bh ///
 adl_bh_core adl_diff_e adl_e_core adl_diff_tx adl_equip_tx adl_tx_core adl_diff_t adl_t_core ///
 iadl_diff_map iadl_diff_mp iadl_mp_core iadl_diff_gr iadl_gr_core iadl_diff_ph iadl_ph_core ///
 iadl_diff_rx iadl_rx_core iadl_diff_m iadl_m_core  fl_diff_wk_many fl_diff_wk_one fl_diff_sit ///
 fl_diff_gu fl_diff_sta_many fl_diff_sta_one fl_diff_stp fl_diff_reach fl_diff_push fl_diff_lift ///
 fl_diff_dime adl_sp_helper adl_oth_helper iadl_sp_helper iadl_sp_helper adl_hlp_freq_imp_ed iadl_hlp_freq_imp_ed

//continuouse variables
local contvars nh_nights hosp_stays_2yr hosp_nights_2yr TICS_tot adl_helper_count iadl_helper_count ///
adl_hlp_freq_imp_mo iadl_hlp_freq_imp_mo adl_help_hours iadl_help_hours

//describe

tab core_year, missing

foreach v in `catvars' {
tab `v' core_year, missing
}

foreach v in `contvars' {
sum `v', detail
}


***********************************************************************
//Exit interview dataset
***********************************************************************
clear 
use exit_02_10_clean.dta //exit prior to adding interview dates

local xcatvars nhres nhres_start_mo nhres_start_yr pain_hrs ///
pain_level_hrs depr_exit delirium_exit dyspnea_hrs fatigue_hrs ///
no_appet_hrs discuss dexp

foreach v in `xcatvars' {
tab `v' exit_year, missing
}

log close


H="Process Claims Relative to Core Interview Date"
/*Get claims 1 year and 2 year before each core interview*/

/*proc printto new 
log="&logdir.\sas_2_sic_add_xwalk_log.log"
	print="&logdir.\sas_2_sic_add_xwalk_out.lst"; 
run;*/

/*Step 1: Bring in mc xwalk id
sic_int.core_xwalk_1 has core interviews, age and claims xwalk id */

/*prepare core dataset to merge*/
proc sort data=sic_int.core_age_zip_wi_2 out=core_id nodupkey;
by id c_ivw_date;
run;

/*prepare xwalk id file to merge*/
data crosswalk_1;
set medi.cmsxref2010;
keep bid_hrs_19 hhid pn;
run;

/*get 2 variables bid_hrs = claims id, id=HRS id*/
data crosswalk_2;
set crosswalk_1;
bid_hrs=bid_hrs_19;
id=trim(hhid)||trim(pn);
drop hhid pn;
drop bid_hrs_19;
run;

proc sort data= crosswalk_2;
by id;
run;

/*bring in xwalk id to core interview dataset*/
proc sql;
create table core_xwalk as select
a.*,b.bid_hrs from
core_id a
left join
crosswalk_2 b
on a.id=b.id;
quit;

/*check for missing xwalk ids
38934 of 130320 interviews are missing xwalk ids*/
data check1;
set core_xwalk ;
if bid_hrs ='';
run;

/*create indicator for having xwalk id*/
data core_xwalk_1;
set core_xwalk;
xwalk_yes=.;
if bid_hrs ='' then xwalk_yes=0;
if bid_hrs~='' then xwalk_yes=1;
run;

proc freq;
table xwalk_yes*core_year /missprint;
run;

/*just get information needed to grab claims, drop rest of interview data
So pulls all interviews for r's with the mc linkage
91386 interviews have linkage*/
data sic_int.core_lmt_xwalk_2;
set core_xwalk_1(keep=id core_year c_ivw_date c_ivw_year c_ivw_month age_at_core bid_hrs xwalk_yes wage_index_20102);
if xwalk_yes=1;
run;

/********************************************************************/
/* Get claims death date, from denominator file as a check
where dod from interview is imputed or after exit interview date */
/********************************************************************/
proc sort data=medi.dn_2000_2010 out=dn_dod_1  nodupkey;
by BID_HRS_19 year;
run;

/*just keep dod from last year*/
data dn_dod_2;
set dn_dod_1;
by BID_HRS_19 year;
if last.BID_HRS_19;
run;

proc freq;
table death_dt /missprint;
run;

/*add to the core dataset with xwalk id*/
proc sort data=core_xwalk_1; by bid_hrs; run;

proc sql;
create table sic_int.core_xwalk_2 as select a.*,b.death_dt as dod_claims
from core_xwalk_1 a left join
dn_dod_2 b
on a.bid_hrs=b.BID_HRS_19;
quit;


H="Step 2a - Identify FFS MC 1yr and 6mos preceeding core interview"
/*Use denominator file to determine which interviews / r's have ffs mc
during the full 12 months preceeding the core interview

2 sets of variables created, 1 for 12 month lookback,
one for 6 month lookback to see what the difference in sample
size would be with the more relaxed requirement*/

/*proc printto new log="&logdir.\sas_3_sic_ffs_log.log"
	print="&logdir.\sas_3_sic_ffs_out.lst" ;
run;*/

proc sort data=medi.dn_2000_2010 out=dn_2000_20102  nodupkey;
by BID_HRS_19 year;
run;

proc sort data=sic_int.core_lmt_xwalk_2 out=core_mc_ids nodupkey;
by bid_hrs c_ivw_year;
run;

proc freq;
table c_ivw_year;
run;

*2 obs have missing core year because no restricted data (no ivw date or dob);
proc freq data=core_mc_ids; table c_ivw_year /missprint; run;

data core_year_test; set core_mc_ids; if c_ivw_year=.; run;

/*pull medicare and hmo status variables from dn file
for the core interview years
interviews are dropped if they don't have a matching dn entry that year*/
proc sql;
create table dn_core_y as select
a.*,b.buyin12,b.year,b.HMOIND12
from core_mc_ids a inner join
dn_2000_20102 b
on trim(left(a.BID_hrs))=trim(left(b.BID_hrs_19))
and a.c_ivw_year=b.year;
quit;

proc freq data=dn_core_y ;
table c_ivw_year c_ivw_month age_at_core;
run;

/*16095 r's have at least 1 interview with a denominator file linked*/
proc sql;
select count(distinct BID_hrs) from dn_core_y ;
quit;

data dn_core_y2;
set dn_core_y;
if length(trim(left(buyin12)))=12 and c_ivw_month>0 then do;
buyin_dy=substr(trim(left(buyin12)),1,c_ivw_month);
hmo_dy=substr(trim(left(HMOIND12)),1,c_ivw_month);
end;
else do;
buyin_dy=trim(left(buyin12));
hmo_dy=trim(left(HMOIND12));
end;
format c_ivw_date date9.;
age_at_core_n=floor(age_at_core);
run;
proc means n;
var  c_ivw_month;
run;
proc freq;
table age_at_core_n;
run;

/*Check year prior to core interview to backfill for interview dates
in the first half of the year (since doing 12 mo look back)*/
/* 49041 have the -1 year dn file*/
proc sql;
create table dn_core_y_bef as select
a.BID_hrs,a.c_ivw_year ,
b.year as c_ivw_year_bef,
b.year,b.buyin12,b.HMOIND12
from dn_core_y a inner join
dn_2000_20102 b
on trim(left(a.BID_hrs))=trim(left(b.BID_hrs_19))
and 0<a.c_ivw_year-b.year<=1 order by bid_hrs,c_ivw_year;
quit;

proc sql;
create table all_insurance as select a.*,b.year as year_bef_civw, 
b.buyin12 as buyin_bef,b.HMOIND12 as hmo_bef from
dn_core_y2 a
left join
dn_core_y_bef b
on trim(left(a.BID_hrs))=trim(left(b.BID_hrs)) 
and a.c_ivw_year=b.c_ivw_year;
quit;

proc freq data=all_insurance;
table c_ivw_year*year_bef_civw /missprint;
run;

/*merge interview year and year before interview buy-in and hmo variables
Trim so the final variable _12m is 12 months pre-interview
Note: indicator variables for parts a and b and hmo are null if don't
have information for full 12 months pre-interview*/
data all_insurance2;
set all_insurance;
buyin_2y=trim(left(buyin_bef))||trim(left(buyin_dy));
hmo_2y=trim(left(hmo_bef))||trim(left(hmo_dy));

buyin_2y_r=reverse(trim(buyin_2y));
hmo_2y_r=reverse(trim(hmo_2y));

*************************************************;
** 12 month variables                          **;
*************************************************;
if length(buyin_2y_r)>11 then buyin_12m_r=substr(trim(left(buyin_2y)),1,12);
if length(hmo_2y_r)>11 then hmo_12m_r=substr(trim(left(hmo_2y)),1,12);

if length(buyin_2y_r)<12 then buyin_12m_r="";
if length(hmo_2y_r)<12 then hmo_12m_r="";

buyin_12m=reverse(trim(buyin_12m_r));
hmo_12m=reverse(trim(hmo_12m_r));

/*create indicator variable for mc coverage 12 mo. 0=no, 1=yes*/
if length(buyin_12m)=12 then do;
if indexc(buyin_12m,"0","1","2","A","B") then part_ab_12m=0;
if indexc(buyin_12m,"0","1","2","A","B")=0 then part_ab_12m=1;
end;
if length(hmo_12m)=12 then do;
if index(hmo_12m,"00000000000") then hmo_d_12m=0;
if index(hmo_12m,"00000000000")=0 then hmo_d_12m=1;
end;

*************************************************;
** 6 month variables                          **;
*************************************************;
if length(buyin_2y_r)>5 then buyin_6m_r=substr(trim(left(buyin_2y)),1,6);
if length(hmo_2y_r)>5 then hmo_6m_r=substr(trim(left(hmo_2y)),1,6);

if length(buyin_2y_r)<6 then buyin_6m_r="";
if length(hmo_2y_r)<6 then hmo_6m_r="";

buyin_6m=reverse(trim(buyin_6m_r));
hmo_6m=reverse(trim(hmo_6m_r));

/*create indicator variable for mc coverage 6 mo. 0=no, 1=yes*/
if length(buyin_6m)=6 then do;
if indexc(buyin_6m,"0","1","2","A","B") then part_ab_6m=0;
if indexc(buyin_6m,"0","1","2","A","B")=0 then part_ab_6m=1;
end;
if length(hmo_6m)=6 then do;
if index(hmo_6m,"000000") then hmo_d_6m=0;
if index(hmo_6m,"000000")=0 then hmo_d_6m=1;
end;

run;

/*12954 observations don't have full denominator data re insurance status
either interview Before Jan 2001 (10945 ivws) or are missing year -1 dn file
*/
proc freq;
table part_ab_12m hmo_d_12m part_ab_12m*age_at_core_n part_ab_6m hmo_d_6m;
run;

/*bring indicators into full interview dataset*/
proc sql;
create table sic_int.core_xwalk_ins as select a.*,b.part_ab_12m,b.hmo_d_12m,b.part_ab_6m,b.hmo_d_6m
 from
sic_int.core_xwalk_2 a left join
all_insurance2 b
on a.bid_hrs=b.bid_hrs and a.c_ivw_year=b.c_ivw_year;
quit;

proc freq data=sic_int.core_xwalk_ins;
table age_ge_65*part_ab_12m age_ge_65*part_ab_6m /missprint;
run;

/*look into missing medicare status 12m preceding the interview*/
proc sql;
create table zzz_core_xwalk_ins as select a.*,b.part_ab_12m,b.hmo_d_12m,
	b.part_ab_6m,b.hmo_d_6m,b.buyin_12m,b.buyin_6m,b.year as dn_year_ivw,
	b.year_bef_civw as dn_year_bef_civw
 from
sic_int.core_xwalk_2 a left join
all_insurance2 b
on a.bid_hrs=b.bid_hrs and a.c_ivw_year=b.c_ivw_year;
quit;

/*why missing medicare status 12m?*/
/*n=72559 age >66 at interview, so elgible for 1 year prior*/
data age_ge_65;
set zzz_core_xwalk_ins;
if age_at_core>=66;
run;
*n=65920 have xwalk
*n=20024 ivws are 2000 and earlier;
proc freq;
table xwalk_yes c_ivw_year /missprint;
run;
*n=47241
of those, n=2213 that are missing status don't have the full 1
year lookback;
data age_ge_65_1;
set age_ge_65;
if xwalk_yes =1 and c_ivw_year>2000;
length_12m=length(buyin_12m);
length_6m=length(buyin_6m);
run;
proc freq; table length_12m length_6m /missprint; run;

data age_ge_65_2;
set age_ge_65_1;
if length_12m~=12;
run;
proc freq; table dn_year_ivw*dn_year_bef_civw /missprint; run;
proc freq; table dn_year_ivw*dn_year_bef_civw /missprint; run;
proc freq; table dn_year_ivw*c_ivw_year /missprint; run;

*2157 have no denominator link the year of the ivw;
*of these 2157, n=2058 are interviews done in 2011, we don't have 2011 dn file;
*n=56 gave dn year of ivw but not year before;

H="Step 2 - Get claims"
/*Get claims 1 year and 2 year before each core interview*/

/*Step 2: Pull claims lists using mc xwalk id and interview date
Save claims lists to project folder for use later */

/*proc printto new log='&logdir.\sas_4_sic_get_claims_log.log'
	print='&logdir.\sas_4_sic_get_claims_out.lst' 
run;*/

/*get a copy of the dataset with just ffs medicare ivws age 65+
use this list to pull the claims lists
n=32718 - just check claims for those that meet analysis criteria*/
data sic_int.core_xwalk_ins_ffs_only;
set sic_int.core_xwalk_ins(keep=bid_hrs c_ivw_date c_ivw_year core_year part_ab_12m hmo_d_12m age_ge_65);
if part_ab_12m=1 & hmo_d_12m=0 & age_ge_65=1;
run;

/****************************************************************************/
/* Macro to pull claims lists, saves lists to int_data folder               */
/****************************************************************************/

/*macros to create claims lists, one for all but medpar, one for medpar*/
%macro other(days_start=,days_bef_core=,source= );

proc sql;
create table &source._meet_&days_bef_core. as select a.*,b.c_ivw_date,b.core_year
from medi.&source._2000_2010 a inner join
sic_int.core_xwalk_ins_ffs_only b
on trim(left(a.bid_hrs_19))=trim(left(b.bid_hrs))
and &days_start<=b.c_ivw_date-a.admit_date<=&days_bef_core;
quit;

%mend;


%macro mp(days_start=,days_bef_core=,source=,time_label=);

proc sql;
create table &source._meet as select a.*,b.c_ivw_date,b.core_year
from medi.&source._2000_2010 a inner join
sic_int.core_xwalk_ins_ffs_only b
on trim(left(a.bid_hrs_19))=trim(left(b.bid_hrs))
and &days_start<=b.c_ivw_date-a.admit_date<=&days_bef_core;
quit;

proc sql;
create table &source._meet2 as select a.*,b.c_ivw_date,b.core_year
from medi.&source._2000_2010 a inner join
sic_int.core_xwalk_ins_ffs_only b
on trim(left(a.bid_hrs_19))=trim(left(b.bid_hrs))
and b.c_ivw_date-a.admit_date>&days_bef_core and b.c_ivw_date-a.disch_date<=&days_bef_core;
quit;

data &source._meet3_&days_bef_core.;
set &source._meet &source._meet2;
run;

%mend;

/*run to get claims list 6 months pre-core for medpar
Use to get indicator of hospitalizations 6 m prior to interview*/
%mp(days_start=0,days_bef_core=183,source=mp );

/*run to get claims lists 1 year pre-core
Datasets are sic_int.mp_meet3_365, sic_int.hh_meet_365, etc.*/
%mp(days_start=0,days_bef_core=365,source=mp );

%other(days_start=0,days_bef_core=365,source=hh );
%other(days_start=0,days_bef_core=365,source=hs );
%other(days_start=0,days_bef_core=365,source=dm);
%other(days_start=0,days_bef_core=365,source=op );
%other(days_start=0,days_bef_core=365,source=pb );

/*run to get claims lists 2 years pre-core
Datasets are sic_int.mp_meet3_730, sic_int.hh_meet_730, etc.*/
%mp(days_start=0,days_bef_core=730,source=mp );
%other(days_start=0,days_bef_core=730,source=hh );
%other(days_start=0,days_bef_core=730,source=hs );
%other(days_start=0,days_bef_core=730,source=dm );
%other(days_start=0,days_bef_core=730,source=op );
%other(days_start=0,days_bef_core=730,source=pb );

/****************************************************************************/
/*Run medpar code on the ip claims list to get ip claims 1 year pre-core
Use these ip claims for the hip fracture determination*/
%mp(days_start=0,days_bef_core=365,source=ip );

/****************************************************************************/
/*prior to saving the permanent claims datasets, drop unneeded variables
this speeds up runnnig code later on*/

/*mp claims*/
%macro mp_drop(days_bef_core=);
data sic_int.mp_meet3_&days_bef_core.;
set mp_meet3_&days_bef_core.(keep=bid_hrs_19 core_year c_ivw_date admit_date disch_date 
 SSLSSNF icarecnt CRNRYDAY type_adm ER_AMT AD_DGNS DGNS_CD01-DGNS_CD25 PRCDR_CD01-PRCDR_CD25 
 PRCDR_DT01-PRCDR_DT25 );
run;
%mend mp_drop;

/*hh*/
%macro hh_drop(days_bef_core=);
data sic_int.hh_meet_&days_bef_core.;
set hh_meet_&days_bef_core.(keep=bid_hrs_19 core_year c_ivw_date PDGNS_CD DGNSCD01-DGNSCD25 );
run;
%mend hh_drop;

/*hs*/
%macro hs_drop(days_bef_core=);
data sic_int.hs_meet_&days_bef_core.;
set hs_meet_&days_bef_core.(keep=bid_hrs_19 core_year c_ivw_date PDGNS_CD DGNSCD01-DGNSCD25 );
run;
%mend hs_drop;

/*dme*/
%macro dm_drop(days_bef_core=);
data sic_int.dm_meet_&days_bef_core.;
set dm_meet_&days_bef_core.(keep=bid_hrs_19 core_year c_ivw_date admit_date BETOS01:BETOS13
PDGNS_CD DGNS_CD1-DGNS_CD12 );
run;
%mend dm_drop;

/*op*/
%macro op_drop(days_bef_core=);
data sic_int.op_meet_&days_bef_core.;
set op_meet_&days_bef_core.(keep=bid_hrs_19 core_year c_ivw_date admit_date disch_date
 RVCNTR01-RVCNTR45 PDGNS_CD DGNSCD01-DGNSCD25 );
run;
%mend op_drop;

/*ip*/
%macro ip_drop(days_bef_core=);
data sic_int.ip_meet3_&days_bef_core.;
set ip_meet3_&days_bef_core.(keep=bid_hrs_19 core_year c_ivw_date admit_date disch_date
 HCPSCD01-HCPSCD45 );
run;
%mend ip_drop;

/*carrier*/
%macro pb_drop(days_bef_core=);
data sic_int.pb_meet_&days_bef_core.;
set pb_meet_&days_bef_core.(keep=bid_hrs_19 core_year c_ivw_date FROM_DT THRU_DT admit_date disch_date
 HCPSCD01-HCPSCD13 PDGNS_CD DGNS_CD1-DGNS_CD12 );
run;
%mend pb_drop;

%mp_drop(days_bef_core=183);
%mp_drop(days_bef_core=365);
%mp_drop(days_bef_core=730);
%hh_drop(days_bef_core=365);
%hh_drop(days_bef_core=730);
%hs_drop(days_bef_core=365);
%hs_drop(days_bef_core=730);
%dm_drop(days_bef_core=365);
%dm_drop(days_bef_core=730);
%op_drop(days_bef_core=365);
%op_drop(days_bef_core=730);
%pb_drop(days_bef_core=365);
%pb_drop(days_bef_core=730);
%ip_drop(days_bef_core=365);


/****************************************************************************/
/****************************************************************************/
/* Macro to pull dx from claims lists, saves dx lists to int_data folder    */
/****************************************************************************/

%macro dx_time_range(range1=, range2=, days_bef_core=);

/*Process carrier medicare claims to pull out dx codes
Multiple lines per each BID*/
data pb_last_&range2._dx(keep=bid_hrs_19 core_year diag);
set sic_int.pb_meet_&days_bef_core.(keep=bid_hrs_19 core_year PDGNS_CD DGNS_CD1-DGNS_CD12 );
array dx PDGNS_CD DGNS_CD1-DGNS_CD12;
do over dx;
diag=dx ;
output;
end;
run;
/*check for and remove duplicates, note this doesn't remove blanks*/
proc sort data=pb_last_&range2._dx out=pb_last_&range2._dx2 nodupkey;
by bid_hrs_19 core_year diag;
run;


/*Process outpatient medicare claims to pull out dx codes
Dataset being created: op_last_&range2._dx2*/
data op_last_&range2._dx(keep=bid_hrs_19 core_year diag);
set sic_int.op_meet_&days_bef_core.(keep=bid_hrs_19 core_year PDGNS_CD DGNSCD01-DGNSCD25  );
array dx PDGNS_CD DGNSCD01-DGNSCD25 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=op_last_&range2._dx out=op_last_&range2._dx2 nodupkey;
by bid_hrs_19 core_year diag;
run;

/*Process medpar medicare claims to pull out dx codes
Dataset being created: mp_last_&range2._dx2*/
data mp_last_&range2._dx(keep=bid_hrs_19 core_year diag);
set sic_int.mp_meet3_&days_bef_core.(keep=bid_hrs_19 core_year AD_DGNS DGNS_CD01-DGNS_CD25 );
array dx AD_DGNS DGNS_CD01-DGNS_CD25 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=mp_last_&range2._dx out=mp_last_&range2._dx2 nodupkey;
by bid_hrs_19 core_year diag;
run;

/*Process dme medicare claims to pull out dx codes
Dataset being created: dm_last_&range2._dx2*/
data dm_last_&range2._dx(keep=bid_hrs_19 core_year diag);
set sic_int.dm_meet_&days_bef_core.(keep=bid_hrs_19 core_year PDGNS_CD DGNS_CD1-DGNS_CD12 );
array dx PDGNS_CD DGNS_CD1-DGNS_CD12 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=dm_last_&range2._dx out=dm_last_&range2._dx2 nodupkey;
by bid_hrs_19 core_year diag;
run;

/*Process hh medicare claims to pull out dx codes
Dataset being created: dm_last_&range2._dx2*/
data hh_last_&range2._dx(keep=bid_hrs_19 core_year diag);
set sic_int.hh_meet_&days_bef_core.(keep=bid_hrs_19 core_year PDGNS_CD DGNSCD01-DGNSCD25 );
array dx PDGNS_CD DGNSCD01-DGNSCD25 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=hh_last_&range2._dx out=hh_last_&range2._dx2 nodupkey;
by bid_hrs_19 core_year diag;
run;

/*Process hs medicare claims to pull out dx codes
Dataset being created: dm_last_&range2._dx2*/
data hs_last_&range2._dx(keep=bid_hrs_19 core_year diag);
set sic_int.hs_meet_&days_bef_core.(keep=bid_hrs_19 core_year PDGNS_CD DGNSCD01-DGNSCD25 );
array dx PDGNS_CD DGNSCD01-DGNSCD25 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=hs_last_&range2._dx out=hs_last_&range2._dx2 nodupkey;
by bid_hrs_19 core_year diag;
run;


/*set diag variable length = 7 chars since that's the max length from the mc claims
Need to do this because length varies across the different mc claim types*/
data hs_last_&range2._dx3;
length diag $7;
set hs_last_&range2._dx2;
run;
data hh_last_&range2._dx3;
length diag $7;
set hh_last_&range2._dx2;
run;
data mp_last_&range2._dx3;
length diag $7;
set mp_last_&range2._dx2;
run;
data dm_last_&range2._dx3;
length diag $7;
set dm_last_&range2._dx2;
run;
data op_last_&range2._dx3;
length diag $7;
set op_last_&range2._dx2;
run;
data pb_last_&range2._dx3;
length diag $7;
set pb_last_&range2._dx2;
run;


/*merge diagnoses from each claim type into single dataset*/
data dx_all_last_&range2.;
set hs_last_&range2._dx3
hh_last_&range2._dx3
mp_last_&range2._dx3
dm_last_&range2._dx3
op_last_&range2._dx3
pb_last_&range2._dx3;
run;
proc sort data=dx_all_last_&range2.(where=(diag~="")) out=sic_int.dx_&range1._&range2 nodupkey;
by bid_hrs_19 core_year diag;
run;

%mend;

/*1 and 2 years pre-interview: sic_int.dx_0_1yr, sic_int.dx_0_2yr */
%dx_time_range(range1=0, range2=1yr, days_bef_core=365);
%dx_time_range(range1=0, range2=2yr, days_bef_core=730);

data zzzdx_test;
set sic_int.dx_0_1yr;
core_year_c=put(core_year,z4.);
run;

/*31794 of the 32718 w/ ffs mc interviews have at least 1 dx code 1 year preceeding the interview*/
proc sql;
select count (distinct bid_hrs_19||core_year_c) from zzzdx_test;
quit;

/*check for frequency of DX codes by bid,core year
Need to use datasets in work folder before removing duplicates*/
data dx_all_last_1yr_w_dups;
set hs_last_1yr_dx
hh_last_1yr_dx
mp_last_1yr_dx
dm_last_1yr_dx
op_last_1yr_dx
pb_last_1yr_dx;
if diag~='.';
run;

proc sort data=dx_all_last_1yr_w_dups;
by bid_hrs_19 core_year diag;
run;

proc sql;
create table zzzdx_freq as select distinct BID_hrs_19,core_year,diag, 
count(*) as n_dx_freq label="count times icd9 dx coded, 12m pre-core"
 from dx_all_last_1yr_w_dups group by BID_hrs_19,core_year,diag;
quit;

proc freq;
table n_dx_freq ;
run;

proc sort data=zzzdx_freq ;
by n_dx_freq;
run;

data zzzdx_chf;
set zzzdx_freq ;
if substr(diag,1,3)='428';
run;

/*****************************************/
/*check dementia diagnosis frequencies, need to pull this into main dataset
dx list is from Elixhauser code*/
data dem_dx_freq;
set dx_all_last_1yr_w_dups;
	dementia=0;
	if (substr(diag,1,4) in ('3310','3311','3312','2900','2901',
             '2902','2903','2912','2948','2949') or
		substr(diag,1,5) in ('29410','29411','29040','29041','29042','29043')) 
		and dementia=0 
          then dementia=1;
run;

proc freq; table dementia; run;

/*this is merged into the main dataset when the elixhauser indicator variables 
in the next section*/
proc sql;
create table sic_int.dem_dx_freq_2 as select distinct BID_hrs_19,core_year,
sum(dementia) as dem_dx_1yr label="count dementia dx 1yr pre core ivw"
 from dem_dx_freq group by BID_hrs_19,core_year;
quit;

proc freq; table dem_dx_1yr; run;


H="Step 3 - Elixhauser comorbidities"
/*proc printto new log='&logdir.\sas_5_sic_elix_log.log'
	print='&logdir.\sas_5_sic_elix_out.lst' 
run;*/

/****************************************************************************/
/* Rename variables macro                                                   */
/****************************************************************************/

%macro rename(lib,dsn,pre);
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "Before Renaming All Variables";
run;
proc sql noprint;
select nvar into :num_vars
from dictionary.tables
where libname="&LIB" and
memname="&DSN";
select distinct(name) into :var1-
:var%TRIM(%LEFT(&num_vars))
from dictionary.columns
where libname="&LIB" and
memname="&DSN";
quit;
run;
proc datasets library=&LIB;
modify &DSN;
rename
%do i=1 %to &num_vars;
&&var&i=&&var&i.._&pre 
%end;
;
quit;
run;
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "After Renaming All Variables";
run;
%mend rename;




/****************************************************************************/
/* Elixhauser comorbidities macro                                           */
/****************************************************************************/
/*Note elixhauser comorbidities diagnosis lists are modified for the 
purposes of this project, do not copy and paste this Elixhauser code 
for use in other projects!!*/

%macro elixhauser(range1=, range2=);

data dx_31_comor;
set sic_int.dx_&range1._&range2(rename=(diag=dx_0));
dx=trim(left(dx_0));

if dx~="" then do;

comorbi_1=0;
comorbi_2=0;
comorbi_3=0;
comorbi_4=0;
comorbi_5=0;
comorbi_6=0;
comorbi_7=0;
comorbi_8=0;
comorbi_9=0;
comorbi_10=0;
comorbi_11=0;
comorbi_12=0;
comorbi_13=0;
comorbi_14=0;
comorbi_15=0;
comorbi_16=0;
comorbi_17=0;
comorbi_18=0;
comorbi_19=0;
comorbi_20=0;
comorbi_21=0;
comorbi_22=0;
comorbi_23=0;
comorbi_24=0;
comorbi_25=0;
comorbi_26=0;
comorbi_27=0;
comorbi_28=0;
comorbi_29=0;
comorbi_30=0;
*end of intialize of 30 binary variables;
*add dementia and CAD and ALS;
dementia=0;
cad=0;
als=0;
renal_dis=0;

*do over dx;
	*Congestive Heart Failure;
	if (substr(dx,1,5)='39891' or
		substr(dx,1,5)='40211' or
		substr(dx,1,5)='40291' or
		substr(dx,1,5)='40411' or
		substr(dx,1,5)='40413' or
		substr(dx,1,5)='40491' or
		substr(dx,1,5)='40493' or
		substr(dx,1,3)='428') 
		and comorbi_1=0 
		then comorbi_1=1;*add one binary variables here.;
	*Cariac Arrhythmias;
	if (substr(dx,1,5)='42610' or
		substr(dx,1,5)='42611' or
		substr(dx,1,5)='42613' or
		substr(dx,1,4)='4262' or
		substr(dx,1,4)='4263' or
		substr(dx,1,4)='4264' or
		substr(dx,1,5)='42650' or
		substr(dx,1,5)='42651' or
		substr(dx,1,5)='42652' or
		substr(dx,1,5)='42653' or
		substr(dx,1,4)='4266' or
		substr(dx,1,4)='4267' or
		substr(dx,1,4)='4268' or
		substr(dx,1,4)='4270' or
		substr(dx,1,4)='4272' or
		substr(dx,1,5)='42731' or
		substr(dx,1,5)='42760' or
		substr(dx,1,4)='4279' or
		substr(dx,1,4)='7850' or
		substr(dx,1,4)='V450' or
		substr(dx,1,4)='V533')
			and comorbi_2=0 
		then comorbi_2=1;
	* Valvular Disease ;
	if (substr(dx,1,5)='09320' or
		substr(dx,1,5)='09321' or
		substr(dx,1,5)='09322' or
		substr(dx,1,5)='09323' or
		substr(dx,1,5)='09324' or
		substr(dx,1,3)='394' or
		substr(dx,1,3)='395' or
		substr(dx,1,3)='396' or
		substr(dx,1,4)='3970' or
		substr(dx,1,4)='3971' or
		substr(dx,1,4)='4240' or
		substr(dx,1,4)='4241' or
		substr(dx,1,4)='4242' or
		substr(dx,1,4)='4243' or
		substr(dx,1,4)='4244' or
		substr(dx,1,4)='4245' or
		substr(dx,1,4)='4246' or
		substr(dx,1,4)='4247' or
		substr(dx,1,4)='4248' or
		substr(dx,1,5)='42490' or
		substr(dx,1,5)='42491' or
		substr(dx,1,4)='7463' or
		substr(dx,1,4)='7464' or
		substr(dx,1,4)='7465' or
		substr(dx,1,4)='7466' or
		substr(dx,1,4)='V422' or
		substr(dx,1,5)='V433')
			and comorbi_3=0 
		then comorbi_3=1;
	*Pulmonary Circulation Disorders;
	if (substr(dx,1,3)='416' or
		substr(dx,1,4)='4179')
			and comorbi_4=0 
		then comorbi_4=1;
	*Peripheral Vascular Disorders;
	if (substr(dx,1,3)='440' or
		substr(dx,1,4)='4412' or
		substr(dx,1,4)='4414' or
		substr(dx,1,4)='4417' or
		substr(dx,1,4)='4419' or
		substr(dx,1,4)='4431' or
		substr(dx,1,4)='4432' or
		substr(dx,1,4)='4438' or
		substr(dx,1,4)='4439' or
		substr(dx,1,4)='4471' or
		substr(dx,1,4)='5571' or
		substr(dx,1,4)='5579' or
		substr(dx,1,4)='V434')
			and comorbi_5=0 
		then comorbi_5=1;
	*Hypertension;
	if ((substr(dx,1,4)='4011' or
		substr(dx,1,4)='4019')) or
	   ((substr(dx,1,5)='40210' or
		substr(dx,1,5)='40290' or
		substr(dx,1,5)='40410' or
		substr(dx,1,5)='40490' or
		substr(dx,1,5)='40511' or
		substr(dx,1,5)='40519' or
		substr(dx,1,5)='40591' or
		substr(dx,1,5)='40599')) 
			and comorbi_6=0 
		then comorbi_6=1;
	*Paralysis;	
	if (substr(dx,1,4)='3420' or
		substr(dx,1,5)='34210' or
		substr(dx,1,5)='34211' or
		substr(dx,1,5)='34212' or
		substr(dx,1,4)='3429' or
		substr(dx,1,3)='343' or
		substr(dx,1,3)='344')
			and comorbi_7=0 
		then comorbi_7=1;
	*Other Neurological Disorders;
	if (substr(dx,1,4)='3319' or
		substr(dx,1,4)='3320' or
		substr(dx,1,4)='3334' or
		substr(dx,1,4)='3335' or
		substr(dx,1,3)='334' or
		substr(dx,1,3)='335' or
		substr(dx,1,3)='340' or
		substr(dx,1,4)='3411' or
		substr(dx,1,4)='3418' or
		substr(dx,1,4)='3419' or
		substr(dx,1,5)='34500' or
		substr(dx,1,5)='34501' or
		substr(dx,1,5)='34510' or
		substr(dx,1,5)='34511' or
		substr(dx,1,4)='3454' or
		substr(dx,1,5)='34550' or
		substr(dx,1,5)='34551' or
		substr(dx,1,4)='3458' or
		substr(dx,1,5)='34590' or
		substr(dx,1,5)='34591' or
		substr(dx,1,4)='3481' or
		substr(dx,1,4)='3483' or
		substr(dx,1,4)='7803' or
		substr(dx,1,4)='7843') 
			and comorbi_8=0 
		then comorbi_8=1;	
	*Chronic Pulmonary Disease;
	if (substr(dx,1,3)='490' or
		substr(dx,1,3)='491' or
		substr(dx,1,3)='492' or
		substr(dx,1,4)='4930' or
		substr(dx,1,4)='4931' or
		substr(dx,1,4)='4932' or
		substr(dx,1,4)='4938' or
		substr(dx,1,5)='49390' or
		substr(dx,1,5)='49391' or
		substr(dx,1,3)='494' or
		substr(dx,1,3)='495' or
		substr(dx,1,3)='496' or
		substr(dx,1,3)='497' or
		substr(dx,1,3)='498' or
		substr(dx,1,3)='499' or
		substr(dx,1,3)='500' or
		substr(dx,1,3)='501' or
		substr(dx,1,3)='502' or
		substr(dx,1,3)='503' or
		substr(dx,1,3)='504' or
		substr(dx,1,3)='505' or
		substr(dx,1,4)='5064') 
			and comorbi_9=0 
		then comorbi_9=1;	
	*Diabetes, uncomplicated;
	if (substr(dx,1,4)='2500' or
		substr(dx,1,4)='2501' or
		substr(dx,1,4)='2502' or
		substr(dx,1,4)='2503') 
			and comorbi_10=0 
		then comorbi_10=1;
	*Diabetes, complicated;
	if (substr(dx,1,4)='2504' or
		substr(dx,1,4)='2505' or
		substr(dx,1,4)='2506' or
		substr(dx,1,4)='2507' or
		substr(dx,1,4)='2509') 
			and comorbi_11=0 
		then comorbi_11=1;
	*Hypothyroidism;
	if (substr(dx,1,3)='243' or
		substr(dx,1,4)='2440' or
		substr(dx,1,4)='2441' or
		substr(dx,1,4)='2442' or
		substr(dx,1,4)='2448' or
		substr(dx,1,4)='2449') 	
			and comorbi_12=0 
		then comorbi_12=1;
	*Renal Failure;
	*Original list modified to drop 2 codes  585 and V568;
	if (substr(dx,1,5)='40311' or
		substr(dx,1,5)='40391' or
		substr(dx,1,5)='40412' or
		substr(dx,1,5)='40492' or
		substr(dx,1,3)='586' or
		substr(dx,1,4)='V420' or
		substr(dx,1,4)='V451' or
		substr(dx,1,4)='V560') 
			and comorbi_13=0 
		then comorbi_13=1;
	*Advanced Liver Disease or Cirrhosis;
	*Code list modified from orig Elix;
	*572.4 hepatorenal syndrome must be added; 
	*Remove '07032' or – chronic hep B, '07033' or – chronic hep B, '07054' or – chronic hep C, '5713' or – alcoholic liver damage, '5714' or – chronic hepatitis;
	if (substr(dx,1,4)='4560' or
		substr(dx,1,4)='4561' or
		substr(dx,1,5)='45620' or
		substr(dx,1,5)='45621' or
		substr(dx,1,4)='5710' or
		substr(dx,1,4)='5712' or
		substr(dx,1,4)='5715' or
		substr(dx,1,4)='5716' or
		substr(dx,1,4)='5718' or
		substr(dx,1,4)='5719' or
		substr(dx,1,4)='5723' or
		substr(dx,1,4)='5724' or
		substr(dx,1,4)='5728' or
		substr(dx,1,4)='V427') 
			and comorbi_14=0 
		then comorbi_14=1;
	*Peptic Ulcer Disease excluding bleeding;
	if (substr(dx,1,5)='53170' or
		substr(dx,1,5)='53190' or
		substr(dx,1,5)='53270' or
		substr(dx,1,5)='53290' or
		substr(dx,1,5)='53370' or
		substr(dx,1,5)='53390' or
		substr(dx,1,5)='53470' or
		substr(dx,1,5)='53490' or
		substr(dx,1,5)='V1271') 
			and comorbi_15=0 
		then comorbi_15=1;
	*AIDS;
	if (substr(dx,1,3)='042' or
		substr(dx,1,3)='043' or
		substr(dx,1,3)='044') 
			and comorbi_16=0 
		then comorbi_16=1;
	*Lymphoma;
	if (substr(dx,1,3)='200' or
		substr(dx,1,4)='201' or
		substr(dx,1,4)='2020' or
		substr(dx,1,4)='2021' or
		substr(dx,1,4)='2022' or
		substr(dx,1,4)='2023' or
		substr(dx,1,4)='2025' or
		substr(dx,1,4)='2026' or
		substr(dx,1,4)='2027' or
		substr(dx,1,4)='2028' or
		substr(dx,1,4)='2029' or
		substr(dx,1,4)='2030' or
		substr(dx,1,4)='2038' or
		substr(dx,1,4)='2386' or
		substr(dx,1,4)='2733' or
		substr(dx,1,5)='V1071' or
		substr(dx,1,5)='V1072' or
		substr(dx,1,5)='V1079')
			and comorbi_17=0 
		then comorbi_17=1;
	*Metastatic Cancer or Hematologic Cancer;
	*Modified to add lukemias;
	if (substr(dx,1,3)='196' or
		substr(dx,1,3)='197' or
		substr(dx,1,3)='198' or
		substr(dx,1,3)='199' or
		substr(dx,1,3)='204' or
		substr(dx,1,3)='205' or
		substr(dx,1,3)='206' or
		substr(dx,1,3)='207' or
		substr(dx,1,3)='208') 
			and comorbi_18=0 
		then comorbi_18=1;	
	*Solid Tumor without Metastisis;
	if (substr(dx,1,2)='14' or
		substr(dx,1,2)='15' or
		substr(dx,1,2)='16' or
		substr(dx,1,3)='170' or
		substr(dx,1,3)='171' or
		substr(dx,1,3)='172' or
		substr(dx,1,3)='174' or
		substr(dx,1,3)='175' or
		substr(dx,1,3)='179' or
		substr(dx,1,2)='18' or
		substr(dx,1,3)='190' or
		substr(dx,1,3)='191' or
		substr(dx,1,3)='192' or
		substr(dx,1,3)='193' or
		substr(dx,1,3)='194' or
		substr(dx,1,3)='195' or
		substr(dx,1,3)='V10')
			and comorbi_19=0 
		then comorbi_19=1;
	*Rheumatoid Arthritis/Collagen Vascular Diseases;
	if (substr(dx,1,4)='7010' or
		substr(dx,1,3)='710' or
		substr(dx,1,3)='714' or
		substr(dx,1,3)='720' or
		substr(dx,1,3)='725') 
			and comorbi_20=0 
		then comorbi_20=1;
	*Coagulopathy;
	if (substr(dx,1,3)='286' or
		substr(dx,1,4)='2871' or
		substr(dx,1,4)='2873' or
		substr(dx,1,4)='2874' or
		substr(dx,1,4)='2875') 
			and comorbi_21=0 
		then comorbi_21=1;
	*Obesity;
	if (substr(dx,1,4)='2780')  
			and comorbi_22=0 
		then comorbi_22=1;
	*Weight Loss;
	if (substr(dx,1,3)='260' or
		substr(dx,1,3)='261' or
		substr(dx,1,3)='262' or
		substr(dx,1,3)='263') 
			and comorbi_23=0 
		then comorbi_23=1;	
	*Fluid and Electrolyte Disorders;
	if (substr(dx,1,3)='276') 
			and comorbi_24=0 
		then comorbi_24=1;
	*Blood Loss Anemia;
	if (substr(dx,1,4)='2800') 
			and comorbi_25=0 
		then comorbi_25=1;
	*Deficiency Anemias;
	if (substr(dx,1,4)='2801' or
		substr(dx,1,4)='2808' or
		substr(dx,1,4)='2809' or
		substr(dx,1,4)='2859') 
			and comorbi_26=0 
		then comorbi_26=1;
	*Alcohol Abuse;
	if (substr(dx,1,4)='2911' or
		substr(dx,1,4)='2912' or
		substr(dx,1,4)='2915' or
		substr(dx,1,4)='2918' or
		substr(dx,1,4)='2919' or
		substr(dx,1,4)='3039' or
		substr(dx,1,4)='3050' or
		substr(dx,1,4)='V113') 
			and comorbi_27=0 
		then comorbi_27=1;
	*Drug Abuse;
	if (substr(dx,1,4)='2920' or
		substr(dx,1,5)='29282' or
		substr(dx,1,5)='29283' or
		substr(dx,1,5)='29284' or
		substr(dx,1,5)='29289' or
		substr(dx,1,4)='2929' or
		substr(dx,1,3)='304' or
		substr(dx,1,4)='3052' or
		substr(dx,1,4)='3053' or
		substr(dx,1,4)='3054' or
		substr(dx,1,4)='3055' or
		substr(dx,1,4)='3056' or
		substr(dx,1,4)='3057' or
		substr(dx,1,4)='3058' or
		substr(dx,1,4)='3059')
			and comorbi_28=0 
		then comorbi_28=1;	
	*Psychoses;
	if (substr(dx,1,3)='295' or
		substr(dx,1,3)='296' or
		substr(dx,1,3)='297' or
		substr(dx,1,3)='298' or
		substr(dx,1,4)='2991') 
			and comorbi_29=0 
		then comorbi_29=1;
	*Depression;
	if (substr(dx,1,4)='3004' or
		substr(dx,1,5)='30112' or
		substr(dx,1,4)='3090' or
		substr(dx,1,4)='3091' or
		substr(dx,1,3)='311')
			and comorbi_30=0 
		then comorbi_30=1;

	*Dementia;
	if (substr(dx,1,4) in ('3310','3311','3312','2900','2901',
             '2902','2903','2912','2948','2949') or
		substr(dx,1,5) in ('29410','29411','29040','29041','29042','29043')) 
		and dementia=0 
          then dementia=1;

	*CAD coronary artery disease;
	if (substr(dx,1,4) in ('4140','4142','4143','4148','4149') or 
		substr(dx,1,3) in ('410','411','412','413') or
		substr(dx,1,5) in ('V4581','V4582'))
		and cad=0 
          then cad=1;

	*ALS Amyotrophic lateral sclerosis;
	if (substr(dx,1,5)='33520') and als=0 
		then als=1;

*Renal Disease, new variable;
	*To identify diabetese with complications;
	if (substr(dx,1,5)='40311' or
		substr(dx,1,5)='40391' or
		substr(dx,1,5)='40412' or
		substr(dx,1,5)='40492' or
		substr(dx,1,3)='585' or
		substr(dx,1,3)='586' or
		substr(dx,1,4)='V420' or
		substr(dx,1,4)='V451' or
		substr(dx,1,4)='V560' or
		substr(dx,1,4)='V568') 
			and renal_dis=0 
		then renal_dis=1;

end;

run;

/*get count of each comorbidity for each id-core year combination*/
proc sql;
create table com_test1 as
select distinct BID_hrs_19,core_year,
sum(comorbi_1) as com_1,
sum(comorbi_2) as com_2,
sum(comorbi_3) as com_3,
sum(comorbi_4) as com_4,
sum(comorbi_5) as com_5,
sum(comorbi_6) as com_6,
sum(comorbi_7) as com_7,
sum(comorbi_8) as com_8,
sum(comorbi_9) as com_9,
sum(comorbi_10) as com_10,
sum(comorbi_11) as com_11,
sum(comorbi_12) as com_12,
sum(comorbi_13) as com_13,
sum(comorbi_14) as com_14,
sum(comorbi_15) as com_15,
sum(comorbi_16) as com_16,
sum(comorbi_17) as com_17,
sum(comorbi_18) as com_18,
sum(comorbi_19) as com_19,
sum(comorbi_20) as com_20,
sum(comorbi_21) as com_21,
sum(comorbi_22) as com_22,
sum(comorbi_23) as com_23,
sum(comorbi_24) as com_24,
sum(comorbi_25) as com_25,
sum(comorbi_26) as com_26,
sum(comorbi_27) as com_27,
sum(comorbi_28) as com_28,
sum(comorbi_29) as com_29,
sum(comorbi_30) as com_30,
sum(dementia) as dementia,
sum(cad) as cad,
sum(als) as als,
sum(renal_dis) as renal_dis
from dx_31_comor
group by BID_hrs_19,core_year;
quit;

/*convert counts of diagnoses for each comorbidity to indicator variables*/ 
data comorbidity_1(keep=BID_hrs_19 core_year comorb_1-comorb_34 comorb_all);
set com_test1;
array list_com com_1-com_30 dementia cad als renal_dis;
array list_com_bin comorb_1-comorb_34 ;

do over list_com;
  list_com_bin=0;

  if list_com>0 then do;
    list_com_bin=1;
   end;

end;
/*note this comorb_all count does not include CAD or ALS or Renal disease*/
comorb_all=comorb_1+comorb_2+comorb_3+comorb_4+comorb_5+comorb_6+comorb_7+comorb_8+comorb_9+comorb_10
+comorb_11+comorb_12+comorb_13+comorb_14+comorb_15+comorb_16+comorb_17+comorb_18+comorb_19+comorb_20
+comorb_21+comorb_22+comorb_23+comorb_24+comorb_25+comorb_26+comorb_27+comorb_28+comorb_29+comorb_30
+comorb_31;

run;

/*merge in to list of core ivw dates for those with ffs mc, age=65+ */
proc sort data=comorbidity_1 nodupkey;
by BID_hrs_19 core_year;
run;

proc sort data=sic_int.core_xwalk_ins_ffs_only out=core_xwalk_ins_ffs_only nodupkey;
by BID_hrs core_year;
run;

proc sql;
create table core_xwalk_elix_1(drop=BID_hrs_19 core_year2) as
select a.*,b.*
from core_xwalk_ins_ffs_only(drop=age_ge_65 c_ivw_date c_ivw_year hmo_d_12m part_ab_12m) a 
left join
comorbidity_1(rename=(core_year=core_year2)) b
on trim(left(a.BID_hrs))=trim(left(b.BID_hrs_19)) and a.core_year=b.core_year2;
quit;

data sic_int.elix_&range1._&range2;
set core_xwalk_elix_1 ;

label comorb_1 ="Congestive Heart Failure";
label comorb_2 ="Cardiac Arrhythmias";
label comorb_3 ="Valvular Disease";
label comorb_4 ="Pulmonary Circulation Disorders";
label comorb_5 ="Peripheral Vascular Disorders";
label comorb_6 ="Hypertension";
label comorb_7 ="Paralysis";
label comorb_8 ="Other Neurological Disorders";
label comorb_9 ="Chronic Pulmonary Disease";
label comorb_10 ="Diabetes, uncomplicated";
label comorb_11 ="Diabetes, complicated";
label comorb_12 ="Hypothyroidism";
label comorb_13 ="Renal Failure";
label comorb_14 ="Advanced Liver Disease or Cirrhosis";
label comorb_15 ="Peptic Ulcer Disease excluding bleeding";
label comorb_16 ="AIDS";
label comorb_17 ="Lymphoma";
label comorb_18 ="Metastatic or Hematologic Cancer";
label comorb_19 ="Solid Tumor without Metastisis";
label comorb_20 ="Rheumatoid Arthritis/Collagen Vascular Diseases";
label comorb_21 ="Coagulopathy";
label comorb_22 ="Obesity";
label comorb_23 ="Weight Loss";
label comorb_24 ="Fluid and Electrolyte Disorders";
label comorb_25 ="Blood Loss Anemia";
label comorb_26 ="Deficiency Anemias";
label comorb_27 ="Alcohol Abuse";
label comorb_28 ="Drug Abuse";
label comorb_29 ="Psychoses";
label comorb_30 ="Depression";
label comorb_31 ="Dementia";
label comorb_32 ="CAD";
label comorb_33 ="ALS";
label comorb_34 ="Renal Disease";
label comorb_all ="Count of Elix comorbidities";
run;

data test;
set sic_int.elix_&range1._&range2;
run;

%rename(WORK,TEST,&range1._&range2);

data sic_int.elix_&range1._&range2._2(rename =(bid_hrs_&range1._&range2=bid_hrs
core_year_&range1._&range2=core_year));
set test;
keep bid_hrs_&range1._&range2 comorb: core_year:;
run;
proc sort data=sic_int.elix_&range1._&range2._2;
by bid_hrs core_year;
run;

%mend;

/*Run for 1 year, 2 year datasets, resulting datasets are sic_int.elix_0_1yr_2, sic_int.elix_0_2yr_2*/
%elixhauser(range1=0, range2=1yr);
%elixhauser(range1=0, range2=2yr);

proc freq data=sic_int.elix_0_1yr_2;
table comorb:;
run;

proc freq data=sic_int.elix_0_2yr_2;
table comorb:;
run;

/****************************************************************************/
/* Macro to merge Elixhauser comorbidities with core full interviews        */
/****************************************************************************/
/*note resulting datasets have all interviews
If ffs mc 1 year prior to interview, then the the elix comorb are left as missing*/
%macro mergeel(range2=);
proc sql;
create table core_ids_elix_&range2(drop=BID_hrs2 core_year2) as select a.*,
b.*
from 
sic_int.core_xwalk_ins /*sic_int.core_xwalk_1*/ a left join
sic_int.elix_0_&range2._2(rename=(BID_hrs=BID_hrs2 core_year=core_year2)) b
on trim(left(a.BID_hrs))=trim(left(b.BID_hrs2)) and a.core_year=b.core_year2;
quit;

/*1328 obs have ffs mc 1 year preceeding interview but no dx during that time
data zzztest;
set sic_int.core_ids_elix_1yr;
if comorb_all_0_1yr=. and part_ab_12m=1 and hmo_d_12m=0 ;
run;*/

data sic_int.core_ids_elix_&range2._2;
set core_ids_elix_&range2;
array list comorb_:;
do over list;
if part_ab_12m=1 and hmo_d_12m=0 and age_ge_65=1 and list=. then list=0;
end;
run;

%mend;

%mergeel(range2=1yr);
%mergeel(range2=2yr);

/*also merge in the 1 year count of dementia diagnoses from the previous section*/
proc sql;
create table core_ids_elix_1yr_dm_dx as select a.*,b.dem_dx_1yr from
sic_int.core_ids_elix_1yr_2 a left join
sic_int.dem_dx_freq_2 b
on a.BID_hrs=b.BID_hrs_19 and a.core_year=b.core_year;
quit;

/*overwrite the previously saved dataset with one with the additional dementia variable added*/
data sic_int.core_ids_elix_1yr_2;
set core_ids_elix_1yr_dm_dx;
run;

proc freq data=sic_int.core_ids_elix_1yr_2;
table comorb:;
run;

proc freq data=sic_int.core_ids_elix_1yr_2;
table dem_dx_1yr*comorb_31_0_1yr;
run;

proc freq data=sic_int.core_ids_elix_2yr_2;
table comorb:;
run;


H="Step 4 - DW chronic conditions"
/*CMS Data Warehouse Chronic Conditions*/
/*proc printto new log='&logdir.\sas_6_sic_cc_log.log'
	print='&logdir.\sas_6_sic_cc_out.lst' 
run;*/

/****************************************************************************/
/*First get the dx list into dot format using Stata*/
/****************************************************************************/

/*export to Stata*/
proc export data=sic_int.dx_0_1yr
outfile="E:\data\serious_ill\int_data\dx_0_1yr.dta" replace;
run;

proc export data=sic_int.dx_0_2yr
outfile="E:\data\serious_ill\int_data\dx_0_2yr.dta" replace;
run;

/****************************************************************************/
/****************************************************************************/
/*SWITCH TO STATA HERE*/
/****************************************************************************/
/****************************************************************************/

clear
set more off
set memory 500m
local datapath E:\data\serious_ill\int_data

use `datapath'\dx_0_1yr.dta,clear

// convert diagnosis codes to string variables, tostring diag,gen(icd9_c)
gen new=ltrim(diag)
icd9 check new,gen(icd9_c)
replace new="" if icd9_c>0 
// convert into dot format (ex 12.1 instead of 121)
icd9 clean new,dots 

replace diag=new
drop icd9_c new

save `datapath'\dx_0_1yr_2.dta,replace

clear all

use `datapath'\dx_0_2yr.dta,clear

// convert diagnosis codes to string variables, tostring diag,gen(icd9_c)
gen new=ltrim(diag)
icd9 check new,gen(icd9_c)
replace new="" if icd9_c>0 
// convert into dot format (ex 12.1 instead of 121)
icd9 clean new,dots 

replace diag=new
drop icd9_c new

save `datapath'\dx_0_2yr_2.dta,replace

/****************************************************************************/
/****************************************************************************/
/*SWITCH TO SAS HERE*/
/****************************************************************************/
/****************************************************************************/

proc import 
datafile="E:\data\serious_ill\int_data\dx_0_1yr_2.dta" 
out=dx_0_1yr_2 replace;
run;

proc import 
datafile="E:\data\serious_ill\int_data\dx_0_2yr_2.dta" 
out=dx_0_2yr_2 replace;
run;

/*bring in excel list of dx codes associated with each chronic condition*/
proc import 
datafile='E:\data\serious_ill\ref_data\chronic_21_condition_icd9.xls'
out=icd9_21_chronic dbms=xls replace;
run;

proc contents data=icd9_21_chronic;
run;

/*creates macro variables of each of the chronic conditions listing of dx codes*/
proc sql;
select icd_9 into :chronic_desc1-:chronic_desc21 from icd9_21_chronic;
quit;
%put &chronic_desc10;
%put &chronic_desc5;

/*******************************************************************/
/*Macro to generate chronic conditions indicators using dx codes   */
/*******************************************************************/

%macro cc(precore=);

data list_&precore._dx;
set dx_0_&precore._2;
array list CC_1_AMI
CC_2_ALZH
CC_3_ALZHDMTA
CC_4_ATRIALFB
CC_5_CATARACT
CC_6_CHRNKIDN
CC_7_COPD
CC_8_CHF
CC_9_DIABETES
CC_10_GLAUCOMA
CC_11_HIPFRAC
CC_12_ISCHMCHT
CC_13_DEPRESSN
CC_14_OSTEOPRS
CC_15_RA_OA
CC_16_STRKETIA
CC_17_CNCRBRST
CC_18_CNCRCLRC
CC_19_CNCRPRST
CC_20_CNCRLUNG
CC_21_CNCREndM;
do over list ;
list=0;
end;

diag_string=diag;

/* for dx codes that begin with numbers, process chronic cond variables*/
if anydigit(substr(trim(left(diag_string)),1,1))=1 then do;
diag=diag_string+0;

if diag in (&chronic_desc1) then CC_1_AMI=1;
if diag in (&chronic_desc2)  then CC_2_ALZH=1;
if diag in (&chronic_desc3)  then CC_3_ALZHDMTA=1;
if diag in (&chronic_desc4) then CC_4_ATRIALFB=1;
if diag in (&chronic_desc5) then CC_5_CATARACT=1;
if diag in (&chronic_desc6) then CC_6_CHRNKIDN=1;
if diag in (&chronic_desc7) then CC_7_COPD=1;
if diag in (&chronic_desc8) then CC_8_CHF=1;
if diag in (&chronic_desc9) then CC_9_DIABETES=1;
if diag in (&chronic_desc10) then CC_10_GLAUCOMA=1;
if diag in (&chronic_desc11) then CC_11_HIPFRAC=1;
if diag in (&chronic_desc12) then CC_12_ISCHMCHT=1;
if diag in (&chronic_desc13) then CC_13_DEPRESSN=1;
if diag in (&chronic_desc14) then CC_14_OSTEOPRS=1;
if diag in (&chronic_desc15) then CC_15_RA_OA=1;
if diag in (&chronic_desc16) then CC_16_STRKETIA=1;
if diag in (&chronic_desc17) then CC_17_CNCRBRST=1;
if diag in (&chronic_desc18) then CC_18_CNCRCLRC=1;
if diag in (&chronic_desc19) then CC_19_CNCRPRST=1;
if diag in (&chronic_desc20) then CC_20_CNCRLUNG=1;
if diag in (&chronic_desc21) then CC_21_CNCREndM=1;
end;

/*Process with dx codes that start with letters
Only two of them in the list*/
if anydigit(substr(trim(left(diag_string)),1,1))=0 then do;
if trim(left(diag_string)) in ("V431") then CC_5_CATARACT=1;
if trim(left(diag_string)) in ("V801") then CC_10_GLAUCOMA=1;
end;

run;


proc sql;
create table bid_dx_0_&precore.(rename=(bid_hrs_19=bid)) as
select distinct bid_hrs_19,core_year,
sum(CC_1_AMI) as CC_1_AMI,
sum(CC_2_ALZH) as CC_2_ALZH,
sum(CC_3_ALZHDMTA) as CC_3_ALZHDMTA,
sum(CC_4_ATRIALFB) as CC_4_ATRIALFB,
sum(CC_5_CATARACT) as CC_5_CATARACT,
sum(CC_6_CHRNKIDN) as CC_6_CHRNKIDN,
sum(CC_7_COPD) as CC_7_COPD,
sum(CC_8_CHF) as CC_8_CHF,
sum(CC_9_DIABETES) as CC_9_DIABETES,
sum(CC_10_GLAUCOMA) as CC_10_GLAUCOMA,
sum(CC_11_HIPFRAC) as CC_11_HIPFRAC,
sum(CC_12_ISCHMCHT) as CC_12_ISCHMCHT,
sum(CC_13_DEPRESSN) as CC_13_DEPRESSN,
sum(CC_14_OSTEOPRS) as CC_14_OSTEOPRS,
sum(CC_15_RA_OA) as CC_15_RA_OA,
sum(CC_16_STRKETIA) as CC_16_STRKETIA,
sum(CC_17_CNCRBRST) as CC_17_CNCRBRST,
sum(CC_18_CNCRCLRC) as CC_18_CNCRCLRC,
sum(CC_19_CNCRPRST) as CC_19_CNCRPRST,
sum(CC_20_CNCRLUNG) as CC_20_CNCRLUNG,
sum(CC_21_CNCREndM) as CC_21_CNCREndM

from list_&precore._dx group by bid_hrs_19,core_year;
quit;

proc sort data=bid_dx_0_&precore. nodupkey;
by bid core_year;
run;

proc sort data=sic_int.core_xwalk_ins_ffs_only out=core_xwalk_ins_ffs_only nodupkey;
by BID_hrs core_year;
run;

/*merge chronic conditions into interview list of bid's with ffs mc, age 65+ */
 proc sql;
 create table bid_dx_0_&precore.2(drop=bid) as select a.bid_hrs,b.*
 from core_xwalk_ins_ffs_only a
 left join
 bid_dx_0_&precore. b 
 on trim(left(a.bid_hrs))=trim(left(b.bid))
and a.core_year=b.core_year;
 quit;

/*convert to chronic condition vars. to binary variables*/
 data bid_dx_0_&precore.3;
 set bid_dx_0_&precore.2;
 array list CC_1_AMI
CC_2_ALZH
CC_3_ALZHDMTA
CC_4_ATRIALFB
CC_5_CATARACT
CC_6_CHRNKIDN
CC_7_COPD
CC_8_CHF
CC_9_DIABETES
CC_10_GLAUCOMA
CC_11_HIPFRAC
CC_12_ISCHMCHT
CC_13_DEPRESSN
CC_14_OSTEOPRS
CC_15_RA_OA
CC_16_STRKETIA
CC_17_CNCRBRST
CC_18_CNCRCLRC
CC_19_CNCRPRST
CC_20_CNCRLUNG
CC_21_CNCREndM
;
do over list ;
if list>0 then list=1;
if list<=0 then list=0;
end;

/*create aggregated indicators*/
CC_AMI_isch=CC_1_AMI|CC_12_ISCHMCHT;
CC_alzheim=CC_2_ALZH|CC_3_ALZHDMTA;
CC_cncr_chronic=CC_17_CNCRBRST | CC_18_CNCRCLRC | CC_19_CNCRPRST | CC_20_CNCRLUNG | 
	CC_21_CNCREndM ;
run;

proc means;
var CC_1_AMI
CC_2_ALZH
CC_3_ALZHDMTA
CC_4_ATRIALFB
CC_5_CATARACT
CC_6_CHRNKIDN
CC_7_COPD
CC_8_CHF
CC_9_DIABETES
CC_10_GLAUCOMA
CC_11_HIPFRAC
CC_12_ISCHMCHT
CC_13_DEPRESSN
CC_14_OSTEOPRS
CC_15_RA_OA
CC_16_STRKETIA
CC_17_CNCRBRST
CC_18_CNCRCLRC
CC_19_CNCRPRST
CC_20_CNCRLUNG
CC_21_CNCREndM;
run;

/*run rename macro*/
data test;
set bid_dx_0_&precore.3;
run;

%rename(WORK,TEST,&precore.);

data sic_int.chronic_21_&precore.3_0;
set test;
bid_hrs=bid_hrs_&precore.;
drop bid_hrs_&precore.;
core_year=core_year_&precore.;
drop core_year_&precore.;
run;

%mend;

/*2 datasets are sic_int.chronic_21_1yr_0 and sic_int.chronic_21_2yr_0*/
%cc(precore=1yr);
%cc(precore=2yr);

proc freq data=sic_int.chronic_21_1yr3_0;
table cc_:;
run;

proc freq data=sic_int.chronic_21_2yr3_0;
table cc_:;
run;

proc contents data=sic_int.chronic_21_1yr3_0;
run;

/****************************************************************************/
/* Merge cc's with interivew, elix dataset                                  */
/****************************************************************************/
%macro mergecc(precore=);

proc sort data=sic_int.core_ids_elix_&precore._2;
by bid_hrs core_year;
run;

proc sort data=sic_int.chronic_21_&precore.3_0;
by bid_hrs core_year;
run;

proc sql;
create table core_ids_elix_cc_&precore.(drop=bid_hrs2 core_year2)
as select * from
sic_int.core_ids_elix_&precore._2 a
left join
sic_int.chronic_21_&precore.3_0(rename=(bid_hrs=bid_hrs2 core_year=core_year2)) b 
on (a.bid_hrs)=(b.bid_hrs2) and a.core_year=b.core_year2;
quit;

/*For observations that have ffs mc 1 year prior to interview
set cc's variables to 0 if missing bc didn't have a dx during that time*/
data sic_int.core_ids_elix_cc_&precore._2;
set core_ids_elix_cc_&precore.;
array list cc_:;
do over list;
if part_ab_12m=1 and hmo_d_12m=0 and age_ge_65=1 and list=. then list=0;
end;
run;

%mend;

%mergecc(precore=1yr);
%mergecc(precore=2yr);

/* the above file contains all interviews, if do not have mc ffs
1 year preceeding interview or age<65 then elixhauser comorbidities 
and cc's are missing

File names are:
sic_int.core_ids_elix_cc_1yr
sic_int.core_ids_elix_cc_2yr*/

proc contents data=sic_int.core_ids_elix_cc_1yr_2;
run;

proc contents data=sic_int.core_ids_elix_cc_2yr_2;
run;

proc freq data=sic_int.core_ids_elix_cc_1yr_2;
table cc_: comorb_all_0_1yr;
run;

proc freq data=sic_int.core_ids_elix_cc_2yr_2;
table cc_:;
run;


H="Step 5 - Get additional utilization information from claims"
/*These additional variables are just added to the dataset with the
elixhauser and cc's 1 year preceeding the interview, can add them
later when required to get the 2 year look-back dataset*/

/*proc printto new log='&logdir.\sas_7_sic_util_log.log'
	print='&logdir.\sas_7_sic_util_out.lst' 
run;*/


/****************************************************************************/
/*Get indicator of any hospital admission 6 and 12 months pre-core interview*/
/****************************************************************************/

%macro admissions(days=,suffix=);

/*pull list of ip claims from all medpar claims x days pre-interview*/
data ip_meet_&days.;
set sic_int.mp_meet3_&days.(where=(trim(left(SSLSSNF))~="N"));
run;

data ip_&days._2;
set ip_meet_&days.;
if icarecnt=. then icarecnt=0; /*medpar intensive care day count*/
if CRNRYDAY=. then CRNRYDAY=0; /*medpar coronary day count*/
icu_days=icarecnt+CRNRYDAY;
em_urgent_admit=0; /*Urgent , emergent admissions from admission type*/
if type_adm in (1,2) then em_urgent_admit=1;
em_admit=0;
if type_adm=1 then em_admit=1;
urgent_admit=0;
if type_adm=2 then urgent_admit=1;
elect_admit=0;
if type_adm=3 then elect_admit=1;
ind_ed_charge=0; /*ED charges as another indicator of ED use*/
if ER_AMT>0 & ER_AMT~=. then ind_ed_charge=1;
if ER_AMT=0 | ER_AMT=. then ind_ed_charge=0;

/*truncate stays where the admit is more than x days before interview
or discharge is after the interview date so can get accurate LOS*/
if c_ivw_date-admit_date>&days. then do;
	admit_date=c_ivw_date-&days.;
	admit_trunc=1;
	end;
if c_ivw_date<disch_date then do;
	disch_date=c_ivw_date;
	disch_trunc=1;	
	end;
adj_los=disch_date-admit_date;
if disch_date-admit_date=0 then adj_los=1;
run;

proc sort data=ip_&days._2;
by BID_hrs_19 core_year;
run;

proc sql;
create table ip_&days._3 as select distinct BID_hrs_19,core_year,
/*total ICU days*/
sum(icu_days) as icu_days_&suffix. label="total icu days &suffix. pre core ivw",
/*count of IP admissions, all types*/
count(*) as n_ip_admit_&suffix. label="total n of hospital admit &suffix. pre core ivw",
/*total Hospital LOS*/
sum(adj_los) as n_hospd_&suffix. label="total hospital days &suffix. pre core ivw",
/*count urgent or emergency admissions*/
count(case when em_urgent_admit=1 then em_urgent_admit else . end) as n_em_urgent_admit_&suffix. 
	label="total n of urgent/emergent hospital admit &suffix. pre core ivw",
/*count of emergency admissions, from admission type code*/
count(case when em_admit=1 then em_admit else . end) as n_em_admit_&suffix. 
	label="total n of emergent hospital admit &suffix. pre core ivw",
/*count of urgent admissions, from admission type code*/
count(case when urgent_admit=1 then urgent_admit else . end) as n_urgent_admit_&suffix. 
	label="total n of urgent hospital admit &suffix. pre core ivw",
/*count of elective admissions, from admission type code*/
count(case when elect_admit=1 then elect_admit else . end) as n_elect_admit_&suffix. 
	label="total n of elective hospital admit &suffix. pre core ivw",
/*count of admissions with any ED charges*/
count(case when ind_ed_charge=1 then ind_ed_charge else . end) as n_ED_ip_&suffix. 
	label="total n of ED visits with subsequent admit &suffix. pre core ivw"

 from ip_&days._2 group by BID_hrs_19,core_year;
quit;

data ip_&days._4;
set ip_&days._3;
if icu_days_&suffix.>n_hospd_&suffix. then icu_days_&suffix.=n_hospd_&suffix.;
run;

%mend;

%admissions(days=183,suffix=6m);
%admissions(days=365,suffix=12m);

data elective_1;
set ip_365_2;
if elect_admit=1;
run;

/*print to file*/
 ods rtf body="E:\data\serious_ill\logs\elective_primary_dxlist.rtf";
 title"Primary dx list for admit type = elective, inpatient claims last 12m pre-core";
proc freq data=elective_1 order=freq; table dgns_cd01;
run;

title"Admission type vs indicator for any ED charges from rev center codes, claims level";
proc freq data=ip_365_2; table ind_ed_charge*type_adm; run;

ods rtf close; 

/*merge the new variables with the list of ivws with ffs mc 1 yr pre and age 65+*/
proc sort data=sic_int.core_xwalk_ins_ffs_only out=core_xwalk_ins_ffs_only nodupkey;
by BID_hrs core_year;
run;

proc sort data=ip_183_3 nodupkey;
by bid_hrs_19 core_year;
run;

proc sql;
create table core_ids_criteria_1a as select a.*,b.icu_days_6m,
b.n_ip_admit_6m,b.n_hospd_6m,b.n_em_urgent_admit_6m,b.n_em_admit_6m,
b.n_urgent_admit_6m,b.n_elect_admit_6m,b.n_ED_ip_6m
from core_xwalk_ins_ffs_only a
left join
ip_183_3 b 
on trim(left(a.bid_hrs))=trim(left(b.bid_hrs_19)) and a.core_year=b.core_year;
quit;

proc sort data=ip_365_3 nodupkey;
by bid_hrs_19 core_year;
run;

proc sql;
create table core_ids_criteria_1 as select a.*,b.icu_days_12m,
b.n_ip_admit_12m,b.n_hospd_12m,b.n_em_urgent_admit_12m,b.n_em_admit_12m,
b.n_urgent_admit_12m,b.n_elect_admit_12m,b.n_ED_ip_12m
from core_ids_criteria_1a a
left join
ip_365_3 b 
on trim(left(a.bid_hrs))=trim(left(b.bid_hrs_19)) and a.core_year=b.core_year;
quit;

/*Dataset just contains obs with ffs mc 1yr and age 65+
So if missing, set var to 0*/
 data core_ids_1yr_criteria ;
 set core_ids_criteria_1 ;
 array list icu_days_6m n_ip_admit_6m n_hospd_6m n_em_urgent_admit_6m 
	n_em_admit_6m n_urgent_admit_6m n_elect_admit_6m n_ED_ip_6m
	icu_days_12m n_ip_admit_12m n_hospd_12m n_em_urgent_admit_12m
	n_em_admit_12m n_urgent_admit_12m n_elect_admit_12m n_ED_ip_12m;
 do over list;
 if list=. then list=0;
 end;

 if n_ip_admit_6m=0 then ind_hosp_adm_6m=0;
 if n_ip_admit_6m>0 & n_ip_admit_6m~=. then ind_hosp_adm_6m=1;
 label ind_hosp_adm_6m="Indicator for any hospital admission 6m pre core";

 if n_em_urgent_admit_6m=0 then ind_em_ur_adm_6m=0;
 if n_em_urgent_admit_6m>0 & n_em_urgent_admit_6m~=. then ind_em_ur_adm_6m=1;
 label ind_em_ur_adm_6m="Ind any urgent or emergent hospital admission 6m pre core";

 if n_em_admit_6m=0 then ind_em_adm_6m=0;
 if n_em_admit_6m>0 & n_em_admit_6m~=. then ind_em_adm_6m=1;
 label ind_em_adm_6m="Ind any emergency hospital admission 6m pre core";

 if n_urgent_admit_6m=0 then ind_ur_adm_6m=0;
 if n_urgent_admit_6m>0 & n_urgent_admit_6m~=. then ind_ur_adm_6m=1;
 label ind_ur_adm_6m="Ind any urgent hospital admission 6m pre core";

 if n_elect_admit_6m =0 then ind_elect_adm_6m=0;
 if n_elect_admit_6m >0 & n_elect_admit_6m ~=. then ind_elect_adm_6m=1;
 label ind_elect_adm_6m="Ind any elective hospital admission 6m pre core";

 if (n_ip_admit_6m - n_elect_admit_6m)=0 then ind_nonelect_adm_6m=0;
 if (n_ip_admit_6m - n_elect_admit_6m)>0 & n_elect_admit_6m~=. then ind_nonelect_adm_6m=1;
 label ind_nonelect_adm_6m="Ind any non-elective hospital admission 6m pre core";

 n_nonelect_adm_6m=(n_ip_admit_6m - n_elect_admit_6m);
 label n_nonelect_adm_6m="total n non-elective ip admit 6m pre core";

 if n_ED_ip_6m=0 then ind_ED_adm_6m=0;
 if n_ED_ip_6m>0 & n_ED_ip_6m~=. then ind_ED_adm_6m=1;
 label ind_ED_adm_6m="Ind ED use with hospital admission 6m pre core, from charges";

 if n_ip_admit_12m=0 then ind_hosp_adm_12m=0;
 if n_ip_admit_12m>0 & n_ip_admit_12m~=. then ind_hosp_adm_12m=1;
 label ind_hosp_adm_12m="Indicator for any hospital admission 12m pre core";

 if n_em_urgent_admit_12m=0 then ind_em_ur_adm_12m=0;
 if n_em_urgent_admit_12m>0 & n_em_urgent_admit_12m~=. then ind_em_ur_adm_12m=1;
 label ind_em_ur_adm_12m="Ind any urgent or emergent hospital admission 12m pre core";

 if n_em_admit_12m=0 then ind_em_adm_12m=0;
 if n_em_admit_12m>0 & n_em_admit_12m~=. then ind_em_adm_12m=1;
 label ind_em_adm_12m="Ind any emergency hospital admission 12m pre core";

 if n_urgent_admit_12m=0 then ind_ur_adm_12m=0;
 if n_urgent_admit_12m>0 & n_urgent_admit_12m~=. then ind_ur_adm_12m=1;
 label ind_ur_adm_12m="Ind any urgent hospital admission 12m pre core";

 if n_elect_admit_12m =0 then ind_elect_adm_12m=0;
 if n_elect_admit_12m >0 & n_elect_admit_12m ~=. then ind_elect_adm_12m=1;
 label ind_elect_adm_12m="Ind any elective hospital admission 12m pre core";

 if (n_ip_admit_12m - n_elect_admit_12m)=0 then ind_nonelect_adm_12m=0;
 if (n_ip_admit_12m - n_elect_admit_12m)>0 & n_elect_admit_12m~=. then ind_nonelect_adm_12m=1;
 label ind_nonelect_adm_12m="Ind any non-elective hospital admission 12m pre core";

 n_nonelect_adm_12m=(n_ip_admit_12m - n_elect_admit_12m);
 label n_nonelect_adm_12m="total n non-elective ip admit 12m pre core";

 if n_ED_ip_12m=0 then ind_ED_adm_12m=0;
 if n_ED_ip_12m>0 & n_ED_ip_12m~=. then ind_ED_adm_12m=1;
 label ind_ED_adm_12m="Ind ED use with hospital admission 12m pre core, from charges";

run;

 proc freq;
 table icu_days_6m n_ip_admit_6m n_hospd_6m ind_hosp_adm_6m n_em_urgent_admit_6m ind_em_ur_adm_6m 
	ind_em_adm_6m ind_ur_adm_6m ind_nonelect_adm_6m n_nonelect_adm_6m n_ED_ip_6m ind_ED_adm_6m 
	ind_em_adm_6m*ind_ED_adm_6m /missprint;
 run;

proc freq;
table icu_days_12m n_ip_admit_12m n_hospd_12m ind_hosp_adm_12m n_em_urgent_admit_12m ind_em_ur_adm_12m
	ind_em_adm_12m ind_ur_adm_12m ind_nonelect_adm_12m n_nonelect_adm_12m n_ED_ip_12m ind_ED_adm_12m 
	ind_em_adm_12m*ind_ED_adm_12m /missprint;
run;

/****************************************************************************/
/****************************************************************************/
/*Get SNF days, indicator for 12 months preceding the interview*/
/****************************************************************************/
/****************************************************************************/

/*pull list of snf claims from all medpar claims 12 months pre-interview*/
data snf_meet_365;
set sic_int.mp_meet3_365(where=(trim(left(SSLSSNF))="N"));
run;

proc sort data=snf_meet_365;
by bid_hrs_19 admit_date;
run;

data snf_meet_365_1a;
set snf_meet_365;
format admit_date date9. disch_date date9.;
run;

/*3 claim windows are present:
1. SNF stays fully within the 1 year before interview
2. Stays that begin before 1 year pre-core but end within 1 year pre-core
3. Stays that begin within 1 year of core but end after core ivw
4. Stays that begin before 1 year and end after interview, LOS=365!
Get claims that meet 1 *1797*/
proc sql;
create table snf_meet1_pre_365 as select *
from snf_meet_365_1a
where (c_ivw_date - admit_date)<365 & (c_ivw_date - disch_date)>=0; 
quit;


/*meet time window 2 *152*/
proc sql;
create table snf_meet2_pre_365 as select *
from snf_meet_365_1a
where (c_ivw_date - admit_date)>=365 & (c_ivw_date - disch_date)>=0; 
quit;

/*For these claims that start > 1 year before core, truncate start date so 
only count LOS days w/i 1 year
create indicator variable that claim start date is truncated*/
data snf_meet2_pre_365_1;
set snf_meet2_pre_365;
admit_date = c_ivw_date-365;
snf_admit_date_mod = 1;
label snf_admit_date_mod = "Admit date mod; at 12 mo from ivw date";
run;

proc freq;
table snf_admit_date_mod ;
run;

/*meet time window 3 *135 */
proc sql;
create table snf_meet3_pre_365 as select *
from snf_meet_365_1a
where (c_ivw_date - admit_date)<365 & (c_ivw_date-disch_date)<0; 
quit;

/*For these claims that end after core, truncate end date so 
only count LOS days 1 year before the core
create indicator variable that claim end date is truncated*/
data snf_meet3_pre_365_1;
set snf_meet3_pre_365;
disch_date = c_ivw_date;
snf_disch_date_mod = 1;
label snf_disch_date_mod = "Disch date mod; at ivw date";
run;

proc freq;
table snf_disch_date_mod ;
run;

/*meet 4 , overlap both start and end dates n=7*/
proc sql;
create table snf_meet4_pre_365 as select *
from snf_meet_365_1a
where (c_ivw_date - admit_date)>=365 & (c_ivw_date - disch_date)<0; 
quit;

/*truncate both start and end dates so just count 1 year pre interview*/
data snf_meet4_pre_365_1;
set snf_meet4_pre_365;
disch_date = c_ivw_date;
snf_disch_date_mod = 1;
label snf_disch_date_mod = "Disch date mod; at ivw date";
admit_date = c_ivw_date-365;
snf_admit_date_mod = 1;
label snf_admit_date_mod = "Admit date mod; at 12 mo from ivw date";
run;

proc freq;
table snf_disch_date_mod snf_admit_date_mod;
run;


data snf_meet_pre_365;
set snf_meet1_pre_365 snf_meet2_pre_365_1 snf_meet3_pre_365_1 snf_meet4_pre_365_1;
run;

proc freq;
table snf_admit_date_mod snf_disch_date_mod ;
run;

/*save final files to project int_data directory*/
data sic_int.snf_meet_pre_365 ;
set  snf_meet_pre_365;
run;

/*************************************************************/
/*calculate total number of days spent in SNF by BID*/
/*************************************************************/

data pre_snf_days_1;
set sic_int.snf_meet_pre_365;
calc_snf_LOS=disch_date-admit_date;
if calc_snf_LOS=0 then calc_snf_LOS=1;
run;

proc sort data=pre_snf_days_1;
by bid_hrs_19 c_ivw_date admit_date;
run;

proc sql;
create table snf_days_pre as select distinct bid_hrs_19,core_year,
sum(calc_snf_LOS)
	as n_snf_days_12m
	from pre_snf_days_1 group by bid_hrs_19,core_year;
quit;

proc freq;
table n_snf_days_12m;
run;

/*merge into full ffs 1yr, age 65+ dataset*/
proc sort data=snf_days_pre nodupkey;
by bid_hrs_19 core_year;
run;

proc sql;
create table core_ids_criteria_2a as select a.*,b.n_snf_days_12m
from core_ids_1yr_criteria a
left join
snf_days_pre b 
on trim(left(a.bid_hrs))=trim(left(b.bid_hrs_19)) and a.core_year=b.core_year;
quit;

 data core_ids_1yr_criteria_2 ;
 set core_ids_criteria_2a ;
 array list n_snf_days_12m;
 do over list;
 if list=. then list=0;
 end; 

if n_snf_days_12m=0 then ind_snf_use_12m=0;
 if n_snf_days_12m>0 & n_snf_days_12m~=. then ind_snf_use_12m=1;
 label ind_snf_use_12m="Indicator for any SNF stay 12m pre core";
 label n_snf_days_12m="SNF Days 12m pre core"

run;

proc freq;
table n_snf_days_12m ind_snf_use_12m /missprint;
run;


/****************************************************************************/
/****************************************************************************/
/*Get indicator of ESRD codes from the denominator file the year of the interview*/
/****************************************************************************/
/****************************************************************************/
proc sort data=medi.dn_2000_2010 out=dn_2000_20102  nodupkey;
by BID_HRS_19 year;
run;

/*pull ESRD status variable from dn file
for the core interview years*/
proc sql;
create table dn_core_y as select
a.*,b.ESRD_IND from 
core_ids_1yr_criteria_2 a left join
dn_2000_20102 b
on trim(left(a.BID_hrs))=trim(left(b.BID_hrs_19))
and a.c_ivw_year=b.year;
quit;

proc freq;
table ESRD_IND /missprint;
run;

data core_ids_1yr_criteria_2b;
set dn_core_y ;
if ESRD_IND='Y' then esrd_ind_n=1;
if ESRD_IND='0' then esrd_ind_n=0;
label esrd_ind_n="ESRD indicator from claims denominator file";
drop ESRD_IND;
run;

proc freq;
table esrd_ind_n /missprint;
run;


/****************************************************************************/
/*Get indicator of Home 02 use 12 months pre interview from DME claims*/
/****************************************************************************/
data oxygen_1(keep=BID_HRS_19 core_year home_oxygen);
set sic_int.dm_meet_365;
home_oxygen=0;
label home_oxygen="Home O2 from DME claims";
array list BETOS01:BETOS13;
do over list;
if list = 'D1C' then home_oxygen=1;
end;
run; 

proc sort data=oxygen_1;
by bid_hrs_19 core_year;
run;

proc freq;
table core_year /missprint;
run;

proc sql;
create table oxygen_2 as
select distinct bid_hrs_19,core_year,
sum(home_oxygen) as home_oxygen
from oxygen_1 group by bid_hrs_19,core_year;
quit;

/*convert to binary variables*/
data oxygen_3;
set oxygen_2 ;
if home_oxygen>0 then home_oxygen=1;
if home_oxygen<=0 then home_oxygen=0;
run;

proc freq;
table home_oxygen;
run;

/*merge Oxygen use variable into the overall dataset*/
proc sql;
create table core_ids_1yr_criteria_3 as select
a.*,b.home_oxygen
from core_ids_1yr_criteria_2b a left join
oxygen_3 b
on trim(left(a.BID_hrs))=trim(left(b.BID_hrs_19))
and a.core_year=b.core_year;
quit;

data core_ids_1yr_criteria_4;
set core_ids_1yr_criteria_3;
if home_oxygen=. then home_oxygen=0;
label home_oxygen="Home O2 use from DME claims 1yr pre ivw";
run;

proc freq;
table home_oxygen /missprint;
run;

/*pull in new variables to overall interview dataset*/
proc sort data=core_ids_1yr_criteria_4 nodupkey;
by bid_hrs core_year;
run;

proc sort data=sic_int.core_ids_elix_cc_1yr_2 out=core_ids_elix_cc_1yr_2;
by bid_hrs core_year;
run;

proc sql;
create table sic_int.core_ids_1yr_criteria_4(drop=bid_hrs2 core_year2) as select a.*,b.* from
core_ids_elix_cc_1yr_2 a left join
core_ids_1yr_criteria_4(rename=(bid_hrs=bid_hrs2) rename=(core_year=core_year2)
     drop=c_ivw_year c_ivw_date age_ge_65 part_ab_12m hmo_d_12m )
 	 b
on a.bid_hrs=b.bid_hrs2 and a.core_year=b.core_year2;
quit;

H="Step 5a - Get outpatient ED use info"
/*proc printto new log='&logdir.\sas_8_sic_op_ed_log.log'
	print='&logdir.\sas_8_sic_op_ed_out.lst' 
run;*/

data op_meet_365;
set sic_int.op_meet_365(keep=bid_hrs_19 admit_date disch_date c_ivw_date core_year RVCNTR01-RVCNTR45);
run;

proc sort data=op_meet_365;
by bid_hrs_19 admit_date;
run;

data ed_op_1;
	set op_meet_365;
	ed_op=0;
	array list RVCNTR01-RVCNTR45;
	do over list;
	if list >= 450 and list < 460 and ed_op=0 then  
	ed_op = 1;
	end;
run;

proc freq;
table ed_op;
run;

proc sql;
create table ed_op_2 as select distinct bid_hrs_19,core_year,
count(case when ed_op=1 then ed_op else . end)
	as n_ed_op_visits_12m
	from ed_op_1 group by bid_hrs_19,core_year;
quit;

proc freq;
table n_ed_op_visits_12m;
run;

proc sort data=sic_int.core_ids_1yr_criteria_4 out=core_ids_1yr_criteria_4;
by bid_hrs core_year;
run;

proc sort data=ed_op_2 nodupkey;
by bid_hrs_19 core_year;
run;

/*merge into dataset*/
proc sql;
create table core_ids_1yr_criteria_4a as select a.*,b.n_ed_op_visits_12m
from core_ids_1yr_criteria_4 a
left join
ed_op_2 b 
on trim(left(a.bid_hrs))=trim(left(b.bid_hrs_19)) and a.core_year=b.core_year;
quit;

data sic_int.core_ids_1yr_criteria_4b;
set core_ids_1yr_criteria_4a;
if n_ed_op_visits_12m=. and comorb_1_0_1yr~=. then n_ed_op_visits_12m=0;
label n_ed_op_visits_12m="Count ED OP visits, 1yr pre ivw";

if n_ed_op_visits_12m=0 then ind_ed_op_12m=0;
if n_ed_op_visits_12m>0 & n_ed_op_visits_12m~=. then ind_ed_op_12m=1;
label ind_ed_op_12m="Indicator any ED OP visits, 1 yr pre ivw";
run;

proc freq;
table n_ed_op_visits_12m*ind_ed_op_12m;
run;

H="Step 5b - Classify serious illness based on just primary dx"
/*proc printto new log='&logdir.\sas_9_sic_pri_dx_log.log'
	print='&logdir.\sas_9_sic_pri_dx_out.lst' 
run;*/


/*recoded as a macro and use either the primary diagnosis or admitting diagnoses AD_DGNS */

/*start with IP claim list, 1 year before interview*/

%macro singledx(dxvar=,name=);

data dx_1_&name.;
set sic_int.mp_meet3_365(where=(trim(left(SSLSSNF))~="N"));

&name._dx=trim(left(&dxvar.));

if &name._dx~="" then do;

chf_&name._dx=0;
copd_&name._dx=0;
hip_&name._dx=0;

/*CHF*/
if (substr(&name._dx,1,5)='39891' or
		substr(&name._dx,1,5)='40211' or
		substr(&name._dx,1,5)='40291' or
		substr(&name._dx,1,5)='40411' or
		substr(&name._dx,1,5)='40413' or
		substr(&name._dx,1,5)='40491' or
		substr(&name._dx,1,5)='40493' or
		substr(&name._dx,1,3)='428') 
		and chf_&name._dx=0 
		then chf_&name._dx=1;*add one binary variables here.;
/*COPD*/
	if (substr(&name._dx,1,3)='490' or
		substr(&name._dx,1,3)='491' or
		substr(&name._dx,1,3)='492' or
		substr(&name._dx,1,4)='4930' or
		substr(&name._dx,1,4)='4931' or
		substr(&name._dx,1,4)='4932' or
		substr(&name._dx,1,4)='4938' or
		substr(&name._dx,1,5)='49390' or
		substr(&name._dx,1,5)='49391' or
		substr(&name._dx,1,3)='494' or
		substr(&name._dx,1,3)='495' or
		substr(&name._dx,1,3)='496' or
		substr(&name._dx,1,3)='497' or
		substr(&name._dx,1,3)='498' or
		substr(&name._dx,1,3)='499' or
		substr(&name._dx,1,3)='500' or
		substr(&name._dx,1,3)='501' or
		substr(&name._dx,1,3)='502' or
		substr(&name._dx,1,3)='503' or
		substr(&name._dx,1,3)='504' or
		substr(&name._dx,1,3)='505' or
		substr(&name._dx,1,4)='5064') 
			and copd_&name._dx=0 
		then copd_&name._dx=1;	
*hip fracture;
if (substr(&name._dx,1,3)='820' ) 
		and hip_&name._dx=0 
		then hip_&name._dx=1;*add one binary variables here.;
end;
run;

proc sql;
create table &name._dx_2 as
select distinct BID_hrs_19,core_year,
sum(chf_&name._dx) as chf_&name.,
sum(copd_&name._dx) as copd_&name.,
sum(hip_&name._dx) as hip_&name.
from dx_1_&name.
group by BID_hrs_19,core_year;
quit;

/*convert counts of diagnoses for each comorbidity to indicator variables*/ 
data &name._dx_3(keep=BID_hrs_19 core_year chf_&name._dx copd_&name._dx hip_&name._dx);
set &name._dx_2 ;
array list_com chf_&name. copd_&name. hip_&name.;
array list_com_bin chf_&name._dx copd_&name._dx hip_&name._dx;

do over list_com;
  list_com_bin=0;

  if list_com>0 then do;
    list_com_bin=1;
   end;

end;

run;

proc freq;
table chf_&name._dx copd_&name._dx hip_&name._dx;
run;
%mend;

/*use primary diagnosis code*/
%singledx(dxvar=dgns_cd01,name=pri);
/*use admitting diagnosis code*/
%singledx(dxvar=AD_DGNS,name=adm);

/*merge into the dataset that is just ffs 1 yr, 65+ age*/
proc sql;
create table core_ids_1yr_criteria_4c as select a.*,b.chf_pri_dx,
b.copd_pri_dx,b.hip_pri_dx
from sic_int.core_xwalk_ins_ffs_only a
left join
pri_dx_3 b 
on trim(left(a.bid_hrs))=trim(left(b.bid_hrs_19)) and a.core_year=b.core_year;
quit;

proc sql;
create table core_ids_1yr_criteria_4d as select a.*,b.chf_adm_dx,
b.copd_adm_dx,b.hip_adm_dx
from core_ids_1yr_criteria_4c a
left join
adm_dx_3 b 
on trim(left(a.bid_hrs))=trim(left(b.bid_hrs_19)) and a.core_year=b.core_year;
quit;

data core_ids_1yr_criteria_4e;
set core_ids_1yr_criteria_4d;

array list chf_pri_dx copd_pri_dx hip_pri_dx chf_adm_dx copd_adm_dx hip_adm_dx;
do over list;
	if list = .  then list=0;
end;
label chf_pri_dx="CHF as primary dx from IP claim, 1yr pre ivw";
label copd_pri_dx="COPD as primary dx from IP claim, 1yr pre ivw";
label hip_pri_dx="Hip fracture as primary dx from IP claim, 1yr pre ivw";

label chf_adm_dx="CHF as admitting dx from IP claim, 1yr pre ivw";
label copd_adm_dx="COPD as admitting dx from IP claim, 1yr pre ivw";
label hip_adm_dx="Hip fracture as admitting dx from IP claim, 1yr pre ivw";

run;

proc freq;
table chf_pri_dx*chf_adm_dx copd_pri_dx*copd_adm_dx hip_pri_dx*hip_adm_dx ;
run;

/*Hip fracture criteria, method  by Covinsky
One of the (2) criteria met:
(1) Subject was admitted to a hospital with admitting diagnosis of “820.xx”.
(2) There is a physician record of “HF procedure” (defined by CPT code of 27230-27248) that is supported by either: 
a. Another physician record within 2 days OR 2
b. Relevant surgery during hospitalization. (Relevant surgery is defined by ICD9 codes 785.5, 790.5, 791.5, 792.5). 
(1) variable hip_adm_dx defined in macro above
(2) HF procedure: carrier claims 	(HCPCS_YR specifies the year of CPT coding used)
					HCPSCD01-HCPSCD13 The level 1 HCPCS code is the CPT code
Then a)from carrier claims or 
     b) from IP claims
	

For item (2) checked inpatient claims variables HCPSCD01-45 but none had any of the CPT codes in the list
Next step, try running with carrier files...
*/

/********************************************************************/
/*Physican record of HF procedure, check IP claims*/
data ip_meet_365;
set sic_int.ip_meet3_365;
run;

proc contents data=ip_meet_365;
run;

data testhf;
set ip_meet_365;
if HCPSCD01~='';
run;

data hfproc_ip;
set ip_meet_365;
hf_proc_ind=0;
array list HCPSCD01-HCPSCD45;
do over list;
if list~='' then do;
	if (list='27230' or
		list='27231' or
		list='27232' or
		list='27233' or
		list='27234' or
		list='27235' or
		list='27236' or
		list='27237' or
		list='27238' or
		list='27239' or
		list='27240' or
		list='27241' or
		list='27242' or
		list='27243' or
		list='27244' or
		list='27245' or
		list='27246' or
		list='27247' or
		list='27248')
		/*and hf_proc_ind=0*/
		then hf_proc_ind=1;
	end;
end;


run;

proc freq; table hf_proc_ind;
run;

/********************************************************************/
/*Physican record of HF procedure, check carrier claims*/
/********************************************************************/

data hfproc_carr;
set sic_int.pb_meet_365;
hf_proc_ind=0;
array list HCPSCD01-HCPSCD13;
do over list;
if list~='' then do;
	if (list='27230' or
		list='27231' or
		list='27232' or
		list='27233' or
		list='27234' or
		list='27235' or
		list='27236' or
		list='27237' or
		list='27238' or
		list='27239' or
		list='27240' or
		list='27241' or
		list='27242' or
		list='27243' or
		list='27244' or
		list='27245' or
		list='27246' or
		list='27247' or
		list='27248')
		/*and hf_proc_ind=0*/
		then hf_proc_ind=1;
	end;
end;


run;

proc freq; table hf_proc_ind;
run;
/********************************************************************/
/*is there also a physican record within 2 days?*/
proc sort data=hfproc_carr; by BID_HRS_19 FROM_DT THRU_DT hf_proc_ind;
run;

data hfproc_carr_2;
set hfproc_carr;
if eof1=0 then
	set hfproc_carr (firstobs=2 keep=admit_date disch_date rename=(admit_date=lead1admit disch_date=lead1disch)) end=eof1;
else do; lead1admit=.;  lead1disch=.; end;
run;

data hfproc_carr_3;
set hfproc_carr_2;
days_next_visit=lead1admit-disch_date;
days_next_disch=lead1disch-disch_date;
if hf_proc_ind=1 and days_next_visit<=2 and days_next_visit~=. & days_next_disch>0 then hf_w_visit_2d=1;
else hf_w_visit_2d=0;
run;

data hfproc_carr_4;
set hfproc_carr_3;
if hf_proc_ind=1;
run;

proc freq data=hfproc_carr_3;
table hf_proc_ind hf_w_visit_2d core_year; run;

/*if have hf CPT code from carrier, but no subsequent carrier claim,
do they have a surgery code from the inpatient claims?*/
data hfproc_carr_5;
set hfproc_carr_4;
if hf_proc_ind=1 and hf_w_visit_2d=0;
run;




/*for b) identify relevant surgeries from IP claims CPT codes and surgery dates*/

/*This section of code for just checking For Surgeries*/
data ip_meet_365;
set sic_int.mp_meet3_365(where=(trim(left(SSLSSNF))~="N"));
run;

proc contents data=ip_meet_365;
run;

data proc_long(keep=BID_hrs_19 TYPE_ADM procedure procedure_date date_imp_yes AD_DGNS DGNS_CD01-DGNS_CD25
	 admit_date disch_date core_year);
set ip_meet_365;
array list PRCDR_CD01-PRCDR_CD25;
array date PRCDR_DT01-PRCDR_DT25;
do over list;
if list~="" then do;
	procedure=list;
	if date=0000000 then do;
		procedure_date=admit_date;
		date_imp_yes=1;
		end;
	if date~=0000000 then do;
	procedure_date=datejul(date);
	end;
	output;
end;
end;

format procedure_date date10.;
format admit_date date10.;
format disch_date date10.;

run;

proc freq; table date_imp_yes; run;

/* Identify surgeries that meet the criteria
Indicator variable surgery_meet = 1 if yes, include in sample 
79 surgeries meet the criteria*/
data surgery_meet;
set proc_long;
if length(compress(procedure))>3 then do;

if compress(procedure)+0 in (7855, 7905, 7915, 7925) then surgery_meet=1;

end;
/*only keep observations in work.surgery_meet that meet criteria*/
if surgery_meet then output;

run;
/*End surgery section 1*/

/*who has surgery that meets criteria AND hf CPT code from carrier?*/
proc sql;
create table cpt_and_surg as select a.*,b.admit_date as carr_hf_admit, b.disch_date as carr_hf_disch,
b.hf_proc_ind, b.hf_w_visit_2d from 
surgery_meet a inner join
hfproc_carr_5 b
on a.bid_hrs_19=b.bid_hrs_19;
quit;

data cpt_and_surg_1;
set cpt_and_surg;
format carr_hf_admit carr_hf_disch date9.;
hf_w_surgery=1;
run;

/*now merge in lists to get a list of bid's that meet criteria 1 or 2*/
data cpt_and_surg_2;
set cpt_and_surg_1;
keep bid_hrs_19 hf_proc_ind hf_w_surgery core_year;
run;

proc sort data=cpt_and_surg_2 nodupkey; by bid_hrs_19 core_year ; run;

data hfproc_carr_6;
set hfproc_carr_4;
keep bid_hrs_19 hf_proc_ind hf_w_visit_2d core_year;
if hf_proc_ind=1 and hf_w_visit_2d=1;
run;

proc sort data=hfproc_carr_6 nodupkey; by bid_hrs_19  core_year ; run;

*merge the datasets;
data hf_meet;
merge hfproc_carr_6 cpt_and_surg_2 ;
by bid_hrs_19 core_year;
run;

proc sort data=hf_meet out=hf_meet2 nodupkey; by bid_hrs_19  core_year; run;

/*merge in these hip fracture variables*/
proc sql;
create table core_ids_1yr_criteria_4f
as select a.*,b.hf_w_visit_2d,b.hf_w_surgery from
core_ids_1yr_criteria_4e a left join
hf_meet2 b
on a.bid_hrs=b.bid_hrs_19 and a.core_year=b.core_year;
quit;

proc freq; table hf_w_visit_2d*hf_w_surgery /missprint;
run;

data core_ids_1yr_criteria_4g;
set core_ids_1yr_criteria_4f;

array list hf_w_visit_2d hf_w_surgery ;
do over list;
	if list = .  then list=0;
end;
label hf_w_visit_2d ="HF CPT + Dr visit within 2 days, 1yr pre ivw";
label hf_w_surgery ="HF CPT + Surgery, 1yr pre ivw";

run;

proc freq; table hf_w_visit_2d hf_w_surgery; run;

/*Another idea is to check IP claims
if CPT code (in fields HCPCSCD01-HCPCSCD45 in list then if PRCDRCD1-PRCDRCD25 in list = hip frature = yes*/

/*merge new variables into full interview dataset*/
proc sql;
create table sic_int.core_ids_1yr_criteria_4g(drop=bid_hrs2 core_year2) as select a.*,b.* from
sic_int.core_ids_1yr_criteria_4b a left join
core_ids_1yr_criteria_4g(rename=(bid_hrs=bid_hrs2) rename=(core_year=core_year2)
     drop=c_ivw_year c_ivw_date age_ge_65 part_ab_12m hmo_d_12m )
 	 b
on a.bid_hrs=b.bid_hrs2 and a.core_year=b.core_year2;
quit;

H="Step 6 - HRS variable cleaning and check criteria"
/*This section defines the serious medical illness indicators
as well as the additional criteria for serious illness
1. Serious medical illness
2. ADL impairment
3. Self report nursing home residence
4. Urgent or emergent hospitalization 

2 sets of criteria are used:
Criteria A: Either serious medical illness or ADL impairment
Criteria B: Critera A + either nursing home resident or hospitalization*/

/*proc printto new log='&logdir.\sas_10_sic_crit_log.log'
	print='&logdir.\sas_10_sic_crit_out.lst' 
run;*/

proc freq
data=sic_int.core_ids_1yr_criteria_4g;
table comorb_31_0_1yr;
run;

data sic_int.core_ids_1yr_criteria_5;
set sic_int.core_ids_1yr_criteria_4g ;

/*create tics categorical variable*/
if tics_tot>8 then tics_cat=1 ;
if 5<=tics_tot<=8 then tics_cat=2 ;
if 0<=tics_tot<=4 then tics_cat=3 ;
label tics_cat="TICS 1=normal, 2=MCI, 3=Demented";

/*any elixhauser cancer dx*/
if comorb_17_0_1yr=1 | comorb_18_0_1yr=1 | comorb_19_0_1yr=1 then el_cancer_1yr=1;
if comorb_17_0_1yr=0 & comorb_18_0_1yr=0 & comorb_19_0_1yr=0 then el_cancer_1yr=0;

/*4 or more comorbidities - needs to be reevaluated once other defs are defined!*/
if comorb_all_0_1yr>3 then el_ge4_comorb_1yr=1;
if 0=<comorb_all_0_1yr<=3 then el_ge4_comorb_1yr=0;

cc_all_count_1yr = cc_1_ami_1yr + cc_2_alzh_1yr + cc_3_alzhdmta_1yr + 
cc_4_atrialfb_1yr + cc_5_cataract_1yr + cc_6_chrnkidn_1yr + 
cc_7_copd_1yr + cc_8_chf_1yr + cc_9_diabetes_1yr + cc_10_glaucoma_1yr + 
cc_11_hipfrac_1yr + cc_12_ischmcht_1yr + cc_13_depressn_1yr + 
cc_14_osteoprs_1yr + cc_15_ra_oa_1yr + cc_16_strketia_1yr + 
cc_17_cncrbrst_1yr + cc_18_cncrclrc_1yr + cc_19_cncrprst_1yr + 
cc_20_cncrlung_1yr + cc_21_cncrendm_1yr;

if cc_all_count_1yr >3 then cc_ge4_comorb_1yr=1;
if 0=<cc_all_count_1yr <=3 then cc_ge4_comorb_1yr=0;

/*cc's excluding cataract and glaucoma*/
cc_all_count_1yr_2 = cc_1_ami_1yr + cc_2_alzh_1yr + cc_3_alzhdmta_1yr + 
cc_4_atrialfb_1yr + /*cc_5_cataract_1yr +*/ cc_6_chrnkidn_1yr + 
cc_7_copd_1yr + cc_8_chf_1yr + cc_9_diabetes_1yr + /*cc_10_glaucoma_1yr +*/ 
cc_11_hipfrac_1yr + cc_12_ischmcht_1yr + cc_13_depressn_1yr + 
cc_14_osteoprs_1yr + cc_15_ra_oa_1yr + cc_16_strketia_1yr + 
cc_17_cncrbrst_1yr + cc_18_cncrclrc_1yr + cc_19_cncrprst_1yr + 
cc_20_cncrlung_1yr + cc_21_cncrendm_1yr;
label cc_all_count_1yr_2="Count of cc's, excludes cataract and glaucoma";

if cc_all_count_1yr_2>3 then cc2_ge4_comorb_1yr=1;
if 0=<cc_all_count_1yr_2<=3 then cc2_ge4_comorb_1yr=0;

label el_ge4_comorb_1yr="4+ Elixhauser comorbidities";
label cc_ge4_comorb_1yr="4+ DW Chronic Conditions";
label cc2_ge4_comorb_1yr="4+ DW Chronic Conditions, excl cataract and glaucoma";

/*create indicators for any indication of the serious medical illnesses across
variables (cc's elix hrs survey) */
if comorb_31_0_1yr=1  then smi_dem_ind=1;
if comorb_31_0_1yr=0  then smi_dem_ind=0;
label smi_dem_ind="Indicator of Dementia 1yr, Elixhauser";

/*old def commented out
if el_cancer_1yr=1 | CC_cncr_chronic_1yr=1 | cancer_hrs=1 then cancer_any_ind=1;
if el_cancer_1yr=0 & CC_cncr_chronic_1yr=0 & cancer_hrs=0 then cancer_any_ind=0; */
/*cancer flagged as serious medical illness if metastatic cancer 
or blood cancers new def to be provided from Amy*/
if comorb_18_0_1yr=1 then smi_cancer_ind=1;
if comorb_18_0_1yr=0 then smi_cancer_ind=0;
label smi_cancer_ind="Indicator of Metastatic Cancer 1yr";

/*ESRD from either dx code per elixhauser or denominator file flag*/
if comorb_13_0_1yr=1 | esrd_ind_n=1 then smi_esrd_ind=1;
if comorb_13_0_1yr=0 & esrd_ind_n=0  then smi_esrd_ind=0;
label smi_esrd_ind="Indicator of ESRD 1yr, Elix and claims DN file";

/*chf, use dx list for Elixhauser, but as primary DX from a hospitalization only*/
if chf_pri_dx=1  then smi_chf_ind=1;
if chf_pri_dx=0  then smi_chf_ind=0;
label smi_chf_ind="Indicator of CHF 1yr, Primary dx from IP claim";

/*COPD indicator meets following criteria:
1. COPD from Elix (any dx field) and Oxygen use from DME claims or
2. COPD as a primary diagnosis from a hospitalization*/
if (comorb_9_0_1yr=1 & home_oxygen=1) | copd_pri_dx=1 then smi_copd_ind=1;
if (comorb_9_0_1yr=0 | home_oxygen=0) & copd_pri_dx=0 then smi_copd_ind=0;
label smi_copd_ind="Indicator of COPD 1yr, copd any dx and home o2 use or copd as prim dx";

/*diabetes, Elix 11 (diabetes with complications) if criteria for 
renal disease (comorb 34), ischemic heart disease (cc 12) or 
peripheral vascular disease (comorb 5) are present*/
if comorb_11_0_1yr=1 & (comorb_5_0_1yr=1 | comorb_34_0_1yr=1 | CC_12_ISCHMCHT_1yr =1) then
	smi_diab_compl_ind=1;
if comorb_11_0_1yr=0 | (comorb_5_0_1yr=0 & comorb_34_0_1yr=0 & CC_12_ISCHMCHT_1yr =0) then
	smi_diab_compl_ind=0;
label smi_diab_compl_ind="Elix compl diabetes + peripheral vas, renal or ischem, 1yr";

if comorb_14_0_1yr=1 then smi_liver_ind=1;
if comorb_14_0_1yr=0 then smi_liver_ind=0;
label smi_liver_ind="Indicator of Advanced liver disease/cirrhosis 1yr, elix";

/*Update 6/9/14 - HIV not included in final list of serious medical illnesses for
the criteria definition*/
if comorb_16_0_1yr=1 then smi_hiv_ind=1;
if comorb_16_0_1yr=0 then smi_hiv_ind=0;
label smi_hiv_ind="Indicator of HIV with and AIDS defining illness 1yr, elix";

if comorb_33_0_1yr=1 then smi_als_ind=1;
if comorb_33_0_1yr=0 then smi_als_ind=0;
label smi_als_ind="Indicator of ALS 1yr, icd9 code";

/*hip fracture, either admitting diagnosis or CPT from carrier claim AND
surgery or follow up carrier claim within 2 days*/
if hip_adm_dx=1 | hf_w_visit_2d=1 | hf_w_surgery=1 then smi_hip_ind=1;
if hip_adm_dx=0 & hf_w_visit_2d=0 & hf_w_surgery=0 then smi_hip_ind=0;
label smi_hip_ind="Indicator of Hip fracture 1yr, adm dx or from physician claims";
/*******************************************************************/
/*******************************************************************/

/*doesn't use the cc definition excluding cataract,glaucoma cc2_ge4_comorb_1yr */
if el_ge4_comorb_1yr=1 | cc_ge4_comorb_1yr=1 | comor_c_hrs=1 then multi_any_ind=1;
if el_ge4_comorb_1yr=0 & cc_ge4_comorb_1yr=0 & comor_c_hrs=0 then multi_any_ind=0;
label multi_any_ind="Any indicator of Multimorbidity 4+ chronic conditions 1yr";

/*total number of serious medical illnesses per these definitions*/
smi_count=smi_dem_ind + smi_cancer_ind + smi_esrd_ind + smi_chf_ind + smi_copd_ind + 
 smi_diab_compl_ind + smi_liver_ind + /*smi_hiv_ind +*/ smi_als_ind + smi_hip_ind;

/*indicator for 2+serious medical illnesses*/
if smi_count>=2 then smi_ge2_ind=1;
if smi_count<2 then smi_ge2_ind=0;
label smi_ge2_ind="2 or more serious medical illnesses";

/*indicator for any serious medical illness
Update 6/9/14 - HIV not included in list of serious medical illnesses*/
if smi_dem_ind =1 | smi_cancer_ind =1 | smi_esrd_ind =1 | smi_chf_ind =1 | 
 smi_copd_ind =1 | comorb_11_0_1yr =1 | comorb_14_0_1yr =1 /*| smi_hiv_ind =1*/ | 
 smi_als_ind =1 | smi_hip_ind=1
 then ser_med_illness=1;
if smi_dem_ind =0 & smi_cancer_ind =0 & comorb_13_0_1yr =0 & smi_chf_ind =0 & 
 smi_copd_ind =0 & comorb_11_0_1yr =0 & comorb_14_0_1yr =0 /*& smi_hiv_ind =0*/ & 
 smi_als_ind =0 & smi_hip_ind=0
 then ser_med_illness=0;
label ser_med_illness="Any indicator of serious medical illness 1yr";

/*Indicator for any SNF stays 12m prior to interview or current nh res
Update 6/2/14 - nursing home use will be included only if current nh residence reported,
not if any SNF claims found*/
if /*ind_snf_use_12m=1 |*/ nhres=1 then smi_nh_ind=1;
if /*ind_snf_use_12m=0 &*/ nhres=0 then smi_nh_ind=0;
label smi_nh_ind="Nursing home resident self report in ivw";

/*indicator for adl helper*/
if adl_helper_count>0 & adl_helper_count~=. then smi_helper_ind=1;
if adl_helper_count=0 then smi_helper_ind=0;
label smi_helper_ind="Indicator of having any helpers with ADL, core";

/*backfill adl status if adl helper variable is complete*/
adl_ind_core_n = adl_independent_core;
if adl_independent_core=. and smi_helper_ind=1 then adl_ind_core_n=0;
if adl_independent_core=. and smi_helper_ind=0 then adl_ind_core_n=1;
label adl_ind_core_n = "ADL independent at core interview, using SR and helper file";

if adl_ind_core_n=1 then adl_impair_core = 0;
if adl_ind_core_n=0 then adl_impair_core = 1;
label adl_impair_core = "ADL impairment at core interview, using SR and helper file";

/*indicator for any ED visit, either OP or IP*/
if ind_ed_op_12m=1 | ind_ED_adm_12m=1 then ind_ed_op_or_ip_12m=1;
if ind_ed_op_12m=0 & ind_ED_adm_12m=0 then ind_ed_op_or_ip_12m=0;
label ind_ed_op_or_ip_12m="Indicator any ED use 12m pre ivw";

/*criteria (A) serious medical illness and/or ADL impairment*/
if (ser_med_illness=1 | adl_impair_core =1) then criteria_a=1;
if (ser_med_illness=0 & adl_impair_core =0) then criteria_a=0;
label criteria_a="Crit A SMI and/or ADL impair";

/*indicator for serious medical illness and ADL impairment*/
if (ser_med_illness=1 & adl_impair_core =1) then smi_and_adl=1;
if (ser_med_illness=0 | adl_impair_core =0) then smi_and_adl=0;
label smi_and_adl="SMI and ADL impairment";

/*criteria (B) serious medical illness and/or ADL impairment AND nh res or urgent/emergent hosp*/
if (ser_med_illness=1 | adl_impair_core =1) & (ind_em_ur_adm_12m=1 | smi_nh_ind=1) then criteria_b=1;
if (ser_med_illness=0 & adl_impair_core =0) | (ind_em_ur_adm_12m=0 & smi_nh_ind=0) then criteria_b=0;
label criteria_b="Crit B SMI or ADL impair and hospital admit or nh use";

/*criteria (C) serious medical illness and adl impairment AND nh res or urgent/emergent hosp*/
if (ser_med_illness=1 & adl_impair_core =1) & (ind_em_ur_adm_12m=1 | smi_nh_ind=1) then criteria_c=1;
if (ser_med_illness=0 | adl_impair_core =0) | (ind_em_ur_adm_12m=0 & smi_nh_ind=0) then criteria_c=0;
label criteria_c="Crit C SMI and ADL impair and hospital admit or nh use";

run;

 ods rtf body="E:\data\serious_ill\logs\criteria_vars_before_coredate.rtf";

title "Number of unique people in full cohort 2000-2010";
proc sql;
select count(distinct id) from sic_int.core_ids_1yr_criteria_5
where core_year in (2000,2002,2004,2006,2008,2010);

title "Unique R's w/ Age 65+";
select count(distinct id) from sic_int.core_ids_1yr_criteria_5
where age_ge_65=1 and core_year in (2000,2002,2004,2006,2008,2010);

title "Unique R's w/ Age 65+, With mc xwalk id";
select count(distinct id) from sic_int.core_ids_1yr_criteria_5
where age_ge_65=1 and xwalk_yes=1 and core_year in (2000,2002,2004,2006,2008,2010);

title "Unique R's w/ Age 65+, With mc xwalk id, and FFS 1yr pre-ivw";
select count(distinct id) from sic_int.core_ids_1yr_criteria_5
where age_ge_65=1 and xwalk_yes=1 and part_ab_12m=1 and hmo_d_12m=0 
and core_year in (2000,2002,2004,2006,2008,2010);

create table age_ge_65_mc as 
select * from sic_int.core_ids_1yr_criteria_5
where age_ge_65=1 and xwalk_yes=1 and part_ab_12m=1 and hmo_d_12m=0 
and core_year in (2000,2002,2004,2006,2008,2010);
quit;

title "Dementia - elix";
proc freq data=age_ge_65_mc ;
table smi_dem_ind /missprint;
run;

title "Cancer - elix, metastatic or hematologic cancer";
proc freq data=age_ge_65_mc ;
table smi_cancer_ind /missprint ;
run;

title "End Stage Renal Disease - elix, claims denominator file year of core ivw";
proc freq data=age_ge_65_mc ;
table comorb_13_0_1yr esrd_ind_n comorb_13_0_1yr*esrd_ind_n ind_hosp_adm_12m*esrd_ind_n smi_esrd_ind /missprint;
run;

title "CHF+Indicator of more advanced disease - elix + some utilization measure TBD!";
proc freq data=age_ge_65_mc ;
table smi_chf_ind chf_pri_dx chf_adm_dx /missprint;
run;

title "COPD, Either (1) ICD=9 code in any claim + DME claim for home O2 OR (2) COPD as primary dx in IP claim";
proc freq data=age_ge_65_mc ;
table smi_copd_ind /missprint;
run;

*data o2_no_copd;
*set age_ge_65_mc ;
*if smi_lung_02_ind =0 and home_oxygen =1;
*run;

*title "Among interviews with home O2 use but no COPD, check to see if these are CHF patients?";
*proc freq data=o2_no_copd;
*table  smi_chf_ind*home_oxygen /missprint;
*run;

title "Diabetes with severe complications (renal disease, ischemic hd or peripheral vascular disease)";
proc freq data=age_ge_65_mc ;
table smi_diab_compl_ind /missprint;
run;

title "Advanced liver disease/cirrhosis - elix";
proc freq data=age_ge_65_mc ;
table smi_liver_ind /missprint;
run;

title "HIV with and AIDS defining illness - elix";
proc freq data=age_ge_65_mc ;
table smi_hiv_ind /missprint;
run;

title "ALS - just single dx code ";
proc freq data=age_ge_65_mc ;
table smi_als_ind /missprint;
run;

title "Hip fracture, CC";
proc freq data=age_ge_65_mc ;
table smi_hip_ind /missprint;
run;

title "Multimorbidity, 2+serious medical illnesses as defined here";
proc freq data=age_ge_65_mc ;
table smi_count smi_ge2_ind /missprint;
run;

title "Any ADL help, HRS";
proc freq data=age_ge_65_mc ;
table adl_independent_core /missprint;
run;

title "Hospital admissions 6m, 12m before core interview";
proc freq data=age_ge_65_mc  ;
table ind_hosp_adm_6m*ind_em_ur_adm_6m ind_hosp_adm_12m*ind_em_ur_adm_12m 
ind_em_adm_12m*ind_ED_adm_12m ind_em_ur_adm_12m*ind_ED_adm_12m /missprint;
run;

title "Elective vs non elective hospital admissions, 12m before core";
proc freq data=age_ge_65_mc  ;
table ind_nonelect_adm_12m n_nonelect_adm_12m ind_elect_adm_12m n_elect_admit_12m /missprint;
run;

title "ED visit without subsequent admission from OP claims, 12m pre interview";
proc freq data=age_ge_65_mc  ;
table ind_ed_op_12m n_ed_op_visits_12m ind_ed_op_or_ip_12m/missprint;
run;

title "Nursing home use 12m before core interview or self report NH resident at interview";
proc freq data=age_ge_65_mc  ;
table ind_snf_use_12m*nhres smi_nh_ind /missprint;
run;

title "Any helper with ADLs, core interview";
proc freq data=age_ge_65_mc  ;
table smi_helper_ind smi_helper_ind*adl_independent_core adl_impair_core /missprint;
run;

title "Number of R's that meet A)Any serious illness";
proc sql;
select count(distinct id) from age_ge_65_mc  
where ser_med_illness=1;

title "Number of R's that meet HIV";
proc sql;
select count(distinct id) from age_ge_65_mc  
where smi_hiv_ind=1;

title "Number of R's that meet B)Any ADL help";
proc sql;
select count(distinct id) from age_ge_65_mc  
where adl_impair_core=1;

title "Number of R's that meet Criteria A: Serious medical illness and/or Any ADL help";
proc sql;
select count(distinct id) from age_ge_65_mc  
where (criteria_a=1);

title "Number of R's that meet Criteria B: Serious medical illness and/or Any ADL help and NH use and/or Hospitalization";
proc sql;
select count(distinct id) from age_ge_65_mc  
where criteria_b=1;

title "Number of R's that meet Criteria C: Serious medical illness and Any ADL help and NH use and/or Hospitalization";
proc sql;
select count(distinct id) from age_ge_65_mc  
where criteria_c=1;

title "Number of R's that meet Any urgent or emergent hospital admission 12m preceding core interview";
proc sql;
select count(distinct id) from age_ge_65_mc  
where ind_em_ur_adm_12m=1;

title "Number of R's that meet NH resident at interview ";
proc sql;
select count(distinct id) from age_ge_65_mc  
where smi_nh_ind=1;

title "Number of R's that meet Any helper with ADLs core interview";
proc sql;
select count(distinct id) from age_ge_65_mc  
where smi_helper_ind=1;

title "Number of R's that meet Any serious illness and ADL help";
proc sql;
select count(distinct id) from age_ge_65_mc  
where (ser_med_illness=1 and adl_impair_core=1) ;

title "Number of R's that meet Any serious illness and Urgent or Emergency hospital admission";
proc sql;
select count(distinct id) from age_ge_65_mc  
where (ser_med_illness=1 and ind_em_ur_adm_12m=1) ;

ods rtf close; 

/*******************************************************************************/
/*17 observations where esrd flag in denominator file = 1 but no esrd comorbidity
what are these peoples diagnoses?*/
data esrd_check_1;
set age_ge_65_mc;
if esrd_ind_n=1 and comorb_13_0_1yr=0;
run;

proc freq data=esrd_check_1; table part_ab_12m hmo_d_12m; run;

proc sql;
create table esrd_check_2 as select a.* from 
dx_all_last_1yr a join
esrd_check_1 b
on a.bid_hrs_19=b.bid_hrs and a.core_year=b.core_year;
quit;

ods rtf body="E:\data\serious_ill\logs\check_esrd.rtf";
title "n=17 with esrd flag in denominator file but not from elixhauser comorb definition";
proc freq data=esrd_check_2 order=freq; table diag; run;
quit;
ods rtf close;

/*export full dataset to Stata*/
proc export data=sic_int.core_ids_1yr_criteria_5
outfile="E:\data\serious_ill\int_data\core_ids_1yr_criteria_5.dta" replace;
run;


H="Step 7 - Stata do file to get sample, criteria"
/*Stata do file to look at sample selection and serious illness cohort criteria*/

capture log close

clear all
set mem 800m
set more off

local logpath E:\data\serious_ill\logs
local datapath E:\data\serious_ill\int_data

log using "`logpath'\2-sic_initial_criteria.txt", text replace

cd `datapath'

use core_ids_1yr_criteria_5.dta
*******************************************************************
mat sample_set=J(7,1,.)

tab core_year, missing
sum core_year
mat sample_set[1,1]=r(N)

sum core_year if inlist(core_year,2000,2002,2004,2006,2008)
mat sample_set[2,1]=r(N)

sum core_year if inlist(core_year,2000,2002,2004,2006,2008) & age_ge_65==1
mat sample_set[3,1]=r(N)

sum core_year if inlist(core_year,2000,2002,2004,2006,2008) & age_ge_65==1 & xwalk_yes==1
mat sample_set[4,1]=r(N)

sum core_year if inlist(core_year,2000,2002,2004,2006,2008) & age_ge_65==1 & xwalk_yes==1 & ///
part_ab_12m==1 & hmo_d_12m==0
mat sample_set[5,1]=r(N)

//check if only require 6 month ffs pre interview, what changes??
sum core_year if inlist(core_year,2000,2002,2004,2006,2008) & age_ge_65==1 & xwalk_yes==1 & ///
part_ab_6m==1 & hmo_d_6m==0
mat sample_set[6,1]=r(N)

//check if have wage index merged in (FFS 1 year)
sum core_year if inlist(core_year,2000,2002,2004,2006,2008) & age_ge_65==1 & xwalk_yes==1 & ///
part_ab_12m==1 & hmo_d_12m==0 & wage_index_20102!=.
mat sample_set[7,1]=r(N)

mat rownames sample_set="Core interviews 1998-2010" "Core Interviews 2000-2008" "Age 65+" ///
"With xwalk id" "With FFS MC 1yr pre-ivw" "With FFS MC 6m pre-ivw" "With 1 year FFS & Wage Index"

mat colnames sample_set="Interviews"

mat list sample_set

frmttable using `logpath'\sic_Table1_sample, statmat(sample_set) ///
title("Serious illness cohort, sample criteria") ///
ctitle("","N Interviews") ///
sdec(0) replace

//drop interviews that don't meet above criteria
keep if inlist(core_year,2000,2002,2004,2006,2008) & age_ge_65==1 & xwalk_yes==1 & ///
part_ab_12m==1 & hmo_d_12m==0

save core_ids_1yr_criteria_5_sample1.dta, replace

*******************************************************************
log close


H="Step 7a - Stata looking at criteria"
//6/9/14 Note HIV was removed from the list of serious illnesses 
//so it was also removed from these tables

capture log close

clear all
set mem 500m
set more off

local logpath E:\data\serious_ill\logs
local datapath E:\data\serious_ill\int_data

log using "`logpath'\3-sic_initial_criteria_2.txt", text replace

cd `datapath'

use core_ids_1yr_criteria_5_sample1.dta

*******************************************************************
//look at criteria variables at the interview level

//Criteria A medical illness and/or adl impairment

tab criteria_a, missing

tab smi_and_adl, missing

gen byte smi_or_adl_and_nh=.
replace smi_or_adl_and_nh=1 if criteria_a==1 & smi_nh_ind==1
replace smi_or_adl_and_nh=0 if criteria_a==0 | smi_nh_ind==0
tab smi_or_adl_and_nh, missing

gen byte smi_or_adl_and_hosp=.
replace smi_or_adl_and_hosp=1 if criteria_a==1 & ind_em_ur_adm_12m==1
replace smi_or_adl_and_hosp=0 if criteria_a==0 | ind_em_ur_adm_12m==0
tab smi_or_adl_and_hosp, missing

tab criteria_c, missing

//serious medical illness variables (16 vars)
local smi_vars smi_dem_ind smi_cancer_ind smi_esrd_ind smi_chf_ind smi_copd_ind ///
smi_diab_compl_ind smi_liver_ind smi_als_ind smi_hip_ind ///
ser_med_illness smi_ge2_ind adl_impair_core smi_and_adl criteria_a smi_or_adl_and_nh ///
smi_or_adl_and_hosp criteria_b criteria_c

mat criteria=J(19,2,.)

//overall n interviews
sum core_year
sca sample=r(N)
mat criteria[1,1]=r(N)

local j=2
foreach v in `smi_vars' {
tab `v',matcell(x_`j')
mat criteria[`j',1]=x_`j'[2,1]
mat criteria[`j',2]=x_`j'[2,1]/sample*100
local j = `j'+1
}


mat list criteria

frmttable using `logpath'\sic_Table2_criteria, statmat(criteria) ///
title("Serious illness cohort, criteria") ///
ctitle("","N Interviews","% interviews") ///
rtitle("Overall n interviews" \"Dementia"\ "Cancer" \"ESRD" \"CHF" \"COPD" \"Diabetes" \ ///
"Liver disease"\ "ALS"\ "Hip fracture"\ "Any serious medical illness"\ "2 or more SMI's"\ ///
"ADL Impairment"\ "Med Ill and ADL Impairment" \"Med Ill and/or ADL Impairment"\ ///
"Med Ill and/or ADL Imp + SNF"\ ///
"Med Ill and/or ADL Imp + Hosp"\ "Med Ill and/or ADL Imp + SNF or Hosp"\ ///
"Med Ill and ADL Imp + SNF or Hosp") ///
sdec(0,2) replace


**********************************************************************************
//look at additional criteria
tab adl_impair_core, missing
tab ind_em_ur_adm_12m, missing
tab smi_nh_ind, missing

//look at combinations
tab ser_med_illness adl_impair_core, missing matcell(smi_adl)

frmttable using `logpath'\sic_Table2_criteria, statmat(smi_adl) ///
title("Serious illness cohort, serious medical condition vs ADL impairment") ///
ctitle("","ADL Impair, no" "ADL Impair, yes") ///
rtitle("Serious med ill, no" \ "Serious med ill, yes") ///
sdec(0) addtable

tab ser_med_illness ind_em_ur_adm_12m, missing
tab ser_med_illness smi_nh_ind, missing
tab adl_impair_core smi_nh_ind, missing  matcell(nh_adl)

frmttable using `logpath'\sic_Table2_criteria, statmat(nh_adl) ///
title("Serious illness cohort, nursing home use vs ADL impairment") ///
ctitle("","ADL Impair, no" "ADL Impair, yes") ///
rtitle("Nursing home use, no" \ "Nursing home use, yes") ///
sdec(0) addtable

**********************************************************************************
//look at SNF use vs adl use and hospitalization
//looking at self report nh use vs snf use from claims
//3 categories, (1) self report in nursing home at interview
//(2) nursing home use per claims
//(3) both SR in NH and SNF claims
mat nh_adl2=J(13,4,.)

//first row - overall n's
tab smi_nh_ind, matcell(crit)
mat nh_adl2[1,1]=crit[2,1]
tab nhres if ind_snf_use_12m==0, matcell(sr) //self report only, no claims
mat nh_adl2[1,2]=sr[2,1]
tab ind_snf_use_12m if nhres==0, matcell(cl) //claims only, no sr
mat nh_adl2[1,3]=cl[2,1]
tab nhres if ind_snf_use_12m==1, matcell(srcl) //self report and claims
mat nh_adl2[1,4]=srcl[2,1]

local r=2
foreach v of varlist adl_impair_core ind_em_ur_adm_12m ind_hosp_adm_12m{

tab `v' if smi_nh_ind==1, matcell(crit2)
mat nh_adl2[`r',1]=crit2[2,1]
mat nh_adl2[`r'+1,1]=(nh_adl2[`r',1])/(nh_adl2[1,1])*100
mat nh_adl2[`r'+2,1]=crit2[1,1]
mat nh_adl2[`r'+3,1]=(nh_adl2[`r'+2,1])/(nh_adl2[1,1])*100


tab `v' if nhres==1 & ind_snf_use_12m==0, matcell(sr2)
mat nh_adl2[`r',2]=sr2[2,1]
mat nh_adl2[`r'+1,2]=(nh_adl2[`r',2])/(nh_adl2[1,2])*100
mat nh_adl2[`r'+2,2]=sr2[1,1]
mat nh_adl2[`r'+3,2]=(nh_adl2[`r'+2,2])/(nh_adl2[1,2])*100


tab `v' if ind_snf_use_12m==1 & nhres==0, matcell(cl2)
mat nh_adl2[`r',3]=cl2[2,1]
mat nh_adl2[`r'+1,3]=(nh_adl2[`r',3])/(nh_adl2[1,3])*100
mat nh_adl2[`r'+2,3]=cl2[1,1]
mat nh_adl2[`r'+3,3]=(nh_adl2[`r'+2,3])/(nh_adl2[1,3])*100


tab `v' if ind_snf_use_12m==1 & nhres==1, matcell(srcl2)
mat nh_adl2[`r',4]=srcl2[2,1]
mat nh_adl2[`r'+1,4]=(nh_adl2[`r',4])/(nh_adl2[1,4])*100
mat nh_adl2[`r'+2,4]=srcl2[1,1]
mat nh_adl2[`r'+3,4]=(nh_adl2[`r'+2,4])/(nh_adl2[1,4])*100

local r = `r'+4
}


frmttable using `logpath'\sic_Table2_criteria, statmat(nh_adl2) ///
title("Serious illness cohort, nursing home criteria vs ADL impairment") ///
ctitle("","SR and/or Claims" "Self report NH use only" "SNF Claims only" "SR and Claims") ///
rtitle("N" \ "ADL Impairment, n" \ "Percent" \ "ADL Independent, n" \ "Percent" \ ///
"Urgent or Emergency Hospital Admit, n" \ "Percent" \ "No, n" \ "Percent" \ ///
"Any Hospital Admit, n" \ "Percent" \ "No, n" \ "Percent" ) ///
sdec(0 \ 0 \ 2 \ 0 \ 2 \ 0 \ 2 \ 0 \ 2 \ 0 \ 2 \ 0 \ 2) addtable

tab criteria_b, missing

**********************************************************************************

//collapse dataset to look at unique R's that meet each of the criteria
collapse core_year `smi_vars' smi_nh_ind ,by(id)

mat criteria_r=J(19,2,.)

sum core_year
sca sample_r=r(N)
mat criteria_r[1,1]=r(N)

local j=2
foreach v in `smi_vars' {
replace `v'=1 if `v'>0 & `v'!=.
tab `v',matcell(x1_`j')
mat criteria_r[`j',1]=x1_`j'[2,1]
mat criteria_r[`j',2]=x1_`j'[2,1]/sample_r*100
local j = `j'+1
}

mat list criteria_r

frmttable using `logpath'\sic_Table2_criteria, statmat(criteria_r) ///
title("Serious illness cohort, criteria, respondent level") ///
ctitle("","N Respondents","% respondents") ///
rtitle("Overall n R's" \"Dementia"\ "Cancer" \"ESRD" \"CHF" \"COPD" \"Diabetes" \ ///
"Liver disease"\ "ALS"\ "Hip fracture"\ "Any serious medical illness"\ "2 or more SMI's"\ ///
"ADL Impairment"\ "Med Ill and ADL Impairment" \"Med Ill and/or ADL Impairment"\ ///
"Med Ill and/or ADL Imp + SNF"\ ///
"Med Ill and/or ADL Imp + Hosp"\ "Med Ill and/or ADL Imp + SNF or Hosp"\ ///
"Med Ill and ADL Imp + SNF or Hosp") ///
sdec(0,2) addtable

log close


H="Step 8aa - Determine ffs medicare 1 year after interview"
/*This section checks for ffs medicare the 1 year after each
core interview or until death if that is within 1 year. 
This will be a check when looking at the 1 year
outcomes to make sure we have full claims datasets 
in the 1 year post-interview
*/

/*get list of beneficiaries that meet the sample criteria 1yr pre interview*/
proc sql;
create table meet_pre(keep=id bid_hrs c_ivw_year c_ivw_month 
	c_ivw_date core_year death_date core_to_death) as 
select * from sic_int.core_ids_1yr_criteria_5
where age_ge_65=1 and xwalk_yes=1 and part_ab_12m=1 and hmo_d_12m=0 
and core_year in (2000,2002,2004,2006,2008,2010);
quit;

/*get months from core until death date where relevant*/
data meet_pre2;
set meet_pre;
*core_to_death is years so convert to months;
if death_date~=. then do;
	death_mo = month(death_date);
	death_yr = year(death_date);
	if death_yr=c_ivw_year then core_to_death_mos=death_mo-c_ivw_month+1;
	if death_yr=1+c_ivw_year then core_to_death_mos=death_mo+(13-c_ivw_month);
end; 
*if core_to_death<=(1 + 1/12) & core_to_death~=. then core_to_death_mos = floor((death_date-c_ivw_date) / 30.5);
*if core_to_death_mos<0 & core_to_death_mos~=. then core_to_death_mos=0;
run;

proc freq; table core_to_death_mos; run;

proc sort data=medi.dn_2000_2010 out=dn_2000_20102  nodupkey;
by BID_HRS_19 year;
run;

/*get medicare and hmo status variables from the dn file
for the year of the core interview*/
proc sql;
create table dn_core_y as select
a.*,b.buyin12,b.year,b.HMOIND12
from meet_pre2 a inner join
dn_2000_20102 b
on trim(left(a.BID_hrs))=trim(left(b.BID_hrs_19))
and a.c_ivw_year=b.year;
quit;

proc freq data=dn_core_y ;
table c_ivw_year c_ivw_month ;
run;

/*10882 r's have at least 1 interview with a denominator file linked*/
proc sql;
select count(distinct BID_hrs) from dn_core_y ;
quit;

/*trim variables to show status month of interview and later
these are all interviews with full info 12m before, so don't 
have to check for missing months in the variable*/
data dn_core_y2;
set dn_core_y;
if length(trim(left(buyin12)))=12 and c_ivw_month>0 then do;
buyin_dy=substr(trim(left(buyin12)),c_ivw_month,(13-c_ivw_month));
hmo_dy=substr(trim(left(HMOIND12)),c_ivw_month,(13-c_ivw_month));
end;
else do;
buyin_dy=trim(left(buyin12));
hmo_dy=trim(left(HMOIND12));
end;
format c_ivw_date date9.;
run;
proc means n;
var  c_ivw_month;
run;

/*Get info for year after interview to fill in remainder of the 12m period*/
/*n=27613 have +1 year dn file*/
proc sql;
create table dn_core_y_aft as select
a.BID_hrs,a.c_ivw_year ,
b.year as c_ivw_year_aft,
b.year,b.buyin12,b.HMOIND12
from dn_core_y a inner join
dn_2000_20102 b
on trim(left(a.BID_hrs))=trim(left(b.BID_hrs_19))
and -1<=a.c_ivw_year-b.year<0 order by bid_hrs,c_ivw_year;
quit;

proc sql;
create table all_insurance as select a.*,b.year as year_aft_civw, 
b.buyin12 as buyin_aft,b.HMOIND12 as hmo_aft from
dn_core_y2 a
left join
dn_core_y_aft b
on trim(left(a.BID_hrs))=trim(left(b.BID_hrs)) 
and a.c_ivw_year=b.c_ivw_year;
quit;

proc freq data=all_insurance;
table c_ivw_year*year_aft_civw /missprint;
run;

/*trim year after if its the death year*/
data data all_insurance1;
set all_insurance;
if year_aft_civw=death_yr & year_aft_civw~=. then do;
	buyin_aft=substr(trim(left(buyin_aft)),1,death_mo);
	hmo_aft=substr(trim(left(hmo_aft)),1,death_mo);
end;
run;

/*merge interview year and year after interview buy-in and hmo variables
Trim so the final variable _12m is 12 months post-interview
Note: indicator variables for parts a and b and hmo are null if don't
have information for full 12 months post-interview*/
data all_insurance2;
set all_insurance1;
buyin_2y=trim(left(buyin_dy))||trim(left(buyin_aft));
hmo_2y=trim(left(hmo_dy))||trim(left(hmo_aft));

*************************************************;
** 12 month variables                          **;
*************************************************;
if length(buyin_2y)>12 then buyin_12m=substr(trim(left(buyin_2y)),1,13);
if length(hmo_2y)>12 then hmo_12m=substr(trim(left(hmo_2y)),1,13);

if length(buyin_2y)<13 & core_to_death_mos>=13 & core_to_death_mos~=. then buyin_12m="";
if length(hmo_2y)<13 & core_to_death_mos>=13 & core_to_death_mos~=. then hmo_12m="";

if length(buyin_2y)<13 & 0<core_to_death_mos<13 & core_to_death_mos~=. & length(buyin_2y)>=core_to_death_mos  then 
	buyin_12m=substr(trim(left(buyin_2y)),1,core_to_death_mos);
if length(hmo_2y)<13 & 0<core_to_death_mos<13 & core_to_death_mos~=. & length(hmo_2y)>=core_to_death_mos then 
	hmo_12m=substr(trim(left(hmo_2y)),1,core_to_death_mos);

/*create indicator variable for mc coverage 12 mo. 0=no, 1=yes*/
	/*for obs that dont die within the year*/
if length(buyin_12m)=13 then do;
	if indexc(buyin_12m,"0","1","2","A","B") then part_ab_12m_aft=0;
	if indexc(buyin_12m,"0","1","2","A","B")=0 then part_ab_12m_aft=1;
end;
	/*for obs that do die within the year*/
else if 0<length(buyin_12m)<=13 & length(buyin_12m)=core_to_death_mos & core_to_death_mos~=. then do;
	if indexc(buyin_12m,"0","1","2","A","B") then part_ab_12m_aft=0;
	if indexc(buyin_12m,"0","1","2","A","B")=0 then part_ab_12m_aft=1;
end;


if length(hmo_12m)=13 then do;
	if indexc(hmo_12m,"1","2","A","B","C") then hmo_d_12m_aft=1;
	if indexc(hmo_12m,"1","2","A","B","C")=0 then hmo_d_12m_aft=0;
end;

else if 0<length(hmo_12m)<=13 & length(hmo_12m)=core_to_death_mos & core_to_death_mos~=. then do;
	if indexc(hmo_12m,"1","2","A","B","C") then hmo_d_12m_aft=1;
	if indexc(hmo_12m,"1","2","A","B","C")=0 then hmo_d_12m_aft=0;
end;

run;

proc freq data=all_insurance2;
table part_ab_12m_aft hmo_d_12m_aft ; 
run;

/*part ab, hmo status, all don't have denominator files the year after the interview*/
data miss_12maft;
set all_insurance2;
if hmo_d_12m_aft=.;
run;

proc freq; table c_ivw_year year_aft_civw /missprint; run;

/*bring indicators into the main dataset*/
proc sql;
create table sic_int.core_ids_1yr_criteria_6 as select a.*,b.part_ab_12m_aft,b.hmo_d_12m_aft
 from
sic_int.core_ids_1yr_criteria_5 a left join
all_insurance2 b
on a.bid_hrs=b.bid_hrs and a.c_ivw_year=b.c_ivw_year;
quit;

proc freq data=sic_int.core_ids_1yr_criteria_6 ;
table part_ab_12m_aft*part_ab_12m hmo_d_12m_aft*hmo_d_12m /missprint;
run;

/*check of ffs medicare 1 year after interview*/
data check_aft;
set sic_int.core_ids_1yr_criteria_6;
if age_ge_65=1 & xwalk_yes=1 & part_ab_12m=1 and hmo_d_12m=0 
& core_year in (2000,2002,2004,2006,2008,2010);
run;

/*of n=32718 that meet sample selection criteria year preceding ivw 
n= 26627 (81.3%) also meet it 1 year after the interview

Many of these are bc they are 2010 interviews that don't have the 2011 denominator
file to follow up with, they also won't have a full set of claims 1 year
after the interview*/

proc freq; table part_ab_12m_aft*hmo_d_12m_aft /missprint; run;


H="Step 8a - Determine outcomes after meet criteria"
/*While still determining criteria, create variables looking at the 1 year
after interview for all interviews (regardless of when meet criteria)

Outcomes are:
1. Urgent or emergency hospital admissions 1 year after meet critera
2. Hospice enrollment 1 year after meet criteria
3. Total Medicare payments 1 year after meet criteria

Note: Final dataset is set of interviews that meet ffs mc 1 year and age 65+
with outcomes added
*/

/*proc printto new log='&logdir.\sas_11_sic_outcomes_log.log'
	print='&logdir.\sas_11_sic_outcomes_out.lst' 
run;*/

/*ids of those interviews with ffs medicare year preceding interview and 65+*/
proc sql;
create table age_ge_65_mc as 
select * from sic_int.core_ids_1yr_criteria_6 
where age_ge_65=1 and xwalk_yes=1 and part_ab_12m=1 and hmo_d_12m=0 
and core_year in (2000,2002,2004,2006,2008,2010);
quit;

proc freq; table core_to_dod_1yr; run;

data age_ge_65_mc_ltd;
set age_ge_65_mc(keep=bid_hrs c_ivw_date core_year);
run;

/**********************************************************************/
/**********************************************************************/
*get claims 1 year after interview, all claim types;
/**********************************************************************/
/**********************************************************************/
/*medpar claims
List of claims with some time within 1 year of interview*/
%macro mp(days_start=,days_after_core=,source=,time_label=);

proc sql;
create table &source._meet_post as select a.*,b.c_ivw_date,b.core_year
from medi.&source._2000_2010 a inner join
age_ge_65_mc_ltd b
on trim(left(a.bid_hrs_19))=trim(left(b.bid_hrs))
and &days_start<=a.disch_date-b.c_ivw_date<=&days_after_core;
quit;

proc sql;
create table &source._meet2_post as select a.*,b.c_ivw_date,b.core_year
from medi.&source._2000_2010 a inner join
age_ge_65_mc_ltd b
on trim(left(a.bid_hrs_19))=trim(left(b.bid_hrs))
and a.disch_date-b.c_ivw_date>&days_after_core and a.admit_date-b.c_ivw_date<=&days_after_core;
quit;

data sic_int.&source._meet3_post_&days_after_core.;
set &source._meet_post &source._meet2_post;
format admit_date date9. disch_date date9.;
run;

%mend;

/*otherclaims, Just keep payment info to limit size of dataset
Pull list of any claims with admission date within 1 year of the interview*/
%macro other(days_start=,days_after_core=,source= );

proc sql;
create table sic_int.&source._meet_post_&days_after_core. as select 
a.*,b.c_ivw_date,b.core_year
from medi.&source._2000_2010(keep=admit_date BID_hrs_19 pmt_amt) a inner join
age_ge_65_mc_ltd b
on trim(left(a.bid_hrs_19))=trim(left(b.bid_hrs))
and &days_start<=a.admit_date-b.c_ivw_date<=&days_after_core;
quit;

%mend;


%mp(days_start=0,days_after_core=365,source=mp );
%other(days_start=0,days_after_core=365,source=op );
%other(days_start=0,days_after_core=365,source=pb );
%other(days_start=0,days_after_core=365,source=hh );
%other(days_start=0,days_after_core=365,source=hs );
%other(days_start=0,days_after_core=365,source=dm );

/**********************************************************************/
/**********************************************************************/
/*Count of hospital admissions 1 year after interview
Use suffix p12m to indicate post interview*/
/**********************************************************************/
/**********************************************************************/
%macro admissions(days=,suffix=);
/*pull list of ip claims from all medpar claims x days after interview*/
data ip_meet_post_&days.;
set sic_int.mp_meet3_post_&days.(where=(trim(left(SSLSSNF))~="N"));
*if admit_date>=c_ivw_date;
run;

data ip_post_&days._2;
set ip_meet_post_&days.;
em_urgent_admit=0; /*Urgent , emergent admissions from admission type*/
if type_adm in (1,2) then em_urgent_admit=1;
em_admit=0;
if type_adm=1 then em_admit=1;
urgent_admit=0;
if type_adm=2 then urgent_admit=1;
elect_admit=0;
if type_adm=3 then elect_admit=1;
ind_ed_charge=0; /*ED charges as another indicator of ED use*/
if ER_AMT>0 & ER_AMT~=. then ind_ed_charge=1;
if ER_AMT=0 | ER_AMT=. then ind_ed_charge=0;

*truncate admit and discharge dates to get all days within the window;
admit_trunc=0;
disch_trunc=0;
if admit_date<c_ivw_date then do;
	admit_date=c_ivw_date;
	admit_trunc=1;
end;
if disch_date-c_ivw_date>&days. then do;
	disch_date=c_ivw_date+&days.;
	disch_trunc=1;
end;
adj_los=disch_date-admit_date;
if disch_date-admit_date=0 then adj_los=1;
run;

proc sort data=ip_post_&days._2;
by BID_hrs_19 core_year;
run;

proc sql;
create table ip_post_&days._3 as select distinct BID_hrs_19,core_year,
/*count of IP admissions, all types*/
count(*) as n_ip_admit_&suffix. label="total n of hospital admit &suffix. after core ivw",
/*count of nights in hospital*/
sum(adj_los) as n_hospd_&suffix. label="total n of hospital nights &suffix. after core ivw",
/*count urgent or emergency admissions*/
count(case when em_urgent_admit=1 then em_urgent_admit else . end) as n_em_urgent_admit_&suffix. 
	label="total n of urgent/emergent hospital admit &suffix. after core ivw",
/*count of emergency admissions, from admission type code*/
count(case when em_admit=1 then em_admit else . end) as n_em_admit_&suffix. 
	label="total n of emergent hospital admit &suffix. after core ivw",
/*count of urgent admissions, from admission type code*/
count(case when urgent_admit=1 then urgent_admit else . end) as n_urgent_admit_&suffix. 
	label="total n of urgent hospital admit &suffix. after core ivw",
/*count of elective admissions, from admission type code*/
count(case when elect_admit=1 then elect_admit else . end) as n_elect_admit_&suffix. 
	label="total n of elective hospital admit &suffix. after core ivw",
/*count of admissions with any ED charges*/
count(case when ind_ed_charge=1 then ind_ed_charge else . end) as n_ED_ip_&suffix. 
	label="total n of ED visits with subsequent admit &suffix. after core ivw",
sum(admit_trunc) as adm_trunc_ind_&suffix.
	label="admit before interview indicator, counted as both pre and post admit"

 from ip_post_&days._2 group by BID_hrs_19,core_year;
quit;

data ip_post_&days._4;
set ip_post_&days._3;
if adm_trunc_ind_&suffix.>1 then adm_trunc_ind_&suffix.=1;
run;

%mend;

%admissions(days=365,suffix=p12m);

proc sql;
create table core_ids_admit_post_1 as select a.*,
b.n_ip_admit_p12m,b.adm_trunc_ind_p12m,b.n_hospd_p12m,
b.n_em_urgent_admit_p12m,b.n_em_admit_p12m,
b.n_urgent_admit_p12m,b.n_elect_admit_p12m,b.n_ED_ip_p12m
from age_ge_65_mc_ltd(drop=c_ivw_date) a
left join
ip_post_365_4 b 
on trim(left(a.bid_hrs))=trim(left(b.bid_hrs_19)) and a.core_year=b.core_year;
quit;

/*Since dataset is just those with ffs mc 1 year preceeding the
core interview, replace admit info with 0 if missing b/c there were no ip claims*/
 data core_ids_admit_post_2;
 set core_ids_admit_post_1;
 array list 
	n_ip_admit_p12m n_hospd_p12m n_em_urgent_admit_p12m
	n_em_admit_p12m n_urgent_admit_p12m n_elect_admit_p12m n_ED_ip_p12m;
 do over list;
 if list=. then list=0;
 end;

 if n_ip_admit_p12m=0 then ind_hosp_adm_p12m=0;
 if n_ip_admit_p12m>0 & n_ip_admit_p12m~=. then ind_hosp_adm_p12m=1;
 label ind_hosp_adm_p12m="Indicator for any hospital admission 12m after core";

 if n_em_urgent_admit_p12m=0 then ind_em_ur_adm_p12m=0;
 if n_em_urgent_admit_p12m>0 & n_em_urgent_admit_p12m~=. then ind_em_ur_adm_p12m=1;
 label ind_em_ur_adm_p12m="Ind any urgent or emergent hospital admission 12m after core";

 if n_em_admit_p12m=0 then ind_em_adm_p12m=0;
 if n_em_admit_p12m>0 & n_em_admit_p12m~=. then ind_em_adm_p12m=1;
 label ind_em_adm_p12m="Ind any emergency hospital admission 12m after core";

 if n_urgent_admit_p12m=0 then ind_ur_adm_p12m=0;
 if n_urgent_admit_p12m>0 & n_urgent_admit_p12m~=. then ind_ur_adm_p12m=1;
 label ind_ur_adm_p12m="Ind any urgent hospital admission 12m after core";

 if n_elect_admit_p12m =0 then ind_elect_adm_p12m=0;
 if n_elect_admit_p12m >0 & n_elect_admit_p12m ~=. then ind_elect_adm_p12m=1;
 label ind_elect_adm_p12m="Ind any elective hospital admission 12m after core";

 if (n_ip_admit_p12m - n_elect_admit_p12m)=0 then ind_nonelect_adm_p12m=0;
 if (n_ip_admit_p12m - n_elect_admit_p12m)>0 & n_elect_admit_p12m~=. then ind_nonelect_adm_p12m=1;
 label ind_nonelect_adm_p12m="Ind any non-elective hospital admission 12m after core";

 n_nonelect_adm_p12m=(n_ip_admit_p12m - n_elect_admit_p12m);
 label n_nonelect_adm_p12m="total n non-elective ip admit 12m after core";

 if n_ED_ip_p12m=0 then ind_ED_adm_p12m=0;
 if n_ED_ip_p12m>0 & n_ED_ip_p12m~=. then ind_ED_adm_p12m=1;
 label ind_ED_adm_p12m="Ind ED use with hospital admission 12m after core, from charges";

run;

proc freq;
table n_ip_admit_p12m adm_trunc_ind_p12m n_hospd_p12m ind_hosp_adm_p12m n_em_urgent_admit_p12m ind_em_ur_adm_p12m
	ind_em_adm_p12m ind_ur_adm_p12m ind_nonelect_adm_p12m n_nonelect_adm_p12m n_ED_ip_p12m ind_ED_adm_p12m 
	ind_em_adm_p12m*ind_ED_adm_p12m /missprint;
run;

/**********************************************************************/
/**********************************************************************/
/*Indicator of any hospice enrollment after interview
Use suffix p12m to indicate post interview*/
/**********************************************************************/
/**********************************************************************/
/*check of hospice claim list*/
data hospice_check;
set sic_int.hs_meet_post_365;
ivw_to_admit=admit_date-c_ivw_date;
run;
proc means; var ivw_to_admit;run;

%macro hospice(days=,suffix=);

proc sort data=sic_int.hs_meet_post_&days.;
by bid_hrs_19;
run;

/*just keep 1 claim per beneficiary since only need indicator of hospice use*/
data hs_meet_post_2_&days.;
set sic_int.hs_meet_post_&days.;
by bid_hrs_19;
if first.bid_hrs_19;
hs_admit_&suffix.=1;
label hs_admit_&suffix.="Hospice admission &suffix. after interview";
run;

%mend;

%hospice(days=365,suffix=p12m);

*merge hospice indicator with full dataset;
proc sql;
create table core_ids_admit_hs_post_2 as select a.*,b.hs_admit_p12m from
core_ids_admit_post_2 a left join
hs_meet_post_2_365 b
on trim(left(a.bid_hrs))=trim(left(b.bid_hrs_19)) and a.core_year=b.core_year;
quit;

proc freq; table hs_admit_p12m; run;

/*replace with 0 when have full info but no hospice claims
core interview*/
data core_ids_admit_hs_post_3 ;
set core_ids_admit_hs_post_2 ;
if hs_admit_p12m=. then hs_admit_p12m=0;
run;
proc freq; table hs_admit_p12m; run;

/*bring new outcomes variables into full interview dataset for those with ffs medicare */
proc sql;
create table sic_int.core_ids_init_outcomes(drop=bid_hrs2 core_year2)
as select * from
age_ge_65_mc a left join
core_ids_admit_hs_post_3(rename=(bid_hrs=bid_hrs2) rename=(core_year=core_year2)) b
on a.bid_hrs=b.bid_hrs2 and a.core_year=b.core_year2;
quit;

proc contents; run;

proc freq; table core_year; run;

proc freq; table hs_admit_p12m; run;

proc freq;
table n_ip_admit_p12m adm_trunc_ind_p12m n_hospd_p12m ind_hosp_adm_p12m n_em_urgent_admit_p12m ind_em_ur_adm_p12m
	ind_em_adm_p12m ind_ur_adm_p12m ind_nonelect_adm_p12m n_nonelect_adm_p12m n_ED_ip_p12m ind_ED_adm_p12m 
	ind_em_adm_p12m*ind_ED_adm_p12m /missprint;
run;



H="Step 8b - Get Medicare payments 1 year after interview"
/*Add total Medicare payments from claims 1 year after interview*/

/*Claims files from 2000-2010, claims pulled in previous section
to get just claims that are within 1 year of the interview dates
for those interviews were r>65 and ffs medicare 1 yr prior to ivw*/

/**********************************************************/
/**********************************************************/
/*totals from mp file*/
/*Note: variable SSLSSNF from mp claims is N=Skilled nursing facility*/
/*Two totals are calculated - one for skilled nursing facility claims
and one for all other claims in the mp file (inpatient claims)*/
/**********************************************************/
/**********************************************************/

/*get count of snf vs ip claims from claim list */
data snf_all;
set sic_int.mp_meet3_post_365(where=(trim(left(SSLSSNF))="N")) ;
ivw_to_admit=admit_date-c_ivw_date;
ivw_to_disch=disch_date-c_ivw_date;
run;

proc means; var ivw_to_admit ivw_to_disch; run;

data ip_all;
set sic_int.mp_meet3_post_365(where=(trim(left(SSLSSNF))~="N")) ;
run;


%macro mp(month_n=,days_start=,days_after_core=,source=,equ=,name=);
%let source0=mp;

/*Case 1 - no adjustment needed - claims where entire claim is within the x months after the interview*/
proc sql;
create table &source._meet_post_1 as select *
from sic_int.&source0._meet3_post_&days_after_core.(where=(trim(left(SSLSSNF))&equ.="N")) 
where &days_start<=disch_date-c_ivw_date<=&days_after_core and
&days_start<=admit_date-c_ivw_date<=&days_after_core;
quit;

data zz_&source._meet_post_1;
set &source._meet_post_1;
ivw_to_admit=admit_date-c_ivw_date;
ivw_to_disch=disch_date-c_ivw_date;
run;
proc means; var ivw_to_admit ivw_to_disch; run;

/*Case 2 - adjustment needed because part of stay is in the window but part is after the window has ended
Claims with admission date within start of x months but discharge date is after the x month window*/
proc sql;
create table &source._meet2_post as select *
from sic_int.&source0._meet3_post_&days_after_core.(where=(trim(left(SSLSSNF))&equ.="N")) 
where disch_date-c_ivw_date>&days_after_core and 0<=admit_date-c_ivw_date<=&days_after_core;
quit;

data zz_&source._meet2_post;
set &source._meet2_post;
ivw_to_admit=admit_date-c_ivw_date;
ivw_to_disch=disch_date-c_ivw_date;
run;
proc means; var ivw_to_admit ivw_to_disch; run;


/*identify fraction of claims that span x month period that should be 
attributed to the x month period
by just using the fraction of time that was included in the span*/
data &source._meet3_post;
set &source._meet2_post;
pct_xm=((c_ivw_date+&days_after_core)-admit_date)/(disch_date-admit_date);
array list pmt_amt passthru;
do over list;
if list=. then list=0;
/*scale the partial claims by the time within the x month period*/
list=list*pct_xm;
end;

run;

/*Case 3 - adjustment needed because part of stay is in the window but part is before the window started
Claims with discharge date within start of x months but admit date is before the interview date*/
proc sql;
create table &source._meet4_post as select *
from sic_int.&source0._meet3_post_&days_after_core.(where=(trim(left(SSLSSNF))&equ.="N")) 
where disch_date-c_ivw_date<=&days_after_core and admit_date-c_ivw_date<&days_start;
quit;

data zz_&source._meet4_post;
set &source._meet4_post;
ivw_to_admit=admit_date-c_ivw_date;
ivw_to_disch=disch_date-c_ivw_date;
run;
proc means; var ivw_to_admit ivw_to_disch; run;


data &source._meet5_post;
set &source._meet4_post;
pct_xm=(disch_date-c_ivw_date)/(disch_date-admit_date);
array list pmt_amt passthru;
do over list;
if list=. then list=0;
/*scale the partial claims by the time within the x month period*/
list=list*pct_xm;
end;

run;

/*adjust for inflation, Uses CPI for Medical Services from 
BLS website, accessed 3/14/2014*/

/*create table merging both the claims fully in the 2 year period 
and those partially in that time
adjust for inflation here also*/
data &source._cost_post;
set &source._meet_post_1 &source._meet3_post &source._meet5_post;
array list pmt_amt passthru;
do over list;
if list=. then list=0;
end;

if year(admit_date)>=2010 then rate=1;
if year(admit_date)=2009 then rate=1.0350;
if year(admit_date)=2008 then rate=1.06823;
if year(admit_date)=2007 then rate=1.11347;
if year(admit_date)=2006 then rate=1.17287;
if year(admit_date)=2005 then rate=1.22119;
if year(admit_date)=2004 then rate=1.27983;
if year(admit_date)=2003 then rate=1.34381;
if year(admit_date)=2002 then rate=1.40392;
if year(admit_date)=2001 then rate=1.47492;
if year(admit_date)=2000 then rate=1.54589;
if year(admit_date)<=1999 then rate=1.61195;


&source._paid_by_mc=rate*(pmt_amt+passthru);
run;

*calculates total of mc charges for the claim type by hrs bid;
proc sql;
create table &source._pay_post as select distinct bid_hrs_19,core_year,
sum(&source._paid_by_mc) as &source._paid_by_mc 
from &source._cost_post group by BID_HRS_19,core_year;
quit;

*merges the totals above with the full interview list;
proc sql;
create table &source._&name. as select
a.BID_hrs,a.id,a.core_year,coalesce(b.&source._paid_by_mc,0) as &source._paid_by_mc_&name.
from sic_int.core_ids_init_outcomes a
left join
 &source._pay_post b
 on trim(left(a.BID_hrs))=trim(left(b.bid_hrs_19)) and a.core_year=b.core_year;
 quit;

 proc sort data=&source._&name. ;
 by BID_hrs core_year;
 run;
%mend;

/*Runs macro to get total for the SNF claims*/
%mp(days_start=0,days_after_core=365,source=snf,equ=,name=1yr );
/*Runs macro to get total for the inpatient (not SNF) claims*/
%mp(days_start=0,days_after_core=365,source=ip,equ=~,name=1yr );

/**********************************************************/
/**********************************************************/
/*totals from other claim types*/
/**********************************************************/
/**********************************************************/
/*macro to calculate totals for the claims that are not in medpar files*/
%macro all_other(source=,month_n=,days_start=,days_after_core=);

/*Adjust for inflation*/
data &source._meet2_post;
set sic_int.&source._meet_post_&days_after_core.;
/*adjust to 2010 dollars*/
if year(admit_date)>=2010 then rate=1;
if year(admit_date)=2009 then rate=1.0350;
if year(admit_date)=2008 then rate=1.06823;
if year(admit_date)=2007 then rate=1.11347;
if year(admit_date)=2006 then rate=1.17287;
if year(admit_date)=2005 then rate=1.22119;
if year(admit_date)=2004 then rate=1.27983;
if year(admit_date)=2003 then rate=1.34381;
if year(admit_date)=2002 then rate=1.40392;
if year(admit_date)=2001 then rate=1.47492;
if year(admit_date)=2000 then rate=1.54589;
if year(admit_date)<=1999 then rate=1.61195;

&source._paid_by_mc=rate*(pmt_amt);
run;

/*Calculate total mc payments by ID*/
proc sql;
create table &source._pay_post as select distinct BID_hrs_19,core_year,
sum(&source._paid_by_mc) as &source._paid_by_mc
from &source._meet2_post group by BID_hrs_19,core_year;
quit;

/*merge in mc totals with interview list*/
proc sql;
create table &source.&month_n._post as select
a.BID_hrs,a.id,a.core_year,coalesce(b.&source._paid_by_mc,0) as &source._paid_by_mc&month_n 
from sic_int.core_ids_init_outcomes a
left join
 &source._pay_post b
 on trim(left(a.BID_hrs))=trim(left(b.BID_hrs_19)) and a.core_year=b.core_year;
 quit;

 proc sort data=&source&month_n._post ;
 by BID_hrs core_year;
 run;
 %mend all_other;

/******************************************************************/
/* Run the macro over the mc claims files for 2 years prior to death*/
/******************************************************************/

 %all_other(source=op,month_n=_1yr,days_start=0,days_after_core=365);
  %all_other(source=pb,month_n=_1yr,days_start=0,days_after_core=365);
   %all_other(source=hh,month_n=_1yr,days_start=0,days_after_core=365);
    %all_other(source=hs,month_n=_1yr,days_start=0,days_after_core=365);
     %all_other(source=dm,month_n=_1yr,days_start=0,days_after_core=365);

/******************************************************************/
/* Adjust for the wage index */
/******************************************************************/
data ip_1yr_post ;
set ip_1yr ;
run;

data snf_1yr_post ;
set snf_1yr ;
run;

%macro wage_ind(source=);
*add wage index to the costs totals files;
proc sql;
create table &source._wi_1 as select a.*, b.wage_index_20102
from &source._1yr_post a left join
sic_int.core_lmt_xwalk_2 b
on a.BID_hrs=b.bid_hrs and a.core_year=b.core_year;
quit;

/*if wage index is missing, set to 1 and identify with an indicator variable*/
data &source._wi_2;
set &source._wi_1;
if wage_index_20102=. then do;
	wage_index_missing_yes = 1;
	wage_index_20102 = 1;
end;
&source._paid_by_mc_1yr_wi = &source._paid_by_mc_1yr / wage_index_20102;
run;

%mend;

%wage_ind(source=ip);
%wage_ind(source=snf);
 %wage_ind(source=op);
  %wage_ind(source=pb);
   %wage_ind(source=hh);
    %wage_ind(source=hs);
     %wage_ind(source=dm);


/******************************************************************/
/* Get totals across all claim types */
/******************************************************************/

*first merge into single dataset;
data mc_costs_all;
merge ip_wi_2 snf_wi_2 hh_wi_2 hs_wi_2 pb_wi_2 op_wi_2 dm_wi_2;
by BID_hrs core_year;
run;

/*48 obs have missing wage index*/
proc freq; table wage_index_missing_yes; run; 

data sic_int.mc_costs_1yr;
set mc_costs_all;
/*total not adjusted for wage index*/
tot_paid_by_mc_1yr=sum(of ip_paid_by_mc_1yr snf_paid_by_mc_1yr hh_paid_by_mc_1yr hs_paid_by_mc_1yr
pb_paid_by_mc_1yr op_paid_by_mc_1yr dm_paid_by_mc_1yr);

/*wage index adjusted*/
tot_paid_by_mc_1yr_wi=sum(of ip_paid_by_mc_1yr_wi snf_paid_by_mc_1yr_wi hh_paid_by_mc_1yr_wi hs_paid_by_mc_1yr_wi
pb_paid_by_mc_1yr_wi op_paid_by_mc_1yr_wi dm_paid_by_mc_1yr_wi);

/*total wage index adjusted*/
label tot_paid_by_mc_1yr="Medicare payment total 1 year following interview"
ip_paid_by_mc_1yr="IP Medicare payments 1 year following interview" 
snf_paid_by_mc_1yr="SNF Medicare payments 1 year following interview"
hh_paid_by_mc_1yr="Home health Medicare payments 1 year following interview" 
hs_paid_by_mc_1yr="Hospice Medicare payments 1 year following interview"
pb_paid_by_mc_1yr="Carrier Medicare payments 1 year following interview" 
op_paid_by_mc_1yr="OP Medicare payments 1 year following interview" 
dm_paid_by_mc_1yr="DME Medicare payments 1 year following interview"

tot_paid_by_mc_1yr_wi="WI adj Medicare payment total 1 year following interview"
ip_paid_by_mc_1yr_wi="WI adj IP Medicare payments 1 year following interview" 
snf_paid_by_mc_1yr_wi="WI adj SNF Medicare payments 1 year following interview"
hh_paid_by_mc_1yr_wi="WI adj Home health Medicare payments 1 year following interview" 
hs_paid_by_mc_1yr_wi="WI adj Hospice Medicare payments 1 year following interview"
pb_paid_by_mc_1yr_wi="WI adj Carrier Medicare payments 1 year following interview" 
op_paid_by_mc_1yr_wi="WI adj OP Medicare payments 1 year following interview" 
dm_paid_by_mc_1yr_wi="WI adj DME Medicare payments 1 year following interview"
;
run;

proc sort data=sic_int.core_ids_init_outcomes; by bid_hrs core_year; run;
proc sort data=sic_int.mc_costs_1yr; by bid_hrs core_year; run;


*merge into overall dataset*;
proc sql;
create table sic_int.core_ids_init_outcomes_2(drop=bid_hrs2 id2 core_year2 wi) as select * from
sic_int.core_ids_init_outcomes a left join
sic_int.mc_costs_1yr(rename=(bid_hrs=bid_hrs2) rename=(id=id2) rename=(core_year=core_year2) rename=(wage_index_20102=wi)) b
on trim(left(a.bid_hrs))=trim(left(b.bid_hrs2)) and a.core_year=b.core_year2;
quit;

proc means; 
var ip_paid_by_mc_1yr snf_paid_by_mc_1yr hh_paid_by_mc_1yr hs_paid_by_mc_1yr
pb_paid_by_mc_1yr op_paid_by_mc_1yr dm_paid_by_mc_1yr tot_paid_by_mc_1yr;
run;

proc means; 
var ip_paid_by_mc_1yr_wi snf_paid_by_mc_1yr_wi hh_paid_by_mc_1yr_wi hs_paid_by_mc_1yr_wi
pb_paid_by_mc_1yr_wi op_paid_by_mc_1yr_wi dm_paid_by_mc_1yr_wi tot_paid_by_mc_1yr_wi;
run;

proc means ; class part_ab_12m_aft; var ip_paid_by_mc_1yr snf_paid_by_mc_1yr hh_paid_by_mc_1yr hs_paid_by_mc_1yr
pb_paid_by_mc_1yr op_paid_by_mc_1yr dm_paid_by_mc_1yr tot_paid_by_mc_1yr;
run;

proc means ; class hmo_d_12m_aft; var ip_paid_by_mc_1yr snf_paid_by_mc_1yr hh_paid_by_mc_1yr hs_paid_by_mc_1yr
pb_paid_by_mc_1yr op_paid_by_mc_1yr dm_paid_by_mc_1yr tot_paid_by_mc_1yr;
run;



H="Step 9 - Identify interview where criteria is first met"
/*create variable that identifies first interview that the criteria is met
3 criteria used:
A) Any serious medical illness
B) Serious medical illness or ADL impairment AND either Urgent/Emerg hopspital admission
or nursing home use
C) Serious illness and ADL impairment and [NH resident and/or hospitalization]

Creates file with outcomes as well

Revised to add additional criteria
1. Serious illness 
2. ADL impairment 
3. Serious illness and ADL impairment
4. Serious illness and ADL impairment and nursing home resident
5. Serious illness and ADL impairment and hospitalization
6. Serious illness and/or ADL impairment and hospitalization but no nursing home resident*
*Want to see if this is very many R's. We think there aren't many R's that are nursing
home residents but haven't had a hospitalization

*/

/*proc printto new log='&logdir.\sas_12_sic_n0_log.log'
	print='&logdir.\sas_12_sic_n0_out.lst' 
run;*/

/***********    Criteria A    ************/
data ivw_meet_a;
set sic_int.core_ids_init_outcomes_2(keep=id criteria_a core_year) ;
if criteria_a=1;
run;

proc sort data=ivw_meet_a;
by id core_year;
run;

data ivw_meet_a_1;
set ivw_meet_a;
by id;
if first.id then ivw_meet_crit_a=1;
else ivw_meet_crit_a=0;
label ivw_meet_crit_a="Ind. 1st time meets Criteria A";
run;

proc freq; table ivw_meet_crit_a;
run;

/***********    Criteria B    ************/
data ivw_meet_b;
set sic_int.core_ids_init_outcomes_2(keep=id criteria_b core_year) ;
if criteria_b=1;
run;

proc sort data=ivw_meet_b;
by id core_year;
run;

data ivw_meet_b_1;
set ivw_meet_b;
by id;
if first.id then ivw_meet_crit_b=1;
else ivw_meet_crit_b=0;
label ivw_meet_crit_b="Ind. 1st time meets Criteria B";
run;

proc freq; table ivw_meet_crit_b;
run;

/***********    Criteria C    ************/
data ivw_meet_c;
set sic_int.core_ids_init_outcomes_2(keep=id criteria_c core_year) ;
if criteria_c=1;
run;

proc sort data=ivw_meet_c;
by id core_year;
run;

data ivw_meet_c_1;
set ivw_meet_c;
by id;
if first.id then ivw_meet_crit_c=1;
else ivw_meet_crit_c=0;
label ivw_meet_crit_c="Ind. 1st time meets Criteria C";
run;

proc freq; table ivw_meet_crit_c;
run;


/***********    Serious medical illness    ************/
data ivw_meet_smi;
set sic_int.core_ids_init_outcomes_2(keep=id ser_med_illness core_year) ;
if ser_med_illness=1;
run;

proc sort data=ivw_meet_smi;
by id core_year;
run;

data ivw_meet_smi_1;
set ivw_meet_smi;
by id;
if first.id then ivw_meet_crit_smi=1;
else ivw_meet_crit_smi=0;
label ivw_meet_crit_smi="Ind. 1st time meets serious medical illness";
run;

proc freq; table ivw_meet_crit_smi;
run;

/***********    ADL Impairment     ************/
data ivw_meet_adl;
set sic_int.core_ids_init_outcomes_2(keep=id adl_impair_core core_year) ;
if adl_impair_core=1;
run;

proc sort data=ivw_meet_adl;
by id core_year;
run;

data ivw_meet_adl_1;
set ivw_meet_adl;
by id;
if first.id then ivw_meet_crit_adl=1;
else ivw_meet_crit_adl=0;
label ivw_meet_crit_adl="Ind. 1st time meets ADL impairment";
run;

proc freq; table ivw_meet_crit_adl;
run;

/***********    Serious illness and ADL Impairment     ************/
data ivw_meet_smiadl;
set sic_int.core_ids_init_outcomes_2(keep=id adl_impair_core ser_med_illness core_year) ;
if ser_med_illness=1 & adl_impair_core=1;
run;

proc sort data=ivw_meet_smiadl;
by id core_year;
run;

data ivw_meet_smiadl_1;
set ivw_meet_smiadl;
by id;
if first.id then ivw_meet_crit_smiadl=1;
else ivw_meet_crit_smiadl=0;
label ivw_meet_crit_smiadl="Ind. 1st time meets serious med illness and ADL impairment";
run;

proc freq; table ivw_meet_crit_smiadl;
run;

/***********    Serious illness and ADL Impairment and Nursing Home Resident (no hospital)   ************/
data ivw_meet_smiadlnh;
set sic_int.core_ids_init_outcomes_2(keep=id adl_impair_core ser_med_illness smi_nh_ind ind_em_ur_adm_12m core_year) ;
if ser_med_illness=1 & adl_impair_core=1 & smi_nh_ind=1 & ind_em_ur_adm_12m=0;
run;

proc sort data=ivw_meet_smiadlnh;
by id core_year;
run;

data ivw_meet_smiadlnh_1;
set ivw_meet_smiadlnh;
by id;
if first.id then ivw_meet_crit_smiadlnh=1;
else ivw_meet_crit_smiadlnh=0;
label ivw_meet_crit_smiadlnh="Ind. 1st time meets serious med illness + ADL + NH";
run;

proc freq; table ivw_meet_crit_smiadlnh;
run;

/***********Serious illness and ADL Impairment and Urgent/Emergent Hospitalization (no NH) ************/
data ivw_meet_smiadlho;
set sic_int.core_ids_init_outcomes_2(keep=id adl_impair_core ser_med_illness ind_em_ur_adm_12m smi_nh_ind core_year) ;
if ser_med_illness=1 & adl_impair_core=1 & ind_em_ur_adm_12m=1 & smi_nh_ind=0 ;
run;

proc sort data=ivw_meet_smiadlho;
by id core_year;
run;

data ivw_meet_smiadlho_1;
set ivw_meet_smiadlho;
by id;
if first.id then ivw_meet_crit_smiadlho=1;
else ivw_meet_crit_smiadlho=0;
label ivw_meet_crit_smiadlho="Ind. 1st time meets serious med illness + ADL + Hospital";
run;

proc freq; table ivw_meet_crit_smiadlho;
run;

/***********Serious illness and ADL Impairment and Urgent/Emergent Hospitalization and NH ************/
data ivw_meet_smiadlhonh;
set sic_int.core_ids_init_outcomes_2(keep=id adl_impair_core ser_med_illness ind_em_ur_adm_12m smi_nh_ind core_year) ;
if ser_med_illness=1 & adl_impair_core=1 & ind_em_ur_adm_12m=1 & smi_nh_ind=1 ;
run;

proc sort data=ivw_meet_smiadlhonh;
by id core_year;
run;

data ivw_meet_smiadlhonh_1;
set ivw_meet_smiadlhonh;
by id;
if first.id then ivw_meet_crit_smiadlhonh=1;
else ivw_meet_crit_smiadlhonh=0;
label ivw_meet_crit_smiadlhonh="Ind. 1st time meets serious med illness + ADL + Hospital + NH";
run;

proc freq; table ivw_meet_crit_smiadlhonh;
run;

/***********Serious illness and/or ADL Impairment and Urgent/Emergent Hospitalization (no NH) ************/
data ivw_meet_aho;
set sic_int.core_ids_init_outcomes_2(keep=id criteria_a ind_em_ur_adm_12m smi_nh_ind core_year) ;
if criteria_a=1 & ind_em_ur_adm_12m=1 & smi_nh_ind=0 ;
run;

proc sort data=ivw_meet_aho;
by id core_year;
run;

data ivw_meet_aho_1;
set ivw_meet_aho;
by id;
if first.id then ivw_meet_crit_aho=1;
else ivw_meet_crit_aho=0;
label ivw_meet_crit_aho="Ind. 1st time meets Crit A + Hospital";
run;

proc freq; table ivw_meet_crit_aho;
run;


/***********    Merge indicators into single dataset    ************/
data crit_all(keep=id core_year ivw_meet_crit_a ivw_meet_crit_b ivw_meet_crit_c
ivw_meet_crit_smi ivw_meet_crit_adl ivw_meet_crit_smiadl ivw_meet_crit_smiadlnh ivw_meet_crit_smiadlho 
ivw_meet_crit_smiadlhonh  ivw_meet_crit_aho);
merge ivw_meet_a_1 ivw_meet_b_1 ivw_meet_c_1 ivw_meet_smi_1 ivw_meet_adl_1 ivw_meet_smiadl_1 
ivw_meet_smiadlnh_1 ivw_meet_smiadlho_1 ivw_meet_smiadlhonh_1  ivw_meet_aho_1;
by id core_year;
run;


/*merge in new variables with the overall dataset*/
proc sort data=sic_int.core_ids_init_outcomes_2 out=ivw_to_merge nodupkey; by id core_year; run;

proc sql;
create table ivws_crit(drop=id2 core_year2) as select * from
ivw_to_merge a left join
crit_all(rename=(id=id2) rename=(core_year=core_year2)) b
on a.id=b.id2 and a.core_year=b.core_year2;
quit;

data ivws_crit_1a;
set ivws_crit;
array list ivw_meet_crit_a ivw_meet_crit_b ivw_meet_crit_c ivw_meet_crit_smi
	ivw_meet_crit_adl ivw_meet_crit_smiadl ivw_meet_crit_smiadlnh
	ivw_meet_crit_smiadlho ivw_meet_crit_smiadlhonh ivw_meet_crit_aho ;
do over list;
if list=. & comorb_1_0_1yr~=. then list=0;
end;
run;

/*should be 5158 and 2901 and 1333*/
proc freq;
table ivw_meet_crit_a ivw_meet_crit_b ivw_meet_crit_c;
run;

/***********************************************************************/
/***********    Identify R's that never meet criteria       ************/
/***********************************************************************/

data ever_meet;
set ivws_crit_1a;
meet_abc=0;
if ivw_meet_crit_a=1 or ivw_meet_crit_b=1 or ivw_meet_crit_c=1 then do;
 meet_abc=1;
end;
run;

proc sort data=ever_meet;
by id core_year;
run;

proc sql;
create table ever_meet_2 as select distinct id,
sum(meet_abc) as total_meet_abc label="n ivws meet a b c"
from ever_meet group by id;
quit;

proc freq; table total_meet_abc; run;

data ever_meet_3;
set ever_meet_2;
ind_no_crit=0;
if total_meet_abc=0 then ind_no_crit=1;
label="Indicator R never meets criteria a,b,or c";
run;

/*bring into main dataset*/
proc sql;
create table sic_int.ivws_crit_1 as select a.*,b.ind_no_crit from
ivws_crit_1a a left join
ever_meet_3 b
on a.id=b.id;
quit;

proc freq; table ind_no_crit; run;
proc freq; table ivw_meet_crit_a*ind_no_crit ivw_meet_crit_b*ind_no_crit ivw_meet_crit_c*ind_no_crit; run;

/*initial look at outcomes from claims data*/

/*for Criteria A*/
data criteria_a;
set sic_int.ivws_crit_1;
if ivw_meet_crit_a=1;
run;

/*for Criteria B*/
data criteria_b;
set sic_int.ivws_crit_1;
if ivw_meet_crit_b=1;
run;

/*for Criteria C*/
data criteria_c;
set sic_int.ivws_crit_1;
if ivw_meet_crit_c=1;
run;


ods rtf body="E:\data\serious_ill\logs\outcomes_first_look.rtf";
title "Outcomes 1 year after initially meeting criteria A) Any serious medical illness and/or ADL Impair";
proc freq data=criteria_a;
table core_to_dod_1yr hs_admit_p12m ind_em_ur_adm_p12m;
run;
proc means data=criteria_a; 
vars ip_paid_by_mc_1yr ip_paid_by_mc_1yr_wi snf_paid_by_mc_1yr snf_paid_by_mc_1yr_wi 
hh_paid_by_mc_1yr hh_paid_by_mc_1yr_wi hs_paid_by_mc_1yr hs_paid_by_mc_1yr_wi
pb_paid_by_mc_1yr pb_paid_by_mc_1yr_wi op_paid_by_mc_1yr op_paid_by_mc_1yr_wi 
dm_paid_by_mc_1yr dm_paid_by_mc_1yr_wi tot_paid_by_mc_1yr tot_paid_by_mc_1yr_wi n_hospd_p12m; run;

title "Outcomes 1 year after initially meeting criteria B) Any ser med illness and/or ADL Impair + SNF and/or Hospital.";
proc freq data=criteria_b;
table core_to_dod_1yr hs_admit_p12m ind_em_ur_adm_p12m;
run;
proc means data=criteria_b; 
vars ip_paid_by_mc_1yr ip_paid_by_mc_1yr_wi snf_paid_by_mc_1yr snf_paid_by_mc_1yr_wi 
hh_paid_by_mc_1yr hh_paid_by_mc_1yr_wi hs_paid_by_mc_1yr hs_paid_by_mc_1yr_wi
pb_paid_by_mc_1yr pb_paid_by_mc_1yr_wi op_paid_by_mc_1yr op_paid_by_mc_1yr_wi 
dm_paid_by_mc_1yr dm_paid_by_mc_1yr_wi tot_paid_by_mc_1yr tot_paid_by_mc_1yr_wi n_hospd_p12m; run;

title "Outcomes 1 year after initially meeting criteria C) Any ser med illness and ADL Impair + SNF and/or Hospital.";
proc freq data=criteria_c;
table core_to_dod_1yr hs_admit_p12m ind_em_ur_adm_p12m;
run;
proc means data=criteria_c; 
vars ip_paid_by_mc_1yr ip_paid_by_mc_1yr_wi snf_paid_by_mc_1yr snf_paid_by_mc_1yr_wi 
hh_paid_by_mc_1yr hh_paid_by_mc_1yr_wi hs_paid_by_mc_1yr hs_paid_by_mc_1yr_wi
pb_paid_by_mc_1yr pb_paid_by_mc_1yr_wi op_paid_by_mc_1yr op_paid_by_mc_1yr_wi 
dm_paid_by_mc_1yr dm_paid_by_mc_1yr_wi tot_paid_by_mc_1yr tot_paid_by_mc_1yr_wi n_hospd_p12m; run;

ods rtf close;

/*export full dataset to Stata*/
proc export data=sic_int.ivws_crit_1
outfile="E:\data\serious_ill\int_data\ivws_crit_1.dta" replace;
run;


H="Looking at outcomes"
*********************************
//6/19/14 update - addtional table added to show a limited set of outcomes
//the first time R meets each of several combinations of the criteria components
*********************************

capture log close

clear all
set mem 500m
set more off

local logpath E:\data\serious_ill\logs
local datapath E:\data\serious_ill\int_data

log using "`logpath'\4-sic_initial_outcomes_1.txt", text replace

cd `datapath'

//use dataset with outcomes, just obs that meet interview sample inclusion criteria
use ivws_crit_1.dta if inlist(core_year,2000,2002,2004,2006,2008) & /// 
age_ge_65==1 & xwalk_yes==1 & part_ab_12m==1 & hmo_d_12m==0
*******************************************************************
//Table comparing outcomes for those with serious illness only, 
//adl impairment only, illness and adl impairment categories

//for n=46 observations where wage index is missing, it has been set to 1
//for the purposes of adjusting the medicare spending totals
sum core_year
sum core_year if wage_index_20102==.
tab wage_index_missing_yes, missing

//categorical variable for serious illness vs adl impairment
gen cat_smi_adl=.
replace cat_smi_adl=1 if ser_med_illness==0 & adl_impair_core==0
replace cat_smi_adl=2 if ser_med_illness==1 & adl_impair_core==0
replace cat_smi_adl=3 if ser_med_illness==0 & adl_impair_core==1
replace cat_smi_adl=4 if smi_and_adl==1
la var cat_smi_adl "Serious illness and/or adl impariment, categorical"
la def cat_smi_adl 1 "No serious illness or adl impairment" ///
2 "Serious medical illness but no adl impair" 3 "ADL impairment, no serious medical ill" ///
4 "Serious medical illness and adl impairment"
la val cat_smi_adl cat_smi_adl
tab cat_smi_adl core_year
tab cat_smi_adl ser_med_illness
tab cat_smi_adl adl_impair_core

//table of outcomes, interview level (so R may be represented 5x)
local outcome1 core_to_dod_1yr hs_admit_p12m ind_em_ur_adm_p12m

local outcome2 ip_paid_by_mc_1yr_wi snf_paid_by_mc_1yr_wi hh_paid_by_mc_1yr_wi hs_paid_by_mc_1yr_wi ///
pb_paid_by_mc_1yr_wi op_paid_by_mc_1yr_wi dm_paid_by_mc_1yr_wi tot_paid_by_mc_1yr_wi n_hospd_p12m

mat table1=J(34,4,.)
//first row, n for each category
tab cat_smi_adl,matcell(row1)
mat table1[1,1]=row1[1,1]
mat table1[1,2]=row1[2,1]
mat table1[1,3]=row1[3,1]
mat table1[1,4]=row1[4,1]

forvalues i=1/4{
local r=2
foreach v in `outcome1'{
	sum `v' if cat_smi_adl==`i', detail
	mat table1[`r',`i']=r(mean)
	mat table1[`r'+1,`i']=r(sd)
	local r=`r'+2 //populates rows 2-7 for indicator variable outcomes
	}

local r=8
foreach v in `outcome2'{
	sum `v' if cat_smi_adl==`i', detail
	mat table1[`r',`i']=r(mean)
	mat table1[`r'+1,`i']=r(p50)
	mat table1[`r'+2,`i']=r(sd)
	local r=`r'+3 //populates rows 8-34 for continuous variables
	}
}

mat rownames table1="N" "Died, mean" "SD" "Hospice enr, mean" "SD" "Emerg or urgent hosp admit, mean" "SD" ///
"IP Medicare payments, mean" "Median" "SD" "SNF Medicare payments, mean" "Median" "SD" ///
"HH Medicare payments, mean" "Median" "SD" "Hospice Medicare payments, mean" "Median" "SD" ///
"Carrier Medicare payments, mean" "Median" "SD" "OP Medicare payments, mean" "Median" "SD" ///
"DME Medicare payments, mean" "Median" "SD" "Total Medicare payments, mean" "Median" "SD" ///
"Hospital nights, mean" "Median" "SD"

mat colnames table1="No ser med ill or impair" "Ser Med Ill" "ADL Impair" "SMI and ADL Impair"

frmttable using "`logpath'\sic_Table3_outcomes", statmat(table1) ///
title("Comparison of outcomes at 1 year, serious medical illness vs ADL impairment" \ ///
"Interview level") ///
note("Medicare spending values are adjusted to 2010$ and for the CMS wage index.") ///
sdec(0\2\2\2\2\2\2\0) landscape replace

*******************************************************************
//Outcomes for first interview where meet criteria
*******************************************************************
mat table2=J(34,3,.)
//first row, n for each category
tab ivw_meet_crit_a ,matcell(row1a)
mat table2[1,1]=row1a[2,1]
tab ivw_meet_crit_b ,matcell(row1b)
mat table2[1,2]=row1b[2,1]
tab ivw_meet_crit_c ,matcell(row1c)
mat table2[1,3]=row1c[2,1]

local c=1
foreach crit of varlist ivw_meet_crit_a ivw_meet_crit_b ivw_meet_crit_c {
local r=2
foreach v in `outcome1'{
	sum `v' if `crit'==1, detail
	mat table2[`r',`c']=r(mean)
	mat table2[`r'+1,`c']=r(sd)
	local r=`r'+2 //populates rows 2-7 for indicator variable outcomes
	}

local r=8
foreach v in `outcome2'{
	sum `v' if `crit'==1, detail
	mat table2[`r',`c']=r(mean)
	mat table2[`r'+1,`c']=r(p50)
	mat table2[`r'+2,`c']=r(sd)
	local r=`r'+3 //populates rows 8-34 for continuous variables
	}
local c=`c'+1	
}

mat rownames table2="N" "Died, mean" "SD" "Hospice enr, mean" "SD" "Emerg or urgent hosp admit, mean" "SD" ///
"IP Medicare payments, mean" "Median" "SD" "SNF Medicare payments, mean" "Median" "SD" ///
"HH Medicare payments, mean" "Median" "SD" "Hospice Medicare payments, mean" "Median" "SD" ///
"Carrier Medicare payments, mean" "Median" "SD" "OP Medicare payments, mean" "Median" "SD" ///
"DME Medicare payments, mean" "Median" "SD" "Total Medicare payments, mean" "Median" "SD" ///
"Hospital nights, mean" "Median" "SD"

frmttable using "`logpath'\sic_Table3_outcomes_ivw", statmat(table2) ///
title("Comparison of outcomes at 1 year, criteria a vs b" \ ///
"First interview when R meets criteria") ///
ctitle("" "Criteria A" "Criteria B" "Criteria C" \ "" "Serious med illness and/or" ///
"SMI and/or ADL impair and" "SMI and ADL impair and" ///
\ "" "ADL impairment" "SNF and/or Hospital use" "SNF and/or Hospital use") ///
note("Medicare spending values are adjusted to 2010$ and for the CMS wage index.") ///
sdec(0\2\2\2\2\2\2\0) replace 

*******************************************************************
//Select Outcomes for first interview where meet criteria
//Criteria comparison
*******************************************************************
//table of outcomes, interview where R first meets criteria
local outcome1 core_to_dod_1yr hs_admit_p12m ind_em_ur_adm_p12m ip_paid_by_mc_1yr_wi ///
tot_paid_by_mc_1yr_wi

local compvars ivw_meet_crit_smi ivw_meet_crit_adl ivw_meet_crit_smiadl ivw_meet_crit_a ///
ivw_meet_crit_smiadlnh ivw_meet_crit_smiadlho ivw_meet_crit_smiadlhonh ///
ivw_meet_crit_c ivw_meet_crit_aho ivw_meet_crit_b 

//overall sample, n interviews
sum core_year
local nsamp=r(N)

mat comp_N_c1=J(10,3,.)
mat comp=J(10,15,.)

//first column, get n for each subgroup
local r=1
foreach comp in `compvars'{
	sum core_year if `comp'==1, detail
	mat comp_N_c1[`r',1]=r(N)
	local r=`r'+1
}

local c=1
foreach var in `outcome1'{
	local r=1
	foreach comp in `compvars'{
		sum `var' if `comp'==1, detail
		mat comp[`r',`c']=r(mean)
		mat comp[`r',`c'+1]=r(sd)
		mat comp[`r',`c'+2]=r(p50)
		local r=`r'+1
	}
local c=`c'+3
}
mat rownames comp_N_c1="Serious med illness" "ADL Impairment"  ///
 "Illness + ADL Impair" "Criteria A" "Illness + ADL + NH(no hosp)" "Illness + ADL + Hospital(no NH)" ///
 "Illness + ADL + NH + Hospital" "Ill + ADL + (Hospital and/or NH)" "Ill and-or ADL + Hospital(no NH)" ///
 "Criteria B"

mat rownames comp="Serious med illness" "ADL Impairment"  ///
"Illness + ADL Impair" "Criteria A" "Illness + ADL + NH(no hosp)" "Illness + ADL + Hospital(no NH)" ///
 "Illness + ADL + NH + Hospital" "Ill + ADL + (Hospital and/or NH)" "Ill and-or ADL + Hospital(no NH)" ///
 "Criteria B"

frmttable , statmat(comp_N_c1) substat(2) ///
title("Comparison of serious medical conditions, outcomes at 1 year" \ ///
"First interview where R meets the criteria") ///
ctitles("","N" ) ///
sdec(0) store(table3)

frmttable using "`logpath'\sic_Table3_outcomes_ivw", statmat(comp)  substat(2) ///
ctitles("","Died","Hospice admit","Hospital admit","IP Medicare","Total Medicare" \ ///
"","mean","","","","" \ "","(SD)", "","","","", \ "","[Median]","","","","" ) ///
note("Medicare spending values are adjusted to 2010$ and for the CMS wage index.") ///
sdec(2) merge(table3) addtable
*************************************************************
//look at comparison between criteria b with nursing home and/or hospitalization
//and just requiring hospitalization, is there much of a difference?
tab ivw_meet_crit_aho ivw_meet_crit_b, missing

*************************************************************


log close


H="Looking at Rs that never meet criteria a b or c"
data do_not_meet;
set sic_int.ivws_crit_1;
if ind_no_crit=0;
run;

ods rtf body="E:\data\serious_ill\logs\comparison_group.rtf";

title "Core interview years for those R's that never meet Criteria A B or C";
proc freq; table core_year; run;

/*get number of interviews per R
n=5158 R's that never meet criteria with at least 1 core interview, ffs mc 1 year before that ivw*/
proc sql;
create table do_not_meet_2 as select distinct id,
count(*) as ivw_count 
from do_not_meet group by id;
quit;

/*range from having 1-5 core interviews in the dataset*/
title"Number of core interviews, n=5158 R's that never meet criteria";
proc freq; table ivw_count; run;

/*what are the last core years we have represented for this group?*/
proc sort data=do_not_meet; by id core_year; run;

data last;
set do_not_meet;
by id;
if last.id;
run;

title "Year of last recorded core interview";
proc freq; table core_year; run;

ods rtf close;

H="Step 10 - Core interviews - set up from time 0=meet criteria"
/*From this point on, there are 3 datasets, one for those that
meet Criteria A) Serious medical illness and one for those that 
meet Criteria B) (Serious medical illness or ADL Impairment) and (nursing
home use or urgent/emergent hospital admission)
meet Criteria C) Serious medical illness and ADL Impairment and (nursing
home use and/or urgent/emergent hospital admission)

Datasets are saved as:
sic_fin.n0_n1_p1_p2_criteria_a
sic_fin.n0_n1_p1_p2_criteria_b
sic_fin.n0_n1_p1_p2_criteria_c

Contain the following interviews as denoted by variable suffix:
_n0 - when first meet criteria
_n1 - interview prior to first meeting criteria
_p1 and _p2 - 2 interviews after meeting criteria
*/

/*proc printto new log='&logdir.\sas_13_sic_ivw_time_log.log'
	print='&logdir.\sas_13_sic_ivw_time_out.lst' 
run;*/


*****************************************************;
*rename macro *;
*****************************************************;
%macro rename(lib,dsn,pre);
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "Before Renaming All Variables";
run;

proc sql noprint;
select nvar into :num_vars
from dictionary.tables
where libname="&LIB" and
memname="&DSN";
select distinct(name) into :var1-
:var%TRIM(%LEFT(&num_vars))
from dictionary.columns
where libname="&LIB" and
memname="&DSN";
quit;
run;

proc datasets library=&LIB;
modify &DSN;
rename
%do i=1 %to &num_vars;
&&var&i=&&var&i.._&pre 
%end;
;
quit;
run;
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "After Renaming All Variables";
run;
%mend rename;


****************************************************************;
/*set up datasets with reference time 0 = time initially meet criteria
time =0 has n0 suffix
interviews before have n1, n2, etc suffix
interviews after have p1, p2 suffix */
****************************************************************;

*drop variables from interview dataset that we don't need for the n1, p1, etc datasets;
*these are variables from the restricted dataset;
data core_to_use;
set sic_int.ivws_crit_1(drop=birth_date death_date white black hisp_eth native_amer 
asian_pi other_race other_na_api_race wage_index_2010
zip_0: zip_10: zip_98: first_ivw_year last_ivw_year restr_yes dod_claims cause_death_12_n);
run;

data core_all_drop;
set sic_int.core_ids_1yr_criteria_6(drop=birth_date death_date white black hisp_eth native_amer 
asian_pi other_race other_na_api_race wage_index_2010 
zip_0: zip_10: zip_98: first_ivw_year last_ivw_year restr_yes dod_claims cause_death_12_n);
run;

data core_educ_only;
set sic_int.core_ids_1yr_criteria_6(keep=id core_year c_ivw_date educ);
run;

*note interview counts listed are for criteria a dataset, they are different for criteria b,c;
%macro ds_restr(crit=);

*get ids, first time they met criteria;
data n0_&crit._1;
set sic_int.ivws_crit_1;
if ivw_meet_crit_&crit.=1;
run;

data TEST;
set n0_&crit._1(drop=zip_0: zip_10: zip_98:);
run;

*add _n0 suffix for interview variables for year that first meets criteria;
%rename(WORK,TEST,n0);

data n0_&crit._3;
set TEST;
rename id_n0=id;
rename bid_hrs_n0=bid_hrs;
run;

****************************************************************;
*get n1 interview, interiew prior to meeting criteria*;
*list of 4239 core interviews with ffs medicare 1 year prior before meeting the criteria*;
proc sql;
create table all_ivw_bef_meet_&crit.
as select b.*
 from n0_&crit._3 a 
 inner join
core_to_use b
  on a.id=b.id and a.c_ivw_date_n0>b.c_ivw_date;
  quit;

proc sort data=all_ivw_bef_meet_&crit. ;
by id c_ivw_date;
run;

*keep only the n1 core interview;
*2219 interviews identified that have ffs medicare 1 year prior to n1 interview;
data core_n1_&crit.;
set all_ivw_bef_meet_&crit.;
by id c_ivw_date;
if last.id;
run;

proc freq;
table core_year;
run;

*supplement the list with interviews with no or unknown ffs medicare 1 year;
*prior to interview in order to fill in for those with interviews in 2000;
proc sql;
create table noffsreq_ivw_bef_meet_&crit.
as select b.*
 from n0_&crit._3 a 
 inner join
core_all_drop b
  on a.id=b.id and a.c_ivw_date_n0>b.c_ivw_date;
  quit;

*5292 of the ivws are not in the list that already have the n1 ivw;
proc sql;
create table noffsreq_ivw_bef_meet_&crit._1 as select * from
noffsreq_ivw_bef_meet_&crit.
where id not in (select id from core_n1_&crit.);
quit;

proc sort data=noffsreq_ivw_bef_meet_&crit._1 ;
by id c_ivw_date;
run;

*keep only the n1 core interview;
*2110 interviews identified;
data noffsreq_core_n1_&crit.;
set noffsreq_ivw_bef_meet_&crit._1;
by id c_ivw_date;
if last.id;
run;

*append to get full list of 4329 n1 interviews;
data core_n1_&crit._1;
set core_n1_&crit. noffsreq_core_n1_&crit.;
run;

proc sort data=core_n1_&crit._1 nodupkey;
by id;
run;

*check on number of pre interviews present in the dataset;
*for those that meet the criteria;
proc sql;
create table ivw_count_before_&crit. as select distinct id,
count(*) as n_ivws_bef_&crit. label="n ivws before meet criteria &crit."
from 
all_ivw_bef_meet_&crit.  group by id;
quit;

proc freq; table n_ivws_bef_&crit.;
run;
****************************************************************;
*get n2 and n3 interviews to backfill education variable;
proc sql;
create table before_n1_&crit. 
as select b.*
 from core_n1_&crit._1 a
 inner join
core_educ_only b
  on a.id=b.id and a.c_ivw_date>b.c_ivw_date;
  quit;

proc sort data= before_n1_&crit. ;
by id c_ivw_date;
run;

*keep n2 core;
data core_n2_&crit.;
set before_n1_&crit.;
by id c_ivw_date;
if last.id;
run;

proc sql;
create table before_n2_&crit. 
as select b.*
 from core_n2_&crit. a
 inner join
before_n1_&crit. b
  on a.id=b.id and a.c_ivw_date>b.c_ivw_date;
  quit;

proc sort data= before_n2_&crit. ;
by id c_ivw_date;
run;

*keep n3 core;
data core_n3_&crit.;
set before_n2_&crit.;
by id c_ivw_date;
if last.id;
run;


****************************************************************;
*get p1 interview, interview after meeting criteria*;
*list of all core interviews after meeting the criteria*;
proc sql;
create table all_ivw_aft_meet_&crit.
as select b.*
 from n0_&crit._3 a 
 inner join
core_to_use b
  on a.id=b.id and a.c_ivw_date_n0<b.c_ivw_date;
  quit;

proc sort data=all_ivw_aft_meet_&crit. ;
by id c_ivw_date;
run;

*keep only the p1 core interview;
*2656 interviews identified;
data core_p1_&crit.;
set all_ivw_aft_meet_&crit.;
by id c_ivw_date;
if first.id;
run;

proc freq;
table core_year;
run;

*supplement the list with interviews with no or unknown ffs medicare 1 year;
*prior to interview in order to fill in missing p1 ivws;
proc sql;
create table noffsreq_ivw_aft_meet_&crit.
as select b.*
 from n0_&crit._3 a 
 inner join
core_all_drop b
  on a.id=b.id and a.c_ivw_date_n0<b.c_ivw_date;
  quit;

*416 of the ivws are not in the list that already have the p1 ivw;
proc sql;
create table noffsreq_ivw_aft_meet_&crit._1 as select * from
noffsreq_ivw_aft_meet_&crit.
where id not in (select id from core_p1_&crit.);
quit;

proc sort data=noffsreq_ivw_aft_meet_&crit._1 ;
by id c_ivw_date;
run;

*keep only the p1 core interview;
*298 interviews identified;
data noffsreq_core_p1_&crit.;
set noffsreq_ivw_aft_meet_&crit._1;
by id c_ivw_date;
if first.id;
run;

*append to get full list of 2954 p1 interviews;
data core_p1_&crit._1;
set core_p1_&crit. noffsreq_core_p1_&crit.;
run;

proc sort data=core_p1_&crit._1 nodupkey;
by id;
run;

*check on number of post-interviews present in the dataset;
*for those that meet the criteria;
proc sql;
create table ivw_count_after_&crit. as select distinct id,
count(*) as n_ivws_after_&crit. label="n ivws after meet criteria &crit."
from 
all_ivw_aft_meet_&crit.  group by id;
quit;

proc freq; table n_ivws_after_&crit.;
run;


****************************************************************;
*get p2 interview, interview after meeting criteria*;
*list of all core interviews after the p1 interview*;
proc sql;
create table all2_ivw_aft_meet_&crit.
as select b.*
 from core_p1_&crit. a 
 inner join
core_to_use b
  on a.id=b.id and a.c_ivw_date<b.c_ivw_date;
  quit;

proc sort data=all2_ivw_aft_meet_&crit. ;
by id c_ivw_date;
run;

*keep only the p2 core interview;
*1398 interviews identified;
data core_p2_&crit.;
set all2_ivw_aft_meet_&crit.;
by id c_ivw_date;
if first.id;
run;

proc freq;
table core_year;
run;

*rename the n1, p1 and p2 interviews*;

*n1 interview;
data TEST;
set core_n1_&crit._1 ;
run;

%rename(WORK,TEST,n1);
data core_n1_&crit._1;
set TEST;
rename id_n1=id;
rename bid_hrs_n1=bid_hrs;
run;

*n2 interview;
data TEST;
set core_n2_&crit. ;
run;

%rename(WORK,TEST,n2);
data core_n2_&crit._1;
set TEST;
rename id_n2=id;
run;

*n3 interview;
data TEST;
set core_n3_&crit. ;
run;

%rename(WORK,TEST,n3);
data core_n3_&crit._1;
set TEST;
rename id_n3=id;
run;

*p1 interview;
data TEST;
set CORE_P1_&crit._1;
run;
%rename(WORK,TEST,p1);
data core_p1_&crit._1;
set TEST;
rename id_p1=id;
rename bid_hrs_p1=bid_hrs;
run;

*p2 interview;
data TEST;
set CORE_P2_&crit.;
run;

%rename(WORK,TEST,p2);
data core_p2_&crit._1;
set TEST;
rename id_p2=id;
rename bid_hrs_p2=bid_hrs;
run;

*merge the datasets together*;
proc sort data=n0_&crit._3 nodupkey;
by id;
run;

proc sort data=core_n1_&crit._1 nodupkey;
by id;
run;

proc sort data=core_n2_&crit._1 nodupkey;
by id;
run;

proc sort data=core_n3_&crit._1 nodupkey;
by id;
run;

proc sort data=core_p1_&crit._1 nodupkey;
by id;
run;

proc sort data=core_p2_&crit._1 nodupkey;
by id;
run;

data sic_fin.n0_n1_p1_p2_criteria_&crit.;
merge n0_&crit._3 core_n1_&crit._1 core_n2_&crit._1 core_n3_&crit._1 core_p1_&crit._1 core_p2_&crit._1;
by id;
run;

%mend ds_restr;

%ds_restr(crit=a);
%ds_restr(crit=b);
%ds_restr(crit=c);


proc freq data=sic_fin.n0_n1_p1_p2_criteria_a;
table core_year_n3 core_year_n2 core_year_n1 core_year_n0 core_year_p1 core_year_p2;
run;

proc freq data=sic_fin.n0_n1_p1_p2_criteria_b;
table core_year_n3 core_year_n2 core_year_n1 core_year_n0 core_year_p1 core_year_p2;
run;

proc freq data=sic_fin.n0_n1_p1_p2_criteria_c;
table core_year_n3 core_year_n2 core_year_n1 core_year_n0 core_year_p1 core_year_p2;
run;


*************************************************************;
** Looking at who has missing n1 core interviews  ***********;
*************************************************************;
proc freq data=sic_fin.n0_n1_p1_p2_criteria_a;
table part_ab_12m_n1*hmo_d_12m_n1 part_ab_6m_n1*hmo_d_6m_n1 /missprint;
run;

data no_n1_core_1;
set sic_fin.n0_n1_p1_p2_criteria_a;
if core_year_n1=.;
run;

proc freq;
table core_year_n0 first_ivw_year_n0;
run;

*************************************************************;
** Looking at who has missing p1 core interviews  ***********;
*************************************************************;
data no_p1_core_1;
set sic_fin.n0_n1_p1_p2_criteria_a;
if core_year_p1=. & core_year_n0<2010;
if core_to_death_n0<=2 then core_to_dod_2yr_n0=1;
else core_to_dod_2yr_n0=0;
run;

/*45% died within 1 year of meeting criteria interview*/
proc freq;
table core_year_n0 first_ivw_year_n0 core_to_dod_1yr_n0 core_to_dod_2yr_n0;
run;

/*look at those that didn't die within 2 years n=80*/
data no_p1_core_2;
set no_p1_core_1;
if core_to_dod_2yr_n0=0;
run;

/*n=60 died within 2.5 years, can't be sure about remaining
next thing to do is to check exit interviews*/
proc freq; table core_to_death_n0 core_to_death_n0*core_year_n0 ; run;

/*why missing insurance status of 150 obs in p1 interview for criteria a dataset?
All interviewed in 2011 for p1, we don't have denominator file that year*/
data miss_ins_a_1;
set noffsreq_core_p1_a;
if part_ab_12m=.;
run;

proc freq;
table  core_year;
run;



H="Step 11 - Add exit interviews to dataset"
/*adds exit interview variables (with _x suffix) to the dataset that
is formatted with the n0 as time0 interview, etc.

Note for now, this just adds interview information, nothing pulled from claims
prior to death, may need to revisit this if we need outcomes prior to exit
interview*/

/*proc printto new log='&logdir.\sas_14_sic_exit_log.log'
	print='&logdir.\sas_14_sic_exit_out.lst' 
run;*/

data exit;
set hrs_fnl.exit_02_to_10_dt;
run;

proc sort data=exit out=EXIT_1;
by id;
run;

*rename with _x suffix;
%rename(WORK,EXIT_1,x);
data exit_2;
set exit_1;
rename id_x=id;
run;

/*use macro to do for criteria a  b and c datasets*/

%macro exit(crit=);

/*keep for those R's that meet criteria at some time*/
proc sql;
create table exit_meet_&crit. as select * 
from exit_2 
where id in (select id from sic_fin.n0_n1_p1_p2_criteria_&crit.);
quit;

proc sort data=exit_meet_&crit. nodupkey; by id; run;
proc sort data=sic_fin.n0_n1_p1_p2_criteria_&crit. out=ivws nodupkey; by id; run;

proc sql;
create table n0_n1_p1_p2_x_criteria_&crit._1(drop=id2) as select *  
from ivws a left join
exit_meet_&crit.(rename=(id=id2)) b
on a.id=b.id2;
quit;

*data n0_n1_p1_p2_x_criteria_&crit._1;
*merge ivws exit_meet_&crit.;
*run;

proc freq; table exit_year_x; run;

data sic_fin.n0_n1_p1_p2_x_criteria_&crit.;
set n0_n1_p1_p2_x_criteria_&crit._1;
if exit_year_x-core_year_n0=2 then ind_exit_p1_yes=1;
else ind_exit_p1_yes=0;
if exit_year_x-core_year_n0=4 then ind_exit_p2_yes=1;
else ind_exit_p2_yes=0;
label ind_exit_p1_yes="Exit interview in wave following n0 ivw";
label ind_exit_p2_yes="Exit interview in wave following p1 ivw";
run;

proc freq; 
table ind_exit_p1_yes*core_year_p1 ind_exit_p2_yes*core_year_p2 /missprint; 
run;

%mend exit;

%exit(crit=a);
%exit(crit=b);
%exit(crit=c);

/*export to Stata for remaining processing*/
proc export data=sic_fin.n0_n1_p1_p2_x_criteria_a
outfile="E:\data\serious_ill\final_data\n0_n1_p1_p2_x_criteria_a.dta" replace;
run;

proc export data=sic_fin.n0_n1_p1_p2_x_criteria_b
outfile="E:\data\serious_ill\final_data\n0_n1_p1_p2_x_criteria_b.dta" replace;
run;

proc export data=sic_fin.n0_n1_p1_p2_x_criteria_c
outfile="E:\data\serious_ill\final_data\n0_n1_p1_p2_x_criteria_c.dta" replace;
run;


H="Step 12 - Create additional variables, changes between ivws"
/*switched to Stata
Data cleaning, create new variables
Code can be run on either criteria a, b or c datasets, comments indicate
sections to be modified when switching between them*/

capture log close

clear all
set mem 500m
set more off

local crit a
//local crit b
//local crit c

local logpath E:\data\serious_ill\logs
local datapath E:\data\serious_ill\final_data

log using "`logpath'\4`crit'-sic_data_cleaning_crit_`crit'.txt", text replace

cd `datapath'

use n0_n1_p1_p2_x_criteria_`crit'.dta

tab core_year_n0, missing

*******************************************************************
//age when meet criteria
sum age_at_core_n0

gen age_cat_n0 = .
replace age_cat_n0 = 1 if age_at_core_n0<75
replace age_cat_n0 = 2 if age_at_core_n0>=75 & age_at_core_n0<85
replace age_cat_n0 = 3 if age_at_core_n0>=85 & age_at_core_n0!=.
la var age_cat_n0 "Age when meets criteria, categorical"
la def age_cat 1 "Age 65-74" 2 "Age 75-84" 3"Age 85+"
la val age_cat_n0 age_cat
tab age_cat_n0, missing

sum age_at_core_n0 if age_cat_n0 ==1
sum age_at_core_n0 if age_cat_n0 ==2
sum age_at_core_n0 if age_cat_n0 ==3

//female gender indicator variable
tab female_n0, missing

//create race and ethnicity categorical variable
//may want to backfill from claims and check this variable!
tab white_n0, missing
tab black_n0, missing
tab hisp_eth_n0, missing
tab native_amer_n0, missing
tab asian_pi_n0, missing
tab other_race_n0, missing
tab other_na_api_race_n0, missing

gen re_cat = .
replace re_cat = 1 if black_n0==1
replace re_cat = 3 if white_n0==1
replace re_cat = 2 if hisp_eth_n0==1
replace re_cat = 4 if native_amer_n0==1 | asian_pi_n0==1 | other_race_n0==1
replace re_cat = 5 if re_cat==.
la var re_cat "Race & Ethnicity"
la def re_cat 1 "African American" 3 "White" 2 "Hispanic" 4 "Other" 5 "Unknown race" , replace
la val re_cat re_cat
tab re_cat, missing

gen re_black = 0
replace re_black=1 if re_cat==1
la var re_black "Race=black"

gen re_white = 0
replace re_white =1 if re_cat==3
la var re_white "Race=white"

gen re_hisp = 0
replace re_hisp =1 if re_cat==2
la var re_hisp "Hispanic Ethnicity"

gen re_other_unk = 0
replace re_other_unk =1 if inlist(re_cat,4,5)
la var re_other_unk "Race=other or unknown"

//education categorical variable
label define educ 0 "No Formal Education" 1 "Grades 1-11" 2 "High School" 3 "Some College" 4 "College" ///
      5 "Post College"
label values educ_n0 educ 
tab educ_n0, missing
tab educ_n1 educ_n0, missing

//need to backfill with n2, n3 information, don't have it in the dataset now
gen educ = educ_n0
replace educ=educ_n1 if educ_n0==.
replace educ=educ_n2 if educ_n0==. & educ_n1==.
replace educ=educ_n3 if educ_n0==. & educ_n1==. & educ_n2==.
label values educ educ
tab educ core_year_n0, missing

gen educ_level_lt_hs = 0 if educ!=.
replace educ_level_lt_hs = 1 if inlist(educ,0,1)

gen educ_level_hs = 0 if educ!=.
replace educ_level_hs = 1 if educ==2

gen educ_level_somcol = 0 if educ!=.
replace educ_level_somcol = 1 if educ==3

gen educ_level_col = 0 if educ!=.
replace educ_level_col = 1 if inlist(educ,4,5)

la var educ_level_lt_hs "Education = less than high school"
la var educ_level_hs "Education = high school"
la var educ_level_somcol "Education = some college, no deg."
la var educ_level_col "Education = college deg. "

foreach v in educ_level_lt_hs educ_level_hs educ_level_somcol educ_level_col {
tab educ `v', missing
}

//create high school degree indicator variable
gen hs_deg_ind=.
replace hs_deg_ind=1 if educ>=2 & educ~=.
replace hs_deg_ind=0 if inlist(educ,0,1)
la var hs_deg_ind "High school degree, 1=yes"
tab hs_deg_ind, missing
tab hs_deg_ind educ, missing

//self reported health status
tab srh_n0 srh_n1, missing

//marital status
tab married_n0 married_n1, missing

*******************************************************************
//Indicators death date from the HRS dataset (will check missing against claims dod later)
gen dod_ind=0
replace dod_ind=1 if  death_date_n0~=.
la var dod_ind "Death date present, 1=yes"
tab dod_ind

gen core_to_dod_2yr_n0=.
replace core_to_dod_2yr_n0=1 if core_to_death_n0<=2 & core_to_death_n0!=.
replace core_to_dod_2yr_n0=0 if core_to_death_n0>2 | core_to_death_n0==.
la var core_to_dod_2yr_n0 "Ind died within 2 years of core ivw"
tab core_to_dod_2yr_n0 core_to_dod_1yr_n0, missing

*******************************************************************
//Indicators for having each of the interviews
gen byte ind_n1_interview = .
replace ind_n1_interview=1 if core_year_n1!=.
replace ind_n1_interview=0 if core_year_n1==.
la var ind_n1_interview "R has n1 interview"
tab ind_n1_interview core_year_n0, missing

gen byte ind_p1_interview = .
replace ind_p1_interview=1 if core_year_p1!=.
replace ind_p1_interview=0 if core_year_p1==.
la var ind_p1_interview "R has p1 interview"
tab ind_p1_interview core_year_n0, missing
tab ind_p1_interview core_to_dod_1yr_n0, missing
tab ind_p1_interview core_to_dod_2yr_n0, missing

gen byte ind_p2_interview = .
replace ind_p2_interview=1 if core_year_p2!=.
replace ind_p2_interview=0 if core_year_p2==.
la var ind_p2_interview "R has p2 interview"
tab ind_p2_interview core_year_n0, missing

gen byte ind_x_interview = .
replace ind_x_interview=1 if exit_year_x!=.
replace ind_x_interview=0 if exit_year_x==.
la var ind_x_interview "R has exit interview"
tab ind_x_interview core_year_n0, missing
tab ind_x_interview core_year_n0 if core_to_dod_1yr_n0==1, missing

//n=853 with no p1 and didn't die within 2 years of n0 ivw
//385 are 2010 n0 interviews, so won't have b/c no 2012 ivws in dataset
tab core_year_n0 if ind_p1_interview==0 & core_to_dod_2yr_n0==0
tab core_year_n0 exit_year_x if ind_x_interview==1 & ind_p1_interview==0 & core_to_dod_2yr_n0==0, missing

*******************************************************************
//indicator that meet criteria at the first interview where we can tell
gen meet_crit_first = 0
replace meet_crit_first=1 if ind_n1_interview==0 //no n1 interview
replace meet_crit_first=1 if ind_n1_interview==1 & (part_ab_12m_n1==0 | hmo_d_12m_n1==1) //have n1 but not ffs mc
replace meet_crit_first=1 if ind_n1_interview==1 & (part_ab_12m_n1==. | hmo_d_12m_n1==.) //have n1 but no denominator file
la var meet_crit_first "Meet criteria first interview with full information"
tab meet_crit_first , missing
tab meet_crit_first if core_year_n0<2010, missing

*******************************************************************
//cleaning up date of death variable!
//notes with specific n's refer to Criteria A dataset
//n=55 observatons have a date of death but no exit interview
tab ind_x_interview dod_ind, missing
tab exit_year_x if dod_ind==0, missing

//look at dod to exit interview date
gen dod_to_exit_days=e_ivw_date_x - death_date_n0
tab dod_to_exit_days, missing
tab dod_to_exit_days if ind_x_interview==1, missing
//6 obs have dod from the HRS restricted dataset after the exit interview date
//so bring in claims dod and compare it to see if can get clean dod!
tab e_ivw_date_x if dod_to_exit_days<0
tab e_ivw_date_x death_date_n0 if dod_to_exit_days<0

//convert claims death date to a date variable
rename dod_claims_n0 dod_claims_n0str
gen dod_claims_n0 = date(dod_claims_n0str,"YMD")
format dod_claims_n0 %td
tab death_date_n0 dod_claims_n0 if dod_to_exit_days<0 //check claims dod

//checking core interview dates for each of these observations, if no conflict
//use the claims dod where they are before the exit interview date
//for one observation, imputation of exit date causes the problem, so reassign exit date
gen use_claims_dod = 0

tab c_ivw_date_n0 c_ivw_date_p1 if e_ivw_date_x==date("06-15-2004","MDY") & death_date_n0==date("11-04-2004","MDY"), missing
tab id if e_ivw_date_x==date("06-15-2004","MDY") & death_date_n0==date("11-04-2004","MDY"), missing
replace death_date_n0=dod_claims_n0 if id=="201667010"
replace use_claims_dod=1 if id=="201667010"

tab c_ivw_date_n0 c_ivw_date_p1 if e_ivw_date_x==date("07-15-2004","MDY") & death_date_n0==date("7-17-2004","MDY"), missing
tab id if e_ivw_date_x==date("07-15-2004","MDY") & death_date_n0==date("7-17-2004","MDY"), missing
replace death_date_n0=dod_claims_n0 if id=="205022010"
replace use_claims_dod=1 if id=="205022010"

tab e_ivw_day_imp_x  e_ivw_date_x if e_ivw_date_x==date("06-15-2006","MDY") & death_date_n0==date("6-16-2006","MDY"), missing
//imputation of exit ivw date is incorrect, assign to last day of month
tab id if e_ivw_date_x==date("06-15-2006","MDY") & death_date_n0==date("6-16-2006","MDY"), missing
replace e_ivw_date_x=date("30jun2006","DMY") if id=="200372020" 
gen e_ivw_date_mod = 0
replace e_ivw_date_mod=1 if id=="200372020" 

tab c_ivw_date_n0 c_ivw_date_p1 if e_ivw_date_x==date("04-07-2008","MDY") & death_date_n0==date("11-27-2008","MDY"), missing
tab id if e_ivw_date_x==date("04-07-2008","MDY") & death_date_n0==date("11-27-2008","MDY"), missing
replace death_date_n0=dod_claims_n0 if id=="210540020"  
replace use_claims_dod=1 if id=="210540020"

tab c_ivw_date_n0 c_ivw_date_p2 if e_ivw_date_x==date("04-18-2008","MDY") & death_date_n0==date("09-27-2008","MDY"), missing
tab id if e_ivw_date_x==date("04-18-2008","MDY") & death_date_n0==date("09-27-2008","MDY"), missing
replace death_date_n0=dod_claims_n0 if id=="201942011"  
replace use_claims_dod=1 if id=="201942011"

tab c_ivw_date_n0 c_ivw_date_p2 if e_ivw_date_x==date("06-24-2008","MDY") & death_date_n0==date("07-26-2008","MDY"), missing
tab id if e_ivw_date_x==date("06-24-2008","MDY") & death_date_n0==date("07-26-2008","MDY"), missing
replace death_date_n0=dod_claims_n0 if id=="206221020"  
replace use_claims_dod=1 if id=="206221020"

tab use_claims_dod, missing

//55 obs have exit interview but no date of death, check to see if can use claims dod for those obs
tab dod_claims_n0 exit_year_x if ind_x_interview==1 & dod_ind==0, missing
sum dod_claims_n0 if ind_x_interview==1 & dod_ind==0

//2 obs don't have dod in claims so need to leave missing
//rest wave seems to match the claims dod information
gen test_claims_miss_dod_exit_dt=e_ivw_date_x-dod_claims_n0 if ind_x_interview==1 & dod_ind==0
tab test_claims_miss_dod_exit_dt, missing //all obs have exit interview date after the dod

gen test_claims_miss_dod_n0_dt=dod_claims_n0-c_ivw_date_n0 if ind_x_interview==1 & dod_ind==0
tab test_claims_miss_dod_n0_dt, missing //all obs have core n0 before the dod

gen test_claims_miss_dod_p1_dt=dod_claims_n0-c_ivw_date_p1 if ind_x_interview==1 & dod_ind==0 & ind_p1_interview==1 
tab test_claims_miss_dod_p1_dt, missing //all obs have core p1 before the dod

gen test_claims_miss_dod_p2_dt=dod_claims_n0-c_ivw_date_p2 if ind_x_interview==1 & dod_ind==0 & ind_p2_interview==1 
tab test_claims_miss_dod_p2_dt, missing //all obs have core p2 before the dod

//use the claims dod since it doesn't conflict with the interview dates
replace death_date_n0=dod_claims_n0 if ind_x_interview==1 & dod_ind==0 & dod_claims_n0!=.
replace use_claims_dod=1 if ind_x_interview==1 & dod_ind==0 & dod_claims_n0!=.

//now replace the dod variables using the cleaned up dod
replace dod_ind=1 if death_date_n0!=.

replace core_to_death_n0=(death_date_n0-c_ivw_date_n0)/365.25 if use_claims_dod==1
tab core_to_death_n0 core_to_dod_1yr_n0 if use_claims_dod==1

replace core_to_dod_1yr_n0=1 if core_to_death_n0<1 & use_claims_dod==1
replace core_to_dod_2yr_n0=1 if core_to_death_n0<2 & use_claims_dod==1

replace dod_to_exit_days=e_ivw_date_x - death_date_n0 if use_claims_dod==1 | e_ivw_date_mod==1
tab dod_to_exit_days if use_claims_dod==1 | e_ivw_date_mod==1

*******************************************************************
//Looking at n1 interview, for dealing with missing information
//Age at n1 interview 
gen age_ge_66_n1 = .
replace age_ge_66_n1 =1 if age_at_core_n1>=66 & age_at_core_n1!=.
replace age_ge_66_n1 =0 if age_at_core_n1<66 & age_at_core_n1!=.
la var age_ge_66_n1 "Age at core n1 66+, yes"
tab age_ge_66_n1 , missing

//interview year, prior to 2001, won't have full year lookback
//in medicare files
gen c_ivw_n1_pre2001 = .
replace c_ivw_n1_pre2001=1 if c_ivw_year_n1<2001 & c_ivw_year_n1!=.
replace c_ivw_n1_pre2001=0 if c_ivw_year_n1>=2001 & c_ivw_year_n1!=.
la var c_ivw_n1_pre2001 "n1 interview earlier than 2001, 1=yes"
tab c_ivw_n1_pre2001 , missing

*******************************************************************
//Change in functional status variables
//Looking back, change from core before meet criteria to core when meet criteria
label define adl_cat_core 0 "Independent" 1 "Partial Dependence" 2 "Severe Dependence"
label values adl_cat_core_n0 adl_cat_core 
tab adl_cat_core_n0 , missing 


//stable ind = 1 if stays the same or improves (0 if declines)
gen byte adl_stable_ind_n0n1=0
replace adl_stable_ind_n0n1=1 if adl_cat_core_n0==0 & inlist(adl_cat_core_n1,0,1,2) 

gen byte adl_stable_partial_n0n1=0
replace adl_stable_partial_n0n1=1 if adl_cat_core_n0==1 & inlist(adl_cat_core_n1,1,2) 

gen byte adl_stable_severe_n0n1=0
replace adl_stable_severe_n0n1=1 if adl_cat_core_n0==2 & adl_cat_core_n1==2 

gen byte adl_change_i_m_n0n1=0
replace adl_change_i_m_n0n1=1 if adl_cat_core_n0==1 & adl_cat_core_n1==0

gen byte adl_change_i_s_n0n1=0
replace adl_change_i_s_n0n1=1 if adl_cat_core_n0==2 & adl_cat_core_n1==0

gen byte adl_change_m_s_n0n1=0
replace adl_change_m_s_n0n1=1 if adl_cat_core_n0==2 & adl_cat_core_n1==1

gen byte adl_improved_n0n1=0
replace adl_improved_n0n1=1 if inlist(adl_cat_core_n0,0,1) & adl_cat_core_n1==2
replace adl_improved_n0n1=1 if adl_cat_core_n0==0 & adl_cat_core_n1==1

local adlchange adl_stable_ind_n0n1 adl_stable_partial_n0n1 adl_stable_severe_n0n1 ///
adl_change_i_m_n0n1 adl_change_i_s_n0n1 adl_change_m_s_n0n1 adl_improved_n0n1

foreach v in `adlchange' {
replace `v'=. if adl_cat_core_n0==. | adl_cat_core_n1==.
}

//keep missing category out for now, see what the data looks like
//if decide on missing category, just change line in foreach loop above
//adl_change_n1n2_miss=0;
//if adl_cat_core_n1=. or  adl_cat_core_n2=.  then adl_change_n1n2_miss=1;

la var adl_stable_ind_n0n1 "R ADL Ind. stable or improving n1 to n0, 1=Yes"
la var adl_stable_partial_n0n1 "R ADL Partial Depend, stable n1 to n0, 1=Yes"
la var adl_stable_severe_n0n1 "R ADL Severe Depend, stable n1 to n0, 1=Yes"
la var adl_change_i_m_n0n1 "R ADL Indep. to Partial Depend n1 to n0, 1=Yes"
la var adl_change_i_s_n0n1 "R ADL Indep. to Severe Depend n1 to n0, 1=Yes"
la var adl_change_m_s_n0n1 "R ADL Partial to Severe Depend n1 to n0, 1=Yes"
la var adl_improved_n0n1 "R ADL Improvement n1 to n0, 1=Yes"
//la var adl_change_n0n1_miss="R ADL n1 to n0 unknown";

foreach v in `adlchange' {
tab `v' , missing
}

*******************************************************************
//Change in functional status variables
//Looking forward, change from core meet criteria to next interview (core or death)
//Need to code up for if missing p1, check the exit interviews!
tab adl_cat_core_p1 adl_cat_core_n0, missing

//stable ind = 1 if stays the same or improves (0 if declines)
gen byte adl_stable_ind_n0p1=0
replace adl_stable_ind_n0p1=1 if adl_cat_core_p1==0 & inlist(adl_cat_core_n0,0,1,2) 

gen byte adl_stable_partial_n0p1=0
replace adl_stable_partial_n0p1=1 if adl_cat_core_p1==1 & inlist(adl_cat_core_n0,1,2) 

gen byte adl_stable_severe_n0p1=0
replace adl_stable_severe_n0p1=1 if adl_cat_core_p1==2 & adl_cat_core_n0==2 

gen byte adl_change_i_m_n0p1=0
replace adl_change_i_m_n0p1=1 if adl_cat_core_p1==1 & adl_cat_core_n0==0

gen byte adl_change_i_s_n0p1=0
replace adl_change_i_s_n0p1=1 if adl_cat_core_p1==2 & adl_cat_core_n0==0

gen byte adl_change_m_s_n0p1=0
replace adl_change_m_s_n0p1=1 if adl_cat_core_p1==2 & adl_cat_core_n0==1

gen byte adl_improved_n0p1=0
replace adl_improved_n0p1=1 if inlist(adl_cat_core_p1,0,1) & adl_cat_core_n0==2
replace adl_improved_n0p1=1 if adl_cat_core_p1==0 & adl_cat_core_n0==1

local adlchange adl_stable_ind_n0p1 adl_stable_partial_n0p1 adl_stable_severe_n0p1 ///
adl_change_i_m_n0p1 adl_change_i_s_n0p1 adl_change_m_s_n0p1 adl_improved_n0p1

foreach v in `adlchange' {
replace `v'=. if adl_cat_core_n0==. | adl_cat_core_p1==.
}

//keep missing category out for now, see what the data looks like
//if decide on missing category, just change line in foreach loop above
//adl_change_n1n2_miss=0;
//if adl_cat_core_n1=. or  adl_cat_core_n2=.  then adl_change_n1n2_miss=1;

la var adl_stable_ind_n0p1 "R ADL Ind. stable or improving n0 to p1, 1=Yes"
la var adl_stable_partial_n0p1 "R ADL Partial Depend, stable n0 to p1, 1=Yes"
la var adl_stable_severe_n0p1 "R ADL Severe Depend, stable n0 to p1, 1=Yes"
la var adl_change_i_m_n0p1 "R ADL Indep. to Partial Depend n0 to p1, 1=Yes"
la var adl_change_i_s_n0p1 "R ADL Indep. to Severe Depend n0 to p1, 1=Yes"
la var adl_change_m_s_n0p1 "R ADL Partial to Severe Depend n0 to p1, 1=Yes"
la var adl_improved_n0p1 "R ADL Improvement n0 to p1, 1=Yes"
//la var adl_change_n0p1_miss="R ADL n0 to p1 unknown";

foreach v in `adlchange' {
tab `v' , missing
}

*******************************************************************
//Change in functional status variables
//Looking forward, change from core meet criteria to exit interview 
//This is populated for all r's with exit interviews, only really relevant
//for those that are missing the p1 interview
tab adl_cat_x adl_cat_core_n0 if ind_x_interview==1 & ind_p1_interview==0, missing
tab adl_cat_x adl_cat_core_n0, missing

//stable ind = 1 if stays the same or improves (0 if declines)
gen byte adl_stable_ind_n0x=0
replace adl_stable_ind_n0x=1 if adl_cat_x==0 & inlist(adl_cat_core_n0,0,1,2) 

gen byte adl_stable_partial_n0x=0
replace adl_stable_partial_n0x=1 if adl_cat_x==1 & inlist(adl_cat_core_n0,1,2) 

gen byte adl_stable_severe_n0x=0
replace adl_stable_severe_n0x=1 if adl_cat_x==2 & adl_cat_core_n0==2 

gen byte adl_change_i_m_n0x=0
replace adl_change_i_m_n0x=1 if adl_cat_x==1 & adl_cat_core_n0==0

gen byte adl_change_i_s_n0x=0
replace adl_change_i_s_n0x=1 if adl_cat_x==2 & adl_cat_core_n0==0

gen byte adl_change_m_s_n0x=0
replace adl_change_m_s_n0x=1 if adl_cat_x==2 & adl_cat_core_n0==1

gen byte adl_improved_n0x=0
replace adl_improved_n0x=1 if inlist(adl_cat_x,0,1) & adl_cat_core_n0==2
replace adl_improved_n0x=1 if adl_cat_x==0 & adl_cat_core_n0==1

local adlchange adl_stable_ind_n0x adl_stable_partial_n0x adl_stable_severe_n0x ///
adl_change_i_m_n0x adl_change_i_s_n0x adl_change_m_s_n0x adl_improved_n0x

foreach v in `adlchange' {
replace `v'=. if adl_cat_core_n0==. | adl_cat_x==.
}

//keep missing category out for now, see what the data looks like
//if decide on missing category, just change line in foreach loop above
//adl_change_n1n2_miss=0;
//if adl_cat_core_n1=. or  adl_cat_core_n2=.  then adl_change_n1n2_miss=1;

la var adl_stable_ind_n0x "R ADL Ind. stable or improving n0 to exit, 1=Yes"
la var adl_stable_partial_n0x "R ADL Partial Depend, stable n0 to exit, 1=Yes"
la var adl_stable_severe_n0x "R ADL Severe Depend, stable n0 to exit, 1=Yes"
la var adl_change_i_m_n0x "R ADL Indep. to Partial Depend n0 to exit, 1=Yes"
la var adl_change_i_s_n0x "R ADL Indep. to Severe Depend n0 to exit, 1=Yes"
la var adl_change_m_s_n0x "R ADL Partial to Severe Depend n0 to exit, 1=Yes"
la var adl_improved_n0x "R ADL Improvement n0 to exit, 1=Yes"
//la var adl_change_n0x_miss="R ADL n0 to exit unknown";

foreach v in `adlchange' {
tab `v' , missing
}

*******************************************************************
//indicator for whether or not meet criteria if chf and copd illness are excluded
tab smi_count_n0, missing

gen meet_`crit'_copd_chf_req_n0 = 1
replace meet_`crit'_copd_chf_req_n0 = 0 if smi_chf_ind_n0==0 & smi_copd_ind_n0==0
replace meet_`crit'_copd_chf_req_n0 = 0 if smi_chf_ind_n0==1 & smi_copd_ind_n0==0 & smi_count_n0>1
replace meet_`crit'_copd_chf_req_n0 = 0 if smi_chf_ind_n0==0 & smi_copd_ind_n0==1 & smi_count_n0>1
replace meet_`crit'_copd_chf_req_n0 = 0 if smi_chf_ind_n0==1 & smi_copd_ind_n0==1 & smi_count_n0>2

la var meet_`crit'_copd_chf_req_n0 "COPD or CHF required to meet criteria 1=yes"
tab meet_`crit'_copd_chf_req_n0, missing

//indicator for dementia is required
gen meet_`crit'_dement_req_n0 = 1
replace meet_`crit'_dement_req_n0 = 0 if smi_dem_ind_n0==0
replace meet_`crit'_dement_req_n0 = 0 if smi_dem_ind_n0==1 & smi_count_n0>1

la var meet_`crit'_dement_req_n0 "Dementia required to meet criteria 1=yes"
tab meet_`crit'_dement_req_n0 , missing


*******************************************************************

save n0_n1_p1_p2_x_criteria_`crit'_v1.dta, replace

log close


H="Tables, looking from 1st interview where meet criteria"

/*Stata
Create tables comparing outcomes for the criteria
Code can be run on either criteria a or criteria b datasets*/

capture log close

clear all
set mem 500m
set more off
/*Update 6/9/14 Removed HIV as a serious medical illness in the list*/


//local crit a
//local crit b
local crit c

local logpath E:\data\serious_ill\logs
local datapath E:\data\serious_ill\final_data

log using "`logpath'\4`crit'-sic_changes_tables_crit_`crit'.txt", text replace

cd `datapath'

use n0_n1_p1_p2_x_criteria_`crit'_v1.dta if core_year_n0<2010

*******************************************************
*** Table of serious medical conditions
*******************************************************
local smivars smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 smi_chf_ind_n0 smi_copd_ind_n0 ///
smi_diab_compl_ind_n0 smi_liver_ind_n0 smi_als_ind_n0 smi_hip_ind_n0 adl_impair_core_n0

mat table1=J(10,10,.)

sum core_year_n0
sca nsamp=r(N)
local nsamp=nsamp

local r=1
foreach a in `smivars'{
	local c=1
	foreach b in `smivars'{
		tab `a' `b', matcell(r`r'c`c')
		mat table1[`r',`c']=r`r'c`c'[2,2]
	local c=`c'+1
	}
	local r=`r'+1
}

mat rownames table1="dementia" "cancer" "esrd" "chf" "copd" "diabetes" "liver disease" ///
 "ALS" "Hip fracture" "ADL Impairment"

mat colnames table1="dementia" "cancer" "esrd" "chf" "copd" "diabetes" "liver disease" ///
 "ALS" "Hip fracture" "ADL Impairment"

frmttable using "`logpath'\sic_Tables_4_outcomes_crit_`crit'", statmat(table1) ///
title("Comparison of serious medical conditions and ADL Impairment" \ ///
"Interview when first meet criteria" \ ///
"Criteria `crit' n=`nsamp'") sdec(0) landscape replace

*******************************************************
//is the hiv smi needed? do those meet the critera otherwise?
//Update 6/9/14 Decided to remove HIV after discussion with Amy
*******************************************************
//list of all criteria a components without hiv criteria
local smivars2 smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 smi_chf_ind_n0 smi_copd_ind_n0 ///
smi_diab_compl_ind_n0 smi_liver_ind_n0 smi_als_ind_n0 smi_hip_ind_n0 adl_impair_core_n0

gen crit_`crit'_nohiv=0 if smi_hiv_ind_n0==1
foreach v in `smivars2'{
replace crit_`crit'_nohiv=1 if `v'==1 & smi_hiv_ind_n0==1 & criteria_`crit'_n0==1
}
tab crit_`crit'_nohiv, missing

//looking at hiv indicator across interview years
label var smi_hiv_ind_n0 "HIV n0"
label var smi_hiv_ind_p1 "HIV p1"
label var smi_hiv_ind_p2 "HIV p2"

replace smi_hiv_ind_p1=99 if smi_hiv_ind_p1==.
replace smi_hiv_ind_p2=99 if smi_hiv_ind_p2==.

table smi_hiv_ind_n0 smi_hiv_ind_p1 smi_hiv_ind_p2, missing
*******************************************************
//Look at outcomes for those that meet without hiv vs those that do not
/********************************************************************
This section commented out, now that HIV was removed from the serious
medical illness secton, it no longer provides any information
since no observations are classified as meeting criteria with the HIV 
illness indicator only
gen hiv_only = 1 if  smi_hiv_ind_n0==1 & crit_`crit'_nohiv==0
replace hiv_only  = 2 if  smi_hiv_ind_n0==1 & crit_`crit'_nohiv==1
tab hiv_only , missing

//table of outcomes
local outcome1 core_to_dod_1yr_n0 hs_admit_p12m_n0 ind_em_ur_adm_p12m_n0

local outcome2 ip_paid_by_mc_1yr_n0 snf_paid_by_mc_1yr_n0 hh_paid_by_mc_1yr_n0 hs_paid_by_mc_1yr_n0 ///
pb_paid_by_mc_1yr_n0 op_paid_by_mc_1yr_n0 dm_paid_by_mc_1yr_n0 tot_paid_by_mc_1yr_n0 n_hospd_p12m_n0

mat hiv=J(34,2,.)
//first row, n for each category
tab hiv_only, matcell(c1)
mat hiv[1,1]=c1[1,1] //those only meeting criteria if hiv dx included
mat hiv[1,2]=c1[2,1] //those meeting criteria regardless of hiv dx

forvalues i=1/2{
local r=2
foreach v in `outcome1'{
	sum `v' if hiv_only==`i', detail
	mat hiv[`r',`i']=r(mean)
	mat hiv[`r'+1,`i']=r(sd)
	local r=`r'+2 //populates rows 2-7 for indicator variable outcomes
	}

local r=8
foreach v in `outcome2'{
	sum `v' if hiv_only==`i', detail
	mat hiv[`r',`i']=r(mean)
	mat hiv[`r'+1,`i']=r(p50)
	mat hiv[`r'+2,`i']=r(sd)
	local r=`r'+3 //populates rows 8-34 for continuous variables
	}
}

mat rownames hiv="N" "Died, mean" "SD" "Hospice enr, mean" "SD" "Emerg or urgent hosp admit, mean" "SD" ///
"IP Medicare payments, mean" "Median" "SD" "SNF Medicare payments, mean" "Median" "SD" ///
"HH Medicare payments, mean" "Median" "SD" "Hospice Medicare payments, mean" "Median" "SD" ///
"Carrier Medicare payments, mean" "Median" "SD" "OP Medicare payments, mean" "Median" "SD" ///
"DME Medicare payments, mean" "Median" "SD" "Total Medicare payments, mean" "Median" "SD" ///
"Hospital nights, mean" "Median" "SD"

mat colnames hiv="HIV dx required to meet criteria" "HIV dx excl, still meet criteria"

frmttable using "`logpath'\sic_Tables_4_outcomes_crit_`crit'", statmat(hiv) ///
title("Comparison of outcomes at 1 year, HIV dx only vs HIV dx not required" \ ///
"Criteria `crit'") sdec(0\2\2\2\2\2\2\0) landscape addtable
********************************************************************/

*******************************************************
*** Meet criteria p1 interview?
*******************************************************
mat p1_crit=J(6,2,.)
sum criteria_`crit'_n0
mat p1_crit[1,1]=r(N) //overall n meet criteria
mat p1_crit[1,2]=100

tab core_to_dod_2yr_n0 ind_p1_interview, missing

sum criteria_`crit'_n0 if ind_p1_interview==1  //n that have p1 interview 
mat p1_crit[2,1]=r(N) //overall n meet criteria w/ p1 ivw
mat p1_crit[2,2]=p1_crit[2,1]/p1_crit[1,1]*100

tab part_ab_12m_p1 hmo_d_12m_p1 if ind_p1_interview==1, missing
tab c_ivw_year_p1 if part_ab_12m_p1==. //all were 2011, we don't have denominator file that year

//who doesn't have p1 interview? Show number died within 2 years
sum criteria_`crit'_n0 if ind_p1_interview==0 & core_to_dod_2yr_n0==1
mat p1_crit[3,1]=r(N) //overall n meet criteria no p1 ivw but died within 2 years of n0 ivw
mat p1_crit[3,2]=p1_crit[3,1]/p1_crit[1,1]*100

sum criteria_`crit'_n0 if ind_p1_interview==0 & core_to_dod_2yr_n0==0
mat p1_crit[4,1]=r(N) //overall n meet criteria no p1 ivw, did not die within 2 years of n0 ivw
mat p1_crit[4,2]=p1_crit[4,1]/p1_crit[1,1]*100

//69% of those with no p1 and didn't die have 2010 n0 interview so don't have p1 ivw
tab core_year_n0 if ind_p1_interview==0 & core_to_dod_2yr_n0==0, missing

sum criteria_`crit'_n0 if ind_p1_interview==1 & part_ab_12m_p1==1 & hmo_d_12m_p1==0 //n that have p1 interview and ffs mc 1 year prior
mat p1_crit[5,1]=r(N) //overall n meet criteria w/ p1 ivw
mat p1_crit[5,2]=p1_crit[5,1]/p1_crit[2,1]*100

tab criteria_`crit'_p1 if ind_p1_interview==1 & part_ab_12m_p1==1 & hmo_d_12m_p1==0, matcell(p1)
mat p1_crit[6,1]=p1[2,1] //n that meet criteria p1
mat p1_crit[6,2]=(p1_crit[6,1] / p1_crit[5,1])*100

frmttable using "`logpath'\sic_Tables_4_outcomes_crit_`crit'", statmat(p1_crit) ///
title("Meet criteria `crit' in p1 interview")  ///
rtitles("Overall n meet criteria n0 interview"\ "Have p1 interview" \ ///
"Missing p1 ivw, died within 2 years of n0" \ "Missing p1 ivw, did not die within 2 years" \ ///
"Have ffs mc 1 year prior to p1 ivw, pct of those with p1 ivw" \ ///
"N meet p1 interview, pct of those with ffs p1 ivw") ///
ctitles("" "N" "Percent") ///
sdec(0,2) addtable

*******************************************************
gen n0top1ivw = (c_ivw_date_p1-c_ivw_date_n0)/365.25
sum n0top1ivw, detail
sca co_95pct=r(p95)
gen died_within_95pctco=0
replace died_within_95pctco=1 if core_to_death_n0<=co_95pct & core_to_death_n0!=.

sum criteria_`crit'_n0 if ind_p1_interview==0 & died_within_95pctco==0
sum criteria_`crit'_n0 if ind_p1_interview==0 & died_within_95pctco==1

sum core_to_death_n0 if  ind_p1_interview==0 & died_within_95pctco==0
tab core_year_n0 if  ind_p1_interview==0 & died_within_95pctco==0
*******************************************************
//looking at missing p1 interviews
mat ivws=J(7,2,.)
sum criteria_`crit'_n0
mat ivws[1,1]=r(N) //overall n meet criteria
mat ivws[1,2]=100

sum criteria_`crit'_n0 if ind_p1_interview==1  //n that have p1 interview 
mat ivws[2,1]=r(N) //overall n meet criteria w/ p1 ivw
mat ivws[2,2]=ivws[2,1]/ivws[1,1]*100

sum criteria_`crit'_n0 if ind_p1_interview==0  //n that do not have p1 interview 
mat ivws[3,1]=r(N) //overall n meet criteria w/o p1 ivw
mat ivws[3,2]=ivws[3,1]/ivws[1,1]*100

sum criteria_`crit'_n0 if ind_p1_interview==0 & core_to_dod_2yr_n0==1
mat ivws[4,1]=r(N) //overall n meet criteria no p1 ivw but died within 2 years of n0 ivw
mat ivws[4,2]=ivws[4,1]/ivws[3,1]*100

sum criteria_`crit'_n0 if ind_p1_interview==0 & core_year_n0==2010
mat ivws[5,1]=r(N) //overall n meet criteria no p1 ivw bc n0=2010
mat ivws[5,2]=ivws[5,1]/ivws[3,1]*100

sum criteria_`crit'_n0 if ind_p1_interview==0 & core_year_n0!=2010 & core_to_dod_2yr_n0==0 & ind_x_interview==1
mat ivws[6,1]=r(N) //overall n meet criteria no p1 ivw but have exit
mat ivws[6,2]=ivws[6,1]/ivws[3,1]*100

//looking at those with exit interview and no p1 interview
//n=27 have no dod but have exit interview!
sum core_to_death_n0 if ind_p1_interview==0 & core_year_n0!=2010 & core_to_dod_2yr_n0==0 & ind_x_interview==1, detail
tab core_to_death_n0 if ind_p1_interview==0 & core_year_n0!=2010 & core_to_dod_2yr_n0==0 & ind_x_interview==1, missing
tab dod_ind exit_year_x if ind_p1_interview==0 & core_year_n0!=2010 & core_to_dod_2yr_n0==0 & ind_x_interview==1, missing

sum criteria_`crit'_n0 if ind_p1_interview==0 & core_year_n0!=2010 & core_to_dod_2yr_n0==0 & ind_x_interview==0
mat ivws[7,1]=r(N) //overall n meet criteria no p1 ivw but have exit
mat ivws[7,2]=ivws[7,1]/ivws[3,1]*100

tab core_year_n0 if ind_p1_interview==0 & core_year_n0!=2010 & core_to_dod_2yr_n0==0 & ind_x_interview==0

mat list ivws

frmttable using "`logpath'\sic_Tables_4_outcomes_crit_`crit'", statmat(ivws) ///
title("Looking at missing p1 interviews, criteria `crit'")  ///
rtitles("Overall n meet criteria n0 interview"\ "Have p1 interview" \ ///
"Missing p1 ivw" \ "Missing p1 ivw, died within 2 years (pct of missing p1)" \ ///
"Missing p1 because meet crit in 2010 (pct of missing p1)" \ ///
"Missing p1, did not die within 2 years but have exit interview (pct of missing p1)" \ ///
"Missing p1, unknown reason, and no exit interview (pct of missing p1)") ///
ctitles("" "N" "Percent") ///
sdec(0,2) addtable

*******************************************************
//characteristics of group that meets criteria
//4 columns, 1 overall group, 2 group meets both n0 and p1 ivws, 3 group meets only n0, not p1
//4 that died, we just have exit, no p1 ivw
 ********* ********* ********* ********* ********* *********
************ This section doesn't do anything right now *********
************ Update it eventually to show the outcomes  *********
 ********* ********* ********* ********* ********* *********
//overall sample
tab core_year_n0 if core_year_n0!=2010, missing //can't have follow up if 2010 ivw so drop
gen ind_oa_sample=0
replace ind_oa_sample=1 if  core_year_n0!=2010
tab ind_oa_sample, missing

//with exit interview, no p1 core
tab ind_p1_interview ind_x_interview if core_year_n0!=2010, missing
gen ind_died_sample=0
replace ind_died_sample=1 if core_year_n0!=2010 & ind_p1_interview==0  & ind_x_interview==1

//with p1 core, meet criteria or not
tab criteria_`crit'_p1 if ind_p1_interview==1 & part_ab_12m_p1==1 & hmo_d_12m_p1==0
gen ind_meetp1_sample=0
replace ind_meetp1_sample=1 if ind_p1_interview==1 & part_ab_12m_p1==1 & hmo_d_12m_p1==0 & criteria_`crit'_p1==1
tab ind_meetp1_sample, missing

gen ind_nomeetp1_sample=0
replace ind_nomeetp1_sample=1 if ind_p1_interview==1 & part_ab_12m_p1==1 & hmo_d_12m_p1==0 & criteria_`crit'_p1==0
tab ind_nomeetp1_sample, missing

mat char=J(15,4,.)
//first row, get sample sizes
sum core_year_n0 if ind_oa_sample==1 
mat char[1,1]=r(N) //overall sample
sum core_year_n0 if ind_died_sample==1
mat char[1,2]=r(N) //with exit interview, no p1 ivw
sum core_year_n0 if ind_meetp1_sample==1
mat char[1,3]=r(N) //n that meet criteria p1
sum core_year_n0 if ind_nomeetp1_sample==1
mat char[1,4]=r(N) //n that do not meet criteria p1

local des_vars female_n0 

tab age_cat_n0, missing //(3 categories)

local c=1
foreach v in ind_oa_sample ind_died_sample ind_meetp1_sample ind_nomeetp1_sample{
	sum age_at_core_n0 if `v'==1
		mat char[2,`c']=r(mean)
	tab age_cat_n0 if `v'==1
		
	local c=`c'+1
}


***************************************************************
***************************************************************
//Look at 1 year n0 outcomes of those that meet 1st ivw and those that don't
local outcome core_to_dod_1yr_n0 hs_admit_p12m_n0 ind_em_ur_adm_p12m_n0 ///
ip_paid_by_mc_1yr_wi_n0 snf_paid_by_mc_1yr_wi_n0 hh_paid_by_mc_1yr_wi_n0 hs_paid_by_mc_1yr_wi_n0 ///
pb_paid_by_mc_1yr_wi_n0 op_paid_by_mc_1yr_wi_n0 dm_paid_by_mc_1yr_wi_n0 tot_paid_by_mc_1yr_wi_n0 n_hospd_p12m_n0

mat meet_1st=J(13,8,.)
	
//overall sample outcomes rows
sum core_year_n0
mat meet_1st[1,1]=r(N) //overall n
	
local r=2
		foreach v in `outcome'{
		sum `v', detail
		mat meet_1st[`r',1]=r(mean)
		mat meet_1st[`r',2]=r(p50)
		local r=`r'+1 
	}
			
local col = 3				
tab meet_crit_first, missing matcell(n0_1)
mat meet_1st[1,`col']=n0_1[2,1] //n who meet 1st interview
mat meet_1st[1,`col'+2]=n0_1[1,1] //n who do not meet 1st interview	
//for those that meet 1st interview and those that don't	
foreach resp in 1 0{
	local r=2
		foreach v in `outcome'{
		sum `v' if meet_crit_first==`resp', detail
		mat meet_1st[`r',`col']=r(mean)
		mat meet_1st[`r',`col'+1]=r(p50)
		local r=`r'+1
		}
	local col = `col'+2		
}

//column 7 for p-values
local r=2
foreach v in `outcome'{
	logit meet_crit_first `v'
	test `v'
	mat meet_1st[`r',7]=r(p) //p value from t-test
	local r=`r'+1
	}

mat list meet_1st

frmttable using "`logpath'\sic_Tables_4_outcomes_crit_`crit'", statmat(meet_1st) ///
title("1 year outcomes by if meet criteria `crit' 1st interview")  ///
rtitles("Overall n"\""\ "Died"\""\ "Hospice admit" \ "" \ "Hospital admit" \ "" \ ///
"IP Medicare" \""\ "SNF Medicare" \""\ "HH Medicare" \""\ "Hospice Medicare" \ "" \ ///
"Carrier Medicare" \""\ "OP Medicare" \ "" \ "DME Medicare" \ "" \ "Total Medicare payments" \ ""\ ///
"Number hospitalizations" \ ""  ) ///
ctitles("" "Overall" "Meet 1st ivw" "Do not meet 1st ivw" "p-value" \ ///
"" "mean" "" "" \ "" "(median)" "" "") ///
note("Criteria A = Any serious medical illness and/or ADL impairment" \ ///
"Criteria B = Criteria A and Urgent / Emergent hospitalization and/or NH resident" \ ///
"Criteria C = Illness and ADL impair and Hospitalization and/or NH resident" \ ///
"Outcomes are for 1 year after the initial interview where R meets criteria." \ ///
"Medicare spending is adjusted for inflation and the CMS wage index.") ///
substat(1) sdec(2\0) addtable


*******************************************************
log close


H="Tables, outcomes, comparing criteria a and b"
/*Stata
Create tables comparing outcomes for the criteria
Code switches between datasets as needed*/

capture log close

clear all
set mem 500m
set more off

local logpath E:\data\serious_ill\logs
local datapath E:\data\serious_ill\final_data

log using "`logpath'\5_crit_a_and_b_outcomes.txt", text replace

cd `datapath'

***************************************************************
//looking at follow up categories using the Criteria A dataset as a start
//prior to creating tables
use n0_n1_p1_p2_x_criteria_a_v1.dta if core_year_n0<2010

tab ind_p1_interview if core_to_dod_2yr_n0==0, missing
tab core_to_dod_2yr_n0, missing
tab core_to_dod_2yr_n0 ind_x_interview, missing
//1 obs died within 2 years of meeting criteria but has no exit or p1
//went back to full exit dataset and verified this
tab core_year_n0 id if core_to_dod_2yr_n0==1 & ind_x_interview==0
tab ind_p1_interview if core_to_dod_2yr_n0==1 & ind_x_interview==0

//missing p1 altogether?
tab ind_p1_interview if core_to_dod_2yr_n0==0, missing
tab core_year_n0 if ind_p1_interview==0 & core_to_dod_2yr_n0==0, missing
tab core_to_death_n0 if ind_p1_interview==0 & core_to_dod_2yr_n0==0, missing
tab core_year_n0 exit_year_x if core_to_death_n0==. & ind_p1_interview==0 & core_to_dod_2yr_n0==0, missing

tab exit_year_x if dod_ind==0, missing

//of those with p1, who had ffs medicare that time
//151 didn't have full denominator info so missing
//146 had hmo
tab  part_ab_12m_p1 hmo_d_12m_p1 if ind_p1_interview==1 & core_to_dod_2yr_n0==0, missing

tab ser_med_illness_p1 if ind_p1_interview==1 & core_to_dod_2yr_n0==0 & part_ab_12m_p1==1 & hmo_d_12m_p1==0, missing

gen outcome_ivw_cat = .
replace outcome_ivw_cat=1 if core_to_dod_2yr_n0==1 & ind_x_interview==1 //died
replace outcome_ivw_cat=2 if ser_med_illness_p1==1 & ind_p1_interview==1 & core_to_dod_2yr_n0==0 & part_ab_12m_p1==1 & hmo_d_12m_p1==0 //meet criteria p1
replace outcome_ivw_cat=3 if ser_med_illness_p1==0 & ind_p1_interview==1 & core_to_dod_2yr_n0==0 & part_ab_12m_p1==1 & hmo_d_12m_p1==0 //meet criteria p1

replace outcome_ivw_cat=4 if core_to_dod_2yr_n0==1 & ind_x_interview==0 //no follow up if died and missing exit ivw, n=1
replace outcome_ivw_cat=4 if core_to_dod_2yr_n0==0 & ind_p1_interview==0 //did not die, have no p1 ivw, n=171
replace outcome_ivw_cat=4 if core_to_dod_2yr_n0==0 & ind_p1_interview==1 & (part_ab_12m_p1!=1 | hmo_d_12m_p1!=0) //no ffs, n=297

la def outcome 1"Died" 2" Meet criteria p1" 3"Does not meet criteria p1" 4"Unknown, inadequate follow up"
la val outcome_ivw_cat outcome

tab outcome_ivw_cat, missing

clear

***************************************************************
**Check follow up interviews for each of the criteria (2 tables)
***************************************************************
mat p1_crit=J(5,4,.)
mat miss=J(6,4,.)

local col = 1
foreach crit in a b{
	use n0_n1_p1_p2_x_criteria_`crit'_v1.dta if core_year_n0<2010
		
**1st table looking at follow up outcomes
	sum core_year_n0
	mat p1_crit[1,`col']=r(N) //overall n meet criteria
	mat p1_crit[1,`col'+1]=100 //percent of n

	sum core_year_n0 if ind_p1_interview==0 & core_to_dod_2yr_n0==1 & ind_x_interview==1
	mat p1_crit[2,`col']=r(N) //no p1 interview, died within 2 years, with exit interview
	mat p1_crit[2,`col'+1]=p1_crit[2,`col']/p1_crit[1,`col']*100

	tab criteria_`crit'_p1 if ind_p1_interview==1 & part_ab_12m_p1==1 & hmo_d_12m_p1==0, matcell(p1)
	mat p1_crit[3,`col']=p1[2,1] //n that meet criteria p1
	mat p1_crit[3,`col'+1]=p1_crit[3,`col']/p1_crit[1,`col']*100
	mat p1_crit[4,`col']=p1[1,1] //n that do not meet criteria p1
	mat p1_crit[4,`col'+1]=p1_crit[4,`col']/p1_crit[1,`col']*100
	
	sum core_year_n0 if (core_to_dod_2yr_n0==1 & ind_x_interview==0) | ///
		(core_to_dod_2yr_n0==0 & ind_p1_interview==0) | ///
		(core_to_dod_2yr_n0==0 & ind_p1_interview==1 & (part_ab_12m_p1!=1 | hmo_d_12m_p1!=0))
	mat p1_crit[5,`col']=r(N) //no follow up interview
	mat p1_crit[5,`col'+1]=p1_crit[5,`col']/p1_crit[1,`col']*100
	
**2nd table begins here looking at missing follow up
	mat miss[1,`col']=p1_crit[5,`col'] //those that are missing, same as last row in above
	
	sum core_year_n0 if (core_to_dod_2yr_n0==1 & ind_x_interview==0)
	mat miss[2,`col']=r(N) //died but no exit interview
	mat miss[2,`col'+1]=miss[2,`col']/miss[1,`col']*100  

	sum core_year_n0 if (core_to_dod_2yr_n0==0 & ind_p1_interview==0)
	mat miss[3,`col']=r(N) //didn't die but no p1
	mat miss[3,`col'+1]=miss[3,`col']/miss[1,`col']*100  
	
	sum core_year_n0 if (core_to_dod_2yr_n0==0 & ind_p1_interview==1 & (part_ab_12m_p1==. | hmo_d_12m_p1==.))
	mat miss[4,`col']=r(N) //have p1 but missing denominator info full year preceding p1
	mat miss[4,`col'+1]=miss[4,`col']/miss[1,`col']*100 

	
tab c_ivw_year_p1 if (core_to_dod_2yr_n0==0 & ind_p1_interview==1 & (part_ab_12m_p1==. | hmo_d_12m_p1==.)), missing
	
	sum core_year_n0 if (core_to_dod_2yr_n0==0 & ind_p1_interview==1 & (part_ab_12m_p1==0))
	mat miss[5,`col']=r(N) //have p1 but not parts a b medicare 1 year preceding p1
	mat miss[5,`col'+1]=miss[5,`col']/miss[1,`col']*100 

	sum core_year_n0 if (core_to_dod_2yr_n0==0 & ind_p1_interview==1 & (hmo_d_12m_p1==1))
	mat miss[6,`col']=r(N) //have p1 but hmo medicare 1 year preceding p1
	mat miss[6,`col'+1]=miss[6,`col']/miss[1,`col']*100 
	
	local col = `col'+2
		
	clear
}
	 
frmttable using "`logpath'\sic_Tables_5_outcomes_crit_a_and_b", statmat(p1_crit) ///
title("Meet criteria in p1 interview")  ///
rtitles("Overall n meet criteria n0 interview"\""\ "Died within 2 years and have exit interview" \ ///
""\"Meet criteria in p1 interview" \""\ "Do not meet criteria in p1 interview" \""\ ///
"Missing follow up interview, see notes"\"") ///
ctitles("" "Criteria A" "Criteria B" \ "" "n" "n" \ "" "(percent)" "(percent)" ) ///
note("Criteria A = Any serious medical illness and/or ADL impairment" \ ///
"Criteria B = Criteria A and Urgent / Emergent hospitalization and/or NH resident" \ ///
"Missing follow up if R died within 2 years of meet criteria but no exit interview,"  \ ///
"R did not die within 2 years, has no p1 interview," \ ///
"or R has p1 interview but not FFS MC 1 year preceding p1 interview.") ///
substat(1) sdec(0\1) replace

frmttable using "`logpath'\sic_Tables_5_outcomes_crit_a_and_b", statmat(miss) ///
title("Missing follow up interview")  ///
rtitles("Missing follow up interview"\""\ "Died within 2 years but no exit interview" \ ///
""\"Did not die but no p1 ivw" \""\ "Had p1 interview but missing dn file 1 year pre" \"" \ ///
"Had p1 interview, but not Part A, B medicare 1 yr pre" \ ""\"Had p1 ivw, but HMO 1 year pre" \ "") ///
ctitles("" "Criteria A" "Criteria B" \ "" "n" "n" \ "" "(percent)" "(percent)" ) ///
note("Criteria A = Any serious medical illness and/or ADL impairment" \ ///
"Criteria B = Criteria A and Urgent / Emergent hospitalization and/or NH resident" \ ///
"All missing denominator file in claims are for interviews that took place in 2011.") ///
substat(1) sdec(0\1) addtable

***************************************************************
**Check counts where meet 1st interview for each of the criteria
***************************************************************
mat n1_crit=J(9,4,.)
local col = 1
foreach crit in a b{
	use n0_n1_p1_p2_x_criteria_`crit'_v1.dta if core_year_n0<2010
		
**1st table looking at n1 present
	sum core_year_n0
	mat n1_crit[1,`col']=r(N) //overall n meet criteria
	mat n1_crit[1,`col'+1]=100 //percent of n

	sum core_year_n0 if ind_n1_interview==1 & part_ab_12m_n1==1 & hmo_d_12m_n1==0
	mat n1_crit[2,`col']=r(N) //have n1 interview with ffs mc 1 year pre
	mat n1_crit[2,`col'+1]=n1_crit[2,`col']/n1_crit[1,`col']*100

	sum core_year_n0 if ind_n1_interview==1 & part_ab_12m_n1==. & hmo_d_12m_n1==.
	mat n1_crit[3,`col']=r(N) //have n1 but don't have denominator file that ivw (pre 2000)
	mat n1_crit[3,`col'+1]=n1_crit[3,`col']/n1_crit[1,`col']*100
	
	//why so many missing denominator files? check interview year, don't have files before Jan 2000
	tab c_ivw_year_n1 if ind_n1_interview==1 & part_ab_12m_n1==. & hmo_d_12m_n1==., missing
	
	sum core_year_n0 if c_ivw_n1_pre2001==1 & ind_n1_interview==1 & part_ab_12m_n1==. & hmo_d_12m_n1==.
	mat n1_crit[4,`col']=r(N) //have n1 but missing dn file b/c pre 2001 ivw
	mat n1_crit[4,`col'+1]=n1_crit[4,`col']/n1_crit[1,`col']*100	

	sum core_year_n0 if c_ivw_n1_pre2001==0 & age_ge_66_n1==0 & ind_n1_interview==1 & part_ab_12m_n1==. & hmo_d_12m_n1==.
	mat n1_crit[5,`col']=r(N) //have n1 but missing dn file, later than 2001 but age less than 66 at ivw
	mat n1_crit[5,`col'+1]=n1_crit[5,`col']/n1_crit[1,`col']*100	

	sum core_year_n0 if c_ivw_n1_pre2001==0 & age_ge_66_n1==1 & ind_n1_interview==1 & part_ab_12m_n1==. & hmo_d_12m_n1==.
	mat n1_crit[6,`col']=r(N) //have n1 but missing dn file, really missing, can't tell why from age and ivw year
	mat n1_crit[6,`col'+1]=n1_crit[6,`col']/n1_crit[1,`col']*100		
		
	sum core_year_n0 if ind_n1_interview==1 & part_ab_12m_n1==0
	mat n1_crit[7,`col']=r(N) //have n1 but not parts a/b medicare 1 year pre
	mat n1_crit[7,`col'+1]=n1_crit[7,`col']/n1_crit[1,`col']*100

	sum core_year_n0 if ind_n1_interview==1 & part_ab_12m_n1==1 & hmo_d_12m_n1==1
	mat n1_crit[8,`col']=r(N) //have n1 but hmo medicare 1 year pre
	mat n1_crit[8,`col'+1]=n1_crit[8,`col']/n1_crit[1,`col']*100

	sum core_year_n0 if ind_n1_interview==0
	mat n1_crit[9,`col']=r(N) //missing n1 interview
	mat n1_crit[9,`col'+1]=n1_crit[9,`col']/n1_crit[1,`col']*100
	
	local col = `col'+2
		
	clear
}

	 
frmttable using "`logpath'\sic_Tables_5_outcomes_crit_a_and_b", statmat(n1_crit) ///
title("Checking R's that meet criteria first interview in our dataset")  ///
rtitles("Overall n meet criteria n0 interview"\""\ "Have n1 interview with ffs mc 1 year pre" \"" \ ///
"Have n1 ivw but missing dn file 1y pre" \"" \"Missing dn file bc ivw before 2001" \ "" \ ///
"Missing dn because age<66 at ivw (ivw 2001 or later)" \ "" \ ///
"Missing dn for unknown reason" \ "" \ "Have n1 ivw but not mc parts a&b 1y pre" \"" \ ///
"Have n1 ivw but HMO 1y pre"\"" \ "No n1 interview in HRS" \ "" ) ///
ctitles("" "Criteria A" "Criteria B" \ "" "n" "n" \ "" "(percent)" "(percent)" ) ///
note("Criteria A = Any serious medical illness and/or ADL impairment" \ ///
"Criteria B = Criteria A and Urgent / Emergent hospitalization and/or NH resident") ///
substat(1) sdec(0\1) addtable


***************************************************************
**Check outcomes across each part of the various criteria
***************************************************************
//Modified list, don't need nursing home or hospitalization only categories
//allow those obs to go into the smi and adl categories
local datapath2 E:\data\serious_ill\int_data
cd `datapath2'

//use dataset with outcomes, just obs that meet interview sample inclusion criteria
use ivws_crit_1.dta if inlist(core_year,2002,2004,2006,2008) & /// 
age_ge_65==1 & xwalk_yes==1 & part_ab_12m==1 & hmo_d_12m==0

gen comp_none=0
replace comp_none=1 if ser_med_illness==0 & adl_impair_core==0 & smi_nh_ind==0 & ind_em_ur_adm_12m==0
tab comp_none

//smi, no adl, regardless of nh or hospitalization
gen comp_smi=0
replace comp_smi=1 if ser_med_illness==1 & adl_impair_core==0
tab comp_smi

//no smi, adl, regardless of nh or hospitalization
gen comp_adl=0
replace comp_adl=1 if ser_med_illness==0 & adl_impair_core==1
tab comp_adl

//gen comp_nh=0
//replace comp_nh=1 if ser_med_illness==0 & adl_impair_core==0 & smi_nh_ind==1 & ind_em_ur_adm_12m==0
//tab comp_nh

//gen comp_hos=0
//replace comp_hos=1 if ser_med_illness==0 & adl_impair_core==0 & smi_nh_ind==0 & ind_em_ur_adm_12m==1
//tab comp_hos

//smi+adl, regardless of nh or hospitalization
gen comp_smi_adl=0
replace comp_smi_adl=1 if ser_med_illness==1 & adl_impair_core==1
tab comp_smi_adl

gen comp_smi_nh=0
replace comp_smi_nh=1 if ser_med_illness==1 & adl_impair_core==0 & smi_nh_ind==1 & ind_em_ur_adm_12m==0
tab comp_smi_nh

gen comp_smi_hosp=0
replace comp_smi_hosp=1 if ser_med_illness==1 & adl_impair_core==0 & smi_nh_ind==0 & ind_em_ur_adm_12m==1
tab comp_smi_hosp

gen comp_adl_nh=0
replace comp_adl_nh=1 if ser_med_illness==0 & adl_impair_core==1 & smi_nh_ind==1 & ind_em_ur_adm_12m==0
tab comp_adl_nh

gen comp_adl_hosp=0
replace comp_adl_hosp=1 if ser_med_illness==0 & adl_impair_core==1 & smi_nh_ind==0 & ind_em_ur_adm_12m==1
tab comp_adl_hosp

gen comp_nh_hosp=0
replace comp_nh_hosp=1 if  ser_med_illness==0 & adl_impair_core==0 & smi_nh_ind==1 & ind_em_ur_adm_12m==1
tab comp_nh_hosp
tab comp_nh_hosp comp_nh

gen comp_smi_adl_nh=0
replace comp_smi_adl_nh=1 if ser_med_illness==1 & adl_impair_core==1 & smi_nh_ind==1 & ind_em_ur_adm_12m==0
tab comp_smi_adl_nh

gen comp_smi_adl_hosp=0
replace comp_smi_adl_hosp=1 if ser_med_illness==1 & adl_impair_core==1 & smi_nh_ind==0 & ind_em_ur_adm_12m==1
tab comp_smi_adl_hosp

gen comp_smi_nh_hosp=0
replace comp_smi_nh_hosp=1 if ser_med_illness==1 & adl_impair_core==0 & smi_nh_ind==1 & ind_em_ur_adm_12m==1
tab comp_smi_nh_hosp

gen comp_adl_nh_hosp=0
replace comp_adl_nh_hosp=1 if ser_med_illness==0 & adl_impair_core==1 & smi_nh_ind==1 & ind_em_ur_adm_12m==1
tab comp_adl_nh_hosp

gen comp_all=0
replace comp_all=1 if ser_med_illness==1 & adl_impair_core==1 & smi_nh_ind==1 & ind_em_ur_adm_12m==1
tab comp_all

gen comp_criteria_a = 0
replace comp_criteria_a =1 if ser_med_illness==1 | adl_impair_core==1 
tab comp_criteria_a

gen comp_criteria_b = 0
replace comp_criteria_b =1 if (ser_med_illness==1 | adl_impair_core==1) & (smi_nh_ind==1 | ind_em_ur_adm_12m==1)
tab comp_criteria_b
***************************************************************
//table of outcomes, interview level (so R may be represented 4x)
local outcome1 core_to_dod_1yr hs_admit_p12m ind_em_ur_adm_p12m ip_paid_by_mc_1yr_wi ///
tot_paid_by_mc_1yr_wi

local compvars comp_none comp_smi comp_adl /*comp_nh comp_hos*/ comp_smi_adl comp_criteria_a ///
comp_smi_nh comp_smi_hosp comp_adl_nh comp_adl_hosp comp_nh_hosp ///
comp_smi_adl_nh comp_smi_adl_hosp comp_smi_nh_hosp comp_adl_nh_hosp comp_all comp_criteria_b

//overall sample, n interviews
sum core_year
local nsamp=r(N)

mat comp_N_c1=J(16,3,.)
mat comp=J(16,15,.)

//first column, get n for each subgroup
local r=1
foreach comp in `compvars'{
	sum core_year if `comp'==1, detail
	mat comp_N_c1[`r',1]=r(N)
	local r=`r'+1
}

local c=1
foreach var in `outcome1'{
	local r=1
	foreach comp in `compvars'{
		sum `var' if `comp'==1, detail
		mat comp[`r',`c']=r(mean)
		mat comp[`r',`c'+1]=r(sd)
		mat comp[`r',`c'+2]=r(p50)
		local r=`r'+1
	}
local c=`c'+3
}
mat rownames comp_N_c1="None" "Serious med illness" "ADL Impairment" /*"NH resident" "Hospitalization"*/ ///
"Illness + ADL Impair" "Criteria A" "Illness + NH res" "Illness + Hospital" ///
"ADL + NH Res" "ADL + Hospital" ///
"NH res + Hospital" "Illness + ADL + NH" "Illness + ADL + Hospital" "Illness + NH + Hospital" ///
"ADL + NH + Hospital" "Illness + ADL + NH + Hosp" "Criteria B"

mat rownames comp="None" "Serious med illness" "ADL Impairment" /*"NH resident" "Hospitalization"*/ ///
"Illness + ADL Impair" "Criteria A"  "Illness + NH res" "Illness + Hospital" ///
"ADL + NH Res" "ADL + Hospital" ///
"NH res + Hospital" "Illness + ADL + NH" "Illness + ADL + Hospital" "Illness + NH + Hospital" ///
"ADL + NH + Hospital" "Illness + ADL + NH + Hosp" "Criteria B"

frmttable , statmat(comp_N_c1) substat(2) ///
title("Comparison of serious medical conditions, outcomes at 1 year" \ ///
"N=`nsamp', interview level") ///
ctitles("","N" ) ///
sdec(0) store(table3)

frmttable using "`logpath'\sic_Tables_5_outcomes_crit_a_and_b", statmat(comp)  substat(2) ///
title("Comparison of serious medical conditions, outcomes at 1 year" \ ///
"N=`nsamp', interview level") ///
ctitles("","Died","Hospice admit","Hospital admit","IP Medicare","Total Medicare" \ ///
"","mean","","","","" \ "","(SD)", "","","","", \ "","[Median]","","","","" \ ///
"Medicare spending adjusted for inflation (2010$) and the CMS wage index.") ///
sdec(2) merge(table3) addtable

***************************************************************
***************************************************************
//Looking at ADL dependence vs nursing home residence
//interview level
tab adl_impair_core, missing
tab nhres, missing
tab core_year, missing

mat adl_nh=J(10,2,0)
tab nhres, missing matcell(nh1)
mat adl_nh[1,1]=nh1[2,1] //nh residents
mat adl_nh[1,2]=nh1[2,1] / `nsamp' * 100 //percent all interviews

tab adl_impair_core if nhres==1, missing matcell(m1)
mat adl_nh[2,1]=m1[2,1] //adl dependent (expect most to be adl dependent)
mat adl_nh[2,2]=m1[2,1]/adl_nh[1,1]*100
mat adl_nh[3,1]=m1[1,1] //adl independent
mat adl_nh[3,2]=m1[1,1]/adl_nh[1,1]*100
mat adl_nh[4,1]=m1[3,1] //adl status missing
mat adl_nh[4,2]=m1[3,1]/adl_nh[1,1]*100

//look at those nursing home resident that are adl independent, why?
tab adl_core_check if nhres==1 & adl_impair_core==0, matcell(m2)
mat adl_nh[5,1]=m2[1,1] //flag for high level function=0
mat adl_nh[5,2]=m2[1,1]/adl_nh[3,1]*100
tab adl_core_check adl_diff_dr  if nhres==1 & adl_impair_core==0, matcell(m3)
mat adl_nh[6,1]=m3[2,1] //flag for high level function=1 and no difficulty dressing
mat adl_nh[6,2]=m3[2,1]/adl_nh[3,1]*100

//rest answered all adl questions as do not receive help with the task
mat adl_nh[7,1]=adl_nh[3,1]-adl_nh[5,1]-adl_nh[6,1]
mat adl_nh[7,2]=adl_nh[7,1]/adl_nh[3,1]*100

tab adl_dr_core if nhres==1 & adl_core_check~=0
tab adl_wk_core if  nhres==1 & (adl_core_check~=0 | (adl_core_check==1 & adl_diff_dr~=1))
tab adl_bh_core if  nhres==1 & (adl_core_check~=0 | (adl_core_check==1 & adl_diff_dr~=1))
tab adl_e_core if  nhres==1 & (adl_core_check~=0 | (adl_core_check==1 & adl_diff_dr~=1))
tab adl_tx_core if  nhres==1 & (adl_core_check~=0 | (adl_core_check==1 & adl_diff_dr~=1))
tab adl_t_core if  nhres==1 & (adl_core_check~=0 | (adl_core_check==1 & adl_diff_dr~=1))

tab adl_index_core if nhres==1

tab iadl_independent_core if nhres==1, missing matcell(m4)
mat adl_nh[8,1]=m4[1,1] //iadl dependent
mat adl_nh[8,2]=m4[1,1]/adl_nh[1,1]*100
mat adl_nh[10,1]=m4[2,1] //iadl status missing
mat adl_nh[10,2]=m4[2,1]/adl_nh[1,1]*100

mat list adl_nh

mat rownames adl_nh="Nursing home res at time of ivw" "ADL Dependent" ///
"ADL Independent" "ADL status missing" "ADL screen count=0" ///
"ADL screen=1 & No diff dress" "Ans no help received all ADL ?s" ///
"IADL Dependent" "IADL Independent" "IADL Status missing"

frmttable using "`logpath'\sic_Tables_5_outcomes_crit_a_and_b", statmat(adl_nh) ///
title("ADL status for NH Residents" \ ///
"N=`nsamp', interview level") ///
ctitles("","n","percent") ///
sdec(0,2) addtable

***************************************************************
***************************************************************
//Look at p1 outcomes of those that meet criteria p1 and those that don't
cd `datapath'

local outcomes core_to_dod_1yr_p1 hs_admit_p12m_p1 ind_em_ur_adm_p12m_p1 ///
ip_paid_by_mc_1yr_wi_p1 snf_paid_by_mc_1yr_wi_p1 hh_paid_by_mc_1yr_wi_p1 hs_paid_by_mc_1yr_wi_p1 ///
pb_paid_by_mc_1yr_wi_p1 op_paid_by_mc_1yr_wi_p1 dm_paid_by_mc_1yr_wi_p1 tot_paid_by_mc_1yr_wi_p1 n_hospd_p12m_p1

mat p1_meet=J(13,8,.)

local col = 1
foreach crit in a b{
	clear
	use n0_n1_p1_p2_x_criteria_`crit'_v1.dta if core_year_n0<2010
		
	tab criteria_`crit'_p1, missing matcell(p1_1)
	mat p1_meet[1,`col']=p1_1[2,1] //n who meet criteria p1
	mat p1_meet[1,`col'+2]=p1_1[1,1] //n who do not meet criteria p1
	
	foreach resp in 1 0{
		local r=2
			foreach v in `outcomes'{
			sum `v' if criteria_`crit'_p1==`resp', detail
			mat p1_meet[`r',`col']=r(mean)
			mat p1_meet[`r',`col'+1]=r(p50)
			local r=`r'+1
			}
		local col = `col'+2		
		}
			
}

	 
frmttable using "`logpath'\sic_Tables_5_outcomes_crit_a_and_b", statmat(p1_meet) ///
title("1 year outcomes by status at p1 interview")  ///
rtitles("Overall n"\""\ "Died"\""\ "Hospice admit" \ "" \ "Hospital admit" \ "" \ ///
"IP Medicare" \""\ "SNF Medicare" \""\ "HH Medicare" \""\ "Hospice Medicare" \ "" \ ///
"Carrier Medicare" \""\ "OP Medicare" \ "" \ "DME Medicare" \ "" \ "Total Medicare payments" \ ""\ ///
"Number hospitalizations" \ ""  ) ///
ctitles("" "Criteria A" "" "Criteria B" "" \ ///
"" "Meet p1" "Do not meet p1" "Meet p1" "Do not meet p1" \ ///
"" "mean" "" "" "" \ "" "(median)" "" "" ) ///
note("Criteria A = Any serious medical illness and/or ADL impairment" \ ///
"Criteria B = Criteria A and Urgent / Emergent hospitalization and/or NH resident" \ ///
"Outcomes are for 1 year after the p1 interview." \ ///
"Medicare spending adjusted for inflation (2010$) and the CMS wage index.") ///
substat(1) sdec(2\0) addtable

***************************************************************
log close


H="Tables, outcomes, without full ffs medicare 1 year after ivw"
/*Stata
Create tables comparing outcomes for the criteria
Code can be run on either criteria a or criteria b datasets

Checking differences in outcomes where full 1 year ffs medicare can be
verified after the interview vs not*/

capture log close

clear all
set mem 500m
set more off

local crit a
local crit b

local logpath E:\data\serious_ill\logs
local datapath E:\data\serious_ill\final_data

log using "`logpath'\6`crit'_sensitivity_full_1yr_post_ffs_mc.txt", text replace

cd `datapath'

use n0_n1_p1_p2_x_criteria_`crit'_v1.dta if core_year_n0<2010

********************************************************************
//Identify where ffs medicare 1 year after interview, n0 and p1 interviews
gen ffs_mc_yes_n0 = 0
replace ffs_mc_yes_n0 = 1 if part_ab_12m_aft_n0==1 & hmo_d_12m_aft_n0==0

gen ffs_mc_yes_p1 = 0
replace ffs_mc_yes_p1 = 1 if part_ab_12m_aft_p1==1 & hmo_d_12m_aft_p1==0

tab ffs_mc_yes_n0 core_year_n0 , missing
tab ffs_mc_yes_p1 core_year_p1 , missing

********************************************************************
//table of outcomes (12) n0 interview
local outcome core_to_dod_1yr hs_admit_p12m ind_em_ur_adm_p12m ///
ip_paid_by_mc_1yr_wi snf_paid_by_mc_1yr_wi hh_paid_by_mc_1yr_wi hs_paid_by_mc_1yr_wi ///
pb_paid_by_mc_1yr_wi op_paid_by_mc_1yr_wi dm_paid_by_mc_1yr_wi tot_paid_by_mc_1yr_wi n_hospd_p12m

mat comp = J(13,6,.)
//first row, counts of each group
sum core_year_n0
comp[1,1]=r(N)
sum core_year_n0

sum core_year_n0 if ffs_mc_yes_n0 ==1
comp[1,3]=r(N)
sum core_year_n0

sum core_year_n0 if ffs_mc_yes_n0 ==0
comp[1,5]=r(N)
sum core_year_n0

//first column, for overall sample
local r = 2
sum 

foreach v in 

********************************************************************
log close

H="Tables, outcomes, comparing a, b, c criteria"
/*Stata
Create tables comparing outcomes for the criteria
Switches  between criteria a, b, c datasets to create set 
of outcome tables

1. Breakdown of counts of each of the different criteria (uses
dataset prior to breaking out by interview timeline meeting criteria)
2. Looking at interview timing both pre and post meeting criteria
3. Looking at outcomes after the first interview when meet criteria
4. Looking at p1 outcomes*/

capture log close

clear all
set mem 500m
set more off

local logpath E:\data\serious_ill\logs
local datapath2 E:\data\serious_ill\int_data
local datapath E:\data\serious_ill\final_data

log using "`logpath'\7_compare_3_criteria.txt", text replace

cd `datapath'

***************************************************************
***************************************************************
//Table 1 - Looking at counts of R's meeting each set 
//of criteria
***************************************************************
***************************************************************
//dataset prior to setting up based on criteria timeline, adding outcomes
//each R can be represented multiple times
use `datapath2'\core_ids_1yr_criteria_5_sample1.dta

tab criteria_a, missing

tab smi_and_adl, missing

gen byte smi_or_adl_and_nh=.
replace smi_or_adl_and_nh=1 if criteria_a==1 & smi_nh_ind==1
replace smi_or_adl_and_nh=0 if criteria_a==0 | smi_nh_ind==0
tab smi_or_adl_and_nh, missing

gen byte smi_or_adl_and_hosp=.
replace smi_or_adl_and_hosp=1 if criteria_a==1 & ind_em_ur_adm_12m==1
replace smi_or_adl_and_hosp=0 if criteria_a==0 | ind_em_ur_adm_12m==0
tab smi_or_adl_and_hosp, missing

gen byte smi_and_adl_and_nh=.
replace smi_and_adl_and_nh=1 if smi_and_adl==1 & smi_nh_ind==1
replace smi_and_adl_and_nh=0 if smi_and_adl==0 | smi_nh_ind==0
tab smi_and_adl_and_nh, missing

gen byte smi_and_adl_and_hosp=.
replace smi_and_adl_and_hosp=1 if smi_and_adl==1 & ind_em_ur_adm_12m==1
replace smi_and_adl_and_hosp=0 if smi_and_adl==0 | ind_em_ur_adm_12m==0
tab smi_and_adl_and_hosp, missing

tab criteria_c, missing

local smi_vars ser_med_illness adl_impair_core smi_and_adl criteria_a ///
smi_or_adl_and_nh smi_or_adl_and_hosp criteria_b ///
smi_and_adl_and_nh smi_and_adl_and_hosp criteria_c

***************************************************************
//collapse dataset so get at the R level, not interview level
collapse core_year `smi_vars' ,by(id)

mat criteria_r=J(11,2,.)

sum core_year
sca sample_r=r(N)
mat criteria_r[1,1]=r(N)

local j=2
foreach v in `smi_vars' {
replace `v'=1 if `v'>0 & `v'!=.
tab `v',matcell(x1_`j')
mat criteria_r[`j',1]=x1_`j'[2,1]
mat criteria_r[`j',2]=x1_`j'[2,1]/sample_r*100
local j = `j'+1
}

mat list criteria_r

frmttable using `logpath'\sic_Tables_7_outcomes_crit_a_b_c, statmat(criteria_r) ///
title("Serious illness cohort, criteria, respondent level") ///
ctitle("","N Respondents","% respondents") ///
rtitle("Overall n R's" \ "Any serious medical illness"\  ///
"ADL Impairment"\ "Med Ill and ADL Impairment" \"Med Ill and/or ADL Impairment"\ ///
"Med Ill and/or ADL Imp + NH"\ ///
"Med Ill and/or ADL Imp + Hosp"\ "Med Ill and/or ADL Imp + NH and/or Hosp"\ ///
"Med Ill and ADL Imp + NH"\ "Med Ill and ADL Imp + Hosp"\ "Med Ill and ADL Imp + NH and/or Hosp") ///
sdec(0,2) replace

clear
***************************************************************
***************************************************************
//Table 2
***************************************************************
***************************************************************
mat ivws=J(16,6,.)
local col = 1
foreach crit in a b c{
	use n0_n1_p1_p2_x_criteria_`crit'_v1.dta if core_year_n0<2010

	sum core_year_n0
	mat ivws[1,`col']=r(N) //overall n meet criteria
	mat ivws[1,`col'+1]=100 //percent of n

***First section, looking at meeting criteria 1st interview

	sum core_year_n0 if ind_n1_interview==1 & part_ab_12m_n1==1 & hmo_d_12m_n1==0
	mat ivws[2,`col']=r(N) //have n1 interview with ffs mc 1 year pre
	mat ivws[2,`col'+1]=ivws[2,`col']/ivws[1,`col']*100

	sum core_year_n0 if ind_n1_interview==0 | part_ab_12m_n1~=1 | hmo_d_12m_n1!=0
	mat ivws[3,`col']=r(N) //total no n1 interview, so meet criteria 1st year
	mat ivws[3,`col'+1]=ivws[3,`col']/ivws[1,`col']*100
	
	sum core_year_n0 if ind_n1_interview==1 & part_ab_12m_n1==. & hmo_d_12m_n1==.
	mat ivws[4,`col']=r(N) //have n1 but don't have denominator file that ivw (pre 2000)
	mat ivws[4,`col'+1]=ivws[4,`col']/ivws[3,`col']*100
	
	//why so many missing denominator files? check interview year, don't have files before Jan 2000
	tab c_ivw_year_n1 if ind_n1_interview==1 & part_ab_12m_n1==. & hmo_d_12m_n1==., missing
	
	sum core_year_n0 if c_ivw_n1_pre2001==1 & ind_n1_interview==1 & part_ab_12m_n1==. & hmo_d_12m_n1==.
	mat ivws[5,`col']=r(N) //have n1 but missing dn file b/c pre 2001 ivw
	mat ivws[5,`col'+1]=ivws[5,`col']/ivws[3,`col']*100	

	sum core_year_n0 if c_ivw_n1_pre2001==0 & age_ge_66_n1==0 & ind_n1_interview==1 & part_ab_12m_n1==. & hmo_d_12m_n1==.
	mat ivws[6,`col']=r(N) //have n1 but missing dn file, later than 2001 but age less than 66 at ivw
	mat ivws[6,`col'+1]=ivws[6,`col']/ivws[3,`col']*100	

	sum core_year_n0 if c_ivw_n1_pre2001==0 & age_ge_66_n1==1 & ind_n1_interview==1 & part_ab_12m_n1==. & hmo_d_12m_n1==.
	mat ivws[7,`col']=r(N) //have n1 but missing dn file, really missing, can't tell why from age and ivw year
	mat ivws[7,`col'+1]=ivws[7,`col']/ivws[3,`col']*100		
		
	sum core_year_n0 if ind_n1_interview==1 & part_ab_12m_n1==0
	mat ivws[8,`col']=r(N) //have n1 but not parts a/b medicare 1 year pre
	mat ivws[8,`col'+1]=ivws[8,`col']/ivws[3,`col']*100

	sum core_year_n0 if ind_n1_interview==1 & part_ab_12m_n1==1 & hmo_d_12m_n1==1
	mat ivws[9,`col']=r(N) //have n1 but hmo medicare 1 year pre
	mat ivws[9,`col'+1]=ivws[9,`col']/ivws[3,`col']*100

	sum core_year_n0 if ind_n1_interview==0
	mat ivws[10,`col']=r(N) //missing n1 interview
	mat ivws[10,`col'+1]=ivws[10,`col']/ivws[3,`col']*100

***Second section, looking at missing p1 interviews
	sum core_year_n0 if (core_to_dod_2yr_n0==1 & ind_x_interview==0) | ///
		(core_to_dod_2yr_n0==0 & ind_p1_interview==0) | ///
		(core_to_dod_2yr_n0==0 & ind_p1_interview==1 & (part_ab_12m_p1!=1 | hmo_d_12m_p1!=0))
	mat ivws[11,`col']=r(N) //no follow up interview
	mat ivws[11,`col'+1]=ivws[11,`col']/ivws[1,`col']*100

	sum core_year_n0 if (core_to_dod_2yr_n0==1 & ind_x_interview==0)
	mat ivws[12,`col']=r(N) //died but no exit interview
	mat ivws[12,`col'+1]=ivws[12,`col']/ivws[1,`col']*100  

	sum core_year_n0 if (core_to_dod_2yr_n0==0 & ind_p1_interview==0)
	mat ivws[13,`col']=r(N) //didn't die but no p1
	mat ivws[13,`col'+1]=ivws[13,`col']/ivws[1,`col']*100  
	
	sum core_year_n0 if (core_to_dod_2yr_n0==0 & ind_p1_interview==1 & (part_ab_12m_p1==. | hmo_d_12m_p1==.))
	mat ivws[14,`col']=r(N) //have p1 but missing denominator info full year preceding p1
	mat ivws[14,`col'+1]=ivws[14,`col']/ivws[1,`col']*100 

tab c_ivw_year_p1 if (core_to_dod_2yr_n0==0 & ind_p1_interview==1 & (part_ab_12m_p1==. | hmo_d_12m_p1==.)), missing
	
	sum core_year_n0 if (core_to_dod_2yr_n0==0 & ind_p1_interview==1 & (part_ab_12m_p1==0))
	mat ivws[15,`col']=r(N) //have p1 but not parts a b medicare 1 year preceding p1
	mat ivws[15,`col'+1]=ivws[15,`col']/ivws[1,`col']*100 

	sum core_year_n0 if (core_to_dod_2yr_n0==0 & ind_p1_interview==1 & (hmo_d_12m_p1==1))
	mat ivws[16,`col']=r(N) //have p1 but hmo medicare 1 year preceding p1
	mat ivws[16,`col'+1]=ivws[16,`col']/ivws[1,`col']*100 

	local col = `col'+2
		
	clear
}

frmttable using `logpath'\sic_Tables_7_outcomes_crit_a_b_c, statmat(ivws) ///
title("Accounting for missing interviews")  ///
rtitles("N meet criteria n0 interview"\""\ ///
"Do not meet criteria in first interview" \"" \ ///
"Meet criteria in first interview with full " \"information" \ ///
"Have n1 ivw but missing dn file 1y pre" \"(percent of those meeting 1st ivw)"\ ///
"Missing dn file bc ivw before 2001" \ "" \ ///
"Missing dn because age<66 at ivw " \ "(ivw 2001 or later)" \ ///
"Missing dn for unknown reason" \ "" \ "Have n1 ivw but not mc parts a&b 1y pre" \"" \ ///
"Have n1 ivw but HMO 1y pre"\"" \ "No n1 interview in HRS" \ "" \ ///
"Missing follow up interview"\""\ "Died within 2 years but no exit interview" \""\ ///
"Did not die but no p1 ivw" \""\ "Had p1 interview but missing dn file 1 year pre" \"" \ ///
"Had p1 interview, but not Part A, B Medicare " \ "1 yr pre"\"Had p1 ivw, but HMO 1 year pre" \ "") ///
ctitles("" "Criteria A" "Criteria B" "Criteria C" \ "" "n" "n" "n" \ "" "(percent)" "(percent)" "(percent)" ) ///
note("Criteria A = Any serious medical illness and/or ADL impairment" \ ///
"Criteria B = Criteria A and Urgent / Emergent hospitalization and/or NH resident" \ ///
"Criteria C = Medical illness and ADL Impairment and hospitalization and/or NH resident" \ ///
"All missing denominator file for p1 ivw are for interviews that took place in 2011.") ///
substat(1) sdec(0\1) addtable

***************************************************************
***************************************************************
//Table 3 - Looking at full set of outcomes, 3 criteria
***************************************************************
***************************************************************
//use dataset with outcomes, just obs that meet interview sample inclusion criteria
use `datapath2'\ivws_crit_1.dta if inlist(core_year,2000,2002,2004,2006,2008) & /// 
age_ge_65==1 & xwalk_yes==1 & part_ab_12m==1 & hmo_d_12m==0

local outcome1 core_to_dod_1yr hs_admit_p12m ind_em_ur_adm_p12m

local outcome2 ip_paid_by_mc_1yr_wi snf_paid_by_mc_1yr_wi hh_paid_by_mc_1yr_wi hs_paid_by_mc_1yr_wi ///
pb_paid_by_mc_1yr_wi op_paid_by_mc_1yr_wi dm_paid_by_mc_1yr_wi tot_paid_by_mc_1yr_wi n_hospd_p12m


mat table2=J(34,3,.)
//first row, n for each category
tab ivw_meet_crit_a ,matcell(row1a)
mat table2[1,1]=row1a[2,1]
tab ivw_meet_crit_b ,matcell(row1b)
mat table2[1,2]=row1b[2,1]
tab ivw_meet_crit_c ,matcell(row1c)
mat table2[1,3]=row1c[2,1]

local c=1
foreach crit of varlist ivw_meet_crit_a ivw_meet_crit_b ivw_meet_crit_c {
local r=2
foreach v in `outcome1'{
	sum `v' if `crit'==1, detail
	mat table2[`r',`c']=r(mean)
	mat table2[`r'+1,`c']=r(sd)
	local r=`r'+2 //populates rows 2-7 for indicator variable outcomes
	}

local r=8
foreach v in `outcome2'{
	sum `v' if `crit'==1, detail
	mat table2[`r',`c']=r(mean)
	mat table2[`r'+1,`c']=r(p50)
	mat table2[`r'+2,`c']=r(sd)
	local r=`r'+3 //populates rows 8-34 for continuous variables
	}
local c=`c'+1	
}

mat rownames table2="N" "Died, mean" "SD" "Hospice enr, mean" "SD" "Emerg or urgent hosp admit, mean" "SD" ///
"IP Medicare payments, mean" "Median" "SD" "SNF Medicare payments, mean" "Median" "SD" ///
"HH Medicare payments, mean" "Median" "SD" "Hospice Medicare payments, mean" "Median" "SD" ///
"Carrier Medicare payments, mean" "Median" "SD" "OP Medicare payments, mean" "Median" "SD" ///
"DME Medicare payments, mean" "Median" "SD" "Total Medicare payments, mean" "Median" "SD" ///
"Hospital nights, mean" "Median" "SD"

frmttable using `logpath'\sic_Tables_7_outcomes_crit_a_b_c, statmat(table2) ///
title("Comparison of outcomes at 1 year, criteria a, b, c" \ ///
"First interview when R meets criteria") ///
ctitle("" "Criteria A" "Criteria B" "Criteria C" ) ///
note("Criteria A = Any serious medical illness and/or ADL impairment" \ ///
"Criteria B = Criteria A and Urgent / Emergent hospitalization and/or NH resident" \ ///
"Criteria C = Medical illness and ADL Impairment and hospitalization and/or NH resident" \ ///
"Medicare spending values are adjusted for inflation (2010$) and the CMS wage index.") ///
sdec(0\2\2\2\2\2\2\0) addtable 

***************************************************************
***************************************************************
//Table 4 - Looking at 2 year outcomes, using p1 interview
***************************************************************
***************************************************************
mat p1_crit=J(5,6,.)

local col = 1
foreach crit in a b c{
	use n0_n1_p1_p2_x_criteria_`crit'_v1.dta if core_year_n0<2010
		
**1st table looking at follow up outcomes
	sum core_year_n0
	mat p1_crit[1,`col']=r(N) //overall n meet criteria
	mat p1_crit[1,`col'+1]=100 //percent of n

	sum core_year_n0 if ind_p1_interview==0 & core_to_dod_2yr_n0==1 & ind_x_interview==1
	mat p1_crit[2,`col']=r(N) //no p1 interview, died within 2 years, with exit interview
	mat p1_crit[2,`col'+1]=p1_crit[2,`col']/p1_crit[1,`col']*100

	tab criteria_`crit'_p1 if ind_p1_interview==1 & part_ab_12m_p1==1 & hmo_d_12m_p1==0, matcell(p1)
	mat p1_crit[3,`col']=p1[2,1] //n that meet criteria p1
	mat p1_crit[3,`col'+1]=p1_crit[3,`col']/p1_crit[1,`col']*100
	mat p1_crit[4,`col']=p1[1,1] //n that do not meet criteria p1
	mat p1_crit[4,`col'+1]=p1_crit[4,`col']/p1_crit[1,`col']*100
	
	sum core_year_n0 if (core_to_dod_2yr_n0==1 & ind_x_interview==0) | ///
		(core_to_dod_2yr_n0==0 & ind_p1_interview==0) | ///
		(core_to_dod_2yr_n0==0 & ind_p1_interview==1 & (part_ab_12m_p1!=1 | hmo_d_12m_p1!=0))
	mat p1_crit[5,`col']=r(N) //no follow up interview
	mat p1_crit[5,`col'+1]=p1_crit[5,`col']/p1_crit[1,`col']*100

		local col = `col'+2
		
	clear
}
	 
frmttable using `logpath'\sic_Tables_7_outcomes_crit_a_b_c, statmat(p1_crit) ///
title("Meet criteria in p1 interview")  ///
rtitles("Overall n meet criteria n0 interview"\""\ "Died within 2 years and have exit interview" \ ///
""\"Meet criteria in p1 interview" \""\ "Do not meet criteria in p1 interview" \""\ ///
"Missing follow up interview, see notes"\"") ///
ctitles("" "Criteria A" "Criteria B" "Criteria C" \ "" "n" "n" "n" \ "" "(percent)" "(percent)" "(percent)" ) ///
note("Criteria A = Any serious medical illness and/or ADL impairment" \ ///
"Criteria B = Criteria A and Urgent / Emergent hospitalization and/or NH resident" \ ///
"Criteria C = Medical illness and ADL Impairment and hospitalization and/or NH resident" \ ///
"Missing follow up if R died within 2 years of meet criteria but no exit interview,"  \ ///
"R did not die within 2 years, has no p1 interview," \ ///
"or R has p1 interview but not FFS MC 1 year preceding p1 interview.") ///
substat(1) sdec(0\1) addtable

***************************************************************
// Table 5
//Typical Table 1 looking at characteristics of those that meet
//each of the requirements, the first interview where they meet
***************************************************************
local tab5list age_at_core_n0 female_n0 re_black re_white re_hisp re_other_unk ///
educ_level_lt_hs educ_level_hs educ_level_somcol educ_level_col ///
srh_pf_n0 srh_g_n0 srh_ve_n0 married_n0 networth_adj2010_n0 ///
smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 smi_chf_ind_n0 smi_copd_ind_n0 ///
smi_diab_compl_ind_n0 smi_liver_ind_n0 smi_als_ind_n0 smi_hip_ind_n0 ///
ser_med_illness_n0 adl_impair_core_n0 smi_and_adl_n0 smi_nh_ind_n0 ind_em_ur_adm_12m_n0 ///
adl_stable_ind_n0n1 adl_stable_partial_n0n1 adl_stable_severe_n0n1 ///
adl_change_i_m_n0n1 adl_change_i_s_n0n1 adl_change_m_s_n0n1 adl_improved_n0n1


mat tab5=J(36,6,.)

local col = 1
foreach crit in a b c{
	use n0_n1_p1_p2_x_criteria_`crit'_v1.dta if core_year_n0<2010
	
	local row = 1
	foreach v in `tab5list'{
		sum `v', detail
		mat tab5[`row',`col']=r(mean) //mean
		mat tab5[`row',`col'+1]=r(sd) //sd
		local row = `row'+1
		}
	local col = `col'+2
		
	clear
}
local r   \ "SD"

frmttable using `logpath'\sic_Tables_7_outcomes_crit_a_b_c, statmat(tab5) ///
title("Sample characteristics - Interview first meet criteria A, B, C")  ///
rtitles("Age (years)"`r'\  "Female" `r'\ "Race - Black" `r'\ "Race - White" `r'\ ///
"Hispanic Ethnicity"`r'\"Unknown race/ethnicity" `r'\"Educ - Less than HS"`r'\ ///
"High school degree" `r'\"Some college"`r'\ ///
"College degree or higher"`r'\ "SRH Fair/Poor" `r'\ "SRH Good" `r'\ ///
"SRH Very good/Excellent" `r'\ "Married" `r'\ ///
"Net worth" `r' \"Dementia"`r'\ "Cancer"`r'\"ESRD" `r'\ "CHF" `r'\ ///
 "COPD" `r'\ "Diabetes" `r'\ "Liver disease" `r'\ ///
"ALS" `r'\ "Hip fracture" `r'\ "Any serious medical illness" `r'\ ///
"ADL impairment"`r' \ "Illness and ADL Impair" `r'\ ///
"Nursing home resident" `r'\ "Urgent/emergent hospitalization" `r'\ "ADL independent n0 and n1" `r'\ ///
"ADL Partial Depend n0 and n1"`r' \ "ADL Severe Depend n0 and n1" `r'\ "ADL ind n1 to Partial Dep n0" `r'\ ///
"ADL ind n1 to Severe Dep n0" `r'\ "ADL Partial to Sev Dep n1 to n0" `r'\ "ADL improved n1 to n0" `r'  ) ///
ctitles("" "Criteria A" "Criteria B" "Criteria C" ) ///
note("Criteria A = Any serious medical illness and/or ADL impairment" \ ///
"Criteria B = Criteria A and Urgent / Emergent hospitalization and/or NH resident" \ ///
"Criteria C = Medical illness and ADL Impairment and hospitalization and/or NH resident") ///
substat(1) sdec(2) addtable

***************************************************************
log close




H="Tables - Hospital use required in CHF, COPD criteria"
/*A hospital stay is required for flagging an R as having CHF or COPD
since (at least part of) the definition requires the diagnosis to be
the primary diagnosis from an inpatient claim

Look at outcomes to see if this really matters by checking outcomes
with and without inclusion of these criteria

Creates 3 tables, one for each of the criteria*/

capture log close

clear all
set mem 500m
set more off

local logpath E:\data\serious_ill\logs
local datapath2 E:\data\serious_ill\int_data
local datapath E:\data\serious_ill\final_data

log using "`logpath'\8_compare_3_criteria_copd_chf.txt", text replace

cd `datapath'

****************************************************
local outcome1 core_to_dod_1yr_n0 hs_admit_p12m_n0 ind_em_ur_adm_p12m_n0

local outcome2 ip_paid_by_mc_1yr_wi_n0 snf_paid_by_mc_1yr_wi_n0 hh_paid_by_mc_1yr_wi_n0 hs_paid_by_mc_1yr_wi_n0 ///
pb_paid_by_mc_1yr_wi_n0 op_paid_by_mc_1yr_wi_n0 dm_paid_by_mc_1yr_wi_n0 tot_paid_by_mc_1yr_wi_n0 n_hospd_p12m_n0

foreach crit in a b c{
	clear
	use n0_n1_p1_p2_x_criteria_`crit'_v1.dta if core_year_n0<2010

	mat crit_`crit'=J(34,3,.)

//first row, n for each category
//indicator that copd or chf diagnosis is required is created in Step 12
	tab meet_`crit'_copd_chf_req_n0, missing matcell(row1)
	mat crit_`crit'[1,1]=row1[2,1] //copd or chf is required
	mat crit_`crit'[1,2]=row1[1,1] //copd or chf not required

local c=1
foreach i in 1 0{
local r=2
foreach v in `outcome1'{
	sum `v' if meet_`crit'_copd_chf_req_n0==`i', detail
	mat crit_`crit'[`r',`c']=r(mean)
	mat crit_`crit'[`r'+1,`c']=r(sd)
	local r=`r'+2 //populates rows 2-7 for indicator variable outcomes
	}

local r=8
foreach v in `outcome2'{
	sum `v' if meet_`crit'_copd_chf_req_n0==`i', detail
	mat crit_`crit'[`r',`c']=r(mean)
	mat crit_`crit'[`r'+1,`c']=r(p50)
	mat crit_`crit'[`r'+2,`c']=r(sd)
	local r=`r'+3 //populates rows 8-34 for continuous variables
	}
local c=`c'+1	
}

//pvalues comparing outcomes
local c = 3
local r=2
foreach v in `outcome1'{
	tab `v' meet_`crit'_copd_chf_req_n0, chi2
	mat crit_`crit'[`r',`c']=r(p)
	local r=`r'+2 //populates rows 2-7 for indicator variable outcomes
	}
local r=8
foreach v in `outcome2'{
	ttest `v', by(meet_`crit'_copd_chf_req_n0)
	mat crit_`crit'[`r',`c']=r(p)
	local r=`r'+3 //populates rows 8-34 for continuous variables
}

mat rownames crit_`crit'="N" "Died, mean" "SD" "Hospice enr, mean" "SD" "Emerg or urgent hosp admit, mean" "SD" ///
"IP MC, mean" "Median" "SD" "SNF MC, mean" "Median" "SD" ///
"HH MC, mean" "Median" "SD" "Hospice MC, mean" "Median" "SD" ///
"Carrier MC, mean" "Median" "SD" "OP MC, mean" "Median" "SD" ///
"DME MC, mean" "Median" "SD" "Total MC, mean" "Median" "SD" ///
"Hospital nights, mean" "Median" "SD"

}

frmttable using "`logpath'\sic_Table8_outcomes_copd_chf", statmat(crit_a) ///
title("Comparison of outcomes at 1 year, criteria A" \ ///
"First interview when R meets criteria" \ ///
"Criteria including CHF &COPD definitions vs excluding them") ///
ctitle("" "CHF and COPD required" "CHF and COPD Not Required" "P-value") ///
note("Medicare spending adjusted for inflation and the CMS wage index." \ ///
"Criteria A = Serious medical illness and/or ADL impairment.") ///
sdec(2,2,3) replace

frmttable using "`logpath'\sic_Table8_outcomes_copd_chf", statmat(crit_b) ///
title("Comparison of outcomes at 1 year, criteria B" \ ///
"First interview when R meets criteria" \ ///
"Criteria including CHF &COPD definitions vs excluding them") ///
ctitle("" "CHF and COPD required" "CHF and COPD Not Required" "P-value") ///
note("Medicare spending adjusted for inflation and the CMS wage index" \ ///
"Criteria B = Criteria A and Nursing home resident and/or hospitalization") ///
sdec(2,2,3) addtable

frmttable using "`logpath'\sic_Table8_outcomes_copd_chf", statmat(crit_c) ///
title("Comparison of outcomes at 1 year, criteria C" \ ///
"First interview when R meets criteria" \ ///
"Criteria including CHF &COPD definitions vs excluding them") ///
ctitle("" "CHF and COPD required" "CHF and COPD Not Required" "P-value") ///
note("Medicare spending adjusted for inflation and the CMS wage index" \ ///
"Criteria C = Medical illness and ADL impairment and Nursing Home res and/or hospitalization.") ///
sdec(2,2,3) addtable

****************************************************
log close

tab core_year_n0


H="Bar graph - p1 outcomes, critera a,b,c"
/*Bar graphs comparing p1 outcomes of the 3 criteria

Note, this requires manual set up of data once its exported
into 3 separate .csv files*/

capture log close

clear all
set mem 500m
set more off

local logpath E:\data\serious_ill\logs
local datapath2 E:\data\serious_ill\int_data
local datapath E:\data\serious_ill\final_data

log using "`logpath'\9_bar_graph_p1_outcomes.txt", text replace

cd `datapath'

****************************************************

foreach crit in a b c{
	clear
	use n0_n1_p1_p2_x_criteria_`crit'_v1.dta if core_year_n0<2010

	//create indiicators for each of the 4 outcome possibilities
	gen p1_exit = 0
	replace p1_exit = 1 if ind_p1_interview==0 & core_to_dod_2yr_n0==1 & ind_x_interview==1
	
	gen p1_meet = 0
	replace p1_meet = 1 if criteria_`crit'_p1==1 & ind_p1_interview==1 & part_ab_12m_p1==1 & hmo_d_12m_p1==0
	
	gen p1_notmeet = 0
	replace p1_notmeet = 1 if criteria_`crit'_p1==0 & ind_p1_interview==1 & part_ab_12m_p1==1 & hmo_d_12m_p1==0
	
	gen p1_miss = 0
	replace p1_miss = 1 if (core_to_dod_2yr_n0==1 & ind_x_interview==0) | ///
		(core_to_dod_2yr_n0==0 & ind_p1_interview==0) | ///
		(core_to_dod_2yr_n0==0 & ind_p1_interview==1 & (part_ab_12m_p1!=1 | hmo_d_12m_p1!=0))

		
collapse (mean) p1_exit	p1_meet	p1_notmeet p1_miss (count) criteria_`crit'_n0
list

//export excel `datapath'\excel_means_`crit', replace
outsheet using `datapath'\excel_means_`crit'.csv, comma replace
}
****************************************************
clear

insheet using `datapath'\import_means.csv

sum n if _n==1
local n_a = r(mean)

sum n if _n==2
local n_b = r(mean)

sum n if _n==3
local n_c = r(mean)

graph hbar p1_exit p1_meet p1_notmeet p1_miss, over(v1) percentage stack ///
	blabel(bar, position(center) format(%3.1f))///
	legend(lab(1 "Expired") lab(2 "Meets criteria p1") ///
	lab(3 "Does not meet criteria p1") lab(4 "Missing p1 status")) ///
	text(-1 79 "n=`n_a'", place(w)) ///
	text(-1 44 "n=`n_b'", place(w)) ///
	text(-1 9 "n=`n_c'", place(w))
	
graph save `logpath'\bar_graph_p1_status, replace	


****************************************************
log close




H="Looking at dementia indicator"
/*A hospital stay is required for flagging an R as having CHF or COPD
since (at least part of) the definition requires the diagnosis to be
the primary diagnosis from an inpatient claim

Look at outcomes to see if this really matters by checking outcomes
with and without inclusion of these criteria

Creates 3 tables, one for each of the criteria*/

capture log close

clear all
set mem 500m
set more off

local logpath E:\data\serious_ill\logs
local datapath2 E:\data\serious_ill\int_data
local datapath E:\data\serious_ill\final_data

log using "`logpath'\10_compare_3_criteria_dementia.txt", text replace

cd `datapath'

****************************************************
mat dem=J(28,6,.)

local c=1
foreach crit in a b c{
	clear
	use n0_n1_p1_p2_x_criteria_`crit'_v1.dta if core_year_n0<2010

	//lookinga t tics distribution
	sum core_year_n0 if meet_`crit'_dement_req_n0==1
	mat dem[1,`c'] = r(N)
	
	tab tics_cat_n0 proxy_core_n0 if meet_`crit'_dement_req_n0==1, missing
	
	tab tics_cat_n0 if meet_`crit'_dement_req_n0==1, missing matcell(tics_`crit')
	mat dem[2,`c']=tics_`crit'[4,1]/r(N)*100  //missing
	mat dem[3,`c']=tics_`crit'[1,1]/r(N)*100 //normal
	mat dem[4,`c']=tics_`crit'[2,1]/r(N)*100 //mci
	mat dem[5,`c']=tics_`crit'[3,1]/r(N)*100 //demented
	
	sum core_year_n0 if smi_dem_ind_n0==1
	mat dem[1,`c'+1] = r(N)
	tab tics_cat_n0 if smi_dem_ind_n0==1,  missing matcell(ind_`crit')
	mat dem[2,`c'+1]=ind_`crit'[4,1]/r(N)*100  //missing
	mat dem[3,`c'+1]=ind_`crit'[1,1]/r(N)*100 
	mat dem[4,`c'+1]=ind_`crit'[2,1]/r(N)*100 
	mat dem[5,`c'+1]=ind_`crit'[3,1]/r(N)*100 

	sum memory_hrs_n0 if meet_`crit'_dement_req_n0==1
	mat dem[6,`c']=r(mean)*100  //missing
	
	sum memory_hrs_n0 if smi_dem_ind_n0==1
	mat dem[6,`c'+1]=r(mean)*100  //missing	
	
	tab sr_memory_n0 if meet_`crit'_dement_req_n0==1,  missing matcell(ind_`crit')
	local r = 7
	forvalues i = 1/6{
		mat dem[`r',`c']=ind_`crit'[`i',1]/r(N)*100  //missing
		local r = `r'+1
	}
	
	tab sr_memory_n0 if smi_dem_ind_n0==1,  missing matcell(ind2_`crit')
	local r = 7
	forvalues i = 1/6{
		mat dem[`r',`c'+1]=ind2_`crit'[`i',1]/r(N)*100  //missing
		local r = `r'+1
	}
	
	tab sr_mem_change_n0 if meet_`crit'_dement_req_n0==1,  missing matcell(ind_`crit')
	local r = 13
	forvalues i = 1/4{
		mat dem[`r',`c']=ind_`crit'[`i',1]/r(N)*100  
		local r = `r'+1
	}

	tab sr_mem_change_n0 if smi_dem_ind_n0==1,  missing matcell(ind2_`crit')
	local r = 13
	forvalues i = 1/4{
		mat dem[`r',`c'+1]=ind2_`crit'[`i',1]/r(N)*100  
		local r = `r'+1
	}

	tab pr_memory_n0 if meet_`crit'_dement_req_n0==1,  missing matcell(ind_`crit')
	local r = 17
	forvalues i = 1/6{
		mat dem[`r',`c']=ind_`crit'[`i',1]/r(N)*100  
		local r = `r'+1
	}

	tab pr_memory_n0 if smi_dem_ind_n0==1,  missing matcell(ind2_`crit')
	local r = 17
	forvalues i = 1/6{
		mat dem[`r',`c'+1]=ind2_`crit'[`i',1]/r(N)*100  
		local r = `r'+1
	}
	
	tab pr_mem_change_n0 if meet_`crit'_dement_req_n0==1,  missing matcell(ind_`crit')
	local r = 23
	forvalues i = 1/4{
		mat dem[`r',`c']=ind_`crit'[`i',1]/r(N)*100  
		local r = `r'+1
	}
	
	tab pr_mem_change_n0 if smi_dem_ind_n0==1,  missing matcell(ind2_`crit')
	local r = 23
	forvalues i = 1/4{
		mat dem[`r',`c'+1]=ind2_`crit'[`i',1]/r(N)*100  
		local r = `r'+1
	}

	//have only 1 vs more than 1 dementia diagnosis
	gen dem_dx_gt1 = 0 if dem_dx_1yr_n0 ==1
	replace dem_dx_gt1 = 1 if dem_dx_1yr_n0>1 & dem_dx_1yr_n0!=.
	tab dem_dx_1yr_n0, missing
	tab dem_dx_gt1, missing //left as missing for those with no dementia dx

	tab dem_dx_gt1 if meet_`crit'_dement_req_n0==1,  missing matcell(ind_`crit')
	local r = 27
	forvalues i = 1/2{
		mat dem[`r',`c']=ind_`crit'[`i',1]/r(N)*100  
		local r = `r'+1
		}

	tab dem_dx_gt1 if smi_dem_ind_n0==1,  missing matcell(ind2_`crit')
	local r = 27
	forvalues i = 1/2{
		mat dem[`r',`c'+1]=ind2_`crit'[`i',1]/r(N)*100  
		local r = `r'+1
		}

		local c = `c'+2
	}

mat list dem
	
frmttable using "`logpath'\sic_Table10_dementia", statmat(dem) ///
title("Looking at Dementia Serious Illness Criteria" \ ///
"First interview when R meets criteria") ///
ctitle("" "Criteria A" "" "Criteria B" "" "Criteria C" "" \ ///
"" "Required" "Has dementia dx" "Required" "Has dementia dx" "Required" "Has dementia dx" ) ///
rtitle("N" \ "TICS missing" \ "TICS Normal >8, %" \ "MCI 5-8"\ "Demented 0-4" \ ///
"SR memory disease" \ "Self-rate memory 1= Excellent" \ "2=Very good" \ ///
"3=Good" \ "4=Fair" \ "5=Poor" \ "Missing" \ "Self-rate memory change 1=Better" \ ///
"2=Same" \ "3=Worse" \ "Missing" \ "Proxy-rate memory 1= Excellent" \ "2=Very good" \ ///
"3=Good" \ "4=Fair" \ "5=Poor" \ "Missing" \ "Proxy-rate memory change 1=Better" \ ///
"2=Same" \ "3=Worse" \ "Missing" \ "Only 1 dementia dx" \ "More than 1 dementia dx") ///
note("Criteria A = Serious medical illness and/or ADL impairment." \ ///
"All R's with missing TICS score are b/c proxy interview." \ ///
"Dementia diagnosis counts are for 1 year preceding the core interview.") ///
sdec(0\1) replace

****************************************************
log close



H="xxxxNotes"
Helper files - A respondant gets an entry (or many entries) in the helper file
if they report getting help in the ADLs, IADLs and Money (MG062_1 or _2) questions:

data helper_check;
set core_pre.H10g_hp;
if MADLNDX=. & MIADLNDX=. & MMNYNDX=.;
run;
No observations without one of the three links.

Notes regarding Elixhauser comorbidity coding:
See the email list of ICD-9 codes provided by Amy on 4/3/14
This list modifies the original ICD-9 codes used to better suit the serious
illness definitions

From reading through Elixhauser et al (1998) the original purpose
was to identify comorbidities that are underlying conditions, so not the
reason for hospital admission. So if a diagnosis was the primary diagnosis,
or if it was related to the primary DRG of the patient, it was NOT used 
in coding the Elixhauser comorbidity index. This is different from what we are
doing in that we want to identify people with serious illness, regardless
(and in many cases specifically) if they are the primary disease or diagnosis.



H="xxxx Additional checks"
proc freq data=bid_dx_0_1yr;
table cc_1_ami  /missprint;
run;

proc freq data=bid_dx_0_1yr2;
table cc_1_ami  /missprint;
run;

proc freq data=sic_int.core_ids_elix_1yr;
table comorb:;
run;

proc sql;
select count(distinct cats(BID_HRS_19,core_year)) from sic_int.dx_0_1yr;
quit;



H="xxxxAdditional variables from claims"
/*********************************************************/
/******* Any admission to the ICU                *********/
/*********************************************************/
/*Comes from medpar claims
Code below from Melissa's hospice project, need to adapt
for the HRS linked MC claims*/

proc freq data=medpar2;
table ICU_IND_CD /missprint;
run;

/*create indicator for ICU and/or ED use during stay
ICUED=0 - no icu or ed use
=1 ED only
=2 ICU only
=3 ICU and ED*/
data medpar3;
	set medpar2;
	if ICU_IND_CD ~= . or INTNSV_CARE_DAY_CNT>0 then ICU = 1;
	if ICU_IND_CD = . and INTNSV_CARE_DAY_CNT=0 then ICU = 0;
	if SS_LS_SNF_IND_CD ~= 'N';
	ED = 0;
	if ER_CHRG_AMT > 0 then ED = 1;
	if ICU = 1 and ED = 1 then ICUED = 3;
	if ICU = 1 and ED = 0 then ICUED = 2;
	if ICU = 0 and ED = 1 then ICUED = 1;
	if ICU = 0 and ED = 0 then ICUED = 0;
	drop icu ed;
run;


/*Notes re OP ED Use, from Melissa's project
Uses Revenue center codes*/

data ed;
	set revenue0;
	if REV_CNTR >= 450 and REV_CNTR < 460;
	ed = 1;
run;

Each OP claim has up to 45 REV_CNTR variables:
 	RVCNTR01-RVCNTR45