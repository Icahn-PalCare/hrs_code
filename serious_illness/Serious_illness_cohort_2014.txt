= V4 Outline MultiLine NoSorting TabWidth=30

H="Serious illness cohort definition development"
HRS variables are processed in file HRS_Processing.txt
1998-2010 Core interviews
2002-2010 Exit interviews
Restricted data received in November 2013

Note elixhauser comorbidities diagnosis lists are modified for the 
purposes of this project, do not copy and paste this Elixhauser code 
for use in other projects!!

******************************************************************

/*hrs cleaned path*/
libname hrs_fnl 'E:\data\hrs_cleaned';

/*medicare xwalk and claims path*/
libname medi 'E:\data\cms_DUA_25000_2010';

/*project data paths*/
libname sic_int 'E:\data\serious_ill\int_data';
libname sic_fin 'E:\data\serious_ill\final_data';
libname sic_ref 'E:\data\serious_ill\ref_data';

%let logdir=E:\data\serious_ill\logs;


H="Initial core criteria"
/***********************************************************************/
/*Core interview dataset, merge variables from restricted              */
/***********************************************************************/

/*proc printto new log='&logdir.\sas_1_sic_core_criteria_log.log'
	print='&logdir.\sas_1_sic_core_criteria_out.lst' 
run;*/

libname hrs_fnl 'E:\data\hrs_cleaned';

data core;
set hrs_fnl.core_00_to_10;
label c_ivw_year="Core interview year";
run;

proc sort data=core nodupkey;
by id core_year;
run;

data restr(rename=(ZIP10_2000=ZIP10));
set hrs_fnl.restricted_v2010(keep=hhid pn id birth_date death_date white black hisp_eth other_na_api_race zip:);
id_c=trim(hhid)||trim(pn);
drop id;
rename id_c=id;
restr_yes=1;
run;

proc sort data=restr nodupkey;
by id;
run;

proc contents data=restr; run;

proc sql;
create table core_dob(drop=id2) as select * from core a left join
restr(rename=(id=id2) drop=hhid pn) b 
on a.id=b.id2;
quit;

*5 obs have no match in the restricted dataset;
*These obs each only have 1 inteview, so can't use them anyway;
proc freq data=core_dob; table restr_yes /missprint; run;

data restr_test;
set core_dob;
if restr_yes=.;
run;

data core_age_1;
set core_dob;
format death_date date9.;
age_at_core=(c_ivw_date-birth_date)/365.25;
label age_at_core="Age at core interview";
if age_at_core>=65 then age_ge_65=1;
if age_at_core<65 then age_ge_65=0;
label age_ge_65="Age at core interview > 65";

core_to_death=(death_date-c_ivw_date)/365.25;
label core_to_death="Time from core ivw to death, years";
if core_to_death<=1 and core_to_death~=. then core_to_dod_1yr=1;
if core_to_death>1 or core_to_death=. then core_to_dod_1yr=0;
label core_to_dod_1yr="Died within 1 year of core interview";
run;

proc freq data=core_age_1;
table age_ge_65 core_to_dod_1yr /missprint;
run;


****************************************************************;
*get clean zip code variable by wave;
proc sort data=core_age_1; by id core_year; run;

/*get list of first and last interview years*/
data ivw_years_1;
set core_age_1;
by id; 
if first.id then first_ivw_year=core_year;
if last.id then last_ivw_year=core_year;
run;

data ivw_years_1a;
set ivw_years_1;
if first_ivw_year~=.;
run;

data ivw_years_1b;
set ivw_years_1;
if last_ivw_year~=.;
run;

proc sql;
create table ivw_years_2 as select a.id,a.first_ivw_year,b.last_ivw_year
from ivw_years_1a a left join
ivw_years_1b b
on a.id=b.id;
quit;

proc freq; table first_ivw_year last_ivw_year; run;

*merge into overall dataset;
proc sql;
create table core_age_zip_1 as select
a.*, b.first_ivw_year,b.last_ivw_year from
core_age_1 a left join
ivw_years_2 b
on a.id=b.id;
quit;

proc freq; table first_ivw_year last_ivw_year; run;

/*clean up missing zip variables
1. if missing, use interview prior
2. if still missing, use interview after
3. if still missing, use interview 2x prior...*/



data core_age_zip_2 ;
set core_age_zip_1 ;
/*1998 updates, use 2000 zip
1 obs only has one interview in our dataset for 1998 and is missing zip that year, won't be
in the final sample so leave as missing now*/
if zip98='' & first_ivw_year<=1998<=last_ivw_year then do;
	zip_98_imp_yes=1;
	zip98=zip00;
	end;
/*2000 updates, use 1998 zip
2 obs only have one interview in the dataset for 2000, missing zip that year, again not
in final sample so leave missing here*/
if zip00='' & first_ivw_year<=2000<=last_ivw_year then do;
	zip_00_imp_yes=1;
	zip00=zip98;
	end;
/*2002 updates, use 2000 or 2004 zip
1 obs has only the 2002 interview, leave zip missing for that person*/
if zip02='' & first_ivw_year<=2002<=last_ivw_year then do;
	zip_02_imp_yes=1;
	zip02=zip00;
		if zip02='' then do;
		zip02=zip04;
		end;
	end;
/*2004 updates, use 2002 or 2006 zip
13 obs has only the 2004 interview, leave zip missing for those observations*/
if zip04='' & first_ivw_year<=2004<=last_ivw_year then do;
	zip_04_imp_yes=1;
	zip04=zip02;
		if zip04='' then do;
		zip04=zip06;
		end; /*1 obs still missing, use 1998 zip for this person*/
				if zip04='' then do;
				zip04=zip98;
				end; 
	end;
/*2006 updates, use 2004 or 2008 zip
no observations missing*/
if zip06='' & first_ivw_year<=2006<=last_ivw_year then do;
	zip_06_imp_yes=1;
	zip06=zip04;
		if zip06='' then do;
		zip06=zip08;
		end; 
	end;
/*2008 updates, use 2006 zip
no observations missing*/
if zip08='' & first_ivw_year<=2008<=last_ivw_year then do;
	zip_08_imp_yes=1;
	zip08=zip06;
	end;
/*2010 updates, use 2008 zip
1 obs has only 2010 interview and missing zip that year, so leave missing*/
if zip10='' & first_ivw_year<=2010<=last_ivw_year then do;
	zip_10_imp_yes=1;
	zip10=zip08;
	end;
run;

proc sort data=core_age_zip_2; by id core_year; run;

*save dataset and drop raw zip code variables;
data sic_int.core_age_zip;
set core_age_zip_2;
zip_wave=vvaluex("zip"||substr(trim(left(core_year)),3,2) );
zip_imputed=vvaluex("zip_"||substr(trim(left(core_year)),3,2)||"_imp_yes" );
drop zip9: zip0: zip1: ;
label zip_wave="ZIP code, residence at time of interview";
label zip_imputed="ZIP code imputed";
run;

proc freq; table zip_wave  /missprint ; run;

proc freq; table zip_imputed /missprint ; run;

****************************************************************;

ods rtf body=" E:\data\serious_ill\logs\core_00_to_08_meet_criteria.rtf" ;
proc sql;
title "serious illness cohort, initial core interview criteria";
title "meet age>=65 at core interview,2000-2008";
select count(distinct id) from sic_int.core_age_zip
where age_ge_65=1 and core_year in (2000,2002,2004,2006,2008);
create table age_ge_65 as 
select * from sic_int.core_age_zip
where age_ge_65=1 and core_year in (2000,2002,2004,2006,2008);

title "those meet age>=65,srf(poor,fair)";
select count(distinct id) from age_ge_65 
where srh_pf=1 ;

title "those meet age>=65,chf";
select count(distinct id) from age_ge_65 
where chf_hrs=1 ;

title "those meet age>=65,lung";
select count(distinct id) from age_ge_65 
where lung_hrs=1 ;

title "those meet age>=65,diabetes";
select count(distinct id) from age_ge_65 
where dm_hrs=1 ;

title "those meet age>=65,cancer";
select count(distinct id) from age_ge_65 
where cancer_hrs=1 ;

title "those meet age>=65,chf or lung or diabetes or cancer";
select count(distinct id) from age_ge_65 
where  chf_hrs=1 or lung_hrs=1 or dm_hrs=1 or cancer_hrs=1 ;

title "those meet age>=65,hosp_last_2yr,since last interview";
select count(distinct id) from age_ge_65 
where hosp_last_2yr=1 ;

title "those meet age>=65,meet at least one,fair or poor self report/chf/lung/diabet/cancer/hosp_last_2yr";
select count(distinct id) from age_ge_65 
where  srh_pf=1 or chf_hrs=1 or lung_hrs=1 or dm_hrs=1 or cancer_hrs=1 or hosp_last_2yr=1 ;

title "age>=65,meet at least one,fair or poor self report/chf/lung/diabet/cancer/hosp_last_2yr/1 adl";
select count(distinct id) from age_ge_65 
where  srh_pf=1 or chf_hrs=1 or lung_hrs=1 or dm_hrs=1 or cancer_hrs=1 or hosp_last_2yr=1 
or adl_independent_core=0;

quit;
ods rtf close;



H="Create frequency tables of core variables"
/*creates log file to review with Amy for new variables*/

capture log close

clear all
set mem 1g
set matsize 800
set more off

//Need to create project file paths for new dataset, logs!
//Amy's PC
local logpath E:\data\serious_ill\logs
local datapath E:\data\hrs_cleaned\working

//RG PC
//local logpath C:\data\serious_illness_cohort\logs
//local datapath C:\HRS\hrs_cleaned\working

log using "`logpath'\1_sic_new_variables.txt", text replace
cd `datapath'

***********************************************************************
//Core interview dataset
***********************************************************************
use core_98_10_nw_tics.dta //dataset without core interview dates added (all public)

//indicator, categorical variables local, want frequency tables
local catvars alz_hrs dem_hrs cancer_hrs cancer_treat_hrs heart_hrs chf_hrs chfadmit_hrs ///
lung_hrs lung_o2_hrs lung_lim_hrs dm_hrs dm_ins_hrs dm_kidn_hrs hip_frac_hrs nhres ///
nhres_start_mo nhres_start_yr nhres_2yr  hh_worker hosp_last_2yr pain_hrs pain_level_hrs ///
pain_limit_act_hrs cesd_tot cesd_tot_ge3 dyspnea_hrs swelling_feet_hrs dizzy_hrs ///
back_pain_hrs headache_hrs fatigue_hrs cough_hrs depr_2_wks_hrs insom_falling_asleep insom_waking_up ///
insom_too_early insom_rested insom_med_sleep insom_med_dr sr_memory sr_mem_change ///
pr_memory pr_mem_change adl_diff_dr adl_dr_core adl_diff_wk adl_equip_wk adl_wk_core adl_diff_bh ///
 adl_bh_core adl_diff_e adl_e_core adl_diff_tx adl_equip_tx adl_tx_core adl_diff_t adl_t_core ///
 iadl_diff_map iadl_diff_mp iadl_mp_core iadl_diff_gr iadl_gr_core iadl_diff_ph iadl_ph_core ///
 iadl_diff_rx iadl_rx_core iadl_diff_m iadl_m_core  fl_diff_wk_many fl_diff_wk_one fl_diff_sit ///
 fl_diff_gu fl_diff_sta_many fl_diff_sta_one fl_diff_stp fl_diff_reach fl_diff_push fl_diff_lift ///
 fl_diff_dime adl_sp_helper adl_oth_helper iadl_sp_helper iadl_sp_helper adl_hlp_freq_imp_ed iadl_hlp_freq_imp_ed

//continuouse variables
local contvars nh_nights hosp_stays_2yr hosp_nights_2yr TICS_tot adl_helper_count iadl_helper_count ///
adl_hlp_freq_imp_mo iadl_hlp_freq_imp_mo adl_help_hours iadl_help_hours

//describe

tab core_year, missing

foreach v in `catvars' {
tab `v' core_year, missing
}

foreach v in `contvars' {
sum `v', detail
}


***********************************************************************
//Exit interview dataset
***********************************************************************
clear 
use exit_02_10_clean.dta //exit prior to adding interview dates

local xcatvars nhres nhres_start_mo nhres_start_yr pain_hrs ///
pain_level_hrs depr_exit delirium_exit dyspnea_hrs fatigue_hrs ///
no_appet_hrs discuss dexp

foreach v in `xcatvars' {
tab `v' exit_year, missing
}

log close


H="Process Claims Relative to Core Interview Date"
/*Get claims 1 year and 2 year before each core interview*/

/*proc printto new log='&logdir.\sas_2_sic_add_xwalk_log.log'
	print='&logdir.\sas_2_sic_add_xwalk_out.lst' 
run;*/

/*Step 1: Bring in mc xwalk id
sic_int.core_xwalk_1 has core interviews, age and claims xwalk id */

/*prepare core dataset to merge*/
data core_id;
set sic_int.core_age_zip;
run;

proc sort data=core_id nodupkey;
by id c_ivw_date;
run;

/*prepare xwalk id file to merge*/
data crosswalk_1;
set medi.cmsxref2010;
keep bid_hrs_19 hhid pn;
run;

/*get 2 variables bid_hrs = claims id, id=HRS id*/
data crosswalk_2;
set crosswalk_1;
bid_hrs=bid_hrs_19;
id=trim(hhid)||trim(pn);
drop hhid pn;
drop bid_hrs_19;
run;

proc sort data= crosswalk_2;
by id;
run;

/*bring in xwalk id to core interview dataset*/
proc sql;
create table core_xwalk as select
a.*,b.bid_hrs from
core_id a
left join
crosswalk_2 b
on a.id=b.id;
quit;

/*check for missing xwalk ids
38934 of 130320 interviews are missing xwalk ids*/
data check1;
set core_xwalk ;
if bid_hrs ='';
run;

/*create indicator for having xwalk id*/
data sic_int.core_xwalk_1;
set core_xwalk;
xwalk_yes=.;
if bid_hrs ='' then xwalk_yes=0;
if bid_hrs~='' then xwalk_yes=1;
run;

proc freq;
table xwalk_yes*core_year /missprint;
run;

/*just get information needed to grab claims, drop rest of interview data
So pulls all interviews for r's with the mc linkage
91386 interviews have linkage*/
data sic_int.core_lmt_xwalk_2;
set sic_int.core_xwalk_1(keep=id core_year c_ivw_date c_ivw_year c_ivw_month age_at_core bid_hrs xwalk_yes);
if xwalk_yes=1;
run;


H="Step 2a - Identify FFS MC 1yr and 6mos preceeding core interview"
/*Use denominator file to determine which interviews / r's have ffs mc
during the full 12 months preceeding the core interview

2 sets of variables created, 1 for 12 month lookback,
one for 6 month lookback to see what the difference in sample
size would be with the more relaxed requirement*/

/*proc printto new log='&logdir.\sas_3_sic_ffs_log.log'
	print='&logdir.\sas_3_sic_ffs_out.lst' 
run;*/

proc sort data=medi.dn_2000_2010 out=dn_2000_20102  nodupkey;
by BID_HRS_19 year;
run;

proc sort data=sic_int.core_lmt_xwalk_2 out=core_mc_ids nodupkey;
by bid_hrs c_ivw_year;
run;

proc freq;
table c_ivw_year;
run;

*2 obs have missing core year because no restricted data (no ivw date or dob);
proc freq data=core_mc_ids; table c_ivw_year /missprint; run;

data core_year_test; set core_mc_ids; if c_ivw_year=.; run;

/*pull medicare and hmo status variables from dn file
for the core interview years
interviews are dropped if they don't have a matching dn entry that year*/
proc sql;
create table dn_core_y as select
a.*,b.buyin12,b.year,b.HMOIND12
from core_mc_ids a inner join
dn_2000_20102 b
on trim(left(a.BID_hrs))=trim(left(b.BID_hrs_19))
and a.c_ivw_year=b.year;
quit;

proc freq data=dn_core_y ;
table c_ivw_year c_ivw_month age_at_core;
run;

/*16095 r's have at least 1 interview with a denominator file linked*/
proc sql;
select count(distinct BID_hrs) from dn_core_y ;
quit;

data dn_core_y2;
set dn_core_y;
if length(trim(left(buyin12)))=12 and c_ivw_month>0 then do;
buyin_dy=substr(trim(left(buyin12)),1,c_ivw_month);
hmo_dy=substr(trim(left(HMOIND12)),1,c_ivw_month);
end;
else do;
buyin_dy=trim(left(buyin12));
hmo_dy=trim(left(HMOIND12));
end;
format c_ivw_date date9.;
age_at_core_n=floor(age_at_core);
run;
proc means n;
var  c_ivw_month;
run;
proc freq;
table age_at_core_n;
run;

/*Check year prior to core interview to backfill for interview dates
in the first half of the year (since doing 12 mo look back)*/
/* 49041 have the -1 year dn file*/
proc sql;
create table dn_core_y_bef as select
a.BID_hrs,a.c_ivw_year ,
b.year as c_ivw_year_bef,
b.year,b.buyin12,b.HMOIND12
from dn_core_y a inner join
dn_2000_20102 b
on trim(left(a.BID_hrs))=trim(left(b.BID_hrs_19))
and 0<a.c_ivw_year-b.year<=1 order by bid_hrs,c_ivw_year;
quit;

proc sql;
create table all_insurance as select a.*,b.year as year_bef_civw, 
b.buyin12 as buyin_bef,b.HMOIND12 as hmo_bef from
dn_core_y2 a
left join
dn_core_y_bef b
on trim(left(a.BID_hrs))=trim(left(b.BID_hrs)) 
and a.c_ivw_year=b.c_ivw_year;
quit;

proc freq data=all_insurance;
table c_ivw_year*year_bef_civw /missprint;
run;

/*merge interview year and year before interview buy-in and hmo variables
Trim so the final variable _12m is 12 months pre-interview
Note: indicator variables for parts a and b and hmo are null if don't
have information for full 12 months pre-interview*/
data all_insurance2;
set all_insurance;
buyin_2y=trim(left(buyin_bef))||trim(left(buyin_dy));
hmo_2y=trim(left(hmo_bef))||trim(left(hmo_dy));

buyin_2y_r=reverse(trim(buyin_2y));
hmo_2y_r=reverse(trim(hmo_2y));

*************************************************;
** 12 month variables                          **;
*************************************************;
if length(buyin_2y_r)>11 then buyin_12m_r=substr(trim(left(buyin_2y)),1,12);
if length(hmo_2y_r)>11 then hmo_12m_r=substr(trim(left(hmo_2y)),1,12);

if length(buyin_2y_r)<12 then buyin_12m_r="";
if length(hmo_2y_r)<12 then hmo_12m_r="";

buyin_12m=reverse(trim(buyin_12m_r));
hmo_12m=reverse(trim(hmo_12m_r));

/*create indicator variable for mc coverage 12 mo. 0=no, 1=yes*/
if length(buyin_12m)=12 then do;
if indexc(buyin_12m,"0","1","2","A","B") then part_ab_12m=0;
if indexc(buyin_12m,"0","1","2","A","B")=0 then part_ab_12m=1;
end;
if length(hmo_12m)=12 then do;
if index(hmo_12m,"00000000000") then hmo_d_12m=0;
if index(hmo_12m,"00000000000")=0 then hmo_d_12m=1;
end;

*************************************************;
** 6 month variables                          **;
*************************************************;
if length(buyin_2y_r)>5 then buyin_6m_r=substr(trim(left(buyin_2y)),1,6);
if length(hmo_2y_r)>5 then hmo_6m_r=substr(trim(left(hmo_2y)),1,6);

if length(buyin_2y_r)<6 then buyin_6m_r="";
if length(hmo_2y_r)<6 then hmo_6m_r="";

buyin_6m=reverse(trim(buyin_6m_r));
hmo_6m=reverse(trim(hmo_6m_r));

/*create indicator variable for mc coverage 6 mo. 0=no, 1=yes*/
if length(buyin_6m)=6 then do;
if indexc(buyin_6m,"0","1","2","A","B") then part_ab_6m=0;
if indexc(buyin_6m,"0","1","2","A","B")=0 then part_ab_6m=1;
end;
if length(hmo_6m)=6 then do;
if index(hmo_6m,"000000") then hmo_d_6m=0;
if index(hmo_6m,"000000")=0 then hmo_d_6m=1;
end;

run;

/*12954 observations don't have full denominator data re insurance status
either interview Before Jan 2001 or are missing year -1 dn file*/
proc freq;
table part_ab_12m hmo_d_12m part_ab_12m*age_at_core_n part_ab_6m hmo_d_6m;
run;

/*bring indicators into full interview dataset*/
proc sql;
create table sic_int.core_xwalk_ins as select a.*,b.part_ab_12m,b.hmo_d_12m,b.part_ab_6m,b.hmo_d_6m
 from
sic_int.core_xwalk_1 a left join
all_insurance2 b
on a.bid_hrs=b.bid_hrs and a.c_ivw_year=b.c_ivw_year;
quit;

proc freq;
table age_ge_65*part_ab_12m age_ge_65*part_ab_6m /missprint;
run;

proc freq;
table age_ge_65 /missprint;
run;

data zzzztest1;
set sic_int.core_xwalk_ins;
if part_ab_12m=. & age_ge_65=1;
age_at_core_n=floor(age_at_core);
run;

proc freq;
table c_ivw_year*c_ivw_month age_at_core_n; run;


H="Step 2 - Get claims"
/*Get claims 1 year and 2 year before each core interview*/

/*Step 2: Pull claims lists using mc xwalk id and interview date
Save claims lists to project folder for use later */

/*proc printto new log='&logdir.\sas_4_sic_get_claims_log.log'
	print='&logdir.\sas_4_sic_get_claims_out.lst' 
run;*/


/****************************************************************************/
/* Macro to pull claims lists, saves lists to int_data folder               */
/****************************************************************************/

/*macros to create claims lists, one for all but medpar, one for medpar*/
%macro other(days_start=,days_bef_core=,source= );

proc sql;
create table sic_int.&source._meet_&days_bef_core. as select a.*,b.c_ivw_date,b.core_year
from medi.&source._2000_2010 a inner join
sic_int.core_lmt_xwalk_2 b
on trim(left(a.bid_hrs_19))=trim(left(b.bid_hrs))
and &days_start<=b.c_ivw_date-a.admit_date<=&days_bef_core;
quit;

%mend;


%macro mp(days_start=,days_bef_core=,source=,time_label=);

proc sql;
create table &source._meet as select a.*,b.c_ivw_date,b.core_year
from medi.&source._2000_2010 a inner join
sic_int.core_lmt_xwalk_2 b
on trim(left(a.bid_hrs_19))=trim(left(b.bid_hrs))
and &days_start<=b.c_ivw_date-a.admit_date<=&days_bef_core;
quit;

proc sql;
create table &source._meet2 as select a.*,b.c_ivw_date,b.core_year
from medi.&source._2000_2010 a inner join
sic_int.core_lmt_xwalk_2 b
on trim(left(a.bid_hrs_19))=trim(left(b.bid_hrs))
and b.c_ivw_date-a.admit_date>&days_bef_core and b.c_ivw_date-a.disch_date<=&days_bef_core;
quit;

data sic_int.&source._meet3_&days_bef_core.;
set &source._meet &source._meet2;
run;

%mend;



/*run to get claims list 6 months pre-core for medpar
Use to get indicator of hospitalizations 6 m prior to interview*/
%mp(days_start=0,days_bef_core=183,source=mp );

/*run to get claims lists 1 year pre-core
Datasets are sic_int.mp_meet3_365, sic_int.hh_meet_365, etc.*/
%mp(days_start=0,days_bef_core=365,source=mp );

%other(days_start=0,days_bef_core=365,source=hh );
%other(days_start=0,days_bef_core=365,source=hs );
%other(days_start=0,days_bef_core=365,source=dm);
%other(days_start=0,days_bef_core=365,source=op );
%other(days_start=0,days_bef_core=365,source=pb );

/*run to get claims lists 2 years pre-core
Datasets are sic_int.mp_meet3_730, sic_int.hh_meet_730, etc.*/
%mp(days_start=0,days_bef_core=730,source=mp );
%other(days_start=0,days_bef_core=730,source=hh );
%other(days_start=0,days_bef_core=730,source=hs );
%other(days_start=0,days_bef_core=730,source=dm );
%other(days_start=0,days_bef_core=730,source=op );
%other(days_start=0,days_bef_core=730,source=pb );


/****************************************************************************/

/****************************************************************************/
/****************************************************************************/
/*Run medpar code on the ip claims list to get ip claims 1 year pre-core
Use these ip claims for the hip fracture determination*/
%mp(days_start=0,days_bef_core=365,source=ip );


/****************************************************************************/
/****************************************************************************/

/****************************************************************************/

/****************************************************************************/
/* Macro to pull dx from claims lists, saves dx lists to int_data folder    */
/****************************************************************************/

%macro dx_time_range(range1=, range2=, days_bef_core=);

/*Process carrier medicare claims to pull out dx codes
Multiple lines per each BID*/
data pb_last_&range2._dx(keep=bid_hrs_19 core_year diag);
set sic_int.pb_meet_&days_bef_core.(keep=bid_hrs_19 core_year PDGNS_CD DGNS_CD1-DGNS_CD12 );
array dx PDGNS_CD DGNS_CD1-DGNS_CD12;
do over dx;
diag=dx ;
output;
end;
run;
/*check for and remove duplicates, note this doesn't remove blanks*/
proc sort data=pb_last_&range2._dx out=pb_last_&range2._dx2 nodupkey;
by bid_hrs_19 core_year diag;
run;


/*Process outpatient medicare claims to pull out dx codes
Dataset being created: op_last_&range2._dx2*/
data op_last_&range2._dx(keep=bid_hrs_19 core_year diag);
set sic_int.op_meet_&days_bef_core.(keep=bid_hrs_19 core_year PDGNS_CD DGNSCD01-DGNSCD25  );
array dx PDGNS_CD DGNSCD01-DGNSCD25 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=op_last_&range2._dx out=op_last_&range2._dx2 nodupkey;
by bid_hrs_19 core_year diag;
run;

/*Process medpar medicare claims to pull out dx codes
Dataset being created: mp_last_&range2._dx2*/
data mp_last_&range2._dx(keep=bid_hrs_19 core_year diag);
set sic_int.mp_meet3_&days_bef_core.(keep=bid_hrs_19 core_year AD_DGNS DGNS_CD01-DGNS_CD25 );
array dx AD_DGNS DGNS_CD01-DGNS_CD25 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=mp_last_&range2._dx out=mp_last_&range2._dx2 nodupkey;
by bid_hrs_19 core_year diag;
run;

/*Process dme medicare claims to pull out dx codes
Dataset being created: dm_last_&range2._dx2*/
data dm_last_&range2._dx(keep=bid_hrs_19 core_year diag);
set sic_int.dm_meet_&days_bef_core.(keep=bid_hrs_19 core_year PDGNS_CD DGNS_CD1-DGNS_CD12 );
array dx PDGNS_CD DGNS_CD1-DGNS_CD12 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=dm_last_&range2._dx out=dm_last_&range2._dx2 nodupkey;
by bid_hrs_19 core_year diag;
run;

/*Process hh medicare claims to pull out dx codes
Dataset being created: dm_last_&range2._dx2*/
data hh_last_&range2._dx(keep=bid_hrs_19 core_year diag);
set sic_int.hh_meet_&days_bef_core.(keep=bid_hrs_19 core_year PDGNS_CD DGNSCD01-DGNSCD25 );
array dx PDGNS_CD DGNSCD01-DGNSCD25 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=hh_last_&range2._dx out=hh_last_&range2._dx2 nodupkey;
by bid_hrs_19 core_year diag;
run;

/*Process hs medicare claims to pull out dx codes
Dataset being created: dm_last_&range2._dx2*/
data hs_last_&range2._dx(keep=bid_hrs_19 core_year diag);
set sic_int.hs_meet_&days_bef_core.(keep=bid_hrs_19 core_year PDGNS_CD DGNSCD01-DGNSCD25 );
array dx PDGNS_CD DGNSCD01-DGNSCD25 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=hs_last_&range2._dx out=hs_last_&range2._dx2 nodupkey;
by bid_hrs_19 core_year diag;
run;


/*set diag variable length = 7 chars since that's the max length from the mc claims
Need to do this because length varies across the different mc claim types*/
data hs_last_&range2._dx3;
length diag $7;
set hs_last_&range2._dx2;
run;
data hh_last_&range2._dx3;
length diag $7;
set hh_last_&range2._dx2;
run;
data mp_last_&range2._dx3;
length diag $7;
set mp_last_&range2._dx2;
run;
data dm_last_&range2._dx3;
length diag $7;
set dm_last_&range2._dx2;
run;
data op_last_&range2._dx3;
length diag $7;
set op_last_&range2._dx2;
run;
data pb_last_&range2._dx3;
length diag $7;
set pb_last_&range2._dx2;
run;


/*merge diagnoses from each claim type into single dataset*/
data dx_all_last_&range2.;
set hs_last_&range2._dx3
hh_last_&range2._dx3
mp_last_&range2._dx3
dm_last_&range2._dx3
op_last_&range2._dx3
pb_last_&range2._dx3;
run;
proc sort data=dx_all_last_&range2.(where=(diag~="")) out=sic_int.dx_&range1._&range2 nodupkey;
by bid_hrs_19 core_year diag;
run;

%mend;

/*1 and 2 years pre-interview: sic_int.dx_0_1yr, sic_int.dx_0_2yr */
%dx_time_range(range1=0, range2=1yr, days_bef_core=365);
%dx_time_range(range1=0, range2=2yr, days_bef_core=730);

data zzzdx_test;
set sic_int.dx_0_1yr;
core_year_c=put(core_year,z4.);
run;

/*47538 interviews have at least 1 dx code 1 year preceeding the interview*/
proc sql;
select count (distinct bid_hrs_19||core_year_c) from zzzdx_test;
quit;

/*check for frequency of DX codes by bid,core year
Need to use datasets in work folder before removing duplicates*/
data dx_all_last_1yr_w_dups;
set hs_last_1yr_dx
hh_last_1yr_dx
mp_last_1yr_dx
dm_last_1yr_dx
op_last_1yr_dx
pb_last_1yr_dx;
if diag~='.';
run;

proc sort data=dx_all_last_1yr_w_dups;
by bid_hrs_19 core_year diag;
run;

proc sql;
create table zzzdx_freq as select distinct BID_hrs_19,core_year,diag, 
count(*) as n_dx_freq label="count times icd9 dx coded, 12m pre-core"
 from dx_all_last_1yr_w_dups group by BID_hrs_19,core_year,diag;
quit;

proc freq;
table n_dx_freq ;
run;

proc sort data=zzzdx_freq ;
by n_dx_freq;
run;

data zzzdx_chf;
set zzzdx_freq ;
if substr(diag,1,3)='428';
run;


H="Step 3 - Elixhauser comorbidities"
/*proc printto new log='&logdir.\sas_5_sic_elix_log.log'
	print='&logdir.\sas_5_sic_elix_out.lst' 
run;*/


/****************************************************************************/
/* Rename variables macro                                                   */
/****************************************************************************/

%macro rename(lib,dsn,pre);
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "Before Renaming All Variables";
run;
proc sql noprint;
select nvar into :num_vars
from dictionary.tables
where libname="&LIB" and
memname="&DSN";
select distinct(name) into :var1-
:var%TRIM(%LEFT(&num_vars))
from dictionary.columns
where libname="&LIB" and
memname="&DSN";
quit;
run;
proc datasets library=&LIB;
modify &DSN;
rename
%do i=1 %to &num_vars;
&&var&i=&&var&i.._&pre 
%end;
;
quit;
run;
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "After Renaming All Variables";
run;
%mend rename;




/****************************************************************************/
/* Elixhauser comorbidities macro                                           */
/****************************************************************************/
/*Note elixhauser comorbidities diagnosis lists are modified for the 
purposes of this project, do not copy and paste this Elixhauser code 
for use in other projects!!*/

%macro elixhauser(range1=, range2=);

data dx_31_comor;
set sic_int.dx_&range1._&range2(rename=(diag=dx_0));
dx=trim(left(dx_0));

if dx~="" then do;

comorbi_1=0;
comorbi_2=0;
comorbi_3=0;
comorbi_4=0;
comorbi_5=0;
comorbi_6=0;
comorbi_7=0;
comorbi_8=0;
comorbi_9=0;
comorbi_10=0;
comorbi_11=0;
comorbi_12=0;
comorbi_13=0;
comorbi_14=0;
comorbi_15=0;
comorbi_16=0;
comorbi_17=0;
comorbi_18=0;
comorbi_19=0;
comorbi_20=0;
comorbi_21=0;
comorbi_22=0;
comorbi_23=0;
comorbi_24=0;
comorbi_25=0;
comorbi_26=0;
comorbi_27=0;
comorbi_28=0;
comorbi_29=0;
comorbi_30=0;
*end of intialize of 30 binary variables;
*add dementia and CAD and ALS;
dementia=0;
cad=0;
als=0;
renal_dis=0;

*do over dx;
	*Congestive Heart Failure;
	if (substr(dx,1,5)='39891' or
		substr(dx,1,5)='40211' or
		substr(dx,1,5)='40291' or
		substr(dx,1,5)='40411' or
		substr(dx,1,5)='40413' or
		substr(dx,1,5)='40491' or
		substr(dx,1,5)='40493' or
		substr(dx,1,3)='428') 
		and comorbi_1=0 
		then comorbi_1=1;*add one binary variables here.;
	*Cariac Arrhythmias;
	if (substr(dx,1,5)='42610' or
		substr(dx,1,5)='42611' or
		substr(dx,1,5)='42613' or
		substr(dx,1,4)='4262' or
		substr(dx,1,4)='4263' or
		substr(dx,1,4)='4264' or
		substr(dx,1,5)='42650' or
		substr(dx,1,5)='42651' or
		substr(dx,1,5)='42652' or
		substr(dx,1,5)='42653' or
		substr(dx,1,4)='4266' or
		substr(dx,1,4)='4267' or
		substr(dx,1,4)='4268' or
		substr(dx,1,4)='4270' or
		substr(dx,1,4)='4272' or
		substr(dx,1,5)='42731' or
		substr(dx,1,5)='42760' or
		substr(dx,1,4)='4279' or
		substr(dx,1,4)='7850' or
		substr(dx,1,4)='V450' or
		substr(dx,1,4)='V533')
			and comorbi_2=0 
		then comorbi_2=1;
	* Valvular Disease ;
	if (substr(dx,1,5)='09320' or
		substr(dx,1,5)='09321' or
		substr(dx,1,5)='09322' or
		substr(dx,1,5)='09323' or
		substr(dx,1,5)='09324' or
		substr(dx,1,3)='394' or
		substr(dx,1,3)='395' or
		substr(dx,1,3)='396' or
		substr(dx,1,4)='3970' or
		substr(dx,1,4)='3971' or
		substr(dx,1,4)='4240' or
		substr(dx,1,4)='4241' or
		substr(dx,1,4)='4242' or
		substr(dx,1,4)='4243' or
		substr(dx,1,4)='4244' or
		substr(dx,1,4)='4245' or
		substr(dx,1,4)='4246' or
		substr(dx,1,4)='4247' or
		substr(dx,1,4)='4248' or
		substr(dx,1,5)='42490' or
		substr(dx,1,5)='42491' or
		substr(dx,1,4)='7463' or
		substr(dx,1,4)='7464' or
		substr(dx,1,4)='7465' or
		substr(dx,1,4)='7466' or
		substr(dx,1,4)='V422' or
		substr(dx,1,5)='V433')
			and comorbi_3=0 
		then comorbi_3=1;
	*Pulmonary Circulation Disorders;
	if (substr(dx,1,3)='416' or
		substr(dx,1,4)='4179')
			and comorbi_4=0 
		then comorbi_4=1;
	*Peripheral Vascular Disorders;
	if (substr(dx,1,3)='440' or
		substr(dx,1,4)='4412' or
		substr(dx,1,4)='4414' or
		substr(dx,1,4)='4417' or
		substr(dx,1,4)='4419' or
		substr(dx,1,4)='4431' or
		substr(dx,1,4)='4432' or
		substr(dx,1,4)='4438' or
		substr(dx,1,4)='4439' or
		substr(dx,1,4)='4471' or
		substr(dx,1,4)='5571' or
		substr(dx,1,4)='5579' or
		substr(dx,1,4)='V434')
			and comorbi_5=0 
		then comorbi_5=1;
	*Hypertension;
	if ((substr(dx,1,4)='4011' or
		substr(dx,1,4)='4019')) or
	   ((substr(dx,1,5)='40210' or
		substr(dx,1,5)='40290' or
		substr(dx,1,5)='40410' or
		substr(dx,1,5)='40490' or
		substr(dx,1,5)='40511' or
		substr(dx,1,5)='40519' or
		substr(dx,1,5)='40591' or
		substr(dx,1,5)='40599')) 
			and comorbi_6=0 
		then comorbi_6=1;
	*Paralysis;	
	if (substr(dx,1,4)='3420' or
		substr(dx,1,5)='34210' or
		substr(dx,1,5)='34211' or
		substr(dx,1,5)='34212' or
		substr(dx,1,4)='3429' or
		substr(dx,1,3)='343' or
		substr(dx,1,3)='344')
			and comorbi_7=0 
		then comorbi_7=1;
	*Other Neurological Disorders;
	if (substr(dx,1,4)='3319' or
		substr(dx,1,4)='3320' or
		substr(dx,1,4)='3334' or
		substr(dx,1,4)='3335' or
		substr(dx,1,3)='334' or
		substr(dx,1,3)='335' or
		substr(dx,1,3)='340' or
		substr(dx,1,4)='3411' or
		substr(dx,1,4)='3418' or
		substr(dx,1,4)='3419' or
		substr(dx,1,5)='34500' or
		substr(dx,1,5)='34501' or
		substr(dx,1,5)='34510' or
		substr(dx,1,5)='34511' or
		substr(dx,1,4)='3454' or
		substr(dx,1,5)='34550' or
		substr(dx,1,5)='34551' or
		substr(dx,1,4)='3458' or
		substr(dx,1,5)='34590' or
		substr(dx,1,5)='34591' or
		substr(dx,1,4)='3481' or
		substr(dx,1,4)='3483' or
		substr(dx,1,4)='7803' or
		substr(dx,1,4)='7843') 
			and comorbi_8=0 
		then comorbi_8=1;	
	*Chronic Pulmonary Disease;
	if (substr(dx,1,3)='490' or
		substr(dx,1,3)='491' or
		substr(dx,1,3)='492' or
		substr(dx,1,4)='4930' or
		substr(dx,1,4)='4931' or
		substr(dx,1,4)='4932' or
		substr(dx,1,4)='4938' or
		substr(dx,1,5)='49390' or
		substr(dx,1,5)='49391' or
		substr(dx,1,3)='494' or
		substr(dx,1,3)='495' or
		substr(dx,1,3)='496' or
		substr(dx,1,3)='497' or
		substr(dx,1,3)='498' or
		substr(dx,1,3)='499' or
		substr(dx,1,3)='500' or
		substr(dx,1,3)='501' or
		substr(dx,1,3)='502' or
		substr(dx,1,3)='503' or
		substr(dx,1,3)='504' or
		substr(dx,1,3)='505' or
		substr(dx,1,4)='5064') 
			and comorbi_9=0 
		then comorbi_9=1;	
	*Diabetes, uncomplicated;
	if (substr(dx,1,4)='2500' or
		substr(dx,1,4)='2501' or
		substr(dx,1,4)='2502' or
		substr(dx,1,4)='2503') 
			and comorbi_10=0 
		then comorbi_10=1;
	*Diabetes, complicated;
	if (substr(dx,1,4)='2504' or
		substr(dx,1,4)='2505' or
		substr(dx,1,4)='2506' or
		substr(dx,1,4)='2507' or
		substr(dx,1,4)='2509') 
			and comorbi_11=0 
		then comorbi_11=1;
	*Hypothyroidism;
	if (substr(dx,1,3)='243' or
		substr(dx,1,4)='2440' or
		substr(dx,1,4)='2441' or
		substr(dx,1,4)='2442' or
		substr(dx,1,4)='2448' or
		substr(dx,1,4)='2449') 	
			and comorbi_12=0 
		then comorbi_12=1;
	*Renal Failure;
	*Original list modified to drop 2 codes  585 and V568;
	if (substr(dx,1,5)='40311' or
		substr(dx,1,5)='40391' or
		substr(dx,1,5)='40412' or
		substr(dx,1,5)='40492' or
		substr(dx,1,3)='586' or
		substr(dx,1,4)='V420' or
		substr(dx,1,4)='V451' or
		substr(dx,1,4)='V560') 
			and comorbi_13=0 
		then comorbi_13=1;
	*Advanced Liver Disease or Cirrhosis;
	*Code list modified from orig Elix;
	*572.4 hepatorenal syndrome must be added; 
	*Remove '07032' or – chronic hep B, '07033' or – chronic hep B, '07054' or – chronic hep C, '5713' or – alcoholic liver damage, '5714' or – chronic hepatitis;
	if (substr(dx,1,4)='4560' or
		substr(dx,1,4)='4561' or
		substr(dx,1,5)='45620' or
		substr(dx,1,5)='45621' or
		substr(dx,1,4)='5710' or
		substr(dx,1,4)='5712' or
		substr(dx,1,4)='5715' or
		substr(dx,1,4)='5716' or
		substr(dx,1,4)='5718' or
		substr(dx,1,4)='5719' or
		substr(dx,1,4)='5723' or
		substr(dx,1,4)='5724' or
		substr(dx,1,4)='5728' or
		substr(dx,1,4)='V427') 
			and comorbi_14=0 
		then comorbi_14=1;
	*Peptic Ulcer Disease excluding bleeding;
	if (substr(dx,1,5)='53170' or
		substr(dx,1,5)='53190' or
		substr(dx,1,5)='53270' or
		substr(dx,1,5)='53290' or
		substr(dx,1,5)='53370' or
		substr(dx,1,5)='53390' or
		substr(dx,1,5)='53470' or
		substr(dx,1,5)='53490' or
		substr(dx,1,5)='V1271') 
			and comorbi_15=0 
		then comorbi_15=1;
	*AIDS;
	if (substr(dx,1,3)='042' or
		substr(dx,1,3)='043' or
		substr(dx,1,3)='044') 
			and comorbi_16=0 
		then comorbi_16=1;
	*Lymphoma;
	if (substr(dx,1,3)='200' or
		substr(dx,1,4)='201' or
		substr(dx,1,4)='2020' or
		substr(dx,1,4)='2021' or
		substr(dx,1,4)='2022' or
		substr(dx,1,4)='2023' or
		substr(dx,1,4)='2025' or
		substr(dx,1,4)='2026' or
		substr(dx,1,4)='2027' or
		substr(dx,1,4)='2028' or
		substr(dx,1,4)='2029' or
		substr(dx,1,4)='2030' or
		substr(dx,1,4)='2038' or
		substr(dx,1,4)='2386' or
		substr(dx,1,4)='2733' or
		substr(dx,1,5)='V1071' or
		substr(dx,1,5)='V1072' or
		substr(dx,1,5)='V1079')
			and comorbi_17=0 
		then comorbi_17=1;
	*Metastatic Cancer or Hematologic Cancer;
	*Modified to add lukemias;
	if (substr(dx,1,3)='196' or
		substr(dx,1,3)='197' or
		substr(dx,1,3)='198' or
		substr(dx,1,3)='199' or
		substr(dx,1,3)='204' or
		substr(dx,1,3)='205' or
		substr(dx,1,3)='206' or
		substr(dx,1,3)='207' or
		substr(dx,1,3)='208') 
			and comorbi_18=0 
		then comorbi_18=1;	
	*Solid Tumor without Metastisis;
	if (substr(dx,1,2)='14' or
		substr(dx,1,2)='15' or
		substr(dx,1,2)='16' or
		substr(dx,1,3)='170' or
		substr(dx,1,3)='171' or
		substr(dx,1,3)='172' or
		substr(dx,1,3)='174' or
		substr(dx,1,3)='175' or
		substr(dx,1,3)='179' or
		substr(dx,1,2)='18' or
		substr(dx,1,3)='190' or
		substr(dx,1,3)='191' or
		substr(dx,1,3)='192' or
		substr(dx,1,3)='193' or
		substr(dx,1,3)='194' or
		substr(dx,1,3)='195' or
		substr(dx,1,3)='V10')
			and comorbi_19=0 
		then comorbi_19=1;
	*Rheumatoid Arthritis/Collagen Vascular Diseases;
	if (substr(dx,1,4)='7010' or
		substr(dx,1,3)='710' or
		substr(dx,1,3)='714' or
		substr(dx,1,3)='720' or
		substr(dx,1,3)='725') 
			and comorbi_20=0 
		then comorbi_20=1;
	*Coagulopathy;
	if (substr(dx,1,3)='286' or
		substr(dx,1,4)='2871' or
		substr(dx,1,4)='2873' or
		substr(dx,1,4)='2874' or
		substr(dx,1,4)='2875') 
			and comorbi_21=0 
		then comorbi_21=1;
	*Obesity;
	if (substr(dx,1,4)='2780')  
			and comorbi_22=0 
		then comorbi_22=1;
	*Weight Loss;
	if (substr(dx,1,3)='260' or
		substr(dx,1,3)='261' or
		substr(dx,1,3)='262' or
		substr(dx,1,3)='263') 
			and comorbi_23=0 
		then comorbi_23=1;	
	*Fluid and Electrolyte Disorders;
	if (substr(dx,1,3)='276') 
			and comorbi_24=0 
		then comorbi_24=1;
	*Blood Loss Anemia;
	if (substr(dx,1,4)='2800') 
			and comorbi_25=0 
		then comorbi_25=1;
	*Deficiency Anemias;
	if (substr(dx,1,4)='2801' or
		substr(dx,1,4)='2808' or
		substr(dx,1,4)='2809' or
		substr(dx,1,4)='2859') 
			and comorbi_26=0 
		then comorbi_26=1;
	*Alcohol Abuse;
	if (substr(dx,1,4)='2911' or
		substr(dx,1,4)='2912' or
		substr(dx,1,4)='2915' or
		substr(dx,1,4)='2918' or
		substr(dx,1,4)='2919' or
		substr(dx,1,4)='3039' or
		substr(dx,1,4)='3050' or
		substr(dx,1,4)='V113') 
			and comorbi_27=0 
		then comorbi_27=1;
	*Drug Abuse;
	if (substr(dx,1,4)='2920' or
		substr(dx,1,5)='29282' or
		substr(dx,1,5)='29283' or
		substr(dx,1,5)='29284' or
		substr(dx,1,5)='29289' or
		substr(dx,1,4)='2929' or
		substr(dx,1,3)='304' or
		substr(dx,1,4)='3052' or
		substr(dx,1,4)='3053' or
		substr(dx,1,4)='3054' or
		substr(dx,1,4)='3055' or
		substr(dx,1,4)='3056' or
		substr(dx,1,4)='3057' or
		substr(dx,1,4)='3058' or
		substr(dx,1,4)='3059')
			and comorbi_28=0 
		then comorbi_28=1;	
	*Psychoses;
	if (substr(dx,1,3)='295' or
		substr(dx,1,3)='296' or
		substr(dx,1,3)='297' or
		substr(dx,1,3)='298' or
		substr(dx,1,4)='2991') 
			and comorbi_29=0 
		then comorbi_29=1;
	*Depression;
	if (substr(dx,1,4)='3004' or
		substr(dx,1,5)='30112' or
		substr(dx,1,4)='3090' or
		substr(dx,1,4)='3091' or
		substr(dx,1,3)='311')
			and comorbi_30=0 
		then comorbi_30=1;

	*Dementia;
	if (substr(dx,1,4) in ('3310','3311','3312','2900','2901',
             '2902','2903','2912','2948','2949') or
		substr(dx,1,5) in ('29410','29411','29040','29041','29042','29043')) 
		and dementia=0 
          then dementia=1;

	*CAD coronary artery disease;
	if (substr(dx,1,4) in ('4140','4142','4143','4148','4149') or 
		substr(dx,1,3) in ('410','411','412','413') or
		substr(dx,1,5) in ('V4581','V4582'))
		and cad=0 
          then cad=1;

	*ALS Amyotrophic lateral sclerosis;
	if (substr(dx,1,5)='33520') and als=0 
		then als=1;

*Renal Disease, new variable;
	*To identify diabetese with complications;
	if (substr(dx,1,5)='40311' or
		substr(dx,1,5)='40391' or
		substr(dx,1,5)='40412' or
		substr(dx,1,5)='40492' or
		substr(dx,1,3)='585' or
		substr(dx,1,3)='586' or
		substr(dx,1,4)='V420' or
		substr(dx,1,4)='V451' or
		substr(dx,1,4)='V560' or
		substr(dx,1,4)='V568') 
			and renal_dis=0 
		then renal_dis=1;

end;

run;

/*get count of each comorbidity for each id-core year combination*/
proc sql;
create table com_test1 as
select distinct BID_hrs_19,core_year,
sum(comorbi_1) as com_1,
sum(comorbi_2) as com_2,
sum(comorbi_3) as com_3,
sum(comorbi_4) as com_4,
sum(comorbi_5) as com_5,
sum(comorbi_6) as com_6,
sum(comorbi_7) as com_7,
sum(comorbi_8) as com_8,
sum(comorbi_9) as com_9,
sum(comorbi_10) as com_10,
sum(comorbi_11) as com_11,
sum(comorbi_12) as com_12,
sum(comorbi_13) as com_13,
sum(comorbi_14) as com_14,
sum(comorbi_15) as com_15,
sum(comorbi_16) as com_16,
sum(comorbi_17) as com_17,
sum(comorbi_18) as com_18,
sum(comorbi_19) as com_19,
sum(comorbi_20) as com_20,
sum(comorbi_21) as com_21,
sum(comorbi_22) as com_22,
sum(comorbi_23) as com_23,
sum(comorbi_24) as com_24,
sum(comorbi_25) as com_25,
sum(comorbi_26) as com_26,
sum(comorbi_27) as com_27,
sum(comorbi_28) as com_28,
sum(comorbi_29) as com_29,
sum(comorbi_30) as com_30,
sum(dementia) as dementia,
sum(cad) as cad,
sum(als) as als,
sum(renal_dis) as renal_dis
from dx_31_comor
group by BID_hrs_19,core_year;
quit;

/*convert counts of diagnoses for each comorbidity to indicator variables*/ 
data comorbidity_1(keep=BID_hrs_19 core_year comorb_1-comorb_34 comorb_all);
set com_test1;
array list_com com_1-com_30 dementia cad als renal_dis;
array list_com_bin comorb_1-comorb_34 ;

do over list_com;
  list_com_bin=0;

  if list_com>0 then do;
    list_com_bin=1;
   end;

end;
/*note this comorb_all count does not include CAD or ALS or Renal disease*/
comorb_all=comorb_1+comorb_2+comorb_3+comorb_4+comorb_5+comorb_6+comorb_7+comorb_8+comorb_9+comorb_10
+comorb_11+comorb_12+comorb_13+comorb_14+comorb_15+comorb_16+comorb_17+comorb_18+comorb_19+comorb_20
+comorb_21+comorb_22+comorb_23+comorb_24+comorb_25+comorb_26+comorb_27+comorb_28+comorb_29+comorb_30
+comorb_31;

run;

/*merge in to list of core ivw dates for those with xwalk id*/
proc sort data=comorbidity_1 nodupkey;
by BID_hrs_19 core_year;
run;

proc sql;
create table core_xwalk_elix_1(drop=BID_hrs_19 core_year2) as
select a.*,b.*
from sic_int.core_lmt_xwalk_2 a 
left join
comorbidity_1(rename=(core_year=core_year2)) b
on trim(left(a.BID_hrs))=trim(left(b.BID_hrs_19)) and a.core_year=b.core_year2;
quit;

data sic_int.elix_&range1._&range2;
set core_xwalk_elix_1 ;

label comorb_1 ="Congestive Heart Failure";
label comorb_2 ="Cardiac Arrhythmias";
label comorb_3 ="Valvular Disease";
label comorb_4 ="Pulmonary Circulation Disorders";
label comorb_5 ="Peripheral Vascular Disorders";
label comorb_6 ="Hypertension";
label comorb_7 ="Paralysis";
label comorb_8 ="Other Neurological Disorders";
label comorb_9 ="Chronic Pulmonary Disease";
label comorb_10 ="Diabetes, uncomplicated";
label comorb_11 ="Diabetes, complicated";
label comorb_12 ="Hypothyroidism";
label comorb_13 ="Renal Failure";
label comorb_14 ="Advanced Liver Disease or Cirrhosis";
label comorb_15 ="Peptic Ulcer Disease excluding bleeding";
label comorb_16 ="AIDS";
label comorb_17 ="Lymphoma";
label comorb_18 ="Metastatic or Hematologic Cancer";
label comorb_19 ="Solid Tumor without Metastisis";
label comorb_20 ="Rheumatoid Arthritis/Collagen Vascular Diseases";
label comorb_21 ="Coagulopathy";
label comorb_22 ="Obesity";
label comorb_23 ="Weight Loss";
label comorb_24 ="Fluid and Electrolyte Disorders";
label comorb_25 ="Blood Loss Anemia";
label comorb_26 ="Deficiency Anemias";
label comorb_27 ="Alcohol Abuse";
label comorb_28 ="Drug Abuse";
label comorb_29 ="Psychoses";
label comorb_30 ="Depression";
label comorb_31 ="Dementia";
label comorb_32 ="CAD";
label comorb_33 ="ALS";
label comorb_34 ="Renal Disease";
label comorb_all ="Count of Elix comorbidities";
run;

data test;
set sic_int.elix_&range1._&range2;
run;

%rename(WORK,TEST,&range1._&range2);

data sic_int.elix_&range1._&range2._2(rename =(bid_hrs_&range1._&range2=bid_hrs
core_year_&range1._&range2=core_year));
set test;
keep bid_hrs_&range1._&range2 comorb: core_year:;
run;
proc sort data=sic_int.elix_&range1._&range2._2;
by bid_hrs core_year;
run;

%mend;

/*Run for 1 year, 2 year datasets, resulting datasets are sic_int.elix_0_1yr_2, sic_int.elix_0_2yr_2*/
%elixhauser(range1=0, range2=1yr);
%elixhauser(range1=0, range2=2yr);

proc freq data=sic_int.elix_0_1yr_2;
table comorb:;
run;

proc freq data=sic_int.elix_0_2yr_2;
table comorb:;
run;

/****************************************************************************/
/* Macro to merge Elixhauser comorbidities with core full interviews        */
/****************************************************************************/
/*note resulting datasets have all interviews
If ffs mc 1 year prior to interview, then the the elix comorb are left as missing*/
%macro mergeel(range2=);
proc sql;
create table core_ids_elix_&range2(drop=BID_hrs2 core_year2) as select a.*,
b.*
from 
sic_int.core_xwalk_ins /*sic_int.core_xwalk_1*/ a left join
sic_int.elix_0_&range2._2(rename=(BID_hrs=BID_hrs2 core_year=core_year2)) b
on trim(left(a.BID_hrs))=trim(left(b.BID_hrs2)) and a.core_year=b.core_year2;
quit;

/*1328 obs have ffs mc 1 year preceeding interview but no dx during that time
data zzztest;
set sic_int.core_ids_elix_1yr;
if comorb_all_0_1yr=. and part_ab_12m=1 and hmo_d_12m=0 ;
run;*/

data sic_int.core_ids_elix_&range2._2;
set core_ids_elix_&range2;
array list comorb_:;
do over list;
if part_ab_12m=1 and hmo_d_12m=0 and list=. then list=0;
end;
run;

%mend;

%mergeel(range2=1yr);
%mergeel(range2=2yr);

proc freq data=sic_int.core_ids_elix_1yr_2;
table comorb:;
run;

proc freq data=sic_int.core_ids_elix_2yr_2;
table comorb:;
run;


H="Step 4 - DW chronic conditions"
/*CMS Data Warehouse Chronic Conditions*/
/*proc printto new log='&logdir.\sas_6_sic_cc_log.log'
	print='&logdir.\sas_6_sic_cc_out.lst' 
run;*/

/****************************************************************************/
/*First get the dx list into dot format using Stata*/
/****************************************************************************/

/*export to Stata*/
proc export data=sic_int.dx_0_1yr
outfile="E:\data\serious_ill\int_data\dx_0_1yr.dta" replace;
run;

proc export data=sic_int.dx_0_2yr
outfile="E:\data\serious_ill\int_data\dx_0_2yr.dta" replace;
run;

/****************************************************************************/
/****************************************************************************/
/*SWITCH TO STATA HERE*/
/****************************************************************************/
/****************************************************************************/

clear
set more off
set memory 500m
local datapath E:\data\serious_ill\int_data

use `datapath'\dx_0_1yr.dta,clear

// convert diagnosis codes to string variables, tostring diag,gen(icd9_c)
gen new=ltrim(diag)
icd9 check new,gen(icd9_c)
replace new="" if icd9_c>0 
// convert into dot format (ex 12.1 instead of 121)
icd9 clean new,dots 

replace diag=new
drop icd9_c new

save `datapath'\dx_0_1yr_2.dta,replace

clear all

use `datapath'\dx_0_2yr.dta,clear

// convert diagnosis codes to string variables, tostring diag,gen(icd9_c)
gen new=ltrim(diag)
icd9 check new,gen(icd9_c)
replace new="" if icd9_c>0 
// convert into dot format (ex 12.1 instead of 121)
icd9 clean new,dots 

replace diag=new
drop icd9_c new

save `datapath'\dx_0_2yr_2.dta,replace

/****************************************************************************/
/****************************************************************************/
/*SWITCH TO SAS HERE*/
/****************************************************************************/
/****************************************************************************/

proc import 
datafile="E:\data\serious_ill\int_data\dx_0_1yr_2.dta" 
out=dx_0_1yr_2 replace;
run;

proc import 
datafile="E:\data\serious_ill\int_data\dx_0_2yr_2.dta" 
out=dx_0_2yr_2 replace;
run;

/*bring in excel list of dx codes associated with each chronic condition*/
proc import 
datafile='E:\data\serious_ill\ref_data\chronic_21_condition_icd9.xls'
out=icd9_21_chronic dbms=xls replace;
run;

proc contents data=icd9_21_chronic;
run;

/*creates macro variables of each of the chronic conditions listing of dx codes*/
proc sql;
select icd_9 into :chronic_desc1-:chronic_desc21 from icd9_21_chronic;
quit;
%put &chronic_desc10;
%put &chronic_desc5;

/*******************************************************************/
/*Macro to generate chronic conditions indicators using dx codes   */
/*******************************************************************/

%macro cc(precore=);

data list_&precore._dx;
set dx_0_&precore._2;
array list CC_1_AMI
CC_2_ALZH
CC_3_ALZHDMTA
CC_4_ATRIALFB
CC_5_CATARACT
CC_6_CHRNKIDN
CC_7_COPD
CC_8_CHF
CC_9_DIABETES
CC_10_GLAUCOMA
CC_11_HIPFRAC
CC_12_ISCHMCHT
CC_13_DEPRESSN
CC_14_OSTEOPRS
CC_15_RA_OA
CC_16_STRKETIA
CC_17_CNCRBRST
CC_18_CNCRCLRC
CC_19_CNCRPRST
CC_20_CNCRLUNG
CC_21_CNCREndM;
do over list ;
list=0;
end;

diag_string=diag;

/* for dx codes that begin with numbers, process chronic cond variables*/
if anydigit(substr(trim(left(diag_string)),1,1))=1 then do;
diag=diag_string+0;

if diag in (&chronic_desc1) then CC_1_AMI=1;
if diag in (&chronic_desc2)  then CC_2_ALZH=1;
if diag in (&chronic_desc3)  then CC_3_ALZHDMTA=1;
if diag in (&chronic_desc4) then CC_4_ATRIALFB=1;
if diag in (&chronic_desc5) then CC_5_CATARACT=1;
if diag in (&chronic_desc6) then CC_6_CHRNKIDN=1;
if diag in (&chronic_desc7) then CC_7_COPD=1;
if diag in (&chronic_desc8) then CC_8_CHF=1;
if diag in (&chronic_desc9) then CC_9_DIABETES=1;
if diag in (&chronic_desc10) then CC_10_GLAUCOMA=1;
if diag in (&chronic_desc11) then CC_11_HIPFRAC=1;
if diag in (&chronic_desc12) then CC_12_ISCHMCHT=1;
if diag in (&chronic_desc13) then CC_13_DEPRESSN=1;
if diag in (&chronic_desc14) then CC_14_OSTEOPRS=1;
if diag in (&chronic_desc15) then CC_15_RA_OA=1;
if diag in (&chronic_desc16) then CC_16_STRKETIA=1;
if diag in (&chronic_desc17) then CC_17_CNCRBRST=1;
if diag in (&chronic_desc18) then CC_18_CNCRCLRC=1;
if diag in (&chronic_desc19) then CC_19_CNCRPRST=1;
if diag in (&chronic_desc20) then CC_20_CNCRLUNG=1;
if diag in (&chronic_desc21) then CC_21_CNCREndM=1;
end;

/*Process with dx codes that start with letters
Only two of them in the list*/
if anydigit(substr(trim(left(diag_string)),1,1))=0 then do;
if trim(left(diag_string)) in ("V431") then CC_5_CATARACT=1;
if trim(left(diag_string)) in ("V801") then CC_10_GLAUCOMA=1;
end;

run;


proc sql;
create table bid_dx_0_&precore.(rename=(bid_hrs_19=bid)) as
select distinct bid_hrs_19,core_year,
sum(CC_1_AMI) as CC_1_AMI,
sum(CC_2_ALZH) as CC_2_ALZH,
sum(CC_3_ALZHDMTA) as CC_3_ALZHDMTA,
sum(CC_4_ATRIALFB) as CC_4_ATRIALFB,
sum(CC_5_CATARACT) as CC_5_CATARACT,
sum(CC_6_CHRNKIDN) as CC_6_CHRNKIDN,
sum(CC_7_COPD) as CC_7_COPD,
sum(CC_8_CHF) as CC_8_CHF,
sum(CC_9_DIABETES) as CC_9_DIABETES,
sum(CC_10_GLAUCOMA) as CC_10_GLAUCOMA,
sum(CC_11_HIPFRAC) as CC_11_HIPFRAC,
sum(CC_12_ISCHMCHT) as CC_12_ISCHMCHT,
sum(CC_13_DEPRESSN) as CC_13_DEPRESSN,
sum(CC_14_OSTEOPRS) as CC_14_OSTEOPRS,
sum(CC_15_RA_OA) as CC_15_RA_OA,
sum(CC_16_STRKETIA) as CC_16_STRKETIA,
sum(CC_17_CNCRBRST) as CC_17_CNCRBRST,
sum(CC_18_CNCRCLRC) as CC_18_CNCRCLRC,
sum(CC_19_CNCRPRST) as CC_19_CNCRPRST,
sum(CC_20_CNCRLUNG) as CC_20_CNCRLUNG,
sum(CC_21_CNCREndM) as CC_21_CNCREndM

from list_&precore._dx group by bid_hrs_19,core_year;
quit;

data bid_dx_0_&precore.1;
set bid_dx_0_&precore.;


/*merge chronic conditions into interview list of bid's by bid*/
 proc sql;
 create table bid_dx_0_&precore.2(drop=bid) as select a.bid_hrs,b.*
 from sic_int.core_lmt_xwalk_2 a
 left join
 bid_dx_0_&precore. b 
 on trim(left(a.bid_hrs))=trim(left(b.bid))
and a.core_year=b.core_year;
 quit;

/*convert to chronic condition vars. to binary variables*/
 data bid_dx_0_&precore.3;
 set bid_dx_0_&precore.2;
 array list CC_1_AMI
CC_2_ALZH
CC_3_ALZHDMTA
CC_4_ATRIALFB
CC_5_CATARACT
CC_6_CHRNKIDN
CC_7_COPD
CC_8_CHF
CC_9_DIABETES
CC_10_GLAUCOMA
CC_11_HIPFRAC
CC_12_ISCHMCHT
CC_13_DEPRESSN
CC_14_OSTEOPRS
CC_15_RA_OA
CC_16_STRKETIA
CC_17_CNCRBRST
CC_18_CNCRCLRC
CC_19_CNCRPRST
CC_20_CNCRLUNG
CC_21_CNCREndM
;
do over list ;
if list>0 then list=1;
if list<=0 then list=0;
end;

/*create aggregated indicators*/
CC_AMI_isch=CC_1_AMI|CC_12_ISCHMCHT;
CC_alzheim=CC_2_ALZH|CC_3_ALZHDMTA;
CC_cncr_chronic=CC_17_CNCRBRST | CC_18_CNCRCLRC | CC_19_CNCRPRST | CC_20_CNCRLUNG | 
	CC_21_CNCREndM ;
run;

proc means;
var CC_1_AMI
CC_2_ALZH
CC_3_ALZHDMTA
CC_4_ATRIALFB
CC_5_CATARACT
CC_6_CHRNKIDN
CC_7_COPD
CC_8_CHF
CC_9_DIABETES
CC_10_GLAUCOMA
CC_11_HIPFRAC
CC_12_ISCHMCHT
CC_13_DEPRESSN
CC_14_OSTEOPRS
CC_15_RA_OA
CC_16_STRKETIA
CC_17_CNCRBRST
CC_18_CNCRCLRC
CC_19_CNCRPRST
CC_20_CNCRLUNG
CC_21_CNCREndM;
run;

/*run rename macro*/
data test;
set bid_dx_0_&precore.3;
run;

%rename(WORK,TEST,&precore.);

data sic_int.chronic_21_&precore.3_0;
set test;
bid_hrs=bid_hrs_&precore.;
drop bid_hrs_&precore.;
core_year=core_year_&precore.;
drop core_year_&precore.;
run;

%mend;

/*2 datasets are sic_int.chronic_21_1yr_0 and sic_int.chronic_21_2yr_0*/
%cc(precore=1yr);
%cc(precore=2yr);

proc freq data=sic_int.chronic_21_1yr3_0;
table cc_:;
run;

proc freq data=sic_int.chronic_21_2yr3_0;
table cc_:;
run;

proc contents data=sic_int.chronic_21_1yr3_0;
run;

/****************************************************************************/
/* Merge cc's with interivew, elix dataset                                  */
/****************************************************************************/
%macro mergecc(precore=);

proc sort data=sic_int.core_ids_elix_&precore.;
by bid_hrs core_year;
run;

proc sort data=sic_int.chronic_21_&precore.3_0;
by bid_hrs core_year;
run;

proc sql;
create table core_ids_elix_cc_&precore.(drop=bid_hrs2 core_year2)
as select * from
sic_int.core_ids_elix_&precore._2 a
left join
sic_int.chronic_21_&precore.3_0(rename=(bid_hrs=bid_hrs2 core_year=core_year2)) b 
on (a.bid_hrs)=(b.bid_hrs2) and a.core_year=b.core_year2;
quit;

/*For observations that have ffs mc 1 year prior to interview
set cc's variables to 0 if missing bc didn't have a dx during that time*/
data sic_int.core_ids_elix_cc_&precore._2;
set core_ids_elix_cc_&precore.;
array list cc_:;
do over list;
if part_ab_12m=1 and hmo_d_12m=0 and list=. then list=0;
end;
run;

%mend;

%mergecc(precore=1yr);
%mergecc(precore=2yr);

/* the above file contains all interviews, if do not have mc ffs
1 year preceeding interview then elixhauser comorbidities and cc's are missing

File names are:
sic_int.core_ids_elix_cc_1yr
sic_int.core_ids_elix_cc_2yr*/

proc contents data=sic_int.core_ids_elix_cc_1yr_2;
run;

proc contents data=sic_int.core_ids_elix_cc_2yr_2;
run;

proc freq data=sic_int.core_ids_elix_cc_1yr_2;
table cc_: comorb_all_0_1yr;
run;

proc freq data=sic_int.core_ids_elix_cc_2yr_2;
table cc_:;
run;






H="Step 5 - Get additional utilization information from claims"
/*These additional variables are just added to the dataset with the
elixhauser and cc's 1 year preceeding the interview, can add them
later when required to get the 2 year look-back dataset*/

/*proc printto new log='&logdir.\sas_7_sic_util_log.log'
	print='&logdir.\sas_7_sic_util_out.lst' 
run;*/


/****************************************************************************/
/*Get indicator of any hospital admission 6 and 12 months pre-core interview*/
/****************************************************************************/

%macro admissions(days=,suffix=);

/*pull list of ip claims from all medpar claims x days pre-interview*/
data ip_meet_&days.;
set sic_int.mp_meet3_&days.(where=(trim(left(SSLSSNF))~="N"));
run;

data ip_&days._2;
set ip_meet_&days.;
if icarecnt=. then icarecnt=0; /*medpar intensive care day count*/
if CRNRYDAY=. then CRNRYDAY=0; /*medpar coronary day count*/
icu_days=icarecnt+CRNRYDAY;
em_urgent_admit=0; /*Urgent , emergent admissions from admission type*/
if type_adm in (1,2) then em_urgent_admit=1;
em_admit=0;
if type_adm=1 then em_admit=1;
urgent_admit=0;
if type_adm=2 then urgent_admit=1;
elect_admit=0;
if type_adm=3 then elect_admit=1;
ind_ed_charge=0; /*ED charges as another indicator of ED use*/
if ER_AMT>0 & ER_AMT~=. then ind_ed_charge=1;
if ER_AMT=0 | ER_AMT=. then ind_ed_charge=0;

/*truncate stays where the admit is more than x days before interview
or discharge is after the interview date so can get accurate LOS*/
if c_ivw_date-admit_date>&days. then do;
	admit_date=c_ivw_date-&days.;
	admit_trunc=1;
	end;
if c_ivw_date<disch_date then do;
	disch_date=c_ivw_date;
	disch_trunc=1;	
	end;
adj_los=disch_date-admit_date;
if disch_date-admit_date=0 then adj_los=1;
run;

proc sort data=ip_&days._2;
by BID_hrs_19 core_year;
run;

proc sql;
create table ip_&days._3 as select distinct BID_hrs_19,core_year,
/*total ICU days*/
sum(icu_days) as icu_days_&suffix. label="total icu days &suffix. pre core ivw",
/*count of IP admissions, all types*/
count(*) as n_ip_admit_&suffix. label="total n of hospital admit &suffix. pre core ivw",
/*total Hospital LOS*/
sum(adj_los) as n_hospd_&suffix. label="total hospital days &suffix. pre core ivw",
/*count urgent or emergency admissions*/
count(case when em_urgent_admit=1 then em_urgent_admit else . end) as n_em_urgent_admit_&suffix. 
	label="total n of urgent/emergent hospital admit &suffix. pre core ivw",
/*count of emergency admissions, from admission type code*/
count(case when em_admit=1 then em_admit else . end) as n_em_admit_&suffix. 
	label="total n of emergent hospital admit &suffix. pre core ivw",
/*count of urgent admissions, from admission type code*/
count(case when urgent_admit=1 then urgent_admit else . end) as n_urgent_admit_&suffix. 
	label="total n of urgent hospital admit &suffix. pre core ivw",
/*count of elective admissions, from admission type code*/
count(case when elect_admit=1 then elect_admit else . end) as n_elect_admit_&suffix. 
	label="total n of elective hospital admit &suffix. pre core ivw",
/*count of admissions with any ED charges*/
count(case when ind_ed_charge=1 then ind_ed_charge else . end) as n_ED_ip_&suffix. 
	label="total n of ED visits with subsequent admit &suffix. pre core ivw"

 from ip_&days._2 group by BID_hrs_19,core_year;
quit;

data ip_&days._4;
set ip_&days._3;
if icu_days_&suffix.>n_hospd_&suffix. then icu_days_&suffix.=n_hospd_&suffix.;
run;

%mend;

%admissions(days=183,suffix=6m);
%admissions(days=365,suffix=12m);

data elective_1;
set ip_365_2;
if elect_admit=1;
run;

/*print to file*/
 ods rtf body="E:\data\serious_ill\logs\elective_primary_dxlist.rtf";
 title"Primary dx list for admit type = elective, inpatient claims last 12m pre-core";
proc freq data=elective_1 order=freq; table dgns_cd01;
run;

title"Admission type vs indicator for any ED charges from rev center codes, claims level";
proc freq data=ip_365_2; table ind_ed_charge*type_adm; run;

ods rtf close; 


/*merge the new variables with the overall dataset with ivws, elix and cc's
variables left blank if no ip claims*/
proc sql;
create table core_ids_criteria_1a as select a.*,b.icu_days_6m,
b.n_ip_admit_6m,b.n_hospd_6m,b.n_em_urgent_admit_6m,b.n_em_admit_6m,
b.n_urgent_admit_6m,b.n_elect_admit_6m,b.n_ED_ip_6m
from sic_int.core_ids_elix_cc_1yr_2 a
left join
ip_183_3 b 
on trim(left(a.bid_hrs))=trim(left(b.bid_hrs_19)) and a.core_year=b.core_year;
quit;

proc sql;
create table core_ids_criteria_1 as select a.*,b.icu_days_12m,
b.n_ip_admit_12m,b.n_hospd_12m,b.n_em_urgent_admit_12m,b.n_em_admit_12m,
b.n_urgent_admit_12m,b.n_elect_admit_12m,b.n_ED_ip_12m
from core_ids_criteria_1a a
left join
ip_365_3 b 
on trim(left(a.bid_hrs))=trim(left(b.bid_hrs_19)) and a.core_year=b.core_year;
quit;

/*Since set comorbidities = 0 if no dx but have ffs mc 1 year preceeding the
core interview, can use comorb = ., same as ffs mc 1 year=no*/
 data core_ids_1yr_criteria ;
 set core_ids_criteria_1 ;
 array list icu_days_6m n_ip_admit_6m n_hospd_6m n_em_urgent_admit_6m 
	n_em_admit_6m n_urgent_admit_6m n_elect_admit_6m n_ED_ip_6m
	icu_days_12m n_ip_admit_12m n_hospd_12m n_em_urgent_admit_12m
	n_em_admit_12m n_urgent_admit_12m n_elect_admit_12m n_ED_ip_12m;
 do over list;
 if list=. & comorb_1_0_1yr~=. then list=0;
 end;

 if n_ip_admit_6m=0 then ind_hosp_adm_6m=0;
 if n_ip_admit_6m>0 & n_ip_admit_6m~=. then ind_hosp_adm_6m=1;
 label ind_hosp_adm_6m="Indicator for any hospital admission 6m pre core";

 if n_em_urgent_admit_6m=0 then ind_em_ur_adm_6m=0;
 if n_em_urgent_admit_6m>0 & n_em_urgent_admit_6m~=. then ind_em_ur_adm_6m=1;
 label ind_em_ur_adm_6m="Ind any urgent or emergent hospital admission 6m pre core";

 if n_em_admit_6m=0 then ind_em_adm_6m=0;
 if n_em_admit_6m>0 & n_em_admit_6m~=. then ind_em_adm_6m=1;
 label ind_em_adm_6m="Ind any emergency hospital admission 6m pre core";

 if n_urgent_admit_6m=0 then ind_ur_adm_6m=0;
 if n_urgent_admit_6m>0 & n_urgent_admit_6m~=. then ind_ur_adm_6m=1;
 label ind_ur_adm_6m="Ind any urgent hospital admission 6m pre core";

 if n_elect_admit_6m =0 then ind_elect_adm_6m=0;
 if n_elect_admit_6m >0 & n_elect_admit_6m ~=. then ind_elect_adm_6m=1;
 label ind_elect_adm_6m="Ind any elective hospital admission 6m pre core";

 if (n_ip_admit_6m - n_elect_admit_6m)=0 then ind_nonelect_adm_6m=0;
 if (n_ip_admit_6m - n_elect_admit_6m)>0 & n_elect_admit_6m~=. then ind_nonelect_adm_6m=1;
 label ind_nonelect_adm_6m="Ind any non-elective hospital admission 6m pre core";

 n_nonelect_adm_6m=(n_ip_admit_6m - n_elect_admit_6m);
 label n_nonelect_adm_6m="total n non-elective ip admit 6m pre core";

 if n_ED_ip_6m=0 then ind_ED_adm_6m=0;
 if n_ED_ip_6m>0 & n_ED_ip_6m~=. then ind_ED_adm_6m=1;
 label ind_ED_adm_6m="Ind ED use with hospital admission 6m pre core, from charges";

 if n_ip_admit_12m=0 then ind_hosp_adm_12m=0;
 if n_ip_admit_12m>0 & n_ip_admit_12m~=. then ind_hosp_adm_12m=1;
 label ind_hosp_adm_12m="Indicator for any hospital admission 12m pre core";

 if n_em_urgent_admit_12m=0 then ind_em_ur_adm_12m=0;
 if n_em_urgent_admit_12m>0 & n_em_urgent_admit_12m~=. then ind_em_ur_adm_12m=1;
 label ind_em_ur_adm_12m="Ind any urgent or emergent hospital admission 12m pre core";

 if n_em_admit_12m=0 then ind_em_adm_12m=0;
 if n_em_admit_12m>0 & n_em_admit_12m~=. then ind_em_adm_12m=1;
 label ind_em_adm_12m="Ind any emergency hospital admission 12m pre core";

 if n_urgent_admit_12m=0 then ind_ur_adm_12m=0;
 if n_urgent_admit_12m>0 & n_urgent_admit_12m~=. then ind_ur_adm_12m=1;
 label ind_ur_adm_12m="Ind any urgent hospital admission 12m pre core";

 if n_elect_admit_12m =0 then ind_elect_adm_12m=0;
 if n_elect_admit_12m >0 & n_elect_admit_12m ~=. then ind_elect_adm_12m=1;
 label ind_elect_adm_12m="Ind any elective hospital admission 12m pre core";

 if (n_ip_admit_12m - n_elect_admit_12m)=0 then ind_nonelect_adm_12m=0;
 if (n_ip_admit_12m - n_elect_admit_12m)>0 & n_elect_admit_12m~=. then ind_nonelect_adm_12m=1;
 label ind_nonelect_adm_12m="Ind any non-elective hospital admission 12m pre core";

 n_nonelect_adm_12m=(n_ip_admit_12m - n_elect_admit_12m);
 label n_nonelect_adm_12m="total n non-elective ip admit 12m pre core";

 if n_ED_ip_12m=0 then ind_ED_adm_12m=0;
 if n_ED_ip_12m>0 & n_ED_ip_12m~=. then ind_ED_adm_12m=1;
 label ind_ED_adm_12m="Ind ED use with hospital admission 12m pre core, from charges";

run;

 proc freq;
 table icu_days_6m n_ip_admit_6m n_hospd_6m ind_hosp_adm_6m n_em_urgent_admit_6m ind_em_ur_adm_6m 
	ind_em_adm_6m ind_ur_adm_6m ind_nonelect_adm_6m n_nonelect_adm_6m n_ED_ip_6m ind_ED_adm_6m 
	ind_em_adm_6m*ind_ED_adm_6m /missprint;
 run;

proc freq;
table icu_days_12m n_ip_admit_12m n_hospd_12m ind_hosp_adm_12m n_em_urgent_admit_12m ind_em_ur_adm_12m
	ind_em_adm_12m ind_ur_adm_12m ind_nonelect_adm_12m n_nonelect_adm_12m n_ED_ip_12m ind_ED_adm_12m 
	ind_em_adm_12m*ind_ED_adm_12m /missprint;
run;

/****************************************************************************/
/****************************************************************************/
/*Get SNF days, indicator for 12 months preceding the interview*/
/****************************************************************************/
/****************************************************************************/

/*pull list of snf claims from all medpar claims 12 months pre-interview*/
data snf_meet_365;
set sic_int.mp_meet3_365(where=(trim(left(SSLSSNF))="N"));
run;

proc sort data=snf_meet_365;
by bid_hrs_19 admit_date;
run;

data snf_meet_365_1a;
set snf_meet_365;
format admit_date date9. disch_date date9.;
run;

/*3 claim windows are present:
1. SNF stays fully within the 1 year before interview
2. Stays that begin before 1 year pre-core but end within 1 year pre-core
3. Stays that begin within 1 year of core but end after core ivw
4. Stays that begin before 1 year and end after interview, LOS=365!
Get claims that meet 1 *2299*/
proc sql;
create table snf_meet1_pre_365 as select *
from snf_meet_365_1a
where (c_ivw_date - admit_date)<365 & (c_ivw_date - disch_date)>=0; 
quit;


/*meet time window 2 *172*/
proc sql;
create table snf_meet2_pre_365 as select *
from snf_meet_365_1a
where (c_ivw_date - admit_date)>=365 & (c_ivw_date - disch_date)>=0; 
quit;

/*For these claims that start > 1 year before core, truncate start date so 
only count LOS days w/i 1 year
create indicator variable that claim start date is truncated*/
data snf_meet2_pre_365_1;
set snf_meet2_pre_365;
admit_date = c_ivw_date-365;
snf_admit_date_mod = 1;
label snf_admit_date_mod = "Admit date mod; at 12 mo from ivw date";
run;

proc freq;
table snf_admit_date_mod ;
run;

/*meet time window 3 *188 */
proc sql;
create table snf_meet3_pre_365 as select *
from snf_meet_365_1a
where (c_ivw_date - admit_date)<365 & (c_ivw_date-disch_date)<0; 
quit;

/*For these claims that end after core, truncate end date so 
only count LOS days 1 year before the core
create indicator variable that claim end date is truncated*/
data snf_meet3_pre_365_1;
set snf_meet3_pre_365;
disch_date = c_ivw_date;
snf_disch_date_mod = 1;
label snf_disch_date_mod = "Disch date mod; at ivw date";
run;

proc freq;
table snf_disch_date_mod ;
run;

/*meet 4 *10*/
proc sql;
create table snf_meet4_pre_365 as select *
from snf_meet_365_1a
where (c_ivw_date - admit_date)>=365 & (c_ivw_date - disch_date)<0; 
quit;

/*truncate both start and end dates so just count 1 year pre interview*/
data snf_meet4_pre_365_1;
set snf_meet4_pre_365;
disch_date = c_ivw_date;
snf_disch_date_mod = 1;
label snf_disch_date_mod = "Disch date mod; at ivw date";
admit_date = c_ivw_date-365;
snf_admit_date_mod = 1;
label snf_admit_date_mod = "Admit date mod; at 12 mo from ivw date";
run;

proc freq;
table snf_disch_date_mod snf_admit_date_mod;
run;


data snf_meet_pre_365;
set snf_meet1_pre_365 snf_meet2_pre_365_1 snf_meet3_pre_365_1 snf_meet4_pre_365_1;
run;

proc freq;
table snf_admit_date_mod snf_disch_date_mod ;
run;

/*save final files to project int_data directory*/
data sic_int.snf_meet_pre_365 ;
set  snf_meet_pre_365;
run;

/*************************************************************/
/*calculate total number of days spent in SNF by BID*/
/*************************************************************/

data pre_snf_days_1;
set sic_int.snf_meet_pre_365;
calc_snf_LOS=disch_date-admit_date;
if calc_snf_LOS=0 then calc_snf_LOS=1;
run;

proc sort data=pre_snf_days_1;
by bid_hrs_19 c_ivw_date admit_date;
run;

proc sql;
create table snf_days_pre as select distinct bid_hrs_19,core_year,
sum(calc_snf_LOS)
	as n_snf_days_12m
	from pre_snf_days_1 group by bid_hrs_19,core_year;
quit;

proc freq;
table n_snf_days_12m;
run;

/*merge into full dataset*/
proc sql;
create table core_ids_criteria_2a as select a.*,b.n_snf_days_12m
from core_ids_1yr_criteria a
left join
snf_days_pre b 
on trim(left(a.bid_hrs))=trim(left(b.bid_hrs_19)) and a.core_year=b.core_year;
quit;

 data core_ids_1yr_criteria_2 ;
 set core_ids_criteria_2a ;
 array list n_snf_days_12m;
 do over list;
 if list=. & comorb_1_0_1yr~=. then list=0;
 end; 

if n_snf_days_12m=0 then ind_snf_use_12m=0;
 if n_snf_days_12m>0 & n_snf_days_12m~=. then ind_snf_use_12m=1;
 label ind_snf_use_12m="Indicator for any SNF stay 12m pre core";
 label n_snf_days_12m="SNF Days 12m pre core"

run;

proc freq;
table n_snf_days_12m ind_snf_use_12m /missprint;
run;



/****************************************************************************/
/****************************************************************************/
/*Get indicator of ESRD codes from the denominator file the year of the interview*/
/****************************************************************************/
/****************************************************************************/
proc sort data=medi.dn_2000_2010 out=dn_2000_20102  nodupkey;
by BID_HRS_19 year;
run;

/*pull ESRD status variable from dn file
for the core interview years*/
proc sql;
create table dn_core_y as select
a.*,b.ESRD_IND from 
core_ids_1yr_criteria_2 a left join
dn_2000_20102 b
on trim(left(a.BID_hrs))=trim(left(b.BID_hrs_19))
and a.c_ivw_year=b.year;
quit;

proc freq;
table ESRD_IND /missprint;
run;

data core_ids_1yr_criteria_2b;
set dn_core_y ;
if ESRD_IND='Y' then esrd_ind_n=1;
if ESRD_IND='0' then esrd_ind_n=0;
label esrd_ind_n="ESRD indicator from claims denominator file";
drop ESRD_IND;
run;

proc freq;
table esrd_ind_n /missprint;
run;


/****************************************************************************/
/*Get indicator of Home 02 use 12 months pre interview from DME claims*/
/****************************************************************************/
data oxygen_1(keep=BID_HRS_19 core_year home_oxygen);
set sic_int.dm_meet_365;
home_oxygen=0;
label home_oxygen="Home O2 from DME claims";
array list BETOS01:BETOS13;
do over list;
if list = 'D1C' then home_oxygen=1;
end;
run; 

proc sort data=oxygen_1;
by bid_hrs_19 core_year;
run;

proc freq;
table core_year /missprint;
run;

proc sql;
create table oxygen_2 as
select distinct bid_hrs_19,core_year,
sum(home_oxygen) as home_oxygen
from oxygen_1 group by bid_hrs_19,core_year;
quit;

/*convert to binary variables*/
data oxygen_3;
set oxygen_2 ;
if home_oxygen>0 then home_oxygen=1;
if home_oxygen<=0 then home_oxygen=0;
run;

proc freq;
table home_oxygen;
run;

/*merge Oxygen use variable into the overall dataset*/
proc sql;
create table core_ids_1yr_criteria_3 as select
a.*,b.home_oxygen
from core_ids_1yr_criteria_2b a left join
oxygen_3 b
on trim(left(a.BID_hrs))=trim(left(b.BID_hrs_19))
and a.core_year=b.core_year;
quit;

data sic_int.core_ids_1yr_criteria_4;
set core_ids_1yr_criteria_3;
if home_oxygen=. and comorb_1_0_1yr~=. then home_oxygen=0;
label home_oxygen="Home O2 use from DME claims 1yr pre ivw";
run;

proc freq;
table home_oxygen /missprint;
run;


H="Step 5a - Get outpatient ED use info"
/*proc printto new log='&logdir.\sas_8_sic_op_ed_log.log'
	print='&logdir.\sas_8_sic_op_ed_out.lst' 
run;*/

data op_meet_365;
set sic_int.op_meet_365(keep=bid_hrs_19 admit_date disch_date c_ivw_date core_year RVCNTR01-RVCNTR45);
run;

proc sort data=op_meet_365;
by bid_hrs_19 admit_date;
run;

data ed_op_1;
	set op_meet_365;
	ed_op=0;
	array list RVCNTR01-RVCNTR45;
	do over list;
	if list >= 450 and list < 460 and ed_op=0 then  
	ed_op = 1;
	end;
run;

proc freq;
table ed_op;
run;

proc sql;
create table ed_op_2 as select distinct bid_hrs_19,core_year,
count(case when ed_op=1 then ed_op else . end)
	as n_ed_op_visits_12m
	from ed_op_1 group by bid_hrs_19,core_year;
quit;

proc freq;
table n_ed_op_visits_12m;
run;

/*merge into dataset*/
proc sql;
create table core_ids_1yr_criteria_4a as select a.*,b.n_ed_op_visits_12m
from sic_int.core_ids_1yr_criteria_4 a
left join
ed_op_2 b 
on trim(left(a.bid_hrs))=trim(left(b.bid_hrs_19)) and a.core_year=b.core_year;
quit;

data sic_int.core_ids_1yr_criteria_4b;
set core_ids_1yr_criteria_4a;
if n_ed_op_visits_12m=. and comorb_1_0_1yr~=. then n_ed_op_visits_12m=0;
label n_ed_op_visits_12m="Count ED OP visits, 1yr pre ivw";

if n_ed_op_visits_12m=0 then ind_ed_op_12m=0;
if n_ed_op_visits_12m>0 & n_ed_op_visits_12m~=. then ind_ed_op_12m=1;
label ind_ed_op_12m="Indicator any ED OP visits, 1 yr pre ivw";
run;

proc freq;
table n_ed_op_visits_12m*ind_ed_op_12m;
run;

H="Step 5b - Classify serious illness based on just primary dx"
/*proc printto new log='&logdir.\sas_9_sic_pri_dx_log.log'
	print='&logdir.\sas_9_sic_pri_dx_out.lst' 
run;*/


/*recoded as a macro and use either the primary diagnosis or admitting diagnoses AD_DGNS */

/*start with IP claim list, 1 year before interview*/

%macro singledx(dxvar=,name=);

data dx_1_&name.;
set sic_int.mp_meet3_365(where=(trim(left(SSLSSNF))~="N"));

&name._dx=trim(left(&dxvar.));

if &name._dx~="" then do;

chf_&name._dx=0;
copd_&name._dx=0;
hip_&name._dx=0;

/*CHF*/
if (substr(&name._dx,1,5)='39891' or
		substr(&name._dx,1,5)='40211' or
		substr(&name._dx,1,5)='40291' or
		substr(&name._dx,1,5)='40411' or
		substr(&name._dx,1,5)='40413' or
		substr(&name._dx,1,5)='40491' or
		substr(&name._dx,1,5)='40493' or
		substr(&name._dx,1,3)='428') 
		and chf_&name._dx=0 
		then chf_&name._dx=1;*add one binary variables here.;
/*COPD*/
	if (substr(&name._dx,1,3)='490' or
		substr(&name._dx,1,3)='491' or
		substr(&name._dx,1,3)='492' or
		substr(&name._dx,1,4)='4930' or
		substr(&name._dx,1,4)='4931' or
		substr(&name._dx,1,4)='4932' or
		substr(&name._dx,1,4)='4938' or
		substr(&name._dx,1,5)='49390' or
		substr(&name._dx,1,5)='49391' or
		substr(&name._dx,1,3)='494' or
		substr(&name._dx,1,3)='495' or
		substr(&name._dx,1,3)='496' or
		substr(&name._dx,1,3)='497' or
		substr(&name._dx,1,3)='498' or
		substr(&name._dx,1,3)='499' or
		substr(&name._dx,1,3)='500' or
		substr(&name._dx,1,3)='501' or
		substr(&name._dx,1,3)='502' or
		substr(&name._dx,1,3)='503' or
		substr(&name._dx,1,3)='504' or
		substr(&name._dx,1,3)='505' or
		substr(&name._dx,1,4)='5064') 
			and copd_&name._dx=0 
		then copd_&name._dx=1;	
*hip fracture;
if (substr(&name._dx,1,3)='820' ) 
		and hip_&name._dx=0 
		then hip_&name._dx=1;*add one binary variables here.;
end;
run;

proc sql;
create table &name._dx_2 as
select distinct BID_hrs_19,core_year,
sum(chf_&name._dx) as chf_&name.,
sum(copd_&name._dx) as copd_&name.,
sum(hip_&name._dx) as hip_&name.
from dx_1_&name.
group by BID_hrs_19,core_year;
quit;

/*convert counts of diagnoses for each comorbidity to indicator variables*/ 
data &name._dx_3(keep=BID_hrs_19 core_year chf_&name._dx copd_&name._dx hip_&name._dx);
set &name._dx_2 ;
array list_com chf_&name. copd_&name. hip_&name.;
array list_com_bin chf_&name._dx copd_&name._dx hip_&name._dx;

do over list_com;
  list_com_bin=0;

  if list_com>0 then do;
    list_com_bin=1;
   end;

end;

run;

proc freq;
table chf_&name._dx copd_&name._dx hip_&name._dx;
run;
%mend;

/*use primary diagnosis code*/
%singledx(dxvar=dgns_cd01,name=pri);
/*use admitting diagnosis code*/
%singledx(dxvar=AD_DGNS,name=adm);

/*merge into dataset*/
proc sql;
create table core_ids_1yr_criteria_4c as select a.*,b.chf_pri_dx,
b.copd_pri_dx,b.hip_pri_dx
from sic_int.core_ids_1yr_criteria_4b a
left join
pri_dx_3 b 
on trim(left(a.bid_hrs))=trim(left(b.bid_hrs_19)) and a.core_year=b.core_year;
quit;

proc sql;
create table core_ids_1yr_criteria_4d as select a.*,b.chf_adm_dx,
b.copd_adm_dx,b.hip_adm_dx
from core_ids_1yr_criteria_4c a
left join
adm_dx_3 b 
on trim(left(a.bid_hrs))=trim(left(b.bid_hrs_19)) and a.core_year=b.core_year;
quit;

data sic_int.core_ids_1yr_criteria_4e;
set core_ids_1yr_criteria_4d;

array list chf_pri_dx copd_pri_dx hip_pri_dx chf_adm_dx copd_adm_dx hip_adm_dx;
do over list;
	if list = . and comorb_1_0_1yr~=. then list=0;
end;
label chf_pri_dx="CHF as primary dx from IP claim, 1yr pre ivw";
label copd_pri_dx="COPD as primary dx from IP claim, 1yr pre ivw";
label hip_pri_dx="Hip fracture as primary dx from IP claim, 1yr pre ivw";

label chf_adm_dx="CHF as admitting dx from IP claim, 1yr pre ivw";
label copd_adm_dx="COPD as admitting dx from IP claim, 1yr pre ivw";
label hip_adm_dx="Hip fracture as admitting dx from IP claim, 1yr pre ivw";

run;

proc freq;
table chf_pri_dx*chf_adm_dx copd_pri_dx*copd_adm_dx hip_pri_dx*hip_adm_dx ;
run;

/*Hip fracture criteria, method  by Covinsky
One of the (2) criteria met:
(1) Subject was admitted to a hospital with admitting diagnosis of “820.xx”.
(2) There is a physician record of “HF procedure” (defined by CPT code of 27230-27248) that is supported by either: 
a. Another physician record within 2 days OR 2
b. Relevant surgery during hospitalization. (Relevant surgery is defined by ICD9 codes 785.5, 790.5, 791.5, 792.5). 
(1) variable hip_adm_dx defined in macro above
(2) HF procedure: carrier claims 	(HCPCS_YR specifies the year of CPT coding used)
					HCPSCD01-HCPSCD13 The level 1 HCPCS code is the CPT code
Then a)from carrier claims or 
     b) from IP claims
	

For item (2) checked inpatient claims variables HCPSCD01-45 but none had any of the CPT codes in the list
Next step, try running with carrier files...
*/

/********************************************************************/
/*Physican record of HF procedure, check IP claims*/
data ip_meet_365;
set sic_int.ip_meet3_365;
run;

proc contents data=ip_meet_365;
run;

data testhf;
set ip_meet_365;
if HCPSCD01~='';
run;

data hfproc_ip;
set ip_meet_365;
hf_proc_ind=0;
array list HCPSCD01-HCPSCD45;
do over list;
if list~='' then do;
	if (list='27230' or
		list='27231' or
		list='27232' or
		list='27233' or
		list='27234' or
		list='27235' or
		list='27236' or
		list='27237' or
		list='27238' or
		list='27239' or
		list='27240' or
		list='27241' or
		list='27242' or
		list='27243' or
		list='27244' or
		list='27245' or
		list='27246' or
		list='27247' or
		list='27248')
		/*and hf_proc_ind=0*/
		then hf_proc_ind=1;
	end;
end;


run;

proc freq; table hf_proc_ind;
run;

/********************************************************************/
/*Physican record of HF procedure, check carrier claims*/
/********************************************************************/

data hfproc_carr;
set sic_int.pb_meet_365;
hf_proc_ind=0;
array list HCPSCD01-HCPSCD13;
do over list;
if list~='' then do;
	if (list='27230' or
		list='27231' or
		list='27232' or
		list='27233' or
		list='27234' or
		list='27235' or
		list='27236' or
		list='27237' or
		list='27238' or
		list='27239' or
		list='27240' or
		list='27241' or
		list='27242' or
		list='27243' or
		list='27244' or
		list='27245' or
		list='27246' or
		list='27247' or
		list='27248')
		/*and hf_proc_ind=0*/
		then hf_proc_ind=1;
	end;
end;


run;

proc freq; table hf_proc_ind;
run;
/********************************************************************/
/*is there also a physican record within 2 days?*/
proc sort data=hfproc_carr; by BID_HRS_19 FROM_DT THRU_DT hf_proc_ind;
run;

data hfproc_carr_2;
set hfproc_carr;
if eof1=0 then
	set hfproc_carr (firstobs=2 keep=admit_date disch_date rename=(admit_date=lead1admit disch_date=lead1disch)) end=eof1;
else do; lead1admit=.;  lead1disch=.; end;
run;

data hfproc_carr_3;
set hfproc_carr_2;
days_next_visit=lead1admit-disch_date;
days_next_disch=lead1disch-disch_date;
if hf_proc_ind=1 and days_next_visit<=2 and days_next_visit~=. & days_next_disch>0 then hf_w_visit_2d=1;
else hf_w_visit_2d=0;
run;

data hfproc_carr_4;
set hfproc_carr_3;
if hf_proc_ind=1;
run;

proc freq data=hfproc_carr_3;
table hf_proc_ind hf_w_visit_2d core_year; run;

/*if have hf CPT code from carrier, but no subsequent carrier claim,
do they have a surgery code from the inpatient claims?*/
data hfproc_carr_5;
set hfproc_carr_4;
if hf_proc_ind=1 and hf_w_visit_2d=0;
run;




/*for b) identify relevant surgeries from IP claims CPT codes and surgery dates*/

/*This section of code for just checking For Surgeries*/
data ip_meet_365;
set sic_int.mp_meet3_365(where=(trim(left(SSLSSNF))~="N"));
run;

proc contents data=ip_meet_365;
run;

data proc_long(keep=BID_hrs_19 TYPE_ADM procedure procedure_date date_imp_yes AD_DGNS DGNS_CD01-DGNS_CD25
	 admit_date disch_date core_year);
set ip_meet_365;
array list PRCDR_CD01-PRCDR_CD25;
array date PRCDR_DT01-PRCDR_DT25;
do over list;
if list~="" then do;
	procedure=list;
	if date=0000000 then do;
		procedure_date=admit_date;
		date_imp_yes=1;
		end;
	if date~=0000000 then do;
	procedure_date=datejul(date);
	end;
	output;
end;
end;

format procedure_date date10.;
format admit_date date10.;
format disch_date date10.;

run;

proc freq; table date_imp_yes; run;

/* Identify surgeries that meet the criteria
Indicator variable surgery_meet = 1 if yes, include in sample 
79 surgeries meet the criteria*/
data surgery_meet;
set proc_long;
if length(compress(procedure))>3 then do;

if compress(procedure)+0 in (7855, 7905, 7915, 7925) then surgery_meet=1;

end;
/*only keep observations in work.surgery_meet that meet criteria*/
if surgery_meet then output;

run;
/*End surgery section 1*/

/*who has surgery that meets criteria AND hf CPT code from carrier?*/
proc sql;
create table cpt_and_surg as select a.*,b.admit_date as carr_hf_admit, b.disch_date as carr_hf_disch,
b.hf_proc_ind, b.hf_w_visit_2d from 
surgery_meet a inner join
hfproc_carr_5 b
on a.bid_hrs_19=b.bid_hrs_19;
quit;

data cpt_and_surg_1;
set cpt_and_surg;
format carr_hf_admit carr_hf_disch date9.;
hf_w_surgery=1;
run;

/*now merge in lists to get a list of bid's that meet criteria 1 or 2*/
data cpt_and_surg_2;
set cpt_and_surg_1;
keep bid_hrs_19 hf_proc_ind hf_w_surgery core_year;
run;

proc sort data=cpt_and_surg_2 nodupkey; by bid_hrs_19 core_year ; run;

data hfproc_carr_6;
set hfproc_carr_4;
keep bid_hrs_19 hf_proc_ind hf_w_visit_2d core_year;
if hf_proc_ind=1 and hf_w_visit_2d=1;
run;

proc sort data=hfproc_carr_6 nodupkey; by bid_hrs_19  core_year ; run;

*merge the datasets;
data hf_meet;
merge hfproc_carr_6 cpt_and_surg_2 ;
by bid_hrs_19 core_year;
run;

proc sort data=hf_meet out=hf_meet2 nodupkey; by bid_hrs_19  core_year; run;

/*merge in these hip fracture variables*/
proc sql;
create table core_ids_1yr_criteria_4f
as select a.*,b.hf_w_visit_2d,b.hf_w_surgery from
sic_int.core_ids_1yr_criteria_4e a left join
hf_meet2 b
on a.bid_hrs=b.bid_hrs_19 and a.core_year=b.core_year;
quit;

proc freq; table hf_w_visit_2d*hf_w_surgery /missprint;
run;

data sic_int.core_ids_1yr_criteria_4g;
set core_ids_1yr_criteria_4f;

array list hf_w_visit_2d hf_w_surgery ;
do over list;
	if list = . and comorb_1_0_1yr~=. then list=0;
end;
label hf_w_visit_2d ="HF CPT + Dr visit within 2 days, 1yr pre ivw";
label hf_w_surgery ="HF CPT + Surgery, 1yr pre ivw";

run;



/*Another idea is to check IP claims
if CPT code (in fields HCPCSCD01-HCPCSCD45 in list then if PRCDRCD1-PRCDRCD25 in list = hip frature = yes*/


H="Step 6 - HRS variable cleaning and check criteria"
/*proc printto new log='&logdir.\sas_10_sic_crit_log.log'
	print='&logdir.\sas_10_sic_crit_out.lst' 
run;*/

proc freq
data=sic_int.core_ids_1yr_criteria_4g;
table comorb_31_0_1yr;
run;

data sic_int.core_ids_1yr_criteria_5;
set sic_int.core_ids_1yr_criteria_4g ;

/*create tics categorical variable*/
if tics_tot>8 then tics_cat=1 ;
if 5<=tics_tot<=8 then tics_cat=2 ;
if 0<=tics_tot<=4 then tics_cat=3 ;
label tics_cat="TICS 1=normal, 2=MCI, 3=Demented";

/*any elixhauser cancer dx*/
if comorb_17_0_1yr=1 | comorb_18_0_1yr=1 | comorb_19_0_1yr=1 then el_cancer_1yr=1;
if comorb_17_0_1yr=0 & comorb_18_0_1yr=0 & comorb_19_0_1yr=0 then el_cancer_1yr=0;

/*4 or more comorbidities - needs to be reevaluated once other defs are defined!*/
if comorb_all_0_1yr>3 then el_ge4_comorb_1yr=1;
if 0=<comorb_all_0_1yr<=3 then el_ge4_comorb_1yr=0;

cc_all_count_1yr = cc_1_ami_1yr + cc_2_alzh_1yr + cc_3_alzhdmta_1yr + 
cc_4_atrialfb_1yr + cc_5_cataract_1yr + cc_6_chrnkidn_1yr + 
cc_7_copd_1yr + cc_8_chf_1yr + cc_9_diabetes_1yr + cc_10_glaucoma_1yr + 
cc_11_hipfrac_1yr + cc_12_ischmcht_1yr + cc_13_depressn_1yr + 
cc_14_osteoprs_1yr + cc_15_ra_oa_1yr + cc_16_strketia_1yr + 
cc_17_cncrbrst_1yr + cc_18_cncrclrc_1yr + cc_19_cncrprst_1yr + 
cc_20_cncrlung_1yr + cc_21_cncrendm_1yr;

if cc_all_count_1yr >3 then cc_ge4_comorb_1yr=1;
if 0=<cc_all_count_1yr <=3 then cc_ge4_comorb_1yr=0;

/*cc's excluding cataract and glaucoma*/
cc_all_count_1yr_2 = cc_1_ami_1yr + cc_2_alzh_1yr + cc_3_alzhdmta_1yr + 
cc_4_atrialfb_1yr + /*cc_5_cataract_1yr +*/ cc_6_chrnkidn_1yr + 
cc_7_copd_1yr + cc_8_chf_1yr + cc_9_diabetes_1yr + /*cc_10_glaucoma_1yr +*/ 
cc_11_hipfrac_1yr + cc_12_ischmcht_1yr + cc_13_depressn_1yr + 
cc_14_osteoprs_1yr + cc_15_ra_oa_1yr + cc_16_strketia_1yr + 
cc_17_cncrbrst_1yr + cc_18_cncrclrc_1yr + cc_19_cncrprst_1yr + 
cc_20_cncrlung_1yr + cc_21_cncrendm_1yr;
label cc_all_count_1yr_2="Count of cc's, excludes cataract and glaucoma";

if cc_all_count_1yr_2>3 then cc2_ge4_comorb_1yr=1;
if 0=<cc_all_count_1yr_2<=3 then cc2_ge4_comorb_1yr=0;

label el_ge4_comorb_1yr="4+ Elixhauser comorbidities";
label cc_ge4_comorb_1yr="4+ DW Chronic Conditions";
label cc2_ge4_comorb_1yr="4+ DW Chronic Conditions, excl cataract and glaucoma";

/*create indicators for any indication of the serious medical illnesses across
variables (cc's elix hrs survey) */
if comorb_31_0_1yr=1  then smi_dem_ind=1;
if comorb_31_0_1yr=0  then smi_dem_ind=0;
label smi_dem_ind="Indicator of Dementia 1yr, Elixhauser";

/*old def commented out
if el_cancer_1yr=1 | CC_cncr_chronic_1yr=1 | cancer_hrs=1 then cancer_any_ind=1;
if el_cancer_1yr=0 & CC_cncr_chronic_1yr=0 & cancer_hrs=0 then cancer_any_ind=0; */
/*cancer flagged as serious medical illness if metastatic cancer 
or blood cancers new def to be provided from Amy*/
if comorb_18_0_1yr=1 then smi_cancer_ind=1;
if comorb_18_0_1yr=0 then smi_cancer_ind=0;
label smi_cancer_ind="Indicator of Metastatic Cancer 1yr";

/*ESRD from either dx code per elixhauser or denominator file flag*/
if comorb_13_0_1yr=1 | esrd_ind_n=1 then smi_esrd_ind=1;
if comorb_13_0_1yr=0 & esrd_ind_n=0  then smi_esrd_ind=0;
label smi_esrd_ind="Indicator of ESRD 1yr, Elix and claims DN file";

/*note needs to add a second criteria for indicator of advanced disease
for final definition of chf as a serious medical illness*/
if chf_pri_dx=1  then smi_chf_ind=1;
if chf_pri_dx=0  then smi_chf_ind=0;
label smi_chf_ind="Indicator of CHF 1yr, Primary dx from IP claim";

/*COPD indicator meets following criteria:
1. COPD from Elix (any dx field) and Oxygen use from DME claims or
2. COPD as a primary diagnosis*/
if (comorb_9_0_1yr=1 & home_oxygen=1) | copd_pri_dx=1 then smi_copd_ind=1;
if (comorb_9_0_1yr=0 | home_oxygen=0) & copd_pri_dx=0 then smi_copd_ind=0;
label smi_copd_ind="Indicator of COPD 1yr, copd any dx and home o2 use or copd as prim dx";

/*diabetes, Elix 11 (diabetes with complications) if criteria for 
renal disease (comorb 34), ischemic heart disease (cc 12) or 
peripheral vascular disease (comorb 5) are present*/
if comorb_11_0_1yr=1 & (comorb_5_0_1yr=1 | comorb_34_0_1yr=1 | CC_12_ISCHMCHT_1yr =1) then
	smi_diab_compl_ind=1;
if comorb_11_0_1yr=0 | (comorb_5_0_1yr=0 & comorb_34_0_1yr=0 & CC_12_ISCHMCHT_1yr =0) then
	smi_diab_compl_ind=0;
label smi_diab_compl_ind="Elix compl diabetes + peripheral vas, renal or ischem, 1yr";

if comorb_14_0_1yr=1 then smi_liver_ind=1;
if comorb_14_0_1yr=0 then smi_liver_ind=0;
label smi_liver_ind="Indicator of Advanced liver disease/cirrhosis 1yr, elix";

if comorb_16_0_1yr=1 then smi_hiv_ind=1;
if comorb_16_0_1yr=0 then smi_hiv_ind=0;
label smi_hiv_ind="Indicator of HIV with and AIDS defining illness 1yr, elix";

if comorb_33_0_1yr=1 then smi_als_ind=1;
if comorb_33_0_1yr=0 then smi_als_ind=0;
label smi_als_ind="Indicator of ALS 1yr, icd9 code";

/*hip fracture, either admitting diagnosis or CPT from carrier claim AND
surgery or follow up carrier claim within 2 days*/
if hip_adm_dx=1 | hf_w_visit_2d=1 | hf_w_surgery=1 then smi_hip_ind=1;
if hip_adm_dx=0 & hf_w_visit_2d=0 & hf_w_surgery=0 then smi_hip_ind=0;
label smi_hip_ind="Indicator of Hip fracture 1yr, adm dx or from physician claims";
/*******************************************************************/
/*******************************************************************/

/*doesn't use the cc definition excluding cataract,glaucoma cc2_ge4_comorb_1yr */
if el_ge4_comorb_1yr=1 | cc_ge4_comorb_1yr=1 | comor_c_hrs=1 then multi_any_ind=1;
if el_ge4_comorb_1yr=0 & cc_ge4_comorb_1yr=0 & comor_c_hrs=0 then multi_any_ind=0;
label multi_any_ind="Any indicator of Multimorbidity 4+ chronic conditions 1yr";

/*total number of serious medical illnesses per these definitions*/
smi_count=smi_dem_ind + smi_cancer_ind + smi_esrd_ind + smi_chf_ind + smi_copd_ind + 
 smi_diab_compl_ind + smi_liver_ind + smi_hiv_ind + smi_als_ind + smi_hip_ind;

/*indicator for 2+serious medical illnesses*/
if smi_count>=2 then smi_ge2_ind=1;
if smi_count<2 then smi_ge2_ind=0;
label smi_ge2_ind="2 or more serious medical illnesses";

/*indicator for any serious medical illness*/
if smi_dem_ind =1 | smi_cancer_ind =1 | smi_esrd_ind =1 | smi_chf_ind =1 | 
 smi_copd_ind =1 | comorb_11_0_1yr =1 | comorb_14_0_1yr =1 | smi_hiv_ind =1 | 
 smi_als_ind =1 | smi_hip_ind=1
 then ser_med_illness=1;
if smi_dem_ind =0 & smi_cancer_ind =0 & comorb_13_0_1yr =0 & smi_chf_ind =0 & 
 smi_copd_ind =0 & comorb_11_0_1yr =0 & comorb_14_0_1yr =0 & smi_hiv_ind =0 & 
 smi_als_ind =0 & smi_hip_ind=0
 then ser_med_illness=0;
label ser_med_illness="Any indicator of serious medical illness 1yr";

/*Indicator for any SNF stays 12m prior to interview or current nh res*/
if ind_snf_use_12m=1 | nhres=1 then smi_nh_ind=1;
if ind_snf_use_12m=0 & nhres=0 then smi_nh_ind=0;
label smi_nh_ind="Nursing home resident or an SNF claims 1yr";

/*indicator for adl helper*/
if adl_helper_count>0 & adl_helper_count~=. then smi_helper_ind=1;
if adl_helper_count=0 then smi_helper_ind=0;
label smi_helper_ind="Indicator of having any helpers with ADL, core";

/*backfill adl status if adl helper variable is complete*/
adl_ind_core_n = adl_independent_core;
if adl_independent_core=. and smi_helper_ind=1 then adl_ind_core_n=0;
if adl_independent_core=. and smi_helper_ind=0 then adl_ind_core_n=1;
label adl_ind_core_n = "ADL independent at core interview, using SR and helper file";

if adl_ind_core_n=1 then adl_impair_core = 0;
if adl_ind_core_n=0 then adl_impair_core = 1;
label adl_impair_core = "ADL impairment at core interview, using SR and helper file";

/*indicator for any ED visit, either OP or IP*/
if ind_ed_op_12m=1 | ind_ED_adm_12m=1 then ind_ed_op_or_ip_12m=1;
if ind_ed_op_12m=0 & ind_ED_adm_12m=0 then ind_ed_op_or_ip_12m=0;
label ind_ed_op_or_ip_12m="Indicator any ED use 12m pre ivw";

/*criteria (B) serious medical illness or ADL impairment AND nh res or urgent/emergent hosp*/
if (ser_med_illness=1 | adl_impair_core =1) & (ind_em_ur_adm_12m=1 | smi_nh_ind=1) then criteria_b=1;
if (ser_med_illness=0 & adl_impair_core =0) | (ind_em_ur_adm_12m=0 & smi_nh_ind=0) then criteria_b=0;
label criteria_b="SMI or ADL impair and hospital admit or nh use";

run;

 ods rtf body="E:\data\serious_ill\logs\criteria_vars_before_coredate.rtf";

title "Number of unique people in full cohort 2000-2010";
proc sql;
select count(distinct id) from sic_int.core_ids_1yr_criteria_5
where core_year in (2000,2002,2004,2006,2008,2010);

title "Unique R's w/ Age 65+";
select count(distinct id) from sic_int.core_ids_1yr_criteria_5
where age_ge_65=1 and core_year in (2000,2002,2004,2006,2008,2010);

title "Unique R's w/ Age 65+, With mc xwalk id";
select count(distinct id) from sic_int.core_ids_1yr_criteria_5
where age_ge_65=1 and xwalk_yes=1 and core_year in (2000,2002,2004,2006,2008,2010);

title "Unique R's w/ Age 65+, With mc xwalk id, and FFS 1yr pre-ivw";
select count(distinct id) from sic_int.core_ids_1yr_criteria_5
where age_ge_65=1 and xwalk_yes=1 and part_ab_12m=1 and hmo_d_12m=0 
and core_year in (2000,2002,2004,2006,2008,2010);

create table age_ge_65_mc as 
select * from sic_int.core_ids_1yr_criteria_5
where age_ge_65=1 and xwalk_yes=1 and part_ab_12m=1 and hmo_d_12m=0 
and core_year in (2000,2002,2004,2006,2008,2010);
quit;

title "Dementia - elix";
proc freq data=age_ge_65_mc ;
table smi_dem_ind /missprint;
run;

title "Cancer - elix, metastatic or hematologic cancer";
proc freq data=age_ge_65_mc ;
table smi_cancer_ind /missprint ;
run;

title "End Stage Renal Disease - elix, claims denominator file year of core ivw";
proc freq data=age_ge_65_mc ;
table comorb_13_0_1yr esrd_ind_n comorb_13_0_1yr*esrd_ind_n ind_hosp_adm_12m*esrd_ind_n smi_esrd_ind /missprint;
run;

title "CHF+Indicator of more advanced disease - elix + some utilization measure TBD!";
proc freq data=age_ge_65_mc ;
table smi_chf_ind chf_pri_dx chf_adm_dx /missprint;
run;

title "COPD, Either (1) ICD=9 code in any claim + DME claim for home O2 OR (2) COPD as primary dx in IP claim";
proc freq data=age_ge_65_mc ;
table smi_copd_ind /missprint;
run;

*data o2_no_copd;
*set age_ge_65_mc ;
*if smi_lung_02_ind =0 and home_oxygen =1;
*run;

*title "Among interviews with home O2 use but no COPD, check to see if these are CHF patients?";
*proc freq data=o2_no_copd;
*table  smi_chf_ind*home_oxygen /missprint;
*run;

title "Diabetes with severe complications (renal disease, ischemic hd or peripheral vascular disease)";
proc freq data=age_ge_65_mc ;
table smi_diab_compl_ind /missprint;
run;

title "Advanced liver disease/cirrhosis - elix";
proc freq data=age_ge_65_mc ;
table smi_liver_ind /missprint;
run;

title "HIV with and AIDS defining illness - elix";
proc freq data=age_ge_65_mc ;
table smi_hiv_ind /missprint;
run;

title "ALS - just single dx code ";
proc freq data=age_ge_65_mc ;
table smi_als_ind /missprint;
run;

title "Hip fracture, CC";
proc freq data=age_ge_65_mc ;
table smi_hip_ind /missprint;
run;

title "Multimorbidity, 2+serious medical illnesses as defined here";
proc freq data=age_ge_65_mc ;
table smi_count smi_ge2_ind /missprint;
run;

title "Any ADL help, HRS";
proc freq data=age_ge_65_mc ;
table adl_independent_core /missprint;
run;

title "Hospital admissions 6m, 12m before core interview";
proc freq data=age_ge_65_mc  ;
table ind_hosp_adm_6m*ind_em_ur_adm_6m ind_hosp_adm_12m*ind_em_ur_adm_12m 
ind_em_adm_12m*ind_ED_adm_12m ind_em_ur_adm_12m*ind_ED_adm_12m /missprint;
run;

title "Elective vs non elective hospital admissions, 12m before core";
proc freq data=age_ge_65_mc  ;
table ind_nonelect_adm_12m n_nonelect_adm_12m ind_elect_adm_12m n_elect_admit_12m /missprint;
run;

title "ED visit without subsequent admission from OP claims, 12m pre interview";
proc freq data=age_ge_65_mc  ;
table ind_ed_op_12m n_ed_op_visits_12m ind_ed_op_or_ip_12m/missprint;
run;

title "Nursing home use 12m before core interview or self report NH resident at interview";
proc freq data=age_ge_65_mc  ;
table ind_snf_use_12m nhres smi_nh_ind /missprint;
run;

title "Any helper with ADLs, core interview";
proc freq data=age_ge_65_mc  ;
table smi_helper_ind smi_helper_ind*adl_independent_core adl_impair_core /missprint;
run;

title "Number of R's that meet A)Any serious illness";
proc sql;
select count(distinct id) from age_ge_65_mc  
where ser_med_illness=1;

title "Number of R's that meet B)Any ADL help";
proc sql;
select count(distinct id) from age_ge_65_mc  
where adl_impair_core=1;

title "Number of R's that meet A) Serious medical illness or B)Any ADL help";
proc sql;
select count(distinct id) from age_ge_65_mc  
where (ser_med_illness=1 or adl_impair_core=1);

title "Number of R's that meet A) Serious medical illness or B)Any ADL help and NH use or Hospitalization";
proc sql;
select count(distinct id) from age_ge_65_mc  
where criteria_b=1;

title "Number of R's that meet C)Any urgent or emergent hospital admission 12m preceding core interview";
proc sql;
select count(distinct id) from age_ge_65_mc  
where ind_em_ur_adm_12m=1;

title "Number of R's that meet D)NH resident at interview or any SNF claim 12m pre interview";
proc sql;
select count(distinct id) from age_ge_65_mc  
where smi_nh_ind=1;

title "Number of R's that meet E)Any helper with ADLs core interview";
proc sql;
select count(distinct id) from age_ge_65_mc  
where smi_helper_ind=1;

title "Number of R's that meet A)Any serious illness + B)ADL help";
proc sql;
select count(distinct id) from age_ge_65_mc  
where (ser_med_illness=1 and adl_impair_core=1) ;

title "Number of R's that meet A)Any serious illness + C)Urgent or Emergency hospital admission";
proc sql;
select count(distinct id) from age_ge_65_mc  
where (ser_med_illness=1 and ind_em_ur_adm_12m=1) ;

ods rtf close; 

/*******************************************************************************/
/*17 observations where esrd flag in denominator file = 1 but no esrd comorbidity
what are these peoples diagnoses?*/
data esrd_check_1;
set age_ge_65_mc;
if esrd_ind_n=1 and comorb_13_0_1yr=0;
run;

proc freq data=esrd_check_1; table part_ab_12m hmo_d_12m; run;

proc sql;
create table esrd_check_2 as select a.* from 
dx_all_last_1yr a join
esrd_check_1 b
on a.bid_hrs_19=b.bid_hrs and a.core_year=b.core_year;
quit;

ods rtf body="E:\data\serious_ill\logs\check_esrd.rtf";
title "n=17 with esrd flag in denominator file but not from elixhauser comorb definition";
proc freq data=esrd_check_2 order=freq; table diag; run;
quit;
ods rtf close;

/*export full dataset to Stata*/
proc export data=sic_int.core_ids_1yr_criteria_5
outfile="E:\data\serious_ill\int_data\core_ids_1yr_criteria_5.dta" replace;
run;


H="Step 7 - Stata do file to get sample, criteria"
/*Stata do file to look at sample selection and serious illness cohort criteria*/

capture log close

clear all
set mem 500m
set more off

local logpath E:\data\serious_ill\logs
local datapath E:\data\serious_ill\int_data

log using "`logpath'\2-sic_initial_criteria.txt", text replace

cd `datapath'

use core_ids_1yr_criteria_5.dta
*******************************************************************
mat sample_set=J(6,1,.)

tab core_year, missing
sum core_year
mat sample_set[1,1]=r(N)

sum core_year if inlist(core_year,2000,2002,2004,2006,2008,2010)
mat sample_set[2,1]=r(N)

sum core_year if inlist(core_year,2000,2002,2004,2006,2008,2010) & age_ge_65==1
mat sample_set[3,1]=r(N)

sum core_year if inlist(core_year,2000,2002,2004,2006,2008,2010) & age_ge_65==1 & xwalk_yes==1
mat sample_set[4,1]=r(N)

sum core_year if inlist(core_year,2000,2002,2004,2006,2008,2010) & age_ge_65==1 & xwalk_yes==1 & ///
part_ab_12m==1 & hmo_d_12m==0
mat sample_set[5,1]=r(N)

//check if only require 6 month ffs pre interview, what changes??
sum core_year if inlist(core_year,2000,2002,2004,2006,2008,2010) & age_ge_65==1 & xwalk_yes==1 & ///
part_ab_6m==1 & hmo_d_6m==0
mat sample_set[6,1]=r(N)

mat rownames sample_set="Core interviews" "Core Interviews 2000-2010" "Age 65+" ///
"With xwalk id" "With FFS MC 1yr pre-ivw" "With FFS MC 6m pre-ivw"

mat colnames sample_set="Interviews"

mat list sample_set

frmttable using `logpath'\sic_Table1_sample, statmat(sample_set) ///
title("Serious illness cohort, sample criteria") ///
ctitle("","N Interviews") ///
sdec(0) replace

//drop interviews that don't meet above criteria
keep if inlist(core_year,2000,2002,2004,2006,2008,2010) & age_ge_65==1 & xwalk_yes==1 & ///
part_ab_12m==1 & hmo_d_12m==0

save core_ids_1yr_criteria_5_sample1.dta, replace

*******************************************************************
log close


H="Step 7a - Stata looking at criteria"
capture log close

clear all
set mem 500m
set more off

local logpath E:\data\serious_ill\logs
local datapath E:\data\serious_ill\int_data

log using "`logpath'\3-sic_initial_criteria_2.txt", text replace

cd `datapath'

use core_ids_1yr_criteria_5_sample1.dta

*******************************************************************
//look at criteria variables at the interview level

//create new temp variable for medical illness or adl impairment
gen byte smi_or_adl=.
replace smi_or_adl=1 if ser_med_illness==1 | adl_impair_core==1
replace smi_or_adl=0 if ser_med_illness==0 & adl_impair_core==0
tab smi_or_adl, missing

gen byte smi_or_adl_and_nh=.
replace smi_or_adl_and_nh=1 if smi_or_adl==1 & smi_nh_ind==1
replace smi_or_adl_and_nh=0 if smi_or_adl==0 | smi_nh_ind==0
tab smi_or_adl_and_nh, missing

gen byte smi_or_adl_and_hosp=.
replace smi_or_adl_and_hosp=1 if smi_or_adl==1 & ind_em_ur_adm_12m==1
replace smi_or_adl_and_hosp=0 if smi_or_adl==0 | ind_em_ur_adm_12m==0
tab smi_or_adl_and_hosp, missing

//serious medical illness variables
local smi_vars smi_dem_ind smi_cancer_ind smi_esrd_ind smi_chf_ind smi_copd_ind ///
smi_diab_compl_ind smi_liver_ind smi_hiv_ind smi_als_ind smi_hip_ind ///
ser_med_illness smi_ge2_ind adl_impair_core smi_or_adl smi_or_adl_and_nh ///
smi_or_adl_and_hosp criteria_b

mat criteria=J(18,2,.)

//overall n interviews
sum core_year
sca sample=r(N)
mat criteria[1,1]=r(N)

local j=2
foreach v in `smi_vars' {
tab `v',matcell(x_`j')
mat criteria[`j',1]=x_`j'[2,1]
mat criteria[`j',2]=x_`j'[2,1]/sample*100
local j = `j'+1
}

mat rownames criteria="Overall n interviews" "Dementia" "Cancer" "ESRD" "CHF" "COPD" "Diabetes" ///
"Liver disease" "HIV" "ALS" "Hip fracture" "Any serious medical illness" "2 or more SMI's" ///
"ADL Impairment" "Med Ill or ADL Impairment" "Med Ill or ADL Imp + SNF" ///
"Med Ill or ADL Imp + Hosp" "Med Ill or ADL Imp + SNF or Hosp"

mat list criteria

frmttable using `logpath'\sic_Table2_criteria, statmat(criteria) ///
title("Serious illness cohort, criteria") ///
ctitle("","N Interviews","% interviews") ///
sdec(0,2) replace


**********************************************************************************
//look at additional criteria
tab adl_impair_core, missing
tab ind_em_ur_adm_12m, missing
tab smi_nh_ind, missing

//look at combinations
tab ser_med_illness adl_impair_core, missing matcell(smi_adl)

frmttable using `logpath'\sic_Table2_criteria, statmat(smi_adl) ///
title("Serious illness cohort, serious medical condition vs ADL impairment") ///
ctitle("","ADL Impair, no" "ADL Impair, yes") ///
rtitle("Serious med ill, no" \ "Serious med ill, yes") ///
sdec(0) addtable

tab ser_med_illness ind_em_ur_adm_12m, missing
tab ser_med_illness smi_nh_ind, missing
tab adl_impair_core smi_nh_ind, missing  matcell(nh_adl)

frmttable using `logpath'\sic_Table2_criteria, statmat(nh_adl) ///
title("Serious illness cohort, nursing home use vs ADL impairment") ///
ctitle("","ADL Impair, no" "ADL Impair, yes") ///
rtitle("Nursing home use, no" \ "Nursing home use, yes") ///
sdec(0) addtable

**********************************************************************************
//look at SNF use vs adl use and hospitalization
//looking at self report nh use vs snf use from claims
//3 categories, (1) self report in nursing home at interview
//(2) nursing home use per claims
//(3) both SR in NH and SNF claims
mat nh_adl2=J(13,4,.)

//first row - overall n's
tab smi_nh_ind, matcell(crit)
mat nh_adl2[1,1]=crit[2,1]
tab nhres if ind_snf_use_12m==0, matcell(sr) //self report only, no claims
mat nh_adl2[1,2]=sr[2,1]
tab ind_snf_use_12m if nhres==0, matcell(cl) //claims only, no sr
mat nh_adl2[1,3]=cl[2,1]
tab nhres if ind_snf_use_12m==1, matcell(srcl) //self report and claims
mat nh_adl2[1,4]=srcl[2,1]

local r=2
foreach v of varlist adl_impair_core ind_em_ur_adm_12m ind_hosp_adm_12m{

tab `v' if smi_nh_ind==1, matcell(crit2)
mat nh_adl2[`r',1]=crit2[2,1]
mat nh_adl2[`r'+1,1]=(nh_adl2[`r',1])/(nh_adl2[1,1])*100
mat nh_adl2[`r'+2,1]=crit2[1,1]
mat nh_adl2[`r'+3,1]=(nh_adl2[`r'+2,1])/(nh_adl2[1,1])*100


tab `v' if nhres==1 & ind_snf_use_12m==0, matcell(sr2)
mat nh_adl2[`r',2]=sr2[2,1]
mat nh_adl2[`r'+1,2]=(nh_adl2[`r',2])/(nh_adl2[1,2])*100
mat nh_adl2[`r'+2,2]=sr2[1,1]
mat nh_adl2[`r'+3,2]=(nh_adl2[`r'+2,2])/(nh_adl2[1,2])*100


tab `v' if ind_snf_use_12m==1 & nhres==0, matcell(cl2)
mat nh_adl2[`r',3]=cl2[2,1]
mat nh_adl2[`r'+1,3]=(nh_adl2[`r',3])/(nh_adl2[1,3])*100
mat nh_adl2[`r'+2,3]=cl2[1,1]
mat nh_adl2[`r'+3,3]=(nh_adl2[`r'+2,3])/(nh_adl2[1,3])*100


tab `v' if ind_snf_use_12m==1 & nhres==1, matcell(srcl2)
mat nh_adl2[`r',4]=srcl2[2,1]
mat nh_adl2[`r'+1,4]=(nh_adl2[`r',4])/(nh_adl2[1,4])*100
mat nh_adl2[`r'+2,4]=srcl2[1,1]
mat nh_adl2[`r'+3,4]=(nh_adl2[`r'+2,4])/(nh_adl2[1,4])*100

local r = `r'+4
}


frmttable using `logpath'\sic_Table2_criteria, statmat(nh_adl2) ///
title("Serious illness cohort, nursing home criteria vs ADL impairment") ///
ctitle("","SR and/or Claims" "Self report NH use only" "SNF Claims only" "SR and Claims") ///
rtitle("N" \ "ADL Impairment, n" \ "Percent" \ "ADL Independent, n" \ "Percent" \ ///
"Urgent or Emergency Hospital Admit, n" \ "Percent" \ "No, n" \ "Percent" \ ///
"Any Hospital Admit, n" \ "Percent" \ "No, n" \ "Percent" ) ///
sdec(0 \ 0 \ 2 \ 0 \ 2 \ 0 \ 2 \ 0 \ 2 \ 0 \ 2 \ 0 \ 2) addtable

tab criteria_b, missing

**********************************************************************************

//collapse dataset to look at unique R's that meet each of the criteria
collapse core_year `smi_vars' smi_nh_ind ,by(id)

mat criteria_r=J(16,2,.)

sum core_year
sca sample_r=r(N)
mat criteria_r[1,1]=r(N)

local j=2
foreach v in `smi_vars' {
replace `v'=1 if `v'>0 & `v'!=.
tab `v',matcell(x1_`j')
mat criteria_r[`j',1]=x1_`j'[2,1]
mat criteria_r[`j',2]=x1_`j'[2,1]/sample_r*100
local j = `j'+1
}

mat rownames criteria_r="Overall n R's" "Dementia" "Cancer" "ESRD" "CHF" "COPD" "Diabetes" ///
"Liver disease" "HIV" "ALS" "Hip fracture" "Any serious medical illness" "2 or more SMI's" ///
"ADL Impairment" "Med Ill or ADL Impairment" "Med Ill or ADL Imp + SNF or Hosp"

mat list criteria_r

frmttable using `logpath'\sic_Table2_criteria, statmat(criteria_r) ///
title("Serious illness cohort, criteria, respondent level") ///
ctitle("","N Respondents","% respondents") ///
sdec(0,2) addtable

log close


H="Step 8a - Determine outcomes after meet criteria"
/*While still determining criteria, create variables looking at the 1 year
after interview for all interviews (regardless of when meet criteria)

Outcomes are:
1. Urgent or emergency hospital admissions 1 year after meet critera
2. Hospice enrollment 1 year after meet criteria
3. Total Medicare payments 1 year after meet criteria
*/

/*proc printto new log='&logdir.\sas_11_sic_outcomes_log.log'
	print='&logdir.\sas_11_sic_outcomes_out.lst' 
run;*/

/*ids of those interviews with ffs medicare year preceding interview and 65+*/
proc sql;
create table age_ge_65_mc as 
select * from sic_int.core_ids_1yr_criteria_5
where age_ge_65=1 and xwalk_yes=1 and part_ab_12m=1 and hmo_d_12m=0 
and core_year in (2000,2002,2004,2006,2008,2010);
quit;

proc freq; table core_to_dod_1yr; run;

/**********************************************************************/
/**********************************************************************/
*get claims 1 year after interview, all claim types;
/**********************************************************************/
/**********************************************************************/
/*medpar claims
List of claims with some time within 1 year of interview*/
%macro mp(days_start=,days_after_core=,source=,time_label=);

proc sql;
create table &source._meet_post as select a.*,b.c_ivw_date,b.core_year
from medi.&source._2000_2010 a inner join
age_ge_65_mc b
on trim(left(a.bid_hrs_19))=trim(left(b.bid_hrs))
and &days_start<=a.disch_date-b.c_ivw_date<=&days_after_core;
quit;

proc sql;
create table &source._meet2_post as select a.*,b.c_ivw_date,b.core_year
from medi.&source._2000_2010 a inner join
age_ge_65_mc b
on trim(left(a.bid_hrs_19))=trim(left(b.bid_hrs))
and a.disch_date-b.c_ivw_date>&days_after_core and a.admit_date-b.c_ivw_date<=&days_after_core;
quit;

data sic_int.&source._meet3_post_&days_after_core.;
set &source._meet_post &source._meet2_post;
format admit_date date9. disch_date date9.;
run;

%mend;

/*otherclaims, Just keep payment info to limit size of dataset
Pull list of any claims with admission date within 1 year of the interview*/
%macro other(days_start=,days_after_core=,source= );

proc sql;
create table sic_int.&source._meet_post_&days_after_core. as select 
a.*,b.c_ivw_date,b.core_year
from medi.&source._2000_2010(keep=admit_date BID_hrs_19 pmt_amt) a inner join
age_ge_65_mc b
on trim(left(a.bid_hrs_19))=trim(left(b.bid_hrs))
and &days_start<=a.admit_date-b.c_ivw_date<=&days_after_core;
quit;

%mend;


%mp(days_start=0,days_after_core=365,source=mp );
%other(days_start=0,days_after_core=365,source=op );
%other(days_start=0,days_after_core=365,source=pb );
%other(days_start=0,days_after_core=365,source=hh );
%other(days_start=0,days_after_core=365,source=hs );
%other(days_start=0,days_after_core=365,source=dm );

/**********************************************************************/
/**********************************************************************/
/*Count of hospital admissions 1 year after interview
Use suffix p12m to indicate post interview*/
/**********************************************************************/
/**********************************************************************/
%macro admissions(days=,suffix=);
/*pull list of ip claims from all medpar claims x days after interview*/
data ip_meet_post_&days.;
set sic_int.mp_meet3_post_&days.(where=(trim(left(SSLSSNF))~="N"));
*if admit_date>=c_ivw_date;
run;

data ip_post_&days._2;
set ip_meet_post_&days.;
em_urgent_admit=0; /*Urgent , emergent admissions from admission type*/
if type_adm in (1,2) then em_urgent_admit=1;
em_admit=0;
if type_adm=1 then em_admit=1;
urgent_admit=0;
if type_adm=2 then urgent_admit=1;
elect_admit=0;
if type_adm=3 then elect_admit=1;
ind_ed_charge=0; /*ED charges as another indicator of ED use*/
if ER_AMT>0 & ER_AMT~=. then ind_ed_charge=1;
if ER_AMT=0 | ER_AMT=. then ind_ed_charge=0;

*truncate admit and discharge dates to get all days within the window;
admit_trunc=0;
disch_trunc=0;
if admit_date<c_ivw_date then do;
	admit_date=c_ivw_date;
	admit_trunc=1;
end;
if disch_date-c_ivw_date>&days. then do;
	disch_date=c_ivw_date+&days.;
	disch_trunc=1;
end;
adj_los=disch_date-admit_date;
if disch_date-admit_date=0 then adj_los=1;
run;

proc sort data=ip_post_&days._2;
by BID_hrs_19 core_year;
run;

proc sql;
create table ip_post_&days._3 as select distinct BID_hrs_19,core_year,
/*count of IP admissions, all types*/
count(*) as n_ip_admit_&suffix. label="total n of hospital admit &suffix. after core ivw",
/*count of nights in hospital*/
sum(adj_los) as n_hospd_&suffix. label="total n of hospital nights &suffix. after core ivw",
/*count urgent or emergency admissions*/
count(case when em_urgent_admit=1 then em_urgent_admit else . end) as n_em_urgent_admit_&suffix. 
	label="total n of urgent/emergent hospital admit &suffix. after core ivw",
/*count of emergency admissions, from admission type code*/
count(case when em_admit=1 then em_admit else . end) as n_em_admit_&suffix. 
	label="total n of emergent hospital admit &suffix. after core ivw",
/*count of urgent admissions, from admission type code*/
count(case when urgent_admit=1 then urgent_admit else . end) as n_urgent_admit_&suffix. 
	label="total n of urgent hospital admit &suffix. after core ivw",
/*count of elective admissions, from admission type code*/
count(case when elect_admit=1 then elect_admit else . end) as n_elect_admit_&suffix. 
	label="total n of elective hospital admit &suffix. after core ivw",
/*count of admissions with any ED charges*/
count(case when ind_ed_charge=1 then ind_ed_charge else . end) as n_ED_ip_&suffix. 
	label="total n of ED visits with subsequent admit &suffix. after core ivw",
sum(admit_trunc) as adm_trunc_ind_&suffix.
	label="admit before interview indicator, counted as both pre and post admit"

 from ip_post_&days._2 group by BID_hrs_19,core_year;
quit;

data ip_post_&days._4;
set ip_post_&days._3;
if adm_trunc_ind_&suffix.>1 then adm_trunc_ind_&suffix.=1;
run;

%mend;

%admissions(days=365,suffix=p12m);

proc sql;
create table core_ids_admit_post_1 as select a.*,
b.n_ip_admit_p12m,b.adm_trunc_ind_p12m,b.n_hospd_p12m,
b.n_em_urgent_admit_p12m,b.n_em_admit_p12m,
b.n_urgent_admit_p12m,b.n_elect_admit_p12m,b.n_ED_ip_p12m
from age_ge_65_mc a
left join
ip_post_365_4 b 
on trim(left(a.bid_hrs))=trim(left(b.bid_hrs_19)) and a.core_year=b.core_year;
quit;

/*Since set comorbidities = 0 if no dx but have ffs mc 1 year preceeding the
core interview, can use comorb = ., same as ffs mc 1 year=no*/
 data core_ids_admit_post_2;
 set core_ids_admit_post_1;
 array list 
	n_ip_admit_p12m n_hospd_p12m n_em_urgent_admit_p12m
	n_em_admit_p12m n_urgent_admit_p12m n_elect_admit_p12m n_ED_ip_p12m;
 do over list;
 if list=. & comorb_1_0_1yr~=. then list=0;
 end;

 if n_ip_admit_p12m=0 then ind_hosp_adm_p12m=0;
 if n_ip_admit_p12m>0 & n_ip_admit_p12m~=. then ind_hosp_adm_p12m=1;
 label ind_hosp_adm_p12m="Indicator for any hospital admission 12m after core";

 if n_em_urgent_admit_p12m=0 then ind_em_ur_adm_p12m=0;
 if n_em_urgent_admit_p12m>0 & n_em_urgent_admit_p12m~=. then ind_em_ur_adm_p12m=1;
 label ind_em_ur_adm_p12m="Ind any urgent or emergent hospital admission 12m after core";

 if n_em_admit_p12m=0 then ind_em_adm_p12m=0;
 if n_em_admit_p12m>0 & n_em_admit_p12m~=. then ind_em_adm_p12m=1;
 label ind_em_adm_p12m="Ind any emergency hospital admission 12m after core";

 if n_urgent_admit_p12m=0 then ind_ur_adm_p12m=0;
 if n_urgent_admit_p12m>0 & n_urgent_admit_p12m~=. then ind_ur_adm_p12m=1;
 label ind_ur_adm_p12m="Ind any urgent hospital admission 12m after core";

 if n_elect_admit_p12m =0 then ind_elect_adm_p12m=0;
 if n_elect_admit_p12m >0 & n_elect_admit_p12m ~=. then ind_elect_adm_p12m=1;
 label ind_elect_adm_p12m="Ind any elective hospital admission 12m after core";

 if (n_ip_admit_p12m - n_elect_admit_p12m)=0 then ind_nonelect_adm_p12m=0;
 if (n_ip_admit_p12m - n_elect_admit_p12m)>0 & n_elect_admit_p12m~=. then ind_nonelect_adm_p12m=1;
 label ind_nonelect_adm_p12m="Ind any non-elective hospital admission 12m after core";

 n_nonelect_adm_p12m=(n_ip_admit_p12m - n_elect_admit_p12m);
 label n_nonelect_adm_p12m="total n non-elective ip admit 12m after core";

 if n_ED_ip_p12m=0 then ind_ED_adm_p12m=0;
 if n_ED_ip_p12m>0 & n_ED_ip_p12m~=. then ind_ED_adm_p12m=1;
 label ind_ED_adm_p12m="Ind ED use with hospital admission 12m after core, from charges";

run;

proc freq;
table n_ip_admit_p12m adm_trunc_ind_p12m n_hospd_p12m ind_hosp_adm_p12m n_em_urgent_admit_p12m ind_em_ur_adm_p12m
	ind_em_adm_p12m ind_ur_adm_p12m ind_nonelect_adm_p12m n_nonelect_adm_p12m n_ED_ip_p12m ind_ED_adm_p12m 
	ind_em_adm_p12m*ind_ED_adm_p12m /missprint;
run;

/**********************************************************************/
/**********************************************************************/
/*Indicator of any hospice enrollment after interview
Use suffix p12m to indicate post interview*/
/**********************************************************************/
/**********************************************************************/
/*check of hospice claim list*/
data hospice_check;
set sic_int.hs_meet_post_365;
ivw_to_admit=admit_date-c_ivw_date;
run;
proc means; var ivw_to_admit;run;

%macro hospice(days=,suffix=);

proc sort data=sic_int.hs_meet_post_&days.;
by bid_hrs_19;
run;

/*just keep 1 claim per beneficiary since only need indicator of hospice use*/
data hs_meet_post_2_&days.;
set sic_int.hs_meet_post_&days.;
by bid_hrs_19;
if first.bid_hrs_19;
hs_admit_&suffix.=1;
label hs_admit_&suffix.="Hospice admission &suffix. after interview";
run;

%mend;

%hospice(days=365,suffix=p12m);

*merge hospice indicator with full dataset;
proc sql;
create table core_ids_admit_hs_post_2 as select a.*,b.hs_admit_p12m from
core_ids_admit_post_2 a left join
hs_meet_post_2_365 b
on trim(left(a.bid_hrs))=trim(left(b.bid_hrs_19)) and a.core_year=b.core_year;
quit;

proc freq; table hs_admit_p12m; run;

/*replace with 0 when have full info but no hospice claims
core interview, can use comorb = ., same as ffs mc 1 year=no*/
data core_ids_admit_hs_post_3 ;
set core_ids_admit_hs_post_2 ;
if hs_admit_p12m=. & comorb_1_0_1yr~=. then hs_admit_p12m=0;
run;
proc freq; table hs_admit_p12m; run;


data sic_int.core_ids_init_outcomes;
set core_ids_admit_hs_post_3 ;
run;

proc contents; run;

proc freq; table core_year; run;



H="Step 8b - Get Medicare payments 1 year after interview"
/*Add total Medicare payments from claims 1 year after interview*/

/*Claims files from 2000-2010, claims pulled in previous section
to get just claims that are within 1 year of the interview dates*/

/**********************************************************/
/**********************************************************/
/*totals from mp file*/
/*Note: variable SSLSSNF from mp claims is N=Skilled nursing facility*/
/*Two totals are calculated - one for skilled nursing facility claims
and one for all other claims in the mp file (inpatient claims)*/
/**********************************************************/
/**********************************************************/

/*get count of snf vs ip claims from claim list */
data snf_all;
set sic_int.mp_meet3_post_365(where=(trim(left(SSLSSNF))="N")) ;
ivw_to_admit=admit_date-c_ivw_date;
ivw_to_disch=disch_date-c_ivw_date;
run;

proc means; var ivw_to_admit ivw_to_disch; run;

data ip_all;
set sic_int.mp_meet3_post_365(where=(trim(left(SSLSSNF))~="N")) ;
run;


%macro mp(month_n=,days_start=,days_after_core=,source=,equ=,name=);
%let source0=mp;

/*Case 1 - no adjustment needed - claims where entire claim is within the x months after the interview*/
proc sql;
create table &source._meet_post_1 as select *
from sic_int.&source0._meet3_post_&days_after_core.(where=(trim(left(SSLSSNF))&equ.="N")) 
where &days_start<=disch_date-c_ivw_date<=&days_after_core and
&days_start<=admit_date-c_ivw_date<=&days_after_core;
quit;

data zz_&source._meet_post_1;
set &source._meet_post_1;
ivw_to_admit=admit_date-c_ivw_date;
ivw_to_disch=disch_date-c_ivw_date;
run;
proc means; var ivw_to_admit ivw_to_disch; run;

/*Case 2 - adjustment needed because part of stay is in the window but part is after the window has ended
Claims with admission date within start of x months but discharge date is after the x month window*/
proc sql;
create table &source._meet2_post as select *
from sic_int.&source0._meet3_post_&days_after_core.(where=(trim(left(SSLSSNF))&equ.="N")) 
where disch_date-c_ivw_date>&days_after_core and 0<=admit_date-c_ivw_date<=&days_after_core;
quit;

data zz_&source._meet2_post;
set &source._meet2_post;
ivw_to_admit=admit_date-c_ivw_date;
ivw_to_disch=disch_date-c_ivw_date;
run;
proc means; var ivw_to_admit ivw_to_disch; run;


/*identify fraction of claims that span x month period that should be 
attributed to the x month period
by just using the fraction of time that was included in the span*/
data &source._meet3_post;
set &source._meet2_post;
pct_xm=((c_ivw_date+&days_after_core)-admit_date)/(disch_date-admit_date);
array list pmt_amt passthru;
do over list;
if list=. then list=0;
/*scale the partial claims by the time within the x month period*/
list=list*pct_xm;
end;

run;

/*Case 3 - adjustment needed because part of stay is in the window but part is before the window started
Claims with discharge date within start of x months but admit date is before the interview date*/
proc sql;
create table &source._meet4_post as select *
from sic_int.&source0._meet3_post_&days_after_core.(where=(trim(left(SSLSSNF))&equ.="N")) 
where disch_date-c_ivw_date<=&days_after_core and admit_date-c_ivw_date<&days_start;
quit;

data zz_&source._meet4_post;
set &source._meet4_post;
ivw_to_admit=admit_date-c_ivw_date;
ivw_to_disch=disch_date-c_ivw_date;
run;
proc means; var ivw_to_admit ivw_to_disch; run;


data &source._meet5_post;
set &source._meet4_post;
pct_xm=(disch_date-c_ivw_date)/(disch_date-admit_date);
array list pmt_amt passthru;
do over list;
if list=. then list=0;
/*scale the partial claims by the time within the x month period*/
list=list*pct_xm;
end;

run;

/*adjust for inflation, Uses CPI for Medical Services from 
BLS website, accessed 3/14/2014*/

/*create table merging both the claims fully in the 2 year period 
and those partially in that time
adjust for inflation here also*/
data &source._cost_post;
set &source._meet_post_1 &source._meet3_post &source._meet5_post;
array list pmt_amt passthru;
do over list;
if list=. then list=0;
end;

if year(admit_date)>=2010 then rate=1;
if year(admit_date)=2009 then rate=1.0350;
if year(admit_date)=2008 then rate=1.06823;
if year(admit_date)=2007 then rate=1.11347;
if year(admit_date)=2006 then rate=1.17287;
if year(admit_date)=2005 then rate=1.22119;
if year(admit_date)=2004 then rate=1.27983;
if year(admit_date)=2003 then rate=1.34381;
if year(admit_date)=2002 then rate=1.40392;
if year(admit_date)=2001 then rate=1.47492;
if year(admit_date)=2000 then rate=1.54589;
if year(admit_date)<=1999 then rate=1.61195;


&source._paid_by_mc=rate*(pmt_amt+passthru);
run;

*calculates total of mc charges for the claim type by hrs bid;
proc sql;
create table &source._pay_post as select distinct bid_hrs_19,core_year,
sum(&source._paid_by_mc) as &source._paid_by_mc 
from &source._cost_post group by BID_HRS_19,core_year;
quit;

*merges the totals above with the full interview list;
proc sql;
create table &source._&name. as select
a.BID_hrs,a.id,a.core_year,coalesce(b.&source._paid_by_mc,0) as &source._paid_by_mc_&name.
from sic_int.core_ids_init_outcomes a
left join
 &source._pay_post b
 on trim(left(a.BID_hrs))=trim(left(b.bid_hrs_19)) and a.core_year=b.core_year;
 quit;

 proc sort data=&source._&name. ;
 by BID_hrs core_year;
 run;
%mend;

/*Runs macro to get total for the SNF claims*/
%mp(days_start=0,days_after_core=365,source=snf,equ=,name=1yr );
/*Runs macro to get total for the inpatient (not SNF) claims*/
%mp(days_start=0,days_after_core=365,source=ip,equ=~,name=1yr );

/**********************************************************/
/**********************************************************/
/*totals from other claim types*/
/**********************************************************/
/**********************************************************/
/*macro to calculate totals for the claims that are not in medpar files*/
%macro all_other(source=,month_n=,days_start=,days_after_core=);

/*Adjust for inflation*/
data &source._meet2_post;
set sic_int.&source._meet_post_&days_after_core.;
/*adjust to 2010 dollars*/
if year(admit_date)>=2010 then rate=1;
if year(admit_date)=2009 then rate=1.0350;
if year(admit_date)=2008 then rate=1.06823;
if year(admit_date)=2007 then rate=1.11347;
if year(admit_date)=2006 then rate=1.17287;
if year(admit_date)=2005 then rate=1.22119;
if year(admit_date)=2004 then rate=1.27983;
if year(admit_date)=2003 then rate=1.34381;
if year(admit_date)=2002 then rate=1.40392;
if year(admit_date)=2001 then rate=1.47492;
if year(admit_date)=2000 then rate=1.54589;
if year(admit_date)<=1999 then rate=1.61195;

&source._paid_by_mc=rate*(pmt_amt);
run;

/*Calculate total mc payments by ID*/
proc sql;
create table &source._pay_post as select distinct BID_hrs_19,core_year,
sum(&source._paid_by_mc) as &source._paid_by_mc
from &source._meet2_post group by BID_hrs_19,core_year;
quit;

/*merge in mc totals with interview list*/
proc sql;
create table &source.&month_n._post as select
a.BID_hrs,a.id,a.core_year,coalesce(b.&source._paid_by_mc,0) as &source._paid_by_mc&month_n 
from sic_int.core_ids_init_outcomes a
left join
 &source._pay_post b
 on trim(left(a.BID_hrs))=trim(left(b.BID_hrs_19)) and a.core_year=b.core_year;
 quit;

 proc sort data=&source&month_n._post ;
 by BID_hrs core_year;
 run;
 %mend all_other;

/******************************************************************/
/* Run the macro over the mc claims files for 2 years prior to death*/
/******************************************************************/

 %all_other(source=op,month_n=_1yr,days_start=0,days_after_core=365);
  %all_other(source=pb,month_n=_1yr,days_start=0,days_after_core=365);
   %all_other(source=hh,month_n=_1yr,days_start=0,days_after_core=365);
    %all_other(source=hs,month_n=_1yr,days_start=0,days_after_core=365);
     %all_other(source=dm,month_n=_1yr,days_start=0,days_after_core=365);

/******************************************************************/
/* Get totals across all claim types */
/******************************************************************/

*first merge into single dataset;
data mc_costs_all;
merge ip_1yr snf_1yr hh_1yr_post hs_1yr_post pb_1yr_post op_1yr_post dm_1yr_post;
by BID_hrs core_year;
run;

data sic_int.mc_costs_1yr;
set mc_costs_all;
/*total not adjusted for wage index*/
tot_paid_by_mc_1yr=sum(of ip_paid_by_mc_1yr snf_paid_by_mc_1yr hh_paid_by_mc_1yr hs_paid_by_mc_1yr
pb_paid_by_mc_1yr op_paid_by_mc_1yr dm_paid_by_mc_1yr);
label tot_paid_by_mc_1yr="Medicare payment total 1 year following interview"
ip_paid_by_mc_1yr="IP Medicare payments 1 year following interview" 
snf_paid_by_mc_1yr="SNF Medicare payments 1 year following interview"
hh_paid_by_mc_1yr="Home health Medicare payments 1 year following interview" 
hs_paid_by_mc_1yr="Hospice Medicare payments 1 year following interview"
pb_paid_by_mc_1yr="Carrier Medicare payments 1 year following interview" 
op_paid_by_mc_1yr="OP Medicare payments 1 year following interview" 
dm_paid_by_mc_1yr="DME Medicare payments 1 year following interview"
;
run;

proc sort data=sic_int.core_ids_init_outcomes; by bid_hrs core_year; run;
proc sort data=sic_int.mc_costs_1yr; by bid_hrs core_year; run;


*merge into overall dataset*;
proc sql;
create table sic_int.core_ids_init_outcomes_2(drop=bid_hrs2 id2 core_year2) as select * from
sic_int.core_ids_init_outcomes a left join
sic_int.mc_costs_1yr(rename=(bid_hrs=bid_hrs2) rename=(id=id2) rename=(core_year=core_year2)) b
on trim(left(a.bid_hrs))=trim(left(b.bid_hrs2)) and a.core_year=b.core_year2;
quit;

proc means; 
var ip_paid_by_mc_1yr snf_paid_by_mc_1yr hh_paid_by_mc_1yr hs_paid_by_mc_1yr
pb_paid_by_mc_1yr op_paid_by_mc_1yr dm_paid_by_mc_1yr tot_paid_by_mc_1yr;
run;




H="Step 9 - Identify interview where criteria is first met"
/*create variable that identifies first interview that the criteria is met
2 criteria used:
A) Any serious medical illness
B) Serious medical illness or ADL impairment AND either Urgent/Emerg hopspital admission
or nursing home use

Creates file with outcomes as well*/

/*proc printto new log='&logdir.\sas_12_sic_n0_log.log'
	print='&logdir.\sas_12_sic_n0_out.lst' 
run;*/

data ivw_meet_a;
set sic_int.core_ids_init_outcomes_2(keep=id ser_med_illness core_year) ;
if ser_med_illness=1;
run;

proc sort data=ivw_meet_a;
by id core_year;
run;

data ivw_meet_a_1;
set ivw_meet_a;
by id;
if first.id then ivw_meet_crit_a=1;
else ivw_meet_crit_a=0;
label ivw_meet_crit_a="Ind. 1st time meets Criteria A";
run;

proc freq; table ivw_meet_crit_a;
run;

data ivw_meet_b;
set sic_int.core_ids_init_outcomes_2(keep=id criteria_b core_year) ;
if criteria_b=1;
run;

proc sort data=ivw_meet_b;
by id core_year;
run;

data ivw_meet_b_1;
set ivw_meet_b;
by id;
if first.id then ivw_meet_crit_b=1;
else ivw_meet_crit_b=0;
label ivw_meet_crit_b="Ind. 1st time meets Criteria B";
run;

proc freq; table ivw_meet_crit_b;
run;

data crit_ab;
merge ivw_meet_a_1 ivw_meet_b_1;
by id core_year;
run;


/*merge in new variables with the overall dataset*/
proc sort data=sic_int.core_ids_init_outcomes_2 out=ivw_to_merge nodupkey; by id core_year; run;

proc sql;
create table ivws_crit as select a.*,b.ivw_meet_crit_a,b.ivw_meet_crit_b from
ivw_to_merge a left join
crit_ab b
on a.id=b.id and a.core_year=b.core_year;
quit;

data sic_int.ivws_crit_1;
set ivws_crit;
array list ivw_meet_crit_a ivw_meet_crit_b ;
do over list;
if list=. & comorb_1_0_1yr~=. then list=0;
end;
run;

/*should be 4394 and 2956*/
proc freq;
table ivw_meet_crit_a ivw_meet_crit_b;
run;

/*initial look at outcomes from claims data*/

/*for Criteria A*/
data criteria_a;
set sic_int.ivws_crit_1;
if ivw_meet_crit_a=1;
run;

/*for Criteria B*/
data criteria_b;
set sic_int.ivws_crit_1;
if ivw_meet_crit_b=1;
run;

ods rtf body="E:\data\serious_ill\logs\outcomes_first_look.rtf";
title "Outcomes 1 year after initially meeting criteria A) Any serious medical illness";
proc freq data=criteria_a;
table core_to_dod_1yr hs_admit_p12m ind_em_ur_adm_p12m;
run;
proc means data=criteria_a; 
vars ip_paid_by_mc_1yr snf_paid_by_mc_1yr hh_paid_by_mc_1yr hs_paid_by_mc_1yr
pb_paid_by_mc_1yr op_paid_by_mc_1yr dm_paid_by_mc_1yr tot_paid_by_mc_1yr n_hospd_p12m; run;

title "Outcomes 1 year after initially meeting criteria B) Any ser med illness or ADL Impair + SNF or Hospital.";
proc freq data=criteria_b;
table core_to_dod_1yr hs_admit_p12m ind_em_ur_adm_p12m;
run;
proc means; 
vars ip_paid_by_mc_1yr snf_paid_by_mc_1yr hh_paid_by_mc_1yr hs_paid_by_mc_1yr
pb_paid_by_mc_1yr op_paid_by_mc_1yr dm_paid_by_mc_1yr tot_paid_by_mc_1yr n_hospd_p12m; run;


ods rtf close;

/*export full dataset to Stata*/
proc export data=sic_int.ivws_crit_1
outfile="E:\data\serious_ill\int_data\ivws_crit_1.dta" replace;
run;


H="Looking at outcomes"
capture log close

clear all
set mem 500m
set more off

local logpath E:\data\serious_ill\logs
local datapath E:\data\serious_ill\int_data

log using "`logpath'\4-sic_initial_outcomes_1.txt", text replace

cd `datapath'

//use dataset with outcomes, just obs that meet interview sample inclusion criteria
use ivws_crit_1.dta if inlist(core_year,2000,2002,2004,2006,2008,2010) & /// 
age_ge_65==1 & xwalk_yes==1 & part_ab_12m==1 & hmo_d_12m==0
*******************************************************************

sum core_year

//categorical variable for serious illness vs adl impairment
gen cat_smi_adl=.
replace cat_smi_adl=1 if ser_med_illness==0 & adl_impair_core==0
replace cat_smi_adl=2 if ser_med_illness==1 & adl_impair_core==0
replace cat_smi_adl=3 if ser_med_illness==0 & adl_impair_core==1
replace cat_smi_adl=4 if ser_med_illness==1 & adl_impair_core==1
la var cat_smi_adl "Serious illness and/or adl impariment, categorical"
la def cat_smi_adl 1 "No serious illness or adl impairment" ///
2 "Serious medical illness but no adl impair" 3 "ADL impairment, no serious medical ill" ///
4 "Serious medical illness and adl impairment"
la val cat_smi_adl cat_smi_adl
tab cat_smi_adl core_year
tab cat_smi_adl ser_med_illness
tab cat_smi_adl adl_impair_core

//table of outcomes, interview level (so R may be represented 5x)
local outcome1 core_to_dod_1yr hs_admit_p12m ind_em_ur_adm_p12m

local outcome2 ip_paid_by_mc_1yr snf_paid_by_mc_1yr hh_paid_by_mc_1yr hs_paid_by_mc_1yr ///
pb_paid_by_mc_1yr op_paid_by_mc_1yr dm_paid_by_mc_1yr tot_paid_by_mc_1yr n_hospd_p12m

mat table1=J(34,4,.)
//first row, n for each category
tab cat_smi_adl,matcell(row1)
mat table1[1,1]=row1[1,1]
mat table1[1,2]=row1[2,1]
mat table1[1,3]=row1[3,1]
mat table1[1,4]=row1[4,1]

forvalues i=1/4{
local r=2
foreach v in `outcome1'{
	sum `v' if cat_smi_adl==`i', detail
	mat table1[`r',`i']=r(mean)
	mat table1[`r'+1,`i']=r(sd)
	local r=`r'+2 //populates rows 2-7 for indicator variable outcomes
	}

local r=8
foreach v in `outcome2'{
	sum `v' if cat_smi_adl==`i', detail
	mat table1[`r',`i']=r(mean)
	mat table1[`r'+1,`i']=r(p50)
	mat table1[`r'+2,`i']=r(sd)
	local r=`r'+3 //populates rows 8-34 for continuous variables
	}
}

mat rownames table1="N" "Died, mean" "SD" "Hospice enr, mean" "SD" "Emerg or urgent hosp admit, mean" "SD" ///
"IP Medicaid payments, mean" "Median" "SD" "SNF Medicaid payments, mean" "Median" "SD" ///
"HH Medicaid payments, mean" "Median" "SD" "Hospice Medicaid payments, mean" "Median" "SD" ///
"Carrier Medicaid payments, mean" "Median" "SD" "OP Medicaid payments, mean" "Median" "SD" ///
"DME Medicaid payments, mean" "Median" "SD" "Total Medicaid payments, mean" "Median" "SD" ///
"Hospital nights, mean" "Median" "SD"

mat colnames table1="No ser med ill or impair" "Ser Med Ill" "ADL Impair" "SMI and ADL Impair"

frmttable using "`logpath'\sic_Table3_outcomes", statmat(table1) ///
title("Comparison of outcomes at 1 year, serious medical illness vs ADL impairment" \ ///
"Interview level") sdec(0\2\2\2\2\2\2\0) landscape replace

*******************************************************************
//Outcomes for first interview where meet criteria
*******************************************************************
mat table2=J(34,2,.)
//first row, n for each category
tab ivw_meet_crit_a ,matcell(row1a)
mat table2[1,1]=row1a[2,1]
tab ivw_meet_crit_b ,matcell(row1b)
mat table2[1,2]=row1b[2,1]

local c=1
foreach crit of varlist ivw_meet_crit_a ivw_meet_crit_b {
local r=2
foreach v in `outcome1'{
	sum `v' if `crit'==1, detail
	mat table2[`r',`c']=r(mean)
	mat table2[`r'+1,`c']=r(sd)
	local r=`r'+2 //populates rows 2-7 for indicator variable outcomes
	}

local r=8
foreach v in `outcome2'{
	sum `v' if `crit'==1, detail
	mat table2[`r',`c']=r(mean)
	mat table2[`r'+1,`c']=r(p50)
	mat table2[`r'+2,`c']=r(sd)
	local r=`r'+3 //populates rows 8-34 for continuous variables
	}
local c=`c'+1	
}

mat rownames table2="N" "Died, mean" "SD" "Hospice enr, mean" "SD" "Emerg or urgent hosp admit, mean" "SD" ///
"IP Medicaid payments, mean" "Median" "SD" "SNF Medicaid payments, mean" "Median" "SD" ///
"HH Medicaid payments, mean" "Median" "SD" "Hospice Medicaid payments, mean" "Median" "SD" ///
"Carrier Medicaid payments, mean" "Median" "SD" "OP Medicaid payments, mean" "Median" "SD" ///
"DME Medicaid payments, mean" "Median" "SD" "Total Medicaid payments, mean" "Median" "SD" ///
"Hospital nights, mean" "Median" "SD"

frmttable using "`logpath'\sic_Table3_outcomes_ivw", statmat(table2) ///
title("Comparison of outcomes at 1 year, criteria a vs b" \ ///
"First interview when R meets criteria") ///
ctitle("" "Criteria A" "Criteria B" \ "" "Serious med illness" "SMI or ADL impair and" ///
\ "" "" "SNF or Hospital use" ) sdec(0\2\2\2\2\2\2\0) replace 


log close


H="Step 10 - Core interviews - set up from time 0=meet criteria"
/*From this point on, there are 2 datasets, one for those that
meet Criteria A) Serious medical illness and one for those that 
meet Criteria B) (Serious medical illness or ADL Impairment) and (nursing
home use or urgent/emergent hospital admission) 

Datasets are saved as:
sic_fin.n0_n1_p1_p2_criteria_a
sic_fin.n0_n1_p1_p2_criteria_b

Contain the following interviews as denoted by variable suffix:
_n0 - when first meet criteria
_n1 - interview prior to first meeting criteria
_p1 and _p2 - 2 interviews after meeting criteria
*/

/*proc printto new log='&logdir.\sas_13_sic_ivw_time_log.log'
	print='&logdir.\sas_13_sic_ivw_time_out.lst' 
run;*/


*****************************************************;
*rename macro *;
*****************************************************;
%macro rename(lib,dsn,pre);
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "Before Renaming All Variables";
run;

proc sql noprint;
select nvar into :num_vars
from dictionary.tables
where libname="&LIB" and
memname="&DSN";
select distinct(name) into :var1-
:var%TRIM(%LEFT(&num_vars))
from dictionary.columns
where libname="&LIB" and
memname="&DSN";
quit;
run;

proc datasets library=&LIB;
modify &DSN;
rename
%do i=1 %to &num_vars;
&&var&i=&&var&i.._&pre 
%end;
;
quit;
run;
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "After Renaming All Variables";
run;
%mend rename;


****************************************************************;
/*set up datasets with reference time 0 = time initially meet criteria
time =0 has n0 suffix
interviews before have n1, n2, etc suffix
interviews after have p1, p2 suffix */
****************************************************************;

*drop variables from interview dataset that we don't need for the n1, p1, etc datasets;
*these are variables from the restricted dataset;
data core_to_use;
set sic_int.ivws_crit_1(drop=birth_date death_date white black hisp_eth other_na_api_race 
zip_0: zip_10: zip_98: first_ivw_year last_ivw_year restr_yes);
run;

data core_all_drop;
set sic_int.core_ids_1yr_criteria_5(drop=birth_date death_date white black hisp_eth other_na_api_race 
zip_0: zip_10: zip_98: first_ivw_year last_ivw_year restr_yes);
run;

*note interview counts listed are for criteria a dataset, they are different for criteria b;
%macro ds_restr(crit=);

*get ids, first time they met criteria;
data n0_&crit._1;
set sic_int.ivws_crit_1;
if ivw_meet_crit_&crit.=1;
run;

data TEST;
set n0_&crit._1(drop=zip_0: zip_10: zip_98:);
run;

*add _n0 suffix for interview variables for year that first meets criteria;
%rename(WORK,TEST,n0);

data n0_&crit._3;
set TEST;
rename id_n0=id;
rename bid_hrs_n0=bid_hrs;
run;

****************************************************************;
*get n1 interview, interiew prior to meeting criteria*;
*list of 4244 core interviews with ffs medicare 1 year prior before meeting the criteria*;
proc sql;
create table all_ivw_bef_meet_&crit.
as select b.*
 from n0_&crit._3 a 
 inner join
core_to_use b
  on a.id=b.id and a.c_ivw_date_n0>b.c_ivw_date;
  quit;

proc sort data=all_ivw_bef_meet_&crit. ;
by id c_ivw_date;
run;

*keep only the n1 core interview;
*2222 interviews identified that have ffs medicare 1 year prior to n1 interview;
data core_n1_&crit.;
set all_ivw_bef_meet_&crit.;
by id c_ivw_date;
if last.id;
run;

proc freq;
table core_year;
run;

*supplement the list with interviews with no or unknown ffs medicare 1 year;
*prior to interview in order to fill in for those with interviews in 2000;
proc sql;
create table noffsreq_ivw_bef_meet_&crit.
as select b.*
 from n0_&crit._3 a 
 inner join
core_all_drop b
  on a.id=b.id and a.c_ivw_date_n0>b.c_ivw_date;
  quit;

*5304 of the ivws are not in the list that already have the n1 ivw;
proc sql;
create table noffsreq_ivw_bef_meet_&crit._1 as select * from
noffsreq_ivw_bef_meet_&crit.
where id not in (select id from core_n1_&crit.);
quit;

proc sort data=noffsreq_ivw_bef_meet_&crit._1 ;
by id c_ivw_date;
run;

*keep only the n1 core interview;
*2114 interviews identified;
data noffsreq_core_n1_&crit.;
set noffsreq_ivw_bef_meet_&crit._1;
by id c_ivw_date;
if last.id;
run;

*append to get full list of 4336 n1 interviews;
data core_n1_&crit._1;
set core_n1_&crit. noffsreq_core_n1_&crit.;
run;

proc sort data=core_n1_&crit._1 nodupkey;
by id;
run;

*check on number of pre interviews present in the dataset;
*for those that meet the criteria;
proc sql;
create table ivw_count_before_&crit. as select distinct id,
count(*) as n_ivws_bef_&crit. label="n ivws before meet criteria &crit."
from 
all_ivw_bef_meet_&crit.  group by id;
quit;

proc freq; table n_ivws_bef_&crit.;
run;

****************************************************************;
*get p1 interview, interview after meeting criteria*;
*list of all core interviews after meeting the criteria*;
proc sql;
create table all_ivw_aft_meet_&crit.
as select b.*
 from n0_&crit._3 a 
 inner join
core_to_use b
  on a.id=b.id and a.c_ivw_date_n0<b.c_ivw_date;
  quit;

proc sort data=all_ivw_aft_meet_&crit. ;
by id c_ivw_date;
run;

*keep only the p1 core interview;
*2260 interviews identified;
data core_p1_&crit.;
set all_ivw_aft_meet_&crit.;
by id c_ivw_date;
if first.id;
run;

proc freq;
table core_year;
run;

*check on number of post-interviews present in the dataset;
*for those that meet the criteria;
proc sql;
create table ivw_count_after_&crit. as select distinct id,
count(*) as n_ivws_after_&crit. label="n ivws after meet criteria &crit."
from 
all_ivw_aft_meet_&crit.  group by id;
quit;

proc freq; table n_ivws_after_&crit.;
run;


****************************************************************;
*get p2 interview, interview after meeting criteria*;
*list of all core interviews after the p1 interview*;
proc sql;
create table all2_ivw_aft_meet_&crit.
as select b.*
 from core_p1_&crit. a 
 inner join
core_to_use b
  on a.id=b.id and a.c_ivw_date<b.c_ivw_date;
  quit;

proc sort data=all2_ivw_aft_meet_&crit. ;
by id c_ivw_date;
run;

*keep only the p2 core interview;
*1400 interviews identified;
data core_p2_&crit.;
set all2_ivw_aft_meet_&crit.;
by id c_ivw_date;
if first.id;
run;

proc freq;
table core_year;
run;

*rename the n1, p1 and p2 interviews*;

*n1 interview;
data TEST;
set core_n1_&crit._1 ;
run;

%rename(WORK,TEST,n1);
data core_n1_&crit._1;
set TEST;
rename id_n1=id;
rename bid_hrs_n1=bid_hrs;
run;

*p1 interview;
data TEST;
set CORE_P1_&crit.;
run;
%rename(WORK,TEST,p1);
data core_p1_&crit._1;
set TEST;
rename id_p1=id;
rename bid_hrs_p1=bid_hrs;
run;

*p2 interview;
data TEST;
set CORE_P2_&crit.;
run;

%rename(WORK,TEST,p2);
data core_p2_&crit._1;
set TEST;
rename id_p2=id;
rename bid_hrs_p2=bid_hrs;
run;

*merge the datasets together*;
proc sort data=n0_&crit._3 nodupkey;
by id;
run;

proc sort data=core_n1_&crit._1 nodupkey;
by id;
run;

proc sort data=core_p1_&crit._1 nodupkey;
by id;
run;

proc sort data=core_p2_&crit._1 nodupkey;
by id;
run;

data sic_fin.n0_n1_p1_p2_criteria_&crit.;
merge n0_&crit._3 core_n1_&crit._1 core_p1_&crit._1 core_p2_&crit._1;
by id;
run;

%mend ds_restr;

%ds_restr(crit=a);
%ds_restr(crit=b);

proc freq data=sic_fin.n0_n1_p1_p2_criteria_a;
table core_year_n1 core_year_n0 core_year_p1 core_year_p2;
run;

proc freq data=sic_fin.n0_n1_p1_p2_criteria_b;
table core_year_n1 core_year_n0 core_year_p1 core_year_p2;
run;

*************************************************************;
** Looking at who has missing n1 core interviews  ***********;
*************************************************************;
proc freq data=sic_fin.n0_n1_p1_p2_criteria_a;
table part_ab_12m_n1*hmo_d_12m_n1 part_ab_6m_n1*hmo_d_6m_n1 /missprint;
run;

data no_n1_core_1;
set sic_fin.n0_n1_p1_p2_criteria_a;
if core_year_n1=.;
run;

proc freq;
table core_year_n0 first_ivw_year_n0;
run;

H="Step 11 - Add exit interviews to dataset"
/*adds exit interview variables (with _x suffix) to the dataset that
is formatted with the n0 as time0 interview, etc.

Note for now, this just adds interview information, nothing pulled from claims
prior to death, may need to revisit this if we need outcomes prior to exit
interview*/

/*proc printto new log='&logdir.\sas_14_sic_exit_log.log'
	print='&logdir.\sas_14_sic_exit_out.lst' 
run;*/

data exit;
set hrs_fnl.exit_02_to_10_dt;
run;

proc sort data=exit out=EXIT_1;
by id;
run;

*rename with _x suffix;
%rename(WORK,EXIT_1,x);
data exit_2;
set exit_1;
rename id_x=id;
run;

/*use macro to do for criteria a and b datasets*/

%macro exit(crit=);

/*keep for those R's that meet criteria at some time*/
proc sql;
create table exit_meet_&crit. as select * 
from exit_2 
where id in (select id from sic_fin.n0_n1_p1_p2_criteria_&crit.);
quit;

proc sort data=exit_meet_&crit. nodupkey; by id; run;
proc sort data=sic_fin.n0_n1_p1_p2_criteria_&crit. out=ivws nodupkey; by id; run;

data n0_n1_p1_p2_x_criteria_&crit._1;
merge ivws exit_meet_&crit.;
run;

proc freq; table exit_year_x; run;

data sic_fin.n0_n1_p1_p2_x_criteria_&crit.;
set n0_n1_p1_p2_x_criteria_&crit._1;
if exit_year_x-core_year_n0=2 then ind_exit_p1_yes=1;
else ind_exit_p1_yes=0;
if exit_year_x-core_year_n0=4 then ind_exit_p2_yes=1;
else ind_exit_p2_yes=0;
label ind_exit_p1_yes="Exit interview in wave following n0 ivw";
label ind_exit_p2_yes="Exit interview in wave following p1 ivw";
run;

proc freq; 
table ind_exit_p1_yes*core_year_p1 ind_exit_p2_yes*core_year_p2 /missprint; 
run;

%mend exit;

%exit(crit=a);
%exit(crit=b);

/*export to Stata for remaining processing*/
proc export data=sic_fin.n0_n1_p1_p2_x_criteria_a
outfile="E:\data\serious_ill\final_data\n0_n1_p1_p2_x_criteria_a.dta" replace;
run;

proc export data=sic_fin.n0_n1_p1_p2_x_criteria_b
outfile="E:\data\serious_ill\final_data\n0_n1_p1_p2_x_criteria_b.dta" replace;
run;


H="Step 12 - Create additional variables, changes between ivws"
/*switched to Stata
Data cleaning, create new variables
Code can be run on either criteria a or criteria b datasets, comments indicate
sections to be modified when switching between them*/

capture log close

clear all
set mem 500m
set more off

local crit a
//local crit b

local logpath E:\data\serious_ill\logs
local datapath E:\data\serious_ill\final_data

log using "`logpath'\4`crit'-sic_data_cleaning_crit_`crit'.txt", text replace

cd `datapath'

use n0_n1_p1_p2_x_criteria_`crit'.dta

tab core_year_n0, missing

*******************************************************************
//age when meet criteria
sum age_at_core_n0

gen age_cat_n0 = .
replace age_cat_n0 = 1 if age_at_core_n0<75
replace age_cat_n0 = 2 if age_at_core_n0>=75 & age_at_core_n0<85
replace age_cat_n0 = 3 if age_at_core_n0>=85 & age_at_core_n0!=.
la var age_cat_n0 "Age when meets criteria, categorical"
la def age_cat 1 "Age 65-74" 2 "Age 75-84" 3"Age 85+"
la val age_cat_n0 age_cat
tab age_cat_n0, missing

sum age_at_core_n0 if age_cat_n0 ==1
sum age_at_core_n0 if age_cat_n0 ==2
sum age_at_core_n0 if age_cat_n0 ==3

//female gender indicator variable
tab female_n0, missing

//create race and ethnicity categorical variable
//may want to backfill from claims and check this variable!
gen re_cat = .
replace re_cat = 1 if black_n0==1
replace re_cat = 3 if white_n0==1
replace re_cat = 2 if hisp_eth_n0==1
replace re_cat = 4 if other_na_api_race_n0==1
replace re_cat = 5 if black_n0!=1 & white_n0!=1 & hisp_eth_n0~=1 & other_na_api_race_n0~=1
la var re_cat "Race & Ethnicity"
la def re_cat 1 "African American" 3 "White" 2 "Hispanic" 4 "Other" 5 "Unknown race" , replace
la val re_cat re_cat
tab re_cat, missing

//education categorical variable
label define educ 0 "No Formal Education" 1 "Grades 1-11" 2 "High School" 3 "Some College" 4 "College" ///
      5 "Post College"
label values educ_n0 educ 
tab educ_n0, missing
tab educ_n1 educ_n0, missing

//need to backfill with n2, n3 information, don't have it in the dataset now
gen educ = educ_n0
replace educ=educ_n1 if educ_n0==.
label values educ educ
tab educ core_year_n0, missing

//self reported health status
tab srh_n0 srh_n1, missing

*******************************************************************
//Indicators for having each of the interviews
gen byte ind_n1_interview = .
replace ind_n1_interview=1 if core_year_n1!=.
replace ind_n1_interview=0 if core_year_n1==.
la var ind_n1_interview "R has n1 interview"
tab ind_n1_interview core_year_n0, missing

gen byte ind_p1_interview = .
replace ind_p1_interview=1 if core_year_p1!=.
replace ind_p1_interview=0 if core_year_p1==.
la var ind_p1_interview "R has p1 interview"
tab ind_p1_interview core_year_n0, missing

gen byte ind_p2_interview = .
replace ind_p2_interview=1 if core_year_p2!=.
replace ind_p2_interview=0 if core_year_p2==.
la var ind_p2_interview "R has p2 interview"
tab ind_p2_interview core_year_n0, missing

gen byte ind_x_interview = .
replace ind_x_interview=1 if exit_year_x!=.
replace ind_x_interview=0 if exit_year_x==.
la var ind_x_interview "R has exit interview"
tab ind_x_interview core_year_n0, missing
tab ind_x_interview core_year_n0 if core_to_dod_1yr_n0==1, missing

*******************************************************************
//Change in functional status variables
//Looking back, change from core before meet criteria to core when meet criteria
label define adl_cat_core 0 "Independent" 1 "Partial Dependence" 2 "Severe Dependence"
label values adl_cat_core_n0 adl_cat_core 
tab adl_cat_core_n0 , missing 


//stable ind = 1 if stays the same or improves (0 if declines)
gen byte adl_stable_ind_n0n1=0
replace adl_stable_ind_n0n1=1 if adl_cat_core_n0==0 & inlist(adl_cat_core_n1,0,1,2) 

gen byte adl_stable_partial_n0n1=0
replace adl_stable_partial_n0n1=1 if adl_cat_core_n0==1 & inlist(adl_cat_core_n1,1,2) 

gen byte adl_stable_severe_n0n1=0
replace adl_stable_severe_n0n1=1 if adl_cat_core_n0==2 & adl_cat_core_n1==2 

gen byte adl_change_i_m_n0n1=0
replace adl_change_i_m_n0n1=1 if adl_cat_core_n0==1 & adl_cat_core_n1==0

gen byte adl_change_i_s_n0n1=0
replace adl_change_i_s_n0n1=1 if adl_cat_core_n0==2 & adl_cat_core_n1==0

gen byte adl_change_m_s_n0n1=0
replace adl_change_m_s_n0n1=1 if adl_cat_core_n0==2 & adl_cat_core_n1==1

gen byte adl_improved_n0n1=0
replace adl_improved_n0n1=1 if inlist(adl_cat_core_n0,0,1) & adl_cat_core_n1==2
replace adl_improved_n0n1=1 if adl_cat_core_n0==0 & adl_cat_core_n1==1

local adlchange adl_stable_ind_n0n1 adl_stable_partial_n0n1 adl_stable_severe_n0n1 ///
adl_change_i_m_n0n1 adl_change_i_s_n0n1 adl_change_m_s_n0n1 adl_improved_n0n1

foreach v in `adlchange' {
replace `v'=. if adl_cat_core_n0==. | adl_cat_core_n1==.
}

//keep missing category out for now, see what the data looks like
//if decide on missing category, just change line in foreach loop above
//adl_change_n1n2_miss=0;
//if adl_cat_core_n1=. or  adl_cat_core_n2=.  then adl_change_n1n2_miss=1;

la var adl_stable_ind_n0n1 "R ADL Ind. stable or improving n1 to n0, 1=Yes"
la var adl_stable_partial_n0n1 "R ADL Partial Depend, stable n1 to n0, 1=Yes"
la var adl_stable_severe_n0n1 "R ADL Severe Depend, stable n1 to n0, 1=Yes"
la var adl_change_i_m_n0n1 "R ADL Indep. to Partial Depend n1 to n0, 1=Yes"
la var adl_change_i_s_n0n1 "R ADL Indep. to Severe Depend n1 to n0, 1=Yes"
la var adl_change_m_s_n0n1 "R ADL Partial to Severe Depend n1 to n0, 1=Yes"
la var adl_improved_n0n1 "R ADL Improvement n1 to n0, 1=Yes"
//la var adl_change_n0n1_miss="R ADL n1 to n0 unknown";

foreach v in `adlchange' {
tab `v' , missing
}

*******************************************************************
//Change in functional status variables
//Looking forward, change from core meet criteria to next interview (core or death)
//Need to code up for if missing p1, check the exit interviews!
tab adl_cat_core_p1 adl_cat_core_n0, missing

//stable ind = 1 if stays the same or improves (0 if declines)
gen byte adl_stable_ind_n0p1=0
replace adl_stable_ind_n0p1=1 if adl_cat_core_p1==0 & inlist(adl_cat_core_n0,0,1,2) 

gen byte adl_stable_partial_n0p1=0
replace adl_stable_partial_n0p1=1 if adl_cat_core_p1==1 & inlist(adl_cat_core_n0,1,2) 

gen byte adl_stable_severe_n0p1=0
replace adl_stable_severe_n0p1=1 if adl_cat_core_p1==2 & adl_cat_core_n0==2 

gen byte adl_change_i_m_n0p1=0
replace adl_change_i_m_n0p1=1 if adl_cat_core_p1==1 & adl_cat_core_n0==0

gen byte adl_change_i_s_n0p1=0
replace adl_change_i_s_n0p1=1 if adl_cat_core_p1==2 & adl_cat_core_n0==0

gen byte adl_change_m_s_n0p1=0
replace adl_change_m_s_n0p1=1 if adl_cat_core_p1==2 & adl_cat_core_n0==1

gen byte adl_improved_n0p1=0
replace adl_improved_n0p1=1 if inlist(adl_cat_core_p1,0,1) & adl_cat_core_n0==2
replace adl_improved_n0p1=1 if adl_cat_core_p1==0 & adl_cat_core_n0==1

local adlchange adl_stable_ind_n0p1 adl_stable_partial_n0p1 adl_stable_severe_n0p1 ///
adl_change_i_m_n0p1 adl_change_i_s_n0p1 adl_change_m_s_n0p1 adl_improved_n0p1

foreach v in `adlchange' {
replace `v'=. if adl_cat_core_n0==. | adl_cat_core_p1==.
}

//keep missing category out for now, see what the data looks like
//if decide on missing category, just change line in foreach loop above
//adl_change_n1n2_miss=0;
//if adl_cat_core_n1=. or  adl_cat_core_n2=.  then adl_change_n1n2_miss=1;

la var adl_stable_ind_n0p1 "R ADL Ind. stable or improving n0 to p1, 1=Yes"
la var adl_stable_partial_n0p1 "R ADL Partial Depend, stable n0 to p1, 1=Yes"
la var adl_stable_severe_n0p1 "R ADL Severe Depend, stable n0 to p1, 1=Yes"
la var adl_change_i_m_n0p1 "R ADL Indep. to Partial Depend n0 to p1, 1=Yes"
la var adl_change_i_s_n0p1 "R ADL Indep. to Severe Depend n0 to p1, 1=Yes"
la var adl_change_m_s_n0p1 "R ADL Partial to Severe Depend n0 to p1, 1=Yes"
la var adl_improved_n0p1 "R ADL Improvement n0 to p1, 1=Yes"
//la var adl_change_n0p1_miss="R ADL n0 to p1 unknown";

foreach v in `adlchange' {
tab `v' , missing
}
*******************************************************************

save n0_n1_p1_p2_x_criteria_`crit'_v1.dta, replace

log close


H="Tables, looking from 1st interview where meet criteria"
/*Stata
Create tables comparing outcomes for the criteria
Code can be run on either criteria a or criteria b datasets*/

capture log close

clear all
set mem 500m
set more off

//local crit a
local crit b
//local critvar ser_med_illness
local critvar criteria_b

local logpath E:\data\serious_ill\logs
local datapath E:\data\serious_ill\final_data

log using "`logpath'\4`crit'-sic_data_cleaning_crit_`crit'.txt", text replace
//log using "`logpath'\4`crit'-sic_data_cleaning_crit_`crit'.txt", text replace

cd `datapath'

use n0_n1_p1_p2_x_criteria_`crit'_v1.dta

//may want to create a tabulation of what smi's are present in n0 interview prior
//to this table (like in the 7a section, but just for interview where first meet
//criteria for both criteria a and b??)
*******************************************************
*** Table of serious medical conditions
*******************************************************
local smivars smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 smi_chf_ind_n0 smi_copd_ind_n0 ///
smi_diab_compl_ind_n0 smi_liver_ind_n0 smi_hiv_ind_n0 smi_als_ind_n0 smi_hip_ind_n0 adl_impair_core_n0

mat table1=J(11,11,.)

sum core_year_n0
sca nsamp=r(N)
local nsamp=nsamp

local r=1
foreach a in `smivars'{
	local c=1
	foreach b in `smivars'{
		tab `a' `b', matcell(r`r'c`c')
		mat table1[`r',`c']=r`r'c`c'[2,2]
	local c=`c'+1
	}
	local r=`r'+1
}

mat rownames table1="dementia" "cancer" "esrd" "chf" "copd" "diabetes" "liver disease" ///
"HIV" "ALS" "Hip fracture" "ADL Impairment"

mat colnames table1="dementia" "cancer" "esrd" "chf" "copd" "diabetes" "liver disease" ///
"HIV" "ALS" "Hip fracture" "ADL Impairment"

frmttable using "`logpath'\sic_Tables_4_outcomes_crit_`crit'", statmat(table1) ///
title("Comparison of serious medical conditions and ADL Impairement" \ ///
"Interview when first meet criteria" \ ///
"Criteria `crit' n=`nsamp'") sdec(0) landscape replace

*******************************************************
*** Meet criteria p1 interview?
*******************************************************
mat p1_crit=J(3,2,.)
sum `critvar'_n0
mat p1_crit[1,1]=r(N) //overall n meet criteria
mat p1_crit[1,2]=100

sum `critvar'_n0 if ind_p1_interview==1 //n that have p1 interview
mat p1_crit[2,1]=r(N) //overall n meet criteria w/ p1 ivw
mat p1_crit[2,2]=p1_crit[2,1]/p1_crit[1,1]*100

tab `critvar'_p1 if ind_p1_interview==1, matcell(p1)
mat p1_crit[3,1]=p1[2,1] //n that meet criteria p1
mat p1_crit[3,2]=(p1_crit[3,1] / p1_crit[2,1])*100

frmttable using "`logpath'\sic_Tables_4_outcomes_crit_`crit'", statmat(p1_crit) ///
title("Meet criteria `crit' in p1 interview")  ///
rtitles("Overall n meet criteria n0 interview"\ "Have p1 interview" \"N meet p1 interview") ///
ctitles("" "N" "Percent") ///
sdec(0,2) addtable

*******************************************************
log close


H="xxxxNotes"
Helper files - A respondant gets an entry (or many entries) in the helper file
if they report getting help in the ADLs, IADLs and Money (MG062_1 or _2) questions:

data helper_check;
set core_pre.H10g_hp;
if MADLNDX=. & MIADLNDX=. & MMNYNDX=.;
run;
No observations without one of the three links.

Notes regarding Elixhauser comorbidity coding:
See the email list of ICD-9 codes provided by Amy on 4/3/14
This list modifies the original ICD-9 codes used to better suit the serious
illness definitions

From reading through Elixhauser et al (1998) the original purpose
was to identify comorbidities that are underlying conditions, so not the
reason for hospital admission. So if a diagnosis was the primary diagnosis,
or if it was related to the primary DRG of the patient, it was NOT used 
in coding the Elixhauser comorbidity index. This is different from what we are
doing in that we want to identify people with serious illness, regardless
(and in many cases specifically) if they are the primary disease or diagnosis.



H="xxxx Additional checks"
proc freq data=bid_dx_0_1yr;
table cc_1_ami  /missprint;
run;

proc freq data=bid_dx_0_1yr2;
table cc_1_ami  /missprint;
run;

proc freq data=sic_int.core_ids_elix_1yr;
table comorb:;
run;

proc sql;
select count(distinct cats(BID_HRS_19,core_year)) from sic_int.dx_0_1yr;
quit;



H="xxxxAdditional variables from claims"
/*********************************************************/
/******* Any admission to the ICU                *********/
/*********************************************************/
/*Comes from medpar claims
Code below from Melissa's hospice project, need to adapt
for the HRS linked MC claims*/

proc freq data=medpar2;
table ICU_IND_CD /missprint;
run;

/*create indicator for ICU and/or ED use during stay
ICUED=0 - no icu or ed use
=1 ED only
=2 ICU only
=3 ICU and ED*/
data medpar3;
	set medpar2;
	if ICU_IND_CD ~= . or INTNSV_CARE_DAY_CNT>0 then ICU = 1;
	if ICU_IND_CD = . and INTNSV_CARE_DAY_CNT=0 then ICU = 0;
	if SS_LS_SNF_IND_CD ~= 'N';
	ED = 0;
	if ER_CHRG_AMT > 0 then ED = 1;
	if ICU = 1 and ED = 1 then ICUED = 3;
	if ICU = 1 and ED = 0 then ICUED = 2;
	if ICU = 0 and ED = 1 then ICUED = 1;
	if ICU = 0 and ED = 0 then ICUED = 0;
	drop icu ed;
run;


/*Notes re OP ED Use, from Melissa's project
Uses Revenue center codes*/

data ed;
	set revenue0;
	if REV_CNTR >= 450 and REV_CNTR < 460;
	ed = 1;
run;

Each OP claim has up to 45 REV_CNTR variables:
 	RVCNTR01-RVCNTR45