= V4 Outline MultiLine NoSorting TabWidth=30

H="Serious illness cohort definition development"
/*HRS variables are processed in file HRS_Processing.txt
1998-2012 Core interviews
2002-2012 Exit interviews
Restricted data received in March 2015

Note elixhauser comorbidities diagnosis lists are modified for the 
purposes of this project, do not copy and paste this Elixhauser code 
for use in other projects!!

******************************************************************

/*hrs cleaned path*/
libname hrs_fnl 'E:\data\hrs_cleaned';

/*medicare xwalk and claims path*/
libname medi 'E:\data\cms_DUA_24548_2012';

/*project data paths*/
libname sic_int 'E:\data\serious_ill\int_data';
libname sic_fin 'E:\data\serious_ill\final_data';
libname sic_ref 'E:\data\serious_ill\ref_data';


H="Initial core criteria"
/***********************************************************************/
/*Core interview dataset, merge variables from restricted              */
/***********************************************************************/

libname hrs_fnl 'E:\data\hrs_cleaned';

data core;
set hrs_fnl.core_00_to_12;
label c_ivw_year="Core interview year";
run;

proc sort data=core nodupkey;
by id core_year;
run;

data restr(rename=(ZIP10_2000=ZIP10));
set hrs_fnl.restr_tracker_v2012(keep=hhid pn id birth_date death_date white black hisp_eth native_amer 
asian_pi other_race other_na_api_race zip: stateusps: cause_death_12_n degree gender);
id_c=trim(hhid)||trim(pn);
drop id;
rename id_c=id;
restr_yes=1;
run;

proc sort data=restr nodupkey;
by id;
run;

proc contents data=restr; run;

proc sql;
create table core_dob(drop=id2) as select * from core a left join
restr(rename=(id=id2) drop=hhid pn) b 
on a.id=b.id2;
quit;

*6 obs have no match in the restricted dataset;
*These obs each only have 1 inteview, so can't use them anyway;
proc freq data=core_dob; table restr_yes /missprint; run;

data restr_test;
set core_dob;
if restr_yes=.;
run;

data core_age_1;
set core_dob;
format death_date date9.;
age_at_core=floor((c_ivw_date-birth_date)/365.25);
label age_at_core="Age at core interview";
if age_at_core>=65 then age_ge_65=1;
if age_at_core<65 then age_ge_65=0;
label age_ge_65="Age at core interview > 65";

core_to_death=(death_date-c_ivw_date)/365.25;
label core_to_death="Time from core ivw to death, years";
if core_to_death<=1 and core_to_death~=. then core_to_dod_1yr=1;
if core_to_death>1 or core_to_death=. then core_to_dod_1yr=0;
label core_to_dod_1yr="Died within 1 year of core interview";

if core_to_death<=0.5 and core_to_death~=. then core_to_dod_6m=1;
if core_to_death>0.5 or core_to_death=. then core_to_dod_6m=0;
label core_to_dod_6m="Died within 6 months of core interview";

run;

proc freq data=core_age_1;
table age_at_core*age_ge_65 core_to_dod_1yr*core_to_dod_6m /missprint;
run;

proc export data=core_age_1 
outfile="E:\data\serious_ill\int_data\core_age_1a.dta" replace;
run;

****************************************************************;
/*switch to stata
****************************************************************;
use "E:\data\serious_ill\int_data\core_age_1a.dta", clear
/*also get nw_quartile for those over 65*/
drop nw_*

levelsof core_year, local(levels)
gen nw_quartile_65=.
foreach y of local levels {
	xtile nq=networth_adj2012 if core_year==`y' & age_at_core>=65, nq(4)
	replace nw_quartile=nq if nw_quartile==.
	drop nq
}

label var nw_quartile "Networth, quartiles, based on 2012$ adjusted nw at age>=65 by year"

tab nw_quart, gen(nw_q)
rename nw_q1 nw_lowest
rename nw_q2 nw_midlow
rename nw_q3 nw_midhigh
rename nw_q4 nw_highest

label variable nw_lowest "Networth, lowest quartile"
label variable nw_midlow "Networth, second quartile"
label variable nw_midhigh "Networth, third quartile"
label variable nw_highest "Networth, highest quartile"

tab nw_lowest, missing
tab nw_midlow, missing
tab nw_midhigh, missing
tab nw_highest, missing

** Networth missing **
generate nw_missing = 0
replace nw_missing = 1 if (nw_quart==.)
label variable nw_missing "Networth missing"
tab nw_missing, missing

saveold "E:\data\serious_ill\int_data\core_age_1.dta", replace
*/

********************************************************;
/*back to sas*/
*******************************************************;

proc import datafile="E:\data\serious_ill\int_data\core_age_1.dta"
out=core_age_2;
run;

*get clean zip code variable by wave;
proc sort data=core_age_2; by id core_year; run;

/*get list of first and last interview years*/
data ivw_years_1;
set core_age_2;
by id; 
if first.id then first_ivw_year=core_year;
if last.id then last_ivw_year=core_year;
run;

data ivw_years_1a;
set ivw_years_1;
if first_ivw_year~=.;
run;

data ivw_years_1b;
set ivw_years_1;
if last_ivw_year~=.;
run;

proc sql;
create table ivw_years_2 as select a.id,a.first_ivw_year,b.last_ivw_year
from ivw_years_1a a left join
ivw_years_1b b
on a.id=b.id;
quit;

proc freq; table first_ivw_year last_ivw_year; run;

*merge into overall dataset;
proc sql;
create table core_age_zip_1 as select
a.*, b.first_ivw_year,b.last_ivw_year from
core_age_2 a left join
ivw_years_2 b
on a.id=b.id;
quit;

proc freq; table first_ivw_year last_ivw_year; run;

/*clean up missing zip variables
1. if missing, use interview prior
2. if still missing, use interview after
3. if still missing, use interview 2x prior...*/

data core_age_zip_2 ;
set core_age_zip_1 ;
/*1998 updates, use 2000 zip
1 obs only has one interview in our dataset for 1998 and is missing zip that year, won't be
in the final sample so leave as missing now*/
if zip98='' & first_ivw_year<=1998<=last_ivw_year then do;
	zip_98_imp_yes=1;
	zip98=zip00;
	end;
/*2000 updates, use 1998 zip
2 obs only have one interview in the dataset for 2000, missing zip that year, again not
in final sample so leave missing here*/
if zip00='' & first_ivw_year<=2000<=last_ivw_year then do;
	zip_00_imp_yes=1;
	zip00=zip98;
	end;
/*2002 updates, use 2000 or 2004 zip
1 obs has only the 2002 interview, leave zip missing for that person*/
if zip02='' & first_ivw_year<=2002<=last_ivw_year then do;
	zip_02_imp_yes=1;
	zip02=zip00;
		if zip02='' then do;
		zip02=zip04;
		end;
	end;
/*2004 updates, use 2002 or 2006 zip
13 obs has only the 2004 interview, leave zip missing for those observations*/
if zip04='' & first_ivw_year<=2004<=last_ivw_year then do;
	zip_04_imp_yes=1;
	zip04=zip02;
		if zip04='' then do;
		zip04=zip06;
		end; /*1 obs still missing, use 1998 zip for this person*/
				if zip04='' then do;
				zip04=zip98;
				end; 
	end;
/*2006 updates, use 2004 or 2008 zip
no observations missing*/
if zip06='' & first_ivw_year<=2006<=last_ivw_year then do;
	zip_06_imp_yes=1;
	zip06=zip04;
		if zip06='' then do;
		zip06=zip08;
		end; 
	end;
/*2008 updates, use 2006 zip
no observations missing*/
if zip08='' & first_ivw_year<=2008<=last_ivw_year then do;
	zip_08_imp_yes=1;
	zip08=zip06;
	end;
/*2010 updates, use 2008 zip
1 obs has only 2010 interview and missing zip that year, so leave missing*/
if zip10='' & first_ivw_year<=2010<=last_ivw_year then do;
	zip_10_imp_yes=1;
	zip10=zip08;
	end;
/*2012 12 observations missing, use 2010*/
if zip12='' & first_ivw_year<=2012<=last_ivw_year then do;
	zip_12_imp_yes=1;
	zip12=ZIP10_2010;
	end;
run;

****************************************************************;
*get clean state code variable by wave;
data core_age_zip_state;
set core_age_zip_2;
/*1998 state - n=1 obs only has one interview with missing zip,state, leave blank*/
if stateusps98='' & first_ivw_year<=1998<=last_ivw_year then do;
	st_98_imp_yes=1;
	stateusps98=stateusps00;
	end;
/*2000 state - n=2 obs only single interview so leave missing*/ 
if stateusps00='' & first_ivw_year<=2000<=last_ivw_year then do;
	st_00_imp_yes=1;
	stateusps00=stateusps98;
	end;
/*2002 state - n=1 obs only single interview so leave missing*/ 
if stateusps02='' & first_ivw_year<=2002<=last_ivw_year then do;
	st_02_imp_yes=1;
	stateusps02=stateusps00;
	if stateusps02='' then do;
		stateusps02=stateusps04;
		end;
	end;
/*2004 updates, use 2002 or 2006 state
13 obs has only the 2004 interview, leave state missing for those observations*/
if stateusps04='' & first_ivw_year<=2004<=last_ivw_year then do;
	st_04_imp_yes=1;
	stateusps04=stateusps02;
		if stateusps04='' then do;
		stateusps04=stateusps06;
		end; /*1 obs still missing, use 1998 state for this person*/
				if stateusps04='' then do;
				stateusps04=stateusps98;
				end; 
	end;
/*2006 updates, use 2004 or 2008 state
no observations missing*/
if stateusps06='' & first_ivw_year<=2006<=last_ivw_year then do;
	st_06_imp_yes=1;
	stateusps06=stateusps04;
		if stateusps06='' then do;
		stateusps06=stateusps08;
		end; 
	end;
/*2008 updates, use 2006 state
no observations missing*/
if stateusps08='' & first_ivw_year<=2008<=last_ivw_year then do;
	st_08_imp_yes=1;
	stateusps08=stateusps06;
	end;
/*2010 updates, use 2008 state
1 obs has only 2010 interview and missing state that year, so leave missing*/
if stateusps10='' & first_ivw_year<=2010<=last_ivw_year then do;
	st_10_imp_yes=1;
	stateusps10=stateusps08;
	end;
/*2012 updates, use 2010 state
no observations missing*/
if stateusps12='' & first_ivw_year<=2012<=last_ivw_year then do;
	st_12_imp_yes=1;
	stateusps12=stateusps10;
	end;
run;

proc sort data=core_age_zip_state; by id core_year; run;

*save dataset and drop raw zip code variables;
data sic_int.core_age_zip;
set core_age_zip_state;
zip_wave=vvaluex("zip"||substr(trim(left(core_year)),3,2) );
zip_imputed=vvaluex("zip_"||substr(trim(left(core_year)),3,2)||"_imp_yes" );
drop zip9: zip0: zip1: ;
label zip_wave="ZIP code, residence at time of interview";
label zip_imputed="ZIP code imputed";

state_wave=vvaluex("stateusps"||substr(trim(left(core_year)),3,2) );
state_imputed=vvaluex("st_"||substr(trim(left(core_year)),3,2)||"_imp_yes" );
drop stateusps: ;
label state_wave="State, residence at time of interview";
label state_imputed="State imputed";
run;

proc freq data=sic_int.core_age_zip; table zip_wave state_wave  /missprint ; run;

proc freq; table zip_imputed state_imputed /missprint ; run;

****************************************************************;
/*bring in BMI from rand dataset*/
libname rand 'E:\data\hrs_public_2012\rand2012\main';
/*pull each wave bmi variable from rand xwave data file
wave 5 = 2000
wave 6 = 2002 ... wave 10 = 2010
*/
options fmterr=no;
data bmi_rand;
set rand.rndhrs_n(keep=hhid pn R4BMI R5BMI R6BMI R7BMI R8BMI R9BMI R10BMI R11BMI);
id = hhid||pn;
run;

%macro getBMI(w=,year=);

data bmi_rand1_&w;
set bmi_rand;
keep id core_year R&w.BMI;
core_year=&year;
run;

data bmi_rand2_&w;
set bmi_rand1_&w;
rename R&w.BMI=BMI;
%mend;

%getBMI(w=4,year=1998);
%getBMI(w=5,year=2000);
%getBMI(w=6,year=2002);
%getBMI(w=7,year=2004);
%getBMI(w=8,year=2006);
%getBMI(w=9,year=2008);
%getBMI(w=10,year=2010);
%getBMI(w=11,year=2012);

data bmi_9812;
set bmi_rand2_4 bmi_rand2_5 bmi_rand2_6 bmi_rand2_7 bmi_rand2_8 bmi_rand2_9 bmi_rand2_10 bmi_rand2_11;
label BMI='Body Mass Index';
label id='HRS ID';
run;

proc means; var BMI; run;

proc sort nodupkey; by id core_year ; run;

/*merge into dataset by id,core year*/
proc sql;
create table sic_int.core_age_zip_bmi as select a.*,b.BMI as BMI_rand from
sic_int.core_age_zip a
left join
bmi_9812 b 
on a.id=b.id and a.core_year=b.core_year;
quit;

****************************************************************;
ods rtf body=" E:\data\serious_ill\logs\core_00_to_10_meet_criteria.rtf" ;
proc sql;
title "serious illness cohort, initial core interview criteria";
title "meet age>=65 at core interview,2000-2010";
select count(distinct id) from sic_int.core_age_zip_bmi 
where age_ge_65=1 and core_year in (2000,2002,2004,2006,2008,2010);
create table age_ge_65 as 
select * from sic_int.core_age_zip_bmi 
where age_ge_65=1 and core_year in (2000,2002,2004,2006,2008,2010);

title "those meet age>=65,srf(poor,fair)";
select count(distinct id) from age_ge_65 
where srh_pf=1 ;

title "those meet age>=65,chf";
select count(distinct id) from age_ge_65 
where chf_hrs=1 ;

title "those meet age>=65,lung";
select count(distinct id) from age_ge_65 
where lung_hrs=1 ;

title "those meet age>=65,diabetes";
select count(distinct id) from age_ge_65 
where dm_hrs=1 ;

title "those meet age>=65,cancer";
select count(distinct id) from age_ge_65 
where cancer_hrs=1 ;

title "those meet age>=65,chf or lung or diabetes or cancer";
select count(distinct id) from age_ge_65 
where  chf_hrs=1 or lung_hrs=1 or dm_hrs=1 or cancer_hrs=1 ;

title "those meet age>=65,hosp_last_2yr,since last interview";
select count(distinct id) from age_ge_65 
where hosp_last_2yr=1 ;

title "those meet age>=65,meet at least one,fair or poor self report/chf/lung/diabet/cancer/hosp_last_2yr";
select count(distinct id) from age_ge_65 
where  srh_pf=1 or chf_hrs=1 or lung_hrs=1 or dm_hrs=1 or cancer_hrs=1 or hosp_last_2yr=1 ;

title "age>=65,meet at least one,fair or poor self report/chf/lung/diabet/cancer/hosp_last_2yr/1 adl";
select count(distinct id) from age_ge_65 
where  srh_pf=1 or chf_hrs=1 or lung_hrs=1 or dm_hrs=1 or cancer_hrs=1 or hosp_last_2yr=1 
or adl_independent_core=0;

quit;
ods rtf close;

H="Link in Regional data by Zip Code or State"
/*Brings in wage index by ZIP or state

Also gets HRR, Dartmouth EOL spending by ZIP

Note that the raw data with the regional data is saved in the out of pocket
(OOP) spending project folders rather than duplicating it for this project

Final dataset is sic_int.core_age_zip_wi_da*/

/******************************************************************/
/* Adjust subtotals for wage index */
/******************************************************************/

/******************************************************************/
/* Link CBSA codes and zip codes from the WI file*/
/******************************************************************/
/*Bring in xwalk file between CBSA codes and zip codes
Note only keep variables needed from xwalk file because formats 
are missing for some of the other text variables
2012 WI/CBSA - based on 2000 census so no change in the xwalk*/

libname oop_ref "E:\data\Dartmouth_misc";

data zip_cb;
set oop_ref.xtract(keep=zip5 cbsa metrodiv state);
if metrodiv ~="" then cbsa=metrodiv;
zip_n=zip5+0;
cbsa_n=cbsa+0;
/*If zip code is not missing, add state code*/
if zip_n~=.;
state_n=state+0;
run;

*Remove duplicate entries for zip5 and cbsa from xwalk file;
*Goes from 399045 to 49289 rows;
proc sort data=zip_cb out=zip_cb2 nodupkey;
by zip_n cbsa_n;
run;

*Check to see zip codes in a cbsa code for Rochester, NY;
proc sql;
select zip5, cbsa from zip_cb2
where cbsa_n in (40380);
quit;

/*note several zip codes have multiple cbsa*/
/*create dataset with just one entry for each zip code
8029 zip codes have more than one cbsa code
Just use the first one when sort*/
proc sort data=zip_cb2 out=cbsa_zip_final nodupkey;
by zip_n;
run;

*Check to see zip codes in a cbsa code for Rochester, NY;
proc sql;
select zip_n, cbsa from cbsa_zip_final
where cbsa_n in (40380);
quit;

/******************************************************************/
/* Create dataset with cbsa, state, wage index and zip code */
/******************************************************************/
/******************************************************************/
/* Pull in wage index, set up with wage_index_setup.txt code 
in the general HRS processing directory*/
/******************************************************************/
/*bring in 2012 wage index file*/
libname misc 'E:\data\Dartmouth_misc\Wage Index';
libname sic_int 'E:\data\serious_ill\int_data';

data sic_int.wage_index;
set misc.wage_index_2012;
run;

proc means;
var wage_index_2012;
run;

/*for zip codes with no cbsa, wage index is left missing
there are also many cbsas with missing wage index*/
proc sql;
create table zip_cbsa_wage_index as
select a.*,b.wage_index_2012 from
cbsa_zip_final a
left join
sic_int.wage_index b
on a.cbsa_n=b.cbsa_n;
quit;

/*Check for and remove duplicates by zip, keep first entry*/
proc sort data=zip_cbsa_wage_index out=zip_cbsa_wage_index2 nodupkey;
by zip_n;
run;

/******************************************************************/
/* Merge the wage index into the interview dataset by the cleaned zip */
/******************************************************************/

/*change zip in interview dataset to a number*/
data core_age_zip_1 ;
set sic_int.core_age_zip_bmi ;
zip_wave_n=zip_wave+0;
run;

proc contents; run;

proc sql;
create table core_age_zip_wi as select a.*,b.wage_index_2012 from
core_age_zip_1 a
left join
zip_cbsa_wage_index2 b
on a.zip_wave_n=b.zip_n;
quit;

/*n=76792 ivws are missing the wage index when matched just by zip*/
data miss_wi;
set core_age_zip_wi;
if wage_index_2012 =.;
run;

/******************************************************************/
/* Bring in  WI by state if missing by zip (b/c not in a metro area) */
/******************************************************************/
proc sort data=sic_int.wage_index out=wage_index3 nodupkey;
by state_in_wage_index;
run;

data wage_index4; set wage_index3; if state_in_wage_index~='';
run;

proc freq data=wage_index4; table ST; run;

/*Merges in wage index if there's one for the state but was missing for the zip*/
proc sql;
create table sic_int.core_age_zip_wi_2
as select a.*,coalesce(a.wage_index_2012,b.wage_index_2012) as wage_index_2012_2
from
core_age_zip_wi a
left join
wage_index4 b
on a.state_wave=b.ST;
quit;

/*check for missing values*/
proc means;
var wage_index_2012 wage_index_2012_2;
run;

proc sql;
select distinct state_wave ,count(*) from sic_int.core_age_zip_wi_2
where wage_index_2012_2=. group by state_wave;
quit;

proc sql;
select distinct zip_wave_n ,count(*) from sic_int.core_age_zip_wi_2
where wage_index_2012_2=. group by zip_wave_n;
quit;

proc freq data=sic_int.core_age_zip_wi_2; table  state_wave  /missprint ; run;

data sic_int.core_age_zip_wi_3;
set sic_int.core_age_zip_wi_2;
/* create census regions */
if state_wave in ('CT','ME','MA','NH','RI','VT','NJ','NY','PA') then REGION=1;
   else if state_wave in ('IN','IL','MI','OH','WI','IA','KS','MN','MO','NE','ND','SD') then REGION=2;
   else if state_wave in ('DE','DC','FL','GA','MD','NC','SC','VA','WV','AL','KY','MS','TN',
        'AR','LA','OK','TX' ) then REGION=3;
   else if state_wave in ('AZ','CO','ID','NM','MT','UT','NV','WY','AK','CA','HI','OR','WA') then REGION=4;
/*create census divisions */
if state_wave in ('CT','ME','MA','NH','RI','VT') then DIVISION=1;
   else if state_wave in ('NJ','NY','PA') then DIVISION=2;
   else if state_wave in ('IN','IL','MI','OH','WI') then DIVISION=3;
   else if state_wave in ('IA','KS','MN','MO','NE','ND','SD') then DIVISION=4;
   else if state_wave in ('DE','DC','FL','GA','MD','NC','SC','VA','WV') then DIVISION=5;
   else if state_wave in ('AL','KY','MS','TN') then DIVISION=6;
   else if state_wave in ('AR','LA','OK','TX' ) then DIVISION=7;
   else if state_wave in ('AZ','CO','ID','NM','MT','UT','NV','WY') then DIVISION=8;
   else if state_wave in ('AK','CA','HI','OR','WA') then DIVISION=9;

/* create medicaid eligibility groupings: =>138% or <138% */
if state_wave in ('AL','AK','FL','GA','ID','KS','LA','ME','MS','MO','MT','NE','NC',
        'OK','SC','SD','TN','TX','UT','VA','WI','WY') then MEDICAID_138=0;
   else if state_wave in ('AR','AZ','CA','CO','CT','DE','DC','HI','IN','IL','IA',
        'KY','MA','MI','MN','MD','NH','ND','NM','NV','NJ','NY','OH','OR','PA',
        'RI','VT','WV','WA') then MEDICAID_138=1;
label region='Census Region: 1=NE,2=MW,3=S,4=W';
label division='Census Division';
label medicaid_138='Medicaid eligibility GE 138% FPL';
run;

proc freq data=sic_int.core_age_zip_wi_3; table state_wave region division medicaid_138; run;

/******************************************************************/
/******************************************************************/
/* Bring in Dartmouth spending data by HRR/zip xwalk  */
/******************************************************************/
/******************************************************************/

/*first get HRR - ZIP crosswalk, 2007 since using the 2003-2007 eol spending data*/
proc import
datafile="E:\data\Dartmouth_misc\Dartmouth HRR_ZIP_xwalk\ziphsahrr07.xls"
out=ziphsahrr07 dbms=xls replace;	
run;

data ziphsahrr07_1;
set ziphsahrr07(rename=(zipcode07=zip));
*zip_n = put(zip,z5.);
zip_n=zip;
label zip_n="Zip code for HRR xwalk";
drop zip;
run;

proc freq; table hrrnum; run;

/*merge in Dartmouth eol spending and HCI (2003-2007) to HRR-zip xwalk*/
proc import
datafile="E:\data\Dartmouth_misc\EOL_mc_2yrs_HRR\DAP_HRR_03_07_to_merge.xls"
out=EOL_dartmouth dbms=xls replace;
run;

data EOL_dartmouth_1;
set EOL_dartmouth;
rename HRR = HRR_number; /*note this is not the right HRR number, not sure what it is*/
rename TOTAL_MEDICARE_SPENDING=tot_eol_spending_hrr;
label TOTAL_MEDICARE_SPENDING="EOL MC spend last 2 yr of life HRR level";
run;

proc freq; table HRR_number; run;

/*merge in additional Dartmouth data for number hospital beds, specialists, physicians
This is 2006 data by HRR from Dartmouth*/
/*capacity data per capita - number beds/physicians/specialists*/
proc import datafile="E:\data\Dartmouth_misc\Dartmouth archive_ref\HRR_data_beds_specialist_per_capital.xls"
out=hrr_beds_per_capita dbms=xls
replace;
run;
proc contents ;
run;

proc freq; table HRR; run;

/*merge the two DA datasets together by hrr*/
proc sql; 
create table da_full as select
a.HRR_number, a.HRR_Name, a.HRR_State, a.tot_eol_spending_hrr, a.Hospital_care_intensity_index__s,
b.Physicians, b.Specialists, b.hospital_beds
from 
EOL_dartmouth_1 a
left join
hrr_beds_per_capita b
on a.HRR_number=b.HRR;
quit;

/*merge the DA data into the zip code/hrr list*/
proc sql;
create table zip_eol_2 as select *
from ziphsahrr07_1 a left join
da_full b
on a.hrrnum=b.HRR_number;
quit;

/*all matched using hrr number to link*/
proc means; var tot_eol_spending_hrr; run;

/*merge into the overall dataset by zip code*/
proc sql;
create table hrs_add_da as select
a.*,b.* from
sic_int.core_age_zip_wi_2 a left join
zip_eol_2 b
on a.zip_wave_n=b.zip_n;
quit;

/*check for missing da data*/
data sic_int.core_age_zip_wi_da;
set hrs_add_da ;
miss_hrr=0;
if hrr_number=. then miss_hrr=1;
label miss_hrr = "Missing HRR - zip link";
run;

proc freq; table miss_hrr; run;

/*who is missing the hrr - zip link??
64% don't have valid zip code = 99999
Rest have zip codes that aren't in the hrr-zip crosswalk file*/
data zzzz_misshrr;
set sic_int.core_age_zip_wi_da;
if miss_hrr=1;
run;

proc freq;
table zip_wave_n state_wave core_year; run;

H="Create frequency tables of core variables"
/*creates log file to review with Amy for new variables*/

capture log close

clear all
set more off

//Need to create project file paths for new dataset, logs!
//Amy's PC
local logpath E:\data\serious_ill\logs
local datapath E:\data\hrs_cleaned\working

//RG PC
//local logpath C:\data\serious_illness_cohort\logs
//local datapath C:\HRS\hrs_cleaned\working

log using "`logpath'\1_sic_new_variables.txt", text replace
cd `datapath'

***********************************************************************
//Core interview dataset
***********************************************************************
use core_98_12_nw_tics.dta //dataset without core interview dates added (all public)

//indicator, categorical variables local, want frequency tables
local catvars alz_hrs dem_hrs cancer_hrs cancer_treat_hrs heart_hrs chf_hrs chfadmit_hrs ///
lung_hrs lung_o2_hrs lung_lim_hrs dm_hrs dm_ins_hrs dm_kidn_hrs hip_frac_hrs nhres ///
nhres_start_mo nhres_start_yr nhres_2yr  hh_worker hosp_last_2yr pain_hrs pain_level_hrs ///
pain_limit_act_hrs cesd_tot cesd_tot_ge3 dyspnea_hrs swelling_feet_hrs dizzy_hrs ///
back_pain_hrs headache_hrs fatigue_hrs cough_hrs depr_2_wks_hrs insom_falling_asleep insom_waking_up ///
insom_too_early insom_rested insom_med_sleep insom_med_dr sr_memory sr_mem_change ///
pr_memory pr_mem_change adl_diff_dr adl_dr_core adl_diff_wk adl_equip_wk adl_wk_core adl_diff_bh ///
 adl_bh_core adl_diff_e adl_e_core adl_diff_tx adl_equip_tx adl_tx_core adl_diff_t adl_t_core ///
 iadl_diff_map iadl_diff_mp iadl_mp_core iadl_diff_gr iadl_gr_core iadl_diff_ph iadl_ph_core ///
 iadl_diff_rx iadl_rx_core iadl_diff_m iadl_m_core  fl_diff_wk_many fl_diff_wk_one fl_diff_sit ///
 fl_diff_gu fl_diff_sta_many fl_diff_sta_one fl_diff_stp fl_diff_reach fl_diff_push fl_diff_lift ///
 fl_diff_dime adl_sp_helper adl_oth_helper iadl_sp_helper iadl_sp_helper adl_hlp_freq_imp_ed iadl_hlp_freq_imp_ed

//continuouse variables
local contvars nh_nights hosp_stays_2yr hosp_nights_2yr TICS_tot adl_helper_count iadl_helper_count ///
adl_hlp_freq_imp_mo iadl_hlp_freq_imp_mo adl_help_hours iadl_help_hours

//describe

tab core_year, missing

foreach v in `catvars' {
tab `v' core_year, missing
}

foreach v in `contvars' {
sum `v', detail
}


***********************************************************************
//Exit interview dataset
***********************************************************************
clear 
use exit_02_12_clean.dta //exit prior to adding interview dates

local xcatvars nhres nhres_start_mo nhres_start_yr pain_hrs ///
pain_level_hrs depr_exit delirium_exit dyspnea_hrs fatigue_hrs ///
no_appet_hrs discuss dexp

foreach v in `xcatvars' {
tab `v' exit_year, missing
}

log close


H="Process Claims Relative to Core Interview Date"
/*Get claims 1 year and 2 year before each core interview*/

/*Step 1: Bring in mc xwalk id
sic_int.core_xwalk_1 has core interviews, age and claims xwalk id */

/*prepare core dataset to merge*/
proc sort data=sic_int.core_age_zip_wi_da out=core_id nodupkey;
by id c_ivw_date;
run;

/*prepare xwalk id file to merge*/
data crosswalk_1;
set medi.cmsxref2012;
keep bid_hrs_21 hhid pn;
run;

/*get 2 variables bid_hrs = claims id, id=HRS id*/
data crosswalk_2;
set crosswalk_1;
bid_hrs=bid_hrs_21;
id=trim(hhid)||trim(pn);
drop hhid pn;
drop bid_hrs_21;
run;

proc sort data= crosswalk_2;
by id;
run;

/*bring in xwalk id to core interview dataset*/
proc sql;
create table core_xwalk as select
a.*,b.bid_hrs from
core_id a
left join
crosswalk_2 b
on a.id=b.id;
quit;

/*check for missing xwalk ids
47839 of 157534 interviews are missing xwalk ids*/
data check1;
set core_xwalk ;
if bid_hrs ='';
run;

/*create indicator for having xwalk id*/
data core_xwalk_1;
set core_xwalk;
xwalk_yes=.;
if bid_hrs ='' then xwalk_yes=0;
if bid_hrs~='' then xwalk_yes=1;
run;

/*most that are missing are <65 years old*/
proc freq;
table xwalk_yes*core_year /missprint;
table age_at_core*xwalk_yes; 
run;

/*export this dataset to Stata for a check of the demo differences
R link to MC claims vs no*/
proc export data=core_xwalk_1
outfile="E:\data\serious_ill\int_data\core_xwalk_1.dta" replace;
run;

/*just get information needed to grab claims, drop rest of interview data
So pulls all interviews for r's with the mc linkage
91386 interviews have linkage*/
data sic_int.core_lmt_xwalk_2;
set core_xwalk_1(keep=id core_year c_ivw_date c_ivw_year c_ivw_month age_at_core bid_hrs xwalk_yes wage_index_2012_2);
if xwalk_yes=1;
run;

/********************************************************************/
/* Get claims death date, from denominator file as a check
where dod from interview is imputed or after exit interview date */
/********************************************************************/
proc sort data=medi.dn_2000_2012 out=dn_dod_1  nodupkey;
by BID_HRS_21 year;
run;

/*just keep dod from last year*/
data dn_dod_2;
set dn_dod_1;
by BID_HRS_21 year;
if last.BID_HRS_21;
run;

proc freq;
table death_dt /missprint;
run;

/*add to the core dataset with xwalk id*/
proc sort data=core_xwalk_1; by bid_hrs; run;

proc sql;
create table sic_int.core_xwalk_2 as select a.*,b.death_dt as dod_claims
from core_xwalk_1 a left join
dn_dod_2 b
on a.bid_hrs=b.BID_HRS_21;
quit;


H="Step 2a - Identify FFS MC 1yr and 6mos preceeding core interview"
/*Use denominator file to determine which interviews / r's have ffs mc
during the full 12 months preceeding the core interview

2 sets of variables created, 1 for 12 month lookback,
one for 6 month lookback to see what the difference in sample
size would be with the more relaxed requirement*/

proc sort data=medi.dn_2000_2012 out=dn_2000_20122  nodupkey;
by BID_HRS_21 year;
run;

proc sort data=sic_int.core_lmt_xwalk_2 out=core_mc_ids nodupkey;
by bid_hrs c_ivw_year;
run;

proc freq;
table c_ivw_year;
run;

*8 obs have missing core year;
proc freq data=core_mc_ids; table c_ivw_year /missprint; run;

data core_year_test; set core_mc_ids; if c_ivw_year=.; run;

/*pull medicare and hmo status variables from dn file
for the core interview years
interviews are dropped if they don't have a matching dn entry that year*/
proc sql;
create table dn_core_y as select
a.*,b.buyin12,b.year,b.HMOIND12
from core_mc_ids a inner join
dn_2000_20122 b
on trim(left(a.BID_hrs))=trim(left(b.BID_hrs_21))
and a.c_ivw_year=b.year;
quit;

proc freq data=dn_core_y ;
table c_ivw_year c_ivw_month age_at_core;
run;

/*18127 r's have at least 1 interview with a denominator file linked*/
proc sql;
select count(distinct BID_hrs) from dn_core_y ;
quit;

data dn_core_y2;
set dn_core_y;
if length(trim(left(buyin12)))=12 and c_ivw_month>0 then do;
buyin_dy=substr(trim(left(buyin12)),1,c_ivw_month);
hmo_dy=substr(trim(left(HMOIND12)),1,c_ivw_month);
end;
else do;
buyin_dy=trim(left(buyin12));
hmo_dy=trim(left(HMOIND12));
end;
format c_ivw_date date9.;
run;
proc means n;
var  c_ivw_month;
run;

/*Check year prior to core interview to backfill for interview dates
in the first half of the year (since doing 12 mo look back)*/
/* 62565 have the -1 year dn file*/
proc sql;
create table dn_core_y_bef as select
a.BID_hrs,a.c_ivw_year ,
b.year as c_ivw_year_bef,
b.year,b.buyin12,b.HMOIND12
from dn_core_y a inner join
dn_2000_20122 b
on trim(left(a.BID_hrs))=trim(left(b.BID_hrs_21))
and 0<a.c_ivw_year-b.year<=1 order by bid_hrs,c_ivw_year;
quit;

proc sql;
create table all_insurance as select a.*,b.year as year_bef_civw, 
b.buyin12 as buyin_bef,b.HMOIND12 as hmo_bef from
dn_core_y2 a
left join
dn_core_y_bef b
on trim(left(a.BID_hrs))=trim(left(b.BID_hrs)) 
and a.c_ivw_year=b.c_ivw_year;
quit;

proc freq data=all_insurance;
table c_ivw_year*year_bef_civw /missprint;
run;

/*merge interview year and year before interview buy-in and hmo variables
Trim so the final variable _12m is 12 months pre-interview
Note: indicator variables for parts a and b and hmo are null if don't
have information for full 12 months pre-interview*/
data all_insurance2;
set all_insurance;
buyin_2y=trim(left(buyin_bef))||trim(left(buyin_dy));
hmo_2y=trim(left(hmo_bef))||trim(left(hmo_dy));

buyin_2y_r=reverse(trim(buyin_2y));
hmo_2y_r=reverse(trim(hmo_2y));

*************************************************;
** 12 month variables                          **;
*************************************************;
if length(buyin_2y_r)>11 then buyin_12m_r=substr(trim(left(buyin_2y_r)),1,12);
if length(hmo_2y_r)>11 then hmo_12m_r=substr(trim(left(hmo_2y_r)),1,12);

if length(buyin_2y_r)<12 then buyin_12m_r="";
if length(hmo_2y_r)<12 then hmo_12m_r="";

buyin_12m=reverse(trim(buyin_12m_r));
hmo_12m=reverse(trim(hmo_12m_r));

/*create indicator variable for mc coverage 12 mo. 0=no, 1=yes*/
if length(buyin_12m)=12 then do;
if indexc(buyin_12m,"0","1","2","A","B") then part_ab_12m=0;
if indexc(buyin_12m,"0","1","2","A","B")=0 then part_ab_12m=1;
end;
if length(hmo_12m)=12 then do;
if index(hmo_12m,"00000000000") then hmo_d_12m=0;
if index(hmo_12m,"00000000000")=0 then hmo_d_12m=1;
end;

*************************************************;
** 6 month variables                          **;
*************************************************;
if length(buyin_2y_r)>5 then buyin_6m_r=substr(trim(left(buyin_2y_r)),1,6);
if length(hmo_2y_r)>5 then hmo_6m_r=substr(trim(left(hmo_2y_r)),1,6);

if length(buyin_2y_r)<6 then buyin_6m_r="";
if length(hmo_2y_r)<6 then hmo_6m_r="";

buyin_6m=reverse(trim(buyin_6m_r));
hmo_6m=reverse(trim(hmo_6m_r));

/*create indicator variable for mc coverage 6 mo. 0=no, 1=yes*/
if length(buyin_6m)=6 then do;
if indexc(buyin_6m,"0","1","2","A","B") then part_ab_6m=0;
if indexc(buyin_6m,"0","1","2","A","B")=0 then part_ab_6m=1;
end;
if length(hmo_6m)=6 then do;
if index(hmo_6m,"000000") then hmo_d_6m=0;
if index(hmo_6m,"000000")=0 then hmo_d_6m=1;
end;

if part_ab_12m=1 & hmo_d_12m=0 then ffs_yes_12m=1;
if part_ab_12m=0 | hmo_d_12m=1 then ffs_yes_12m=0;
if part_ab_6m=1 & hmo_d_6m=0 then ffs_yes_6m=1;
if part_ab_6m=0 | hmo_d_6m=1 then ffs_yes_6m=0;
 
run;

/*13875 observations don't have full denominator data re insurance status
either interview Before Jan 2001 (11386 ivws) or are missing year -1 dn file
*/
proc freq;
table part_ab_12m hmo_d_12m part_ab_12m*age_at_core part_ab_6m hmo_d_6m;
run;

proc freq;
table ffs_yes_12m ffs_yes_6m ;
run; 

data missdn;
set all_insurance2;
if ffs_yes_12m=.;
run;

proc freq; table c_ivw_year; run;

/*bring indicators into full interview dataset*/
proc sql;
create table sic_int.core_xwalk_ins as select a.*,b.part_ab_12m,b.hmo_d_12m,b.part_ab_6m,b.hmo_d_6m
 from
sic_int.core_xwalk_2 a left join
all_insurance2 b
on a.bid_hrs=b.bid_hrs and a.c_ivw_year=b.c_ivw_year;
quit;

proc freq data=sic_int.core_xwalk_ins;
table age_ge_65*part_ab_12m age_ge_65*part_ab_6m /missprint;
run;

/*look into missing medicare status 12m preceding the interview*/
/*94905 missing insurance info for 12m lookback from ivw*/
data miss_ins1;
set sic_int.core_xwalk_ins;
if part_ab_12m=.;
run;

proc freq; table xwalk_yes; run;
*47839 don't have xwalk;

data miss_ins2;
set miss_ins1;
if xwalk_yes=0;
run;

*of remaining 47066 with xwalk, why missing? most explained by interiew timing and age;
*6776 (3346+233+3197) have core 2000 or earlier;
*1147 had 2013 interviews;
*35332 (41385-951-3027-210-2816) are < 65 at the interview;
proc freq; table c_ivw_year*age_ge_65; run;





H="Step 2 - Get claims"
/*Get claims 1 year and 2 year before each core interview*/

/*Step 2: Pull claims lists using mc xwalk id and interview date
Save claims lists to project folder for use later */

/*get a copy of the dataset with just ffs medicare ivws age 65+
use this list to pull the claims lists
n=40481 - just check claims for those that meet analysis criteria*/
data sic_int.core_xwalk_ins_ffs_only;
set sic_int.core_xwalk_ins(keep=bid_hrs c_ivw_date c_ivw_year core_year part_ab_12m hmo_d_12m age_ge_65);
if part_ab_12m=1 & hmo_d_12m=0 & age_ge_65=1;
run;

/****************************************************************************/
/* Macro to pull claims lists, saves lists to int_data folder               */
/****************************************************************************/

/*macros to create claims lists, one for all but medpar, one for medpar*/
%macro other(days_start=,days_bef_core=,source= );

proc sql;
create table &source._meet_&days_bef_core. as select a.*,b.c_ivw_date,b.core_year
from medi.&source._2000_2012 a inner join
sic_int.core_xwalk_ins_ffs_only b
on trim(left(a.bid_hrs_21))=trim(left(b.bid_hrs))
and &days_start<=b.c_ivw_date-a.admit_date<=&days_bef_core;
quit;

%mend;


%macro mp(days_start=,days_bef_core=,source=,time_label=);

proc sql;
create table &source._meet as select a.*,b.c_ivw_date,b.core_year
from medi.&source._2000_2012 a inner join
sic_int.core_xwalk_ins_ffs_only b
on trim(left(a.bid_hrs_21))=trim(left(b.bid_hrs))
and &days_start<=b.c_ivw_date-a.admit_date<=&days_bef_core;
quit;

proc sql;
create table &source._meet2 as select a.*,b.c_ivw_date,b.core_year
from medi.&source._2000_2012 a inner join
sic_int.core_xwalk_ins_ffs_only b
on trim(left(a.bid_hrs_21))=trim(left(b.bid_hrs))
and b.c_ivw_date-a.admit_date>&days_bef_core and b.c_ivw_date-a.disch_date<=&days_bef_core;
quit;

data &source._meet3_&days_bef_core.;
set &source._meet &source._meet2;
run;

%mend;

/*run to get claims list 6 months pre-core for medpar
Use to get indicator of hospitalizations 6 m prior to interview*/
%mp(days_start=0,days_bef_core=183,source=mp );

/*run to get claims lists 1 year pre-core
Datasets are sic_int.mp_meet3_365, sic_int.hh_meet_365, etc.*/
%mp(days_start=0,days_bef_core=365,source=mp );

%other(days_start=0,days_bef_core=365,source=hh );
%other(days_start=0,days_bef_core=365,source=hs );
%other(days_start=0,days_bef_core=365,source=dm);
%other(days_start=0,days_bef_core=365,source=op );
%other(days_start=0,days_bef_core=365,source=pb );

/*run to get claims lists 2 years pre-core
Datasets are sic_int.mp_meet3_730, sic_int.hh_meet_730, etc.*/
%mp(days_start=0,days_bef_core=730,source=mp );
%other(days_start=0,days_bef_core=730,source=hh );
%other(days_start=0,days_bef_core=730,source=hs );
%other(days_start=0,days_bef_core=730,source=dm );
%other(days_start=0,days_bef_core=730,source=op );
%other(days_start=0,days_bef_core=730,source=pb );

/****************************************************************************/
/*Run medpar code on the ip claims list to get ip claims 1 year pre-core
Use these ip claims for the hip fracture determination*/
%mp(days_start=0,days_bef_core=365,source=ip );

/****************************************************************************/
/*prior to saving the permanent claims datasets, drop unneeded variables
this speeds up runnnig code later on*/

/*mp claims*/
%macro mp_drop(days_bef_core=);
data sic_int.mp_meet3_&days_bef_core.;
set mp_meet3_&days_bef_core.(keep=bid_hrs_21 core_year c_ivw_date admit_date disch_date 
 SSLSSNF icarecnt CRNRYDAY type_adm ER_AMT AD_DGNS DGNS_CD01-DGNS_CD25 PRCDR_CD01-PRCDR_CD25 
 PRCDR_DT01-PRCDR_DT25 );
run;
%mend mp_drop;

/*hh*/
%macro hh_drop(days_bef_core=);
data sic_int.hh_meet_&days_bef_core.;
set hh_meet_&days_bef_core.(keep=bid_hrs_21 core_year c_ivw_date PDGNS_CD DGNSCD01-DGNSCD25 );
run;
%mend hh_drop;

/*hs*/
%macro hs_drop(days_bef_core=);
data sic_int.hs_meet_&days_bef_core.;
set hs_meet_&days_bef_core.(keep=bid_hrs_21 core_year c_ivw_date PDGNS_CD DGNSCD01-DGNSCD25 );
run;
%mend hs_drop;

/*dme*/
%macro dm_drop(days_bef_core=);
data sic_int.dm_meet_&days_bef_core.;
set dm_meet_&days_bef_core.(keep=bid_hrs_21 core_year c_ivw_date admit_date BETOS01:BETOS13
PDGNS_CD DGNSCD01-DGNSCD12 );
run;
%mend dm_drop;

/*op*/
%macro op_drop(days_bef_core=);
data sic_int.op_meet_&days_bef_core.;
set op_meet_&days_bef_core.(keep=bid_hrs_21 core_year c_ivw_date admit_date disch_date
 RVCNTR01-RVCNTR45 PDGNS_CD DGNSCD01-DGNSCD25 );
run;
%mend op_drop;

/*ip*/
%macro ip_drop(days_bef_core=);
data sic_int.ip_meet3_&days_bef_core.;
set ip_meet3_&days_bef_core.(keep=bid_hrs_21 core_year c_ivw_date admit_date disch_date
 HCPSCD01-HCPSCD45 );
run;
%mend ip_drop;

/*carrier*/
%macro pb_drop(days_bef_core=);
data sic_int.pb_meet_&days_bef_core.;
set pb_meet_&days_bef_core.(keep=bid_hrs_21 core_year c_ivw_date FROM_DT THRU_DT admit_date disch_date
 HCPSCD01-HCPSCD13 PDGNS_CD DGNSCD01-DGNSCD12 );
run;
%mend pb_drop;

%mp_drop(days_bef_core=183);
%mp_drop(days_bef_core=365);
%mp_drop(days_bef_core=730);
%hh_drop(days_bef_core=365);
%hh_drop(days_bef_core=730);
%hs_drop(days_bef_core=365);
%hs_drop(days_bef_core=730);
%dm_drop(days_bef_core=365);
%dm_drop(days_bef_core=730);
%op_drop(days_bef_core=365);
%op_drop(days_bef_core=730);
%pb_drop(days_bef_core=365);
%pb_drop(days_bef_core=730);
%ip_drop(days_bef_core=365);


/****************************************************************************/
/****************************************************************************/
/* Macro to pull dx from claims lists, saves dx lists to int_data folder    */
/****************************************************************************/

%macro dx_time_range(range1=, range2=, days_bef_core=);

/*Process carrier medicare claims to pull out dx codes
Multiple lines per each BID*/
data pb_last_&range2._dx(keep=bid_hrs_21 core_year diag);
set sic_int.pb_meet_&days_bef_core.(keep=bid_hrs_21 core_year PDGNS_CD DGNSCD01-DGNSCD12 );
array dx PDGNS_CD DGNSCD01-DGNSCD12;
do over dx;
diag=dx ;
output;
end;
run;
/*check for and remove duplicates, note this doesn't remove blanks*/
proc sort data=pb_last_&range2._dx out=pb_last_&range2._dx2 nodupkey;
by bid_hrs_21 core_year diag;
run;


/*Process outpatient medicare claims to pull out dx codes
Dataset being created: op_last_&range2._dx2*/
data op_last_&range2._dx(keep=bid_hrs_21 core_year diag);
set sic_int.op_meet_&days_bef_core.(keep=bid_hrs_21 core_year PDGNS_CD DGNSCD01-DGNSCD25  );
array dx PDGNS_CD DGNSCD01-DGNSCD25 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=op_last_&range2._dx out=op_last_&range2._dx2 nodupkey;
by bid_hrs_21 core_year diag;
run;

/*Process medpar medicare claims to pull out dx codes
Dataset being created: mp_last_&range2._dx2*/
data mp_last_&range2._dx(keep=bid_hrs_21 core_year diag);
set sic_int.mp_meet3_&days_bef_core.(keep=bid_hrs_21 core_year AD_DGNS  DGNS_CD01-DGNS_CD25 );
array dx AD_DGNS  DGNS_CD01-DGNS_CD25 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=mp_last_&range2._dx out=mp_last_&range2._dx2 nodupkey;
by bid_hrs_21 core_year diag;
run;

/*Process dme medicare claims to pull out dx codes
Dataset being created: dm_last_&range2._dx2*/
data dm_last_&range2._dx(keep=bid_hrs_21 core_year diag);
set sic_int.dm_meet_&days_bef_core.(keep=bid_hrs_21 core_year PDGNS_CD DGNSCD01-DGNSCD12 );
array dx PDGNS_CD DGNSCD01-DGNSCD12 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=dm_last_&range2._dx out=dm_last_&range2._dx2 nodupkey;
by bid_hrs_21 core_year diag;
run;

/*Process hh medicare claims to pull out dx codes
Dataset being created: dm_last_&range2._dx2*/
data hh_last_&range2._dx(keep=bid_hrs_21 core_year diag);
set sic_int.hh_meet_&days_bef_core.(keep=bid_hrs_21 core_year PDGNS_CD DGNSCD01-DGNSCD25 );
array dx PDGNS_CD DGNSCD01-DGNSCD25 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=hh_last_&range2._dx out=hh_last_&range2._dx2 nodupkey;
by bid_hrs_21 core_year diag;
run;

/*Process hs medicare claims to pull out dx codes
Dataset being created: dm_last_&range2._dx2*/
data hs_last_&range2._dx(keep=bid_hrs_21 core_year diag);
set sic_int.hs_meet_&days_bef_core.(keep=bid_hrs_21 core_year PDGNS_CD DGNSCD01-DGNSCD25 );
array dx PDGNS_CD DGNSCD01-DGNSCD25 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=hs_last_&range2._dx out=hs_last_&range2._dx2 nodupkey;
by bid_hrs_21 core_year diag;
run;


/*set diag variable length = 7 chars since that's the max length from the mc claims
Need to do this because length varies across the different mc claim types*/
data hs_last_&range2._dx3;
length diag $7;
set hs_last_&range2._dx2;
run;
data hh_last_&range2._dx3;
length diag $7;
set hh_last_&range2._dx2;
run;
data mp_last_&range2._dx3;
length diag $7;
set mp_last_&range2._dx2;
run;
data dm_last_&range2._dx3;
length diag $7;
set dm_last_&range2._dx2;
run;
data op_last_&range2._dx3;
length diag $7;
set op_last_&range2._dx2;
run;
data pb_last_&range2._dx3;
length diag $7;
set pb_last_&range2._dx2;
run;


/*merge diagnoses from each claim type into single dataset*/
data dx_all_last_&range2.;
set hs_last_&range2._dx3
hh_last_&range2._dx3
mp_last_&range2._dx3
dm_last_&range2._dx3
op_last_&range2._dx3
pb_last_&range2._dx3;
run;
proc sort data=dx_all_last_&range2.(where=(diag~="")) out=sic_int.dx_&range1._&range2 nodupkey;
by bid_hrs_21 core_year diag;
run;

%mend;

/*1 and 2 years pre-interview: sic_int.dx_0_1yr, sic_int.dx_0_2yr */
%dx_time_range(range1=0, range2=1yr, days_bef_core=365);
%dx_time_range(range1=0, range2=2yr, days_bef_core=730);

data zzzdx_test;
set sic_int.dx_0_1yr;
core_year_c=put(core_year,z4.);
run;

/*39024 ffs mc interviews have at least 1 dx code 1 year preceeding the interview*/
proc sql;
select count (distinct bid_hrs_21||core_year_c) from zzzdx_test;
quit;

/*check for frequency of DX codes by bid,core year
Need to use datasets in work folder before removing duplicates*/
data dx_all_last_1yr_w_dups;
set hs_last_1yr_dx
hh_last_1yr_dx
mp_last_1yr_dx
dm_last_1yr_dx
op_last_1yr_dx
pb_last_1yr_dx;
if diag~='.';
run;

proc sort data=dx_all_last_1yr_w_dups;
by bid_hrs_21 core_year diag;
run;

proc sql;
create table zzzdx_freq as select distinct BID_hrs_21,core_year,diag, 
count(*) as n_dx_freq label="count times icd9 dx coded, 12m pre-core"
 from dx_all_last_1yr_w_dups group by BID_hrs_21,core_year,diag;
quit;

proc freq;
table n_dx_freq ;
run;

proc sort data=zzzdx_freq ;
by n_dx_freq;
run;

data zzzdx_chf;
set zzzdx_freq ;
if substr(diag,1,3)='428';
run;

/*****************************************/
/*check dementia diagnosis frequencies, need to pull this into main dataset
dx list is from Elixhauser code*/
data dem_dx_freq;
set dx_all_last_1yr_w_dups;
	dementia=0;
	if (substr(diag,1,4) in ('3310','3311','3312','2900','2901',
             '2902','2903','2912','2948','2949') or
		substr(diag,1,5) in ('29410','29411','29040','29041','29042','29043')) 
		and dementia=0 
          then dementia=1;
run;

proc freq; table dementia; run;

/*this is merged into the main dataset when the elixhauser indicator variables 
in the next section*/
proc sql;
create table sic_int.dem_dx_freq_2 as select distinct BID_hrs_21,core_year,
sum(dementia) as dem_dx_1yr label="count dementia dx 1yr pre core ivw"
 from dem_dx_freq group by BID_hrs_21,core_year;
quit;

proc freq; table dem_dx_1yr; run;


H="Step 3 - Elixhauser comorbidities"
/*Note elixhauser comorbidities diagnosis lists are modified for the 
purposes of this project, do not copy and paste this Elixhauser code 
for use in other projects!!
*/

/****************************************************************************/
/* Rename variables macro                                                   */
/****************************************************************************/

%macro rename(lib,dsn,pre);
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "Before Renaming All Variables";
run;
proc sql noprint;
select nvar into :num_vars
from dictionary.tables
where libname="&LIB" and
memname="&DSN";
select distinct(name) into :var1-
:var%TRIM(%LEFT(&num_vars))
from dictionary.columns
where libname="&LIB" and
memname="&DSN";
quit;
run;
proc datasets library=&LIB;
modify &DSN;
rename
%do i=1 %to &num_vars;
&&var&i=&&var&i.._&pre 
%end;
;
quit;
run;
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "After Renaming All Variables";
run;
%mend rename;




/****************************************************************************/
/* Elixhauser comorbidities macro                                           */
/****************************************************************************/
/*Note elixhauser comorbidities diagnosis lists are modified for the 
purposes of this project, do not copy and paste this Elixhauser code 
for use in other projects!!*/

%macro elixhauser(range1=, range2=);

data dx_31_comor;
set sic_int.dx_&range1._&range2(rename=(diag=dx_0));
dx=trim(left(dx_0));

if dx~="" then do;

comorbi_1=0;
comorbi_2=0;
comorbi_3=0;
comorbi_4=0;
comorbi_5=0;
comorbi_6=0;
comorbi_7=0;
comorbi_8=0;
comorbi_9=0;
comorbi_10=0;
comorbi_11=0;
comorbi_12=0;
comorbi_13=0;
comorbi_14=0;
comorbi_15=0;
comorbi_16=0;
comorbi_17=0;
comorbi_18=0;
comorbi_19=0;
comorbi_20=0;
comorbi_21=0;
comorbi_22=0;
comorbi_23=0;
comorbi_24=0;
comorbi_25=0;
comorbi_26=0;
comorbi_27=0;
comorbi_28=0;
comorbi_29=0;
comorbi_30=0;
*end of intialize of 30 binary variables;
*add dementia and CAD and ALS;
dementia=0;
cad=0;
als=0;
renal_dis=0;

*do over dx;
	*Congestive Heart Failure;
	if (substr(dx,1,5)='39891' or
		substr(dx,1,5)='40211' or
		substr(dx,1,5)='40291' or
		substr(dx,1,5)='40411' or
		substr(dx,1,5)='40413' or
		substr(dx,1,5)='40491' or
		substr(dx,1,5)='40493' or
		substr(dx,1,3)='428') 
		and comorbi_1=0 
		then comorbi_1=1;*add one binary variables here.;
	*Cariac Arrhythmias;
	if (substr(dx,1,5)='42610' or
		substr(dx,1,5)='42611' or
		substr(dx,1,5)='42613' or
		substr(dx,1,4)='4262' or
		substr(dx,1,4)='4263' or
		substr(dx,1,4)='4264' or
		substr(dx,1,5)='42650' or
		substr(dx,1,5)='42651' or
		substr(dx,1,5)='42652' or
		substr(dx,1,5)='42653' or
		substr(dx,1,4)='4266' or
		substr(dx,1,4)='4267' or
		substr(dx,1,4)='4268' or
		substr(dx,1,4)='4270' or
		substr(dx,1,4)='4272' or
		substr(dx,1,5)='42731' or
		substr(dx,1,5)='42760' or
		substr(dx,1,4)='4279' or
		substr(dx,1,4)='7850' or
		substr(dx,1,4)='V450' or
		substr(dx,1,4)='V533')
			and comorbi_2=0 
		then comorbi_2=1;
	* Valvular Disease ;
	if (substr(dx,1,5)='09320' or
		substr(dx,1,5)='09321' or
		substr(dx,1,5)='09322' or
		substr(dx,1,5)='09323' or
		substr(dx,1,5)='09324' or
		substr(dx,1,3)='394' or
		substr(dx,1,3)='395' or
		substr(dx,1,3)='396' or
		substr(dx,1,4)='3970' or
		substr(dx,1,4)='3971' or
		substr(dx,1,4)='4240' or
		substr(dx,1,4)='4241' or
		substr(dx,1,4)='4242' or
		substr(dx,1,4)='4243' or
		substr(dx,1,4)='4244' or
		substr(dx,1,4)='4245' or
		substr(dx,1,4)='4246' or
		substr(dx,1,4)='4247' or
		substr(dx,1,4)='4248' or
		substr(dx,1,5)='42490' or
		substr(dx,1,5)='42491' or
		substr(dx,1,4)='7463' or
		substr(dx,1,4)='7464' or
		substr(dx,1,4)='7465' or
		substr(dx,1,4)='7466' or
		substr(dx,1,4)='V422' or
		substr(dx,1,4)='V433')
			and comorbi_3=0 
		then comorbi_3=1;
	*Pulmonary Circulation Disorders;
	if (substr(dx,1,3)='416' or
		substr(dx,1,4)='4179')
			and comorbi_4=0 
		then comorbi_4=1;
	*Peripheral Vascular Disorders;
	if (substr(dx,1,3)='440' or
		substr(dx,1,4)='4412' or
		substr(dx,1,4)='4414' or
		substr(dx,1,4)='4417' or
		substr(dx,1,4)='4419' or
		substr(dx,1,4)='4431' or
		substr(dx,1,4)='4432' or
		substr(dx,1,4)='4438' or
		substr(dx,1,4)='4439' or
		substr(dx,1,4)='4471' or
		substr(dx,1,4)='5571' or
		substr(dx,1,4)='5579' or
		substr(dx,1,4)='V434')
			and comorbi_5=0 
		then comorbi_5=1;
	*Hypertension;
	if ((substr(dx,1,4)='4011' or
		substr(dx,1,4)='4019')) or
	   ((substr(dx,1,5)='40210' or
		substr(dx,1,5)='40290' or
		substr(dx,1,5)='40410' or
		substr(dx,1,5)='40490' or
		substr(dx,1,5)='40511' or
		substr(dx,1,5)='40519' or
		substr(dx,1,5)='40591' or
		substr(dx,1,5)='40599')) 
			and comorbi_6=0 
		then comorbi_6=1;
	*Paralysis;	
	if (substr(dx,1,4)='3420' or
		substr(dx,1,5)='34210' or
		substr(dx,1,5)='34211' or
		substr(dx,1,5)='34212' or
		substr(dx,1,4)='3429' or
		substr(dx,1,3)='343' or
		substr(dx,1,3)='344')
			and comorbi_7=0 
		then comorbi_7=1;
	*Other Neurological Disorders;
	if (substr(dx,1,4)='3319' or
		substr(dx,1,4)='3320' or
		substr(dx,1,4)='3334' or
		substr(dx,1,4)='3335' or
		substr(dx,1,3)='334' or
		substr(dx,1,3)='335' or
		substr(dx,1,3)='340' or
		substr(dx,1,4)='3411' or
		substr(dx,1,4)='3418' or
		substr(dx,1,4)='3419' or
		substr(dx,1,5)='34500' or
		substr(dx,1,5)='34501' or
		substr(dx,1,5)='34510' or
		substr(dx,1,5)='34511' or
		substr(dx,1,4)='3454' or
		substr(dx,1,5)='34550' or
		substr(dx,1,5)='34551' or
		substr(dx,1,4)='3458' or
		substr(dx,1,5)='34590' or
		substr(dx,1,5)='34591' or
		substr(dx,1,4)='3481' or
		substr(dx,1,4)='3483' or
		substr(dx,1,4)='7803' or
		substr(dx,1,4)='7843') 
			and comorbi_8=0 
		then comorbi_8=1;	
	*Chronic Pulmonary Disease;
	if (substr(dx,1,3)='490' or
		substr(dx,1,3)='491' or
		substr(dx,1,3)='492' or
		substr(dx,1,4)='4930' or
		substr(dx,1,4)='4931' or
		substr(dx,1,4)='4932' or
		substr(dx,1,4)='4938' or
		substr(dx,1,5)='49390' or
		substr(dx,1,5)='49391' or
		substr(dx,1,3)='494' or
		substr(dx,1,3)='495' or
		substr(dx,1,3)='496' or
		substr(dx,1,3)='497' or
		substr(dx,1,3)='498' or
		substr(dx,1,3)='499' or
		substr(dx,1,3)='500' or
		substr(dx,1,3)='501' or
		substr(dx,1,3)='502' or
		substr(dx,1,3)='503' or
		substr(dx,1,3)='504' or
		substr(dx,1,3)='505' or
		substr(dx,1,4)='5064') 
			and comorbi_9=0 
		then comorbi_9=1;	
	*Diabetes, uncomplicated;
	if (substr(dx,1,4)='2500' or
		substr(dx,1,4)='2501' or
		substr(dx,1,4)='2502' or
		substr(dx,1,4)='2503') 
			and comorbi_10=0 
		then comorbi_10=1;
	*Diabetes, complicated;
	if (substr(dx,1,4)='2504' or
		substr(dx,1,4)='2505' or
		substr(dx,1,4)='2506' or
		substr(dx,1,4)='2507' or
		substr(dx,1,4)='2509') 
			and comorbi_11=0 
		then comorbi_11=1;
	*Hypothyroidism;
	if (substr(dx,1,3)='243' or
		substr(dx,1,4)='2440' or
		substr(dx,1,4)='2441' or
		substr(dx,1,4)='2442' or
		substr(dx,1,4)='2448' or
		substr(dx,1,4)='2449') 	
			and comorbi_12=0 
		then comorbi_12=1;
	*Renal Failure;
	*Original list modified to drop 2 codes  585 and V568;
	if (substr(dx,1,5)='40311' or
		substr(dx,1,5)='40391' or
		substr(dx,1,5)='40412' or
		substr(dx,1,5)='40492' or
		substr(dx,1,3)='586' or
		substr(dx,1,4)='V420' or
		substr(dx,1,4)='V451' or
		substr(dx,1,4)='V560') 
			and comorbi_13=0 
		then comorbi_13=1;
	*Advanced Liver Disease or Cirrhosis;
	*Code list modified from orig Elix;
	*572.4 hepatorenal syndrome must be added; 
	*Remove '07032' or  chronic hep B, '07033' or  chronic hep B, '07054' or  chronic hep C, '5713' or  alcoholic liver damage, '5714' or  chronic hepatitis;
	if (substr(dx,1,4)='4560' or
		substr(dx,1,4)='4561' or
		substr(dx,1,5)='45620' or
		substr(dx,1,5)='45621' or
		substr(dx,1,4)='5710' or
		substr(dx,1,4)='5712' or
		substr(dx,1,4)='5715' or
		substr(dx,1,4)='5716' or
		substr(dx,1,4)='5718' or
		substr(dx,1,4)='5719' or
		substr(dx,1,4)='5723' or
		substr(dx,1,4)='5724' or
		substr(dx,1,4)='5728' or
		substr(dx,1,4)='V427') 
			and comorbi_14=0 
		then comorbi_14=1;
	*Peptic Ulcer Disease excluding bleeding;
	if (substr(dx,1,5)='53170' or
		substr(dx,1,5)='53190' or
		substr(dx,1,5)='53270' or
		substr(dx,1,5)='53290' or
		substr(dx,1,5)='53370' or
		substr(dx,1,5)='53390' or
		substr(dx,1,5)='53470' or
		substr(dx,1,5)='53490' or
		substr(dx,1,5)='V1271') 
			and comorbi_15=0 
		then comorbi_15=1;
	*AIDS;
	if (substr(dx,1,3)='042' or
		substr(dx,1,3)='043' or
		substr(dx,1,3)='044') 
			and comorbi_16=0 
		then comorbi_16=1;
	*Lymphoma;
	if (substr(dx,1,3)='200' or
		substr(dx,1,3)='201' or
		substr(dx,1,4)='2020' or
		substr(dx,1,4)='2021' or
		substr(dx,1,4)='2022' or
		substr(dx,1,4)='2023' or
		substr(dx,1,4)='2025' or
		substr(dx,1,4)='2026' or
		substr(dx,1,4)='2027' or
		substr(dx,1,4)='2028' or
		substr(dx,1,4)='2029' or
		substr(dx,1,4)='2030' or
		substr(dx,1,4)='2038' or
		substr(dx,1,4)='2386' or
		substr(dx,1,4)='2733' or
		substr(dx,1,5)='V1071' or
		substr(dx,1,5)='V1072' or
		substr(dx,1,5)='V1079')
			and comorbi_17=0 
		then comorbi_17=1;
	*Metastatic Cancer or Hematologic Cancer;
	*Modified to add lukemias;
	if (substr(dx,1,3)='196' or
		substr(dx,1,3)='197' or
		substr(dx,1,3)='198' or
		substr(dx,1,3)='199' or
		substr(dx,1,3)='204' or
		substr(dx,1,3)='205' or
		substr(dx,1,3)='206' or
		substr(dx,1,3)='207' or
		substr(dx,1,3)='208') 
			and comorbi_18=0 
		then comorbi_18=1;	
	*Solid Tumor without Metastisis;
	if (substr(dx,1,2)='14' or
		substr(dx,1,2)='15' or
		substr(dx,1,2)='16' or
		substr(dx,1,3)='170' or
		substr(dx,1,3)='171' or
		substr(dx,1,3)='172' or
		substr(dx,1,3)='174' or
		substr(dx,1,3)='175' or
		substr(dx,1,3)='179' or
		substr(dx,1,2)='18' or
		substr(dx,1,3)='190' or
		substr(dx,1,3)='191' or
		substr(dx,1,3)='192' or
		substr(dx,1,3)='193' or
		substr(dx,1,3)='194' or
		substr(dx,1,3)='195' or
		substr(dx,1,3)='V10')
			and comorbi_19=0 
		then comorbi_19=1;
	*Rheumatoid Arthritis/Collagen Vascular Diseases;
	if (substr(dx,1,4)='7010' or
		substr(dx,1,3)='710' or
		substr(dx,1,3)='714' or
		substr(dx,1,3)='720' or
		substr(dx,1,3)='725') 
			and comorbi_20=0 
		then comorbi_20=1;
	*Coagulopathy;
	if (substr(dx,1,3)='286' or
		substr(dx,1,4)='2871' or
		substr(dx,1,4)='2873' or
		substr(dx,1,4)='2874' or
		substr(dx,1,4)='2875') 
			and comorbi_21=0 
		then comorbi_21=1;
	*Obesity;
	if (substr(dx,1,4)='2780')  
			and comorbi_22=0 
		then comorbi_22=1;
	*Weight Loss;
	if (substr(dx,1,3)='260' or
		substr(dx,1,3)='261' or
		substr(dx,1,3)='262' or
		substr(dx,1,3)='263') 
			and comorbi_23=0 
		then comorbi_23=1;	
	*Fluid and Electrolyte Disorders;
	if (substr(dx,1,3)='276') 
			and comorbi_24=0 
		then comorbi_24=1;
	*Blood Loss Anemia;
	if (substr(dx,1,4)='2800') 
			and comorbi_25=0 
		then comorbi_25=1;
	*Deficiency Anemias;
	if (substr(dx,1,4)='2801' or
		substr(dx,1,4)='2808' or
		substr(dx,1,4)='2809' or
		substr(dx,1,4)='2859') 
			and comorbi_26=0 
		then comorbi_26=1;
	*Alcohol Abuse;
	if (substr(dx,1,4)='2911' or
		substr(dx,1,4)='2912' or
		substr(dx,1,4)='2915' or
		substr(dx,1,4)='2918' or
		substr(dx,1,4)='2919' or
		substr(dx,1,4)='3039' or
		substr(dx,1,4)='3050' or
		substr(dx,1,4)='V113') 
			and comorbi_27=0 
		then comorbi_27=1;
	*Drug Abuse;
	if (substr(dx,1,4)='2920' or
		substr(dx,1,5)='29282' or
		substr(dx,1,5)='29283' or
		substr(dx,1,5)='29284' or
		substr(dx,1,5)='29289' or
		substr(dx,1,4)='2929' or
		substr(dx,1,3)='304' or
		substr(dx,1,4)='3052' or
		substr(dx,1,4)='3053' or
		substr(dx,1,4)='3054' or
		substr(dx,1,4)='3055' or
		substr(dx,1,4)='3056' or
		substr(dx,1,4)='3057' or
		substr(dx,1,4)='3058' or
		substr(dx,1,4)='3059')
			and comorbi_28=0 
		then comorbi_28=1;	
	*Psychoses;
	if (substr(dx,1,3)='295' or
		substr(dx,1,3)='296' or
		substr(dx,1,3)='297' or
		substr(dx,1,3)='298' or
		substr(dx,1,4)='2991') 
			and comorbi_29=0 
		then comorbi_29=1;
	*Depression;
	if (substr(dx,1,4)='3004' or
		substr(dx,1,5)='30112' or
		substr(dx,1,4)='3090' or
		substr(dx,1,4)='3091' or
		substr(dx,1,3)='311')
			and comorbi_30=0 
		then comorbi_30=1;

	*Dementia;
	if (substr(dx,1,4) in ('3310','3311','3312','2900','2901',
             '2902','2903','2912','2948','2949') or
		substr(dx,1,5) in ('29410','29411','29040','29041','29042','29043')) 
		and dementia=0 
          then dementia=1;

	*CAD coronary artery disease;
	if (substr(dx,1,4) in ('4140','4142','4143','4148','4149') or 
		substr(dx,1,3) in ('410','411','412','413') or
		substr(dx,1,5) in ('V4581','V4582'))
		and cad=0 
          then cad=1;

	*ALS Amyotrophic lateral sclerosis;
	if (substr(dx,1,5)='33520') and als=0 
		then als=1;

*Renal Disease, new variable;
	*To identify diabetese with complications;
	if (substr(dx,1,5)='40311' or
		substr(dx,1,5)='40391' or
		substr(dx,1,5)='40412' or
		substr(dx,1,5)='40492' or
		substr(dx,1,3)='585' or
		substr(dx,1,3)='586' or
		substr(dx,1,4)='V420' or
		substr(dx,1,4)='V451' or
		substr(dx,1,4)='V560' or
		substr(dx,1,4)='V568') 
			and renal_dis=0 
		then renal_dis=1;

end;

run;

/*get count of each comorbidity for each id-core year combination*/
proc sql;
create table com_test1 as
select distinct BID_hrs_21,core_year,
sum(comorbi_1) as com_1,
sum(comorbi_2) as com_2,
sum(comorbi_3) as com_3,
sum(comorbi_4) as com_4,
sum(comorbi_5) as com_5,
sum(comorbi_6) as com_6,
sum(comorbi_7) as com_7,
sum(comorbi_8) as com_8,
sum(comorbi_9) as com_9,
sum(comorbi_10) as com_10,
sum(comorbi_11) as com_11,
sum(comorbi_12) as com_12,
sum(comorbi_13) as com_13,
sum(comorbi_14) as com_14,
sum(comorbi_15) as com_15,
sum(comorbi_16) as com_16,
sum(comorbi_17) as com_17,
sum(comorbi_18) as com_18,
sum(comorbi_19) as com_19,
sum(comorbi_20) as com_20,
sum(comorbi_21) as com_21,
sum(comorbi_22) as com_22,
sum(comorbi_23) as com_23,
sum(comorbi_24) as com_24,
sum(comorbi_25) as com_25,
sum(comorbi_26) as com_26,
sum(comorbi_27) as com_27,
sum(comorbi_28) as com_28,
sum(comorbi_29) as com_29,
sum(comorbi_30) as com_30,
sum(dementia) as dementia,
sum(cad) as cad,
sum(als) as als,
sum(renal_dis) as renal_dis
from dx_31_comor
group by BID_hrs_21,core_year;
quit;

/*convert counts of diagnoses for each comorbidity to indicator variables*/ 
data comorbidity_1(keep=BID_hrs_21 core_year comorb_1-comorb_34 comorb_all);
set com_test1;
array list_com com_1-com_30 dementia cad als renal_dis;
array list_com_bin comorb_1-comorb_34 ;

do over list_com;
  list_com_bin=0;

  if list_com>0 then do;
    list_com_bin=1;
   end;

end;
/*note this comorb_all count does not include CAD or ALS or Renal disease*/
comorb_all=comorb_1+comorb_2+comorb_3+comorb_4+comorb_5+comorb_6+comorb_7+comorb_8+comorb_9+comorb_10
+comorb_11+comorb_12+comorb_13+comorb_14+comorb_15+comorb_16+comorb_17+comorb_18+comorb_19+comorb_20
+comorb_21+comorb_22+comorb_23+comorb_24+comorb_25+comorb_26+comorb_27+comorb_28+comorb_29+comorb_30
+comorb_31;

run;

/*merge in to list of core ivw dates for those with ffs mc, age=65+ */
proc sort data=comorbidity_1 nodupkey;
by BID_hrs_21 core_year;
run;

proc sort data=sic_int.core_xwalk_ins_ffs_only out=core_xwalk_ins_ffs_only nodupkey;
by BID_hrs core_year;
run;

proc sql;
create table core_xwalk_elix_1(drop=BID_hrs_21 core_year2) as
select a.*,b.*
from core_xwalk_ins_ffs_only(drop=age_ge_65 c_ivw_date c_ivw_year hmo_d_12m part_ab_12m) a 
left join
comorbidity_1(rename=(core_year=core_year2)) b
on trim(left(a.BID_hrs))=trim(left(b.BID_hrs_21)) and a.core_year=b.core_year2;
quit;

data sic_int.elix_&range1._&range2;
set core_xwalk_elix_1 ;

label comorb_1 ="Congestive Heart Failure";
label comorb_2 ="Cardiac Arrhythmias";
label comorb_3 ="Valvular Disease";
label comorb_4 ="Pulmonary Circulation Disorders";
label comorb_5 ="Peripheral Vascular Disorders";
label comorb_6 ="Hypertension";
label comorb_7 ="Paralysis";
label comorb_8 ="Other Neurological Disorders";
label comorb_9 ="Chronic Pulmonary Disease";
label comorb_10 ="Diabetes, uncomplicated";
label comorb_11 ="Diabetes, complicated";
label comorb_12 ="Hypothyroidism";
label comorb_13 ="Renal Failure";
label comorb_14 ="Advanced Liver Disease or Cirrhosis";
label comorb_15 ="Peptic Ulcer Disease excluding bleeding";
label comorb_16 ="AIDS";
label comorb_17 ="Lymphoma";
label comorb_18 ="Metastatic or Hematologic Cancer";
label comorb_19 ="Solid Tumor without Metastisis";
label comorb_20 ="Rheumatoid Arthritis/Collagen Vascular Diseases";
label comorb_21 ="Coagulopathy";
label comorb_22 ="Obesity";
label comorb_23 ="Weight Loss";
label comorb_24 ="Fluid and Electrolyte Disorders";
label comorb_25 ="Blood Loss Anemia";
label comorb_26 ="Deficiency Anemias";
label comorb_27 ="Alcohol Abuse";
label comorb_28 ="Drug Abuse";
label comorb_29 ="Psychoses";
label comorb_30 ="Depression";
label comorb_31 ="Dementia";
label comorb_32 ="CAD";
label comorb_33 ="ALS";
label comorb_34 ="Renal Disease";
label comorb_all ="Count of Elix comorbidities";
run;

data test;
set sic_int.elix_&range1._&range2;
run;

%rename(WORK,TEST,&range1._&range2);

data sic_int.elix_&range1._&range2._2(rename =(bid_hrs_&range1._&range2=bid_hrs
core_year_&range1._&range2=core_year));
set test;
keep bid_hrs_&range1._&range2 comorb: core_year:;
run;
proc sort data=sic_int.elix_&range1._&range2._2;
by bid_hrs core_year;
run;

%mend;

/*Run for 1 year, 2 year datasets, resulting datasets are sic_int.elix_0_1yr_2, sic_int.elix_0_2yr_2*/
%elixhauser(range1=0, range2=1yr);
%elixhauser(range1=0, range2=2yr);

proc freq data=sic_int.elix_0_1yr_2;
table comorb:;
run;

proc freq data=sic_int.elix_0_2yr_2;
table comorb:;
run;

/****************************************************************************/
/* Macro to merge Elixhauser comorbidities with core full interviews        */
/****************************************************************************/
/*note resulting datasets have all interviews
If ffs mc 1 year prior to interview, then the the elix comorb are left as missing*/
%macro mergeel(range2=);
proc sql;
create table core_ids_elix_&range2(drop=BID_hrs2 core_year2) as select a.*,
b.*
from 
sic_int.core_xwalk_ins /*sic_int.core_xwalk_1*/ a left join
sic_int.elix_0_&range2._2(rename=(BID_hrs=BID_hrs2 core_year=core_year2)) b
on trim(left(a.BID_hrs))=trim(left(b.BID_hrs2)) and a.core_year=b.core_year2;
quit;

/*3047 obs have ffs mc 1 year preceeding interview but no dx during that time
data zzztest;
set sic_int.core_ids_elix_1yr;
if comorb_all_0_1yr=. and part_ab_12m=1 and hmo_d_12m=0 ;
run;*/

data sic_int.core_ids_elix_&range2._2;
set core_ids_elix_&range2;
array list comorb_:;
do over list;
if part_ab_12m=1 and hmo_d_12m=0 and age_ge_65=1 and list=. then list=0;
end;
run;

%mend;

%mergeel(range2=1yr);
%mergeel(range2=2yr);

/*also merge in the 1 year count of dementia diagnoses from the previous section*/
proc sql;
create table core_ids_elix_1yr_dm_dx as select a.*,b.dem_dx_1yr from
sic_int.core_ids_elix_1yr_2 a left join
sic_int.dem_dx_freq_2 b
on a.BID_hrs=b.BID_hrs_21 and a.core_year=b.core_year;
quit;

/*overwrite the previously saved dataset with one with the additional dementia variable added*/
data sic_int.core_ids_elix_1yr_2;
set core_ids_elix_1yr_dm_dx;
if comorb_31_0_1yr=0 then dem_dx_1yr=0;
run;

proc freq data=sic_int.core_ids_elix_1yr_2;
table comorb:;
run;

proc freq data=sic_int.core_ids_elix_1yr_2;
table dem_dx_1yr*comorb_31_0_1yr /missprint;
run;

proc freq data=sic_int.core_ids_elix_2yr_2;
table comorb:;
run;


H="Step 3a - Charlson comorbidities"
/*Add indicator variables for the Charlson comorbidities
and Charlson weighted and unweighted index */

/*Charlson code

This program reads through the diagnosis codes of patient abstract records in a hospital
    file and identifies whether the record belongs to one (or more) of 17 different Charlson
    Comorbidity Index (CCI) groups.  The groups are identified by using the Enhanced ICD-9-CM
    diagnosis codes listed in Quan et al., "Coding Algorithms for Defining Comorbidities
    in ICD-9-CM and ICD-10 Administrative Data", Medical Care:43(11), Nov. 2005 p1130-1139.*/

%macro charlson(range1=,range2=);

data dx_charlson;
set sic_int.dx_&range1._&range2.(rename=(diag=dx_0));
dx=trim(left(dx_0));

if dx~="" then do;

*initialize variables;
   charlson_1=0;
   charlson_2=0;
   charlson_3=0;
   charlson_4=0;
   charlson_5=0;
   charlson_6=0;
      charlson_7=0;
	     charlson_8=0;
		    charlson_9=0;
			   charlson_10=0;
			      charlson_11=0;
				     charlson_12=0;
					    charlson_13=0;
						   charlson_14=0;
						      charlson_15=0;
							     charlson_16=0;
								    charlson_17=0;

*do over dx;
   *Myocardial Infarction;
   if(substr(dx,1,3)='410' or
               substr(dx,1,3)='412')
               and charlson_1=0
               then charlson_1=1;
   *Congestive heart failure;
   if(substr(dx,1,5)='39891' or
               substr(dx,1,5)='40201' or
               substr(dx,1,5)='40211' or
               substr(dx,1,5)='40291' or
               substr(dx,1,5)='40401' or
               substr(dx,1,5)='40403' or
               substr(dx,1,5)='40411' or
               substr(dx,1,5)='40413' or
               substr(dx,1,5)='40491' or
               substr(dx,1,5)='40493' or
               substr(dx,1,4)='4254' or
               substr(dx,1,4)='4255' or
               substr(dx,1,4)='4256' or
               substr(dx,1,4)='4257' or
               substr(dx,1,4)='4258' or
               substr(dx,1,4)='4259' or
               substr(dx,1,3)='428')
               and charlson_2=0
               then charlson_2=1;
   *Periphral Vascular Disease;
    if(substr(dx,1,4)='0930' or
               substr(dx,1,4)='4373' or
               substr(dx,1,3)='440' or
               substr(dx,1,3)='441' or
               substr(dx,1,4)='4431' or
               substr(dx,1,4)='4432' or
               substr(dx,1,4)='4438' or
               substr(dx,1,4)='4439' or
               substr(dx,1,4)='4471' or
               substr(dx,1,4)='5571' or
               substr(dx,1,4)='5579' or
               substr(dx,1,4)='V434')
               and charlson_3=0
               then charlson_3=1;
    *Cerebrovascular Disease ;
        if(substr(dx,1,5)='36234' or
               substr(dx,1,3)='430' or
               substr(dx,1,3)='431' or
               substr(dx,1,3)='432' or
               substr(dx,1,3)='433' or
               substr(dx,1,3)='434' or
               substr(dx,1,3)='435' or
               substr(dx,1,3)='436' or
               substr(dx,1,3)='437' or
               substr(dx,1,3)='438')
               and charlson_4=0
               then charlson_4=1;
    *Dementia ;
       if(substr(dx,1,3)='290' or
               substr(dx,1,4)='2941' or
               substr(dx,1,4)='3312')
               and charlson_5=0
               then charlson_5=1;
   *Chronic Pulmonary Disease ;
        if(substr(dx,1,5)='4168' or
               substr(dx,1,4)='4169' or
               substr(dx,1,3)='490' or
               substr(dx,1,3)='491' or
               substr(dx,1,3)='492' or
               substr(dx,1,3)='493' or
               substr(dx,1,3)='494' or
               substr(dx,1,3)='495' or
               substr(dx,1,3)='496' or
               substr(dx,1,3)='500' or
               substr(dx,1,3)='501' or
               substr(dx,1,3)='502' or
               substr(dx,1,3)='503' or
               substr(dx,1,3)='504' or
               substr(dx,1,3)='505' or
               substr(dx,1,4)='5064' or
               substr(dx,1,4)='5081' or
               substr(dx,1,4)='5088')
               and charlson_6=0
               then charlson_6=1;
*Connective Tissue Disease-Rheumatic Disease;
         if(substr(dx,1,4)='4465' or
               substr(dx,1,4)='7100' or
               substr(dx,1,4)='7101' or
               substr(dx,1,4)='7102' or
               substr(dx,1,4)='7103' or
               substr(dx,1,4)='7104' or
               substr(dx,1,4)='7140' or
               substr(dx,1,4)='7141' or
               substr(dx,1,4)='7142' or
               substr(dx,1,4)='7148' or
               substr(dx,1,3)='725')
               and charlson_7=0
               then charlson_7=1;
 *Peptic Ulcer Disease;
         if(substr(dx,1,3)='531' or
               substr(dx,1,3)='532' or
               substr(dx,1,3)='533' or
               substr(dx,1,3)='534')
               and charlson_8=0
               then charlson_8=1;
*Mild Liver Disease ;
         if(substr(dx,1,5)='07022' or
               substr(dx,1,5)='07023' or
               substr(dx,1,5)='07032' or
               substr(dx,1,5)='07033' or
               substr(dx,1,5)='07044' or
               substr(dx,1,5)='07054' or
               substr(dx,1,4)='0706' or
               substr(dx,1,4)='0709' or
               substr(dx,1,3)='570' or
               substr(dx,1,3)='571' or
               substr(dx,1,4)='5733' or
               substr(dx,1,4)='5734' or
               substr(dx,1,4)='5738' or
               substr(dx,1,4)='5739' or
               substr(dx,1,4)='V427')
               and charlson_9=0
               then charlson_9=1;
*Diabetes without complications ;
         if(substr(dx,1,4)='2500' or
               substr(dx,1,4)='2501' or
               substr(dx,1,4)='2502' or
               substr(dx,1,4)='2503' or
               substr(dx,1,4)='2508' or
               substr(dx,1,4)='2509')
               and charlson_10=0
               then charlson_10=1;
*Diabetes, complicated;
	if (substr(dx,1,4)='2504' or
		substr(dx,1,4)='2505' or
		substr(dx,1,4)='2506' or
		substr(dx,1,4)='2507')
		and charlson_11=0
                then charlson_11=1;
*Paraplegia and Hemiplegia ;
	if (substr(dx,1,4)='3341' or
		substr(dx,1,3)='342' or
		substr(dx,1,3)='343' or
		substr(dx,1,4)='3440' or
		substr(dx,1,4)='3441' or
		substr(dx,1,4)='3442' or
		substr(dx,1,4)='3443' or
                substr(dx,1,4)='3444' or
		substr(dx,1,4)='3445' or
		substr(dx,1,4)='3446' or
		substr(dx,1,4)='3449')
		and charlson_12=0
                then charlson_12=1;
* Renal Disease ;
	if (substr(dx,1,5)='40301' or
		substr(dx,1,5)='40311' or
		substr(dx,1,5)='40391' or
		substr(dx,1,5)='40402' or
		substr(dx,1,5)='40403' or
		substr(dx,1,5)='40412' or
		substr(dx,1,5)='40413' or
                substr(dx,1,5)='40492' or
		substr(dx,1,5)='40493' or
		substr(dx,1,3)='582' or
		substr(dx,1,4)='5830' or
                substr(dx,1,4)='5831' or
                substr(dx,1,4)='5832' or
                substr(dx,1,4)='5834' or
                substr(dx,1,4)='5836' or
                substr(dx,1,4)='5837' or
                substr(dx,1,3)='585' or
                substr(dx,1,3)='586' or
                substr(dx,1,4)='5880' or
                substr(dx,1,4)='V420' or
                substr(dx,1,4)='V451' or
                substr(dx,1,3)='V56' )
		and charlson_13=0
                then charlson_13=1;
*Cancer ;
	if (substr(dx,1,2)='14' or
		substr(dx,1,2)='15' or
		substr(dx,1,2)='16' or
		substr(dx,1,3)='170' or
		substr(dx,1,3)='171' or
		substr(dx,1,3)='172' or
		substr(dx,1,3)='174' or
		substr(dx,1,3)='175' or
		substr(dx,1,3)='176' or
		substr(dx,1,3)='179' or
		substr(dx,1,2)='18' or
		substr(dx,1,3)='190' or
		substr(dx,1,3)='191' or
		substr(dx,1,3)='192' or
		substr(dx,1,3)='193' or
		substr(dx,1,3)='194' or
		substr(dx,1,3)='195' or
                substr(dx,1,3)='200' or
                substr(dx,1,3)='201' or
                substr(dx,1,3)='202' or
                substr(dx,1,3)='203' or
                substr(dx,1,3)='204' or
                substr(dx,1,3)='205' or
                substr(dx,1,3)='206' or
                substr(dx,1,3)='207' or
                substr(dx,1,3)='208' or
                substr(dx,1,3)='2386' )
		and charlson_14=0
                then charlson_14=1;
* Moderate or Severe Liver Disease ;
	if (substr(dx,1,4)='4560' or
		substr(dx,1,4)='4561' or
		substr(dx,1,4)='4562' or
		substr(dx,1,4)='5722' or
		substr(dx,1,4)='5723' or
		substr(dx,1,4)='5724' or
      		substr(dx,1,4)='5728' )
		and charlson_15=0
                then charlson_15=1;
  * Metastatic Carcinoma ;
	if (substr(dx,1,3)='196' or
		substr(dx,1,3)='197' or
		substr(dx,1,3)='198' or
		substr(dx,1,3)='199' )
		and charlson_16=0
                then charlson_16=1;
  * AIDS/HIV ;
	if (substr(dx,1,3)='042' or
		substr(dx,1,3)='043' or
		substr(dx,1,3)='044' )
		and charlson_17=0
                then charlson_17=1;

end;

run;

/*get count of each comorbidity for each id-core year combination*/
proc sql;
create table cha_test1 as
select distinct BID_hrs_21,core_year,
sum(charlson_1) as cha_1,
sum(charlson_2) as cha_2,
sum(charlson_3) as cha_3,
sum(charlson_4) as cha_4,
sum(charlson_5) as cha_5,
sum(charlson_6) as cha_6,
sum(charlson_7) as cha_7,
sum(charlson_8) as cha_8,
sum(charlson_9) as cha_9,
sum(charlson_10) as cha_10,
sum(charlson_11) as cha_11,
sum(charlson_12) as cha_12,
sum(charlson_13) as cha_13,
sum(charlson_14) as cha_14,
sum(charlson_15) as cha_15,
sum(charlson_16) as cha_16,
sum(charlson_17) as cha_17
from dx_charlson
group by BID_hrs_21,core_year;
quit;

/*convert counts of diagnoses for each comorbidity to indicator variables*/ 
data charlson_1(keep=BID_hrs_21 core_year charls_1-charls_17 charls_index charls_index_wt);
set cha_test1;
array list_cha cha_1-cha_17;
array list_cha_bin charls_1-charls_17 ;

do over list_cha;
  list_cha_bin=0;

  if list_cha>0 then do;
    list_cha_bin=1;
   end;

end;
/*note this charls_index count count is not weighted for morbidity*/
charls_index=charls_1+charls_2+charls_3+charls_4+charls_5+charls_6+charls_7+charls_8+charls_9+charls_10
+charls_11+charls_12+charls_13+charls_14+charls_15+charls_16+charls_17;
/*now morbidity weighted*/
charls_index_wt=charls_1+charls_2+charls_3+charls_4+charls_5+charls_6+charls_7+charls_8+charls_9+charls_10
+2*charls_11+2*charls_12+2*charls_13+2*charls_14+3*charls_15+6*charls_16+6*charls_17;

label charls_1 ="Myocardial infarction, Charlson";
label charls_2 ="Congestive Heart Failure, Charlson";
label charls_3 ="Peripheral Vascular Disease, Charlson";
label charls_4 ="Cerebrovascular disease, Charlson";
label charls_5 ="Dementia, Charlson";
label charls_6 ="Chronic Pulmonary Disease, Charlson";
label charls_7 ="Rheumatic disease, Charlson";
label charls_8 ="Peptic ulcer disease, Charlson";
label charls_9 ="Mild liver disease, Charlson";
label charls_10 ="Diabetes, uncomplicated, Charlson";
label charls_11 ="Diabetes, complicated, Charlson";
label charls_12 ="Hemiplegia or paraplegia, Charlson";
label charls_13 ="Renal disease, Charlson";
label charls_14 ="Any malignancy except neoplasm of skin, Charlson";
label charls_15 ="Mod or severe liver disease, Charlson";
label charls_16 ="Metastatic solid tumor, Charlson";
label charls_17 ="AIDS/HIV, Charlson";
label charls_index ="Charlson score index, not weighted";
label charls_index_wt ="Charlson score index, weighted";

run;

/*merge into list of obs with ffs mc 6m prior to ivw*/
proc sort data=charlson_1 nodupkey;
by BID_hrs_21 core_year;
run;

proc sort data=sic_int.core_xwalk_ins_ffs_only out=core_xwalk_ins_ffs_only nodupkey;
by BID_hrs core_year;
run;

proc freq; table age_ge_65 hmo_d_12m part_ab_12m; run;

proc sql;
create table core_xwalk_charls_1(drop=BID_hrs_21 core_year2) as
select a.*,b.*
from core_xwalk_ins_ffs_only(drop=age_ge_65 c_ivw_date c_ivw_year hmo_d_12m part_ab_12m) a 
left join
charlson_1(rename=(core_year=core_year2)) b
on trim(left(a.BID_hrs))=trim(left(b.BID_hrs_21)) and a.core_year=b.core_year2;
quit;

/*if missing because no diagnoses, set to 0*/
data core_xwalk_charls_2;
set core_xwalk_charls_1;
array list charls_:;
do over list;
if list=. then list=0;
end;

data test;
set core_xwalk_charls_2;
run;

%rename(WORK,TEST,&range1._&range2);

data sic_int.charls_&range1._&range2.(rename =(bid_hrs_&range1._&range2=bid_hrs
core_year_&range1._&range2=core_year));
set test;
keep bid_hrs_&range1._&range2 charls: core_year:;
run;
proc sort data=sic_int.charls_&range1._&range2.;
by bid_hrs core_year;
run;

%mend;

%charlson(range1=0, range2=1yr);
%charlson(range1=0, range2=2yr);

proc freq data=sic_int.charls_0_1yr;
table charls:;
run;

proc freq data=sic_int.charls_0_2yr;
table charls:;
run;

/****************************************************************************/
/* Macro to merge Charlson comorbidities with core full interviews        */
/****************************************************************************/
/*note resulting datasets have all interviews
If ffs mc 1 year prior to interview, then the the Charlson comorb are left as missing
 (same as Elix in prev section)*/

%macro mergech(range2=);

proc sql;
create table sic_int.core_ids_charls_&range2.(drop=BID_hrs2 core_year2) as select a.*,
b.*
from 
sic_int.core_ids_elix_&range2._2 a left join
sic_int.charls_0_&range2.(rename=(BID_hrs=BID_hrs2 core_year=core_year2)) b
on trim(left(a.BID_hrs))=trim(left(b.BID_hrs2)) and a.core_year=b.core_year2;
quit;

%mend;

%mergech(range2=1yr);
%mergech(range2=2yr);

proc freq data=sic_int.core_ids_charls_1yr;
table charls:;
run;

proc freq data=sic_int.core_ids_charls_2yr;
table charls:;
run;

/****************************************************************************/
/*Quick tabulation of charlson vs elixhauser comorbidities */
/****************************************************************************/
ods rtf body="E:\data\serious_ill\logs\chalrson_elix_compare.rtf";

proc freq data=sic_int.core_ids_charls_1yr;
table charls_1_0_1yr 
 charls_2_0_1yr*comorb_1_0_1yr 
 charls_3_0_1yr*comorb_5_0_1yr 
 charls_4_0_1yr 
 charls_5_0_1yr*comorb_31_0_1yr 
 charls_6_0_1yr*comorb_9_0_1yr 
 charls_7_0_1yr*comorb_20_0_1yr 
 charls_8_0_1yr*comorb_15_0_1yr 
 charls_9_0_1yr 
 charls_10_0_1yr*comorb_10_0_1yr
 charls_11_0_1yr*comorb_11_0_1yr 
 charls_12_0_1yr*comorb_7_0_1yr 
 charls_13_0_1yr*comorb_34_0_1yr 
 charls_14_0_1yr*comorb_19_0_1yr 
 charls_15_0_1yr*comorb_14_0_1yr 
 charls_16_0_1yr*comorb_18_0_1yr 
 charls_17_0_1yr*comorb_16_0_1yr 
;

run;


ods rtf close;


H="Step 4 - DW chronic conditions"
/*CMS Data Warehouse Chronic Conditions*/

/****************************************************************************/
/*First get the dx list into dot format using Stata*/
/****************************************************************************/

/*export to Stata*/
proc export data=sic_int.dx_0_1yr
outfile="E:\data\serious_ill\int_data\dx_0_1yr.dta" replace;
run;

proc export data=sic_int.dx_0_2yr
outfile="E:\data\serious_ill\int_data\dx_0_2yr.dta" replace;
run;

/****************************************************************************/
/****************************************************************************/
/*SWITCH TO STATA HERE*/
/****************************************************************************/
/****************************************************************************/

capture log close
clear
set more off
local datapath E:\data\serious_ill\int_data

use `datapath'\dx_0_1yr.dta,clear

// convert diagnosis codes to string variables, tostring diag,gen(icd9_c)
gen new=ltrim(diag)
icd9 check new,gen(icd9_c)
replace new="" if icd9_c>0 
// convert into dot format (ex 12.1 instead of 121)
icd9 clean new,dots 

replace diag=new
drop icd9_c new

save `datapath'\dx_0_1yr_2.dta,replace
outsheet using `datapath'\dx_0_1yr_2.csv, comma replace


clear all

use `datapath'\dx_0_2yr.dta,clear

// convert diagnosis codes to string variables, tostring diag,gen(icd9_c)
gen new=ltrim(diag)
icd9 check new,gen(icd9_c)
replace new="" if icd9_c>0 
// convert into dot format (ex 12.1 instead of 121)
icd9 clean new,dots 

replace diag=new
drop icd9_c new

save `datapath'\dx_0_2yr_2.dta,replace
outsheet using `datapath'\dx_0_2yr_2.csv, comma replace

/****************************************************************************/
/****************************************************************************/
/*SWITCH TO SAS HERE*/
/****************************************************************************/
/****************************************************************************/

proc import 
datafile="E:\data\serious_ill\int_data\dx_0_1yr_2.csv" 
out=dx_0_1yr_2 replace;
run;

proc import 
datafile="E:\data\serious_ill\int_data\dx_0_2yr_2.csv" 
out=dx_0_2yr_2 replace;
run;

/*bring in excel list of dx codes associated with each chronic condition*/
proc import 
datafile='E:\data\serious_ill\ref_data\chronic_21_condition_icd9.xls'
out=icd9_21_chronic dbms=xls replace;
run;

proc contents data=icd9_21_chronic;
run;

/*creates macro variables of each of the chronic conditions listing of dx codes*/
proc sql;
select icd_9 into :chronic_desc1-:chronic_desc21 from icd9_21_chronic;
quit;
%put &chronic_desc10;
%put &chronic_desc5;

/*******************************************************************/
/*Macro to generate chronic conditions indicators using dx codes   */
/*******************************************************************/

%macro cc(precore=);

data list_&precore._dx;
set dx_0_&precore._2;
array list CC_1_AMI
CC_2_ALZH
CC_3_ALZHDMTA
CC_4_ATRIALFB
CC_5_CATARACT
CC_6_CHRNKIDN
CC_7_COPD
CC_8_CHF
CC_9_DIABETES
CC_10_GLAUCOMA
CC_11_HIPFRAC
CC_12_ISCHMCHT
CC_13_DEPRESSN
CC_14_OSTEOPRS
CC_15_RA_OA
CC_16_STRKETIA
CC_17_CNCRBRST
CC_18_CNCRCLRC
CC_19_CNCRPRST
CC_20_CNCRLUNG
CC_21_CNCREndM;
do over list ;
list=0;
end;

diag_string=diag;

/* for dx codes that begin with numbers, process chronic cond variables*/
if anydigit(substr(trim(left(diag_string)),1,1))=1 then do;
diag=diag_string+0;

if diag in (&chronic_desc1) then CC_1_AMI=1;
if diag in (&chronic_desc2)  then CC_2_ALZH=1;
if diag in (&chronic_desc3)  then CC_3_ALZHDMTA=1;
if diag in (&chronic_desc4) then CC_4_ATRIALFB=1;
if diag in (&chronic_desc5) then CC_5_CATARACT=1;
if diag in (&chronic_desc6) then CC_6_CHRNKIDN=1;
if diag in (&chronic_desc7) then CC_7_COPD=1;
if diag in (&chronic_desc8) then CC_8_CHF=1;
if diag in (&chronic_desc9) then CC_9_DIABETES=1;
if diag in (&chronic_desc10) then CC_10_GLAUCOMA=1;
if diag in (&chronic_desc11) then CC_11_HIPFRAC=1;
if diag in (&chronic_desc12) then CC_12_ISCHMCHT=1;
if diag in (&chronic_desc13) then CC_13_DEPRESSN=1;
if diag in (&chronic_desc14) then CC_14_OSTEOPRS=1;
if diag in (&chronic_desc15) then CC_15_RA_OA=1;
if diag in (&chronic_desc16) then CC_16_STRKETIA=1;
if diag in (&chronic_desc17) then CC_17_CNCRBRST=1;
if diag in (&chronic_desc18) then CC_18_CNCRCLRC=1;
if diag in (&chronic_desc19) then CC_19_CNCRPRST=1;
if diag in (&chronic_desc20) then CC_20_CNCRLUNG=1;
if diag in (&chronic_desc21) then CC_21_CNCREndM=1;
end;

/*Process with dx codes that start with letters
Only two of them in the list*/
if anydigit(substr(trim(left(diag_string)),1,1))=0 then do;
if trim(left(diag_string)) in ("V431") then CC_5_CATARACT=1;
if trim(left(diag_string)) in ("V801") then CC_10_GLAUCOMA=1;
end;

run;


proc sql;
create table bid_dx_0_&precore.(rename=(bid_hrs_21=bid)) as
select distinct bid_hrs_21,core_year,
sum(CC_1_AMI) as CC_1_AMI,
sum(CC_2_ALZH) as CC_2_ALZH,
sum(CC_3_ALZHDMTA) as CC_3_ALZHDMTA,
sum(CC_4_ATRIALFB) as CC_4_ATRIALFB,
sum(CC_5_CATARACT) as CC_5_CATARACT,
sum(CC_6_CHRNKIDN) as CC_6_CHRNKIDN,
sum(CC_7_COPD) as CC_7_COPD,
sum(CC_8_CHF) as CC_8_CHF,
sum(CC_9_DIABETES) as CC_9_DIABETES,
sum(CC_10_GLAUCOMA) as CC_10_GLAUCOMA,
sum(CC_11_HIPFRAC) as CC_11_HIPFRAC,
sum(CC_12_ISCHMCHT) as CC_12_ISCHMCHT,
sum(CC_13_DEPRESSN) as CC_13_DEPRESSN,
sum(CC_14_OSTEOPRS) as CC_14_OSTEOPRS,
sum(CC_15_RA_OA) as CC_15_RA_OA,
sum(CC_16_STRKETIA) as CC_16_STRKETIA,
sum(CC_17_CNCRBRST) as CC_17_CNCRBRST,
sum(CC_18_CNCRCLRC) as CC_18_CNCRCLRC,
sum(CC_19_CNCRPRST) as CC_19_CNCRPRST,
sum(CC_20_CNCRLUNG) as CC_20_CNCRLUNG,
sum(CC_21_CNCREndM) as CC_21_CNCREndM

from list_&precore._dx group by bid_hrs_21,core_year;
quit;

proc sort data=bid_dx_0_&precore. nodupkey;
by bid core_year;
run;

proc sort data=sic_int.core_xwalk_ins_ffs_only out=core_xwalk_ins_ffs_only nodupkey;
by BID_hrs core_year;
run;

/*merge chronic conditions into interview list of bid's with ffs mc, age 65+ */
 proc sql;
 create table bid_dx_0_&precore.2(drop=bid) as select a.bid_hrs,b.*
 from core_xwalk_ins_ffs_only a
 left join
 bid_dx_0_&precore. b 
 on trim(left(a.bid_hrs))=trim(left(b.bid))
and a.core_year=b.core_year;
 quit;

/*convert to chronic condition vars. to binary variables*/
 data bid_dx_0_&precore.3;
 set bid_dx_0_&precore.2;
 array list CC_1_AMI
CC_2_ALZH
CC_3_ALZHDMTA
CC_4_ATRIALFB
CC_5_CATARACT
CC_6_CHRNKIDN
CC_7_COPD
CC_8_CHF
CC_9_DIABETES
CC_10_GLAUCOMA
CC_11_HIPFRAC
CC_12_ISCHMCHT
CC_13_DEPRESSN
CC_14_OSTEOPRS
CC_15_RA_OA
CC_16_STRKETIA
CC_17_CNCRBRST
CC_18_CNCRCLRC
CC_19_CNCRPRST
CC_20_CNCRLUNG
CC_21_CNCREndM
;
do over list ;
if list>0 then list=1;
if list<=0 then list=0;
end;

/*create aggregated indicators*/
CC_AMI_isch=CC_1_AMI|CC_12_ISCHMCHT;
CC_alzheim=CC_2_ALZH|CC_3_ALZHDMTA;
CC_cncr_chronic=CC_17_CNCRBRST | CC_18_CNCRCLRC | CC_19_CNCRPRST | CC_20_CNCRLUNG | 
	CC_21_CNCREndM ;
run;

proc means;
var CC_1_AMI
CC_2_ALZH
CC_3_ALZHDMTA
CC_4_ATRIALFB
CC_5_CATARACT
CC_6_CHRNKIDN
CC_7_COPD
CC_8_CHF
CC_9_DIABETES
CC_10_GLAUCOMA
CC_11_HIPFRAC
CC_12_ISCHMCHT
CC_13_DEPRESSN
CC_14_OSTEOPRS
CC_15_RA_OA
CC_16_STRKETIA
CC_17_CNCRBRST
CC_18_CNCRCLRC
CC_19_CNCRPRST
CC_20_CNCRLUNG
CC_21_CNCREndM;
run;

/*run rename macro*/
data test;
set bid_dx_0_&precore.3;
run;

%rename(WORK,TEST,&precore.);

data sic_int.chronic_21_&precore.3_0;
set test;
bid_hrs=bid_hrs_&precore.;
drop bid_hrs_&precore.;
core_year=core_year_&precore.;
drop core_year_&precore.;
run;

%mend;

/*2 datasets are sic_int.chronic_21_1yr_0 and sic_int.chronic_21_2yr_0*/
%cc(precore=1yr);
%cc(precore=2yr);

proc freq data=sic_int.chronic_21_1yr3_0;
table cc_:;
run;

proc freq data=sic_int.chronic_21_2yr3_0;
table cc_:;
run;

proc contents data=sic_int.chronic_21_1yr3_0;
run;




/****************************************************************************/
/* Merge cc's with interivew, elix, charlson dataset                        */
/****************************************************************************/
%macro mergecc(precore=);

proc sort data=sic_int.core_ids_charls_&precore.;
by bid_hrs core_year;
run;

proc sort data=sic_int.chronic_21_&precore.3_0;
by bid_hrs core_year;
run;

proc sql;
create table core_ids_elix_cc_&precore.(drop=bid_hrs2 core_year2)
as select * from
sic_int.core_ids_charls_&precore. a
left join
sic_int.chronic_21_&precore.3_0(rename=(bid_hrs=bid_hrs2 core_year=core_year2)) b 
on (a.bid_hrs)=(b.bid_hrs2) and a.core_year=b.core_year2;
quit;

/*For observations that have ffs mc 1 year prior to interview
set cc's variables to 0 if missing bc didn't have a dx during that time*/
data sic_int.core_ids_elix_cc_&precore._2;
set core_ids_elix_cc_&precore.;
array list cc_:;
do over list;
if part_ab_12m=1 and hmo_d_12m=0 and age_ge_65=1 and list=. then list=0;
end;
run;

%mend;

%mergecc(precore=1yr);
%mergecc(precore=2yr);

/* the above file contains all interviews, if do not have mc ffs
1 year preceeding interview or age<65 then elixhauser comorbidities 
and cc's are missing

File names are:
sic_int.core_ids_elix_cc_1yr
sic_int.core_ids_elix_cc_2yr*/

proc contents data=sic_int.core_ids_elix_cc_1yr_2;
run;

proc contents data=sic_int.core_ids_elix_cc_2yr_2;
run;

proc freq data=sic_int.core_ids_elix_cc_1yr_2;
table cc_: comorb_all_0_1yr;
run;

proc freq data=sic_int.core_ids_elix_cc_2yr_2;
table cc_:;
run;


H="Step 5 - Get additional utilization information from claims"
/*These additional variables are just added to the dataset with the
elixhauser and cc's 1 year preceeding the interview, can add them
later when required to get the 2 year look-back dataset*/

/****************************************************************************/
/*Get indicator of any hospital admission 6 and 12 months pre-core interview*/
/****************************************************************************/

%macro admissions(days=,suffix=);

/*pull list of ip claims from all medpar claims x days pre-interview*/
data ip_meet_&days.;
set sic_int.mp_meet3_&days.(where=(trim(left(SSLSSNF))~="N"));
run;

data ip_&days._2;
set ip_meet_&days.;
if icarecnt=. then icarecnt=0; /*medpar intensive care day count*/
if CRNRYDAY=. then CRNRYDAY=0; /*medpar coronary day count*/
icu_days=icarecnt+CRNRYDAY;
em_urgent_admit=0; /*Urgent , emergent admissions from admission type*/
if type_adm in (1,2) then em_urgent_admit=1;
em_admit=0;
if type_adm=1 then em_admit=1;
urgent_admit=0;
if type_adm=2 then urgent_admit=1;
elect_admit=0;
if type_adm=3 then elect_admit=1;
ind_ed_charge=0; /*ED charges as another indicator of ED use*/
if ER_AMT>0 & ER_AMT~=. then ind_ed_charge=1;
if ER_AMT=0 | ER_AMT=. then ind_ed_charge=0;

/*truncate stays where the admit is more than x days before interview
or discharge is after the interview date so can get accurate LOS*/
if c_ivw_date-admit_date>&days. then do;
	admit_date=c_ivw_date-&days.;
	admit_trunc=1;
	end;
if c_ivw_date<disch_date then do;
	disch_date=c_ivw_date;
	disch_trunc=1;	
	end;
adj_los=disch_date-admit_date;
if disch_date-admit_date=0 then adj_los=1;
run;

proc sort data=ip_&days._2;
by BID_hrs_21 core_year;
run;

proc sql;
create table ip_&days._3 as select distinct BID_hrs_21,core_year,
/*total ICU days*/
sum(icu_days) as icu_days_&suffix. label="total icu days &suffix. pre core ivw",
/*count of IP admissions, all types*/
count(*) as n_ip_admit_&suffix. label="total n of hospital admit &suffix. pre core ivw",
/*total Hospital LOS*/
sum(adj_los) as n_hospd_&suffix. label="total hospital days &suffix. pre core ivw",
/*count urgent or emergency admissions*/
count(case when em_urgent_admit=1 then em_urgent_admit else . end) as n_em_urgent_admit_&suffix. 
	label="total n of urgent/emergent hospital admit &suffix. pre core ivw",
/*count of emergency admissions, from admission type code*/
count(case when em_admit=1 then em_admit else . end) as n_em_admit_&suffix. 
	label="total n of emergent hospital admit &suffix. pre core ivw",
/*count of urgent admissions, from admission type code*/
count(case when urgent_admit=1 then urgent_admit else . end) as n_urgent_admit_&suffix. 
	label="total n of urgent hospital admit &suffix. pre core ivw",
/*count of elective admissions, from admission type code*/
count(case when elect_admit=1 then elect_admit else . end) as n_elect_admit_&suffix. 
	label="total n of elective hospital admit &suffix. pre core ivw",
/*count of admissions with any ED charges*/
count(case when ind_ed_charge=1 then ind_ed_charge else . end) as n_ED_ip_&suffix. 
	label="total n of ED visits with subsequent admit &suffix. pre core ivw"

 from ip_&days._2 group by BID_hrs_21,core_year;
quit;

data ip_&days._4;
set ip_&days._3;
if icu_days_&suffix.>n_hospd_&suffix. then icu_days_&suffix.=n_hospd_&suffix.;
run;

%mend;

%admissions(days=183,suffix=6m);
%admissions(days=365,suffix=12m);

data elective_1;
set ip_365_2;
if elect_admit=1;
run;

/*print to file*/
 ods rtf body="E:\data\serious_ill\logs\elective_primary_dxlist.rtf";
 title"Primary dx list for admit type = elective, inpatient claims last 12m pre-core";
proc freq data=elective_1 order=freq; table dgns_cd01;
run;

title"Admission type vs indicator for any ED charges from rev center codes, claims level";
proc freq data=ip_365_2; table ind_ed_charge*type_adm; run;

ods rtf close; 

/*merge the new variables with the list of ivws with ffs mc 1 yr pre and age 65+*/
proc sort data=sic_int.core_xwalk_ins_ffs_only out=core_xwalk_ins_ffs_only nodupkey;
by BID_hrs core_year;
run;

proc sort data=ip_183_3 nodupkey;
by bid_hrs_21 core_year;
run;

proc sql;
create table core_ids_criteria_1a as select a.*,b.icu_days_6m,
b.n_ip_admit_6m,b.n_hospd_6m,b.n_em_urgent_admit_6m,b.n_em_admit_6m,
b.n_urgent_admit_6m,b.n_elect_admit_6m,b.n_ED_ip_6m
from core_xwalk_ins_ffs_only a
left join
ip_183_3 b 
on trim(left(a.bid_hrs))=trim(left(b.bid_hrs_21)) and a.core_year=b.core_year;
quit;

proc sort data=ip_365_3 nodupkey;
by bid_hrs_21 core_year;
run;

proc sql;
create table core_ids_criteria_1 as select a.*,b.icu_days_12m,
b.n_ip_admit_12m,b.n_hospd_12m,b.n_em_urgent_admit_12m,b.n_em_admit_12m,
b.n_urgent_admit_12m,b.n_elect_admit_12m,b.n_ED_ip_12m
from core_ids_criteria_1a a
left join
ip_365_3 b 
on trim(left(a.bid_hrs))=trim(left(b.bid_hrs_21)) and a.core_year=b.core_year;
quit;

/*Dataset just contains obs with ffs mc 1yr and age 65+
So if missing, set var to 0*/
 data core_ids_1yr_criteria ;
 set core_ids_criteria_1 ;
 array list icu_days_6m n_ip_admit_6m n_hospd_6m n_em_urgent_admit_6m 
	n_em_admit_6m n_urgent_admit_6m n_elect_admit_6m n_ED_ip_6m
	icu_days_12m n_ip_admit_12m n_hospd_12m n_em_urgent_admit_12m
	n_em_admit_12m n_urgent_admit_12m n_elect_admit_12m n_ED_ip_12m;
 do over list;
 if list=. then list=0;
 end;

 if n_ip_admit_6m=0 then ind_hosp_adm_6m=0;
 if n_ip_admit_6m>0 & n_ip_admit_6m~=. then ind_hosp_adm_6m=1;
 label ind_hosp_adm_6m="Indicator for any hospital admission 6m pre core";

 if n_em_urgent_admit_6m=0 then ind_em_ur_adm_6m=0;
 if n_em_urgent_admit_6m>0 & n_em_urgent_admit_6m~=. then ind_em_ur_adm_6m=1;
 label ind_em_ur_adm_6m="Ind any urgent or emergent hospital admission 6m pre core";

 if n_em_admit_6m=0 then ind_em_adm_6m=0;
 if n_em_admit_6m>0 & n_em_admit_6m~=. then ind_em_adm_6m=1;
 label ind_em_adm_6m="Ind any emergency hospital admission 6m pre core";

 if n_urgent_admit_6m=0 then ind_ur_adm_6m=0;
 if n_urgent_admit_6m>0 & n_urgent_admit_6m~=. then ind_ur_adm_6m=1;
 label ind_ur_adm_6m="Ind any urgent hospital admission 6m pre core";

 if n_elect_admit_6m =0 then ind_elect_adm_6m=0;
 if n_elect_admit_6m >0 & n_elect_admit_6m ~=. then ind_elect_adm_6m=1;
 label ind_elect_adm_6m="Ind any elective hospital admission 6m pre core";

 if (n_ip_admit_6m - n_elect_admit_6m)=0 then ind_nonelect_adm_6m=0;
 if (n_ip_admit_6m - n_elect_admit_6m)>0 & n_elect_admit_6m~=. then ind_nonelect_adm_6m=1;
 label ind_nonelect_adm_6m="Ind any non-elective hospital admission 6m pre core";

 n_nonelect_adm_6m=(n_ip_admit_6m - n_elect_admit_6m);
 label n_nonelect_adm_6m="total n non-elective ip admit 6m pre core";

 if n_ED_ip_6m=0 then ind_ED_adm_6m=0;
 if n_ED_ip_6m>0 & n_ED_ip_6m~=. then ind_ED_adm_6m=1;
 label ind_ED_adm_6m="Ind ED use with hospital admission 6m pre core, from charges";

 if n_ip_admit_12m=0 then ind_hosp_adm_12m=0;
 if n_ip_admit_12m>0 & n_ip_admit_12m~=. then ind_hosp_adm_12m=1;
 label ind_hosp_adm_12m="Indicator for any hospital admission 12m pre core";

 if n_em_urgent_admit_12m=0 then ind_em_ur_adm_12m=0;
 if n_em_urgent_admit_12m>0 & n_em_urgent_admit_12m~=. then ind_em_ur_adm_12m=1;
 label ind_em_ur_adm_12m="Ind any urgent or emergent hospital admission 12m pre core";

 if n_em_admit_12m=0 then ind_em_adm_12m=0;
 if n_em_admit_12m>0 & n_em_admit_12m~=. then ind_em_adm_12m=1;
 label ind_em_adm_12m="Ind any emergency hospital admission 12m pre core";

 if n_urgent_admit_12m=0 then ind_ur_adm_12m=0;
 if n_urgent_admit_12m>0 & n_urgent_admit_12m~=. then ind_ur_adm_12m=1;
 label ind_ur_adm_12m="Ind any urgent hospital admission 12m pre core";

 if n_elect_admit_12m =0 then ind_elect_adm_12m=0;
 if n_elect_admit_12m >0 & n_elect_admit_12m ~=. then ind_elect_adm_12m=1;
 label ind_elect_adm_12m="Ind any elective hospital admission 12m pre core";

 if (n_ip_admit_12m - n_elect_admit_12m)=0 then ind_nonelect_adm_12m=0;
 if (n_ip_admit_12m - n_elect_admit_12m)>0 & n_elect_admit_12m~=. then ind_nonelect_adm_12m=1;
 label ind_nonelect_adm_12m="Ind any non-elective hospital admission 12m pre core";

 n_nonelect_adm_12m=(n_ip_admit_12m - n_elect_admit_12m);
 label n_nonelect_adm_12m="total n non-elective ip admit 12m pre core";

 if n_ED_ip_12m=0 then ind_ED_adm_12m=0;
 if n_ED_ip_12m>0 & n_ED_ip_12m~=. then ind_ED_adm_12m=1;
 label ind_ED_adm_12m="Ind ED use with hospital admission 12m pre core, from charges";

run;

 proc freq;
 table icu_days_6m n_ip_admit_6m n_hospd_6m ind_hosp_adm_6m n_em_urgent_admit_6m ind_em_ur_adm_6m 
	ind_em_adm_6m ind_ur_adm_6m ind_nonelect_adm_6m n_nonelect_adm_6m n_ED_ip_6m ind_ED_adm_6m 
	ind_em_adm_6m*ind_ED_adm_6m /missprint;
 run;

proc freq;
table icu_days_12m n_ip_admit_12m n_hospd_12m ind_hosp_adm_12m n_em_urgent_admit_12m ind_em_ur_adm_12m
	ind_em_adm_12m ind_ur_adm_12m ind_nonelect_adm_12m n_nonelect_adm_12m n_ED_ip_12m ind_ED_adm_12m 
	ind_em_adm_12m*ind_ED_adm_12m /missprint;
run;

/****************************************************************************/
/****************************************************************************/
/*Get SNF days, indicator for 12 months preceding the interview*/
/****************************************************************************/
/****************************************************************************/

/*pull list of snf claims from all medpar claims 12 months pre-interview*/
data snf_meet_365;
set sic_int.mp_meet3_365(where=(trim(left(SSLSSNF))="N"));
run;

proc sort data=snf_meet_365;
by bid_hrs_21 admit_date;
run;

data snf_meet_365_1a;
set snf_meet_365;
format admit_date date9. disch_date date9.;
run;

/*3 claim windows are present:
1. SNF stays fully within the 1 year before interview
2. Stays that begin before 1 year pre-core but end within 1 year pre-core
3. Stays that begin within 1 year of core but end after core ivw
4. Stays that begin before 1 year and end after interview, LOS=365!
Get claims that meet 1 *1797*/
proc sql;
create table snf_meet1_pre_365 as select *
from snf_meet_365_1a
where (c_ivw_date - admit_date)<365 & (c_ivw_date - disch_date)>=0; 
quit;


/*meet time window 2 *152*/
proc sql;
create table snf_meet2_pre_365 as select *
from snf_meet_365_1a
where (c_ivw_date - admit_date)>=365 & (c_ivw_date - disch_date)>=0; 
quit;

/*For these claims that start > 1 year before core, truncate start date so 
only count LOS days w/i 1 year
create indicator variable that claim start date is truncated*/
data snf_meet2_pre_365_1;
set snf_meet2_pre_365;
admit_date = c_ivw_date-365;
snf_admit_date_mod = 1;
label snf_admit_date_mod = "Admit date mod; at 12 mo from ivw date";
run;

proc freq;
table snf_admit_date_mod ;
run;

/*meet time window 3 *135 */
proc sql;
create table snf_meet3_pre_365 as select *
from snf_meet_365_1a
where (c_ivw_date - admit_date)<365 & (c_ivw_date-disch_date)<0; 
quit;

/*For these claims that end after core, truncate end date so 
only count LOS days 1 year before the core
create indicator variable that claim end date is truncated*/
data snf_meet3_pre_365_1;
set snf_meet3_pre_365;
disch_date = c_ivw_date;
snf_disch_date_mod = 1;
label snf_disch_date_mod = "Disch date mod; at ivw date";
run;

proc freq;
table snf_disch_date_mod ;
run;

/*meet 4 , overlap both start and end dates n=7*/
proc sql;
create table snf_meet4_pre_365 as select *
from snf_meet_365_1a
where (c_ivw_date - admit_date)>=365 & (c_ivw_date - disch_date)<0; 
quit;

/*truncate both start and end dates so just count 1 year pre interview*/
data snf_meet4_pre_365_1;
set snf_meet4_pre_365;
disch_date = c_ivw_date;
snf_disch_date_mod = 1;
label snf_disch_date_mod = "Disch date mod; at ivw date";
admit_date = c_ivw_date-365;
snf_admit_date_mod = 1;
label snf_admit_date_mod = "Admit date mod; at 12 mo from ivw date";
run;

proc freq;
table snf_disch_date_mod snf_admit_date_mod;
run;


data snf_meet_pre_365;
set snf_meet1_pre_365 snf_meet2_pre_365_1 snf_meet3_pre_365_1 snf_meet4_pre_365_1;
run;

proc freq;
table snf_admit_date_mod snf_disch_date_mod ;
run;

/*save final files to project int_data directory*/
data sic_int.snf_meet_pre_365 ;
set  snf_meet_pre_365;
run;

/*************************************************************/
/*calculate total number of days spent in SNF by BID*/
/*************************************************************/

data pre_snf_days_1;
set sic_int.snf_meet_pre_365;
calc_snf_LOS=disch_date-admit_date;
if calc_snf_LOS=0 then calc_snf_LOS=1;
run;

proc sort data=pre_snf_days_1;
by bid_hrs_21 c_ivw_date admit_date;
run;

proc sql;
create table snf_days_pre as select distinct bid_hrs_21,core_year,
sum(calc_snf_LOS)
	as n_snf_days_12m
	from pre_snf_days_1 group by bid_hrs_21,core_year;
quit;

proc freq;
table n_snf_days_12m;
run;

/*merge into full ffs 1yr, age 65+ dataset*/
proc sort data=snf_days_pre nodupkey;
by bid_hrs_21 core_year;
run;

proc sql;
create table core_ids_criteria_2a as select a.*,b.n_snf_days_12m
from core_ids_1yr_criteria a
left join
snf_days_pre b 
on trim(left(a.bid_hrs))=trim(left(b.bid_hrs_21)) and a.core_year=b.core_year;
quit;

 data core_ids_1yr_criteria_2 ;
 set core_ids_criteria_2a ;
 array list n_snf_days_12m;
 do over list;
 if list=. then list=0;
 end; 

if n_snf_days_12m=0 then ind_snf_use_12m=0;
 if n_snf_days_12m>0 & n_snf_days_12m~=. then ind_snf_use_12m=1;
 label ind_snf_use_12m="Indicator for any SNF stay 12m pre core";
 label n_snf_days_12m="SNF Days 12m pre core";

run;

proc freq;
table n_snf_days_12m ind_snf_use_12m /missprint;
run;


/****************************************************************************/
/****************************************************************************/
/*Get indicator of ESRD codes from the denominator file the year of the interview*/
/****************************************************************************/
/****************************************************************************/
proc sort data=medi.dn_2000_2012 out=dn_2000_20122  nodupkey;
by BID_HRS_21 year;
run;

/*pull ESRD status variable from dn file
for the core interview years*/
proc sql;
create table dn_core_y as select
a.*,b.ESRD_IND from 
core_ids_1yr_criteria_2 a left join
dn_2000_20122 b
on trim(left(a.BID_hrs))=trim(left(b.BID_hrs_21))
and a.c_ivw_year=b.year;
quit;

proc freq;
table ESRD_IND /missprint;
run;

data core_ids_1yr_criteria_2b;
set dn_core_y ;
if ESRD_IND='Y' then esrd_ind_n=1;
if ESRD_IND='0' then esrd_ind_n=0;
label esrd_ind_n="ESRD indicator from claims denominator file";
drop ESRD_IND;
run;

proc freq;
table esrd_ind_n /missprint;
run;


/****************************************************************************/
/*Get indicator of Home 02 use 12 months pre interview from DME claims*/
/****************************************************************************/
data oxygen_1(keep=BID_HRS_21 core_year home_oxygen);
set sic_int.dm_meet_365;
home_oxygen=0;
label home_oxygen="Home O2 from DME claims";
array list BETOS01:BETOS13;
do over list;
if list = 'D1C' then home_oxygen=1;
end;
run; 

proc sort data=oxygen_1;
by bid_hrs_21 core_year;
run;

proc freq;
table core_year /missprint;
run;

proc sql;
create table oxygen_2 as
select distinct bid_hrs_21,core_year,
sum(home_oxygen) as home_oxygen
from oxygen_1 group by bid_hrs_21,core_year;
quit;

/*convert to binary variables*/
data oxygen_3;
set oxygen_2 ;
if home_oxygen>0 then home_oxygen=1;
if home_oxygen<=0 then home_oxygen=0;
run;

proc freq;
table home_oxygen;
run;

/*merge Oxygen use variable into the overall dataset*/
proc sql;
create table core_ids_1yr_criteria_3 as select
a.*,b.home_oxygen
from core_ids_1yr_criteria_2b a left join
oxygen_3 b
on trim(left(a.BID_hrs))=trim(left(b.BID_hrs_21))
and a.core_year=b.core_year;
quit;

data core_ids_1yr_criteria_4;
set core_ids_1yr_criteria_3;
if home_oxygen=. then home_oxygen=0;
label home_oxygen="Home O2 use from DME claims 1yr pre ivw";
run;

proc freq;
table home_oxygen /missprint;
run;

/*pull in new variables to overall interview dataset*/
proc sort data=core_ids_1yr_criteria_4 nodupkey;
by bid_hrs core_year;
run;

proc sort data=sic_int.core_ids_elix_cc_1yr_2 out=core_ids_elix_cc_1yr_2;
by bid_hrs core_year;
run;

proc sql;
create table sic_int.core_ids_1yr_criteria_4(drop=bid_hrs2 core_year2) as select a.*,b.* from
core_ids_elix_cc_1yr_2 a left join
core_ids_1yr_criteria_4(rename=(bid_hrs=bid_hrs2) rename=(core_year=core_year2)
     drop=c_ivw_year c_ivw_date age_ge_65 part_ab_12m hmo_d_12m )
 	 b
on a.bid_hrs=b.bid_hrs2 and a.core_year=b.core_year2;
quit;

H="Step 5a - Get outpatient ED use info"
data op_meet_365;
set sic_int.op_meet_365(keep=bid_hrs_21 admit_date disch_date c_ivw_date core_year RVCNTR01-RVCNTR45);
run;

proc sort data=op_meet_365;
by bid_hrs_21 admit_date;
run;

data ed_op_1;
	set op_meet_365;
	ed_op=0;
	array list RVCNTR01-RVCNTR45;
	do over list;
	if list >= 450 and list < 460 and ed_op=0 then  
	ed_op = 1;
	end;
run;

proc freq;
table ed_op;
run;

proc sql;
create table ed_op_2 as select distinct bid_hrs_21,core_year,
count(case when ed_op=1 then ed_op else . end)
	as n_ed_op_visits_12m
	from ed_op_1 group by bid_hrs_21,core_year;
quit;

proc freq;
table n_ed_op_visits_12m;
run;

proc sort data=sic_int.core_ids_1yr_criteria_4 out=core_ids_1yr_criteria_4;
by bid_hrs core_year;
run;

proc sort data=ed_op_2 nodupkey;
by bid_hrs_21 core_year;
run;

/*merge into dataset*/
proc sql;
create table core_ids_1yr_criteria_4a as select a.*,b.n_ed_op_visits_12m
from core_ids_1yr_criteria_4 a
left join
ed_op_2 b 
on trim(left(a.bid_hrs))=trim(left(b.bid_hrs_21)) and a.core_year=b.core_year;
quit;

data sic_int.core_ids_1yr_criteria_4ba;
set core_ids_1yr_criteria_4a;
if n_ed_op_visits_12m=. and comorb_1_0_1yr~=. then n_ed_op_visits_12m=0;
label n_ed_op_visits_12m="Count ED OP visits, 1yr pre ivw";

if n_ed_op_visits_12m=0 then ind_ed_op_12m=0;
if n_ed_op_visits_12m>0 & n_ed_op_visits_12m~=. then ind_ed_op_12m=1;
label ind_ed_op_12m="Indicator any ED OP visits, 1 yr pre ivw";
run;

proc freq;
table n_ed_op_visits_12m*ind_ed_op_12m;
run;

/*now for the 12 months after core ivw*/

/*ids of those interviews with ffs medicare year preceding interview and 65+*/
proc sql;
create table age_ge_65_mc as 
select * from sic_int.core_ids_1yr_criteria_4ba 
where age_ge_65=1 and xwalk_yes=1 and part_ab_12m=1 and hmo_d_12m=0 
and core_year in (2000,2002,2004,2006,2008,2010,2012);
quit;

data age_ge_65_mc_ltd;
set age_ge_65_mc(keep=bid_hrs c_ivw_date core_year);
run;
proc sql;
create table op_meet_post_365 as select 
a.*,b.c_ivw_date,b.core_year
from medi.op_2000_2012(keep=bid_hrs_21 admit_date disch_date RVCNTR01-RVCNTR45) a inner join
age_ge_65_mc_ltd b
on trim(left(a.bid_hrs_21))=trim(left(b.bid_hrs))
and 0<=a.admit_date-b.c_ivw_date<=365;
quit;



proc sort data=op_meet_post_365;
by bid_hrs_21 admit_date;
run;

data ed_op_1;
	set op_meet_post_365;
	ed_op=0;
	array list RVCNTR01-RVCNTR45;
	do over list;
	if list >= 450 and list < 460 and ed_op=0 then  
	ed_op = 1;
	end;
run;

proc freq;
table ed_op;
run;

proc sql;
create table ed_op_2 as select distinct bid_hrs_21,core_year,
count(case when ed_op=1 then ed_op else . end)
	as n_ed_op_visits_p12m
	from ed_op_1 group by bid_hrs_21,core_year;
quit;

proc freq;
table n_ed_op_visits_p12m;
run;

proc sort data=sic_int.core_ids_1yr_criteria_4ba out=core_ids_1yr_criteria_4;
by bid_hrs core_year;
run;

proc sort data=ed_op_2 nodupkey;
by bid_hrs_21 core_year;
run;

/*merge into dataset*/
proc sql;
create table core_ids_1yr_criteria_4a as select a.*,b.n_ed_op_visits_p12m
from core_ids_1yr_criteria_4 a
left join
ed_op_2 b 
on trim(left(a.bid_hrs))=trim(left(b.bid_hrs_21)) and a.core_year=b.core_year;
quit;

data sic_int.core_ids_1yr_criteria_4b;
set core_ids_1yr_criteria_4a;
if n_ed_op_visits_p12m=. and comorb_1_0_1yr~=. then n_ed_op_visits_p12m=0;
label n_ed_op_visits_p12m="Count ED OP visits, 1yr after ivw";

if n_ed_op_visits_p12m=0 then ind_ed_op_p12m=0;
if n_ed_op_visits_p12m>0 & n_ed_op_visits_p12m~=. then ind_ed_op_p12m=1;
label ind_ed_op_p12m="Indicator any ED OP visits, 1 yr after ivw";
run;

proc freq;
table n_ed_op_visits_p12m*ind_ed_op_p12m;
run;

H="Step 5b - Classify serious illness based on just primary dx"
/*recoded as a macro and use either the primary diagnosis or admitting diagnoses AD_DGNS */

/*start with IP claim list, 1 year before interview*/

%macro singledx(dxvar=,name=);

data dx_1_&name.;
set sic_int.mp_meet3_365(where=(trim(left(SSLSSNF))~="N"));

&name._dx=trim(left(&dxvar.));

if &name._dx~="" then do;

chf_&name._dx=0;
copd_&name._dx=0;
hip_&name._dx=0;

/*CHF*/
if (substr(&name._dx,1,5)='39891' or
		substr(&name._dx,1,5)='40211' or
		substr(&name._dx,1,5)='40291' or
		substr(&name._dx,1,5)='40411' or
		substr(&name._dx,1,5)='40413' or
		substr(&name._dx,1,5)='40491' or
		substr(&name._dx,1,5)='40493' or
		substr(&name._dx,1,3)='428') 
		and chf_&name._dx=0 
		then chf_&name._dx=1;*add one binary variables here.;
/*COPD*/
	if (substr(&name._dx,1,3)='490' or
		substr(&name._dx,1,3)='491' or
		substr(&name._dx,1,3)='492' or
		substr(&name._dx,1,4)='4930' or
		substr(&name._dx,1,4)='4931' or
		substr(&name._dx,1,4)='4932' or
		substr(&name._dx,1,4)='4938' or
		substr(&name._dx,1,5)='49390' or
		substr(&name._dx,1,5)='49391' or
		substr(&name._dx,1,3)='494' or
		substr(&name._dx,1,3)='495' or
		substr(&name._dx,1,3)='496' or
		substr(&name._dx,1,3)='497' or
		substr(&name._dx,1,3)='498' or
		substr(&name._dx,1,3)='499' or
		substr(&name._dx,1,3)='500' or
		substr(&name._dx,1,3)='501' or
		substr(&name._dx,1,3)='502' or
		substr(&name._dx,1,3)='503' or
		substr(&name._dx,1,3)='504' or
		substr(&name._dx,1,3)='505' or
		substr(&name._dx,1,4)='5064') 
			and copd_&name._dx=0 
		then copd_&name._dx=1;	
*hip fracture;
if (substr(&name._dx,1,3)='820' ) 
		and hip_&name._dx=0 
		then hip_&name._dx=1;*add one binary variables here.;
end;
run;

proc sql;
create table &name._dx_2 as
select distinct BID_hrs_21,core_year,
sum(chf_&name._dx) as chf_&name.,
sum(copd_&name._dx) as copd_&name.,
sum(hip_&name._dx) as hip_&name.
from dx_1_&name.
group by BID_hrs_21,core_year;
quit;

/*convert counts of diagnoses for each comorbidity to indicator variables*/ 
data &name._dx_3(keep=BID_hrs_21 core_year chf_&name._dx copd_&name._dx hip_&name._dx);
set &name._dx_2 ;
array list_com chf_&name. copd_&name. hip_&name.;
array list_com_bin chf_&name._dx copd_&name._dx hip_&name._dx;

do over list_com;
  list_com_bin=0;

  if list_com>0 then do;
    list_com_bin=1;
   end;

end;

run;

proc freq;
table chf_&name._dx copd_&name._dx hip_&name._dx;
run;
%mend;

/*use primary diagnosis code*/
%singledx(dxvar=dgns_cd01,name=pri);
/*use admitting diagnosis code*/
%singledx(dxvar=AD_DGNS,name=adm);

/*merge into the dataset that is just ffs 1 yr, 65+ age*/
proc sql;
create table core_ids_1yr_criteria_4c as select a.*,b.chf_pri_dx,
b.copd_pri_dx,b.hip_pri_dx
from sic_int.core_xwalk_ins_ffs_only a
left join
pri_dx_3 b 
on trim(left(a.bid_hrs))=trim(left(b.bid_hrs_21)) and a.core_year=b.core_year;
quit;

proc sql;
create table core_ids_1yr_criteria_4d as select a.*,b.chf_adm_dx,
b.copd_adm_dx,b.hip_adm_dx
from core_ids_1yr_criteria_4c a
left join
adm_dx_3 b 
on trim(left(a.bid_hrs))=trim(left(b.bid_hrs_21)) and a.core_year=b.core_year;
quit;

data core_ids_1yr_criteria_4e;
set core_ids_1yr_criteria_4d;

array list chf_pri_dx copd_pri_dx hip_pri_dx chf_adm_dx copd_adm_dx hip_adm_dx;
do over list;
	if list = .  then list=0;
end;
label chf_pri_dx="CHF as primary dx from IP claim, 1yr pre ivw";
label copd_pri_dx="COPD as primary dx from IP claim, 1yr pre ivw";
label hip_pri_dx="Hip fracture as primary dx from IP claim, 1yr pre ivw";

label chf_adm_dx="CHF as admitting dx from IP claim, 1yr pre ivw";
label copd_adm_dx="COPD as admitting dx from IP claim, 1yr pre ivw";
label hip_adm_dx="Hip fracture as admitting dx from IP claim, 1yr pre ivw";

run;

proc freq;
table chf_pri_dx*chf_adm_dx copd_pri_dx*copd_adm_dx hip_pri_dx*hip_adm_dx ;
run;

/*Hip fracture criteria, method  by Covinsky
One of the (2) criteria met:
(1) Subject was admitted to a hospital with admitting diagnosis of 820.xx.
(2) There is a physician record of HF procedure (defined by CPT code of 27230-27248) that is supported by either: 
a. Another physician record within 2 days OR 2
b. Relevant surgery during hospitalization. (Relevant surgery is defined by ICD9 codes 785.5, 790.5, 791.5, 792.5). 
(1) variable hip_adm_dx defined in macro above
(2) HF procedure: carrier claims 	(HCPCS_YR specifies the year of CPT coding used)
					HCPSCD01-HCPSCD13 The level 1 HCPCS code is the CPT code
Then a)from carrier claims or 
     b) from IP claims
	

For item (2) checked inpatient claims variables HCPSCD01-45 but none had any of the CPT codes in the list
Next step, try running with carrier files...
*/

/********************************************************************/
/*Physican record of HF procedure, check IP claims
There are no observations with the HF procedure codes in the IP claims, this method isn't
used in creating the final variable*/
data ip_meet_365;
set sic_int.ip_meet3_365;
run;

proc contents data=ip_meet_365;
run;

data testhf;
set ip_meet_365;
if HCPSCD01~='';
run;

data hfproc_ip;
set ip_meet_365;
hf_proc_ind=0;
array list HCPSCD01-HCPSCD45;
do over list;
if list~='' then do;
	if (list='27230' or
		list='27231' or
		list='27232' or
		list='27233' or
		list='27234' or
		list='27235' or
		list='27236' or
		list='27237' or
		list='27238' or
		list='27239' or
		list='27240' or
		list='27241' or
		list='27242' or
		list='27243' or
		list='27244' or
		list='27245' or
		list='27246' or
		list='27247' or
		list='27248')
		/*and hf_proc_ind=0*/
		then hf_proc_ind=1;
	end;
end;


run;

proc freq; table hf_proc_ind;
run;

/********************************************************************/
/*Physican record of HF procedure, check carrier claims*/
/********************************************************************/

data hfproc_carr;
set sic_int.pb_meet_365;
hf_proc_ind=0;
array list HCPSCD01-HCPSCD13;
do over list;
if list~='' then do;
	if (list='27230' or
		list='27231' or
		list='27232' or
		list='27233' or
		list='27234' or
		list='27235' or
		list='27236' or
		list='27237' or
		list='27238' or
		list='27239' or
		list='27240' or
		list='27241' or
		list='27242' or
		list='27243' or
		list='27244' or
		list='27245' or
		list='27246' or
		list='27247' or
		list='27248')
		/*and hf_proc_ind=0*/
		then hf_proc_ind=1;
	end;
end;


run;

proc freq; table hf_proc_ind;
run;
/********************************************************************/
/*is there also a physican record within 2 days?*/
proc sort data=hfproc_carr; by BID_HRS_21 FROM_DT THRU_DT hf_proc_ind;
run;

data hfproc_carr_2;
set hfproc_carr;
if eof1=0 then
	set hfproc_carr (firstobs=2 keep=admit_date disch_date rename=(admit_date=lead1admit disch_date=lead1disch)) end=eof1;
else do; lead1admit=.;  lead1disch=.; end;
run;

data hfproc_carr_3;
set hfproc_carr_2;
days_next_visit=lead1admit-disch_date;
days_next_disch=lead1disch-disch_date;
if hf_proc_ind=1 and days_next_visit<=2 and days_next_visit~=. & days_next_disch>0 then hf_w_visit_2d=1;
else hf_w_visit_2d=0;
run;

data hfproc_carr_4;
set hfproc_carr_3;
if hf_proc_ind=1;
run;

proc freq data=hfproc_carr_3;
table hf_proc_ind hf_w_visit_2d core_year; run;

/*if have hf CPT code from carrier, but no subsequent carrier claim,
do they have a surgery code from the inpatient claims?*/
data hfproc_carr_5;
set hfproc_carr_4;
if hf_proc_ind=1 and hf_w_visit_2d=0;
run;




/*for b) identify relevant surgeries from IP claims CPT codes and surgery dates*/

/*This section of code for just checking For Surgeries*/
data ip_meet_365;
set sic_int.mp_meet3_365(where=(trim(left(SSLSSNF))~="N"));
run;

proc contents data=ip_meet_365;
run;

data proc_long(keep=BID_hrs_21 TYPE_ADM procedure procedure_date date_imp_yes AD_DGNS DGNS_CD01-DGNS_CD25
	 admit_date disch_date core_year);
set ip_meet_365;
array list PRCDR_CD01-PRCDR_CD25;
array date PRCDR_DT01-PRCDR_DT25;
do over list;
if list~="" then do;
	procedure=list;
	if date=0000000 then do;
		procedure_date=admit_date;
		date_imp_yes=1;
		end;
	if date~=0000000 then do;
	procedure_date=datejul(date);
	end;
	output;
end;
end;

format procedure_date date10.;
format admit_date date10.;
format disch_date date10.;

run;

proc freq; table date_imp_yes; run;

/* Identify surgeries that meet the criteria
Indicator variable surgery_meet = 1 if yes, include in sample 
79 surgeries meet the criteria*/
data surgery_meet;
set proc_long;
if length(compress(procedure))>3 then do;

if compress(procedure)+0 in (7855, 7905, 7915, 7925) then surgery_meet=1;

end;
/*only keep observations in work.surgery_meet that meet criteria*/
if surgery_meet then output;

run;
/*End surgery section 1*/

/*who has surgery that meets criteria AND hf CPT code from carrier?*/
proc sql;
create table cpt_and_surg as select a.*,b.admit_date as carr_hf_admit, b.disch_date as carr_hf_disch,
b.hf_proc_ind, b.hf_w_visit_2d from 
surgery_meet a inner join
hfproc_carr_5 b
on a.bid_hrs_21=b.bid_hrs_21;
quit;

data cpt_and_surg_1;
set cpt_and_surg;
format carr_hf_admit carr_hf_disch date9.;
hf_w_surgery=1;
run;

/*now merge in lists to get a list of bid's that meet criteria 1 or 2*/
data cpt_and_surg_2;
set cpt_and_surg_1;
keep bid_hrs_21 hf_proc_ind hf_w_surgery core_year;
run;

proc sort data=cpt_and_surg_2 nodupkey; by bid_hrs_21 core_year ; run;

data hfproc_carr_6;
set hfproc_carr_4;
keep bid_hrs_21 hf_proc_ind hf_w_visit_2d core_year;
if hf_proc_ind=1 and hf_w_visit_2d=1;
run;

proc sort data=hfproc_carr_6 nodupkey; by bid_hrs_21  core_year ; run;

*merge the datasets;
data hf_meet;
merge hfproc_carr_6 cpt_and_surg_2 ;
by bid_hrs_21 core_year;
run;

proc sort data=hf_meet out=hf_meet2 nodupkey; by bid_hrs_21  core_year; run;

/*merge in these hip fracture variables*/
proc sql;
create table core_ids_1yr_criteria_4f
as select a.*,b.hf_w_visit_2d,b.hf_w_surgery from
core_ids_1yr_criteria_4e a left join
hf_meet2 b
on a.bid_hrs=b.bid_hrs_21 and a.core_year=b.core_year;
quit;

proc freq; table hf_w_visit_2d*hf_w_surgery /missprint;
run;

data core_ids_1yr_criteria_4g;
set core_ids_1yr_criteria_4f;

array list hf_w_visit_2d hf_w_surgery ;
do over list;
	if list = .  then list=0;
end;
label hf_w_visit_2d ="HF CPT + Dr visit within 2 days, 1yr pre ivw";
label hf_w_surgery ="HF CPT + Surgery, 1yr pre ivw";

run;

proc freq; table hf_w_visit_2d hf_w_surgery; run;

/*Another idea is to check IP claims
if CPT code (in fields HCPCSCD01-HCPCSCD45 in list then if PRCDRCD1-PRCDRCD25 in list = hip frature = yes*/

/*merge new variables into full interview dataset*/
proc sql;
create table sic_int.core_ids_1yr_criteria_4g(drop=bid_hrs2 core_year2) as select a.*,b.* from
sic_int.core_ids_1yr_criteria_4b a left join
core_ids_1yr_criteria_4g(rename=(bid_hrs=bid_hrs2) rename=(core_year=core_year2)
     drop=c_ivw_year c_ivw_date age_ge_65 part_ab_12m hmo_d_12m )
 	 b
on a.bid_hrs=b.bid_hrs2 and a.core_year=b.core_year2;
quit;

H="Step 6 - HRS variable cleaning and check criteria"
/*This section defines the serious medical illness indicators
as well as the additional criteria for serious illness
1. Serious medical illness
2. ADL impairment
3. Self report nursing home residence
4. Urgent or emergent hospitalization 

2 sets of criteria are used:
Criteria A: Either serious medical illness or ADL impairment
Criteria B: Critera A + either nursing home resident or hospitalization*/

proc freq
data=sic_int.core_ids_1yr_criteria_4g;
table dem_dx_1yr*comorb_31_0_1yr;
run;

data sic_int.core_ids_1yr_criteria_5;
set sic_int.core_ids_1yr_criteria_4g ;

/*create tics categorical variable*/
if tics_tot>8 then tics_cat=1 ;
if 5<=tics_tot<=8 then tics_cat=2 ;
if 0<=tics_tot<=4 then tics_cat=3 ;
label tics_cat="TICS 1=normal, 2=MCI, 3=Demented";

/*any elixhauser cancer dx*/
if comorb_17_0_1yr=1 | comorb_18_0_1yr=1 | comorb_19_0_1yr=1 then el_cancer_1yr=1;
if comorb_17_0_1yr=0 & comorb_18_0_1yr=0 & comorb_19_0_1yr=0 then el_cancer_1yr=0;

/*3 or more Elixhauser comorbidities*/
if comorb_all_0_1yr>2 then el_ge3_comorb_1yr=1;
if 0=<comorb_all_0_1yr<=2 then el_ge3_comorb_1yr=0;

/*4 or more comorbidities - needs to be reevaluated once other defs are defined!*/
if comorb_all_0_1yr>3 then el_ge4_comorb_1yr=1;
if 0=<comorb_all_0_1yr<=3 then el_ge4_comorb_1yr=0;

cc_all_count_1yr = cc_1_ami_1yr + cc_2_alzh_1yr + cc_3_alzhdmta_1yr + 
cc_4_atrialfb_1yr + cc_5_cataract_1yr + cc_6_chrnkidn_1yr + 
cc_7_copd_1yr + cc_8_chf_1yr + cc_9_diabetes_1yr + cc_10_glaucoma_1yr + 
cc_11_hipfrac_1yr + cc_12_ischmcht_1yr + cc_13_depressn_1yr + 
cc_14_osteoprs_1yr + cc_15_ra_oa_1yr + cc_16_strketia_1yr + 
cc_17_cncrbrst_1yr + cc_18_cncrclrc_1yr + cc_19_cncrprst_1yr + 
cc_20_cncrlung_1yr + cc_21_cncrendm_1yr;

if cc_all_count_1yr >3 then cc_ge4_comorb_1yr=1;
if 0=<cc_all_count_1yr <=3 then cc_ge4_comorb_1yr=0;

/*cc's excluding cataract and glaucoma*/
cc_all_count_1yr_2 = cc_1_ami_1yr + cc_2_alzh_1yr + cc_3_alzhdmta_1yr + 
cc_4_atrialfb_1yr + /*cc_5_cataract_1yr +*/ cc_6_chrnkidn_1yr + 
cc_7_copd_1yr + cc_8_chf_1yr + cc_9_diabetes_1yr + /*cc_10_glaucoma_1yr +*/ 
cc_11_hipfrac_1yr + cc_12_ischmcht_1yr + cc_13_depressn_1yr + 
cc_14_osteoprs_1yr + cc_15_ra_oa_1yr + cc_16_strketia_1yr + 
cc_17_cncrbrst_1yr + cc_18_cncrclrc_1yr + cc_19_cncrprst_1yr + 
cc_20_cncrlung_1yr + cc_21_cncrendm_1yr;
label cc_all_count_1yr_2="Count of cc's, excludes cataract and glaucoma";

if cc_all_count_1yr_2>3 then cc2_ge4_comorb_1yr=1;
if 0=<cc_all_count_1yr_2<=3 then cc2_ge4_comorb_1yr=0;

label el_ge3_comorb_1yr="3+ Elixhauser comorbidities";
label el_ge4_comorb_1yr="4+ Elixhauser comorbidities";
label cc_ge4_comorb_1yr="4+ DW Chronic Conditions";
label cc2_ge4_comorb_1yr="4+ DW Chronic Conditions, excl cataract and glaucoma";

/***************************************************/
/*create indicators for any indication of the serious medical illnesses across
variables (cc's elix hrs survey) */
/*dementia requires more than 1 dementia diagnosis 1 year before ivw*/
if dem_dx_1yr>=2 and dem_dx_1yr~=. then smi_dem_ind=1;
if dem_dx_1yr=0 or dem_dx_1yr=1 then smi_dem_ind=0;
label smi_dem_ind="Indicator of Dementia 1yr, Elixhauser 2+dx req.";

/*old def commented out
if el_cancer_1yr=1 | CC_cncr_chronic_1yr=1 | cancer_hrs=1 then cancer_any_ind=1;
if el_cancer_1yr=0 & CC_cncr_chronic_1yr=0 & cancer_hrs=0 then cancer_any_ind=0; */
/*cancer flagged as serious medical illness if metastatic cancer 
or blood cancers new def to be provided from Amy*/
if comorb_18_0_1yr=1 then smi_cancer_ind=1;
if comorb_18_0_1yr=0 then smi_cancer_ind=0;
label smi_cancer_ind="Indicator of Metastatic Cancer 1yr";

/*ESRD from either dx code per elixhauser or denominator file flag*/
if comorb_13_0_1yr=1 | esrd_ind_n=1 then smi_esrd_ind=1;
if comorb_13_0_1yr=0 & esrd_ind_n=0  then smi_esrd_ind=0;
label smi_esrd_ind="Indicator of ESRD 1yr, Elix and claims DN file";

/*chf, use dx list for Elixhauser, but as primary DX from a hospitalization only*/
if chf_pri_dx=1  then smi_chf_ind=1;
if chf_pri_dx=0  then smi_chf_ind=0;
label smi_chf_ind="Indicator of CHF 1yr, Primary dx from IP claim";

/*COPD indicator meets following criteria:
1. COPD from Elix (any dx field) and Oxygen use from DME claims or
2. COPD as a primary diagnosis from a hospitalization*/
if (comorb_9_0_1yr=1 & home_oxygen=1) | copd_pri_dx=1 then smi_copd_ind=1;
if (comorb_9_0_1yr=0 | home_oxygen=0) & copd_pri_dx=0 then smi_copd_ind=0;
label smi_copd_ind="Indicator of COPD 1yr, copd any dx and home o2 use or copd as prim dx";

/*diabetes, Elix 11 (diabetes with complications) if criteria for 
renal disease (comorb 34), ischemic heart disease (cc 12) or 
peripheral vascular disease (comorb 5) are present*/
if comorb_11_0_1yr=1 & (comorb_5_0_1yr=1 | comorb_34_0_1yr=1 | CC_12_ISCHMCHT_1yr =1) then
	smi_diab_compl_ind=1;
if comorb_11_0_1yr=0 | (comorb_5_0_1yr=0 & comorb_34_0_1yr=0 & CC_12_ISCHMCHT_1yr =0) then
	smi_diab_compl_ind=0;
label smi_diab_compl_ind="Elix compl diabetes + peripheral vas, renal or ischem, 1yr";

if comorb_14_0_1yr=1 then smi_liver_ind=1;
if comorb_14_0_1yr=0 then smi_liver_ind=0;
label smi_liver_ind="Indicator of Advanced liver disease/cirrhosis 1yr, elix";

/*Update 6/9/14 - HIV not included in final list of serious medical illnesses for
the criteria definition
4/2/15 - Added HIV back into list*/
if comorb_16_0_1yr=1 then smi_hiv_ind=1;
if comorb_16_0_1yr=0 then smi_hiv_ind=0;
label smi_hiv_ind="Indicator of HIV with and AIDS defining illness 1yr, elix";

if comorb_33_0_1yr=1 then smi_als_ind=1;
if comorb_33_0_1yr=0 then smi_als_ind=0;
label smi_als_ind="Indicator of ALS 1yr, icd9 code";

/*hip fracture, either admitting diagnosis or CPT from carrier claim AND
surgery or follow up carrier claim within 2 days*/
if hip_adm_dx=1 | hf_w_visit_2d=1 | hf_w_surgery=1 then smi_hip_ind=1;
if hip_adm_dx=0 & hf_w_visit_2d=0 & hf_w_surgery=0 then smi_hip_ind=0;
label smi_hip_ind="Indicator of Hip fracture 1yr, adm dx or from physician claims";
/*******************************************************************/
/*******************************************************************/

/*doesn't use the cc definition excluding cataract,glaucoma cc2_ge4_comorb_1yr */
if el_ge4_comorb_1yr=1 | cc_ge4_comorb_1yr=1 | comor_c_hrs=1 then multi_any_ind=1;
if el_ge4_comorb_1yr=0 & cc_ge4_comorb_1yr=0 & comor_c_hrs=0 then multi_any_ind=0;
label multi_any_ind="Any indicator of Multimorbidity 4+ chronic conditions 1yr";

/*total number of serious medical illnesses per these definitions*/
smi_count=smi_dem_ind + smi_cancer_ind + smi_esrd_ind + smi_chf_ind + smi_copd_ind + 
 smi_diab_compl_ind + smi_liver_ind + smi_hiv_ind + smi_als_ind + smi_hip_ind;

/*indicator for 3+serious medical illnesses*/
if smi_count>=3 then smi_ge3_ind=1;
if smi_count<3 then smi_ge3_ind=0;
label smi_ge3_ind="3 or more serious medical illnesses";

/*indicator for any serious medical illness
Update 6/9/14 - HIV not included in list of serious medical illnesses*/
if smi_dem_ind =1 | smi_cancer_ind =1 | smi_esrd_ind =1 | smi_chf_ind =1 | 
 smi_copd_ind =1 | smi_diab_compl_ind =1 | smi_liver_ind =1 | smi_hiv_ind =1 | 
 smi_als_ind =1 | smi_hip_ind=1
 then ser_med_illness=1;
if smi_dem_ind =0 & smi_cancer_ind =0 & smi_esrd_ind =0 & smi_chf_ind =0 & 
 smi_copd_ind =0 & smi_diab_compl_ind =0 & smi_liver_ind =0 & smi_hiv_ind =0 & 
 smi_als_ind =0 & smi_hip_ind=0
 then ser_med_illness=0;
label ser_med_illness="Any indicator of serious medical illness 1yr";

/*Indicator for any SNF stays 12m prior to interview or current nh res
Update 6/2/14 - nursing home use will be included only if current nh residence reported,
not if any SNF claims found*/
if /*ind_snf_use_12m=1 |*/ nhres=1 then smi_nh_ind=1;
if /*ind_snf_use_12m=0 &*/ nhres=0 then smi_nh_ind=0;
label smi_nh_ind="Nursing home resident self report in ivw";

/*indicator for adl helper*/
if adl_helper_count>0 & adl_helper_count~=. then smi_helper_ind=1;
if adl_helper_count=0 then smi_helper_ind=0;
label smi_helper_ind="Indicator of having any helpers with ADL, core";

/*backfill adl status if adl helper variable is complete*/
adl_ind_core_n = adl_independent_core;
if adl_independent_core=. and smi_helper_ind=1 then adl_ind_core_n=0;
if adl_independent_core=. and smi_helper_ind=0 then adl_ind_core_n=1;
label adl_ind_core_n = "ADL independent at core interview, using SR and helper file";

if adl_ind_core_n=1 then adl_impair_core = 0;
if adl_ind_core_n=0 then adl_impair_core = 1;
label adl_impair_core = "ADL impairment at core interview, using SR and helper file";

/*indicator for any ED visit, either OP or IP*/
if ind_ed_op_12m=1 | ind_ED_adm_12m=1 then ind_ed_op_or_ip_12m=1;
if ind_ed_op_12m=0 & ind_ED_adm_12m=0 then ind_ed_op_or_ip_12m=0;
label ind_ed_op_or_ip_12m="Indicator any ED use 12m pre ivw";

/*criteria (A) serious medical illness and/or ADL impairment*/
if (ser_med_illness=1 | adl_impair_core =1) then criteria_a=1;
if (ser_med_illness=0 & adl_impair_core =0) then criteria_a=0;
label criteria_a="Crit A SMI and/or ADL impair";

/*indicator for serious medical illness and ADL impairment*/
if (ser_med_illness=1 & adl_impair_core =1) then smi_and_adl=1;
if (ser_med_illness=0 | adl_impair_core =0) then smi_and_adl=0;
label smi_and_adl="SMI and ADL impairment";

/*criteria (B) serious medical illness and/or ADL impairment AND nh res or urgent/emergent hosp*/
if (ser_med_illness=1 | adl_impair_core =1) & (ind_em_ur_adm_12m=1 | smi_nh_ind=1) then criteria_b=1;
if (ser_med_illness=0 & adl_impair_core =0) | (ind_em_ur_adm_12m=0 & smi_nh_ind=0) then criteria_b=0;
label criteria_b="Crit B SMI or ADL impair and hospital admit or nh use";

/*criteria (C) serious medical illness and adl impairment AND nh res or urgent/emergent hosp*/
if (ser_med_illness=1 & adl_impair_core =1) & (ind_em_ur_adm_12m=1 | smi_nh_ind=1) then criteria_c=1;
if (ser_med_illness=0 | adl_impair_core =0) | (ind_em_ur_adm_12m=0 & smi_nh_ind=0) then criteria_c=0;
label criteria_c="Crit C SMI and ADL impair and hospital admit or nh use";

/*serious medical illness criteria variable defined, so name matches format of other criteria indicators*/
criteria_smi=ser_med_illness;
label criteria_smi="Comparison criteria - SMI";

run;

 ods rtf body="E:\data\serious_ill\logs\criteria_vars_before_coredate.rtf";

title "Number of unique people in full cohort 2000-2012";
proc sql;
select count(distinct id) from sic_int.core_ids_1yr_criteria_5
where core_year in (2000,2002,2004,2006,2008,2010,2012);

title "Unique R's w/ Age 65+";
select count(distinct id) from sic_int.core_ids_1yr_criteria_5
where age_ge_65=1 and core_year in (2000,2002,2004,2006,2008,2010,2012);

title "Unique R's w/ Age 65+, With mc xwalk id";
select count(distinct id) from sic_int.core_ids_1yr_criteria_5
where age_ge_65=1 and xwalk_yes=1 and core_year in (2000,2002,2004,2006,2008,2010,2012);

title "Unique R's w/ Age 65+, With mc xwalk id, and FFS 1yr pre-ivw";
select count(distinct id) from sic_int.core_ids_1yr_criteria_5
where age_ge_65=1 and xwalk_yes=1 and part_ab_12m=1 and hmo_d_12m=0 
and core_year in (2000,2002,2004,2006,2008,2010,2012);

create table age_ge_65_mc as 
select * from sic_int.core_ids_1yr_criteria_5
where age_ge_65=1 and xwalk_yes=1 and part_ab_12m=1 and hmo_d_12m=0 
and core_year in (2000,2002,2004,2006,2008,2010,2012);
quit;

title "Dementia - elix, 2+ diagnoses required";
proc freq data=age_ge_65_mc ;
table smi_dem_ind /missprint;
run;

title "Cancer - elix, metastatic or hematologic cancer";
proc freq data=age_ge_65_mc ;
table smi_cancer_ind /missprint ;
run;

title "End Stage Renal Disease - elix, claims denominator file year of core ivw";
proc freq data=age_ge_65_mc ;
table comorb_13_0_1yr esrd_ind_n comorb_13_0_1yr*esrd_ind_n ind_hosp_adm_12m*esrd_ind_n smi_esrd_ind /missprint;
run;

title "CHF+Indicator of more advanced disease - elix + some utilization measure TBD!";
proc freq data=age_ge_65_mc ;
table smi_chf_ind chf_pri_dx chf_adm_dx /missprint;
run;

title "COPD, Either (1) ICD=9 code in any claim + DME claim for home O2 OR (2) COPD as primary dx in IP claim";
proc freq data=age_ge_65_mc ;
table smi_copd_ind /missprint;
run;

*data o2_no_copd;
*set age_ge_65_mc ;
*if smi_lung_02_ind =0 and home_oxygen =1;
*run;

*title "Among interviews with home O2 use but no COPD, check to see if these are CHF patients?";
*proc freq data=o2_no_copd;
*table  smi_chf_ind*home_oxygen /missprint;
*run;

title "Diabetes with severe complications (renal disease, ischemic hd or peripheral vascular disease)";
proc freq data=age_ge_65_mc ;
table smi_diab_compl_ind /missprint;
run;

title "Advanced liver disease/cirrhosis - elix";
proc freq data=age_ge_65_mc ;
table smi_liver_ind /missprint;
run;

title "HIV with and AIDS defining illness - elix";
proc freq data=age_ge_65_mc ;
table smi_hiv_ind /missprint;
run;

title "ALS - just single dx code ";
proc freq data=age_ge_65_mc ;
table smi_als_ind /missprint;
run;

title "Hip fracture, CC";
proc freq data=age_ge_65_mc ;
table smi_hip_ind /missprint;
run;

title "Multimorbidity, 3+serious medical illnesses as defined here";
proc freq data=age_ge_65_mc ;
table smi_count smi_ge3_ind /missprint;
run;

title "Any ADL help, HRS";
proc freq data=age_ge_65_mc ;
table adl_independent_core /missprint;
run;

title "Hospital admissions 6m, 12m before core interview";
proc freq data=age_ge_65_mc  ;
table ind_hosp_adm_6m*ind_em_ur_adm_6m ind_hosp_adm_12m*ind_em_ur_adm_12m 
ind_em_adm_12m*ind_ED_adm_12m ind_em_ur_adm_12m*ind_ED_adm_12m /missprint;
run;

title "Elective vs non elective hospital admissions, 12m before core";
proc freq data=age_ge_65_mc  ;
table ind_nonelect_adm_12m n_nonelect_adm_12m ind_elect_adm_12m n_elect_admit_12m /missprint;
run;

title "ED visit without subsequent admission from OP claims, 12m pre interview";
proc freq data=age_ge_65_mc  ;
table ind_ed_op_12m n_ed_op_visits_12m ind_ed_op_or_ip_12m/missprint;
run;

title "Nursing home use 12m before core interview or self report NH resident at interview";
proc freq data=age_ge_65_mc  ;
table ind_snf_use_12m*nhres smi_nh_ind /missprint;
run;

title "Any helper with ADLs, core interview";
proc freq data=age_ge_65_mc  ;
table smi_helper_ind smi_helper_ind*adl_independent_core adl_impair_core /missprint;
run;

title "Number of R's that meet A)Any serious illness";
proc sql;
select count(distinct id) from age_ge_65_mc  
where ser_med_illness=1;

title "Number of R's that meet HIV";
proc sql;
select count(distinct id) from age_ge_65_mc  
where smi_hiv_ind=1;

title "Number of R's that meet B)Any ADL help";
proc sql;
select count(distinct id) from age_ge_65_mc  
where adl_impair_core=1;

title "Number of R's that meet Criteria A: Serious medical illness and/or Any ADL help";
proc sql;
select count(distinct id) from age_ge_65_mc  
where (criteria_a=1);

title "Number of R's that meet Criteria B: Serious medical illness and/or Any ADL help and NH use and/or Hospitalization";
proc sql;
select count(distinct id) from age_ge_65_mc  
where criteria_b=1;

title "Number of R's that meet Criteria C: Serious medical illness and Any ADL help and NH use and/or Hospitalization";
proc sql;
select count(distinct id) from age_ge_65_mc  
where criteria_c=1;

title "Number of R's that meet Any urgent or emergent hospital admission 12m preceding core interview";
proc sql;
select count(distinct id) from age_ge_65_mc  
where ind_em_ur_adm_12m=1;

title "Number of R's that meet NH resident at interview ";
proc sql;
select count(distinct id) from age_ge_65_mc  
where smi_nh_ind=1;

title "Number of R's that meet Any helper with ADLs core interview";
proc sql;
select count(distinct id) from age_ge_65_mc  
where smi_helper_ind=1;

title "Number of R's that meet Any serious illness and ADL help";
proc sql;
select count(distinct id) from age_ge_65_mc  
where (ser_med_illness=1 and adl_impair_core=1) ;

title "Number of R's that meet Any serious illness and Urgent or Emergency hospital admission";
proc sql;
select count(distinct id) from age_ge_65_mc  
where (ser_med_illness=1 and ind_em_ur_adm_12m=1) ;

ods rtf close; 

/*******************************************************************************/
/*17 observations where esrd flag in denominator file = 1 but no esrd comorbidity
what are these peoples diagnoses?*/
data esrd_check_1;
set age_ge_65_mc;
if esrd_ind_n=1 and comorb_13_0_1yr=0;
run;

proc freq data=esrd_check_1; table part_ab_12m hmo_d_12m; run;

proc sql;
create table esrd_check_2 as select a.* from 
dx_all_last_1yr a join
esrd_check_1 b
on a.bid_hrs_21=b.bid_hrs and a.core_year=b.core_year;
quit;

ods rtf body="E:\data\serious_ill\logs\check_esrd_2012.rtf";
title "n=17 with esrd flag in denominator file but not from elixhauser comorb definition";
proc freq data=esrd_check_2 order=freq; table diag; run;
quit;
ods rtf close;

/*export full dataset to Stata*/
proc export data=sic_int.core_ids_1yr_criteria_5
outfile="E:\data\serious_ill\int_data\core_ids_1yr_criteria_5.dta" replace;
run;


H="Step 7 - Stata do file to get sample, criteria"
/*Stata do file to look at sample selection and serious illness cohort criteria*/

capture log close

clear all
set more off

local logpath E:\data\serious_ill\logs
local datapath E:\data\serious_ill\int_data

log using "`logpath'\2-sic_initial_criteria.txt", text replace

cd `datapath'

use core_ids_1yr_criteria_5.dta
*******************************************************************
/*also get nw_quartile for those over 65*/
drop nw_*

levelsof core_year, local(levels)
gen nw_quartile_65=.
foreach y of local levels {
	xtile nq=networth_adj2012 if core_year==`y' & age_at_core>=65, nq(4)
	replace nw_quartile=nq if nw_quartile==.
	drop nq
}

label var nw_quartile "Networth, quartiles, based on 2012$ adjusted nw at age>=65 by year"

tab nw_quart, gen(nw_q)
rename nw_q1 nw_lowest
rename nw_q2 nw_midlow
rename nw_q3 nw_midhigh
rename nw_q4 nw_highest

label variable nw_lowest "Networth, lowest quartile"
label variable nw_midlow "Networth, second quartile"
label variable nw_midhigh "Networth, third quartile"
label variable nw_highest "Networth, highest quartile"

tab nw_lowest, missing
tab nw_midlow, missing
tab nw_midhigh, missing
tab nw_highest, missing

** Networth missing **
generate nw_missing = 0
replace nw_missing = 1 if (nw_quart==.)
label variable nw_missing "Networth missing"
tab nw_missing, missing

mat sample_set=J(7,1,.)

tab core_year, missing
sum core_year
mat sample_set[1,1]=r(N)

sum core_year if inlist(core_year,2000,2002,2004,2006,2008,2010)
mat sample_set[2,1]=r(N)

sum core_year if inlist(core_year,2000,2002,2004,2006,2008,2010) & age_ge_65==1
mat sample_set[3,1]=r(N)

sum core_year if inlist(core_year,2000,2002,2004,2006,2008,2010) & age_ge_65==1 & xwalk_yes==1
mat sample_set[4,1]=r(N)

sum core_year if inlist(core_year,2000,2002,2004,2006,2008,2010) & age_ge_65==1 & xwalk_yes==1 & ///
part_ab_12m==1 & hmo_d_12m==0
mat sample_set[5,1]=r(N)

//check if only require 6 month ffs pre interview, what changes??
sum core_year if inlist(core_year,2000,2002,2004,2006,2008,2010) & age_ge_65==1 & xwalk_yes==1 & ///
part_ab_6m==1 & hmo_d_6m==0
mat sample_set[6,1]=r(N)

//check if have wage index merged in (FFS 1 year)
sum core_year if inlist(core_year,2000,2002,2004,2006,2008,2010) & age_ge_65==1 & xwalk_yes==1 & ///
part_ab_12m==1 & hmo_d_12m==0 & wage_index_2012_2!=.
mat sample_set[7,1]=r(N)

mat rownames sample_set="Core interviews 1998-2012" "Core Interviews 2000-2010" "Age 65+" ///
"With xwalk id" "With FFS MC 1yr pre-ivw" "With FFS MC 6m pre-ivw" "With 1 year FFS & Wage Index"

mat colnames sample_set="Interviews"

mat list sample_set

frmttable using `logpath'\sic_Table1_sample, statmat(sample_set) ///
title("Serious illness cohort, sample criteria") ///
ctitle("","N Interviews") ///
sdec(0) replace

//drop interviews that don't meet above criteria
keep if inlist(core_year,2000,2002,2004,2006,2008,2010) & age_ge_65==1 & xwalk_yes==1 & ///
part_ab_12m==1 & hmo_d_12m==0
*note-11,577 unique individuals are eligible with 35,171 interviews

save core_ids_1yr_criteria_5_sample1.dta, replace

*******************************************************************
log close


H="Step 7a - Stata looking at criteria"
capture log close

clear all
set more off

local logpath E:\data\serious_ill\logs
local datapath E:\data\serious_ill\int_data

log using "`logpath'\3-sic_initial_criteria_2.txt", text replace

cd `datapath'

use core_ids_1yr_criteria_5_sample1.dta

*******************************************************************
//look at criteria variables at the interview level

//Criteria A medical illness and/or adl impairment

tab criteria_a, missing

tab smi_and_adl, missing

gen byte smi_or_adl_and_nh=.
replace smi_or_adl_and_nh=1 if criteria_a==1 & smi_nh_ind==1
replace smi_or_adl_and_nh=0 if criteria_a==0 | smi_nh_ind==0
tab smi_or_adl_and_nh, missing

gen byte smi_or_adl_and_hosp=.
replace smi_or_adl_and_hosp=1 if criteria_a==1 & ind_em_ur_adm_12m==1
replace smi_or_adl_and_hosp=0 if criteria_a==0 | ind_em_ur_adm_12m==0
tab smi_or_adl_and_hosp, missing

tab criteria_c, missing

//serious medical illness variables (19 vars)
local smi_vars smi_dem_ind smi_cancer_ind smi_esrd_ind smi_chf_ind smi_copd_ind ///
smi_diab_compl_ind smi_liver_ind smi_hiv_ind smi_als_ind smi_hip_ind ///
ser_med_illness smi_ge3_ind adl_impair_core smi_and_adl criteria_a smi_or_adl_and_nh ///
smi_or_adl_and_hosp criteria_b criteria_c

mat criteria=J(20,2,.)

//overall n interviews
sum core_year
sca sample=r(N)
mat criteria[1,1]=r(N)

local j=2
foreach v in `smi_vars' {
tab `v',matcell(x_`j')
mat criteria[`j',1]=x_`j'[2,1]
mat criteria[`j',2]=x_`j'[2,1]/sample*100
local j = `j'+1
}


mat list criteria

frmttable using `logpath'\sic_Table2_criteria, statmat(criteria) ///
title("Serious illness cohort, criteria") ///
ctitle("","N Interviews","% interviews") ///
rtitle("Overall n interviews" \"Dementia"\ "Cancer" \"ESRD" \"CHF" \"COPD" \"Diabetes" \ ///
"Liver disease"\ "HIV" \ "ALS"\ "Hip fracture"\ "Any serious medical illness"\ "3 or more SMI's"\ ///
"ADL Impairment"\ "Med Ill and ADL Impairment" \"Med Ill and/or ADL Impairment"\ ///
"Med Ill and/or ADL Imp + SNF"\ ///
"Med Ill and/or ADL Imp + Hosp"\ "Med Ill and/or ADL Imp + SNF or Hosp"\ ///
"Med Ill and ADL Imp + SNF or Hosp") ///
sdec(0,2) replace


**********************************************************************************
//look at additional criteria
tab adl_impair_core, missing
tab ind_em_ur_adm_12m, missing
tab smi_nh_ind, missing

//look at combinations
tab ser_med_illness adl_impair_core, missing matcell(smi_adl)

frmttable using `logpath'\sic_Table2_criteria, statmat(smi_adl) ///
title("Serious illness cohort, serious medical condition vs ADL impairment") ///
ctitle("","ADL Impair, no" "ADL Impair, yes") ///
rtitle("Serious med ill, no" \ "Serious med ill, yes") ///
sdec(0) addtable

tab ser_med_illness ind_em_ur_adm_12m, missing
tab ser_med_illness smi_nh_ind, missing
tab adl_impair_core smi_nh_ind, missing  matcell(nh_adl)

frmttable using `logpath'\sic_Table2_criteria, statmat(nh_adl) ///
title("Serious illness cohort, nursing home use vs ADL impairment") ///
ctitle("","ADL Impair, no" "ADL Impair, yes") ///
rtitle("Nursing home use, no" \ "Nursing home use, yes") ///
sdec(0) addtable

**********************************************************************************
//look at SNF use vs adl use and hospitalization
//looking at self report nh use vs snf use from claims
//3 categories, (1) self report in nursing home at interview
//(2) nursing home use per claims
//(3) both SR in NH and SNF claims
mat nh_adl2=J(13,4,.)

//first row - overall n's
tab smi_nh_ind, matcell(crit)
mat nh_adl2[1,1]=crit[2,1]
tab nhres if ind_snf_use_12m==0, matcell(sr) //self report only, no claims
mat nh_adl2[1,2]=sr[2,1]
tab ind_snf_use_12m if nhres==0, matcell(cl) //claims only, no sr
mat nh_adl2[1,3]=cl[2,1]
tab nhres if ind_snf_use_12m==1, matcell(srcl) //self report and claims
mat nh_adl2[1,4]=srcl[2,1]

local r=2
foreach v of varlist adl_impair_core ind_em_ur_adm_12m ind_hosp_adm_12m{

tab `v' if smi_nh_ind==1, matcell(crit2)
mat nh_adl2[`r',1]=crit2[2,1]
mat nh_adl2[`r'+1,1]=(nh_adl2[`r',1])/(nh_adl2[1,1])*100
mat nh_adl2[`r'+2,1]=crit2[1,1]
mat nh_adl2[`r'+3,1]=(nh_adl2[`r'+2,1])/(nh_adl2[1,1])*100


tab `v' if nhres==1 & ind_snf_use_12m==0, matcell(sr2)
mat nh_adl2[`r',2]=sr2[2,1]
mat nh_adl2[`r'+1,2]=(nh_adl2[`r',2])/(nh_adl2[1,2])*100
mat nh_adl2[`r'+2,2]=sr2[1,1]
mat nh_adl2[`r'+3,2]=(nh_adl2[`r'+2,2])/(nh_adl2[1,2])*100


tab `v' if ind_snf_use_12m==1 & nhres==0, matcell(cl2)
mat nh_adl2[`r',3]=cl2[2,1]
mat nh_adl2[`r'+1,3]=(nh_adl2[`r',3])/(nh_adl2[1,3])*100
mat nh_adl2[`r'+2,3]=cl2[1,1]
mat nh_adl2[`r'+3,3]=(nh_adl2[`r'+2,3])/(nh_adl2[1,3])*100


tab `v' if ind_snf_use_12m==1 & nhres==1, matcell(srcl2)
mat nh_adl2[`r',4]=srcl2[2,1]
mat nh_adl2[`r'+1,4]=(nh_adl2[`r',4])/(nh_adl2[1,4])*100
mat nh_adl2[`r'+2,4]=srcl2[1,1]
mat nh_adl2[`r'+3,4]=(nh_adl2[`r'+2,4])/(nh_adl2[1,4])*100

local r = `r'+4
}


frmttable using `logpath'\sic_Table2_criteria, statmat(nh_adl2) ///
title("Serious illness cohort, nursing home criteria vs ADL impairment") ///
ctitle("","SR and/or Claims" "Self report NH use only" "SNF Claims only" "SR and Claims") ///
rtitle("N" \ "ADL Impairment, n" \ "Percent" \ "ADL Independent, n" \ "Percent" \ ///
"Urgent or Emergency Hospital Admit, n" \ "Percent" \ "No, n" \ "Percent" \ ///
"Any Hospital Admit, n" \ "Percent" \ "No, n" \ "Percent" ) ///
sdec(0 \ 0 \ 2 \ 0 \ 2 \ 0 \ 2 \ 0 \ 2 \ 0 \ 2 \ 0 \ 2) addtable

tab criteria_b, missing
**********************************************************************************

//look at interview years, number per R
mat years=J(6,2,.)

tab core_year, missing matcell(yr)

forvalues r=1/5{
mat years[`r',1]=yr[`r',1]
mat years[`r',2]=yr[`r',1]/r(N)*100
}

sum core_year
mat years[6,1]=r(N)
mat years[6,2]=r(N)/r(N)*100
mat list years

mat rownames years="2002" "2004" "2006" "2008" "2010" "Total"

frmttable using `logpath'\sic_Table2_criteria, statmat(years) ///
title("Interview years") ///
ctitle("","n Interviews" "Percent") ///
sdec(0 , 2 ) addtable

sort id core_year

by id: gen n1=_n
by id: gen n2=_N

preserve
keep if n1==n2
tab n1, missing matcell(cnt)

mat count=J(6,2,.)

forvalues r=1/5{
mat count[`r',1]=cnt[`r',1]
mat count[`r',2]=cnt[`r',1]/r(N)*100
}

sum core_year
mat count[6,1]=r(N)
mat count[6,2]=r(N)/r(N)*100
mat list count

mat rownames count="1" "2" "3" "4" "5" "Total"

frmttable using `logpath'\sic_Table2_criteria, statmat(count) ///
title("Interviews per Respondent") ///
ctitle("Number of interviews","n R's" "Percent") ///
sdec(0 , 2 ) addtable

restore

**********************************************************************************

//collapse dataset to look at unique R's that meet each of the criteria
collapse core_year `smi_vars' smi_nh_ind ,by(id)

mat criteria_r=J(20,2,.)

sum core_year
sca sample_r=r(N)
mat criteria_r[1,1]=r(N)

local j=2
foreach v in `smi_vars' {
replace `v'=1 if `v'>0 & `v'!=.
tab `v',matcell(x1_`j')
mat criteria_r[`j',1]=x1_`j'[2,1]
mat criteria_r[`j',2]=x1_`j'[2,1]/sample_r*100
local j = `j'+1
}

mat list criteria_r

frmttable using `logpath'\sic_Table2_criteria, statmat(criteria_r) ///
title("Serious illness cohort, criteria, respondent level") ///
ctitle("","N Respondents","% respondents") ///
rtitle("Overall n R's" \"Dementia"\ "Cancer" \"ESRD" \"CHF" \"COPD" \"Diabetes" \ ///
"Liver disease"\ "HIV"\ "ALS"\ "Hip fracture"\ "Any serious medical illness"\ "3 or more SMI's"\ ///
"ADL Impairment"\ "Med Ill and ADL Impairment" \"Med Ill and/or ADL Impairment"\ ///
"Med Ill and/or ADL Imp + SNF"\ ///
"Med Ill and/or ADL Imp + Hosp"\ "Med Ill and/or ADL Imp + SNF or Hosp"\ ///
"Med Ill and ADL Imp + SNF or Hosp") ///
sdec(0,2) addtable

log close


H="Step 8aa - Determine ffs medicare 1 year after interview"
/*This section checks for ffs medicare the 1 year after each
core interview or until death if that is within 1 year. 
This will be a check when looking at the 1 year
outcomes to make sure we have full claims datasets 
in the 1 year post-interview
*/

/*get list of beneficiaries that meet the sample criteria 1yr pre interview*/
proc sql;
create table meet_pre(keep=id bid_hrs c_ivw_year c_ivw_month 
	c_ivw_date core_year death_date core_to_death) as 
select * from sic_int.core_ids_1yr_criteria_5
where age_ge_65=1 and xwalk_yes=1 and part_ab_12m=1 and hmo_d_12m=0 
and core_year in (2000,2002,2004,2006,2008,2010,2012);
quit;

/*get months from core until death date where relevant*/
data meet_pre2;
set meet_pre;
*core_to_death is years so convert to months;
if death_date~=. then do;
	death_mo = month(death_date);
	death_yr = year(death_date);
	if death_yr=c_ivw_year then core_to_death_mos=death_mo-c_ivw_month+1;
	if death_yr=1+c_ivw_year then core_to_death_mos=death_mo+(13-c_ivw_month);
end; 
*if core_to_death<=(1 + 1/12) & core_to_death~=. then core_to_death_mos = floor((death_date-c_ivw_date) / 30.5);
*if core_to_death_mos<0 & core_to_death_mos~=. then core_to_death_mos=0;
run;

proc freq; table core_to_death_mos; run;

proc sort data=medi.dn_2000_2012 out=dn_2000_20122  nodupkey;
by BID_HRS_21 year;
run;

/*get medicare and hmo status variables from the dn file
for the year of the core interview*/
proc sql;
create table dn_core_y as select
a.*,b.buyin12,b.year,b.HMOIND12
from meet_pre2 a inner join
dn_2000_20122 b
on trim(left(a.BID_hrs))=trim(left(b.BID_hrs_21))
and a.c_ivw_year=b.year;
quit;

proc freq data=dn_core_y ;
table c_ivw_year c_ivw_month ;
run;

/*11982 r's have at least 1 interview with a denominator file linked*/
proc sql;
select count(distinct BID_hrs) from dn_core_y ;
quit;

/*trim variables to show status month of interview and later
these are all interviews with full info 12m before, so don't 
have to check for missing months in the variable*/
data dn_core_y2;
set dn_core_y;
if length(trim(left(buyin12)))=12 and c_ivw_month>0 then do;
buyin_dy=substr(trim(left(buyin12)),c_ivw_month,(13-c_ivw_month));
hmo_dy=substr(trim(left(HMOIND12)),c_ivw_month,(13-c_ivw_month));
end;
else do;
buyin_dy=trim(left(buyin12));
hmo_dy=trim(left(HMOIND12));
end;
format c_ivw_date date9.;
run;
proc means n;
var  c_ivw_month;
run;

/*Get info for year after interview to fill in remainder of the 12m period*/
/*n=34320 have +1 year dn file*/
proc sql;
create table dn_core_y_aft as select
a.BID_hrs,a.c_ivw_year ,
b.year as c_ivw_year_aft,
b.year,b.buyin12,b.HMOIND12
from dn_core_y a inner join
dn_2000_20122 b
on trim(left(a.BID_hrs))=trim(left(b.BID_hrs_21))
and -1<=a.c_ivw_year-b.year<0 order by bid_hrs,c_ivw_year;
quit;

proc sql;
create table all_insurance as select a.*,b.year as year_aft_civw, 
b.buyin12 as buyin_aft,b.HMOIND12 as hmo_aft from
dn_core_y2 a
left join
dn_core_y_aft b
on trim(left(a.BID_hrs))=trim(left(b.BID_hrs)) 
and a.c_ivw_year=b.c_ivw_year;
quit;

proc freq data=all_insurance;
table c_ivw_year*year_aft_civw /missprint;
run;

/*trim year after if its the death year*/
data data all_insurance1;
set all_insurance;
if year_aft_civw=death_yr & year_aft_civw~=. then do;
	buyin_aft=substr(trim(left(buyin_aft)),1,death_mo);
	hmo_aft=substr(trim(left(hmo_aft)),1,death_mo);
end;
run;

/*merge interview year and year after interview buy-in and hmo variables
Trim so the final variable _12m is 12 months post-interview
Note: indicator variables for parts a and b and hmo are null if don't
have information for full 12 months post-interview*/
data all_insurance2;
set all_insurance1;
buyin_2y=trim(left(buyin_dy))||trim(left(buyin_aft));
hmo_2y=trim(left(hmo_dy))||trim(left(hmo_aft));

*************************************************;
** 12 month variables                          **;
*************************************************;
if length(buyin_2y)>12 then buyin_12m=substr(trim(left(buyin_2y)),1,13);
if length(hmo_2y)>12 then hmo_12m=substr(trim(left(hmo_2y)),1,13);

if length(buyin_2y)<13 & core_to_death_mos>=13 & core_to_death_mos~=. then buyin_12m="";
if length(hmo_2y)<13 & core_to_death_mos>=13 & core_to_death_mos~=. then hmo_12m="";

if length(buyin_2y)<13 & 0<core_to_death_mos<13 & core_to_death_mos~=. & length(buyin_2y)>=core_to_death_mos  then 
	buyin_12m=substr(trim(left(buyin_2y)),1,core_to_death_mos);
if length(hmo_2y)<13 & 0<core_to_death_mos<13 & core_to_death_mos~=. & length(hmo_2y)>=core_to_death_mos then 
	hmo_12m=substr(trim(left(hmo_2y)),1,core_to_death_mos);

/*create indicator variable for mc coverage 12 mo. 0=no, 1=yes*/
	/*for obs that dont die within the year*/
if length(buyin_12m)=13 then do;
	if indexc(buyin_12m,"0","1","2","A","B") then part_ab_12m_aft=0;
	if indexc(buyin_12m,"0","1","2","A","B")=0 then part_ab_12m_aft=1;
end;
	/*for obs that do die within the year*/
else if 0<length(buyin_12m)<=13 & length(buyin_12m)=core_to_death_mos & core_to_death_mos~=. then do;
	if indexc(buyin_12m,"0","1","2","A","B") then part_ab_12m_aft=0;
	if indexc(buyin_12m,"0","1","2","A","B")=0 then part_ab_12m_aft=1;
end;


if length(hmo_12m)=13 then do;
	if indexc(hmo_12m,"1","2","A","B","C") then hmo_d_12m_aft=1;
	if indexc(hmo_12m,"1","2","A","B","C")=0 then hmo_d_12m_aft=0;
end;

else if 0<length(hmo_12m)<=13 & length(hmo_12m)=core_to_death_mos & core_to_death_mos~=. then do;
	if indexc(hmo_12m,"1","2","A","B","C") then hmo_d_12m_aft=1;
	if indexc(hmo_12m,"1","2","A","B","C")=0 then hmo_d_12m_aft=0;
end;

run;

proc freq data=all_insurance2;
table part_ab_12m_aft hmo_d_12m_aft ; 
run;

/*part ab, hmo status, all don't have denominator files the year after the interview*/
data miss_12maft;
set all_insurance2;
if hmo_d_12m_aft=.;
run;

proc freq; table c_ivw_year year_aft_civw /missprint; run;

/*bring indicators into the main dataset*/
proc sql;
create table sic_int.core_ids_1yr_criteria_6 as select a.*,b.part_ab_12m_aft,b.hmo_d_12m_aft
 from
sic_int.core_ids_1yr_criteria_5 a left join
all_insurance2 b
on a.bid_hrs=b.bid_hrs and a.c_ivw_year=b.c_ivw_year;
quit;

proc freq data=sic_int.core_ids_1yr_criteria_6 ;
table part_ab_12m_aft*part_ab_12m hmo_d_12m_aft*hmo_d_12m /missprint;
run;

/*check of ffs medicare 1 year after interview*/
data check_aft;
set sic_int.core_ids_1yr_criteria_6;
if age_ge_65=1 & xwalk_yes=1 & part_ab_12m=1 and hmo_d_12m=0 
& core_year in (2000,2002,2004,2006,2008,2010,2012);
run;

/*of n=40481 that meet sample selection criteria year preceding ivw 
n= 33812 (83.5%) also meet it 1 year after the interview

Many of these are bc they are 2012 interviews that don't have the 2013 denominator
file to follow up with, they also won't have a full set of claims 1 year
after the interview*/

proc freq; table part_ab_12m_aft*hmo_d_12m_aft /missprint; run;


H="xxxx(not correct)Step 8aa2 - Determine ffs medicare 2 years after interview"
/*This section checks for ffs medicare the 2 years after each
core interview or until death if that is within 2 years. 
This will be a check when looking at the 2 year
outcomes to make sure we have full claims datasets 
in the 2 years post-interview
*/

/*get list of beneficiaries that meet the sample criteria 1yr pre interview*/
proc sql;
create table meet_pre(keep=id bid_hrs c_ivw_year c_ivw_month 
	c_ivw_date core_year death_date core_to_death) as 
select * from sic_int.core_ids_1yr_criteria_5
where age_ge_65=1 and xwalk_yes=1 and part_ab_12m=1 and hmo_d_12m=0 
and core_year in (2000,2002,2004,2006,2008,2010,2012);
quit;

/*get months from core until death date where relevant*/
data meet_pre2;
set meet_pre;
*core_to_death is years so convert to months;
if death_date~=. then do;
	death_mo = month(death_date);
	death_yr = year(death_date);
	if death_yr=c_ivw_year then core_to_death_mos=death_mo-c_ivw_month+1;
	if death_yr=1+c_ivw_year then core_to_death_mos=death_mo+(13-c_ivw_month);
	if death_yr=2+c_ivw_year then core_to_death_mos=death_mo+(25-c_ivw_month);
end; 
*if core_to_death<=(1 + 1/12) & core_to_death~=. then core_to_death_mos = floor((death_date-c_ivw_date) / 30.5);
*if core_to_death_mos<0 & core_to_death_mos~=. then core_to_death_mos=0;
run;

proc freq; table core_to_death_mos; run;

proc sort data=medi.dn_2000_2012 out=dn_2000_20122  nodupkey;
by BID_HRS_21 year;
run;

/*get medicare and hmo status variables from the dn file
for the year of the core interview*/
proc sql;
create table dn_core_y as select
a.*,b.buyin12,b.year,b.HMOIND12
from meet_pre2 a inner join
dn_2000_20122 b
on trim(left(a.BID_hrs))=trim(left(b.BID_hrs_21))
and a.c_ivw_year=b.year;
quit;

proc freq data=dn_core_y ;
table c_ivw_year c_ivw_month ;
run;

/*11982 r's have at least 1 interview with a denominator file linked*/
proc sql;
select count(distinct BID_hrs) from dn_core_y ;
quit;

/*trim variables to show status month of interview and later
these are all interviews with full info 12m before, so don't 
have to check for missing months in the variable*/
data dn_core_y2;
set dn_core_y;
if length(trim(left(buyin12)))=12 and c_ivw_month>0 then do;
buyin_dy=substr(trim(left(buyin12)),c_ivw_month,(13-c_ivw_month));
hmo_dy=substr(trim(left(HMOIND12)),c_ivw_month,(13-c_ivw_month));
end;
else do;
buyin_dy=trim(left(buyin12));
hmo_dy=trim(left(HMOIND12));
end;
format c_ivw_date date9.;
run;
proc means n;
var  c_ivw_month;
run;
/*Get info for year after interview to fill in remainder of the 12m period*/
/*n=34320 have +1 year dn file*/
proc sql;
create table dn_core_y_aft as select
a.BID_hrs,a.c_ivw_year ,
b.year as c_ivw_year_aft,
b.year,b.buyin12,b.HMOIND12
from dn_core_y a inner join
dn_2000_20122 b
on trim(left(a.BID_hrs))=trim(left(b.BID_hrs_21))
and -1<=a.c_ivw_year-b.year<0 order by bid_hrs,c_ivw_year;
quit;


/*Get info for years after interview to fill in remainder of the 24m period*/
/*n=31055 have +2 year dn file*/
proc sql;
create table dn_core_2y_aft as select
a.BID_hrs,a.c_ivw_year ,
b.year as c_ivw_year_2aft,
b.year,b.buyin12,b.HMOIND12
from dn_core_y a inner join
dn_2000_20122 b
on trim(left(a.BID_hrs))=trim(left(b.BID_hrs_21))
and -2<=a.c_ivw_year-b.year<-1 order by bid_hrs,c_ivw_year;
quit;

proc sql;
create table all_insurance as select a.*,b.year as year_aft_civw, 
b.buyin12 as buyin_aft,b.HMOIND12 as hmo_aft from
dn_core_y2 a
left join
dn_core_y_aft b
on trim(left(a.BID_hrs))=trim(left(b.BID_hrs)) 
and a.c_ivw_year=b.c_ivw_year;
quit;

proc sql;
create table all_insurance1 as select a.*,b.year as year_2aft_civw, 
b.buyin12 as buyin_2aft,b.HMOIND12 as hmo_2aft from
all_insurance a
left join
dn_core_2y_aft b
on trim(left(a.BID_hrs))=trim(left(b.BID_hrs)) 
and a.c_ivw_year=b.c_ivw_year;
quit;

proc freq data=all_insurance1;
table c_ivw_year*year_2aft_civw /missprint;
run;

proc freq data=all_insurance;
table c_ivw_year*year_aft_civw /missprint;
run;

/*trim 2years after if its the death year---I don't understand this right now*/
data data all_insurance2;
set all_insurance1;
if year_aft_civw=death_yr & year_aft_civw~=. then do;
	buyin_aft=substr(trim(left(buyin_aft)),1,death_mo);
	hmo_aft=substr(trim(left(hmo_aft)),1,death_mo);
end;
if year_2aft_civw=death_yr & year_2aft_civw~=. then do;
	buyin_2aft=substr(trim(left(buyin_2aft)),1,death_mo);
	hmo_2aft=substr(trim(left(hmo_2aft)),1,death_mo);
end;
run;

/*merge interview year and year after interview buy-in and hmo variables
Trim so the final variable _24m is 24 months post-interview
Note: indicator variables for parts a and b and hmo are null if don't
have information for full 24 months post-interview*/
data all_insurance3;
set all_insurance2;
buyin_2y=trim(left(buyin_dy))||trim(left(buyin_aft))||trim(left(buyin_2aft));
hmo_2y=trim(left(hmo_dy))||trim(left(hmo_aft))||trim(left(hmo_2aft));

*************************************************;
** 12 month variables                          **;
*************************************************;
if length(buyin_2y)>24 then buyin_24m=substr(trim(left(buyin_2y)),1,25);
if length(hmo_2y)>24 then hmo_24m=substr(trim(left(hmo_2y)),1,25);

if length(buyin_2y)>12 then buyin_12m=substr(trim(left(buyin_2y)),1,13);
if length(hmo_2y)>12 then hmo_12m=substr(trim(left(hmo_2y)),1,13);

if length(buyin_2y)<25 & core_to_death_mos>=25 & core_to_death_mos~=. then buyin_24m="";
if length(hmo_2y)<25 & core_to_death_mos>=25 & core_to_death_mos~=. then hmo_24m="";

if length(buyin_2y)<13 & core_to_death_mos>=13 & core_to_death_mos~=. then buyin_12m="";
if length(hmo_2y)<13 & core_to_death_mos>=13 & core_to_death_mos~=. then hmo_12m="";

if length(buyin_2y)<25 & 0<core_to_death_mos<25 & core_to_death_mos~=. & length(buyin_2y)>=core_to_death_mos  then 
	buyin_24m=substr(trim(left(buyin_2y)),1,core_to_death_mos);
if length(hmo_2y)<25 & 0<core_to_death_mos<25 & core_to_death_mos~=. & length(hmo_2y)>=core_to_death_mos then 
	hmo_24m=substr(trim(left(hmo_2y)),1,core_to_death_mos);

if length(buyin_2y)<13 & 0<core_to_death_mos<13 & core_to_death_mos~=. & length(buyin_2y)>=core_to_death_mos  then 
	buyin_12m=substr(trim(left(buyin_2y)),1,core_to_death_mos);
if length(hmo_2y)<13 & 0<core_to_death_mos<13 & core_to_death_mos~=. & length(hmo_2y)>=core_to_death_mos then 
	hmo_12m=substr(trim(left(hmo_2y)),1,core_to_death_mos);

/*create indicator variable for mc coverage 12 mo. 0=no, 1=yes*/
	/*for obs that dont die within 2 years*/
if length(buyin_24m)=25 then do;
	if indexc(buyin_24m,"0","1","2","A","B") then part_ab_24m_aft=0;
	if indexc(buyin_24m,"0","1","2","A","B")=0 then part_ab_24m_aft=1;
end;
	/*for obs that do die within 2 years*/
else if 0<length(buyin_24m)<=25 & length(buyin_24m)=core_to_death_mos & core_to_death_mos~=. then do;
	if indexc(buyin_24m,"0","1","2","A","B") then part_ab_24m_aft=0;
	if indexc(buyin_24m,"0","1","2","A","B")=0 then part_ab_24m_aft=1;
end;


if length(hmo_24m)=25 then do;
	if indexc(hmo_24m,"1","2","A","B","C") then hmo_d_24m_aft=1;
	if indexc(hmo_24m,"1","2","A","B","C")=0 then hmo_d_24m_aft=0;
end;

else if 0<length(hmo_24m)<=25 & length(hmo_24m)=core_to_death_mos & core_to_death_mos~=. then do;
	if indexc(hmo_24m,"1","2","A","B","C") then hmo_d_24m_aft=1;
	if indexc(hmo_24m,"1","2","A","B","C")=0 then hmo_d_24m_aft=0;
end;

if length(buyin_12m)=13 then do;
	if indexc(buyin_12m,"0","1","2","A","B") then part_ab_12m_aft=0;
	if indexc(buyin_12m,"0","1","2","A","B")=0 then part_ab_12m_aft=1;
end;
	/*for obs that do die within the year*/
else if 0<length(buyin_12m)<=13 & length(buyin_12m)=core_to_death_mos & core_to_death_mos~=. then do;
	if indexc(buyin_12m,"0","1","2","A","B") then part_ab_12m_aft=0;
	if indexc(buyin_12m,"0","1","2","A","B")=0 then part_ab_12m_aft=1;
end;


if length(hmo_12m)=13 then do;
	if indexc(hmo_12m,"1","2","A","B","C") then hmo_d_12m_aft=1;
	if indexc(hmo_12m,"1","2","A","B","C")=0 then hmo_d_12m_aft=0;
end;

else if 0<length(hmo_12m)<=13 & length(hmo_12m)=core_to_death_mos & core_to_death_mos~=. then do;
	if indexc(hmo_12m,"1","2","A","B","C") then hmo_d_12m_aft=1;
	if indexc(hmo_12m,"1","2","A","B","C")=0 then hmo_d_12m_aft=0;
end;

run;

proc freq data=all_insurance3;
table part_ab_12m_aft hmo_d_12m_aft part_ab_24m_aft hmo_d_24m_aft; 
run;

/*part ab, hmo status, all don't have denominator files the year after the interview*/
data miss_12maft;
set all_insurance3;
if hmo_d_12m_aft=.;
run;

data miss_24maft;
set all_insurance3;
if hmo_d_24m_aft=.;
run;

proc freq; table c_ivw_year year_aft_civw /missprint; run;

/*bring indicators into the main dataset*/
proc sql;
create table sic_int.core_ids_1yr_criteria_6 as select a.*,b.part_ab_12m_aft,b.hmo_d_12m_aft,
b.part_ab_24m_aft,b.hmo_d_24m_aft
 from
sic_int.core_ids_1yr_criteria_5 a left join
all_insurance3 b
on a.bid_hrs=b.bid_hrs and a.c_ivw_year=b.c_ivw_year;
quit;

proc freq data=sic_int.core_ids_1yr_criteria_6 ;
table part_ab_12m_aft*part_ab_12m hmo_d_12m_aft*hmo_d_12m 
part_ab_24m_aft*part_ab_12m hmo_d_24m_aft*hmo_d_12m /missprint;
run;

/*check of ffs medicare 1 year after interview*/
data check_aft;
set sic_int.core_ids_1yr_criteria_6;
if age_ge_65=1 & xwalk_yes=1 & part_ab_12m=1 & hmo_d_12m=0
& core_year in (2000,2002,2004,2006,2008,2010,2012);
run;

/*of n=40481 that meet sample selection criteria year preceding ivw 
n= 33812 (83.5%) also meet it 1 year after the interview**note, oddly I (Evan) have it as 33023***
n=30543 that meet 2 years after
Many of these are bc they are 2012 interviews that don't have the 2013 denominator
file to follow up with, they also won't have a full set of claims 1 year
after the interview*/

proc freq; table part_ab_12m_aft*hmo_d_12m_aft part_ab_24m_aft*hmo_d_24m_aft/missprint; run;


H="Step 8a - Determine outcomes after meet criteria"
/*While still determining criteria, create variables looking at the 1 year
after and 6 months after interview for all interviews (regardless of when meet criteria)

Outcomes are:
1. Urgent or emergency hospital admissions 1 year after meet critera
2. Hospice enrollment 1 year after meet criteria
3. Total Medicare payments 1 year after meet criteria

Note: Final dataset is set of interviews that meet ffs mc 1 year and age 65+
with outcomes added
*/

/*6/1/16-added icu days

/*ids of those interviews with ffs medicare year preceding interview and 65+*/
proc sql;
create table age_ge_65_mc as 
select * from sic_int.core_ids_1yr_criteria_6 
where age_ge_65=1 and xwalk_yes=1 and part_ab_12m=1 and hmo_d_12m=0 
and core_year in (2000,2002,2004,2006,2008,2010,2012);
quit;

proc freq; table core_to_dod_1yr  core_to_dod_6m; run;

data age_ge_65_mc_ltd;
set age_ge_65_mc(keep=bid_hrs c_ivw_date core_year);
run;

/**********************************************************************/
/**********************************************************************/
*get claims 1 year after interview, all claim types;
/**********************************************************************/
/**********************************************************************/
/*medpar claims
List of claims with some time within 1 year of interview*/
%macro mp(days_start=,days_after_core=,source=,time_label=);

proc sql;
create table &source._meet_post as select a.*,b.c_ivw_date,b.core_year
from medi.&source._2000_2012 a inner join
age_ge_65_mc_ltd b
on trim(left(a.bid_hrs_21))=trim(left(b.bid_hrs))
and &days_start<=a.disch_date-b.c_ivw_date<=&days_after_core;
quit;

proc sql;
create table &source._meet2_post as select a.*,b.c_ivw_date,b.core_year
from medi.&source._2000_2012 a inner join
age_ge_65_mc_ltd b
on trim(left(a.bid_hrs_21))=trim(left(b.bid_hrs))
and a.disch_date-b.c_ivw_date>&days_after_core and a.admit_date-b.c_ivw_date<=&days_after_core;
quit;

data sic_int.&source._meet3_post_&days_after_core.;
set &source._meet_post &source._meet2_post;
format admit_date date9. disch_date date9.;
run;

%mend;

/*otherclaims, Just keep payment info to limit size of dataset
Pull list of any claims with admission date within 1 year of the interview*/
%macro other(days_start=,days_after_core=,source= );

proc sql;
create table sic_int.&source._meet_post_&days_after_core. as select 
a.*,b.c_ivw_date,b.core_year
from medi.&source._2000_2012(keep=admit_date BID_hrs_21 pmt_amt) a inner join
age_ge_65_mc_ltd b
on trim(left(a.bid_hrs_21))=trim(left(b.bid_hrs))
and &days_start<=a.admit_date-b.c_ivw_date<=&days_after_core;
quit;

%mend;

/*1 year claims lists*/
%mp(days_start=0,days_after_core=365,source=mp );
%other(days_start=0,days_after_core=365,source=op );
%other(days_start=0,days_after_core=365,source=pb );
%other(days_start=0,days_after_core=365,source=hh );
%other(days_start=0,days_after_core=365,source=hs );
%other(days_start=0,days_after_core=365,source=dm );

/*6 months claims lists*/
%mp(days_start=0,days_after_core=183,source=mp );
%other(days_start=0,days_after_core=183,source=op );
%other(days_start=0,days_after_core=183,source=pb );
%other(days_start=0,days_after_core=183,source=hh );
%other(days_start=0,days_after_core=183,source=hs );
%other(days_start=0,days_after_core=183,source=dm );

/**********************************************************************/
/**********************************************************************/
/*Count of hospital admissions 1 year after interview
Use suffix p12m to indicate post interview*/
/**********************************************************************/
/**********************************************************************/
%macro admissions(days=,suffix=);
/*pull list of ip claims from all medpar claims x days after interview*/
data ip_meet_post_&days.;
set sic_int.mp_meet3_post_&days.(where=(trim(left(SSLSSNF))~="N"));
*if admit_date>=c_ivw_date;
run;

data ip_post_&days._2;
set ip_meet_post_&days.;
if icarecnt=. then icarecnt=0; /*medpar intensive care day count*/
if CRNRYDAY=. then CRNRYDAY=0; /*medpar coronary day count*/
icu_days=icarecnt+CRNRYDAY;
if icu_days>0 then icu=1;
em_urgent_admit=0; /*Urgent , emergent admissions from admission type*/
if type_adm in (1,2) then em_urgent_admit=1;
em_admit=0;
if type_adm=1 then em_admit=1;
urgent_admit=0;
if type_adm=2 then urgent_admit=1;
elect_admit=0;
if type_adm=3 then elect_admit=1;
ind_ed_charge=0; /*ED charges as another indicator of ED use*/
if ER_AMT>0 & ER_AMT~=. then ind_ed_charge=1;
if ER_AMT=0 | ER_AMT=. then ind_ed_charge=0;

*truncate admit and discharge dates to get all days within the window;
admit_trunc=0;
disch_trunc=0;
if admit_date<c_ivw_date then do;
	admit_date=c_ivw_date;
	admit_trunc=1;
end;
if disch_date-c_ivw_date>&days. then do;
	disch_date=c_ivw_date+&days.;
	disch_trunc=1;
end;
adj_los=disch_date-admit_date;
if disch_date-admit_date=0 then adj_los=1;
run;

proc sort data=ip_post_&days._2;
by BID_hrs_21 core_year;
run;

proc sql;
create table ip_post_&days._3 as select distinct BID_hrs_21,core_year,
/*count of IP admissions, all types*/
count(*) as n_ip_admit_&suffix. label="total n of hospital admit &suffix. after core ivw",
/*count of nights in hospital*/
sum(adj_los) as n_hospd_&suffix. label="total n of hospital nights &suffix. after core ivw",
/*count urgent or emergency admissions*/
count(case when em_urgent_admit=1 then em_urgent_admit else . end) as n_em_urgent_admit_&suffix. 
	label="total n of urgent/emergent hospital admit &suffix. after core ivw",
/*count of emergency admissions, from admission type code*/
count(case when em_admit=1 then em_admit else . end) as n_em_admit_&suffix. 
	label="total n of emergent hospital admit &suffix. after core ivw",
/*count of urgent admissions, from admission type code*/
count(case when urgent_admit=1 then urgent_admit else . end) as n_urgent_admit_&suffix. 
	label="total n of urgent hospital admit &suffix. after core ivw",
/*count of elective admissions, from admission type code*/
count(case when elect_admit=1 then elect_admit else . end) as n_elect_admit_&suffix. 
	label="total n of elective hospital admit &suffix. after core ivw",
/*count of admissions with any ED charges*/
count(case when ind_ed_charge=1 then ind_ed_charge else . end) as n_ED_ip_&suffix. 
	label="total n of ED visits with subsequent admit &suffix. after core ivw",
sum(admit_trunc) as adm_trunc_ind_&suffix.
	label="admit before interview indicator, counted as both pre and post admit",
/*count of admissions with any ICU days*/
count(case when icu=1 then icu else . end) as n_icu_admit_&suffix.
	label="total n of hospital admit with ICU &suffix. after core ivw",
sum(icu_days) as icu_days_&suffix.
	label="total ICU days &suffix. after core ivw"
 from ip_post_&days._2 group by BID_hrs_21,core_year;
quit;

data ip_post_&days._4;
set ip_post_&days._3;
if adm_trunc_ind_&suffix.>1 then adm_trunc_ind_&suffix.=1;
run;

%mend;

%admissions(days=365,suffix=p12m); /*1 year admisions details*/
%admissions(days=183,suffix=p6m); /*6 months admisions details*/

/*merge in new variables to full variable list*/
proc sql;
create table core_ids_admit_post_1 as select a.*,
b.n_ip_admit_p12m,b.adm_trunc_ind_p12m,b.n_hospd_p12m,
b.n_em_urgent_admit_p12m,b.n_em_admit_p12m,
b.n_urgent_admit_p12m,b.n_elect_admit_p12m,b.n_ED_ip_p12m,
b.n_icu_admit_p12m,b.icu_days_p12m
from age_ge_65_mc_ltd(drop=c_ivw_date) a
left join
ip_post_365_4 b 
on trim(left(a.bid_hrs))=trim(left(b.bid_hrs_21)) and a.core_year=b.core_year;
quit;

proc sql;
create table core_ids_admit_post_2 as select a.*,
b.n_ip_admit_p6m,b.adm_trunc_ind_p6m,b.n_hospd_p6m,
b.n_em_urgent_admit_p6m,b.n_em_admit_p6m,
b.n_urgent_admit_p6m,b.n_elect_admit_p6m,b.n_ED_ip_p6m,
b.icu_days_p6m,b.n_icu_admit_p6m
from core_ids_admit_post_1 a
left join
ip_post_183_4 b 
on trim(left(a.bid_hrs))=trim(left(b.bid_hrs_21)) and a.core_year=b.core_year;
quit;


/*Since dataset is just those with ffs mc 1 year preceeding the
core interview, replace admit info with 0 if missing b/c there were no ip claims*/
 data core_ids_admit_post_3;
 set core_ids_admit_post_2;
 array list 
	n_ip_admit_p12m n_hospd_p12m n_em_urgent_admit_p12m
	n_em_admit_p12m n_urgent_admit_p12m n_elect_admit_p12m n_ED_ip_p12m
	n_ip_admit_p6m n_hospd_p6m n_em_urgent_admit_p6m
	n_em_admit_p6m n_urgent_admit_p6m n_elect_admit_p6m n_ED_ip_p6m
	icu_days_p6m icu_days_p12m n_icu_admit_p6m n_icu_admit_p12m;
 do over list;
 if list=. then list=0;
 end;

 if n_ip_admit_p12m=0 then ind_hosp_adm_p12m=0;
 if n_ip_admit_p12m>0 & n_ip_admit_p12m~=. then ind_hosp_adm_p12m=1;
 label ind_hosp_adm_p12m="Indicator for any hospital admission 12m after core";

 if n_ip_admit_p6m=0 then ind_hosp_adm_p6m=0;
 if n_ip_admit_p6m>0 & n_ip_admit_p6m~=. then ind_hosp_adm_p6m=1;
 label ind_hosp_adm_p6m="Indicator for any hospital admission 6m after core";

 if n_em_urgent_admit_p12m=0 then ind_em_ur_adm_p12m=0;
 if n_em_urgent_admit_p12m>0 & n_em_urgent_admit_p12m~=. then ind_em_ur_adm_p12m=1;
 label ind_em_ur_adm_p12m="Ind any urgent or emergent hospital admission 12m after core";

 if n_em_urgent_admit_p6m=0 then ind_em_ur_adm_p6m=0;
 if n_em_urgent_admit_p6m>0 & n_em_urgent_admit_p6m~=. then ind_em_ur_adm_p6m=1;
 label ind_em_ur_adm_p6m="Ind any urgent or emergent hospital admission 6m after core";

 if n_em_admit_p12m=0 then ind_em_adm_p12m=0;
 if n_em_admit_p12m>0 & n_em_admit_p12m~=. then ind_em_adm_p12m=1;
 label ind_em_adm_p12m="Ind any emergency hospital admission 12m after core";

 if n_em_admit_p6m=0 then ind_em_adm_p6m=0;
 if n_em_admit_p6m>0 & n_em_admit_p6m~=. then ind_em_adm_p6m=1;
 label ind_em_adm_p6m="Ind any emergency hospital admission 6m after core";

 if n_urgent_admit_p12m=0 then ind_ur_adm_p12m=0;
 if n_urgent_admit_p12m>0 & n_urgent_admit_p12m~=. then ind_ur_adm_p12m=1;
 label ind_ur_adm_p12m="Ind any urgent hospital admission 12m after core";

 if n_urgent_admit_p6m=0 then ind_ur_adm_p6m=0;
 if n_urgent_admit_p6m>0 & n_urgent_admit_p6m~=. then ind_ur_adm_p6m=1;
 label ind_ur_adm_p6m="Ind any urgent hospital admission 6m after core";

 if n_elect_admit_p12m =0 then ind_elect_adm_p12m=0;
 if n_elect_admit_p12m >0 & n_elect_admit_p12m ~=. then ind_elect_adm_p12m=1;
 label ind_elect_adm_p12m="Ind any elective hospital admission 12m after core";

 if n_elect_admit_p6m =0 then ind_elect_adm_p6m=0;
 if n_elect_admit_p6m >0 & n_elect_admit_p6m ~=. then ind_elect_adm_p6m=1;
 label ind_elect_adm_p6m="Ind any elective hospital admission 6m after core";

 if (n_ip_admit_p12m - n_elect_admit_p12m)=0 then ind_nonelect_adm_p12m=0;
 if (n_ip_admit_p12m - n_elect_admit_p12m)>0 & n_elect_admit_p12m~=. then ind_nonelect_adm_p12m=1;
 label ind_nonelect_adm_p12m="Ind any non-elective hospital admission 12m after core";

 if (n_ip_admit_p6m - n_elect_admit_p6m)=0 then ind_nonelect_adm_p6m=0;
 if (n_ip_admit_p6m - n_elect_admit_p6m)>0 & n_elect_admit_p6m~=. then ind_nonelect_adm_p6m=1;
 label ind_nonelect_adm_p6m="Ind any non-elective hospital admission 6m after core";

 n_nonelect_adm_p12m=(n_ip_admit_p12m - n_elect_admit_p12m);
 label n_nonelect_adm_p12m="total n non-elective ip admit 12m after core";

 n_nonelect_adm_p6m=(n_ip_admit_p6m - n_elect_admit_p6m);
 label n_nonelect_adm_p6m="total n non-elective ip admit 6m after core";

 if n_ED_ip_p12m=0 then ind_ED_adm_p12m=0;
 if n_ED_ip_p12m>0 & n_ED_ip_p12m~=. then ind_ED_adm_p12m=1;
 label ind_ED_adm_p12m="Ind ED use with hospital admission 12m after core, from charges";

 if n_ED_ip_p6m=0 then ind_ED_adm_p6m=0;
 if n_ED_ip_p6m>0 & n_ED_ip_p6m~=. then ind_ED_adm_p6m=1;
 label ind_ED_adm_p6m="Ind ED use with hospital admission 6m after core, from charges";

run;

proc freq;
table n_ip_admit_p: adm_trunc_ind_p: n_hospd_p: ind_hosp_adm_p: n_em_urgent_admit_p: ind_em_ur_adm_p:
	ind_em_adm_p: ind_ur_adm_p: ind_nonelect_adm_p: n_nonelect_adm_p: n_ED_ip_p: ind_ED_adm_p: 
	ind_em_adm_p12m*ind_ED_adm_p12m ind_em_adm_p6m*ind_ED_adm_p6m /missprint;
run;

/**********************************************************************/
/**********************************************************************/
/*Indicator of any hospice enrollment after interview
Use suffix p12m to indicate post interview*/
/**********************************************************************/
/**********************************************************************/
/*check of hospice claim list*/
data hospice_check;
set sic_int.hs_meet_post_365;
ivw_to_admit=admit_date-c_ivw_date;
run;
proc means; var ivw_to_admit;run;

data hospice_check2;
set sic_int.hs_meet_post_183;
ivw_to_admit=admit_date-c_ivw_date;
run;
proc means; var ivw_to_admit;run;


%macro hospice(days=,suffix=);

proc sort data=sic_int.hs_meet_post_&days.;
by bid_hrs_21 c_ivw_date admit_date;
run;

/*just keep 1 claim per beneficiary-interview since only need indicator of hospice use*/
data hs_meet_post_2_&days.;
set sic_int.hs_meet_post_&days.;
by bid_hrs_21 c_ivw_date;
if first.c_ivw_date;
hs_admit_&suffix.=1;
label hs_admit_&suffix.="Hospice admission &suffix. after interview";
format admit_date date9.;
run;

%mend;

%hospice(days=365,suffix=p12m);
%hospice(days=183,suffix=p6m);

*merge hospice indicators with full dataset;
proc sql;
create table core_ids_admit_hs_post_2 as select a.*,b.hs_admit_p12m from
core_ids_admit_post_3 a left join
hs_meet_post_2_365 b
on trim(left(a.bid_hrs))=trim(left(b.bid_hrs_21)) and a.core_year=b.core_year;
quit;

proc sql;
create table core_ids_admit_hs_post_3 as select a.*,b.hs_admit_p6m from
core_ids_admit_hs_post_2 a left join
hs_meet_post_2_183 b
on trim(left(a.bid_hrs))=trim(left(b.bid_hrs_21)) and a.core_year=b.core_year;
quit;

proc freq; table hs_admit_p6m*hs_admit_p12m /missprint; run;

/*replace with 0 when have full info but no hospice claims
core interview*/
data core_ids_admit_hs_post_4 ;
set core_ids_admit_hs_post_3 ;
if hs_admit_p12m=. then hs_admit_p12m=0;
if hs_admit_p6m=. then hs_admit_p6m=0;
run;
proc freq; table hs_admit_p6m*hs_admit_p12m; run;

/*bring new outcomes variables into full interview dataset for those with ffs medicare */
proc sql;
create table sic_int.core_ids_init_outcomes(drop=bid_hrs2 core_year2)
as select * from
age_ge_65_mc a left join
core_ids_admit_hs_post_4(rename=(bid_hrs=bid_hrs2) rename=(core_year=core_year2)) b
on a.bid_hrs=b.bid_hrs2 and a.core_year=b.core_year2;
quit;

proc contents; run;

proc freq; table core_year; run;

proc freq; table hs_admit_p6m*hs_admit_p12m; run;

proc freq;
table n_ip_admit_p12m adm_trunc_ind_p12m n_hospd_p12m ind_hosp_adm_p12m n_em_urgent_admit_p12m ind_em_ur_adm_p12m
	ind_em_adm_p12m ind_ur_adm_p12m ind_nonelect_adm_p12m n_nonelect_adm_p12m n_ED_ip_p12m ind_ED_adm_p12m 
	ind_em_adm_p12m*ind_ED_adm_p12m /missprint;
run;



H="Step 8a1-Determine outcomes 2 years after invterview"
/*While still determining criteria, create variables looking at the 1 year, 2 years
after and 6 months after interview for all interviews (regardless of when meet criteria)

Outcomes are:
1. Urgent or emergency hospital admissions 1 year after meet critera
2. Hospice enrollment 1 year after meet criteria
3. Total Medicare payments 1 year after meet criteria

Note: Final dataset is set of interviews that meet ffs mc 1 year and age 65+
with outcomes added
*/

/*ids of those interviews with ffs medicare year preceding interview and 65+*/
proc sql;
create table age_ge_65_mc as 
select * from sic_int.core_ids_1yr_criteria_6 
where age_ge_65=1 and xwalk_yes=1 and part_ab_12m=1 and hmo_d_12m=0 
and core_year in (2000,2002,2004,2006,2008,2010,2012);
quit;

proc freq; table core_to_dod_1yr  core_to_dod_6m; run;

data age_ge_65_mc_ltd;
set age_ge_65_mc(keep=bid_hrs c_ivw_date core_year);
run;

/**********************************************************************/
/**********************************************************************/
*get claims 2 years after interview, all claim types;
/**********************************************************************/
/**********************************************************************/
/*medpar claims
List of claims with some time within 1 year of interview*/
%macro mp(days_start=,days_after_core=,source=,time_label=);

proc sql;
create table &source._meet_post as select a.*,b.c_ivw_date,b.core_year
from medi.&source._2000_2012 a inner join
age_ge_65_mc_ltd b
on trim(left(a.bid_hrs_21))=trim(left(b.bid_hrs))
and &days_start<=a.disch_date-b.c_ivw_date<=&days_after_core;
quit;

proc sql;
create table &source._meet2_post as select a.*,b.c_ivw_date,b.core_year
from medi.&source._2000_2012 a inner join
age_ge_65_mc_ltd b
on trim(left(a.bid_hrs_21))=trim(left(b.bid_hrs))
and a.disch_date-b.c_ivw_date>&days_after_core and a.admit_date-b.c_ivw_date<=&days_after_core;
quit;

data sic_int.&source._meet3_post_&days_after_core.;
set &source._meet_post &source._meet2_post;
format admit_date date9. disch_date date9.;
run;

%mend;

/*otherclaims, Just keep payment info to limit size of dataset
Pull list of any claims with admission date within 1 year of the interview*/
%macro other(days_start=,days_after_core=,source= );

proc sql;
create table sic_int.&source._meet_post_&days_after_core. as select 
a.*,b.c_ivw_date,b.core_year
from medi.&source._2000_2012(keep=admit_date BID_hrs_21 pmt_amt) a inner join
age_ge_65_mc_ltd b
on trim(left(a.bid_hrs_21))=trim(left(b.bid_hrs))
and &days_start<=a.admit_date-b.c_ivw_date<=&days_after_core;
quit;

%mend;

/*2 year claims lists*/
%mp(days_start=0,days_after_core=730,source=mp );
%other(days_start=0,days_after_core=730,source=op );
%other(days_start=0,days_after_core=730,source=pb );
%other(days_start=0,days_after_core=730,source=hh );
%other(days_start=0,days_after_core=730,source=hs );
%other(days_start=0,days_after_core=730,source=dm );


/*1 year claims lists*/
%mp(days_start=0,days_after_core=365,source=mp );
%other(days_start=0,days_after_core=365,source=op );
%other(days_start=0,days_after_core=365,source=pb );
%other(days_start=0,days_after_core=365,source=hh );
%other(days_start=0,days_after_core=365,source=hs );
%other(days_start=0,days_after_core=365,source=dm );

/*6 months claims lists*/
%mp(days_start=0,days_after_core=183,source=mp );
%other(days_start=0,days_after_core=183,source=op );
%other(days_start=0,days_after_core=183,source=pb );
%other(days_start=0,days_after_core=183,source=hh );
%other(days_start=0,days_after_core=183,source=hs );
%other(days_start=0,days_after_core=183,source=dm );

/**********************************************************************/
/**********************************************************************/
/*Count of hospital admissions 1 year after interview
Use suffix p24m to indicate post interview*/
/**********************************************************************/
/**********************************************************************/
%macro admissions(days=,suffix=);
/*pull list of ip claims from all medpar claims x days after interview*/
data ip_meet_post_&days.;
set sic_int.mp_meet3_post_&days.(where=(trim(left(SSLSSNF))~="N"));
*if admit_date>=c_ivw_date;
run;

data ip_post_&days._2;
set ip_meet_post_&days.;
em_urgent_admit=0; /*Urgent , emergent admissions from admission type*/
if type_adm in (1,2) then em_urgent_admit=1;
em_admit=0;
if type_adm=1 then em_admit=1;
urgent_admit=0;
if type_adm=2 then urgent_admit=1;
elect_admit=0;
if type_adm=3 then elect_admit=1;
ind_ed_charge=0; /*ED charges as another indicator of ED use*/
if ER_AMT>0 & ER_AMT~=. then ind_ed_charge=1;
if ER_AMT=0 | ER_AMT=. then ind_ed_charge=0;

*truncate admit and discharge dates to get all days within the window;
admit_trunc=0;
disch_trunc=0;
if admit_date<c_ivw_date then do;
	admit_date=c_ivw_date;
	admit_trunc=1;
end;
if disch_date-c_ivw_date>&days. then do;
	disch_date=c_ivw_date+&days.;
	disch_trunc=1;
end;
adj_los=disch_date-admit_date;
if disch_date-admit_date=0 then adj_los=1;
run;

proc sort data=ip_post_&days._2;
by BID_hrs_21 core_year;
run;

proc sql;
create table ip_post_&days._3 as select distinct BID_hrs_21,core_year,
/*count of IP admissions, all types*/
count(*) as n_ip_admit_&suffix. label="total n of hospital admit &suffix. after core ivw",
/*count of nights in hospital*/
sum(adj_los) as n_hospd_&suffix. label="total n of hospital nights &suffix. after core ivw",
/*count urgent or emergency admissions*/
count(case when em_urgent_admit=1 then em_urgent_admit else . end) as n_em_urgent_admit_&suffix. 
	label="total n of urgent/emergent hospital admit &suffix. after core ivw",
/*count of emergency admissions, from admission type code*/
count(case when em_admit=1 then em_admit else . end) as n_em_admit_&suffix. 
	label="total n of emergent hospital admit &suffix. after core ivw",
/*count of urgent admissions, from admission type code*/
count(case when urgent_admit=1 then urgent_admit else . end) as n_urgent_admit_&suffix. 
	label="total n of urgent hospital admit &suffix. after core ivw",
/*count of elective admissions, from admission type code*/
count(case when elect_admit=1 then elect_admit else . end) as n_elect_admit_&suffix. 
	label="total n of elective hospital admit &suffix. after core ivw",
/*count of admissions with any ED charges*/
count(case when ind_ed_charge=1 then ind_ed_charge else . end) as n_ED_ip_&suffix. 
	label="total n of ED visits with subsequent admit &suffix. after core ivw",
sum(admit_trunc) as adm_trunc_ind_&suffix.
	label="admit before interview indicator, counted as both pre and post admit"

 from ip_post_&days._2 group by BID_hrs_21,core_year;
quit;

data ip_post_&days._4;
set ip_post_&days._3;
if adm_trunc_ind_&suffix.>1 then adm_trunc_ind_&suffix.=1;
run;

%mend;

%admissions(days=730,suffix=p24m); /*1 year admisions details*/
%admissions(days=365,suffix=p12m); /*1 year admisions details*/
%admissions(days=183,suffix=p6m); /*6 months admisions details*/


/*merge in new variables to full variable list*/
proc sql;
create table core_ids_admit_post_1 as select a.*,
b.n_ip_admit_p24m,b.adm_trunc_ind_p24m,b.n_hospd_p24m,
b.n_em_urgent_admit_p24m,b.n_em_admit_p24m,
b.n_urgent_admit_p24m,b.n_elect_admit_p24m,b.n_ED_ip_p24m
from age_ge_65_mc_ltd(drop=c_ivw_date) a
left join
ip_post_730_4 b 
on trim(left(a.bid_hrs))=trim(left(b.bid_hrs_21)) and a.core_year=b.core_year;
quit;


proc sql;
create table core_ids_admit_post_2 as select a.*,
b.n_ip_admit_p12m,b.adm_trunc_ind_p12m,b.n_hospd_p12m,
b.n_em_urgent_admit_p12m,b.n_em_admit_p12m,
b.n_urgent_admit_p12m,b.n_elect_admit_p12m,b.n_ED_ip_p12m
from core_ids_admit_post_1 a
left join
ip_post_365_4 b 
on trim(left(a.bid_hrs))=trim(left(b.bid_hrs_21)) and a.core_year=b.core_year;
quit;


proc sql;
create table core_ids_admit_post_3 as select a.*,
b.n_ip_admit_p6m,b.adm_trunc_ind_p6m,b.n_hospd_p6m,
b.n_em_urgent_admit_p6m,b.n_em_admit_p6m,
b.n_urgent_admit_p6m,b.n_elect_admit_p6m,b.n_ED_ip_p6m
from core_ids_admit_post_2 a
left join
ip_post_183_4 b 
on trim(left(a.bid_hrs))=trim(left(b.bid_hrs_21)) and a.core_year=b.core_year;
quit;


/*Since dataset is just those with ffs mc 1 year preceeding the
core interview, replace admit info with 0 if missing b/c there were no ip claims*/
 data core_ids_admit_post_4;
 set core_ids_admit_post_3;
 array list 
 	n_ip_admit_p24m n_hospd_p24m n_em_urgent_admit_p24m
	n_em_admit_p24m n_urgent_admit_p24m n_elect_admit_p24m n_ED_ip_p24m
	n_ip_admit_p12m n_hospd_p12m n_em_urgent_admit_p12m
	n_em_admit_p12m n_urgent_admit_p12m n_elect_admit_p12m n_ED_ip_p12m
	n_ip_admit_p6m n_hospd_p6m n_em_urgent_admit_p6m
	n_em_admit_p6m n_urgent_admit_p6m n_elect_admit_p6m n_ED_ip_p6m;
 do over list;
 if list=. then list=0;
 end;


 if n_ip_admit_p24m=0 then ind_hosp_adm_p24m=0;
 if n_ip_admit_p24m>0 & n_ip_admit_p24m~=. then ind_hosp_adm_p24m=1;
 label ind_hosp_adm_p24m="Indicator for any hospital admission 24m after core";

 if n_ip_admit_p12m=0 then ind_hosp_adm_p12m=0;
 if n_ip_admit_p12m>0 & n_ip_admit_p12m~=. then ind_hosp_adm_p12m=1;
 label ind_hosp_adm_p12m="Indicator for any hospital admission 12m after core";

 if n_ip_admit_p6m=0 then ind_hosp_adm_p6m=0;
 if n_ip_admit_p6m>0 & n_ip_admit_p6m~=. then ind_hosp_adm_p6m=1;
 label ind_hosp_adm_p6m="Indicator for any hospital admission 6m after core";

 if n_em_urgent_admit_p24m=0 then ind_em_ur_adm_p24m=0;
 if n_em_urgent_admit_p24m>0 & n_em_urgent_admit_p24m~=. then ind_em_ur_adm_p24m=1;
 label ind_em_ur_adm_p24m="Ind any urgent or emergent hospital admission 24m after core";

 if n_em_urgent_admit_p12m=0 then ind_em_ur_adm_p12m=0;
 if n_em_urgent_admit_p12m>0 & n_em_urgent_admit_p12m~=. then ind_em_ur_adm_p12m=1;
 label ind_em_ur_adm_p12m="Ind any urgent or emergent hospital admission 12m after core";

 if n_em_urgent_admit_p6m=0 then ind_em_ur_adm_p6m=0;
 if n_em_urgent_admit_p6m>0 & n_em_urgent_admit_p6m~=. then ind_em_ur_adm_p6m=1;
 label ind_em_ur_adm_p6m="Ind any urgent or emergent hospital admission 6m after core";

 if n_em_admit_p24m=0 then ind_em_adm_p24m=0;
 if n_em_admit_p24m>0 & n_em_admit_p24m~=. then ind_em_adm_p24m=1;
 label ind_em_adm_p24m="Ind any emergency hospital admission 24m after core";

 if n_em_admit_p12m=0 then ind_em_adm_p12m=0;
 if n_em_admit_p12m>0 & n_em_admit_p12m~=. then ind_em_adm_p12m=1;
 label ind_em_adm_p12m="Ind any emergency hospital admission 12m after core";

 if n_em_admit_p6m=0 then ind_em_adm_p6m=0;
 if n_em_admit_p6m>0 & n_em_admit_p6m~=. then ind_em_adm_p6m=1;
 label ind_em_adm_p6m="Ind any emergency hospital admission 6m after core";

 if n_urgent_admit_p24m=0 then ind_ur_adm_p24m=0;
 if n_urgent_admit_p24m>0 & n_urgent_admit_p24m~=. then ind_ur_adm_p24m=1;
 label ind_ur_adm_p24m="Ind any urgent hospital admission 24m after core";

 if n_urgent_admit_p12m=0 then ind_ur_adm_p12m=0;
 if n_urgent_admit_p12m>0 & n_urgent_admit_p12m~=. then ind_ur_adm_p12m=1;
 label ind_ur_adm_p12m="Ind any urgent hospital admission 12m after core";

 if n_urgent_admit_p6m=0 then ind_ur_adm_p6m=0;
 if n_urgent_admit_p6m>0 & n_urgent_admit_p6m~=. then ind_ur_adm_p6m=1;
 label ind_ur_adm_p6m="Ind any urgent hospital admission 6m after core";

 if n_elect_admit_p24m =0 then ind_elect_adm_p24m=0;
 if n_elect_admit_p24m >0 & n_elect_admit_p24m ~=. then ind_elect_adm_p24m=1;
 label ind_elect_adm_p24m="Ind any elective hospital admission 24m after core";


 if n_elect_admit_p12m =0 then ind_elect_adm_p12m=0;
 if n_elect_admit_p12m >0 & n_elect_admit_p12m ~=. then ind_elect_adm_p12m=1;
 label ind_elect_adm_p12m="Ind any elective hospital admission 12m after core";

 if n_elect_admit_p6m =0 then ind_elect_adm_p6m=0;
 if n_elect_admit_p6m >0 & n_elect_admit_p6m ~=. then ind_elect_adm_p6m=1;
 label ind_elect_adm_p6m="Ind any elective hospital admission 6m after core";

 if (n_ip_admit_p24m - n_elect_admit_p24m)=0 then ind_nonelect_adm_p24m=0;
 if (n_ip_admit_p24m - n_elect_admit_p24m)>0 & n_elect_admit_p24m~=. then ind_nonelect_adm_p24m=1;
 label ind_nonelect_adm_p24m="Ind any non-elective hospital admission 24m after core";

 if (n_ip_admit_p12m - n_elect_admit_p12m)=0 then ind_nonelect_adm_p12m=0;
 if (n_ip_admit_p12m - n_elect_admit_p12m)>0 & n_elect_admit_p12m~=. then ind_nonelect_adm_p12m=1;
 label ind_nonelect_adm_p12m="Ind any non-elective hospital admission 12m after core";

 if (n_ip_admit_p6m - n_elect_admit_p6m)=0 then ind_nonelect_adm_p6m=0;
 if (n_ip_admit_p6m - n_elect_admit_p6m)>0 & n_elect_admit_p6m~=. then ind_nonelect_adm_p6m=1;
 label ind_nonelect_adm_p6m="Ind any non-elective hospital admission 6m after core";

 n_nonelect_adm_p24m=(n_ip_admit_p24m - n_elect_admit_p24m);
 label n_nonelect_adm_p24m="total n non-elective ip admit 24m after core";

 n_nonelect_adm_p12m=(n_ip_admit_p12m - n_elect_admit_p12m);
 label n_nonelect_adm_p12m="total n non-elective ip admit 12m after core";

 n_nonelect_adm_p6m=(n_ip_admit_p6m - n_elect_admit_p6m);
 label n_nonelect_adm_p6m="total n non-elective ip admit 6m after core";

 if n_ED_ip_p24m=0 then ind_ED_adm_p24m=0;
 if n_ED_ip_p24m>0 & n_ED_ip_p24m~=. then ind_ED_adm_p24m=1;
 label ind_ED_adm_p24m="Ind ED use with hospital admission 24m after core, from charges";

 if n_ED_ip_p12m=0 then ind_ED_adm_p12m=0;
 if n_ED_ip_p12m>0 & n_ED_ip_p12m~=. then ind_ED_adm_p12m=1;
 label ind_ED_adm_p12m="Ind ED use with hospital admission 12m after core, from charges";

 if n_ED_ip_p6m=0 then ind_ED_adm_p6m=0;
 if n_ED_ip_p6m>0 & n_ED_ip_p6m~=. then ind_ED_adm_p6m=1;
 label ind_ED_adm_p6m="Ind ED use with hospital admission 6m after core, from charges";

run;
proc freq;
table n_ip_admit_p: adm_trunc_ind_p: n_hospd_p: ind_hosp_adm_p: n_em_urgent_admit_p: ind_em_ur_adm_p:
	ind_em_adm_p: ind_ur_adm_p: ind_nonelect_adm_p: n_nonelect_adm_p: n_ED_ip_p: ind_ED_adm_p: 
	ind_em_adm_p24m*ind_ED_adm_p24m ind_em_adm_p12m*ind_ED_adm_p12m ind_em_adm_p6m*ind_ED_adm_p6m /missprint;
run;

/**********************************************************************/
/**********************************************************************/
/*Indicator of any hospice enrollment after interview
Use suffix p24m to indicate post interview*/
/**********************************************************************/
/**********************************************************************/
/*check of hospice claim list*/
data hospice_check1;
set sic_int.hs_meet_post_730;
ivw_to_admit=admit_date-c_ivw_date;
run;
proc means; var ivw_to_admit;run;

data hospice_check;
set sic_int.hs_meet_post_365;
ivw_to_admit=admit_date-c_ivw_date;
run;
proc means; var ivw_to_admit;run;

data hospice_check2;
set sic_int.hs_meet_post_183;
ivw_to_admit=admit_date-c_ivw_date;
run;
proc means; var ivw_to_admit;run;


%macro hospice(days=,suffix=);

proc sort data=sic_int.hs_meet_post_&days.;
by bid_hrs_21 c_ivw_date admit_date;
run;

/*just keep 1 claim per beneficiary-interview since only need indicator of hospice use*/
data hs_meet_post_2_&days.;
set sic_int.hs_meet_post_&days.;
by bid_hrs_21 c_ivw_date;
if first.c_ivw_date;
hs_admit_&suffix.=1;
label hs_admit_&suffix.="Hospice admission &suffix. after interview";
format admit_date date9.;
run;

%mend;

%hospice(days=730,suffix=p24m);
%hospice(days=365,suffix=p12m);
%hospice(days=183,suffix=p6m);

*merge hospice indicators with full dataset;
proc sql;
create table core_ids_admit_hs_post_2 as select a.*,b.hs_admit_p12m from
core_ids_admit_post_4 a left join
hs_meet_post_2_365 b
on trim(left(a.bid_hrs))=trim(left(b.bid_hrs_21)) and a.core_year=b.core_year;
quit;

proc sql;
create table core_ids_admit_hs_post_3 as select a.*,b.hs_admit_p6m from
core_ids_admit_hs_post_2 a left join
hs_meet_post_2_183 b
on trim(left(a.bid_hrs))=trim(left(b.bid_hrs_21)) and a.core_year=b.core_year;
quit;

proc sql;
create table core_ids_admit_hs_post_4 as select a.*,b.hs_admit_p24m from
core_ids_admit_hs_post_3 a left join
hs_meet_post_2_730 b
on trim(left(a.bid_hrs))=trim(left(b.bid_hrs_21)) and a.core_year=b.core_year;
quit;


proc freq; table hs_admit_p6m*hs_admit_p12m /missprint; run;

/*replace with 0 when have full info but no hospice claims
core interview*/
data core_ids_admit_hs_post_5 ;
set core_ids_admit_hs_post_4 ;
if hs_admit_p24m=. then hs_admit_p24m=0;
if hs_admit_p12m=. then hs_admit_p12m=0;
if hs_admit_p6m=. then hs_admit_p6m=0;
run;
proc freq; table hs_admit_p6m*hs_admit_p12m; run;

/*bring new outcomes variables into full interview dataset for those with ffs medicare */
proc sql;
create table sic_int.core_ids_init_outcomes(drop=bid_hrs2 core_year2)
as select * from
age_ge_65_mc a left join
core_ids_admit_hs_post_5(rename=(bid_hrs=bid_hrs2) rename=(core_year=core_year2)) b
on a.bid_hrs=b.bid_hrs2 and a.core_year=b.core_year2;
quit;

proc contents; run;

proc freq; table core_year; run;

proc freq; table hs_admit_p6m*hs_admit_p12m; run;

proc freq;
table n_ip_admit_p6m adm_trunc_ind_p6m n_hospd_p6m ind_hosp_adm_p6m n_em_urgent_admit_p6m ind_em_ur_adm_p6m
	ind_em_adm_p6m ind_ur_adm_p6m ind_nonelect_adm_p6m n_nonelect_adm_p6m n_ED_ip_p6m ind_ED_adm_p6m 
	ind_em_adm_p6m*ind_ED_adm_p6m /missprint;
run;



H="Step 8b - Get Medicare payments 1 year after interview"
/*Add total Medicare payments from claims 1 year after interview
and 6m after interview*/

/*Claims files from 2000-2012, claims pulled in previous section
to get just claims that are within 1 year of the interview dates
for those interviews were r>65 and ffs medicare 1 yr prior to ivw*/

/**********************************************************/
/**********************************************************/
/*totals from mp file*/
/*Note: variable SSLSSNF from mp claims is N=Skilled nursing facility*/
/*Two totals are calculated - one for skilled nursing facility claims
and one for all other claims in the mp file (inpatient claims)*/
/**********************************************************/
/**********************************************************/

/*get count of snf vs ip claims from claim list */
data snf_all;
set sic_int.mp_meet3_post_365(where=(trim(left(SSLSSNF))="N")) ;
ivw_to_admit=admit_date-c_ivw_date;
ivw_to_disch=disch_date-c_ivw_date;
run;

proc means; var ivw_to_admit ivw_to_disch; run;

data ip_all;
set sic_int.mp_meet3_post_365(where=(trim(left(SSLSSNF))~="N")) ;
run;


%macro mp(month_n=,days_start=,days_after_core=,source=,equ=,name=);
%let source0=mp;

/*Case 1 - no adjustment needed - claims where entire claim is within the x months after the interview*/
proc sql;
create table &source._meet_post_1 as select *
from sic_int.&source0._meet3_post_&days_after_core.(where=(trim(left(SSLSSNF))&equ.="N")) 
where &days_start<=disch_date-c_ivw_date<=&days_after_core and
&days_start<=admit_date-c_ivw_date<=&days_after_core;
quit;

data zz_&source._meet_post_1;
set &source._meet_post_1;
ivw_to_admit=admit_date-c_ivw_date;
ivw_to_disch=disch_date-c_ivw_date;
run;
proc means; var ivw_to_admit ivw_to_disch; run;

/*Case 2 - adjustment needed because part of stay is in the window but part is after the window has ended
Claims with admission date within start of x months but discharge date is after the x month window*/
proc sql;
create table &source._meet2_post as select *
from sic_int.&source0._meet3_post_&days_after_core.(where=(trim(left(SSLSSNF))&equ.="N")) 
where disch_date-c_ivw_date>&days_after_core and 0<=admit_date-c_ivw_date<=&days_after_core;
quit;

data zz_&source._meet2_post;
set &source._meet2_post;
ivw_to_admit=admit_date-c_ivw_date;
ivw_to_disch=disch_date-c_ivw_date;
run;
proc means; var ivw_to_admit ivw_to_disch; run;


/*identify fraction of claims that span x month period that should be 
attributed to the x month period
by just using the fraction of time that was included in the span*/
data &source._meet3_post;
set &source._meet2_post;
pct_xm=((c_ivw_date+&days_after_core)-admit_date)/(disch_date-admit_date);
array list pmt_amt passthru;
do over list;
if list=. then list=0;
/*scale the partial claims by the time within the x month period*/
list=list*pct_xm;
end;

run;

/*Case 3 - adjustment needed because part of stay is in the window but part is before the window started
Claims with discharge date within start of x months but admit date is before the interview date*/
proc sql;
create table &source._meet4_post as select *
from sic_int.&source0._meet3_post_&days_after_core.(where=(trim(left(SSLSSNF))&equ.="N")) 
where disch_date-c_ivw_date<=&days_after_core and admit_date-c_ivw_date<&days_start;
quit;

data zz_&source._meet4_post;
set &source._meet4_post;
ivw_to_admit=admit_date-c_ivw_date;
ivw_to_disch=disch_date-c_ivw_date;
run;
proc means; var ivw_to_admit ivw_to_disch; run;


data &source._meet5_post;
set &source._meet4_post;
pct_xm=(disch_date-c_ivw_date)/(disch_date-admit_date);
array list pmt_amt passthru;
do over list;
if list=. then list=0;
/*scale the partial claims by the time within the x month period*/
list=list*pct_xm;
end;

run;

/*adjust for inflation, Uses CPI for Medical Services from 
BLS website, accessed 5/4/2015*/

/*create table merging both the claims fully in the 2 year period 
and those partially in that time
adjust for inflation here also*/
data &source._cost_post;
set &source._meet_post_1 &source._meet3_post &source._meet5_post;
array list pmt_amt passthru;
do over list;
if list=. then list=0;
end;

if year(admit_date)>=2012 then rate=1;
if year(admit_date)=2011 then rate=1.03902;
if year(admit_date)=2010 then rate=1.07086;
if year(admit_date)=2009 then rate=1.10835;
if year(admit_date)=2008 then rate=1.1439;
if year(admit_date)=2007 then rate=1.1923;
if year(admit_date)=2006 then rate=1.25586;
if year(admit_date)=2005 then rate=1.30783;
if year(admit_date)=2004 then rate=1.37027;
if year(admit_date)=2003 then rate=1.43908;
if year(admit_date)=2002 then rate=1.50337;
if year(admit_date)=2001 then rate=1.57963;
if year(admit_date)=2000 then rate=1.65519;
if year(admit_date)<=1999 then rate=1.72641;


&source._paid_by_mc=rate*(pmt_amt+passthru);
run;

*calculates total of mc charges for the claim type by hrs bid;
proc sql;
create table &source._pay_post as select distinct bid_hrs_21,core_year,
sum(&source._paid_by_mc) as &source._paid_by_mc 
from &source._cost_post group by BID_HRS_21,core_year;
quit;

*merges the totals above with the full interview list;
proc sql;
create table &source._&name. as select
a.BID_hrs,a.id,a.core_year,coalesce(b.&source._paid_by_mc,0) as &source._paid_by_mc_&name.
from sic_int.core_ids_init_outcomes a
left join
 &source._pay_post b
 on trim(left(a.BID_hrs))=trim(left(b.bid_hrs_21)) and a.core_year=b.core_year;
 quit;

 proc sort data=&source._&name. ;
 by BID_hrs core_year;
 run;
%mend;

/*Runs macro to get total for the SNF claims*/
%mp(days_start=0,days_after_core=365,source=snf,equ=,name=12m );
%mp(days_start=0,days_after_core=183,source=snf,equ=,name=6m );
/*Runs macro to get total for the inpatient (not SNF) claims*/
%mp(days_start=0,days_after_core=365,source=ip,equ=~,name=12m );
%mp(days_start=0,days_after_core=183,source=ip,equ=~,name=6m );

/**********************************************************/
/**********************************************************/
/*totals from other claim types*/
/**********************************************************/
/**********************************************************/
/*macro to calculate totals for the claims that are not in medpar files*/
%macro all_other(source=,month_n=,days_start=,days_after_core=);

/*Adjust for inflation*/
data &source._meet2_post;
set sic_int.&source._meet_post_&days_after_core.;
/*adjust to 2012 dollars*/
if year(admit_date)>=2012 then rate=1;
if year(admit_date)=2011 then rate=1.03902;
if year(admit_date)=2010 then rate=1.07086;
if year(admit_date)=2009 then rate=1.10835;
if year(admit_date)=2008 then rate=1.1439;
if year(admit_date)=2007 then rate=1.1923;
if year(admit_date)=2006 then rate=1.25586;
if year(admit_date)=2005 then rate=1.30783;
if year(admit_date)=2004 then rate=1.37027;
if year(admit_date)=2003 then rate=1.43908;
if year(admit_date)=2002 then rate=1.50337;
if year(admit_date)=2001 then rate=1.57963;
if year(admit_date)=2000 then rate=1.65519;
if year(admit_date)<=1999 then rate=1.72641;

&source._paid_by_mc=rate*(pmt_amt);
run;

/*Calculate total mc payments by ID*/
proc sql;
create table &source._pay_post as select distinct BID_hrs_21,core_year,
sum(&source._paid_by_mc) as &source._paid_by_mc
from &source._meet2_post group by BID_hrs_21,core_year;
quit;

/*merge in mc totals with interview list*/
proc sql;
create table &source.&month_n._post as select
a.BID_hrs,a.id,a.core_year,coalesce(b.&source._paid_by_mc,0) as &source._paid_by_mc&month_n 
from sic_int.core_ids_init_outcomes a
left join
 &source._pay_post b
 on trim(left(a.BID_hrs))=trim(left(b.BID_hrs_21)) and a.core_year=b.core_year;
 quit;

 proc sort data=&source&month_n._post ;
 by BID_hrs core_year;
 run;
 %mend all_other;

/******************************************************************/
/* Run the macro over the mc claims files for 2 years prior to death*/
/******************************************************************/

 %all_other(source=op,month_n=_12m,days_start=0,days_after_core=365);
  %all_other(source=pb,month_n=_12m,days_start=0,days_after_core=365);
   %all_other(source=hh,month_n=_12m,days_start=0,days_after_core=365);
    %all_other(source=hs,month_n=_12m,days_start=0,days_after_core=365);
     %all_other(source=dm,month_n=_12m,days_start=0,days_after_core=365);

 %all_other(source=op,month_n=_6m,days_start=0,days_after_core=183);
  %all_other(source=pb,month_n=_6m,days_start=0,days_after_core=183);
   %all_other(source=hh,month_n=_6m,days_start=0,days_after_core=183);
    %all_other(source=hs,month_n=_6m,days_start=0,days_after_core=183);
     %all_other(source=dm,month_n=_6m,days_start=0,days_after_core=183);

/******************************************************************/
/* Merge into single file, by id and interview */
/******************************************************************/
*first merge 12m and 6m spending into single dataset;
data mc_costs_all;
merge ip_12m snf_12m hh_12m_post hs_12m_post pb_12m_post op_12m_post dm_12m_post
 ip_6m snf_6m hh_6m_post hs_6m_post pb_6m_post op_6m_post dm_6m_post;
by BID_hrs core_year;
run;

/******************************************************************/
/* Adjust for the wage index */
/******************************************************************/

*add wage index to the costs totals files;
proc sql;
create table mc_costs_all_wi_1 as select a.*, b.wage_index_2012_2
from mc_costs_all a left join
sic_int.core_lmt_xwalk_2 b
on a.BID_hrs=b.bid_hrs and a.core_year=b.core_year;
quit;

/*if wage index is missing, set to 1 and identify with an indicator variable*/
data mc_costs_all_wi_2;
set mc_costs_all_wi_1;
if wage_index_2012_2=. then do;
	wage_index_missing_yes = 1;
	wage_index_2012_2 = 1;
end;
run;

proc freq; table wage_index_missing_yes; run;

%macro wage_ind(source=);
data mc_costs_all_wi_2;
set mc_costs_all_wi_2;
&source._paid_by_mc_12m_wi = &source._paid_by_mc_12m / wage_index_2012_2;
&source._paid_by_mc_6m_wi = &source._paid_by_mc_6m / wage_index_2012_2;
run;
%mend;

%wage_ind(source=ip);
%wage_ind(source=snf);
 %wage_ind(source=op);
  %wage_ind(source=pb);
   %wage_ind(source=hh);
    %wage_ind(source=hs);
     %wage_ind(source=dm);


/******************************************************************/
/* Get totals across all claim types */
/******************************************************************/

data sic_int.mc_costs_12m_6m;
set mc_costs_all_wi_2;
/*total not adjusted for wage index*/
tot_paid_by_mc_12m=sum(of ip_paid_by_mc_12m snf_paid_by_mc_12m hh_paid_by_mc_12m hs_paid_by_mc_12m
pb_paid_by_mc_12m op_paid_by_mc_12m dm_paid_by_mc_12m);

tot_paid_by_mc_6m=sum(of ip_paid_by_mc_6m snf_paid_by_mc_6m hh_paid_by_mc_6m hs_paid_by_mc_6m
pb_paid_by_mc_6m op_paid_by_mc_6m dm_paid_by_mc_6m);

/*wage index adjusted*/
tot_paid_by_mc_12m_wi=sum(of ip_paid_by_mc_12m_wi snf_paid_by_mc_12m_wi hh_paid_by_mc_12m_wi hs_paid_by_mc_12m_wi
pb_paid_by_mc_12m_wi op_paid_by_mc_12m_wi dm_paid_by_mc_12m_wi);

tot_paid_by_mc_6m_wi=sum(of ip_paid_by_mc_6m_wi snf_paid_by_mc_6m_wi hh_paid_by_mc_6m_wi hs_paid_by_mc_6m_wi
pb_paid_by_mc_6m_wi op_paid_by_mc_6m_wi dm_paid_by_mc_6m_wi);

/*label variables*/
label tot_paid_by_mc_12m="Medicare payment total 1 year following interview"
ip_paid_by_mc_12m="IP Medicare payments 1 year following interview" 
snf_paid_by_mc_12m="SNF Medicare payments 1 year following interview"
hh_paid_by_mc_12m="Home health Medicare payments 1 year following interview" 
hs_paid_by_mc_12m="Hospice Medicare payments 1 year following interview"
pb_paid_by_mc_12m="Carrier Medicare payments 1 year following interview" 
op_paid_by_mc_12m="OP Medicare payments 1 year following interview" 
dm_paid_by_mc_12m="DME Medicare payments 1 year following interview"

tot_paid_by_mc_12m_wi="WI adj Medicare payment total 1 year following interview"
ip_paid_by_mc_12m_wi="WI adj IP Medicare payments 1 year following interview" 
snf_paid_by_mc_12m_wi="WI adj SNF Medicare payments 1 year following interview"
hh_paid_by_mc_12m_wi="WI adj Home health Medicare payments 1 year following interview" 
hs_paid_by_mc_12m_wi="WI adj Hospice Medicare payments 1 year following interview"
pb_paid_by_mc_12m_wi="WI adj Carrier Medicare payments 1 year following interview" 
op_paid_by_mc_12m_wi="WI adj OP Medicare payments 1 year following interview" 
dm_paid_by_mc_12m_wi="WI adj DME Medicare payments 1 year following interview"
;

label tot_paid_by_mc_6m="Medicare payment total 6 months following interview"
ip_paid_by_mc_6m="IP Medicare payments 6 months following interview" 
snf_paid_by_mc_6m="SNF Medicare payments 6 months following interview"
hh_paid_by_mc_6m="Home health Medicare payments 6 months following interview" 
hs_paid_by_mc_6m="Hospice Medicare payments 6 months following interview"
pb_paid_by_mc_6m="Carrier Medicare payments 6 months following interview" 
op_paid_by_mc_6m="OP Medicare payments 6 months following interview" 
dm_paid_by_mc_6m="DME Medicare payments 6 months following interview"

tot_paid_by_mc_6m_wi="WI adj Medicare payment total 6 months following interview"
ip_paid_by_mc_6m_wi="WI adj IP Medicare payments 6 months following interview" 
snf_paid_by_mc_6m_wi="WI adj SNF Medicare payments 6 months following interview"
hh_paid_by_mc_6m_wi="WI adj Home health Medicare payments 6 months following interview" 
hs_paid_by_mc_6m_wi="WI adj Hospice Medicare payments 6 months following interview"
pb_paid_by_mc_6m_wi="WI adj Carrier Medicare payments 6 months following interview" 
op_paid_by_mc_6m_wi="WI adj OP Medicare payments 6 months following interview" 
dm_paid_by_mc_6m_wi="WI adj DME Medicare payments 6 months following interview"
;
run;

proc sort data=sic_int.core_ids_init_outcomes; by bid_hrs core_year; run;
proc sort data=sic_int.mc_costs_12m_6m; by bid_hrs core_year; run;


*merge into overall dataset*;
proc sql;
create table sic_int.core_ids_init_outcomes_2(drop=bid_hrs2 id2 core_year2 wi) as select * from
sic_int.core_ids_init_outcomes a left join
sic_int.mc_costs_12m_6m(rename=(bid_hrs=bid_hrs2) rename=(id=id2) rename=(core_year=core_year2) rename=(wage_index_2012_2=wi)) b
on trim(left(a.bid_hrs))=trim(left(b.bid_hrs2)) and a.core_year=b.core_year2;
quit;

proc means; 
var ip_paid_by_mc_: snf_paid_by_mc_: hh_paid_by_mc_: hs_paid_by_mc_:
pb_paid_by_mc_: op_paid_by_mc_: dm_paid_by_mc_: tot_paid_by_mc_:;
run;

proc means ; class part_ab_12m_aft; var ip_paid_by_mc_12m snf_paid_by_mc_12m hh_paid_by_mc_12m hs_paid_by_mc_12m
pb_paid_by_mc_12m op_paid_by_mc_12m dm_paid_by_mc_12m tot_paid_by_mc_12m;
run;

proc means ; class hmo_d_12m_aft; var ip_paid_by_mc_12m snf_paid_by_mc_12m hh_paid_by_mc_12m hs_paid_by_mc_12m
pb_paid_by_mc_12m op_paid_by_mc_12m dm_paid_by_mc_12m tot_paid_by_mc_12m;
run;



H="xxxx(not correct)Step 8b1-Get Medicare payments 2 years after n0"
/*Add total Medicare payments from claims 1 year after interview, 2 yrs after
and 6m after interview*/

/*Claims files from 2000-2012, claims pulled in previous section
to get just claims that are within 1 year of the interview dates
for those interviews were r>65 and ffs medicare 1 yr prior to ivw*/

/**********************************************************/
/**********************************************************/
/*totals from mp file*/
/*Note: variable SSLSSNF from mp claims is N=Skilled nursing facility*/
/*Two totals are calculated - one for skilled nursing facility claims
and one for all other claims in the mp file (inpatient claims)*/
/**********************************************************/
/**********************************************************/

/*get count of snf vs ip claims from claim list */
data snf_all;
set sic_int.mp_meet3_post_730(where=(trim(left(SSLSSNF))="N")) ;
ivw_to_admit=admit_date-c_ivw_date;
ivw_to_disch=disch_date-c_ivw_date;
run;

proc means; var ivw_to_admit ivw_to_disch; run;

data ip_all;
set sic_int.mp_meet3_post_730(where=(trim(left(SSLSSNF))~="N")) ;
run;


%macro mp(month_n=,days_start=,days_after_core=,source=,equ=,name=);
%let source0=mp;

/*Case 1 - no adjustment needed - claims where entire claim is within the x months after the interview*/
proc sql;
create table &source._meet_post_1 as select *
from sic_int.&source0._meet3_post_&days_after_core.(where=(trim(left(SSLSSNF))&equ.="N")) 
where &days_start<=disch_date-c_ivw_date<=&days_after_core and
&days_start<=admit_date-c_ivw_date<=&days_after_core;
quit;

data zz_&source._meet_post_1;
set &source._meet_post_1;
ivw_to_admit=admit_date-c_ivw_date;
ivw_to_disch=disch_date-c_ivw_date;
run;
proc means; var ivw_to_admit ivw_to_disch; run;

/*Case 2 - adjustment needed because part of stay is in the window but part is after the window has ended
Claims with admission date within start of x months but discharge date is after the x month window*/
proc sql;
create table &source._meet2_post as select *
from sic_int.&source0._meet3_post_&days_after_core.(where=(trim(left(SSLSSNF))&equ.="N")) 
where disch_date-c_ivw_date>&days_after_core and 0<=admit_date-c_ivw_date<=&days_after_core;
quit;

data zz_&source._meet2_post;
set &source._meet2_post;
ivw_to_admit=admit_date-c_ivw_date;
ivw_to_disch=disch_date-c_ivw_date;
run;
proc means; var ivw_to_admit ivw_to_disch; run;


/*identify fraction of claims that span x month period that should be 
attributed to the x month period
by just using the fraction of time that was included in the span*/
data &source._meet3_post;
set &source._meet2_post;
pct_xm=((c_ivw_date+&days_after_core)-admit_date)/(disch_date-admit_date);
array list pmt_amt passthru;
do over list;
if list=. then list=0;
/*scale the partial claims by the time within the x month period*/
list=list*pct_xm;
end;

run;

/*Case 3 - adjustment needed because part of stay is in the window but part is before the window started
Claims with discharge date within start of x months but admit date is before the interview date*/
proc sql;
create table &source._meet4_post as select *
from sic_int.&source0._meet3_post_&days_after_core.(where=(trim(left(SSLSSNF))&equ.="N")) 
where disch_date-c_ivw_date<=&days_after_core and admit_date-c_ivw_date<&days_start;
quit;

data zz_&source._meet4_post;
set &source._meet4_post;
ivw_to_admit=admit_date-c_ivw_date;
ivw_to_disch=disch_date-c_ivw_date;
run;
proc means; var ivw_to_admit ivw_to_disch; run;


data &source._meet5_post;
set &source._meet4_post;
pct_xm=(disch_date-c_ivw_date)/(disch_date-admit_date);
array list pmt_amt passthru;
do over list;
if list=. then list=0;
/*scale the partial claims by the time within the x month period*/
list=list*pct_xm;
end;

run;

/*adjust for inflation, Uses CPI for Medical Services from 
BLS website, accessed 5/4/2015*/

/*create table merging both the claims fully in the 2 year period 
and those partially in that time
adjust for inflation here also*/
data &source._cost_post;
set &source._meet_post_1 &source._meet3_post &source._meet5_post;
array list pmt_amt passthru;
do over list;
if list=. then list=0;
end;

if year(admit_date)>=2012 then rate=1;
if year(admit_date)=2011 then rate=1.03902;
if year(admit_date)=2010 then rate=1.07086;
if year(admit_date)=2009 then rate=1.10835;
if year(admit_date)=2008 then rate=1.1439;
if year(admit_date)=2007 then rate=1.1923;
if year(admit_date)=2006 then rate=1.25586;
if year(admit_date)=2005 then rate=1.30783;
if year(admit_date)=2004 then rate=1.37027;
if year(admit_date)=2003 then rate=1.43908;
if year(admit_date)=2002 then rate=1.50337;
if year(admit_date)=2001 then rate=1.57963;
if year(admit_date)=2000 then rate=1.65519;
if year(admit_date)<=1999 then rate=1.72641;


&source._paid_by_mc=rate*(pmt_amt+passthru);
run;

*calculates total of mc charges for the claim type by hrs bid;
proc sql;
create table &source._pay_post as select distinct bid_hrs_21,core_year,
sum(&source._paid_by_mc) as &source._paid_by_mc 
from &source._cost_post group by BID_HRS_21,core_year;
quit;

*merges the totals above with the full interview list;
proc sql;
create table &source._&name. as select
a.BID_hrs,a.id,a.core_year,coalesce(b.&source._paid_by_mc,0) as &source._paid_by_mc_&name.
from sic_int.core_ids_init_outcomes a
left join
 &source._pay_post b
 on trim(left(a.BID_hrs))=trim(left(b.bid_hrs_21)) and a.core_year=b.core_year;
 quit;

 proc sort data=&source._&name. ;
 by BID_hrs core_year;
 run;
%mend;

/*Runs macro to get total for the SNF claims*/
%mp(days_start=0,days_after_core=730,source=snf,equ=,name=24m );
%mp(days_start=0,days_after_core=365,source=snf,equ=,name=12m );
%mp(days_start=0,days_after_core=183,source=snf,equ=,name=6m );
/*Runs macro to get total for the inpatient (not SNF) claims*/
%mp(days_start=0,days_after_core=730,source=ip,equ=~,name=24m );
%mp(days_start=0,days_after_core=365,source=ip,equ=~,name=12m );
%mp(days_start=0,days_after_core=183,source=ip,equ=~,name=6m );

/**********************************************************/
/**********************************************************/
/*totals from other claim types*/
/**********************************************************/
/**********************************************************/
/*macro to calculate totals for the claims that are not in medpar files*/
%macro all_other(source=,month_n=,days_start=,days_after_core=);

/*Adjust for inflation*/
data &source._meet2_post;
set sic_int.&source._meet_post_&days_after_core.;
/*adjust to 2012 dollars*/
if year(admit_date)>=2012 then rate=1;
if year(admit_date)=2011 then rate=1.03902;
if year(admit_date)=2010 then rate=1.07086;
if year(admit_date)=2009 then rate=1.10835;
if year(admit_date)=2008 then rate=1.1439;
if year(admit_date)=2007 then rate=1.1923;
if year(admit_date)=2006 then rate=1.25586;
if year(admit_date)=2005 then rate=1.30783;
if year(admit_date)=2004 then rate=1.37027;
if year(admit_date)=2003 then rate=1.43908;
if year(admit_date)=2002 then rate=1.50337;
if year(admit_date)=2001 then rate=1.57963;
if year(admit_date)=2000 then rate=1.65519;
if year(admit_date)<=1999 then rate=1.72641;

&source._paid_by_mc=rate*(pmt_amt);
run;

/*Calculate total mc payments by ID*/
proc sql;
create table &source._pay_post as select distinct BID_hrs_21,core_year,
sum(&source._paid_by_mc) as &source._paid_by_mc
from &source._meet2_post group by BID_hrs_21,core_year;
quit;

/*merge in mc totals with interview list*/
proc sql;
create table &source.&month_n._post as select
a.BID_hrs,a.id,a.core_year,coalesce(b.&source._paid_by_mc,0) as &source._paid_by_mc&month_n 
from sic_int.core_ids_init_outcomes a
left join
 &source._pay_post b
 on trim(left(a.BID_hrs))=trim(left(b.BID_hrs_21)) and a.core_year=b.core_year;
 quit;

 proc sort data=&source&month_n._post ;
 by BID_hrs core_year;
 run;
 %mend all_other;

/******************************************************************/
/* Run the macro over the mc claims files for 2 years prior to death*/
/******************************************************************/

 %all_other(source=op,month_n=_24m,days_start=0,days_after_core=730);
  %all_other(source=pb,month_n=_24m,days_start=0,days_after_core=730);
   %all_other(source=hh,month_n=_24m,days_start=0,days_after_core=730);
    %all_other(source=hs,month_n=_24m,days_start=0,days_after_core=730);
     %all_other(source=dm,month_n=_24m,days_start=0,days_after_core=730);

 %all_other(source=op,month_n=_12m,days_start=0,days_after_core=365);
  %all_other(source=pb,month_n=_12m,days_start=0,days_after_core=365);
   %all_other(source=hh,month_n=_12m,days_start=0,days_after_core=365);
    %all_other(source=hs,month_n=_12m,days_start=0,days_after_core=365);
     %all_other(source=dm,month_n=_12m,days_start=0,days_after_core=365);

 %all_other(source=op,month_n=_6m,days_start=0,days_after_core=183);
  %all_other(source=pb,month_n=_6m,days_start=0,days_after_core=183);
   %all_other(source=hh,month_n=_6m,days_start=0,days_after_core=183);
    %all_other(source=hs,month_n=_6m,days_start=0,days_after_core=183);
     %all_other(source=dm,month_n=_6m,days_start=0,days_after_core=183);

/******************************************************************/
/* Merge into single file, by id and interview */
/******************************************************************/
*first merge 12m and 6m spending into single dataset;
data mc_costs_all;
merge ip_24m snf_24m hh_24m_post hs_24m_post pb_24m_post op_24m_post dm_24m_post
ip_12m snf_12m hh_12m_post hs_12m_post pb_12m_post op_12m_post dm_12m_post
 ip_6m snf_6m hh_6m_post hs_6m_post pb_6m_post op_6m_post dm_6m_post;
by BID_hrs core_year;
run;

/******************************************************************/
/* Adjust for the wage index */
/******************************************************************/

*add wage index to the costs totals files;
proc sql;
create table mc_costs_all_wi_1 as select a.*, b.wage_index_2012_2
from mc_costs_all a left join
sic_int.core_lmt_xwalk_2 b
on a.BID_hrs=b.bid_hrs and a.core_year=b.core_year;
quit;

/*if wage index is missing, set to 1 and identify with an indicator variable*/
data mc_costs_all_wi_2;
set mc_costs_all_wi_1;
if wage_index_2012_2=. then do;
	wage_index_missing_yes = 1;
	wage_index_2012_2 = 1;
end;
run;

proc freq; table wage_index_missing_yes; run;

%macro wage_ind(source=);
data mc_costs_all_wi_2;
set mc_costs_all_wi_2;
&source._paid_by_mc_24m_wi = &source._paid_by_mc_24m / wage_index_2012_2;
&source._paid_by_mc_12m_wi = &source._paid_by_mc_12m / wage_index_2012_2;
&source._paid_by_mc_6m_wi = &source._paid_by_mc_6m / wage_index_2012_2;
run;
%mend;

%wage_ind(source=ip);
%wage_ind(source=snf);
 %wage_ind(source=op);
  %wage_ind(source=pb);
   %wage_ind(source=hh);
    %wage_ind(source=hs);
     %wage_ind(source=dm);


/******************************************************************/
/* Get totals across all claim types */
/******************************************************************/

data sic_int.mc_costs_12m_6m;
set mc_costs_all_wi_2;
/*total not adjusted for wage index*/
tot_paid_by_mc_24m=sum(of ip_paid_by_mc_24m snf_paid_by_mc_24m hh_paid_by_mc_24m hs_paid_by_mc_24m
pb_paid_by_mc_24m op_paid_by_mc_24m dm_paid_by_mc_24m);

tot_paid_by_mc_12m=sum(of ip_paid_by_mc_12m snf_paid_by_mc_12m hh_paid_by_mc_12m hs_paid_by_mc_12m
pb_paid_by_mc_12m op_paid_by_mc_12m dm_paid_by_mc_12m);

tot_paid_by_mc_6m=sum(of ip_paid_by_mc_6m snf_paid_by_mc_6m hh_paid_by_mc_6m hs_paid_by_mc_6m
pb_paid_by_mc_6m op_paid_by_mc_6m dm_paid_by_mc_6m);

/*wage index adjusted*/
tot_paid_by_mc_24m_wi=sum(of ip_paid_by_mc_24m_wi snf_paid_by_mc_24m_wi hh_paid_by_mc_24m_wi hs_paid_by_mc_24m_wi
pb_paid_by_mc_24m_wi op_paid_by_mc_24m_wi dm_paid_by_mc_24m_wi);

tot_paid_by_mc_12m_wi=sum(of ip_paid_by_mc_12m_wi snf_paid_by_mc_12m_wi hh_paid_by_mc_12m_wi hs_paid_by_mc_12m_wi
pb_paid_by_mc_12m_wi op_paid_by_mc_12m_wi dm_paid_by_mc_12m_wi);

tot_paid_by_mc_6m_wi=sum(of ip_paid_by_mc_6m_wi snf_paid_by_mc_6m_wi hh_paid_by_mc_6m_wi hs_paid_by_mc_6m_wi
pb_paid_by_mc_6m_wi op_paid_by_mc_6m_wi dm_paid_by_mc_6m_wi);

/*label variables*/
label tot_paid_by_mc_24m="Medicare payment total 2 years following interview"
ip_paid_by_mc_24m="IP Medicare payments 2 years following interview" 
snf_paid_by_mc_24m="SNF Medicare payments 2 years following interview"
hh_paid_by_mc_24m="Home health Medicare payments 2 years following interview" 
hs_paid_by_mc_24m="Hospice Medicare payments 2 years following interview"
pb_paid_by_mc_24m="Carrier Medicare payments 2 years following interview" 
op_paid_by_mc_24m="OP Medicare payments 2 years following interview" 
dm_paid_by_mc_24m="DME Medicare payments 2 years following interview"

tot_paid_by_mc_24m_wi="WI adj Medicare payment total 2 years following interview"
ip_paid_by_mc_24m_wi="WI adj IP Medicare payments 2 years following interview" 
snf_paid_by_mc_24m_wi="WI adj SNF Medicare payments 2 years following interview"
hh_paid_by_mc_24m_wi="WI adj Home health Medicare payments 2 years following interview" 
hs_paid_by_mc_24m_wi="WI adj Hospice Medicare payments 2 years following interview"
pb_paid_by_mc_24m_wi="WI adj Carrier Medicare payments 2 years following interview" 
op_paid_by_mc_24m_wi="WI adj OP Medicare payments 2 years following interview" 
dm_paid_by_mc_24m_wi="WI adj DME Medicare payments 2 years following interview"
;

label tot_paid_by_mc_12m="Medicare payment total 1 year following interview"
ip_paid_by_mc_12m="IP Medicare payments 1 year following interview" 
snf_paid_by_mc_12m="SNF Medicare payments 1 year following interview"
hh_paid_by_mc_12m="Home health Medicare payments 1 year following interview" 
hs_paid_by_mc_12m="Hospice Medicare payments 1 year following interview"
pb_paid_by_mc_12m="Carrier Medicare payments 1 year following interview" 
op_paid_by_mc_12m="OP Medicare payments 1 year following interview" 
dm_paid_by_mc_12m="DME Medicare payments 1 year following interview"

tot_paid_by_mc_12m_wi="WI adj Medicare payment total 1 year following interview"
ip_paid_by_mc_12m_wi="WI adj IP Medicare payments 1 year following interview" 
snf_paid_by_mc_12m_wi="WI adj SNF Medicare payments 1 year following interview"
hh_paid_by_mc_12m_wi="WI adj Home health Medicare payments 1 year following interview" 
hs_paid_by_mc_12m_wi="WI adj Hospice Medicare payments 1 year following interview"
pb_paid_by_mc_12m_wi="WI adj Carrier Medicare payments 1 year following interview" 
op_paid_by_mc_12m_wi="WI adj OP Medicare payments 1 year following interview" 
dm_paid_by_mc_12m_wi="WI adj DME Medicare payments 1 year following interview"
;

label tot_paid_by_mc_6m="Medicare payment total 6 months following interview"
ip_paid_by_mc_6m="IP Medicare payments 6 months following interview" 
snf_paid_by_mc_6m="SNF Medicare payments 6 months following interview"
hh_paid_by_mc_6m="Home health Medicare payments 6 months following interview" 
hs_paid_by_mc_6m="Hospice Medicare payments 6 months following interview"
pb_paid_by_mc_6m="Carrier Medicare payments 6 months following interview" 
op_paid_by_mc_6m="OP Medicare payments 6 months following interview" 
dm_paid_by_mc_6m="DME Medicare payments 6 months following interview"

tot_paid_by_mc_6m_wi="WI adj Medicare payment total 6 months following interview"
ip_paid_by_mc_6m_wi="WI adj IP Medicare payments 6 months following interview" 
snf_paid_by_mc_6m_wi="WI adj SNF Medicare payments 6 months following interview"
hh_paid_by_mc_6m_wi="WI adj Home health Medicare payments 6 months following interview" 
hs_paid_by_mc_6m_wi="WI adj Hospice Medicare payments 6 months following interview"
pb_paid_by_mc_6m_wi="WI adj Carrier Medicare payments 6 months following interview" 
op_paid_by_mc_6m_wi="WI adj OP Medicare payments 6 months following interview" 
dm_paid_by_mc_6m_wi="WI adj DME Medicare payments 6 months following interview"
;
run;

proc sort data=sic_int.core_ids_init_outcomes; by bid_hrs core_year; run;
proc sort data=sic_int.mc_costs_12m_6m; by bid_hrs core_year; run;


*merge into overall dataset*;
proc sql;
create table sic_int.core_ids_init_outcomes_2(drop=bid_hrs2 id2 core_year2 wi) as select * from
sic_int.core_ids_init_outcomes a left join
sic_int.mc_costs_12m_6m(rename=(bid_hrs=bid_hrs2) rename=(id=id2) rename=(core_year=core_year2) rename=(wage_index_2012_2=wi)) b
on trim(left(a.bid_hrs))=trim(left(b.bid_hrs2)) and a.core_year=b.core_year2;
quit;

proc means; 
var ip_paid_by_mc_: snf_paid_by_mc_: hh_paid_by_mc_: hs_paid_by_mc_:
pb_paid_by_mc_: op_paid_by_mc_: dm_paid_by_mc_: tot_paid_by_mc_:;
run;

proc means ; class part_ab_12m_aft; var ip_paid_by_mc_12m snf_paid_by_mc_12m hh_paid_by_mc_12m hs_paid_by_mc_12m
pb_paid_by_mc_12m op_paid_by_mc_12m dm_paid_by_mc_12m tot_paid_by_mc_12m;
run;

proc means ; class hmo_d_12m_aft; var ip_paid_by_mc_12m snf_paid_by_mc_12m hh_paid_by_mc_12m hs_paid_by_mc_12m
pb_paid_by_mc_12m op_paid_by_mc_12m dm_paid_by_mc_12m tot_paid_by_mc_12m;
run;



H="Step 8c - contact days"
/*Contact days*/
/*Use year before interview claims, then merge with main data*/

data mpa;
set sic_int.mp_meet3_365;
run;

data mpb;
set mpa(keep=bid_hrs_21 admit_date disch_date sslssnf c_ivw_date core_year);
if admit_date<c_ivw_date-365 then admit_date=c_ivw_date-365;
if disch_date>c_ivw_date then disch_date=c_ivw_date;
los=disch_date-admit_date+1;
if los=0 then los=1;
run;

proc sort data=mpb out=mpc nodupkey; 
by bid_hrs_21 admit_date disch_date c_ivw_date; 
run;

%macro dates();
data mpd;
set mpc;
%do i=1 %to 366;
%let l=%eval(&i-1);
if los>=&i. then date&i.=admit_date+&l.;
format date&i. date9.;
%end;
run;
%mend;

%dates();

data mpe;
set mpd;
array adate(1:366) date1-date366;
do datenum = 1 to 366;
date=adate(datenum);
output;
end;
format date date9.;
drop date1-date366;
run;

data mpf;
set mpe;
where date~=.;
run;

proc sort data=mpf out=mpg nodupkey;
by bid_hrs_21 date;
run;

data mp;
set mpg(keep= bid_hrs_21 date admit_date c_ivw_date);
where date~=.;
mp=1;
run;

proc sql;
create table mp_cd as select distinct
bid_hrs_21,c_ivw_date,
count(date) as mp_contact_days
from mp group by bid_hrs_21, c_ivw_date;
quit;

data ip;
set mpg;
where sslssnf~="N";
if date~=.;
run;

proc sql;
create table ip_cd as select distinct
bid_hrs_21,c_ivw_date,
count(date) as ip_contact_days
from ip group by bid_hrs_21,c_ivw_date;
quit;

data pba;
set sic_int.pb_meet_365;
run;

data pbb;
set pba(keep=bid_hrs_21 admit_date hcpscd01-hcpscd13 betos01-betos13 c_ivw_date);
run;

data pbe(keep=bid_hrs_21 date betos01 code c_ivw_date);
set pbb;
date=admit_date;
code=substr(betos01,1,1);
pb=1;
run;
data pbe2;
set pbe;
if code~="" and code~="Y" and code~="Z" and code~="O" and code~="D" and betos01~="M4A";
run;
proc sort data=pbe2 out=pbe3 nodupkey;
by bid_hrs_21 date c_ivw_date; 
run;

proc sql;
create table pb_adm as select distinct
bid_hrs_21,c_ivw_date,
count(date) as pb_adm_days
from pbe3 group by bid_hrs_21,c_ivw_date;
quit;

data pbf;
set pbe3;
where date~=.; 
format date date9.;
pb=1;
run;

proc sort data=pbf out=pb nodupkey;
by bid_hrs_21 date;
run;

proc sql;
create table pb_cd as select distinct
bid_hrs_21,c_ivw_date,
count(date) as pb_contact_days
from pb group by bid_hrs_21,c_ivw_date;
quit;

data alla;
set mp pb;
where date~=.;
format date date9.;
run;

proc sort data=alla out=allb nodupkey;
by bid_hrs_21 date;
run;

proc sql;
create table allc as select distinct
bid_hrs_21,c_ivw_date,
count(date) as contact_days
from allb group by bid_hrs_21,c_ivw_date;
quit;

data ids;
set sic_int.core_ids_init_outcomes_2(keep=bid_hrs c_ivw_date);
run;

proc sql; 
create table alld as select * from 
ids a left join
allc b
on a.bid_hrs=b.bid_hrs_21 and a.c_ivw_date=b.c_ivw_date
left join mp_cd c
on a.bid_hrs=c.bid_hrs_21 and a.c_ivw_date=c.c_ivw_date
left join pb_cd d
on a.bid_hrs=d.bid_hrs_21 and a.c_ivw_date=d.c_ivw_date;
run;

data all;
set alld;
array list mp_contact_days ip_contact_days  pb_contact_days contact_days;
do over list;
if list=. then list=0;
end;
run;

proc sql;
create table sic_int.core_ids_init_outcomes_2a as select * from 
sic_int.core_ids_init_outcomes_2 a
left join 
all b
on a.bid_hrs=b.bid_hrs_21;
quit;

H="Step 9 - Identify interview where criteria is first met"
/*create variable that identifies first interview that the criteria is met
3 criteria used:
A) Any serious medical illness
B) Serious medical illness or ADL impairment AND either Urgent/Emerg hopspital admission
or nursing home use
C) Serious illness and ADL impairment and [NH resident and/or hospitalization]

Creates file with outcomes as well

Revised to add additional criteria
1. Serious illness 
2. ADL impairment 
3. Serious illness and ADL impairment
4. Serious illness and ADL impairment and nursing home resident
5. Serious illness and ADL impairment and hospitalization
6. Serious illness and/or ADL impairment and hospitalization but no nursing home resident*
*Want to see if this is very many R's. We think there aren't many R's that are nursing
home residents but haven't had a hospitalization

*/


/***********    Criteria A    ************/
data ivw_meet_a;
set sic_int.core_ids_init_outcomes_2a(keep=id criteria_a core_year) ;
if criteria_a=1;
run;

proc sort data=ivw_meet_a;
by id core_year;
run;

data ivw_meet_a_1;
set ivw_meet_a;
by id;
if first.id then ivw_meet_crit_a=1;
else ivw_meet_crit_a=0;
label ivw_meet_crit_a="Ind. 1st time meets Criteria A";
run;

proc freq; table ivw_meet_crit_a;
run;

/***********    Criteria B    ************/
data ivw_meet_b;
set sic_int.core_ids_init_outcomes_2a(keep=id criteria_b core_year) ;
if criteria_b=1;
run;

proc sort data=ivw_meet_b;
by id core_year;
run;

data ivw_meet_b_1;
set ivw_meet_b;
by id;
if first.id then ivw_meet_crit_b=1;
else ivw_meet_crit_b=0;
label ivw_meet_crit_b="Ind. 1st time meets Criteria B";
run;

proc freq; table ivw_meet_crit_b;
run;

/***********    Criteria C    ************/
data ivw_meet_c;
set sic_int.core_ids_init_outcomes_2a(keep=id criteria_c core_year) ;
if criteria_c=1;
run;

proc sort data=ivw_meet_c;
by id core_year;
run;

data ivw_meet_c_1;
set ivw_meet_c;
by id;
if first.id then ivw_meet_crit_c=1;
else ivw_meet_crit_c=0;
label ivw_meet_crit_c="Ind. 1st time meets Criteria C";
run;

proc freq; table ivw_meet_crit_c;
run;


/***********    Serious medical illness    ************/
data ivw_meet_smi;
set sic_int.core_ids_init_outcomes_2a(keep=id ser_med_illness core_year) ;
if ser_med_illness=1;
run;

proc sort data=ivw_meet_smi;
by id core_year;
run;

data ivw_meet_smi_1;
set ivw_meet_smi;
by id;
if first.id then ivw_meet_crit_smi=1;
else ivw_meet_crit_smi=0;
label ivw_meet_crit_smi="Ind. 1st time meets serious medical illness";
run;

proc freq; table ivw_meet_crit_smi;
run;

/***********    ADL Impairment     ************/
data ivw_meet_adl;
set sic_int.core_ids_init_outcomes_2a(keep=id adl_impair_core core_year) ;
if adl_impair_core=1;
run;

proc sort data=ivw_meet_adl;
by id core_year;
run;

data ivw_meet_adl_1;
set ivw_meet_adl;
by id;
if first.id then ivw_meet_crit_adl=1;
else ivw_meet_crit_adl=0;
label ivw_meet_crit_adl="Ind. 1st time meets ADL impairment";
run;

proc freq; table ivw_meet_crit_adl;
run;

/***********    Serious illness and ADL Impairment     ************/
data ivw_meet_smiadl;
set sic_int.core_ids_init_outcomes_2a(keep=id adl_impair_core ser_med_illness core_year) ;
if ser_med_illness=1 & adl_impair_core=1;
run;

proc sort data=ivw_meet_smiadl;
by id core_year;
run;

data ivw_meet_smiadl_1;
set ivw_meet_smiadl;
by id;
if first.id then ivw_meet_crit_smiadl=1;
else ivw_meet_crit_smiadl=0;
label ivw_meet_crit_smiadl="Ind. 1st time meets serious med illness and ADL impairment";
run;

proc freq; table ivw_meet_crit_smiadl;
run;

/***********    Serious illness and ADL Impairment and Nursing Home Resident (no hospital)   ************/
data ivw_meet_smiadlnh;
set sic_int.core_ids_init_outcomes_2a(keep=id adl_impair_core ser_med_illness smi_nh_ind ind_em_ur_adm_12m core_year) ;
if ser_med_illness=1 & adl_impair_core=1 & smi_nh_ind=1 & ind_em_ur_adm_12m=0;
run;

proc sort data=ivw_meet_smiadlnh;
by id core_year;
run;

data ivw_meet_smiadlnh_1;
set ivw_meet_smiadlnh;
by id;
if first.id then ivw_meet_crit_smiadlnh=1;
else ivw_meet_crit_smiadlnh=0;
label ivw_meet_crit_smiadlnh="Ind. 1st time meets serious med illness + ADL + NH";
run;

proc freq; table ivw_meet_crit_smiadlnh;
run;

/***********Serious illness and ADL Impairment and Urgent/Emergent Hospitalization (no NH) ************/
data ivw_meet_smiadlho;
set sic_int.core_ids_init_outcomes_2a(keep=id adl_impair_core ser_med_illness ind_em_ur_adm_12m smi_nh_ind core_year) ;
if ser_med_illness=1 & adl_impair_core=1 & ind_em_ur_adm_12m=1 & smi_nh_ind=0 ;
run;

proc sort data=ivw_meet_smiadlho;
by id core_year;
run;

data ivw_meet_smiadlho_1;
set ivw_meet_smiadlho;
by id;
if first.id then ivw_meet_crit_smiadlho=1;
else ivw_meet_crit_smiadlho=0;
label ivw_meet_crit_smiadlho="Ind. 1st time meets serious med illness + ADL + Hospital";
run;

proc freq; table ivw_meet_crit_smiadlho;
run;

/***********Serious illness and ADL Impairment and Urgent/Emergent Hospitalization and NH ************/
data ivw_meet_smiadlhonh;
set sic_int.core_ids_init_outcomes_2a(keep=id adl_impair_core ser_med_illness ind_em_ur_adm_12m smi_nh_ind core_year) ;
if ser_med_illness=1 & adl_impair_core=1 & ind_em_ur_adm_12m=1 & smi_nh_ind=1 ;
run;

proc sort data=ivw_meet_smiadlhonh;
by id core_year;
run;

data ivw_meet_smiadlhonh_1;
set ivw_meet_smiadlhonh;
by id;
if first.id then ivw_meet_crit_smiadlhonh=1;
else ivw_meet_crit_smiadlhonh=0;
label ivw_meet_crit_smiadlhonh="Ind. 1st time meets serious med illness + ADL + Hospital + NH";
run;

proc freq; table ivw_meet_crit_smiadlhonh;
run;

/***********Serious illness and/or ADL Impairment and Urgent/Emergent Hospitalization (no NH) ************/
data ivw_meet_aho;
set sic_int.core_ids_init_outcomes_2a(keep=id criteria_a ind_em_ur_adm_12m smi_nh_ind core_year) ;
if criteria_a=1 & ind_em_ur_adm_12m=1 & smi_nh_ind=0 ;
run;

proc sort data=ivw_meet_aho;
by id core_year;
run;

data ivw_meet_aho_1;
set ivw_meet_aho;
by id;
if first.id then ivw_meet_crit_aho=1;
else ivw_meet_crit_aho=0;
label ivw_meet_crit_aho="Ind. 1st time meets Crit A + Hospital";
run;

proc freq; table ivw_meet_crit_aho;
run;


/***********    Merge indicators into single dataset    ************/
data crit_all(keep=id core_year ivw_meet_crit_a ivw_meet_crit_b ivw_meet_crit_c
ivw_meet_crit_smi ivw_meet_crit_adl ivw_meet_crit_smiadl ivw_meet_crit_smiadlnh ivw_meet_crit_smiadlho 
ivw_meet_crit_smiadlhonh  ivw_meet_crit_aho);
merge ivw_meet_a_1 ivw_meet_b_1 ivw_meet_c_1 ivw_meet_smi_1 ivw_meet_adl_1 ivw_meet_smiadl_1 
ivw_meet_smiadlnh_1 ivw_meet_smiadlho_1 ivw_meet_smiadlhonh_1  ivw_meet_aho_1;
by id core_year;
run;


/*merge in new variables with the overall dataset*/
proc sort data=sic_int.core_ids_init_outcomes_2a out=ivw_to_merge nodupkey; by id core_year; run;

proc sql;
create table ivws_crit(drop=id2 core_year2) as select * from
ivw_to_merge a left join
crit_all(rename=(id=id2) rename=(core_year=core_year2)) b
on a.id=b.id2 and a.core_year=b.core_year2;
quit;

data ivws_crit_1a;
set ivws_crit;
array list ivw_meet_crit_a ivw_meet_crit_b ivw_meet_crit_c ivw_meet_crit_smi
	ivw_meet_crit_adl ivw_meet_crit_smiadl ivw_meet_crit_smiadlnh
	ivw_meet_crit_smiadlho ivw_meet_crit_smiadlhonh ivw_meet_crit_aho ;
do over list;
if list=. & comorb_1_0_1yr~=. then list=0;
end;
rename Hospital_care_intensity_index__s=hospital_care_intensity;
run;

/*should be 5813 and 3497 and 1649*/
proc freq;
table ivw_meet_crit_a ivw_meet_crit_b ivw_meet_crit_c;
run;

/***********************************************************************/
/***********    Identify R's that never meet criteria       ************/
/***********************************************************************/

data ever_meet;
set ivws_crit_1a;
meet_abc=0;
if ivw_meet_crit_a=1 or ivw_meet_crit_b=1 or ivw_meet_crit_c=1 then do;
 meet_abc=1;
end;
run;

proc sort data=ever_meet;
by id core_year;
run;

proc sql;
create table ever_meet_2 as select distinct id,
sum(meet_abc) as total_meet_abc label="n ivws meet a b c"
from ever_meet group by id;
quit;

proc freq; table total_meet_abc; run;

data ever_meet_3;
set ever_meet_2;
ind_no_crit=0;
if total_meet_abc=0 then ind_no_crit=1;
label="Indicator R never meets criteria a,b,or c";
run;

/*bring into main dataset*/
proc sql;
create table sic_int.ivws_crit_1a as select a.*,b.ind_no_crit from
ivws_crit_1a a left join
ever_meet_3 b
on a.id=b.id;
quit;

proc freq; table ind_no_crit; run;
proc freq; table ivw_meet_crit_a*ind_no_crit ivw_meet_crit_b*ind_no_crit ivw_meet_crit_c*ind_no_crit; run;

/*initial look at outcomes from claims data*/

/*for Criteria A*/
data criteria_a;
set sic_int.ivws_crit_1a;
if ivw_meet_crit_a=1;
run;

/*for Criteria B*/
data criteria_b;
set sic_int.ivws_crit_1a;
if ivw_meet_crit_b=1;
run;

/*for Criteria C*/
data criteria_c;
set sic_int.ivws_crit_1a;
if ivw_meet_crit_c=1;
run;



ods rtf body="E:\data\serious_ill\logs\outcomes_first_look.rtf";
title "Outcomes 1 year after initially meeting criteria A) Any serious medical illness and/or ADL Impair";
proc freq data=criteria_a;
table core_to_dod_1yr core_to_dod_6m hs_admit_p12m hs_admit_p6m ind_em_ur_adm_p12m ind_em_ur_adm_p6m ;
run;
proc means data=criteria_a; 
vars ip_paid_by_mc_: snf_paid_by_mc_: hh_paid_by_mc_: hs_paid_by_mc_: 
pb_paid_by_mc_:  op_paid_by_mc_: 
dm_paid_by_mc_:  tot_paid_by_mc_: n_hospd_p12m n_hospd_p6m; run;

title "Outcomes 1 year after initially meeting criteria B) Any ser med illness and/or ADL Impair + SNF and/or Hospital.";
proc freq data=criteria_b;
table core_to_dod_1yr core_to_dod_6m hs_admit_p12m hs_admit_p6m ind_em_ur_adm_p12m ind_em_ur_adm_p6m ;
run;
proc means data=criteria_b; 
vars ip_paid_by_mc_: snf_paid_by_mc_: hh_paid_by_mc_: hs_paid_by_mc_: 
pb_paid_by_mc_:  op_paid_by_mc_: 
dm_paid_by_mc_:  tot_paid_by_mc_: n_hospd_p12m n_hospd_p6m; run;

title "Outcomes 1 year after initially meeting criteria C) Any ser med illness and ADL Impair + SNF and/or Hospital.";
proc freq data=criteria_c;
table core_to_dod_1yr core_to_dod_6m hs_admit_p12m hs_admit_p6m ind_em_ur_adm_p12m ind_em_ur_adm_p6m ;
run;
proc means data=criteria_c; 
vars ip_paid_by_mc_: snf_paid_by_mc_: hh_paid_by_mc_: hs_paid_by_mc_: 
pb_paid_by_mc_:  op_paid_by_mc_: 
dm_paid_by_mc_:  tot_paid_by_mc_: n_hospd_p12m n_hospd_p6m; run;

ods rtf close;


/*export full dataset to Stata*/
proc export data=sic_int.ivws_crit_1a
outfile="E:\data\serious_ill\int_data\ivws_crit_1a.dta" replace;
run;

/*stata code to get percentile of medicare spending*/

use "E:\data\serious_ill\int_data\ivws_crit_1a.dta", clear
/*this code creates percentile of spending for 12m 24m, and 12-24m timeframes 
 for each core year so there is no double counting of respondents in the percentile*/
 
gen tot_paid_by_mc_2nd_yr_wi=tot_paid_by_mc_24m_wi-tot_paid_by_mc_12m_wi

foreach x in 12m 24m 2nd_yr {
	gen pct_tot_paid_by_mc_`x'_wi=.
}


levelsof core_year, local(levels)

foreach l of local levels {
	foreach x in 12m 24m 2nd_yr {
		sort tot_paid_by_mc_`x'_wi
		xtile p`x'=tot_paid_by_mc_`x'_wi if core_year==`l', nq(100)
		replace pct_tot_paid_by_mc_`x'_wi=p`x' if core_year==`l' & core_year<2011
		drop p`x'
}
}
/*
*keeping this code in case decide it's better to get the overall
xtile pct_tot_paid_by_mc_12m=tot_paid_by_mc_wi_12m_wi if c_ivw_year<2011, nq(100)
xtile pct_tot_paid_by_mc_24m=tot_paid_by_mc_24m_wi if c_ivw_year<2011, nq(100)
*/

gen criteria=0
replace criteria=1 if criteria_a==1
replace criteria=2 if criteria_a==1 & criteria_smi==0
replace criteria=3 if criteria_a==1 & criteria_smi==1 & adl_index>0
replace criteria=4 if criteria_b==1
replace criteria=5 if criteria_b==1 & criteria_smi==0
replace criteria=6 if criteria_c==1

label define crit 0 "Does not meet" 1 "SMI only" 2 "Function only" 3 "Both" 4 "SMI and Util" 5 "Function and Util" 6 "Criteria C"
label values criteria crit

gen critgroup=0 
replace critgroup=1 if criteria_a==1
replace critgroup=2 if criteria_b==1
replace critgroup=3 if criteria_c==1

label define critgroup 0 "Does not meet" 1 "Criteria A only" 2 "B not C" 3 "Criteria C"
label values critgroup critgroup

foreach x in a b c {
	by id, sort: egen first_meet_crit_`x'=min(core_year) if criteria_`x'==1
	replace first_meet_crit_`x'=first_meet_crit_`x'==core_year
}

gen ivw_first_meet=.
replace ivw_first_meet=1 if first_meet_crit_a==1 & criteria==1
replace ivw_first_meet=2 if first_meet_crit_a==1 & criteria==2
replace ivw_first_meet=3 if first_meet_crit_a==1 & criteria==3
replace ivw_first_meet=4 if first_meet_crit_b==1 & criteria==4
replace ivw_first_meet=5 if first_meet_crit_b==1 & criteria==5
replace ivw_first_meet=6 if first_meet_crit_c==1
 
saveold "E:\data\serious_ill\int_data\ivws_crit_1.dta", replace



/*import full dataset back to sas*/
proc import datafile="E:\data\serious_ill\int_data\ivws_crit_1.dta" 
out=sic_int.ivws_crit_1 replace;
run;


H="Looking at outcomes"
*********************************
//6/19/14 update - addtional table added to show a limited set of outcomes
//the first time R meets each of several combinations of the criteria components
*********************************

capture log close

clear all
set more off

local logpath E:\data\serious_ill\logs
local datapath E:\data\serious_ill\int_data

log using "`logpath'\4-sic_initial_outcomes_1.txt", text replace

cd `datapath'

//use dataset with outcomes, just obs that meet interview sample inclusion criteria
use ivws_crit_1.dta if inlist(core_year,2000,2002,2004,2006,2008,2010) & /// 
age_ge_65==1 & xwalk_yes==1 & part_ab_12m==1 & hmo_d_12m==0
*******************************************************************
//Table comparing outcomes for those with serious illness only, 
//adl impairment only, illness and adl impairment categories

//for n=47 observations where wage index is missing, it has been set to 1
//for the purposes of adjusting the medicare spending totals
sum core_year
sum core_year if wage_index_2012_2==.
tab wage_index_missing_yes, missing

//categorical variable for serious illness vs adl impairment
gen cat_smi_adl=.
replace cat_smi_adl=1 if ser_med_illness==0 & adl_impair_core==0
replace cat_smi_adl=2 if ser_med_illness==1 & adl_impair_core==0
replace cat_smi_adl=3 if ser_med_illness==0 & adl_impair_core==1
replace cat_smi_adl=4 if smi_and_adl==1
la var cat_smi_adl "Serious illness and/or adl impariment, categorical"
la def cat_smi_adl 1 "No serious illness or adl impairment" ///
2 "Serious medical illness but no adl impair" 3 "ADL impairment, no serious medical ill" ///
4 "Serious medical illness and adl impairment"
la val cat_smi_adl cat_smi_adl
tab cat_smi_adl core_year
tab cat_smi_adl ser_med_illness
tab cat_smi_adl adl_impair_core

//table of outcomes, interview level (so R may be represented 5x)
local outcome1 core_to_dod_1yr hs_admit_p12m ind_em_ur_adm_p12m

local outcome2 ip_paid_by_mc_12m_wi snf_paid_by_mc_12m_wi hh_paid_by_mc_12m_wi hs_paid_by_mc_12m_wi ///
pb_paid_by_mc_12m_wi op_paid_by_mc_12m_wi dm_paid_by_mc_12m_wi tot_paid_by_mc_12m_wi n_hospd_p12m

mat table1=J(34,4,.)
//first row, n for each category
tab cat_smi_adl,matcell(row1)
mat table1[1,1]=row1[1,1]
mat table1[1,2]=row1[2,1]
mat table1[1,3]=row1[3,1]
mat table1[1,4]=row1[4,1]

forvalues i=1/4{
local r=2
foreach v in `outcome1'{
	sum `v' if cat_smi_adl==`i', detail
	mat table1[`r',`i']=r(mean)
	mat table1[`r'+1,`i']=r(sd)
	local r=`r'+2 //populates rows 2-7 for indicator variable outcomes
	}

local r=8
foreach v in `outcome2'{
	sum `v' if cat_smi_adl==`i', detail
	mat table1[`r',`i']=r(mean)
	mat table1[`r'+1,`i']=r(p50)
	mat table1[`r'+2,`i']=r(sd)
	local r=`r'+3 //populates rows 8-34 for continuous variables
	}
}

mat rownames table1="N" "Died, mean" "SD" "Hospice enr, mean" "SD" "Emerg or urgent hosp admit, mean" "SD" ///
"IP Medicare payments, mean" "Median" "SD" "SNF Medicare payments, mean" "Median" "SD" ///
"HH Medicare payments, mean" "Median" "SD" "Hospice Medicare payments, mean" "Median" "SD" ///
"Carrier Medicare payments, mean" "Median" "SD" "OP Medicare payments, mean" "Median" "SD" ///
"DME Medicare payments, mean" "Median" "SD" "Total Medicare payments, mean" "Median" "SD" ///
"Hospital nights, mean" "Median" "SD"

mat colnames table1="No ser med ill or impair" "Ser Med Ill" "ADL Impair" "SMI and ADL Impair"

frmttable using "`logpath'\sic_Table3_outcomes", statmat(table1) ///
title("Comparison of outcomes at 1 year, serious medical illness vs ADL impairment" \ ///
"Interview level") ///
note("Medicare spending values are adjusted to 2010$ and for the CMS wage index.") ///
sdec(0\2\2\2\2\2\2\0) landscape replace

*******************************************************************
//Outcomes for first interview where meet criteria
*******************************************************************
mat table2=J(34,3,.)
//first row, n for each category
tab ivw_meet_crit_a ,matcell(row1a)
mat table2[1,1]=row1a[2,1]
tab ivw_meet_crit_b ,matcell(row1b)
mat table2[1,2]=row1b[2,1]
tab ivw_meet_crit_c ,matcell(row1c)
mat table2[1,3]=row1c[2,1]

local c=1
foreach crit of varlist ivw_meet_crit_a ivw_meet_crit_b ivw_meet_crit_c {
local r=2
foreach v in `outcome1'{
	sum `v' if `crit'==1, detail
	mat table2[`r',`c']=r(mean)
	mat table2[`r'+1,`c']=r(sd)
	local r=`r'+2 //populates rows 2-7 for indicator variable outcomes
	}

local r=8
foreach v in `outcome2'{
	sum `v' if `crit'==1, detail
	mat table2[`r',`c']=r(mean)
	mat table2[`r'+1,`c']=r(p50)
	mat table2[`r'+2,`c']=r(sd)
	local r=`r'+3 //populates rows 8-34 for continuous variables
	}
local c=`c'+1	
}

mat rownames table2="N" "Died, mean" "SD" "Hospice enr, mean" "SD" "Emerg or urgent hosp admit, mean" "SD" ///
"IP Medicare payments, mean" "Median" "SD" "SNF Medicare payments, mean" "Median" "SD" ///
"HH Medicare payments, mean" "Median" "SD" "Hospice Medicare payments, mean" "Median" "SD" ///
"Carrier Medicare payments, mean" "Median" "SD" "OP Medicare payments, mean" "Median" "SD" ///
"DME Medicare payments, mean" "Median" "SD" "Total Medicare payments, mean" "Median" "SD" ///
"Hospital nights, mean" "Median" "SD"

frmttable using "`logpath'\sic_Table3_outcomes_ivw", statmat(table2) ///
title("Comparison of outcomes at 1 year, criteria a vs b" \ ///
"First interview when R meets criteria") ///
ctitle("" "Criteria A" "Criteria B" "Criteria C" \ "" "Serious med illness and/or" ///
"SMI and/or ADL impair and" "SMI and ADL impair and" ///
\ "" "ADL impairment" "SNF and/or Hospital use" "SNF and/or Hospital use") ///
note("Medicare spending values are adjusted to 2010$ and for the CMS wage index.") ///
sdec(0\2\2\2\2\2\2\0) replace 

*******************************************************************
//Select Outcomes for first interview where meet criteria
//Criteria comparison
*******************************************************************
//table of outcomes, interview where R first meets criteria
local outcome1 core_to_dod_1yr hs_admit_p12m ind_em_ur_adm_p12m ip_paid_by_mc_12m_wi ///
tot_paid_by_mc_12m_wi

local compvars ivw_meet_crit_smi ivw_meet_crit_adl ivw_meet_crit_smiadl ivw_meet_crit_a ///
ivw_meet_crit_smiadlnh ivw_meet_crit_smiadlho ivw_meet_crit_smiadlhonh ///
ivw_meet_crit_c ivw_meet_crit_aho ivw_meet_crit_b 

//overall sample, n interviews
sum core_year
local nsamp=r(N)

mat comp_N_c1=J(10,3,.)
mat comp=J(10,15,.)

//first column, get n for each subgroup
local r=1
foreach comp in `compvars'{
	sum core_year if `comp'==1, detail
	mat comp_N_c1[`r',1]=r(N)
	local r=`r'+1
}

local c=1
foreach var in `outcome1'{
	local r=1
	foreach comp in `compvars'{
		sum `var' if `comp'==1, detail
		mat comp[`r',`c']=r(mean)
		mat comp[`r',`c'+1]=r(sd)
		mat comp[`r',`c'+2]=r(p50)
		local r=`r'+1
	}
local c=`c'+3
}
mat rownames comp_N_c1="Serious med illness" "ADL Impairment"  ///
 "Illness + ADL Impair" "Criteria A" "Illness + ADL + NH(no hosp)" "Illness + ADL + Hospital(no NH)" ///
 "Illness + ADL + NH + Hospital" "Ill + ADL + (Hospital and/or NH)" "Ill and-or ADL + Hospital(no NH)" ///
 "Criteria B"

mat rownames comp="Serious med illness" "ADL Impairment"  ///
"Illness + ADL Impair" "Criteria A" "Illness + ADL + NH(no hosp)" "Illness + ADL + Hospital(no NH)" ///
 "Illness + ADL + NH + Hospital" "Ill + ADL + (Hospital and/or NH)" "Ill and-or ADL + Hospital(no NH)" ///
 "Criteria B"

frmttable , statmat(comp_N_c1) substat(2) ///
title("Comparison of serious medical conditions, outcomes at 1 year" \ ///
"First interview where R meets the criteria") ///
ctitles("","N" ) ///
sdec(0) store(table3)

frmttable using "`logpath'\sic_Table3_outcomes_ivw", statmat(comp)  substat(2) ///
ctitles("","Died","Hospice admit","Hospital admit","IP Medicare","Total Medicare" \ ///
"","mean","","","","" \ "","(SD)", "","","","", \ "","[Median]","","","","" ) ///
note("Medicare spending values are adjusted to 2010$ and for the CMS wage index.") ///
sdec(2) merge(table3) addtable
*************************************************************
//look at comparison between criteria b with nursing home and/or hospitalization
//and just requiring hospitalization, is there much of a difference?
tab ivw_meet_crit_aho ivw_meet_crit_b, missing

*************************************************************


log close


H="Looking at Rs that never meet criteria a b or c"
data do_not_meet;
set sic_int.ivws_crit_1;
if ind_no_crit=1;
run;

ods rtf body="E:\data\serious_ill\logs\comparison_group.rtf";

title "Core interview years for those R's that never meet Criteria A B or C";
proc freq; table core_year; run;

/*get number of interviews per R
n=6169 R's that never meet criteria with at least 1 core interview, ffs mc 1 year before that ivw*/
proc sql;
create table do_not_meet_2 as select distinct id,
count(*) as ivw_count 
from do_not_meet group by id;
quit;

/*range from having 1-6 core interviews in the dataset*/
title"Number of core interviews, n=6169 R's that never meet criteria";
proc freq; table ivw_count; run;

/*what are the last core years we have represented for this group?*/
proc sort data=do_not_meet; by id core_year; run;

data last;
set do_not_meet;
by id;
if last.id;
run;

title "Year of last recorded core interview";
proc freq; table core_year; run;

ods rtf close;

H="Step 10 - Core interviews - set up from time 0=meet criteria"
/*From this point on, there are 3 datasets, one for those that
meet Criteria A) Serious medical illness and one for those that 
meet Criteria B) (Serious medical illness or ADL Impairment) and (nursing
home use or urgent/emergent hospital admission)
meet Criteria C) Serious medical illness and ADL Impairment and (nursing
home use and/or urgent/emergent hospital admission)

Datasets are saved as:
sic_fin.n0_n1_p1_p2_criteria_a
sic_fin.n0_n1_p1_p2_criteria_b
sic_fin.n0_n1_p1_p2_criteria_c

Contain the following interviews as denoted by variable suffix:
_n0 - when first meet criteria
_n1 - interview prior to first meeting criteria
_p1 and _p2 - 2 interviews after meeting criteria
*/


*****************************************************;
*rename macro *;
*****************************************************;
%macro rename(lib,dsn,pre);
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "Before Renaming All Variables";
run;

proc sql noprint;
select nvar into :num_vars
from dictionary.tables
where libname="&LIB" and
memname="&DSN";
select distinct(name) into :var1-
:var%TRIM(%LEFT(&num_vars))
from dictionary.columns
where libname="&LIB" and
memname="&DSN";
quit;
run;

proc datasets library=&LIB;
modify &DSN;
rename
%do i=1 %to &num_vars;
&&var&i=&&var&i.._&pre 
%end;
;
quit;
run;
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "After Renaming All Variables";
run;
%mend rename;


****************************************************************;
/*set up datasets with reference time 0 = time initially meet criteria
time =0 has n0 suffix
interviews before have n1, n2, etc suffix
interviews after have p1, p2 suffix */
****************************************************************;

*drop variables from interview dataset that we don't need for the n1, p1, etc datasets;
*these are variables from the restricted dataset;
data core_to_use;
set sic_int.ivws_crit_1(drop=birth_date death_date white black hisp_eth native_amer 
asian_pi other_race other_na_api_race wage_index_2012
zip_0: zip_10: zip_12: zip_98: first_ivw_year last_ivw_year restr_yes dod_claims cause_death_12_n);
run;

data core_all_drop;
set sic_int.core_ids_1yr_criteria_6(drop=birth_date death_date white black hisp_eth native_amer 
asian_pi other_race other_na_api_race wage_index_2012 
zip_0: zip_10: zip_12: zip_98: first_ivw_year last_ivw_year restr_yes dod_claims cause_death_12_n);
rename Hospital_care_intensity_index__s=hospital_care_intensity;
run;

*note interview counts listed are for criteria a dataset, they are different for criteria b,c;
%macro ds_restr(crit=);

*get ids, first time they met criteria;
data n0_&crit._1;
set sic_int.ivws_crit_1;
if ivw_meet_crit_&crit.=1;
run;

data TEST;
set n0_&crit._1(drop=zip_0: zip_10: zip_12: zip_98:);
run;

*add _n0 suffix for interview variables for year that first meets criteria;
%rename(WORK,TEST,n0);

data n0_&crit._3;
set TEST;
rename id_n0=id;
rename bid_hrs_n0=bid_hrs;
run;

****************************************************************;
*get n1 interview, interiew prior to meeting criteria*;
*list of 6786 core interviews with ffs medicare 1 year prior before meeting the criteria*;
proc sql;
create table all_ivw_bef_meet_&crit.
as select b.*
 from n0_&crit._3 a 
 inner join
core_to_use b
  on a.id=b.id and a.c_ivw_date_n0>b.c_ivw_date;
  quit;

proc sort data=all_ivw_bef_meet_&crit. ;
by id c_ivw_date;
run;

*keep only the n1 core interview;
*3000 interviews identified that have ffs medicare 1 year prior to n1 interview;
data core_n1_&crit.;
set all_ivw_bef_meet_&crit.;
by id c_ivw_date;
if last.id;
run;

proc freq;
table core_year;
run;

*supplement the list with interviews with no or unknown ffs medicare 1 year;
*prior to interview in order to fill in for those with interviews in 2000;
proc sql;
create table noffsreq_ivw_bef_meet_&crit.
as select b.*
 from n0_&crit._3 a 
 inner join
core_all_drop b
  on a.id=b.id and a.c_ivw_date_n0>b.c_ivw_date;
  quit;

*7158 of the ivws are not in the list that already have the n1 ivw;
proc sql;
create table noffsreq_ivw_bef_meet_&crit._1 as select * from
noffsreq_ivw_bef_meet_&crit.
where id not in (select id from core_n1_&crit.);
quit;

proc sort data=noffsreq_ivw_bef_meet_&crit._1 ;
by id c_ivw_date;
run;

*keep only the n1 core interview;
*2723 interviews identified;
data noffsreq_core_n1_&crit.;
set noffsreq_ivw_bef_meet_&crit._1;
by id c_ivw_date;
if last.id;
run;

*append to get full list of 5723 n1 interviews;
data core_n1_&crit._1;
set core_n1_&crit. noffsreq_core_n1_&crit.;
run;

proc sort data=core_n1_&crit._1 nodupkey;
by id;
run;

*check on number of pre interviews present in the dataset;
*for those that meet the criteria;
proc sql;
create table ivw_count_before_&crit. as select distinct id,
count(*) as n_ivws_bef_&crit. label="n ivws before meet criteria &crit."
from 
all_ivw_bef_meet_&crit.  group by id;
quit;

proc freq; table n_ivws_bef_&crit.;
run;

****************************************************************;
*get p1 interview, interview after meeting criteria*;
*list of all core interviews after meeting the criteria*;
proc sql;
create table all_ivw_aft_meet_&crit.
as select b.*
 from n0_&crit._3 a 
 inner join
core_to_use b
  on a.id=b.id and a.c_ivw_date_n0<b.c_ivw_date;
  quit;

proc sort data=all_ivw_aft_meet_&crit. ;
by id c_ivw_date;
run;

*keep only the p1 core interview;
*3681 interviews identified;
data core_p1_&crit.;
set all_ivw_aft_meet_&crit.;
by id c_ivw_date;
if first.id;
run;

proc freq;
table core_year;
run;

*supplement the list with interviews with no or unknown ffs medicare 1 year;
*prior to interview in order to fill in missing p1 ivws;
proc sql;
create table noffsreq_ivw_aft_meet_&crit.
as select b.*
 from n0_&crit._3 a 
 inner join
core_all_drop b
  on a.id=b.id and a.c_ivw_date_n0<b.c_ivw_date;
  quit;

*413 of the ivws are not in the list that already have the p1 ivw;
proc sql;
create table noffsreq_ivw_aft_meet_&crit._1 as select * from
noffsreq_ivw_aft_meet_&crit.
where id not in (select id from core_p1_&crit.);
quit;

proc sort data=noffsreq_ivw_aft_meet_&crit._1 ;
by id c_ivw_date;
run;

*keep only the p1 core interview;
*225 interviews identified;
data noffsreq_core_p1_&crit.;
set noffsreq_ivw_aft_meet_&crit._1;
by id c_ivw_date;
if first.id;
run;

*append to get full list of 3906 p1 interviews;
data core_p1_&crit._1;
set core_p1_&crit. noffsreq_core_p1_&crit.;
run;

proc sort data=core_p1_&crit._1 nodupkey;
by id;
run;

*check on number of post-interviews present in the dataset;
*for those that meet the criteria;
proc sql;
create table ivw_count_after_&crit. as select distinct id,
count(*) as n_ivws_after_&crit. label="n ivws after meet criteria &crit."
from 
all_ivw_aft_meet_&crit.  group by id;
quit;

proc freq; table n_ivws_after_&crit.;
run;


****************************************************************;
*get p2 interview, interview after meeting criteria*;
*list of all core interviews after the p1 interview*;
proc sql;
create table all2_ivw_aft_meet_&crit.
as select b.*
 from core_p1_&crit. a 
 inner join
core_to_use b
  on a.id=b.id and a.c_ivw_date<b.c_ivw_date;
  quit;

proc sort data=all2_ivw_aft_meet_&crit. ;
by id c_ivw_date;
run;

*keep only the p2 core interview;
*2078 interviews identified;
data core_p2_&crit.;
set all2_ivw_aft_meet_&crit.;
by id c_ivw_date;
if first.id;
run;

proc freq;
table core_year;
run;

*rename the n1, p1 and p2 interviews*;

*n1 interview;
data TEST;
set core_n1_&crit._1 ;
run;

%rename(WORK,TEST,n1);
data core_n1_&crit._1;
set TEST;
rename id_n1=id;
rename bid_hrs_n1=bid_hrs;
run;

*p1 interview;
data TEST;
set CORE_P1_&crit._1;
run;
%rename(WORK,TEST,p1);
data core_p1_&crit._1;
set TEST;
rename id_p1=id;
rename bid_hrs_p1=bid_hrs;
run;

*p2 interview;
data TEST;
set CORE_P2_&crit.;
run;

%rename(WORK,TEST,p2);
data core_p2_&crit._1;
set TEST;
rename id_p2=id;
rename bid_hrs_p2=bid_hrs;
run;

*merge the datasets together*;
proc sort data=n0_&crit._3 nodupkey;
by id;
run;

proc sort data=core_n1_&crit._1 nodupkey;
by id;
run;

proc sort data=core_p1_&crit._1 nodupkey;
by id;
run;

proc sort data=core_p2_&crit._1 nodupkey;
by id;
run;

data sic_fin.n0_n1_p1_p2_criteria_&crit.;
merge n0_&crit._3 core_n1_&crit._1 core_p1_&crit._1 core_p2_&crit._1;
by id;
run;

%mend ds_restr;

%ds_restr(crit=a);
%ds_restr(crit=b);
%ds_restr(crit=c);
%ds_restr(crit=smi); 


proc freq data=sic_fin.n0_n1_p1_p2_criteria_a;
table core_year_n1 core_year_n0 core_year_p1 core_year_p2;
run;

proc freq data=sic_fin.n0_n1_p1_p2_criteria_b;
table core_year_n1 core_year_n0 core_year_p1 core_year_p2;
run;

proc freq data=sic_fin.n0_n1_p1_p2_criteria_c;
table core_year_n1 core_year_n0 core_year_p1 core_year_p2;
run;

proc freq data=sic_fin.n0_n1_p1_p2_criteria_smi;
table core_year_n1 core_year_n0 core_year_p1 core_year_p2;
run;


*************************************************************;
** Looking at who has missing n1 core interviews  ***********;
*************************************************************;
proc freq data=sic_fin.n0_n1_p1_p2_criteria_a;
table part_ab_12m_n1*hmo_d_12m_n1 part_ab_6m_n1*hmo_d_6m_n1 /missprint;
run;

data no_n1_core_1;
set sic_fin.n0_n1_p1_p2_criteria_a;
if core_year_n1=.;
run;

proc freq;
table core_year_n0 first_ivw_year_n0;
run;

*************************************************************;
** Looking at who has missing p1 core interviews  ***********;
*************************************************************;
data no_p1_core_1;
set sic_fin.n0_n1_p1_p2_criteria_a;
if core_year_p1=. & core_year_n0<2012;
if core_to_death_n0<=2 then core_to_dod_2yr_n0=1;
else core_to_dod_2yr_n0=0;
run;

/*46% died within 1 year of meeting criteria interview*/
proc freq;
table core_year_n0 first_ivw_year_n0 core_to_dod_1yr_n0 core_to_dod_2yr_n0;
run;

/*look at those that didn't die within 2 years n=112*/
data no_p1_core_2;
set no_p1_core_1;
if core_to_dod_2yr_n0=0;
run;

/*n=70 died within 2.5 years, can't be sure about remaining
next thing to do is to check exit interviews*/
proc freq; table core_to_death_n0 core_to_death_n0*core_year_n0 ; run;

/*why missing insurance status of 47 obs in p1 interview for criteria a dataset?
All interviewed in 2013 for p1, we don't have denominator file that year*/
data miss_ins_a_1;
set noffsreq_core_p1_a;
if part_ab_12m=.;
run;

proc freq;
table  core_year c_ivw_year;
run;



H="Step 10a - Get 2008 interview dataset set up"
/*Creates additional dataset that is 2008 core interviews, with

Dataset saved as:
sic_fin.n0_n1_p1_p2_criteria_2008

Contain the following interviews as denoted by variable suffix:
_n0 - 2008
_n1 - interview prior to 2008
_p1 - 2012 interview
*/

*****************************************************;
*rename macro *;
*****************************************************;
%macro rename(lib,dsn,pre);
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "Before Renaming All Variables";
run;

proc sql noprint;
select nvar into :num_vars
from dictionary.tables
where libname="&LIB" and
memname="&DSN";
select distinct(name) into :var1-
:var%TRIM(%LEFT(&num_vars))
from dictionary.columns
where libname="&LIB" and
memname="&DSN";
quit;
run;

proc datasets library=&LIB;
modify &DSN;
rename
%do i=1 %to &num_vars;
&&var&i=&&var&i.._&pre 
%end;
;
quit;
run;
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "After Renaming All Variables";
run;
%mend rename;


****************************************************************;
/*set up dataset with reference time 0 = 2008 core
time =0 has n0 suffix
interviews before have n1, n2, etc suffix
interviews after have p1, p2 suffix */
****************************************************************;

*drop variables from interview dataset that we don't need for the n1, p1, etc datasets;
*these are variables from the restricted dataset;
data core_to_use;
set sic_int.ivws_crit_1(drop=birth_date death_date white black hisp_eth native_amer 
asian_pi other_race other_na_api_race gender degree wage_index_2012
zip_0: zip_10: zip_12: zip_98: first_ivw_year last_ivw_year restr_yes dod_claims cause_death_12_n);
run;

data core_all_drop;
set sic_int.core_ids_1yr_criteria_6(drop=birth_date death_date white black hisp_eth native_amer 
asian_pi other_race other_na_api_race  gender degree wage_index_2012 
zip_0: zip_10: zip_12: zip_98: first_ivw_year last_ivw_year restr_yes dod_claims cause_death_12_n);
rename Hospital_care_intensity_index__s=hospital_care_intensity;
run;

*get ids, 2008 core interviews, n=6011;
data n0_2008_1;
set sic_int.ivws_crit_1;
if core_year=2008;
run;

%macro ds_restr(crit=);

data TEST;
set n0_&crit._1(drop=zip_0: zip_10: zip_12: zip_98:);
run;

*add _n0 suffix for interview variables for year that first meets criteria;
%rename(WORK,TEST,n0);

data n0_&crit._3;
set TEST;
rename id_n0=id;
rename bid_hrs_n0=bid_hrs;
run;

****************************************************************;
*get n1 interview, interiew prior to meeting criteria*;
*list of 16630 core interviews with ffs medicare 1 year prior before meeting the criteria*;
proc sql;
create table all_ivw_bef_meet_&crit.
as select b.*
 from n0_&crit._3 a 
 inner join
core_to_use b
  on a.id=b.id and a.c_ivw_date_n0>b.c_ivw_date;
  quit;

proc sort data=all_ivw_bef_meet_&crit. ;
by id c_ivw_date;
run;

*keep only the n1 core interview;
*5357 interviews identified that have ffs medicare 1 year prior to n1 interview;
data core_n1_&crit.;
set all_ivw_bef_meet_&crit.;
by id c_ivw_date;
if last.id;
run;

proc freq;
table core_year;
run;

*supplement the list with interviews with no or unknown ffs medicare 1 year;
*prior to interview in order to fill in for those with interviews in 2000;
proc sql;
create table noffsreq_ivw_bef_meet_&crit.
as select b.*
 from n0_&crit._3 a 
 inner join
core_all_drop b
  on a.id=b.id and a.c_ivw_date_n0>b.c_ivw_date;
  quit;

*3316 of the ivws are not in the list that already have the n1 ivw;
proc sql;
create table noffsreq_ivw_bef_meet_&crit._1 as select * from
noffsreq_ivw_bef_meet_&crit.
where id not in (select id from core_n1_&crit.);
quit;

proc sort data=noffsreq_ivw_bef_meet_&crit._1 ;
by id c_ivw_date;
run;

*keep only the n1 core interview;
*601 interviews identified;
data noffsreq_core_n1_&crit.;
set noffsreq_ivw_bef_meet_&crit._1;
by id c_ivw_date;
if last.id;
run;

*append to get full list of 5958 n1 interviews;
data core_n1_&crit._1;
set core_n1_&crit. noffsreq_core_n1_&crit.;
run;

proc sort data=core_n1_&crit._1 nodupkey;
by id;
run;

*check on number of pre interviews present in the dataset;
*for those that meet the criteria;
proc sql;
create table ivw_count_before_&crit. as select distinct id,
count(*) as n_ivws_bef_&crit. label="n ivws before meet criteria &crit."
from 
all_ivw_bef_meet_&crit.  group by id;
quit;

proc freq; table n_ivws_bef_&crit.;
run;


****************************************************************;
*get p1 interview, interview after meeting criteria*;
*list of all core interviews after meeting the criteria*;
proc sql;
create table all_ivw_aft_meet_&crit.
as select b.*
 from n0_&crit._3 a 
 inner join
core_to_use b
  on a.id=b.id and a.c_ivw_date_n0<b.c_ivw_date;
  quit;

proc sort data=all_ivw_aft_meet_&crit. ;
by id c_ivw_date;
run;

*keep only the p1 core interview;
*4684 interviews identified;
data core_p1_&crit.;
set all_ivw_aft_meet_&crit.;
by id c_ivw_date;
if first.id;
run;

proc freq;
table core_year;
run;

*supplement the list with interviews with no or unknown ffs medicare 1 year;
*prior to interview in order to fill in missing p1 ivws;
proc sql;
create table noffsreq_ivw_aft_meet_&crit.
as select b.*
 from n0_&crit._3 a 
 inner join
core_all_drop b
  on a.id=b.id and a.c_ivw_date_n0<b.c_ivw_date;
  quit;

*487 of the ivws are not in the list that already have the p1 ivw;
proc sql;
create table noffsreq_ivw_aft_meet_&crit._1 as select * from
noffsreq_ivw_aft_meet_&crit.
where id not in (select id from core_p1_&crit.);
quit;

proc sort data=noffsreq_ivw_aft_meet_&crit._1 ;
by id c_ivw_date;
run;

*keep only the p1 core interview;
*487 interviews identified;
data noffsreq_core_p1_&crit.;
set noffsreq_ivw_aft_meet_&crit._1;
by id c_ivw_date;
if first.id;
run;

*append to get full list of 5171 p1 interviews;
data core_p1_&crit._1;
set core_p1_&crit. noffsreq_core_p1_&crit.;
run;

proc sort data=core_p1_&crit._1 nodupkey;
by id;
run;

*check on number of post-interviews present in the dataset;
*for those that meet the criteria;
proc sql;
create table ivw_count_after_&crit. as select distinct id,
count(*) as n_ivws_after_&crit. label="n ivws after meet criteria &crit."
from 
all_ivw_aft_meet_&crit.  group by id;
quit;

proc freq; table n_ivws_after_&crit.;
run;


*rename the n1, p1 interviews*;

*n1 interview;
data TEST;
set core_n1_&crit._1 ;
run;

%rename(WORK,TEST,n1);
data core_n1_&crit._1;
set TEST;
rename id_n1=id;
rename bid_hrs_n1=bid_hrs;
run;

*p1 interview;
data TEST;
set CORE_P1_&crit._1;
run;
%rename(WORK,TEST,p1);
data core_p1_&crit._1;
set TEST;
rename id_p1=id;
rename bid_hrs_p1=bid_hrs;
run;


*merge the datasets together*;
proc sort data=n0_&crit._3 nodupkey;
by id;
run;

proc sort data=core_n1_&crit._1 nodupkey;
by id;
run;

proc sort data=core_p1_&crit._1 nodupkey;
by id;
run;

data sic_fin.n0_n1_p1_p2_criteria_&crit.;
merge n0_&crit._3 core_n1_&crit._1 core_p1_&crit._1 ;
by id;
run;

%mend ds_restr;

%ds_restr(crit=2008);

proc freq data=sic_fin.n0_n1_p1_p2_criteria_2008;
table core_year_n1 core_year_n0 core_year_p1 ;
run;

*************************************************************;
** Looking at who has missing n1 core interviews  ***********;
*************************************************************;
proc freq data=sic_fin.n0_n1_p1_p2_criteria_2008;
table part_ab_12m_n1*hmo_d_12m_n1 part_ab_6m_n1*hmo_d_6m_n1 /missprint;
run;

data no_n1_core_1;
set sic_fin.n0_n1_p1_p2_criteria_2008;
if core_year_n1=.;
run;

proc freq;
table core_year_n0 first_ivw_year_n0;
run;

*************************************************************;
** Looking at who has missing p1 core interviews  ***********;
*************************************************************;
data no_p1_core_1;
set sic_fin.n0_n1_p1_p2_criteria_2008;
if core_year_p1=. & core_year_n0<2012;
if core_to_death_n0<=2 then core_to_dod_2yr_n0=1;
else core_to_dod_2yr_n0=0;
run;

/*38% died within 1 year of meeting criteria interview*/
proc freq;
table core_year_n0 first_ivw_year_n0 core_to_dod_1yr_n0 core_to_dod_2yr_n0;
run;

/*look at those that didn't die within 2 years n=19*/
data no_p1_core_2;
set no_p1_core_1;
if core_to_dod_2yr_n0=0;
run;

/*all died within 3 years of core*/
proc freq; table core_to_death_n0 core_to_death_n0*core_year_n0 ; run;

/*why missing insurance status of 217 obs in p1 interview for criteria a dataset?
All interviewed in 2013 for p1, we don't have denominator file that year*/
data miss_ins_2008_1;
set noffsreq_core_p1_2008;
if part_ab_12m=.;
run;

proc freq;
table c_ivw_year core_year;
run;



H="Step 10b - Get all comparison interviews set up (2002-2010)"
/*Creates additional dataset that is all core interviews, with

Dataset saved as:
sic_fin.n0_n1_p1_p2_criteria_2002_2010

Contain the following interviews as denoted by variable suffix:
_n0 - core year
_n1 - interview prior to core year n0
_p1 - interview after core year n0
*/

*****************************************************;
*rename macro *;
*****************************************************;
%macro rename(lib,dsn,pre);
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "Before Renaming All Variables";
run;

proc sql noprint;
select nvar into :num_vars
from dictionary.tables
where libname="&LIB" and
memname="&DSN";
select distinct(name) into :var1-
:var%TRIM(%LEFT(&num_vars))
from dictionary.columns
where libname="&LIB" and
memname="&DSN";
quit;
run;

proc datasets library=&LIB;
modify &DSN;
rename
%do i=1 %to &num_vars;
&&var&i=&&var&i.._&pre 
%end;
;
quit;
run;
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "After Renaming All Variables";
run;
%mend rename;


****************************************************************;
/*set up dataset with reference time 0 = 2008 core
time =0 has n0 suffix
interviews before have n1, n2, etc suffix
interviews after have p1, p2 suffix */
****************************************************************;

*drop variables from interview dataset that we don't need for the n1, p1, etc datasets;
*these are variables from the restricted dataset;
data core_to_use;
set sic_int.ivws_crit_1(drop=birth_date death_date white black hisp_eth native_amer 
asian_pi other_race other_na_api_race gender degree wage_index_2012
zip_0: zip_10: zip_12: zip_98: first_ivw_year last_ivw_year restr_yes dod_claims cause_death_12_n);
run;

data core_all_drop;
set sic_int.core_ids_1yr_criteria_6(drop=birth_date death_date white black hisp_eth native_amer 
asian_pi other_race other_na_api_race  gender degree wage_index_2012 
zip_0: zip_10: zip_12: zip_98: first_ivw_year last_ivw_year restr_yes dod_claims cause_death_12_n);
rename Hospital_care_intensity_index__s=hospital_care_intensity;
run;
%macro getyear(year=);
*get ids, 2010 core interviews, n=6011;
data n0_&year._1;
set sic_int.ivws_crit_1;
if core_year=&year;
run;
%mend getyear;

%getyear(year=2000);
%getyear(year=2002);
%getyear(year=2004);
%getyear(year=2006);
%getyear(year=2008);
%getyear(year=2010);

%macro ds_restr(crit=);

data TEST;
set n0_&crit._1(drop=zip_0: zip_10: zip_12: zip_98:);
run;

*add _n0 suffix for interview variables for year that first meets criteria;
%rename(WORK,TEST,n0);

data n0_&crit._3;
set TEST;
rename id_n0=id;
rename bid_hrs_n0=bid_hrs;
run;

****************************************************************;
*get n1 interview, interiew prior to meeting criteria*;
*list of 16630 core interviews with ffs medicare 1 year prior before meeting the criteria*;
proc sql;
create table all_ivw_bef_meet_&crit.
as select b.*
 from n0_&crit._3 a 
 inner join
core_to_use b
  on a.id=b.id and a.c_ivw_date_n0>b.c_ivw_date;
  quit;

proc sort data=all_ivw_bef_meet_&crit. ;
by id c_ivw_date;
run;

*keep only the n1 core interview;
*5357 interviews identified that have ffs medicare 1 year prior to n1 interview;
data core_n1_&crit.;
set all_ivw_bef_meet_&crit.;
by id c_ivw_date;
if last.id;
run;

proc freq;
table core_year;
run;

*supplement the list with interviews with no or unknown ffs medicare 1 year;
*prior to interview in order to fill in for those with interviews in 2000;
proc sql;
create table noffsreq_ivw_bef_meet_&crit.
as select b.*
 from n0_&crit._3 a 
 inner join
core_all_drop b
  on a.id=b.id and a.c_ivw_date_n0>b.c_ivw_date;
  quit;

*3316 of the ivws are not in the list that already have the n1 ivw;
proc sql;
create table noffsreq_ivw_bef_meet_&crit._1 as select * from
noffsreq_ivw_bef_meet_&crit.
where id not in (select id from core_n1_&crit.);
quit;

proc sort data=noffsreq_ivw_bef_meet_&crit._1 ;
by id c_ivw_date;
run;

*keep only the n1 core interview;
*601 interviews identified;
data noffsreq_core_n1_&crit.;
set noffsreq_ivw_bef_meet_&crit._1;
by id c_ivw_date;
if last.id;
run;

*append to get full list of 5958 n1 interviews;
data core_n1_&crit._1;
set core_n1_&crit. noffsreq_core_n1_&crit.;
run;

proc sort data=core_n1_&crit._1 nodupkey;
by id;
run;

*check on number of pre interviews present in the dataset;
*for those that meet the criteria;
proc sql;
create table ivw_count_before_&crit. as select distinct id,
count(*) as n_ivws_bef_&crit. label="n ivws before meet criteria &crit."
from 
all_ivw_bef_meet_&crit.  group by id;
quit;

proc freq; table n_ivws_bef_&crit.;
run;


****************************************************************;
*get p1 interview, interview after meeting criteria*;
*list of all core interviews after meeting the criteria*;
proc sql;
create table all_ivw_aft_meet_&crit.
as select b.*
 from n0_&crit._3 a 
 inner join
core_to_use b
  on a.id=b.id and a.c_ivw_date_n0<b.c_ivw_date;
  quit;

proc sort data=all_ivw_aft_meet_&crit. ;
by id c_ivw_date;
run;

*keep only the p1 core interview;
*4684 interviews identified;
data core_p1_&crit.;
set all_ivw_aft_meet_&crit.;
by id c_ivw_date;
if first.id;
run;

proc freq;
table core_year;
run;

*supplement the list with interviews with no or unknown ffs medicare 1 year;
*prior to interview in order to fill in missing p1 ivws;
proc sql;
create table noffsreq_ivw_aft_meet_&crit.
as select b.*
 from n0_&crit._3 a 
 inner join
core_all_drop b
  on a.id=b.id and a.c_ivw_date_n0<b.c_ivw_date;
  quit;

*487 of the ivws are not in the list that already have the p1 ivw;
proc sql;
create table noffsreq_ivw_aft_meet_&crit._1 as select * from
noffsreq_ivw_aft_meet_&crit.
where id not in (select id from core_p1_&crit.);
quit;

proc sort data=noffsreq_ivw_aft_meet_&crit._1 ;
by id c_ivw_date;
run;

*keep only the p1 core interview;
*487 interviews identified;
data noffsreq_core_p1_&crit.;
set noffsreq_ivw_aft_meet_&crit._1;
by id c_ivw_date;
if first.id;
run;

*append to get full list of 5171 p1 interviews;
data core_p1_&crit._1;
set core_p1_&crit. noffsreq_core_p1_&crit.;
run;

proc sort data=core_p1_&crit._1 nodupkey;
by id;
run;

*check on number of post-interviews present in the dataset;
*for those that meet the criteria;
proc sql;
create table ivw_count_after_&crit. as select distinct id,
count(*) as n_ivws_after_&crit. label="n ivws after meet criteria &crit."
from 
all_ivw_aft_meet_&crit.  group by id;
quit;

proc freq; table n_ivws_after_&crit.;
run;


*rename the n1, p1 interviews*;

*n1 interview;
data TEST;
set core_n1_&crit._1 ;
run;

%rename(WORK,TEST,n1);
data core_n1_&crit._1;
set TEST;
rename id_n1=id;
rename bid_hrs_n1=bid_hrs;
run;

*p1 interview;
data TEST;
set CORE_P1_&crit._1;
run;
%rename(WORK,TEST,p1);
data core_p1_&crit._1;
set TEST;
rename id_p1=id;
rename bid_hrs_p1=bid_hrs;
run;


*merge the datasets together*;
proc sort data=n0_&crit._3 nodupkey;
by id;
run;

proc sort data=core_n1_&crit._1 nodupkey;
by id;
run;

proc sort data=core_p1_&crit._1 nodupkey;
by id;
run;

data sic_fin.n0_n1_p1_p2_criteria_&crit.;
merge n0_&crit._3 core_n1_&crit._1 core_p1_&crit._1 ;
by id;
run;

%mend ds_restr;
%ds_restr(crit=2000);
%ds_restr(crit=2002);
%ds_restr(crit=2004);
%ds_restr(crit=2006);
%ds_restr(crit=2008);
%ds_restr(crit=2010);

data all;
set sic_fin.n0_n1_p1_p2_criteria_2000;
run;

proc append base=all data=sic_fin.n0_n1_p1_p2_criteria_2002; run;
proc append base=all data=sic_fin.n0_n1_p1_p2_criteria_2004; run;
proc append base=all data=sic_fin.n0_n1_p1_p2_criteria_2006; run;
proc append base=all data=sic_fin.n0_n1_p1_p2_criteria_2008; run;
proc append base=all data=sic_fin.n0_n1_p1_p2_criteria_2010; run;

data sic_fin.n0_n1_p1_p2_2002_2010;
set all;
run;

proc export data=sic_fin.n0_n1_p1_p2_2002_2010 outfile='E:\data\serious_ill\final_data\n0_n1_p1_p2_2002_2010.dta' replace; run;

H="Step 11 - Add exit interviews to dataset"
/*adds exit interview variables (with _x suffix) to the dataset that
is formatted with the n0 as time0 interview, etc.

Note for now, this just adds interview information, nothing pulled from claims
prior to death, may need to revisit this if we need outcomes prior to exit
interview*/


data exit;
set hrs_fnl.exit_02_to_12_dt;
run;

proc sort data=exit out=EXIT_1;
by id;
run;

*rename with _x suffix;
%rename(WORK,EXIT_1,x);
data exit_2;
set exit_1;
rename id_x=id;
run;

/*use macro to do for criteria a  b and c datasets*/

%macro exit(crit=);

/*keep for those R's that meet criteria at some time*/
proc sql;
create table exit_meet_&crit. as select * 
from exit_2 
where id in (select id from sic_fin.n0_n1_p1_p2_criteria_&crit.);
quit;

proc sort data=exit_meet_&crit. nodupkey; by id; run;
proc sort data=sic_fin.n0_n1_p1_p2_criteria_&crit. out=ivws nodupkey; by id; run;

proc sql;
create table n0_n1_p1_p2_x_criteria_&crit._1(drop=id2) as select *  
from ivws a left join
exit_meet_&crit.(rename=(id=id2)) b
on a.id=b.id2;
quit;

*data n0_n1_p1_p2_x_criteria_&crit._1;
*merge ivws exit_meet_&crit.;
*run;

proc freq; table exit_year_x; run;

data sic_fin.n0_n1_p1_p2_x_criteria_&crit.;
set n0_n1_p1_p2_x_criteria_&crit._1;
if exit_year_x-core_year_n0=2 then ind_exit_p1_yes=1;
else ind_exit_p1_yes=0;
if exit_year_x-core_year_n0=4 then ind_exit_p2_yes=1;
else ind_exit_p2_yes=0;
label ind_exit_p1_yes="Exit interview in wave following n0 ivw";
label ind_exit_p2_yes="Exit interview in wave following p1 ivw";
run;

proc freq; 
table ind_exit_p1_yes*core_year_p1 /*ind_exit_p2_yes*core_year_p2*/ /missprint; 
run;

%mend exit;

%exit(crit=a);
%exit(crit=b);
%exit(crit=c);
%exit(crit=2008);
%exit(crit=smi);

/*export to Stata for remaining processing*/
proc export data=sic_fin.n0_n1_p1_p2_x_criteria_a
outfile="E:\data\serious_ill\final_data\n0_n1_p1_p2_x_criteria_a.dta" replace;
run;

proc export data=sic_fin.n0_n1_p1_p2_x_criteria_b
outfile="E:\data\serious_ill\final_data\n0_n1_p1_p2_x_criteria_b.dta" replace;
run;

proc export data=sic_fin.n0_n1_p1_p2_x_criteria_c
outfile="E:\data\serious_ill\final_data\n0_n1_p1_p2_x_criteria_c.dta" replace;
run;

proc export data=sic_fin.n0_n1_p1_p2_x_criteria_2008
outfile="E:\data\serious_ill\final_data\n0_n1_p1_p2_x_criteria_2008.dta" replace;
run;

proc export data=sic_fin.n0_n1_p1_p2_x_criteria_smi
outfile="E:\data\serious_ill\final_data\n0_n1_p1_p2_x_criteria_smi.dta" replace;
run;

H="Step 12 - Create additional variables, changes between ivws"
/*switched to Stata
Data cleaning, create new variables
Code can be run on either criteria a, b or c datasets, comments indicate
sections to be modified when switching between them

When run this on the 2010 dataset, need to comment out sections relating to the
p2 interview since it isn't included in this dataset

4/2/15 - Added cleaning step for the dataset based on Medical Illness Only
*/

capture log close

clear all
set more off

//local crit smi
local crit a
//local crit b
//local crit c
//local crit 2010

local logpath E:\data\serious_ill\logs
local datapath E:\data\serious_ill\final_data

log using "`logpath'\4`crit'-sic_data_cleaning_crit_`crit'.txt", text replace

cd `datapath'

use n0_n1_p1_p2_x_criteria_`crit'.dta

tab core_year_n0, missing

*******************************************************************
//age when meet criteria
sum age_at_core_n0

gen age_cat_n0 = .
replace age_cat_n0 = 1 if age_at_core_n0<75
replace age_cat_n0 = 2 if age_at_core_n0>=75 & age_at_core_n0<85
replace age_cat_n0 = 3 if age_at_core_n0>=85 & age_at_core_n0!=.
la var age_cat_n0 "Age when meets criteria, categorical"
la def age_cat 1 "Age 65-74" 2 "Age 75-84" 3"Age 85+"
la val age_cat_n0 age_cat
tab age_cat_n0, missing

sum age_at_core_n0 if age_cat_n0 ==1
sum age_at_core_n0 if age_cat_n0 ==2
sum age_at_core_n0 if age_cat_n0 ==3

gen age_cat2_n0 = .
replace age_cat2_n0 = 1 if age_at_core_n0<70
replace age_cat2_n0 = 2 if age_at_core_n0>=70 & age_at_core_n0<75
replace age_cat2_n0 = 3 if age_at_core_n0>=75 & age_at_core_n0<80
replace age_cat2_n0 = 4 if age_at_core_n0>=80 & age_at_core_n0<85
replace age_cat2_n0 = 5 if age_at_core_n0>=85 & age_at_core_n0!=.
la var age_cat2_n0 "Age when meets criteria, categorical"
la def age_cat2 1 "Age 65-69" 2 "Age 70-74" 3 "Age 75-79" 4 "Age 80-84" 5"Age 85+"
la val age_cat2_n0 age_cat2
tab age_cat2_n0, missing

//female gender indicator variable
tab gender_n0 female_n0, missing //use tracker file to define new female indicator
drop female*
gen female = 1 if gender_n0==2
replace female = 0 if gender_n0==1
label var female "Female, 1=yes"
tab female, missing

//create race and ethnicity categorical variable
//may want to backfill from claims and check this variable!
tab white_n0, missing
tab black_n0, missing
tab hisp_eth_n0, missing
tab native_amer_n0, missing
tab asian_pi_n0, missing
tab other_race_n0, missing
tab other_na_api_race_n0, missing

gen re_cat = .
replace re_cat = 1 if black_n0==1
replace re_cat = 3 if white_n0==1
replace re_cat = 2 if hisp_eth_n0==1
replace re_cat = 4 if native_amer_n0==1 | asian_pi_n0==1 | other_race_n0==1
replace re_cat = 5 if re_cat==.
la var re_cat "Race & Ethnicity"
la def re_cat 1 "African American" 3 "White" 2 "Hispanic" 4 "Other" 5 "Unknown race" , replace
la val re_cat re_cat
tab re_cat, missing

gen re_black = 0
replace re_black=1 if re_cat==1
la var re_black "Race=black"

gen re_white = 0
replace re_white =1 if re_cat==3
la var re_white "Race=white"

gen re_hisp = 0
replace re_hisp =1 if re_cat==2
la var re_hisp "Hispanic Ethnicity"

gen re_other_unk = 0
replace re_other_unk =1 if inlist(re_cat,4,5)
la var re_other_unk "Race=other or unknown"

//education categorical variable
label define degree 0 "No degree" 1 "GED" 2 "High School" 3 "2yr college degree" ///
  4 "4yr College degree" 5 "Masters degree" 6"Professional degree" ///
  9 "degree unknown/some college", modify
label values degree_n0 degree 
label var degree_n0 "Eduction, Highest Level, from Tracker file"
tab degree_n0, missing

rename degree_n0 degree
//comment out for 2010
drop degree_n1 degree_p1 degree_p2

tab degree core_year_n0, missing

gen educ_level_lt_hs = 0 if degree!=.
replace educ_level_lt_hs = 1 if degree==0

gen educ_level_hs = 0 if degree!=.
replace educ_level_hs = 1 if inlist(degree,1,2)

gen educ_level_somcol = 0 if degree!=.
replace educ_level_somcol = 1 if inlist(degree,3,9)

gen educ_level_col = 0 if degree!=.
replace educ_level_col = 1 if inlist(degree,4,5,6)

la var educ_level_lt_hs "Education = less than high school"
la var educ_level_hs "Education = high school"
la var educ_level_somcol "Education = some college, no deg."
la var educ_level_col "Education = college deg. "

foreach v in educ_level_lt_hs educ_level_hs educ_level_somcol educ_level_col {
tab degree `v', missing
}

//create high school degree indicator variable
gen hs_deg_ind=.
replace hs_deg_ind=1 if degree>=1 & degree~=.
replace hs_deg_ind=0 if degree==0
la var hs_deg_ind "High school degree, 1=yes"
tab hs_deg_ind, missing
tab degree hs_deg_ind, missing

//self reported health status
tab srh_n0 srh_n1, missing

//marital status
tab married_n0 married_n1, missing
tab couple_n0, missing //tracker file variables to check
tab marst_n0, missing //too much missingness here because only started 2006

//bmi, use rand because more observations
sum bmi_rand_n0 bmi_n0, detail

gen bmi_lt25_n0=1 if bmi_rand_n0<25
replace bmi_lt25_n0=0 if bmi_rand_n0>=25
replace bmi_lt25_n0=. if bmi_rand_n0==.
la var bmi_lt25_n0 "BMI < 25 n0 ivw"
tab bmi_lt25_n0, missing

*******************************************************************
//fill in missing symptoms variables, only asked 1st interview and every other year
tab pain_hrs_n0, missing
tab dyspnea_hrs_n0 dyspnea_hrs_n1, missing

local sx_vars dyspnea_hrs_n depr_2_wks_hrs_n swelling_feet_hrs_n ///
dizzy_hrs_n back_pain_hrs_n headache_hrs_n cough_hrs_n 
foreach v in `sx_vars'{
	gen `v'0n1=`v'0
	replace `v'0n1=`v'1 if `v'0==. & `v'1~=.
	la var `v'0n1 "`v' from n0 or n1 ivw"
	tab `v'0n1, missing
	}

//set indicator for using n1 or n0 interview using the dyspnea variable
gen symptoms_ivw=0 if dyspnea_hrs_n0~=.
replace symptoms_ivw=1 if dyspnea_hrs_n0==. & dyspnea_hrs_n1~=.
la var symptoms_ivw "Symptoms from n1 interview"
la def symptoms_ivw 0 "n0 interview" 1 "n1 interview"
la val symptoms_ivw symptoms_ivw
tab symptoms_ivw, missing

//insomnia questions not asked before 2002 or if not 1st interview in 2008
local sx_insom insom_falling_asleep_n insom_waking_up_n ///
	insom_too_early_n insom_rested_n
foreach v in `sx_insom'{
	tab core_year_n0 `v'0, missing
	gen `v'0n1=`v'0
	replace `v'0n1=`v'1 if `v'0==. & `v'1~=. & core_year_n0==2008
	la var `v'0n1 "`v' from n0 or n1 ivw"
	tab `v'0n1, missing	
	}

gen insom_symptoms_ivw=0 if insom_falling_asleep_n0~=.
replace insom_symptoms_ivw=1 if insom_falling_asleep_n0==. & ///
	insom_falling_asleep_n1~=. & core_year_n0==2008
la var insom_symptoms_ivw "Insomnia Symptoms from n1 interview"
la val insom_symptoms_ivw symptoms_ivw
tab insom_symptoms_ivw, missing	

*******************************************************************
//Indicators death date from the HRS dataset (will check missing against claims dod later)
gen dod_ind=0
replace dod_ind=1 if  death_date_n0~=.
la var dod_ind "Death date present, 1=yes"
tab dod_ind

gen core_to_dod_2yr_n0=.
replace core_to_dod_2yr_n0=1 if core_to_death_n0<=2 & core_to_death_n0!=.
replace core_to_dod_2yr_n0=0 if core_to_death_n0>2 | core_to_death_n0==.
la var core_to_dod_2yr_n0 "Ind died within 2 years of core ivw"
tab core_to_dod_2yr_n0 core_to_dod_1yr_n0, missing

*******************************************************************
//Indicators for having each of the interviews
gen byte ind_n1_interview = .
replace ind_n1_interview=1 if core_year_n1!=.
replace ind_n1_interview=0 if core_year_n1==.
la var ind_n1_interview "R has n1 interview"
tab ind_n1_interview core_year_n0, missing

gen byte ind_p1_interview = .
replace ind_p1_interview=1 if core_year_p1!=.
replace ind_p1_interview=0 if core_year_p1==.
la var ind_p1_interview "R has p1 interview"
tab ind_p1_interview core_year_n0, missing
tab ind_p1_interview core_to_dod_1yr_n0, missing
tab ind_p1_interview core_to_dod_2yr_n0, missing

//comment out for 2010
gen byte ind_p2_interview = .
replace ind_p2_interview=1 if core_year_p2!=.
replace ind_p2_interview=0 if core_year_p2==.
la var ind_p2_interview "R has p2 interview"
tab ind_p2_interview core_year_n0, missing

gen byte ind_x_interview = .
replace ind_x_interview=1 if exit_year_x!=.
replace ind_x_interview=0 if exit_year_x==.
la var ind_x_interview "R has exit interview"
tab ind_x_interview core_year_n0, missing
tab ind_x_interview core_year_n0 if core_to_dod_1yr_n0==1, missing

//n=727 with no p1 and didn't die within 2 years of n0 ivw
//516 are 2012 n0 interviews, so won't have b/c no 2014 ivws in dataset
tab core_year_n0 if ind_p1_interview==0 & core_to_dod_2yr_n0==0
tab core_year_n0 exit_year_x if ind_x_interview==1 & ind_p1_interview==0 & core_to_dod_2yr_n0==0, missing

*******************************************************************
//indicator that meet criteria at the first interview where we can tell
gen meet_crit_first = 0
replace meet_crit_first=1 if ind_n1_interview==0 //no n1 interview
replace meet_crit_first=1 if ind_n1_interview==1 & (part_ab_12m_n1==0 | hmo_d_12m_n1==1) //have n1 but not ffs mc
replace meet_crit_first=1 if ind_n1_interview==1 & (part_ab_12m_n1==. | hmo_d_12m_n1==.) //have n1 but no denominator file
la var meet_crit_first "Meet criteria first interview with full information"
tab meet_crit_first , missing
tab meet_crit_first if core_year_n0<2012, missing

*******************************************************************
//cleaning up date of death variable!
//notes with specific n's refer to Criteria A dataset
//n=47 observatons have a date of death but no exit interview
tab ind_x_interview dod_ind, missing
tab exit_year_x if dod_ind==0, missing

//look at dod to exit interview date
gen dod_to_exit_days=e_ivw_date_x - death_date_n0
tab dod_to_exit_days, missing
tab dod_to_exit_days if ind_x_interview==1, missing
//7 obs have dod from the HRS restricted dataset after the exit interview date
//so bring in claims dod and compare it to see if can get clean dod!
tab e_ivw_date_x if dod_to_exit_days<0
tab e_ivw_date_x death_date_n0 if dod_to_exit_days<0

//convert claims death date to a date variable
rename dod_claims_n0 dod_claims_n0str
gen dod_claims_n0 = date(dod_claims_n0str,"YMD")
format dod_claims_n0 %td
tab death_date_n0 dod_claims_n0 if dod_to_exit_days<0 //check claims dod

//checking core interview dates for each of these observations, if no conflict
//use the claims dod where they are before the exit interview date
//for one observation, imputation of exit date causes the problem, so reassign exit date
gen use_claims_dod = 0

tab c_ivw_date_n0 c_ivw_date_p1 if e_ivw_date_x==date("06-15-2004","MDY") & death_date_n0==date("11-04-2004","MDY"), missing
tab id if e_ivw_date_x==date("06-15-2004","MDY") & death_date_n0==date("11-04-2004","MDY"), missing
replace death_date_n0=dod_claims_n0 if id=="201667010"
replace use_claims_dod=1 if id=="201667010"

tab c_ivw_date_n0 c_ivw_date_p1 if e_ivw_date_x==date("07-15-2004","MDY") & death_date_n0==date("7-17-2004","MDY"), missing
tab id if e_ivw_date_x==date("07-15-2004","MDY") & death_date_n0==date("7-17-2004","MDY"), missing
replace death_date_n0=dod_claims_n0 if id=="205022010"
replace use_claims_dod=1 if id=="205022010"

tab e_ivw_day_imp_x  e_ivw_date_x if e_ivw_date_x==date("06-15-2006","MDY") & death_date_n0==date("6-16-2006","MDY"), missing
//imputation of exit ivw date is incorrect, assign to last day of month
tab id if e_ivw_date_x==date("06-15-2006","MDY") & death_date_n0==date("6-16-2006","MDY"), missing
replace e_ivw_date_x=date("30jun2006","DMY") if id=="200372020" 
gen e_ivw_date_mod = 0
replace e_ivw_date_mod=1 if id=="200372020" 

tab c_ivw_date_n0 c_ivw_date_p1 if e_ivw_date_x==date("12-15-2006","MDY") & death_date_n0==date("12-17-2006","MDY"), missing
tab id if e_ivw_date_x==date("12-15-2006","MDY") & death_date_n0==date("12-17-2006","MDY"), missing
replace death_date_n0=dod_claims_n0 if id=="204723010"
replace use_claims_dod=1 if id=="204723010"

tab c_ivw_date_n0 c_ivw_date_p1 if e_ivw_date_x==date("04-07-2008","MDY") & death_date_n0==date("11-27-2008","MDY"), missing
tab id if e_ivw_date_x==date("04-07-2008","MDY") & death_date_n0==date("11-27-2008","MDY"), missing
replace death_date_n0=dod_claims_n0 if id=="210540020"  
replace use_claims_dod=1 if id=="210540020"

//comment out for 2010
tab c_ivw_date_n0 c_ivw_date_p2 if e_ivw_date_x==date("04-18-2008","MDY") & death_date_n0==date("09-27-2008","MDY"), missing
tab id if e_ivw_date_x==date("04-18-2008","MDY") & death_date_n0==date("09-27-2008","MDY"), missing
replace death_date_n0=dod_claims_n0 if id=="201942011"  
replace use_claims_dod=1 if id=="201942011"

//comment out for 2010
tab c_ivw_date_n0 c_ivw_date_p2 if e_ivw_date_x==date("06-24-2008","MDY") & death_date_n0==date("07-26-2008","MDY"), missing
tab id if e_ivw_date_x==date("06-24-2008","MDY") & death_date_n0==date("07-26-2008","MDY"), missing
replace death_date_n0=dod_claims_n0 if id=="206221020"  
replace use_claims_dod=1 if id=="206221020"

tab use_claims_dod, missing

//47 obs have exit interview but no date of death, check to see if can use claims dod for those obs
tab dod_claims_n0 exit_year_x if ind_x_interview==1 & dod_ind==0, missing
list dod_claims_n0 if ind_x_interview==1 & dod_ind==0

//1 obs does have dod in claims so need to leave missing
//rest wave seems to match the claims dod information
gen test_claims_miss_dod_exit_dt=e_ivw_date_x-dod_claims_n0 if ind_x_interview==1 & dod_ind==0
tab test_claims_miss_dod_exit_dt, missing //all obs have exit interview date after the dod

gen test_claims_miss_dod_n0_dt=dod_claims_n0-c_ivw_date_n0 if ind_x_interview==1 & dod_ind==0
tab test_claims_miss_dod_n0_dt, missing //all obs have core n0 before the dod

gen test_claims_miss_dod_p1_dt=dod_claims_n0-c_ivw_date_p1 if ind_x_interview==1 & dod_ind==0 & ind_p1_interview==1 
tab test_claims_miss_dod_p1_dt, missing //all obs have core p1 before the dod

//comment out for 2010
gen test_claims_miss_dod_p2_dt=dod_claims_n0-c_ivw_date_p2 if ind_x_interview==1 & dod_ind==0 & ind_p2_interview==1 
tab test_claims_miss_dod_p2_dt, missing //all obs have core p2 before the dod

//use the claims dod since it doesn't conflict with the interview dates
replace death_date_n0=dod_claims_n0 if ind_x_interview==1 & dod_ind==0 & dod_claims_n0!=.
replace use_claims_dod=1 if ind_x_interview==1 & dod_ind==0 & dod_claims_n0!=.

//20 observations have dod before core n0 interview
//check to see if can use claims dod for these observations
list c_ivw_date_n0 death_date_n0 dod_claims_n0 e_ivw_date_x if core_to_death_n0<0 & use_claims_dod~=1
gen test_claims_dod_x=e_ivw_date_x-dod_claims_n0 if core_to_death_n0<0 & use_claims_dod~=1
tab test_claims_dod_x, missing //all observations have exit after claims dod

gen test_claims_dod_n0=dod_claims_n0-c_ivw_date_n0 if core_to_death_n0<0 & use_claims_dod~=1
tab test_claims_dod_n0, missing //all observations have dod after core n0 interview

//so use the claims dod
tab core_year_n0 if  core_to_death_n0<0 & core_to_death_n0~=.
replace death_date_n0=dod_claims_n0 if  core_to_death_n0<0 & core_to_death_n0~=.
replace use_claims_dod=1 if core_to_death_n0<0 & core_to_death_n0~=.

//now replace the dod variables using the cleaned up dod
replace dod_ind=1 if death_date_n0!=.

replace core_to_death_n0=(death_date_n0-c_ivw_date_n0)/365.25 if use_claims_dod==1
tab core_to_death_n0 core_to_dod_1yr_n0 if use_claims_dod==1

foreach i in 1 2 {
replace core_to_dod_`i'yr_n0=1 if core_to_death_n0<`i' & use_claims_dod==1
replace core_to_dod_`i'yr_n0=0 if core_to_death_n0>=`i' & use_claims_dod==1
}
replace core_to_dod_6m_n0=1 if core_to_death_n0<.5 & use_claims_dod==1
replace core_to_dod_6m_n0=0 if core_to_death_n0>=.5 & use_claims_dod==1

replace dod_to_exit_days=e_ivw_date_x - death_date_n0 if use_claims_dod==1 | e_ivw_date_mod==1
tab dod_to_exit_days if use_claims_dod==1 | e_ivw_date_mod==1

drop test_claims_*

*******************************************************************
//Looking at n1 interview, for dealing with missing information
//Age at n1 interview 
gen age_ge_66_n1 = .
replace age_ge_66_n1 =1 if age_at_core_n1>=66 & age_at_core_n1!=.
replace age_ge_66_n1 =0 if age_at_core_n1<66 & age_at_core_n1!=.
la var age_ge_66_n1 "Age at core n1 66+, yes"
tab age_ge_66_n1 , missing

//interview year, prior to 2001, won't have full year lookback
//in medicare files
gen c_ivw_n1_pre2001 = .
replace c_ivw_n1_pre2001=1 if c_ivw_year_n1<2001 & c_ivw_year_n1!=.
replace c_ivw_n1_pre2001=0 if c_ivw_year_n1>=2001 & c_ivw_year_n1!=.
la var c_ivw_n1_pre2001 "n1 interview earlier than 2001, 1=yes"
tab c_ivw_n1_pre2001 , missing

*******************************************************************
//Change in functional status variables
*******************************************************************
//Looking back, change from core before meet criteria to core when meet criteria
label define adl_cat_core 0 "Independent" 1 "Partial Dependence" 2 "Severe Dependence"
label values adl_cat_core_n0 adl_cat_core 
tab adl_cat_core_n0 , missing 

//stable ind = 1 if stays the same or improves (0 if declines)
gen byte adl_stable_ind_n0n1=0
replace adl_stable_ind_n0n1=1 if adl_cat_core_n0==0 & inlist(adl_cat_core_n1,0,1,2) 

gen byte adl_stable_partial_n0n1=0
replace adl_stable_partial_n0n1=1 if adl_cat_core_n0==1 & inlist(adl_cat_core_n1,1,2) 

gen byte adl_stable_severe_n0n1=0
replace adl_stable_severe_n0n1=1 if adl_cat_core_n0==2 & adl_cat_core_n1==2 

gen byte adl_change_i_m_n0n1=0
replace adl_change_i_m_n0n1=1 if adl_cat_core_n0==1 & adl_cat_core_n1==0

gen byte adl_change_i_s_n0n1=0
replace adl_change_i_s_n0n1=1 if adl_cat_core_n0==2 & adl_cat_core_n1==0

gen byte adl_change_m_s_n0n1=0
replace adl_change_m_s_n0n1=1 if adl_cat_core_n0==2 & adl_cat_core_n1==1

//note that adl improved category is included in the stable categories above
gen byte adl_improved_n0n1=0
replace adl_improved_n0n1=1 if inlist(adl_cat_core_n0,0,1) & adl_cat_core_n1==2
replace adl_improved_n0n1=1 if adl_cat_core_n0==0 & adl_cat_core_n1==1

local adlchange adl_stable_ind_n0n1 adl_stable_partial_n0n1 adl_stable_severe_n0n1 ///
adl_change_i_m_n0n1 adl_change_i_s_n0n1 adl_change_m_s_n0n1 adl_improved_n0n1

foreach v in `adlchange' {
replace `v'=. if adl_cat_core_n0==. | adl_cat_core_n1==.
}

//keep missing category out for now, see what the data looks like
//if decide on missing category, just change line in foreach loop above
//adl_change_n1n2_miss=0;
//if adl_cat_core_n1=. or  adl_cat_core_n2=.  then adl_change_n1n2_miss=1;

la var adl_stable_ind_n0n1 "R ADL Ind. stable or improving n1 to n0, 1=Yes"
la var adl_stable_partial_n0n1 "R ADL Partial Depend, stable n1 to n0, 1=Yes"
la var adl_stable_severe_n0n1 "R ADL Severe Depend, stable n1 to n0, 1=Yes"
la var adl_change_i_m_n0n1 "R ADL Indep. to Partial Depend n1 to n0, 1=Yes"
la var adl_change_i_s_n0n1 "R ADL Indep. to Severe Depend n1 to n0, 1=Yes"
la var adl_change_m_s_n0n1 "R ADL Partial to Severe Depend n1 to n0, 1=Yes"
la var adl_improved_n0n1 "R ADL Improvement n1 to n0, 1=Yes"
//la var adl_change_n0n1_miss="R ADL n1 to n0 unknown";

foreach v in `adlchange' {
tab `v' , missing
}

*******************************************************************
//Tabulate missng because missing n1 interview
mat adl_miss=J(6,1,.)

sum core_year_n0 //get overall n that meet criteria
mat adl_miss[1,1]=r(N)
		
sum core_year_n0 if adl_stable_ind_n0n1==. //need to look at those that are missing
mat adl_miss[2,1]=r(N)
	
sum core_year_n0 if adl_cat_core_n0==. //need to look at those that are missing
mat adl_miss[3,1]=r(N)
	
//if have n0 but missing n1, what are they n0?
sum core_year_n0 if adl_independent_core_n0==1 & adl_stable_ind_n0n1==.
mat adl_miss[4,1]=r(N)
	
sum core_year_n0 if adl_partial_core_n0==1 & adl_stable_ind_n0n1==.
mat adl_miss[5,1]=r(N)
	
sum core_year_n0 if adl_severe_core_n0==1 & adl_stable_ind_n0n1==.
mat adl_miss[6,1]=r(N)
	
mat list adl_miss

frmttable , ///
	statmat(adl_miss) ///
	sdec(0)	ctitles("" "Criteria `crit'") ///
	rtitles("N" \ "N missing adl change n1n0" \ "N Missing adl n0" \ ///
	"n ADL Independent n0" \"n ADL Partial n0" \"n ADL Severe n0")

//If missing adl change because n1 is missing, assign to stable category from n0 interview
replace adl_stable_ind_n0n1=1 if adl_independent_core_n0==1 & adl_change_i_m_n0n1==.
replace adl_stable_ind_n0n1=0 if adl_independent_core_n0==0 & adl_change_i_m_n0n1==.

replace adl_stable_partial_n0n1=1 if adl_partial_core_n0==1 & adl_change_i_m_n0n1==.
replace adl_stable_partial_n0n1=0 if adl_partial_core_n0==0 & adl_change_i_m_n0n1==.

replace adl_stable_severe_n0n1=1 if adl_severe_core_n0==1 & adl_change_i_m_n0n1==.
replace adl_stable_severe_n0n1=0 if adl_severe_core_n0==0 & adl_change_i_m_n0n1==.

foreach v in `adlchange' {
tab `v' , missing
}

*******************************************************************
*******************************************************************
//Change in functional status variables
//Looking forward, change from core meet criteria to next interview
tab adl_cat_core_p1 adl_cat_core_n0, missing

//stable ind = 1 if stays the same or improves (0 if declines)
gen byte adl_stable_ind_n0p1=0
replace adl_stable_ind_n0p1=1 if adl_cat_core_p1==0 & inlist(adl_cat_core_n0,0,1,2) 

gen byte adl_stable_partial_n0p1=0
replace adl_stable_partial_n0p1=1 if adl_cat_core_p1==1 & inlist(adl_cat_core_n0,1,2) 

gen byte adl_stable_severe_n0p1=0
replace adl_stable_severe_n0p1=1 if adl_cat_core_p1==2 & adl_cat_core_n0==2 

gen byte adl_change_i_m_n0p1=0
replace adl_change_i_m_n0p1=1 if adl_cat_core_p1==1 & adl_cat_core_n0==0

gen byte adl_change_i_s_n0p1=0
replace adl_change_i_s_n0p1=1 if adl_cat_core_p1==2 & adl_cat_core_n0==0

gen byte adl_change_m_s_n0p1=0
replace adl_change_m_s_n0p1=1 if adl_cat_core_p1==2 & adl_cat_core_n0==1

gen byte adl_improved_n0p1=0
replace adl_improved_n0p1=1 if inlist(adl_cat_core_p1,0,1) & adl_cat_core_n0==2
replace adl_improved_n0p1=1 if adl_cat_core_p1==0 & adl_cat_core_n0==1

local adlchange adl_stable_ind_n0p1 adl_stable_partial_n0p1 adl_stable_severe_n0p1 ///
adl_change_i_m_n0p1 adl_change_i_s_n0p1 adl_change_m_s_n0p1 adl_improved_n0p1

foreach v in `adlchange' {
replace `v'=. if adl_cat_core_n0==. | adl_cat_core_p1==.
}

//keep missing category out for now, see what the data looks like
//if decide on missing category, just change line in foreach loop above
//adl_change_n1n2_miss=0;
//if adl_cat_core_n1=. or  adl_cat_core_n2=.  then adl_change_n1n2_miss=1;

la var adl_stable_ind_n0p1 "R ADL Ind. stable or improving n0 to p1, 1=Yes"
la var adl_stable_partial_n0p1 "R ADL Partial Depend, stable n0 to p1, 1=Yes"
la var adl_stable_severe_n0p1 "R ADL Severe Depend, stable n0 to p1, 1=Yes"
la var adl_change_i_m_n0p1 "R ADL Indep. to Partial Depend n0 to p1, 1=Yes"
la var adl_change_i_s_n0p1 "R ADL Indep. to Severe Depend n0 to p1, 1=Yes"
la var adl_change_m_s_n0p1 "R ADL Partial to Severe Depend n0 to p1, 1=Yes"
la var adl_improved_n0p1 "R ADL Improvement n0 to p1, 1=Yes"
//la var adl_change_n0p1_miss="R ADL n0 to p1 unknown";

foreach v in `adlchange' {
tab `v' , missing
}

*******************************************************************
//Change in functional status variables
//Looking forward, change from core meet criteria to exit interview 
//This is populated for all r's with exit interviews, only really relevant
//for those that are missing the p1 interview
tab adl_cat_x adl_cat_core_n0 if ind_x_interview==1 & ind_p1_interview==0, missing
tab adl_cat_x adl_cat_core_n0, missing

//stable ind = 1 if stays the same or improves (0 if declines)
gen byte adl_stable_ind_n0x=0
replace adl_stable_ind_n0x=1 if adl_cat_x==0 & inlist(adl_cat_core_n0,0,1,2) 

gen byte adl_stable_partial_n0x=0
replace adl_stable_partial_n0x=1 if adl_cat_x==1 & inlist(adl_cat_core_n0,1,2) 

gen byte adl_stable_severe_n0x=0
replace adl_stable_severe_n0x=1 if adl_cat_x==2 & adl_cat_core_n0==2 

gen byte adl_change_i_m_n0x=0
replace adl_change_i_m_n0x=1 if adl_cat_x==1 & adl_cat_core_n0==0

gen byte adl_change_i_s_n0x=0
replace adl_change_i_s_n0x=1 if adl_cat_x==2 & adl_cat_core_n0==0

gen byte adl_change_m_s_n0x=0
replace adl_change_m_s_n0x=1 if adl_cat_x==2 & adl_cat_core_n0==1

gen byte adl_improved_n0x=0
replace adl_improved_n0x=1 if inlist(adl_cat_x,0,1) & adl_cat_core_n0==2
replace adl_improved_n0x=1 if adl_cat_x==0 & adl_cat_core_n0==1

local adlchange adl_stable_ind_n0x adl_stable_partial_n0x adl_stable_severe_n0x ///
adl_change_i_m_n0x adl_change_i_s_n0x adl_change_m_s_n0x adl_improved_n0x

foreach v in `adlchange' {
replace `v'=. if adl_cat_core_n0==. | adl_cat_x==.
}

//keep missing category out for now, see what the data looks like
//if decide on missing category, just change line in foreach loop above
//adl_change_n1n2_miss=0;
//if adl_cat_core_n1=. or  adl_cat_core_n2=.  then adl_change_n1n2_miss=1;

la var adl_stable_ind_n0x "R ADL Ind. stable or improving n0 to exit, 1=Yes"
la var adl_stable_partial_n0x "R ADL Partial Depend, stable n0 to exit, 1=Yes"
la var adl_stable_severe_n0x "R ADL Severe Depend, stable n0 to exit, 1=Yes"
la var adl_change_i_m_n0x "R ADL Indep. to Partial Depend n0 to exit, 1=Yes"
la var adl_change_i_s_n0x "R ADL Indep. to Severe Depend n0 to exit, 1=Yes"
la var adl_change_m_s_n0x "R ADL Partial to Severe Depend n0 to exit, 1=Yes"
la var adl_improved_n0x "R ADL Improvement n0 to exit, 1=Yes"
//la var adl_change_n0x_miss="R ADL n0 to exit unknown";

foreach v in `adlchange' {
tab `v' , missing
}

*******************************************************************
//indicator for whether or not meet criteria if chf and copd illness are excluded
tab smi_count_n0, missing

gen meet_`crit'_copd_chf_req_n0 = 1
replace meet_`crit'_copd_chf_req_n0 = 0 if smi_chf_ind_n0==0 & smi_copd_ind_n0==0
replace meet_`crit'_copd_chf_req_n0 = 0 if smi_chf_ind_n0==1 & smi_copd_ind_n0==0 & smi_count_n0>1
replace meet_`crit'_copd_chf_req_n0 = 0 if smi_chf_ind_n0==0 & smi_copd_ind_n0==1 & smi_count_n0>1
replace meet_`crit'_copd_chf_req_n0 = 0 if smi_chf_ind_n0==1 & smi_copd_ind_n0==1 & smi_count_n0>2

la var meet_`crit'_copd_chf_req_n0 "COPD or CHF required to meet criteria 1=yes"
tab meet_`crit'_copd_chf_req_n0, missing

//indicator for dementia is required
gen meet_`crit'_dement_req_n0 = 1
replace meet_`crit'_dement_req_n0 = 0 if smi_dem_ind_n0==0
replace meet_`crit'_dement_req_n0 = 0 if smi_dem_ind_n0==1 & smi_count_n0>1

la var meet_`crit'_dement_req_n0 "Dementia required to meet criteria 1=yes"
tab meet_`crit'_dement_req_n0 , missing

*******************************************************************
//get total MC payments / month
//check costs/month for 2010 no criteria group
gen death_mos_n0=12 if core_to_dod_1yr_n0==0
replace death_mos_n0=floor(core_to_death_n0*12) if core_to_dod_1yr_n0==1
replace death_mos_n0=0 if death_mos_n0==-1
tab death_mos_n0 core_to_dod_1yr_n0, missing

gen cost_mos_n0=tot_paid_by_mc_12m_wi_n0 if death_mos_n0==0
replace cost_mos_n0=tot_paid_by_mc_12m_wi_n0/death_mos_n0 if death_mos_n0>0
la var cost_mos_n0 "Medicare payments / month 12m following interview"
sum cost_mos_n0, detail


*******************************************************************
//gen total MC paid 2nd year from ivw 
/*
foreach x in n0 n1 p1 p2 {
gen tot_paid_2nd_yr_`x'=tot_paid_by_mc_24m_`x'-tot_paid_by_mc_12m_`x'
gen tot_paid_2nd_yr_wi_`x'=tot_paid_by_mc_24m_wi_`x'-tot_paid_by_mc_12m_wi_`x'
}
*/
//gen group vars (die, high, low, brief high)
foreach x in 90 95 {
gen h_tot_12m_`x'_n0=pct_tot_paid_by_mc_12m_wi_n0>`x'
gen h_tot_2nd_yr_`x'_n0=pct_tot_paid_by_mc_2nd_yr_wi_n0>`x'
gen p_high_util_`x'=h_tot_12m_`x'==1 & h_tot_2nd_yr_`x'==1
gen p_low_util_`x'=h_tot_12m_`x'==0 & h_tot_2nd_yr_`x'==0
gen brief_high_util_`x'=p_high_util_`x'==0 & p_low_util_`x'==0
gen brief_1st_yr_`x'=h_tot_12m_`x'==1 & h_tot_2nd_yr_`x'==0


gen tot_util_`x'_cat=1
replace tot_util_`x'_cat=2 if h_tot_12m_`x'==1 & h_tot_2nd_yr_`x'==0
replace tot_util_`x'_cat=3 if h_tot_12m_`x'==0 & h_tot_2nd_yr_`x'==1
replace tot_util_`x'_cat=4 if p_high_util_`x'==1
}
label define util 1 "Persistent Low Utilization" ///
2 "Brief High Utilization, 1st Yr" 3 "Brief High Utilization, 2nd Yr" ///
4 "Persistent High Utilization"

label values tot_util_90_cat util
label values tot_util_95_cat util

foreach x of varlist contact* {
	replace `x'=0 if `x'==.
}

//set icu_days=0 if icu_days==.
foreach x of varlist *icu* {
	replace `x'=0 if `x'==.
}

/*
gen h_type=h_tot_1+1
replace h_type=3 if p_h==1

label define util2 1 "Low 1st Yr Spending" 2 "Brief High Utilization" ///
3 "Persistent High Utilization"
*/
*********************************************************************
save n0_n1_p1_p2_x_criteria_`crit'_v1a.dta, replace

log close


H="Bringing in Helper file (from OOP) & dod"
clear all
set more off
capture log close

local logpath E:\data\serious_ill\logs
local datapath2 E:\data\serious_ill\int_data
local datapath E:\data\serious_ill\final_data

use "E:\data\hrs_oop_2010\received_data\2012\helper_hours_2012.dta", clear

rename hhid hhid_n0
rename pn pn_n0
rename year core_year_n0

save "`datapath2'\helper_hours_2012.dta", replace

foreach crit in a b c 2008 {
use "`datapath'\n0_n1_p1_p2_x_criteria_`crit'_v1a.dta", clear
merge 1:1 hhid_n0 pn_n0 core_year_n0 using "`datapath2'\helper_hours_2012.dta", ///
keep(match master)

replace n_hp=0 if n_hp==.
replace hlphrs=0 if hlphrs==.

drop _m

merge 1:1 id using "E:\data\surgery_hysterectomy\int_2012clms\death_date_2012.dta", ///
keep(match master) keepusing(death_all)

rename core_to_dod_* old_core_to_dod_*
gen core_to_dod_1yr_n0=(death_all-c_ivw_date_n0<=365)
gen core_to_dod_2yr_n0=(death_all-c_ivw_date_n0<=730)
gen core_to_dod_1yr_p1=(death_all-c_ivw_date_p1<=365) if c_ivw_date_p1!=.
gen core_to_dod_2yr_p2=(death_all-c_ivw_date_p1<=730) if c_ivw_date_p1!=.
rename death_date_n0 old_death_date_n0
rename death_all death_date_n0

foreach x in 90 95 {
	gen h2_tot_2nd_yr_`x'=pct_tot_paid_by_mc_2nd_yr_wi_n0>`x' if core_to_dod_1yr_n0==0
	gen h2_tot_1st_yr_`x'=pct_tot_paid_by_mc_12m_wi_n0>`x' if core_to_dod_1yr_n0==0
	gen p2_high_`x'=h2_tot_1st_yr_`x'==1 & h2_tot_2nd_yr_`x'==1
}
save "`datapath'\n0_n1_p1_p2_x_criteria_`crit'_v1.dta", replace
}


H="Tables, looking from 1st interview where meet criteria"

/*Stata
Create tables comparing outcomes for the criteria
Code can be run on either criteria a or criteria b datasets*/

capture log close

clear all
set more off
/*Update 6/9/14 Removed HIV as a serious medical illness in the list*/


local crit a
//local crit b
//local crit c

local logpath E:\data\serious_ill\logs
local datapath E:\data\serious_ill\final_data

log using "`logpath'\4`crit'-sic_changes_tables_crit_`crit'.txt", text replace

cd `datapath'

use n0_n1_p1_p2_x_criteria_`crit'_v1.dta if core_year_n0<2010

*******************************************************
*** Table of serious medical conditions
*******************************************************
local smivars smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 smi_chf_ind_n0 smi_copd_ind_n0 ///
smi_diab_compl_ind_n0 smi_liver_ind_n0 smi_als_ind_n0 smi_hip_ind_n0 adl_impair_core_n0

mat table1=J(10,10,.)

sum core_year_n0
sca nsamp=r(N)
local nsamp=nsamp

local r=1
foreach a in `smivars'{
	local c=1
	foreach b in `smivars'{
		tab `a' `b', matcell(r`r'c`c')
		mat table1[`r',`c']=r`r'c`c'[2,2]
	local c=`c'+1
	}
	local r=`r'+1
}

mat rownames table1="dementia" "cancer" "esrd" "chf" "copd" "diabetes" "liver disease" ///
 "ALS" "Hip fracture" "ADL Impairment"

mat colnames table1="dementia" "cancer" "esrd" "chf" "copd" "diabetes" "liver disease" ///
 "ALS" "Hip fracture" "ADL Impairment"

frmttable using "`logpath'\sic_Tables_4_outcomes_crit_`crit'", statmat(table1) ///
title("Comparison of serious medical conditions and ADL Impairment" \ ///
"Interview when first meet criteria" \ ///
"Criteria `crit' n=`nsamp'") sdec(0) landscape replace

*******************************************************
//is the hiv smi needed? do those meet the critera otherwise?
//Update 6/9/14 Decided to remove HIV after discussion with Amy
*******************************************************
//list of all criteria a components without hiv criteria
local smivars2 smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 smi_chf_ind_n0 smi_copd_ind_n0 ///
smi_diab_compl_ind_n0 smi_liver_ind_n0 smi_als_ind_n0 smi_hip_ind_n0 adl_impair_core_n0

gen crit_`crit'_nohiv=0 if smi_hiv_ind_n0==1
foreach v in `smivars2'{
replace crit_`crit'_nohiv=1 if `v'==1 & smi_hiv_ind_n0==1 & criteria_`crit'_n0==1
}
tab crit_`crit'_nohiv, missing

//looking at hiv indicator across interview years
label var smi_hiv_ind_n0 "HIV n0"
label var smi_hiv_ind_p1 "HIV p1"
label var smi_hiv_ind_p2 "HIV p2"

replace smi_hiv_ind_p1=99 if smi_hiv_ind_p1==.
replace smi_hiv_ind_p2=99 if smi_hiv_ind_p2==.

table smi_hiv_ind_n0 smi_hiv_ind_p1 smi_hiv_ind_p2, missing
*******************************************************
//Look at outcomes for those that meet without hiv vs those that do not
/********************************************************************
This section commented out, now that HIV was removed from the serious
medical illness secton, it no longer provides any information
since no observations are classified as meeting criteria with the HIV 
illness indicator only
gen hiv_only = 1 if  smi_hiv_ind_n0==1 & crit_`crit'_nohiv==0
replace hiv_only  = 2 if  smi_hiv_ind_n0==1 & crit_`crit'_nohiv==1
tab hiv_only , missing

//table of outcomes
local outcome1 core_to_dod_1yr_n0 hs_admit_p12m_n0 ind_em_ur_adm_p12m_n0

local outcome2 ip_paid_by_mc_12m_n0 snf_paid_by_mc_12m_n0 hh_paid_by_mc_12m_n0 hs_paid_by_mc_12m_n0 ///
pb_paid_by_mc_12m_n0 op_paid_by_mc_12m_n0 dm_paid_by_mc_12m_n0 tot_paid_by_mc_12m_n0 n_hospd_p12m_n0

mat hiv=J(34,2,.)
//first row, n for each category
tab hiv_only, matcell(c1)
mat hiv[1,1]=c1[1,1] //those only meeting criteria if hiv dx included
mat hiv[1,2]=c1[2,1] //those meeting criteria regardless of hiv dx

forvalues i=1/2{
local r=2
foreach v in `outcome1'{
	sum `v' if hiv_only==`i', detail
	mat hiv[`r',`i']=r(mean)
	mat hiv[`r'+1,`i']=r(sd)
	local r=`r'+2 //populates rows 2-7 for indicator variable outcomes
	}

local r=8
foreach v in `outcome2'{
	sum `v' if hiv_only==`i', detail
	mat hiv[`r',`i']=r(mean)
	mat hiv[`r'+1,`i']=r(p50)
	mat hiv[`r'+2,`i']=r(sd)
	local r=`r'+3 //populates rows 8-34 for continuous variables
	}
}

mat rownames hiv="N" "Died, mean" "SD" "Hospice enr, mean" "SD" "Emerg or urgent hosp admit, mean" "SD" ///
"IP Medicare payments, mean" "Median" "SD" "SNF Medicare payments, mean" "Median" "SD" ///
"HH Medicare payments, mean" "Median" "SD" "Hospice Medicare payments, mean" "Median" "SD" ///
"Carrier Medicare payments, mean" "Median" "SD" "OP Medicare payments, mean" "Median" "SD" ///
"DME Medicare payments, mean" "Median" "SD" "Total Medicare payments, mean" "Median" "SD" ///
"Hospital nights, mean" "Median" "SD"

mat colnames hiv="HIV dx required to meet criteria" "HIV dx excl, still meet criteria"

frmttable using "`logpath'\sic_Tables_4_outcomes_crit_`crit'", statmat(hiv) ///
title("Comparison of outcomes at 1 year, HIV dx only vs HIV dx not required" \ ///
"Criteria `crit'") sdec(0\2\2\2\2\2\2\0) landscape addtable
********************************************************************/

*******************************************************
*** Meet criteria p1 interview?
*******************************************************
mat p1_crit=J(6,2,.)
sum criteria_`crit'_n0
mat p1_crit[1,1]=r(N) //overall n meet criteria
mat p1_crit[1,2]=100

tab core_to_dod_2yr_n0 ind_p1_interview, missing

sum criteria_`crit'_n0 if ind_p1_interview==1  //n that have p1 interview 
mat p1_crit[2,1]=r(N) //overall n meet criteria w/ p1 ivw
mat p1_crit[2,2]=p1_crit[2,1]/p1_crit[1,1]*100

tab part_ab_12m_p1 hmo_d_12m_p1 if ind_p1_interview==1, missing
tab c_ivw_year_p1 if part_ab_12m_p1==. //all were 2011, we don't have denominator file that year

//who doesn't have p1 interview? Show number died within 2 years
sum criteria_`crit'_n0 if ind_p1_interview==0 & core_to_dod_2yr_n0==1
mat p1_crit[3,1]=r(N) //overall n meet criteria no p1 ivw but died within 2 years of n0 ivw
mat p1_crit[3,2]=p1_crit[3,1]/p1_crit[1,1]*100

sum criteria_`crit'_n0 if ind_p1_interview==0 & core_to_dod_2yr_n0==0
mat p1_crit[4,1]=r(N) //overall n meet criteria no p1 ivw, did not die within 2 years of n0 ivw
mat p1_crit[4,2]=p1_crit[4,1]/p1_crit[1,1]*100

//69% of those with no p1 and didn't die have 2010 n0 interview so don't have p1 ivw
tab core_year_n0 if ind_p1_interview==0 & core_to_dod_2yr_n0==0, missing

sum criteria_`crit'_n0 if ind_p1_interview==1 & part_ab_12m_p1==1 & hmo_d_12m_p1==0 //n that have p1 interview and ffs mc 1 year prior
mat p1_crit[5,1]=r(N) //overall n meet criteria w/ p1 ivw
mat p1_crit[5,2]=p1_crit[5,1]/p1_crit[2,1]*100

tab criteria_`crit'_p1 if ind_p1_interview==1 & part_ab_12m_p1==1 & hmo_d_12m_p1==0, matcell(p1)
mat p1_crit[6,1]=p1[2,1] //n that meet criteria p1
mat p1_crit[6,2]=(p1_crit[6,1] / p1_crit[5,1])*100

frmttable using "`logpath'\sic_Tables_4_outcomes_crit_`crit'", statmat(p1_crit) ///
title("Meet criteria `crit' in p1 interview")  ///
rtitles("Overall n meet criteria n0 interview"\ "Have p1 interview" \ ///
"Missing p1 ivw, died within 2 years of n0" \ "Missing p1 ivw, did not die within 2 years" \ ///
"Have ffs mc 1 year prior to p1 ivw, pct of those with p1 ivw" \ ///
"N meet p1 interview, pct of those with ffs p1 ivw") ///
ctitles("" "N" "Percent") ///
sdec(0,2) addtable

*******************************************************
gen n0top1ivw = (c_ivw_date_p1-c_ivw_date_n0)/365.25
sum n0top1ivw, detail
sca co_95pct=r(p95)
gen died_within_95pctco=0
replace died_within_95pctco=1 if core_to_death_n0<=co_95pct & core_to_death_n0!=.

sum criteria_`crit'_n0 if ind_p1_interview==0 & died_within_95pctco==0
sum criteria_`crit'_n0 if ind_p1_interview==0 & died_within_95pctco==1

sum core_to_death_n0 if  ind_p1_interview==0 & died_within_95pctco==0
tab core_year_n0 if  ind_p1_interview==0 & died_within_95pctco==0
*******************************************************
//looking at missing p1 interviews
mat ivws=J(7,2,.)
sum criteria_`crit'_n0
mat ivws[1,1]=r(N) //overall n meet criteria
mat ivws[1,2]=100

sum criteria_`crit'_n0 if ind_p1_interview==1  //n that have p1 interview 
mat ivws[2,1]=r(N) //overall n meet criteria w/ p1 ivw
mat ivws[2,2]=ivws[2,1]/ivws[1,1]*100

sum criteria_`crit'_n0 if ind_p1_interview==0  //n that do not have p1 interview 
mat ivws[3,1]=r(N) //overall n meet criteria w/o p1 ivw
mat ivws[3,2]=ivws[3,1]/ivws[1,1]*100

sum criteria_`crit'_n0 if ind_p1_interview==0 & core_to_dod_2yr_n0==1
mat ivws[4,1]=r(N) //overall n meet criteria no p1 ivw but died within 2 years of n0 ivw
mat ivws[4,2]=ivws[4,1]/ivws[3,1]*100

sum criteria_`crit'_n0 if ind_p1_interview==0 & core_year_n0==2010
mat ivws[5,1]=r(N) //overall n meet criteria no p1 ivw bc n0=2010
mat ivws[5,2]=ivws[5,1]/ivws[3,1]*100

sum criteria_`crit'_n0 if ind_p1_interview==0 & core_year_n0!=2010 & core_to_dod_2yr_n0==0 & ind_x_interview==1
mat ivws[6,1]=r(N) //overall n meet criteria no p1 ivw but have exit
mat ivws[6,2]=ivws[6,1]/ivws[3,1]*100

//looking at those with exit interview and no p1 interview
//n=27 have no dod but have exit interview!
sum core_to_death_n0 if ind_p1_interview==0 & core_year_n0!=2010 & core_to_dod_2yr_n0==0 & ind_x_interview==1, detail
tab core_to_death_n0 if ind_p1_interview==0 & core_year_n0!=2010 & core_to_dod_2yr_n0==0 & ind_x_interview==1, missing
tab dod_ind exit_year_x if ind_p1_interview==0 & core_year_n0!=2010 & core_to_dod_2yr_n0==0 & ind_x_interview==1, missing

sum criteria_`crit'_n0 if ind_p1_interview==0 & core_year_n0!=2010 & core_to_dod_2yr_n0==0 & ind_x_interview==0
mat ivws[7,1]=r(N) //overall n meet criteria no p1 ivw but have exit
mat ivws[7,2]=ivws[7,1]/ivws[3,1]*100

tab core_year_n0 if ind_p1_interview==0 & core_year_n0!=2010 & core_to_dod_2yr_n0==0 & ind_x_interview==0

mat list ivws

frmttable using "`logpath'\sic_Tables_4_outcomes_crit_`crit'", statmat(ivws) ///
title("Looking at missing p1 interviews, criteria `crit'")  ///
rtitles("Overall n meet criteria n0 interview"\ "Have p1 interview" \ ///
"Missing p1 ivw" \ "Missing p1 ivw, died within 2 years (pct of missing p1)" \ ///
"Missing p1 because meet crit in 2010 (pct of missing p1)" \ ///
"Missing p1, did not die within 2 years but have exit interview (pct of missing p1)" \ ///
"Missing p1, unknown reason, and no exit interview (pct of missing p1)") ///
ctitles("" "N" "Percent") ///
sdec(0,2) addtable

*******************************************************
//characteristics of group that meets criteria
//4 columns, 1 overall group, 2 group meets both n0 and p1 ivws, 3 group meets only n0, not p1
//4 that died, we just have exit, no p1 ivw
 ********* ********* ********* ********* ********* *********
************ This section doesn't do anything right now *********
************ Update it eventually to show the outcomes  *********
 ********* ********* ********* ********* ********* *********
//overall sample
tab core_year_n0 if core_year_n0!=2010, missing //can't have follow up if 2010 ivw so drop
gen ind_oa_sample=0
replace ind_oa_sample=1 if  core_year_n0!=2010
tab ind_oa_sample, missing

//with exit interview, no p1 core
tab ind_p1_interview ind_x_interview if core_year_n0!=2010, missing
gen ind_died_sample=0
replace ind_died_sample=1 if core_year_n0!=2010 & ind_p1_interview==0  & ind_x_interview==1

//with p1 core, meet criteria or not
tab criteria_`crit'_p1 if ind_p1_interview==1 & part_ab_12m_p1==1 & hmo_d_12m_p1==0
gen ind_meetp1_sample=0
replace ind_meetp1_sample=1 if ind_p1_interview==1 & part_ab_12m_p1==1 & hmo_d_12m_p1==0 & criteria_`crit'_p1==1
tab ind_meetp1_sample, missing

gen ind_nomeetp1_sample=0
replace ind_nomeetp1_sample=1 if ind_p1_interview==1 & part_ab_12m_p1==1 & hmo_d_12m_p1==0 & criteria_`crit'_p1==0
tab ind_nomeetp1_sample, missing

mat char=J(15,4,.)
//first row, get sample sizes
sum core_year_n0 if ind_oa_sample==1 
mat char[1,1]=r(N) //overall sample
sum core_year_n0 if ind_died_sample==1
mat char[1,2]=r(N) //with exit interview, no p1 ivw
sum core_year_n0 if ind_meetp1_sample==1
mat char[1,3]=r(N) //n that meet criteria p1
sum core_year_n0 if ind_nomeetp1_sample==1
mat char[1,4]=r(N) //n that do not meet criteria p1

local des_vars female_n0 

tab age_cat_n0, missing //(3 categories)

local c=1
foreach v in ind_oa_sample ind_died_sample ind_meetp1_sample ind_nomeetp1_sample{
	sum age_at_core_n0 if `v'==1
		mat char[2,`c']=r(mean)
	tab age_cat_n0 if `v'==1
		
	local c=`c'+1
}


***************************************************************
***************************************************************
//Look at 1 year n0 outcomes of those that meet 1st ivw and those that don't
local outcome core_to_dod_1yr_n0 hs_admit_p12m_n0 ind_em_ur_adm_p12m_n0 ///
ip_paid_by_mc_12m_wi_n0 snf_paid_by_mc_12m_wi_n0 hh_paid_by_mc_12m_wi_n0 hs_paid_by_mc_12m_wi_n0 ///
pb_paid_by_mc_12m_wi_n0 op_paid_by_mc_12m_wi_n0 dm_paid_by_mc_12m_wi_n0 tot_paid_by_mc_12m_wi_n0 n_hospd_p12m_n0

mat meet_1st=J(13,8,.)
	
//overall sample outcomes rows
sum core_year_n0
mat meet_1st[1,1]=r(N) //overall n
	
local r=2
		foreach v in `outcome'{
		sum `v', detail
		mat meet_1st[`r',1]=r(mean)
		mat meet_1st[`r',2]=r(p50)
		local r=`r'+1 
	}
			
local col = 3				
tab meet_crit_first, missing matcell(n0_1)
mat meet_1st[1,`col']=n0_1[2,1] //n who meet 1st interview
mat meet_1st[1,`col'+2]=n0_1[1,1] //n who do not meet 1st interview	
//for those that meet 1st interview and those that don't	
foreach resp in 1 0{
	local r=2
		foreach v in `outcome'{
		sum `v' if meet_crit_first==`resp', detail
		mat meet_1st[`r',`col']=r(mean)
		mat meet_1st[`r',`col'+1]=r(p50)
		local r=`r'+1
		}
	local col = `col'+2		
}

//column 7 for p-values
local r=2
foreach v in `outcome'{
	logit meet_crit_first `v'
	test `v'
	mat meet_1st[`r',7]=r(p) //p value from t-test
	local r=`r'+1
	}

mat list meet_1st

frmttable using "`logpath'\sic_Tables_4_outcomes_crit_`crit'", statmat(meet_1st) ///
title("1 year outcomes by if meet criteria `crit' 1st interview")  ///
rtitles("Overall n"\""\ "Died"\""\ "Hospice admit" \ "" \ "Hospital admit" \ "" \ ///
"IP Medicare" \""\ "SNF Medicare" \""\ "HH Medicare" \""\ "Hospice Medicare" \ "" \ ///
"Carrier Medicare" \""\ "OP Medicare" \ "" \ "DME Medicare" \ "" \ "Total Medicare payments" \ ""\ ///
"Number hospitalizations" \ ""  ) ///
ctitles("" "Overall" "Meet 1st ivw" "Do not meet 1st ivw" "p-value" \ ///
"" "mean" "" "" \ "" "(median)" "" "") ///
note("Criteria A = Any serious medical illness and/or ADL impairment" \ ///
"Criteria B = Criteria A and Urgent / Emergent hospitalization and/or NH resident" \ ///
"Criteria C = Illness and ADL impair and Hospitalization and/or NH resident" \ ///
"Outcomes are for 1 year after the initial interview where R meets criteria." \ ///
"Medicare spending is adjusted for inflation and the CMS wage index.") ///
substat(1) sdec(2\0) addtable


*******************************************************
log close


H="Tables, outcomes, comparing criteria a and b"
/*Stata
Create tables comparing outcomes for the criteria
Code switches between datasets as needed*/

capture log close

clear all
set mem 500m
set more off

local logpath E:\data\serious_ill\logs
local datapath E:\data\serious_ill\final_data

log using "`logpath'\5_crit_a_and_b_outcomes.txt", text replace

cd `datapath'

***************************************************************
//looking at follow up categories using the Criteria A dataset as a start
//prior to creating tables
use n0_n1_p1_p2_x_criteria_a_v1.dta if core_year_n0<2010

tab ind_p1_interview if core_to_dod_2yr_n0==0, missing
tab core_to_dod_2yr_n0, missing
tab core_to_dod_2yr_n0 ind_x_interview, missing
//1 obs died within 2 years of meeting criteria but has no exit or p1
//went back to full exit dataset and verified this
tab core_year_n0 id if core_to_dod_2yr_n0==1 & ind_x_interview==0
tab ind_p1_interview if core_to_dod_2yr_n0==1 & ind_x_interview==0

//missing p1 altogether?
tab ind_p1_interview if core_to_dod_2yr_n0==0, missing
tab core_year_n0 if ind_p1_interview==0 & core_to_dod_2yr_n0==0, missing
tab core_to_death_n0 if ind_p1_interview==0 & core_to_dod_2yr_n0==0, missing
tab core_year_n0 exit_year_x if core_to_death_n0==. & ind_p1_interview==0 & core_to_dod_2yr_n0==0, missing

tab exit_year_x if dod_ind==0, missing

//of those with p1, who had ffs medicare that time
//151 didn't have full denominator info so missing
//146 had hmo
tab  part_ab_12m_p1 hmo_d_12m_p1 if ind_p1_interview==1 & core_to_dod_2yr_n0==0, missing

tab ser_med_illness_p1 if ind_p1_interview==1 & core_to_dod_2yr_n0==0 & part_ab_12m_p1==1 & hmo_d_12m_p1==0, missing

gen outcome_ivw_cat = .
replace outcome_ivw_cat=1 if core_to_dod_2yr_n0==1 & ind_x_interview==1 //died
replace outcome_ivw_cat=2 if ser_med_illness_p1==1 & ind_p1_interview==1 & core_to_dod_2yr_n0==0 & part_ab_12m_p1==1 & hmo_d_12m_p1==0 //meet criteria p1
replace outcome_ivw_cat=3 if ser_med_illness_p1==0 & ind_p1_interview==1 & core_to_dod_2yr_n0==0 & part_ab_12m_p1==1 & hmo_d_12m_p1==0 //meet criteria p1

replace outcome_ivw_cat=4 if core_to_dod_2yr_n0==1 & ind_x_interview==0 //no follow up if died and missing exit ivw, n=1
replace outcome_ivw_cat=4 if core_to_dod_2yr_n0==0 & ind_p1_interview==0 //did not die, have no p1 ivw, n=171
replace outcome_ivw_cat=4 if core_to_dod_2yr_n0==0 & ind_p1_interview==1 & (part_ab_12m_p1!=1 | hmo_d_12m_p1!=0) //no ffs, n=297

la def outcome 1"Died" 2" Meet criteria p1" 3"Does not meet criteria p1" 4"Unknown, inadequate follow up"
la val outcome_ivw_cat outcome

tab outcome_ivw_cat, missing

clear

***************************************************************
**Check follow up interviews for each of the criteria (2 tables)
***************************************************************
mat p1_crit=J(5,4,.)
mat miss=J(6,4,.)

local col = 1
foreach crit in a b{
	use n0_n1_p1_p2_x_criteria_`crit'_v1.dta if core_year_n0<2010
		
**1st table looking at follow up outcomes
	sum core_year_n0
	mat p1_crit[1,`col']=r(N) //overall n meet criteria
	mat p1_crit[1,`col'+1]=100 //percent of n

	sum core_year_n0 if ind_p1_interview==0 & core_to_dod_2yr_n0==1 & ind_x_interview==1
	mat p1_crit[2,`col']=r(N) //no p1 interview, died within 2 years, with exit interview
	mat p1_crit[2,`col'+1]=p1_crit[2,`col']/p1_crit[1,`col']*100

	tab criteria_`crit'_p1 if ind_p1_interview==1 & part_ab_12m_p1==1 & hmo_d_12m_p1==0, matcell(p1)
	mat p1_crit[3,`col']=p1[2,1] //n that meet criteria p1
	mat p1_crit[3,`col'+1]=p1_crit[3,`col']/p1_crit[1,`col']*100
	mat p1_crit[4,`col']=p1[1,1] //n that do not meet criteria p1
	mat p1_crit[4,`col'+1]=p1_crit[4,`col']/p1_crit[1,`col']*100
	
	sum core_year_n0 if (core_to_dod_2yr_n0==1 & ind_x_interview==0) | ///
		(core_to_dod_2yr_n0==0 & ind_p1_interview==0) | ///
		(core_to_dod_2yr_n0==0 & ind_p1_interview==1 & (part_ab_12m_p1!=1 | hmo_d_12m_p1!=0))
	mat p1_crit[5,`col']=r(N) //no follow up interview
	mat p1_crit[5,`col'+1]=p1_crit[5,`col']/p1_crit[1,`col']*100
	
**2nd table begins here looking at missing follow up
	mat miss[1,`col']=p1_crit[5,`col'] //those that are missing, same as last row in above
	
	sum core_year_n0 if (core_to_dod_2yr_n0==1 & ind_x_interview==0)
	mat miss[2,`col']=r(N) //died but no exit interview
	mat miss[2,`col'+1]=miss[2,`col']/miss[1,`col']*100  

	sum core_year_n0 if (core_to_dod_2yr_n0==0 & ind_p1_interview==0)
	mat miss[3,`col']=r(N) //didn't die but no p1
	mat miss[3,`col'+1]=miss[3,`col']/miss[1,`col']*100  
	
	sum core_year_n0 if (core_to_dod_2yr_n0==0 & ind_p1_interview==1 & (part_ab_12m_p1==. | hmo_d_12m_p1==.))
	mat miss[4,`col']=r(N) //have p1 but missing denominator info full year preceding p1
	mat miss[4,`col'+1]=miss[4,`col']/miss[1,`col']*100 

	
tab c_ivw_year_p1 if (core_to_dod_2yr_n0==0 & ind_p1_interview==1 & (part_ab_12m_p1==. | hmo_d_12m_p1==.)), missing
	
	sum core_year_n0 if (core_to_dod_2yr_n0==0 & ind_p1_interview==1 & (part_ab_12m_p1==0))
	mat miss[5,`col']=r(N) //have p1 but not parts a b medicare 1 year preceding p1
	mat miss[5,`col'+1]=miss[5,`col']/miss[1,`col']*100 

	sum core_year_n0 if (core_to_dod_2yr_n0==0 & ind_p1_interview==1 & (hmo_d_12m_p1==1))
	mat miss[6,`col']=r(N) //have p1 but hmo medicare 1 year preceding p1
	mat miss[6,`col'+1]=miss[6,`col']/miss[1,`col']*100 
	
	local col = `col'+2
		
	clear
}
	 
frmttable using "`logpath'\sic_Tables_5_outcomes_crit_a_and_b", statmat(p1_crit) ///
title("Meet criteria in p1 interview")  ///
rtitles("Overall n meet criteria n0 interview"\""\ "Died within 2 years and have exit interview" \ ///
""\"Meet criteria in p1 interview" \""\ "Do not meet criteria in p1 interview" \""\ ///
"Missing follow up interview, see notes"\"") ///
ctitles("" "Criteria A" "Criteria B" \ "" "n" "n" \ "" "(percent)" "(percent)" ) ///
note("Criteria A = Any serious medical illness and/or ADL impairment" \ ///
"Criteria B = Criteria A and Urgent / Emergent hospitalization and/or NH resident" \ ///
"Missing follow up if R died within 2 years of meet criteria but no exit interview,"  \ ///
"R did not die within 2 years, has no p1 interview," \ ///
"or R has p1 interview but not FFS MC 1 year preceding p1 interview.") ///
substat(1) sdec(0\1) replace

frmttable using "`logpath'\sic_Tables_5_outcomes_crit_a_and_b", statmat(miss) ///
title("Missing follow up interview")  ///
rtitles("Missing follow up interview"\""\ "Died within 2 years but no exit interview" \ ///
""\"Did not die but no p1 ivw" \""\ "Had p1 interview but missing dn file 1 year pre" \"" \ ///
"Had p1 interview, but not Part A, B medicare 1 yr pre" \ ""\"Had p1 ivw, but HMO 1 year pre" \ "") ///
ctitles("" "Criteria A" "Criteria B" \ "" "n" "n" \ "" "(percent)" "(percent)" ) ///
note("Criteria A = Any serious medical illness and/or ADL impairment" \ ///
"Criteria B = Criteria A and Urgent / Emergent hospitalization and/or NH resident" \ ///
"All missing denominator file in claims are for interviews that took place in 2011.") ///
substat(1) sdec(0\1) addtable

***************************************************************
**Check counts where meet 1st interview for each of the criteria
***************************************************************
mat n1_crit=J(9,4,.)
local col = 1
foreach crit in a b{
	use n0_n1_p1_p2_x_criteria_`crit'_v1.dta if core_year_n0<2010
		
**1st table looking at n1 present
	sum core_year_n0
	mat n1_crit[1,`col']=r(N) //overall n meet criteria
	mat n1_crit[1,`col'+1]=100 //percent of n

	sum core_year_n0 if ind_n1_interview==1 & part_ab_12m_n1==1 & hmo_d_12m_n1==0
	mat n1_crit[2,`col']=r(N) //have n1 interview with ffs mc 1 year pre
	mat n1_crit[2,`col'+1]=n1_crit[2,`col']/n1_crit[1,`col']*100

	sum core_year_n0 if ind_n1_interview==1 & part_ab_12m_n1==. & hmo_d_12m_n1==.
	mat n1_crit[3,`col']=r(N) //have n1 but don't have denominator file that ivw (pre 2000)
	mat n1_crit[3,`col'+1]=n1_crit[3,`col']/n1_crit[1,`col']*100
	
	//why so many missing denominator files? check interview year, don't have files before Jan 2000
	tab c_ivw_year_n1 if ind_n1_interview==1 & part_ab_12m_n1==. & hmo_d_12m_n1==., missing
	
	sum core_year_n0 if c_ivw_n1_pre2001==1 & ind_n1_interview==1 & part_ab_12m_n1==. & hmo_d_12m_n1==.
	mat n1_crit[4,`col']=r(N) //have n1 but missing dn file b/c pre 2001 ivw
	mat n1_crit[4,`col'+1]=n1_crit[4,`col']/n1_crit[1,`col']*100	

	sum core_year_n0 if c_ivw_n1_pre2001==0 & age_ge_66_n1==0 & ind_n1_interview==1 & part_ab_12m_n1==. & hmo_d_12m_n1==.
	mat n1_crit[5,`col']=r(N) //have n1 but missing dn file, later than 2001 but age less than 66 at ivw
	mat n1_crit[5,`col'+1]=n1_crit[5,`col']/n1_crit[1,`col']*100	

	sum core_year_n0 if c_ivw_n1_pre2001==0 & age_ge_66_n1==1 & ind_n1_interview==1 & part_ab_12m_n1==. & hmo_d_12m_n1==.
	mat n1_crit[6,`col']=r(N) //have n1 but missing dn file, really missing, can't tell why from age and ivw year
	mat n1_crit[6,`col'+1]=n1_crit[6,`col']/n1_crit[1,`col']*100		
		
	sum core_year_n0 if ind_n1_interview==1 & part_ab_12m_n1==0
	mat n1_crit[7,`col']=r(N) //have n1 but not parts a/b medicare 1 year pre
	mat n1_crit[7,`col'+1]=n1_crit[7,`col']/n1_crit[1,`col']*100

	sum core_year_n0 if ind_n1_interview==1 & part_ab_12m_n1==1 & hmo_d_12m_n1==1
	mat n1_crit[8,`col']=r(N) //have n1 but hmo medicare 1 year pre
	mat n1_crit[8,`col'+1]=n1_crit[8,`col']/n1_crit[1,`col']*100

	sum core_year_n0 if ind_n1_interview==0
	mat n1_crit[9,`col']=r(N) //missing n1 interview
	mat n1_crit[9,`col'+1]=n1_crit[9,`col']/n1_crit[1,`col']*100
	
	local col = `col'+2
		
	clear
}

	 
frmttable using "`logpath'\sic_Tables_5_outcomes_crit_a_and_b", statmat(n1_crit) ///
title("Checking R's that meet criteria first interview in our dataset")  ///
rtitles("Overall n meet criteria n0 interview"\""\ "Have n1 interview with ffs mc 1 year pre" \"" \ ///
"Have n1 ivw but missing dn file 1y pre" \"" \"Missing dn file bc ivw before 2001" \ "" \ ///
"Missing dn because age<66 at ivw (ivw 2001 or later)" \ "" \ ///
"Missing dn for unknown reason" \ "" \ "Have n1 ivw but not mc parts a&b 1y pre" \"" \ ///
"Have n1 ivw but HMO 1y pre"\"" \ "No n1 interview in HRS" \ "" ) ///
ctitles("" "Criteria A" "Criteria B" \ "" "n" "n" \ "" "(percent)" "(percent)" ) ///
note("Criteria A = Any serious medical illness and/or ADL impairment" \ ///
"Criteria B = Criteria A and Urgent / Emergent hospitalization and/or NH resident") ///
substat(1) sdec(0\1) addtable


***************************************************************
**Check outcomes across each part of the various criteria
***************************************************************
//Modified list, don't need nursing home or hospitalization only categories
//allow those obs to go into the smi and adl categories
local datapath2 E:\data\serious_ill\int_data
cd `datapath2'

//use dataset with outcomes, just obs that meet interview sample inclusion criteria
use ivws_crit_1.dta if inlist(core_year,2002,2004,2006,2008) & /// 
age_ge_65==1 & xwalk_yes==1 & part_ab_12m==1 & hmo_d_12m==0

gen comp_none=0
replace comp_none=1 if ser_med_illness==0 & adl_impair_core==0 & smi_nh_ind==0 & ind_em_ur_adm_12m==0
tab comp_none

//smi, no adl, regardless of nh or hospitalization
gen comp_smi=0
replace comp_smi=1 if ser_med_illness==1 & adl_impair_core==0
tab comp_smi

//no smi, adl, regardless of nh or hospitalization
gen comp_adl=0
replace comp_adl=1 if ser_med_illness==0 & adl_impair_core==1
tab comp_adl

//gen comp_nh=0
//replace comp_nh=1 if ser_med_illness==0 & adl_impair_core==0 & smi_nh_ind==1 & ind_em_ur_adm_12m==0
//tab comp_nh

//gen comp_hos=0
//replace comp_hos=1 if ser_med_illness==0 & adl_impair_core==0 & smi_nh_ind==0 & ind_em_ur_adm_12m==1
//tab comp_hos

//smi+adl, regardless of nh or hospitalization
gen comp_smi_adl=0
replace comp_smi_adl=1 if ser_med_illness==1 & adl_impair_core==1
tab comp_smi_adl

gen comp_smi_nh=0
replace comp_smi_nh=1 if ser_med_illness==1 & adl_impair_core==0 & smi_nh_ind==1 & ind_em_ur_adm_12m==0
tab comp_smi_nh

gen comp_smi_hosp=0
replace comp_smi_hosp=1 if ser_med_illness==1 & adl_impair_core==0 & smi_nh_ind==0 & ind_em_ur_adm_12m==1
tab comp_smi_hosp

gen comp_adl_nh=0
replace comp_adl_nh=1 if ser_med_illness==0 & adl_impair_core==1 & smi_nh_ind==1 & ind_em_ur_adm_12m==0
tab comp_adl_nh

gen comp_adl_hosp=0
replace comp_adl_hosp=1 if ser_med_illness==0 & adl_impair_core==1 & smi_nh_ind==0 & ind_em_ur_adm_12m==1
tab comp_adl_hosp

gen comp_nh_hosp=0
replace comp_nh_hosp=1 if  ser_med_illness==0 & adl_impair_core==0 & smi_nh_ind==1 & ind_em_ur_adm_12m==1
tab comp_nh_hosp
tab comp_nh_hosp comp_nh

gen comp_smi_adl_nh=0
replace comp_smi_adl_nh=1 if ser_med_illness==1 & adl_impair_core==1 & smi_nh_ind==1 & ind_em_ur_adm_12m==0
tab comp_smi_adl_nh

gen comp_smi_adl_hosp=0
replace comp_smi_adl_hosp=1 if ser_med_illness==1 & adl_impair_core==1 & smi_nh_ind==0 & ind_em_ur_adm_12m==1
tab comp_smi_adl_hosp

gen comp_smi_nh_hosp=0
replace comp_smi_nh_hosp=1 if ser_med_illness==1 & adl_impair_core==0 & smi_nh_ind==1 & ind_em_ur_adm_12m==1
tab comp_smi_nh_hosp

gen comp_adl_nh_hosp=0
replace comp_adl_nh_hosp=1 if ser_med_illness==0 & adl_impair_core==1 & smi_nh_ind==1 & ind_em_ur_adm_12m==1
tab comp_adl_nh_hosp

gen comp_all=0
replace comp_all=1 if ser_med_illness==1 & adl_impair_core==1 & smi_nh_ind==1 & ind_em_ur_adm_12m==1
tab comp_all

gen comp_criteria_a = 0
replace comp_criteria_a =1 if ser_med_illness==1 | adl_impair_core==1 
tab comp_criteria_a

gen comp_criteria_b = 0
replace comp_criteria_b =1 if (ser_med_illness==1 | adl_impair_core==1) & (smi_nh_ind==1 | ind_em_ur_adm_12m==1)
tab comp_criteria_b
***************************************************************
//table of outcomes, interview level (so R may be represented 4x)
local outcome1 core_to_dod_1yr hs_admit_p12m ind_em_ur_adm_p12m ip_paid_by_mc_12m_wi ///
tot_paid_by_mc_12m_wi

local compvars comp_none comp_smi comp_adl /*comp_nh comp_hos*/ comp_smi_adl comp_criteria_a ///
comp_smi_nh comp_smi_hosp comp_adl_nh comp_adl_hosp comp_nh_hosp ///
comp_smi_adl_nh comp_smi_adl_hosp comp_smi_nh_hosp comp_adl_nh_hosp comp_all comp_criteria_b

//overall sample, n interviews
sum core_year
local nsamp=r(N)

mat comp_N_c1=J(16,3,.)
mat comp=J(16,15,.)

//first column, get n for each subgroup
local r=1
foreach comp in `compvars'{
	sum core_year if `comp'==1, detail
	mat comp_N_c1[`r',1]=r(N)
	local r=`r'+1
}

local c=1
foreach var in `outcome1'{
	local r=1
	foreach comp in `compvars'{
		sum `var' if `comp'==1, detail
		mat comp[`r',`c']=r(mean)
		mat comp[`r',`c'+1]=r(sd)
		mat comp[`r',`c'+2]=r(p50)
		local r=`r'+1
	}
local c=`c'+3
}
mat rownames comp_N_c1="None" "Serious med illness" "ADL Impairment" /*"NH resident" "Hospitalization"*/ ///
"Illness + ADL Impair" "Criteria A" "Illness + NH res" "Illness + Hospital" ///
"ADL + NH Res" "ADL + Hospital" ///
"NH res + Hospital" "Illness + ADL + NH" "Illness + ADL + Hospital" "Illness + NH + Hospital" ///
"ADL + NH + Hospital" "Illness + ADL + NH + Hosp" "Criteria B"

mat rownames comp="None" "Serious med illness" "ADL Impairment" /*"NH resident" "Hospitalization"*/ ///
"Illness + ADL Impair" "Criteria A"  "Illness + NH res" "Illness + Hospital" ///
"ADL + NH Res" "ADL + Hospital" ///
"NH res + Hospital" "Illness + ADL + NH" "Illness + ADL + Hospital" "Illness + NH + Hospital" ///
"ADL + NH + Hospital" "Illness + ADL + NH + Hosp" "Criteria B"

frmttable , statmat(comp_N_c1) substat(2) ///
title("Comparison of serious medical conditions, outcomes at 1 year" \ ///
"N=`nsamp', interview level") ///
ctitles("","N" ) ///
sdec(0) store(table3)

frmttable using "`logpath'\sic_Tables_5_outcomes_crit_a_and_b", statmat(comp)  substat(2) ///
title("Comparison of serious medical conditions, outcomes at 1 year" \ ///
"N=`nsamp', interview level") ///
ctitles("","Died","Hospice admit","Hospital admit","IP Medicare","Total Medicare" \ ///
"","mean","","","","" \ "","(SD)", "","","","", \ "","[Median]","","","","" \ ///
"Medicare spending adjusted for inflation (2010$) and the CMS wage index.") ///
sdec(2) merge(table3) addtable

***************************************************************
***************************************************************
//Looking at ADL dependence vs nursing home residence
//interview level
tab adl_impair_core, missing
tab nhres, missing
tab core_year, missing

mat adl_nh=J(10,2,0)
tab nhres, missing matcell(nh1)
mat adl_nh[1,1]=nh1[2,1] //nh residents
mat adl_nh[1,2]=nh1[2,1] / `nsamp' * 100 //percent all interviews

tab adl_impair_core if nhres==1, missing matcell(m1)
mat adl_nh[2,1]=m1[2,1] //adl dependent (expect most to be adl dependent)
mat adl_nh[2,2]=m1[2,1]/adl_nh[1,1]*100
mat adl_nh[3,1]=m1[1,1] //adl independent
mat adl_nh[3,2]=m1[1,1]/adl_nh[1,1]*100
mat adl_nh[4,1]=m1[3,1] //adl status missing
mat adl_nh[4,2]=m1[3,1]/adl_nh[1,1]*100

//look at those nursing home resident that are adl independent, why?
tab adl_core_check if nhres==1 & adl_impair_core==0, matcell(m2)
mat adl_nh[5,1]=m2[1,1] //flag for high level function=0
mat adl_nh[5,2]=m2[1,1]/adl_nh[3,1]*100
tab adl_core_check adl_diff_dr  if nhres==1 & adl_impair_core==0, matcell(m3)
mat adl_nh[6,1]=m3[2,1] //flag for high level function=1 and no difficulty dressing
mat adl_nh[6,2]=m3[2,1]/adl_nh[3,1]*100

//rest answered all adl questions as do not receive help with the task
mat adl_nh[7,1]=adl_nh[3,1]-adl_nh[5,1]-adl_nh[6,1]
mat adl_nh[7,2]=adl_nh[7,1]/adl_nh[3,1]*100

tab adl_dr_core if nhres==1 & adl_core_check~=0
tab adl_wk_core if  nhres==1 & (adl_core_check~=0 | (adl_core_check==1 & adl_diff_dr~=1))
tab adl_bh_core if  nhres==1 & (adl_core_check~=0 | (adl_core_check==1 & adl_diff_dr~=1))
tab adl_e_core if  nhres==1 & (adl_core_check~=0 | (adl_core_check==1 & adl_diff_dr~=1))
tab adl_tx_core if  nhres==1 & (adl_core_check~=0 | (adl_core_check==1 & adl_diff_dr~=1))
tab adl_t_core if  nhres==1 & (adl_core_check~=0 | (adl_core_check==1 & adl_diff_dr~=1))

tab adl_index_core if nhres==1

tab iadl_independent_core if nhres==1, missing matcell(m4)
mat adl_nh[8,1]=m4[1,1] //iadl dependent
mat adl_nh[8,2]=m4[1,1]/adl_nh[1,1]*100
mat adl_nh[10,1]=m4[2,1] //iadl status missing
mat adl_nh[10,2]=m4[2,1]/adl_nh[1,1]*100

mat list adl_nh

mat rownames adl_nh="Nursing home res at time of ivw" "ADL Dependent" ///
"ADL Independent" "ADL status missing" "ADL screen count=0" ///
"ADL screen=1 & No diff dress" "Ans no help received all ADL ?s" ///
"IADL Dependent" "IADL Independent" "IADL Status missing"

frmttable using "`logpath'\sic_Tables_5_outcomes_crit_a_and_b", statmat(adl_nh) ///
title("ADL status for NH Residents" \ ///
"N=`nsamp', interview level") ///
ctitles("","n","percent") ///
sdec(0,2) addtable

***************************************************************
***************************************************************
//Look at p1 outcomes of those that meet criteria p1 and those that don't
cd `datapath'

local outcomes core_to_dod_1yr_p1 hs_admit_p12m_p1 ind_em_ur_adm_p12m_p1 ///
ip_paid_by_mc_12m_wi_p1 snf_paid_by_mc_12m_wi_p1 hh_paid_by_mc_12m_wi_p1 hs_paid_by_mc_12m_wi_p1 ///
pb_paid_by_mc_12m_wi_p1 op_paid_by_mc_12m_wi_p1 dm_paid_by_mc_12m_wi_p1 tot_paid_by_mc_12m_wi_p1 n_hospd_p12m_p1

mat p1_meet=J(13,8,.)

local col = 1
foreach crit in a b{
	clear
	use n0_n1_p1_p2_x_criteria_`crit'_v1.dta if core_year_n0<2010
		
	tab criteria_`crit'_p1, missing matcell(p1_1)
	mat p1_meet[1,`col']=p1_1[2,1] //n who meet criteria p1
	mat p1_meet[1,`col'+2]=p1_1[1,1] //n who do not meet criteria p1
	
	foreach resp in 1 0{
		local r=2
			foreach v in `outcomes'{
			sum `v' if criteria_`crit'_p1==`resp', detail
			mat p1_meet[`r',`col']=r(mean)
			mat p1_meet[`r',`col'+1]=r(p50)
			local r=`r'+1
			}
		local col = `col'+2		
		}
			
}

	 
frmttable using "`logpath'\sic_Tables_5_outcomes_crit_a_and_b", statmat(p1_meet) ///
title("1 year outcomes by status at p1 interview")  ///
rtitles("Overall n"\""\ "Died"\""\ "Hospice admit" \ "" \ "Hospital admit" \ "" \ ///
"IP Medicare" \""\ "SNF Medicare" \""\ "HH Medicare" \""\ "Hospice Medicare" \ "" \ ///
"Carrier Medicare" \""\ "OP Medicare" \ "" \ "DME Medicare" \ "" \ "Total Medicare payments" \ ""\ ///
"Number hospitalizations" \ ""  ) ///
ctitles("" "Criteria A" "" "Criteria B" "" \ ///
"" "Meet p1" "Do not meet p1" "Meet p1" "Do not meet p1" \ ///
"" "mean" "" "" "" \ "" "(median)" "" "" ) ///
note("Criteria A = Any serious medical illness and/or ADL impairment" \ ///
"Criteria B = Criteria A and Urgent / Emergent hospitalization and/or NH resident" \ ///
"Outcomes are for 1 year after the p1 interview." \ ///
"Medicare spending adjusted for inflation (2010$) and the CMS wage index.") ///
substat(1) sdec(2\0) addtable

***************************************************************
log close


H="xxxNeeds work!! xxxTables, outcomes, without full ffs medicare 1 year after ivw"
/*Stata
Create tables comparing outcomes for the criteria
Code can be run on either criteria a or criteria b datasets

Checking differences in outcomes where full 1 year ffs medicare can be
verified after the interview vs not

Maybe want to compare for those that die within the 1 year vs those that
don't also because they will not be comparing similar time periods, spending may be cut off for those that died within the year...*/

capture log close

clear all
set mem 500m
set more off

local crit a
local crit b

local logpath E:\data\serious_ill\logs
local datapath E:\data\serious_ill\final_data

log using "`logpath'\6`crit'_sensitivity_full_1yr_post_ffs_mc.txt", text replace

cd `datapath'

use n0_n1_p1_p2_x_criteria_`crit'_v1.dta if core_year_n0<2010

********************************************************************
//Identify where ffs medicare 1 year after interview, n0 and p1 interviews
gen ffs_mc_yes_n0 = 0
replace ffs_mc_yes_n0 = 1 if part_ab_12m_aft_n0==1 & hmo_d_12m_aft_n0==0

gen ffs_mc_yes_p1 = 0
replace ffs_mc_yes_p1 = 1 if part_ab_12m_aft_p1==1 & hmo_d_12m_aft_p1==0

tab ffs_mc_yes_n0 core_year_n0 , missing
tab ffs_mc_yes_p1 core_year_p1 , missing

********************************************************************
//table of outcomes (12) n0 interview
local outcome core_to_dod_1yr hs_admit_p12m ind_em_ur_adm_p12m ///
ip_paid_by_mc_1yr_wi snf_paid_by_mc_1yr_wi hh_paid_by_mc_1yr_wi hs_paid_by_mc_1yr_wi ///
pb_paid_by_mc_1yr_wi op_paid_by_mc_1yr_wi dm_paid_by_mc_1yr_wi tot_paid_by_mc_1yr_wi n_hospd_p12m

mat comp = J(13,6,.)
//first row, counts of each group
sum core_year_n0
comp[1,1]=r(N)
sum core_year_n0

sum core_year_n0 if ffs_mc_yes_n0 ==1
comp[1,3]=r(N)
sum core_year_n0

sum core_year_n0 if ffs_mc_yes_n0 ==0
comp[1,5]=r(N)
sum core_year_n0

//first column, for overall sample
local r = 2
sum 

foreach v in 

********************************************************************
log close

H="Tables, outcomes, comparing a, b, c criteria"
/*Stata
Create tables comparing outcomes for the criteria
Switches  between criteria a, b, c datasets to create set 
of outcome tables

****Creates tables 1,2 of JAMA-IM April 2015 Submission****
(See next section for significance test for these 2 tables)

Final table list (tables 1-3 formatted for publication)
1. Typical table 1, sample characteristics for criteria medical illness, a, b, and c
2. 1 year outcomes, criteria medical illness, a, b, c
3. 2008 1 year outcomes, criteria a,b,c and no criteria as comparison group

Original table list:
4. Breakdown of counts of each of the different criteria (uses
dataset prior to breaking out by interview timeline meeting criteria)
5. Looking at interview timing both pre and post meeting criteria
6. Looking at p1 outcomes
*/

capture log close

clear all
set more off

local logpath E:\data\serious_ill\logs
local datapath2 E:\data\serious_ill\int_data
local datapath E:\data\serious_ill\final_data

log using "`logpath'\7_compare_3_criteria.txt", text replace

cd `datapath'




***************************************************************
//Typical Table 1 looking at characteristics of those that meet
//each of the requirements, the first interview where they meet
***************************************************************
local cvars age_at_core_n0 networth_adj2012_n0

local ivars female re_black re_white re_hisp re_other_unk ///
educ_level_lt_hs educ_level_hs educ_level_somcol educ_level_col ///
srh_pf_n0 srh_g_n0 srh_ve_n0 married_n0 smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 ///
smi_diab_compl_ind_n0 smi_liver_ind_n0 smi_als_ind_n0 smi_hip_ind_n0 el_ge3_comorb_1yr_n0 ///
adl_stable_ind_n0n1 adl_stable_partial_n0n1 adl_stable_severe_n0n1 ///
adl_change_i_m_n0n1 adl_change_i_s_n0n1 adl_change_m_s_n0n1 ///
ser_med_illness_n0 adl_impair_core_n0 smi_and_adl_n0 smi_nh_ind_n0 ind_em_ur_adm_12m_n0 

mat tab1 = J(36,6,.)
mat tab1n = J(1,6,.)

local c = 1
foreach crit in a b c {
	clear
	use n0_n1_p1_p2_x_criteria_`crit'_v1.dta if core_year_n0<2012

	//assign variable names for use in the tables
label var age_at_core_n0 "Age, mean (SD)"
label var networth_adj2012_n0 "Net worth, mean (SD)"
label var female "Female, n (%)"
label var re_black "Black, n (%)"
label var re_white "non-Hispanic White, n (%)"
label var re_hisp "Hispanic, n (%)"
label var re_other_unk "Other or Unknown, n (%)"
label var educ_level_lt_hs "Less than HS Deg., n (%)"

label var educ_level_hs "High school degree, n (%)"
label var educ_level_somcol "Some college, n (%)"
label var educ_level_col "Four year college deg., n (%)"
label var srh_pf_n0 "Poor/Fair, n (%)"
label var srh_g_n0 "Good, n (%)"
label var srh_ve_n0 "Very good/Excellent, n (%)"

label var married_n0 "Married, n (%)"
label var smi_dem_ind_n0 "Dementia, n (%)"
label var smi_cancer_ind_n0 "Cancer, n (%)"
label var smi_esrd_ind_n0 "ESRD, n (%)"
label var smi_chf_ind_n0 "CHF, n (%)"
label var smi_copd_ind_n0 "COPD, n (%)"

label var smi_diab_compl_ind_n0 "Diabetes, n (%)"
label var smi_liver_ind_n0 "Liver disease, n (%)"
label var smi_als_ind_n0 "ALS, n (%)"
label var smi_hip_ind_n0 "Hip Fracture, n (%)"
label var el_ge3_comorb_1yr_n0 "3 or more comorbid conditions, n (%)*"

label var ser_med_illness_n0 "Any serious medical illness, n (%)"
label var adl_impair_core_n0 "ADL Impairment, n (%)"

label var smi_and_adl_n0 "Medical illness & ADL Impair., n (%)"
label var smi_nh_ind_n0 "Nursing home resident, n (%)"
label var ind_em_ur_adm_12m_n0 "Hospital admission, n (%)"
label var adl_stable_ind_n0n1 "ADL Stable, independent, n (%)"
label var adl_stable_partial_n0n1 "ADL Stable, partial dep., n (%)"

label var adl_stable_severe_n0n1 "ADL Stable, severe dep., n (%)"
label var adl_change_i_m_n0n1 "ADL Indep to Partial Dep, n (%)"
label var adl_change_i_s_n0n1 "ADL Indep to Severe Dep, n (%)"
label var adl_change_m_s_n0n1 "ADL Partial to Severe Dep, n (%)"
	
	local r = 1
	foreach v in `cvars'{
		sum `v', detail
		mat tab1[`r',`c']=r(mean)
		mat tab1[`r',`c'+1]=r(sd)
		local r = `r'+1
	}

	foreach v in `ivars'{
	sum `v'
	mat tab1[`r',`c']=r(mean)*r(N) //n
	mat tab1[`r',`c'+1]=r(mean)*100 //percent
	local r = `r'+1
	}

	//n for last row
	sum core_year_n0
	mat tab1n[1,`c']=r(N)
	
	local c = `c'+2
}

mat tab1n_2 = J(1,4,.)

mat tab1n_2[1,1]=tab1n[1,1]
mat tab1n_2[1,2]=tab1n[1,3]
mat tab1n_2[1,3]=tab1n[1,5]


mat rownames tab1=`cvars' `ivars'

mat list tab1
mat list tab1n_2

//save the table in frmttable	
mat dmat=(0,1,0,1,0,1)
mat ann=J(36,3,1)

frmttable, statmat(tab1) varlabels ///
	sdec(1\0\1) doubles(dmat) ///
	dbldiv(" (") annotate(ann) asymbol(")") ///
	store(tab1_1) 	

frmttable, statmat(tab1n_2) ///
	sdec(0)	store(tab1_2) ///
	rtitles("N")

outreg , ///
	replay(tab1_1) append(tab1_2) ///
	ctitles("","Criteria A","Criteria B","Criteria C") ///
	title("Table 1: Sample characteristics - Interview first meet criteria A, B, C")  ///
	note("Criteria A = Any serious medical illness and/or ADL impairment" \ ///
	"Criteria B = Criteria A and Urgent / Emergent hospitalization and/or NH resident" \ ///
	"Criteria C = Medical illness and ADL Impairment and hospitalization and/or NH resident" \ ///
	"Comparison Group= Subjects in the 2008 interview wave who met none of the 3 criteria." \ ///
	"*Comorbid conditions as defined by Elixhauser comorbidities, 1 yr prior to interview.") ///
	store(table1)

***************************************************************
//repeat for 2008 r's that don't meet any criteria, add on as 4th column
clear
use n0_n1_p1_p2_x_criteria_2008_v1.dta

//meet criteria variables
tab criteria_a_n0, missing
tab criteria_b_n0, missing
tab criteria_c_n0, missing

gen no_crit = 0
replace no_crit=1 if criteria_a_n0==0 & criteria_b_n0==0 & criteria_c_n0==0 
la var no_crit "Criteria not met, 1=yes"
tab no_crit, missing

tab smi_esrd_ind_n0 no_crit, missing
tab smi_esrd_ind_n0 criteria_a_n0, missing
tab ser_med_illness_n0 smi_esrd_ind_n0, missing

keep if no_crit==1

mat tab1_2008=J(36,2,.)
mat tab1n_2008 = J(1,1,.)

//assign variable names for use in the tables
label var age_at_core_n0 "Age, mean (SD)"
label var networth_adj2012_n0 "Net worth, mean (SD)"
label var female "Female, n (%)"
label var re_black "Black, n (%)"
label var re_white "non-Hispanic White, n (%)"
label var re_hisp "Hispanic, n (%)"
label var re_other_unk "Other or Unknown, n (%)"
label var educ_level_lt_hs "Less than HS Deg., n (%)"

label var educ_level_hs "High school degree, n (%)"
label var educ_level_somcol "Some college, n (%)"
label var educ_level_col "Four year college deg., n (%)"
label var srh_pf_n0 "Poor/Fair, n (%)"
label var srh_g_n0 "Good, n (%)"
label var srh_ve_n0 "Very good/Excellent, n (%)"

label var married_n0 "Married, n (%)"
label var smi_dem_ind_n0 "Dementia, n (%)"
label var smi_cancer_ind_n0 "Cancer, n (%)"
label var smi_esrd_ind_n0 "ESRD, n (%)"
label var smi_chf_ind_n0 "CHF, n (%)"
label var smi_copd_ind_n0 "COPD, n (%)"

label var smi_diab_compl_ind_n0 "Diabetes, n (%)"
label var smi_liver_ind_n0 "Liver disease, n (%)"
label var smi_als_ind_n0 "ALS, n (%)"
label var smi_hip_ind_n0 "Hip Fracture, n (%)"
label var el_ge3_comorb_1yr_n0 "3 or more comorbid conditions, n (%)*"

label var ser_med_illness_n0 "Any serious medical illness, n (%)"
label var adl_impair_core_n0 "ADL Impairment, n (%)"

label var smi_and_adl_n0 "Medical illness & ADL Impair., n (%)"
label var smi_nh_ind_n0 "Nursing home resident, n (%)"
label var ind_em_ur_adm_12m_n0 "Hospital admission, n (%)"
label var adl_stable_ind_n0n1 "ADL Stable, independent, n (%)"
label var adl_stable_partial_n0n1 "ADL Stable, partial dep., n (%)"

label var adl_stable_severe_n0n1 "ADL Stable, severe dep., n (%)"
label var adl_change_i_m_n0n1 "ADL Indep to Partial Dep, n (%)"
label var adl_change_i_s_n0n1 "ADL Indep to Severe Dep, n (%)"
label var adl_change_m_s_n0n1 "ADL Partial to Severe Dep, n (%)"

local c = 1	
local r = 1
foreach v in `cvars'{
	sum `v', detail
	mat tab1_2008[`r',`c']=r(mean)
	mat tab1_2008[`r',`c'+1]=r(sd)
	local r = `r'+1
}

foreach v in `ivars'{
	sum `v'
	mat tab1_2008[`r',`c']=r(mean)*r(N) //n
	mat tab1_2008[`r',`c'+1]=r(mean)*100 //percent
	local r = `r'+1
}

//n for last row
sum core_year_n0
mat tab1n_2008[1,`c']=r(N)
	
mat rownames tab1_2008=`cvars' `ivars'

mat list tab1_2008
mat list tab1n_2008

//save the table in frmttable	
mat dmat=(0,1)
mat ann=J(36,1,1)

frmttable, statmat(tab1_2008) varlabels ///
	sdec(1\0\1) doubles(dmat) ///
	dbldiv(" (") annotate(ann) asymbol(")") ///
	store(tab12008_1) 	

frmttable, statmat(tab1n_2008) ///
	sdec(0)	store(tab12008_2) ///
	rtitles("N")

outreg, replay(tab12008_1) append(tab12008_2) store(tab12008_ab)

outreg using `logpath'\sic_Tables_7_outcomes_crit_a_b_c, ///
	replay(table1) merge(tab12008_ab) ///
	ctitles("","Criteria A","Criteria B","Criteria C","Comparison Group") ///
	replace
	
clear

***************************************************************
***************************************************************
//Table 2 - Looking at 1 year outcomes, 3 criteria
***************************************************************
***************************************************************
//use dataset with outcomes, just obs that meet interview sample inclusion criteria

foreach crit in  a b c{
	frmttable, clear(table2_b_1)
	clear
	use n0_n1_p1_p2_x_criteria_`crit'_v1.dta if core_year_n0<2012
	
la var core_to_dod_1yr_n0 "Died, n (%)"
la var hs_admit_p12m_n0 "Enrolled in hospice, n (%)"
la var ind_em_ur_adm_p12m_n0 "Hospital admission, n (%)"
la var n_hospd_p12m_n0 "Hospital nights, mean (sd)"

la var ip_paid_by_mc_12m_wi_n0 "Inpatient"
la var snf_paid_by_mc_12m_wi_n0 "SNF"
la var hh_paid_by_mc_12m_wi_n0 "Home health" 
la var hs_paid_by_mc_12m_wi_n0 "Hospice" 
la var pb_paid_by_mc_12m_wi_n0 "Carrier"
la var op_paid_by_mc_12m_wi_n0 "Outpatient" 
la var dm_paid_by_mc_12m_wi_n0 "DME"
la var tot_paid_by_mc_12m_wi_n0 "Total"
la var cost_mos_n0 "Costs per month"

local outcome1 core_to_dod_1yr_n0 hs_admit_p12m_n0 ind_em_ur_adm_p12m_n0

local outcome3 n_hospd_p12m_n0

local outcome2 ip_paid_by_mc_12m_wi_n0 snf_paid_by_mc_12m_wi_n0 hh_paid_by_mc_12m_wi_n0 ///
 hs_paid_by_mc_12m_wi_n0 pb_paid_by_mc_12m_wi_n0 op_paid_by_mc_12m_wi_n0 ///
 dm_paid_by_mc_12m_wi_n0 tot_paid_by_mc_12m_wi_n0 cost_mos_n0 

mat table2_n=J(1,1,.)
//row of n for each category
tab core_year_n0 , missing
mat table2_n[1,1]=r(N)

mat rownames table2_n="N"
mat list table2_n
frmttable, statmat(table2_n) ///
	sdec(0) store(table2_n_1) ///
	rtitles("N")

mat table2_a=J(4,2,.)
local c=1
local r=1
foreach v in `outcome1'{ //indicator variables, report n (percent)
	sum `v' , detail
	mat table2_a[`r',`c']=r(mean)*r(N) //n
	mat table2_a[`r',`c'+1]=r(mean)*100 //percent
	local r=`r'+1 
	}

foreach v in `outcome3'{ //hospital nights variable, report mean (sd)
	sum `v' , detail
	mat table2_a[`r',`c']=r(mean) //mean
	mat table2_a[`r',`c'+1]=r(sd) //sd
	local r=`r'+1 
	}

mat rownames table2_a=`outcome1' `outcome3'
mat list table2_a

//save the table in frmttable	
mat dmat=(0,1)
mat ann=J(4,1,1)

frmttable, statmat(table2_a) varlabels ///
	sdec(1) doubles(dmat) ///
	dbldiv(" (") annotate(ann) asymbol(")") ///
	store(table2_a_1) 

//for spending variables where we report medians
mat table2_b=J(1,2,.) //for mean, sd
mat table2_c=J(1,1,.) //for median

mat dmat_b=(0,1)
mat ann_b=J(1,1,1)
foreach v in `outcome2'{ //spending variables, report mean(sd),median

local c=1
	sum `v', detail
	mat table2_b[1,`c']=r(mean) //mean
	mat table2_b[1,`c'+1]=r(sd) //sd
	mat table2_c[1,`c']=r(p50) //median

	local lbl: var label `v'
	label var `v' "`lbl' , mean (sd)"
	mat rownames table2_b=`v'

	frmttable, statmat(table2_b)  varlabels ///
		sdec(0) doubles(dmat) ///
		dbldiv(" (") annotate(ann) asymbol(")") ///
		append(table2_b_1) 
	
	label var `v' " median"
	mat rownames table2_c=`v'	
	
	frmttable, statmat(table2_c)  varlabels ///
		sdec(0) append(table2_b_1) 	
}

outreg, replay(table2_a_1) append(table2_b_1) store(table2_c_1)
outreg, replay(table2_c_1) append(table2_n_1) store(table2_`crit')

}

outreg, replay(table2_smi) merge(table2_a) store(table2_1)
outreg, replay(table2_1) merge(table2_b) store(table2_2)

outreg , ///
replay(table2_2) merge(table2_c) store(table2_3) ///
	ctitles("","Criteria A","Criteria B","Criteria C") ///
	title("Table 2: 1 Year Outcomes, Year R first meets criteria") ///
	note("Serious illness = Any serious medical illness" \ ///
	"Criteria A = Any serious medical illness and/or ADL impairment" \ ///
	"Criteria B = Criteria A and Urgent / Emergent hospitalization and/or NH resident" \ ///
	"Criteria C = Medical illness and ADL Impairment and hospitalization and/or NH resident") ///
	

***************************************************************
//Add column for 2008 Comparison group
use n0_n1_p1_p2_x_criteria_2008_v1.dta
frmttable, clear(table2_b_1)

gen no_crit = 0
replace no_crit=1 if criteria_a_n0==0 & criteria_b_n0==0 & criteria_c_n0==0 
la var no_crit "Criteria not met, 1=yes"
tab no_crit, missing

keep if no_crit==1

la var core_to_dod_1yr_n0 "Died, n (%)"
la var hs_admit_p12m_n0 "Enrolled in hospice, n (%)"
la var ind_em_ur_adm_p12m_n0 "Hospital admission, n (%)"
la var n_hospd_p12m_n0 "Hospital nights, mean (sd)"

la var ip_paid_by_mc_12m_wi_n0 "Inpatient"
la var snf_paid_by_mc_12m_wi_n0 "SNF"
la var hh_paid_by_mc_12m_wi_n0 "Home health" 
la var hs_paid_by_mc_12m_wi_n0 "Hospice" 
la var pb_paid_by_mc_12m_wi_n0 "Carrier"
la var op_paid_by_mc_12m_wi_n0 "Outpatient" 
la var dm_paid_by_mc_12m_wi_n0 "DME"
la var tot_paid_by_mc_12m_wi_n0 "Total"
la var cost_mos_n0 "Costs per month"

mat table2_n=J(1,1,.)
//row of n for each category
tab core_year_n0 ,missing
mat table2_n[1,1]=r(N)

mat rownames table2_n="N"
mat list table2_n
frmttable, statmat(table2_n) ///
	sdec(0) store(table2_n_2008) ///
	rtitles("N")
	
mat table2_a=J(4,2,.)
local c=1
local r=1
foreach v in `outcome1'{ //indicator variables, report n (percent)
	sum `v' , detail
	mat table2_a[`r',`c']=r(mean)*r(N) //n
	mat table2_a[`r',`c'+1]=r(mean)*100 //percent
	local r=`r'+1 
	}

foreach v in `outcome3'{ //hospital nights variable, report mean (sd)
	sum `v' , detail
	mat table2_a[`r',`c']=r(mean) //mean
	mat table2_a[`r',`c'+1]=r(sd) //sd
	local r=`r'+1 
	}

mat rownames table2_a=`outcome1' `outcome3'
mat list table2_a

//save the table in frmttable	
mat dmat=(0,1)
mat ann=J(4,1,1)

frmttable, statmat(table2_a) varlabels ///
	sdec(1) doubles(dmat) ///
	dbldiv(" (") annotate(ann) asymbol(")") ///
	store(table2_a_1) 

//for spending variables where we report medians
mat table2_b=J(1,2,.) //for mean, sd
mat table2_c=J(1,2,.) //for median

mat dmat_b=(0,1)
mat ann_b=J(1,1,1)
foreach v in `outcome2'{ //spending variables, report mean(sd),median

local c=1
	sum `v' , detail
	mat table2_b[1,`c']=r(mean) //mean
	mat table2_b[1,`c'+1]=r(sd) //sd
	mat table2_c[1,`c']=r(p50) //median
	
	local lbl: var label `v'
	label var `v' "`lbl' , mean (sd)"
	mat rownames table2_b=`v'

	frmttable, statmat(table2_b)  varlabels ///
		sdec(0) doubles(dmat) ///
		dbldiv(" (") annotate(ann) asymbol(")") ///
		append(table2_b_1) 
	
	label var `v' " median"
	mat rownames table2_c=`v'	
	
	frmttable, statmat(table2_c)  varlabels ///
		sdec(0) append(table2_b_1) 	
}

outreg, replay(table2_a_1) append(table2_b_1) store(table2_c_1)
outreg, replay(table2_c_1) append(table2_n_2008) store(table2_2008)

outreg using `logpath'\sic_Tables_7_outcomes_crit_a_b_c, ///
	replay(table2_3) merge(table2_2008) ///
	ctitles("","Criteria A","Criteria B","Criteria C","2008") ///
	title("Table 2: 1 Year Outcomes, Year R first meets criteria") ///
	note("Serious illness = Any serious medical illness" \ ///
	"Criteria A = Any serious medical illness and/or ADL impairment" \ ///
	"Criteria B = Criteria A and Urgent / Emergent hospitalization and/or NH resident" \ ///
	"Criteria C = Medical illness and ADL Impairment and hospitalization and/or NH resident" \ ///
	"2008 Comparison Group = 2008 Wave interview, does not meet any of the 3 criteria") ///
	addtable
	
	
***************************************************************
***************************************************************
//Table 4 - Looking at counts of R's meeting each set 
//of criteria
***************************************************************
***************************************************************
//dataset prior to setting up based on criteria timeline, adding outcomes
//each R can be represented multiple times
use `datapath2'\core_ids_1yr_criteria_5_sample1.dta, clear

tab criteria_a, missing

tab smi_and_adl, missing

gen byte smi_or_adl_and_nh=.
replace smi_or_adl_and_nh=1 if criteria_a==1 & smi_nh_ind==1
replace smi_or_adl_and_nh=0 if criteria_a==0 | smi_nh_ind==0
tab smi_or_adl_and_nh, missing

gen byte smi_or_adl_and_hosp=.
replace smi_or_adl_and_hosp=1 if criteria_a==1 & ind_em_ur_adm_12m==1
replace smi_or_adl_and_hosp=0 if criteria_a==0 | ind_em_ur_adm_12m==0
tab smi_or_adl_and_hosp, missing

gen byte smi_and_adl_and_nh=.
replace smi_and_adl_and_nh=1 if smi_and_adl==1 & smi_nh_ind==1
replace smi_and_adl_and_nh=0 if smi_and_adl==0 | smi_nh_ind==0
tab smi_and_adl_and_nh, missing

gen byte smi_and_adl_and_hosp=.
replace smi_and_adl_and_hosp=1 if smi_and_adl==1 & ind_em_ur_adm_12m==1
replace smi_and_adl_and_hosp=0 if smi_and_adl==0 | ind_em_ur_adm_12m==0
tab smi_and_adl_and_hosp, missing

tab criteria_c, missing

local smi_vars ser_med_illness adl_impair_core smi_and_adl criteria_a ///
smi_or_adl_and_nh smi_or_adl_and_hosp criteria_b ///
smi_and_adl_and_nh smi_and_adl_and_hosp criteria_c

***************************************************************
//collapse dataset so get at the R level, not interview level
collapse core_year `smi_vars' ,by(id)

mat criteria_r=J(11,2,.)

sum core_year
sca sample_r=r(N)
mat criteria_r[1,1]=r(N)

local j=2
foreach v in `smi_vars' {
replace `v'=1 if `v'>0 & `v'!=.
tab `v',matcell(x1_`j')
mat criteria_r[`j',1]=x1_`j'[2,1]
mat criteria_r[`j',2]=x1_`j'[2,1]/sample_r*100
local j = `j'+1
}

mat list criteria_r

frmttable using `logpath'\sic_Tables_7_outcomes_crit_a_b_c, statmat(criteria_r) ///
title("Table 4 - Serious illness cohort, criteria, respondent level") ///
ctitle("","N Respondents","% respondents") ///
rtitle("Overall n R's" \ "Any serious medical illness"\  ///
"ADL Impairment"\ "Med Ill and ADL Impairment" \"Med Ill and/or ADL Impairment"\ ///
"Med Ill and/or ADL Imp + NH"\ ///
"Med Ill and/or ADL Imp + Hosp"\ "Med Ill and/or ADL Imp + NH and/or Hosp"\ ///
"Med Ill and ADL Imp + NH"\ "Med Ill and ADL Imp + Hosp"\ "Med Ill and ADL Imp + NH and/or Hosp") ///
sdec(0,2) addtable

clear
***************************************************************
***************************************************************
//Table 5
//Looking at interviews, missingness
***************************************************************
***************************************************************
mat ivws=J(16,8,.)
local col = 1
foreach crit in a b c{
	use n0_n1_p1_p2_x_criteria_`crit'_v1.dta if core_year_n0<2012

	sum core_year_n0
	mat ivws[1,`col']=r(N) //overall n meet criteria
	mat ivws[1,`col'+1]=100 //percent of n

***First section, looking at meeting criteria 1st interview

	sum core_year_n0 if ind_n1_interview==1 & part_ab_12m_n1==1 & hmo_d_12m_n1==0
	mat ivws[2,`col']=r(N) //have n1 interview with ffs mc 1 year pre
	mat ivws[2,`col'+1]=ivws[2,`col']/ivws[1,`col']*100

	sum core_year_n0 if ind_n1_interview==0 | part_ab_12m_n1~=1 | hmo_d_12m_n1!=0
	mat ivws[3,`col']=r(N) //total no n1 interview, so meet criteria 1st year
	mat ivws[3,`col'+1]=ivws[3,`col']/ivws[1,`col']*100
	
	sum core_year_n0 if ind_n1_interview==1 & part_ab_12m_n1==. & hmo_d_12m_n1==.
	mat ivws[4,`col']=r(N) //have n1 but don't have denominator file that ivw (pre 2000)
	mat ivws[4,`col'+1]=ivws[4,`col']/ivws[3,`col']*100
	
	//why so many missing denominator files? check interview year, don't have files before Jan 2000
	tab c_ivw_year_n1 if ind_n1_interview==1 & part_ab_12m_n1==. & hmo_d_12m_n1==., missing
	
	sum core_year_n0 if c_ivw_n1_pre2001==1 & ind_n1_interview==1 & part_ab_12m_n1==. & hmo_d_12m_n1==.
	mat ivws[5,`col']=r(N) //have n1 but missing dn file b/c pre 2001 ivw
	mat ivws[5,`col'+1]=ivws[5,`col']/ivws[3,`col']*100	

	sum core_year_n0 if c_ivw_n1_pre2001==0 & age_ge_66_n1==0 & ind_n1_interview==1 & part_ab_12m_n1==. & hmo_d_12m_n1==.
	mat ivws[6,`col']=r(N) //have n1 but missing dn file, later than 2001 but age less than 66 at ivw
	mat ivws[6,`col'+1]=ivws[6,`col']/ivws[3,`col']*100	

	sum core_year_n0 if c_ivw_n1_pre2001==0 & age_ge_66_n1==1 & ind_n1_interview==1 & part_ab_12m_n1==. & hmo_d_12m_n1==.
	mat ivws[7,`col']=r(N) //have n1 but missing dn file, really missing, can't tell why from age and ivw year
	mat ivws[7,`col'+1]=ivws[7,`col']/ivws[3,`col']*100		
		
	sum core_year_n0 if ind_n1_interview==1 & part_ab_12m_n1==0
	mat ivws[8,`col']=r(N) //have n1 but not parts a/b medicare 1 year pre
	mat ivws[8,`col'+1]=ivws[8,`col']/ivws[3,`col']*100

	sum core_year_n0 if ind_n1_interview==1 & part_ab_12m_n1==1 & hmo_d_12m_n1==1
	mat ivws[9,`col']=r(N) //have n1 but hmo medicare 1 year pre
	mat ivws[9,`col'+1]=ivws[9,`col']/ivws[3,`col']*100

	sum core_year_n0 if ind_n1_interview==0
	mat ivws[10,`col']=r(N) //missing n1 interview
	mat ivws[10,`col'+1]=ivws[10,`col']/ivws[3,`col']*100

***Second section, looking at missing p1 interviews
	sum core_year_n0 if (core_to_dod_2yr_n0==1 & ind_x_interview==0) | ///
		(core_to_dod_2yr_n0==0 & ind_p1_interview==0) | ///
		(core_to_dod_2yr_n0==0 & ind_p1_interview==1 & (part_ab_12m_p1!=1 | hmo_d_12m_p1!=0))
	mat ivws[11,`col']=r(N) //no follow up interview
	mat ivws[11,`col'+1]=ivws[11,`col']/ivws[1,`col']*100

	sum core_year_n0 if (core_to_dod_2yr_n0==1 & ind_x_interview==0)
	mat ivws[12,`col']=r(N) //died but no exit interview
	mat ivws[12,`col'+1]=ivws[12,`col']/ivws[1,`col']*100  

	sum core_year_n0 if (core_to_dod_2yr_n0==0 & ind_p1_interview==0)
	mat ivws[13,`col']=r(N) //didn't die but no p1
	mat ivws[13,`col'+1]=ivws[13,`col']/ivws[1,`col']*100  
	
	sum core_year_n0 if (core_to_dod_2yr_n0==0 & ind_p1_interview==1 & (part_ab_12m_p1==. | hmo_d_12m_p1==.))
	mat ivws[14,`col']=r(N) //have p1 but missing denominator info full year preceding p1
	mat ivws[14,`col'+1]=ivws[14,`col']/ivws[1,`col']*100 

tab c_ivw_year_p1 if (core_to_dod_2yr_n0==0 & ind_p1_interview==1 & (part_ab_12m_p1==. | hmo_d_12m_p1==.)), missing
	
	sum core_year_n0 if (core_to_dod_2yr_n0==0 & ind_p1_interview==1 & (part_ab_12m_p1==0))
	mat ivws[15,`col']=r(N) //have p1 but not parts a b medicare 1 year preceding p1
	mat ivws[15,`col'+1]=ivws[15,`col']/ivws[1,`col']*100 

	sum core_year_n0 if (core_to_dod_2yr_n0==0 & ind_p1_interview==1 & (hmo_d_12m_p1==1))
	mat ivws[16,`col']=r(N) //have p1 but hmo medicare 1 year preceding p1
	mat ivws[16,`col'+1]=ivws[16,`col']/ivws[1,`col']*100 

	local col = `col'+2
		
	clear
}

frmttable using `logpath'\sic_Tables_7_outcomes_crit_a_b_c, statmat(ivws) ///
title("Table 5 - Accounting for missing interviews")  ///
rtitles("N meet criteria n0 interview"\""\ ///
"Do not meet criteria in first interview" \"" \ ///
"Meet criteria in first interview with full " \"information" \ ///
"Have n1 ivw but missing dn file 1y pre" \"(percent of those meeting 1st ivw)"\ ///
"Missing dn file bc ivw before 2001" \ "" \ ///
"Missing dn because age<66 at ivw " \ "(ivw 2001 or later)" \ ///
"Missing dn for unknown reason" \ "" \ "Have n1 ivw but not mc parts a&b 1y pre" \"" \ ///
"Have n1 ivw but HMO 1y pre"\"" \ "No n1 interview in HRS" \ "" \ ///
"Missing follow up interview"\""\ "Died within 2 years but no exit interview" \""\ ///
"Did not die but no p1 ivw" \""\ "Had p1 interview but missing dn file 1 year pre" \"" \ ///
"Had p1 interview, but not Part A, B Medicare " \ "1 yr pre"\"Had p1 ivw, but HMO 1 year pre" \ "") ///
ctitles("" "Serious illness" "Criteria A" "Criteria B" "Criteria C" \ "" "n" "n" "n" "n" \ "" "(percent)" "(percent)" "(percent)" "(percent)" ) ///
note("Serious illness = Any serious medical illness" \ ///
"Criteria A = Any serious medical illness and/or ADL impairment" \ ///
"Criteria B = Criteria A and Urgent / Emergent hospitalization and/or NH resident" \ ///
"Criteria C = Medical illness and ADL Impairment and hospitalization and/or NH resident" \ ///
"All missing denominator file for p1 ivw are for interviews that took place in 2011.") ///
substat(1) sdec(0\1) addtable

***************************************************************
***************************************************************
//Table 6 - Looking at 2 year outcomes, using p1 interview
***************************************************************
***************************************************************
mat p1_crit=J(5,8,.)

local col = 1
foreach crit in a b c{
	use n0_n1_p1_p2_x_criteria_`crit'_v1.dta if core_year_n0<2012
		
**1st table looking at follow up outcomes
	sum core_year_n0
	mat p1_crit[1,`col']=r(N) //overall n meet criteria
	mat p1_crit[1,`col'+1]=100 //percent of n

	sum core_year_n0 if ind_p1_interview==0 & core_to_dod_2yr_n0==1 & ind_x_interview==1
	mat p1_crit[2,`col']=r(N) //no p1 interview, died within 2 years, with exit interview
	mat p1_crit[2,`col'+1]=p1_crit[2,`col']/p1_crit[1,`col']*100

	tab criteria_`crit'_p1 if ind_p1_interview==1 & part_ab_12m_p1==1 & hmo_d_12m_p1==0, matcell(p1)
	mat p1_crit[3,`col']=p1[2,1] //n that meet criteria p1
	mat p1_crit[3,`col'+1]=p1_crit[3,`col']/p1_crit[1,`col']*100
	mat p1_crit[4,`col']=p1[1,1] //n that do not meet criteria p1
	mat p1_crit[4,`col'+1]=p1_crit[4,`col']/p1_crit[1,`col']*100
	
	sum core_year_n0 if (core_to_dod_2yr_n0==1 & ind_x_interview==0) | ///
		(core_to_dod_2yr_n0==0 & ind_p1_interview==0) | ///
		(core_to_dod_2yr_n0==0 & ind_p1_interview==1 & (part_ab_12m_p1!=1 | hmo_d_12m_p1!=0))
	mat p1_crit[5,`col']=r(N) //no follow up interview
	mat p1_crit[5,`col'+1]=p1_crit[5,`col']/p1_crit[1,`col']*100

		local col = `col'+2
		
	clear
}
	 
frmttable using `logpath'\sic_Tables_7_outcomes_crit_a_b_c, statmat(p1_crit) ///
title("Table 6 - Meet criteria in p1 interview")  ///
rtitles("Overall n meet criteria n0 interview"\""\ "Died within 2 years and have exit interview" \ ///
""\"Meet criteria in p1 interview" \""\ "Do not meet criteria in p1 interview" \""\ ///
"Missing follow up interview, see notes"\"") ///
ctitles("" "Serious illness" "Criteria A" "Criteria B" "Criteria C" \ "" "n" "n" "n" "n" \ "" "(percent)" "(percent)" "(percent)" "(percent)" ) ///
note("Serious illness = Any serious medical illness" \ ///
"Criteria A = Any serious medical illness and/or ADL impairment" \ ///
"Criteria B = Criteria A and Urgent / Emergent hospitalization and/or NH resident" \ ///
"Criteria C = Medical illness and ADL Impairment and hospitalization and/or NH resident" \ ///
"Missing follow up if R died within 2 years of meet criteria but no exit interview,"  \ ///
"R did not die within 2 years, has no p1 interview," \ ///
"or R has p1 interview but not FFS MC 1 year preceding p1 interview.") ///
substat(1) sdec(0\1) addtable

***************************************************************
//looking at p1 outcomes, those R's that are alive and have p1 interview
***************************************************************
foreach crit in  a b c{
	use n0_n1_p1_p2_x_criteria_`crit'_v1.dta if core_year_n0<2012 & ///
		ind_p1_interview==1 & part_ab_12m_p1==1 & hmo_d_12m_p1==0
		
	mat p1_out_n=J(1,1,.)
	//get n that have p1 interview
	sum core_year_p1
	mat p1_out_n[1,1]=r(N) //overall n meet criteria, have p1 ivw
	mat rownames p1_out_n="N"
	
	frmttable, statmat(p1_out_n) store(t7_1) sdec(0)

la var core_to_dod_1yr_p1 "Died within 1 year, n (%)"
la var hs_admit_p12m_p1 "Enrolled in hospice, n (%)"
la var ind_em_ur_adm_p12m_p1 "Hospital admission, n (%)"
la var n_hospd_p12m_p1 "Hospital nights, mean (sd)"

la var ip_paid_by_mc_12m_wi_p1 "Inpatient"
la var snf_paid_by_mc_12m_wi_p1 "SNF"
la var hh_paid_by_mc_12m_wi_p1 "Home health" 
la var hs_paid_by_mc_12m_wi_p1 "Hospice" 
la var pb_paid_by_mc_12m_wi_p1 "Carrier"
la var op_paid_by_mc_12m_wi_p1 "Outpatient" 
la var dm_paid_by_mc_12m_wi_p1 "DME"
la var tot_paid_by_mc_12m_wi_p1 "Total"

local outcome1 core_to_dod_1yr_p1 hs_admit_p12m_p1 ind_em_ur_adm_p12m_p1

local outcome2 ip_paid_by_mc_12m_wi_p1 snf_paid_by_mc_12m_wi_p1 hh_paid_by_mc_12m_wi_p1 ///
hs_paid_by_mc_12m_wi_p1 pb_paid_by_mc_12m_wi_p1 op_paid_by_mc_12m_wi_p1 ///
dm_paid_by_mc_12m_wi_p1 tot_paid_by_mc_12m_wi_p1 

	mat p1_out_a=J(4,2,.)
	local r=1
	foreach v in `outcome1'{ //indicator vars, report n, percent
		sum `v', detail
		mat p1_out_a[`r',1]=r(mean)*r(N)
		mat p1_out_a[`r',2]=r(mean)*100
		local r = `r'+1
	}

	sum n_hospd_p12m_p1, detail //get mean, sd
	mat p1_out_a[`r',1]=r(mean)
	mat p1_out_a[`r',2]=r(sd)

	mat rownames p1_out_a=`outcome1' n_hospd_p12m_p1

	mat dmat=(0,1)
	mat ann=J(4,1,1)

	frmttable, statmat(p1_out_a) varlabels ///
		sdec(1) doubles(dmat) ///
		dbldiv(" (") annotate(ann) asymbol(")") ///
		store(t7_2) 

	foreach v in `outcome2'{ //spending vars, report mean, sd, and median
		sum `v', detail
		mat p1_out_b=J(1,2,.)
		mat p1_out_c=J(1,1,.)
		mat p1_out_b[1,1]=r(mean)
		mat p1_out_b[1,2]=r(sd)
		mat p1_out_c[1,1]=r(p50)
		
		local lbl: var label `v'
		label var `v' "`lbl' , mean (sd)"
		mat rownames p1_out_b=`v'

		frmttable, statmat(p1_out_b)  varlabels ///
			sdec(0) doubles(dmat) ///
			dbldiv(" (") annotate(ann) asymbol(")") ///
			append(t7_3_`crit') 

		label var `v' " median"
		mat rownames p1_out_c=`v'	
	
		frmttable, statmat(p1_out_c) varlabels ///
			sdec(0) append(t7_3_`crit')	
					
		}

	outreg, replay(t7_1) append(t7_2) store(t7_a)
	outreg, replay(t7_a) append(t7_3_`crit') store(t7_b_`crit')
}

outreg, replay(t7_b_smi) merge(t7_b_a) store(table7)
outreg, replay(table7) merge(t7_b_b) store(table7)
outreg using `logpath'\sic_Tables_7_outcomes_crit_a_b_c, ///
 replay(table7) merge(t7_b_c) addtable ///
 title("Table 7 - P1 interview outcomes, interview after first meet criteria")  ///
 ctitles("","Criteria A","Criteria B","Criteria C") ///
 note("Serious illness = Any serious medical illness" \ ///
 "Criteria A = Any serious medical illness and/or ADL impairment" \ ///
 "Criteria B = Criteria A and Urgent / Emergent hospitalization and/or NH resident" \ ///
 "Criteria C = Medical illness and ADL Impairment and hospitalization and/or NH resident" \ ///
 "Outcomes are for the 1 year after the p1 interview" \ ///
 "Sample limited to those with p1 core interview and FFS MC 1 year prior to p1 interview")
***************************************************************
//now table with 2 sections
//first rows are those that continue to meet the criteria in the p1 period
//second half are those that do not meet in the p1 period
frmttable, clear

foreach crit in a b c{
	clear
	use n0_n1_p1_p2_x_criteria_`crit'_v1.dta if core_year_n0<2012 & ///
		ind_p1_interview==1 & part_ab_12m_p1==1 & hmo_d_12m_p1==0
		
	mat p1_out_n=J(1,1,.)
	//get n that have p1 interview, overall n
	sum core_year_p1
	mat p1_out_n[1,1]=r(N) //overall n meet criteria, have p1 ivw
	mat rownames p1_out_n="N"
	
	frmttable, statmat(p1_out_n) store(t7_1) sdec(0)

la var core_to_dod_1yr_p1 "Died within 1 year, n (%)"
la var hs_admit_p12m_p1 "Enrolled in hospice, n (%)"
la var ind_em_ur_adm_p12m_p1 "Hospital admission, n (%)"
la var n_hospd_p12m_p1 "Hospital nights, mean (sd)"

la var ip_paid_by_mc_12m_wi_p1 "Inpatient"
la var snf_paid_by_mc_12m_wi_p1 "SNF"
la var hh_paid_by_mc_12m_wi_p1 "Home health" 
la var hs_paid_by_mc_12m_wi_p1 "Hospice" 
la var pb_paid_by_mc_12m_wi_p1 "Carrier"
la var op_paid_by_mc_12m_wi_p1 "Outpatient" 
la var dm_paid_by_mc_12m_wi_p1 "DME"
la var tot_paid_by_mc_12m_wi_p1 "Total"

local outcome1 core_to_dod_1yr_p1 hs_admit_p12m_p1 ind_em_ur_adm_p12m_p1

local outcome2 ip_paid_by_mc_12m_wi_p1 snf_paid_by_mc_12m_wi_p1 hh_paid_by_mc_12m_wi_p1 ///
hs_paid_by_mc_12m_wi_p1 pb_paid_by_mc_12m_wi_p1 op_paid_by_mc_12m_wi_p1 ///
dm_paid_by_mc_12m_wi_p1 tot_paid_by_mc_12m_wi_p1 

	//get n that have p1 interview, overall n
	sum core_year_p1 if criteria_`crit'_p1==1
	mat p1_out_n[1,1]=r(N) //overall n meet criteria, have p1 ivw and meet p1
	mat rownames p1_out_n="N meets criteria p1"
	
	frmttable, statmat(p1_out_n) append(t7_1) sdec(0) store(t7_1a)

	mat p1_out_a=J(4,2,.)
	local r=1
	foreach v in `outcome1'{ //indicator vars, report n, percent
		sum `v' if criteria_`crit'_p1==1, detail
		mat p1_out_a[`r',1]=r(mean)*r(N)
		mat p1_out_a[`r',2]=r(mean)*100
		local r = `r'+1
	}

	sum n_hospd_p12m_p1 if criteria_`crit'_p1==1, detail //get mean, sd
	mat p1_out_a[`r',1]=r(mean)
	mat p1_out_a[`r',2]=r(sd)

	mat rownames p1_out_a=`outcome1' n_hospd_p12m_p1

	mat dmat=(0,1)
	mat ann=J(4,1,1)

	frmttable, statmat(p1_out_a) varlabels ///
		sdec(1) doubles(dmat) ///
		dbldiv(" (") annotate(ann) asymbol(")") ///
		store(t7_2) 

	foreach v in `outcome2'{ //spending vars, report mean, sd, and median
		sum `v' if criteria_`crit'_p1==1, detail
		mat p1_out_b=J(1,2,.)
		mat p1_out_c=J(1,1,.)
		mat p1_out_b[1,1]=r(mean)
		mat p1_out_b[1,2]=r(sd)
		mat p1_out_c[1,1]=r(p50)
		
		local lbl: var label `v'
		label var `v' "`lbl' , mean (sd)"
		mat rownames p1_out_b=`v'

		frmttable, statmat(p1_out_b)  varlabels ///
			sdec(0) doubles(dmat) ///
			dbldiv(" (") annotate(ann) asymbol(")") ///
			append(t7_3_`crit'_1) 

		label var `v' " median"
		mat rownames p1_out_c=`v'	
	
		frmttable, statmat(p1_out_c) varlabels ///
			sdec(0) append(t7_3_`crit'_1)	
					
		}

	outreg, replay(t7_1a) append(t7_2) store(t7_a)
	outreg, replay(t7_a) append(t7_3_`crit'_1) store(t7_b_`crit'_a)

la var ip_paid_by_mc_12m_wi_p1 "Inpatient"
la var snf_paid_by_mc_12m_wi_p1 "SNF"
la var hh_paid_by_mc_12m_wi_p1 "Home health" 
la var hs_paid_by_mc_12m_wi_p1 "Hospice" 
la var pb_paid_by_mc_12m_wi_p1 "Carrier"
la var op_paid_by_mc_12m_wi_p1 "Outpatient" 
la var dm_paid_by_mc_12m_wi_p1 "DME"
la var tot_paid_by_mc_12m_wi_p1 "Total"	
	
	//section for those that don't meet criteria in p1	
	//get n that have p1 interview, overall n
	sum core_year_p1 if criteria_`crit'_p1==0
	mat p1_out_n[1,1]=r(N) //overall n meet criteria, have p1 ivw and don't meet p1
	mat rownames p1_out_n="N does not meet criteria p1"
	
	frmttable, statmat(p1_out_n) sdec(0) store(t7_1a)

	mat p1_out_a=J(4,2,.)
	local r=1
	foreach v in `outcome1'{ //indicator vars, report n, percent
		sum `v' if criteria_`crit'_p1==0, detail
		mat p1_out_a[`r',1]=r(mean)*r(N)
		mat p1_out_a[`r',2]=r(mean)*100
		local r = `r'+1
	}

	sum n_hospd_p12m_p1 if criteria_`crit'_p1==0, detail //get mean, sd
	mat p1_out_a[`r',1]=r(mean)
	mat p1_out_a[`r',2]=r(sd)

	mat rownames p1_out_a=`outcome1' n_hospd_p12m_p1

	mat dmat=(0,1)
	mat ann=J(4,1,1)

	frmttable, statmat(p1_out_a) varlabels ///
		sdec(1) doubles(dmat) ///
		dbldiv(" (") annotate(ann) asymbol(")") ///
		store(t7_2) 

	foreach v in `outcome2'{ //spending vars, report mean, sd, and median
		sum `v' if criteria_`crit'_p1==0, detail
		mat p1_out_b=J(1,2,.)
		mat p1_out_c=J(1,1,.)
		mat p1_out_b[1,1]=r(mean)
		mat p1_out_b[1,2]=r(sd)
		mat p1_out_c[1,1]=r(p50)
		
		local lbl: var label `v'
		label var `v' "`lbl' , mean (sd)"
		mat rownames p1_out_b=`v'

		frmttable, statmat(p1_out_b)  varlabels ///
			sdec(0) doubles(dmat) ///
			dbldiv(" (") annotate(ann) asymbol(")") ///
			append(t7_3_`crit'_0) 

		label var `v' " median"
		mat rownames p1_out_c=`v'	
	
		frmttable, statmat(p1_out_c) varlabels ///
			sdec(0) append(t7_3_`crit'_0)	
					
		}

	outreg, replay(t7_1a) append(t7_2) store(t7_a)
	outreg, replay(t7_a) append(t7_3_`crit'_0) store(t7_b_`crit'_b)
	
	outreg, replay(t7_b_`crit'_a) append(t7_b_`crit'_b) store(t7_b_`crit'_1)
}

outreg, replay(t7_b_smi_1) merge(t7_b_a_1) store(table7)
outreg, replay(table7) merge(t7_b_b_1) store(table7)
outreg using `logpath'\sic_Tables_7_outcomes_crit_a_b_c, ///
 replay(table7) merge(t7_b_c_1) addtable ///
 title("Table 8 - P1 interview outcomes, interview after first meet criteria" \ ///
 "Stratified by meeting criteria p1 interview period")  ///
 ctitles("","Criteria A","Criteria B","Criteria C") ///
 note("Serious illness = Any serious medical illness" \ ///
 "Criteria A = Any serious medical illness and/or ADL impairment" \ ///
 "Criteria B = Criteria A and Urgent / Emergent hospitalization and/or NH resident" \ ///
 "Criteria C = Medical illness and ADL Impairment and hospitalization and/or NH resident" \ ///
 "Outcomes are for the 1 year after the p1 interview" \ ///
 "Sample limited to those with p1 core interview and FFS MC 1 year prior to p1 interview")

	
***************************************************************
log close




H="Sig Tests - Tables 1,2"
/*Runs significant tests for:
Table 1 - Compares 2008 comparison group to Criteria A, B, C groups
Table 2 - Compares
	a. Condition only group to Criteria A, B, C groups
	b. 2008 comparison group to Criteria A, B, C groups

****Significance tests for Tables 1 and 2 for JAMA IM Submission April 2015 ****
*/

capture log close

clear all
set more off

local logpath E:\data\serious_ill\logs
local datapath2 E:\data\serious_ill\int_data
local datapath E:\data\serious_ill\final_data

log using "`logpath'\7b_compare_3_criteria_sig_test.txt", text replace

cd `datapath'

**********************************************************************
**********************************************************************
**********************************************************************
******************    Table 1 signfiicance tests   *******************
**********************************************************************
**********************************************************************
**********************************************************************

foreach crit in a b c {
use n0_n1_p1_p2_x_criteria_2008_v1.dta, clear
frmttable, clear(test1)
frmttable, clear(test1_all)


//meet criteria variables
tab criteria_a_n0, missing
tab criteria_b_n0, missing
tab criteria_c_n0, missing

gen no_crit = 0
replace no_crit=1 if criteria_a_n0==0 & criteria_b_n0==0 & criteria_c_n0==0 
la var no_crit "Criteria not met, 1=yes"
tab no_crit, missing

keep if no_crit==1

append using n0_n1_p1_p2_x_criteria_`crit'_v1.dta 

drop if core_year_n0==2010
tab no_crit criteria_`crit'_n0, missing

gen group_ind=1 if no_crit==1
replace group_ind=2 if criteria_`crit'_n0==1
tab group_ind, missing

//now test characteristics of the two groups, meet criteria vs 2008 comparison group
local cvars age_at_core_n0 networth_adj2010_n0

local ivars female_n0 re_black re_white re_hisp re_other_unk ///
educ_level_lt_hs educ_level_hs educ_level_somcol educ_level_col ///
srh_pf_n0 srh_g_n0 srh_ve_n0 married_n0 smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 ///
smi_diab_compl_ind_n0 smi_liver_ind_n0 /*smi_als_ind_n0*/ smi_hip_ind_n0 el_ge3_comorb_1yr_n0 ///
ser_med_illness_n0 adl_impair_core_n0 smi_and_adl_n0 smi_nh_ind_n0 ind_em_ur_adm_12m_n0 ///
adl_stable_ind_n0n1 adl_stable_partial_n0n1 adl_stable_severe_n0n1 ///
adl_change_i_m_n0n1 adl_change_i_s_n0n1 adl_change_m_s_n0n1 

di "********************************************************************"
di "********************************************************************"
di "Table 1 Test Criteria `c' vs Condition Only group"
di "********************************************************************"
di "********************************************************************"

mat test1=J(1,3,.)
foreach v in `cvars'{
ttest `v' , by(group_ind)
mat test1[1,1]=r(mu_1)
mat test1[1,2]=r(mu_2)
mat test1[1,3]=r(p)
mat rownames test1=`v'
frmttable, statmat(test1) append(test1_all) store(test1_all) nodisplay
}

foreach v in `ivars'{
tab `v' if group_ind==1, matcell(row1)
mat test1[1,1]=row1[2,1]/r(N)*100
tab `v' if group_ind==2, matcell(row2)
mat test1[1,2]=row2[2,1]/r(N)*100
tab `v' group_ind, chi2 matcell(row)
mat test1[1,3]=r(p)
mat rownames test1=`v'
frmttable, statmat(test1) append(test1_all) store(test1_all) nodisplay
}

frmttable, replay(test1_all) ///
title("Significance test Criteria `crit' group vs 2008 Comparison group") ///
ctitles("" "Comparison group" "Criteria `crit' group" "P-value")

}


**********************************************************************
**********************************************************************
**********************************************************************
******************    Table 2 signfiicance tests   *******************
**********************************************************************
**********************************************************************
**********************************************************************
//Part 1 - Comparing Condition Only group Outcomes to A,B,C

la var core_to_dod_1yr_n0 "Died, n (%)"
la var ind_em_ur_adm_p12m_n0 "Hospital admission, n (%)"

la var tot_paid_by_mc_12m_wi_n0 "Total MC costs, mean (sd)"
la var cost_mos_n0 "Costs per month, mean (sd)"

foreach crit in a b c {
use n0_n1_p1_p2_x_criteria_smi_v1.dta, clear
frmttable, clear(test2)
frmttable, clear(test2_all)

//meet criteria variables
tab criteria_smi_n0 criteria_a_n0, missing
tab criteria_smi_n0 criteria_b_n0, missing
tab criteria_smi_n0 criteria_c_n0, missing

append using n0_n1_p1_p2_x_criteria_`crit'_v1.dta , gen(group_ind)

drop if core_year_n0==2010
tab criteria_smi_n0 criteria_`crit'_n0, missing

tab group_ind, missing

//now test characteristics of the two groups, meet criteria vs Condition Only group
local cvars cost_mos_n0 tot_paid_by_mc_12m_wi_n0 

local ivars ind_em_ur_adm_p12m_n0 core_to_dod_1yr_n0

di "********************************************************************"
di "********************************************************************"
di "Table 2 Test Criteria `c' vs Condition Only group"
di "********************************************************************"
di "********************************************************************"

mat test2=J(1,3,.)
foreach v in `cvars'{
ttest `v' , by(group_ind)
mat test2[1,1]=r(mu_1)
mat test2[1,2]=r(mu_2)
mat test2[1,3]=r(p)
mat rownames test2=`v'
frmttable, statmat(test2) append(test2_all) store(test2_all) nodisplay
}

//now median for total mc payments
mat test2=J(1,3,.)
sum tot_paid_by_mc_12m_wi_n0 if group_ind==0, detail
mat test2[1,1]=r(p50)
sum tot_paid_by_mc_12m_wi_n0 if group_ind==1, detail
mat test2[1,2]=r(p50)
qreg tot_paid_by_mc_12m_wi_n0 group_ind
test group_ind
mat test2[1,3]=r(p)
mat rownames test2="Total MC spending, median"
frmttable, statmat(test2) append(test2_all) store(test2_all) nodisplay

foreach v in `ivars'{
tab `v' if group_ind==0, matcell(row1)
mat test2[1,1]=row1[2,1]/r(N)*100
tab `v' if group_ind==1, matcell(row2)
mat test2[1,2]=row2[2,1]/r(N)*100
tab `v' group_ind, chi2 matcell(row)
mat test2[1,3]=r(p)
mat rownames test2=`v'
frmttable, statmat(test2) append(test2_all) store(test2_all) nodisplay
}

frmttable, replay(test2_all) ///
title("Significance test -  Criteria `crit' group vs Condition Only group") ///
ctitles("" "Condition only group" "Criteria `crit' group" "P-value")
}
****************************************************************
//Part 2 - Comparing 2008 Comparison group Outcomes to A,B,C

la var core_to_dod_1yr_n0 "Died, n (%)"
la var ind_em_ur_adm_p12m_n0 "Hospital admission, n (%)"

la var tot_paid_by_mc_12m_wi_n0 "Total MC costs, mean (sd)"
la var cost_mos_n0 "Costs per month, mean (sd)"

foreach crit in a b c {
use n0_n1_p1_p2_x_criteria_2008_v1.dta, clear
frmttable, clear(test2)
frmttable, clear(test2_all)

//meet criteria variables
tab criteria_a_n0, missing
tab criteria_b_n0, missing
tab criteria_c_n0, missing

gen no_crit = 0
replace no_crit=1 if criteria_a_n0==0 & criteria_b_n0==0 & criteria_c_n0==0 
la var no_crit "Criteria not met, 1=yes"
tab no_crit, missing

keep if no_crit==1

append using n0_n1_p1_p2_x_criteria_`crit'_v1.dta , gen(group_ind)

drop if core_year_n0==2010
tab group_ind criteria_`crit'_n0, missing

tab group_ind, missing

//now test characteristics of the two groups, meet criteria vs 2008 comparison group
local cvars cost_mos_n0 tot_paid_by_mc_12m_wi_n0 

local ivars ind_em_ur_adm_p12m_n0 core_to_dod_1yr_n0

di "********************************************************************"
di "********************************************************************"
di "Table 2 Test Criteria `c' vs 2008 Comparison group"
di "********************************************************************"
di "********************************************************************"


mat test2=J(1,3,.)
foreach v in `cvars'{
ttest `v' , by(group_ind)
mat test2[1,1]=r(mu_1)
mat test2[1,2]=r(mu_2)
mat test2[1,3]=r(p)
mat rownames test2=`v'
frmttable, statmat(test2) append(test2_all) store(test2_all) nodisplay
}

//now median for total mc payments
mat test2=J(1,3,.)
sum tot_paid_by_mc_12m_wi_n0 if group_ind==0, detail
mat test2[1,1]=r(p50)
sum tot_paid_by_mc_12m_wi_n0 if group_ind==1, detail
mat test2[1,2]=r(p50)
qreg tot_paid_by_mc_12m_wi_n0 group_ind
test group_ind
mat test2[1,3]=r(p)
mat rownames test2="Total MC spending, median"
frmttable, statmat(test2) append(test2_all) store(test2_all) nodisplay

foreach v in `ivars'{
tab `v' if group_ind==0, matcell(row1)
mat test2[1,1]=row1[2,1]/r(N)*100
tab `v' if group_ind==1, matcell(row2)
mat test2[1,2]=row2[2,1]/r(N)*100
tab `v' group_ind, chi2 matcell(row)
mat test2[1,3]=r(p)
mat rownames test2=`v'
frmttable, statmat(test2) append(test2_all) store(test2_all) nodisplay
}

frmttable, replay(test2_all) ///
title("Significance test -  Criteria `crit' group vs 2008 Comparison group") ///
ctitles("" "2008 Comparison group" "Criteria `crit' group" "P-value")
}

log close


H="Tables - Hospital use required in CHF, COPD criteria"
/*A hospital stay is required for flagging an R as having CHF or COPD
since (at least part of) the definition requires the diagnosis to be
the primary diagnosis from an inpatient claim

Look at outcomes to see if this really matters by checking outcomes
with and without inclusion of these criteria

Creates 3 tables, one for each of the criteria*/

capture log close

clear all
set more off

local logpath E:\data\serious_ill\logs
local datapath2 E:\data\serious_ill\int_data
local datapath E:\data\serious_ill\final_data

log using "`logpath'\8_compare_3_criteria_copd_chf.txt", text replace

cd `datapath'

****************************************************
local outcome1 core_to_dod_1yr_n0 hs_admit_p12m_n0 ind_em_ur_adm_p12m_n0

local outcome2 ip_paid_by_mc_12m_wi_n0 snf_paid_by_mc_12m_wi_n0 hh_paid_by_mc_12m_wi_n0 hs_paid_by_mc_12m_wi_n0 ///
pb_paid_by_mc_12m_wi_n0 op_paid_by_mc_12m_wi_n0 dm_paid_by_mc_12m_wi_n0 tot_paid_by_mc_12m_wi_n0 n_hospd_p12m_n0

foreach crit in a b c{
	clear
	use n0_n1_p1_p2_x_criteria_`crit'_v1.dta if core_year_n0<2010

	mat crit_`crit'=J(34,3,.)

	mat cont=J(34,6,.) //matrix of mean, n, and variance for manually calculating p-value
		//continuous variables


//first row, n for each category
//indicator that copd or chf diagnosis is required is created in Step 12
	sum core_year_n0
	mat crit_`crit'[1,1]=r(N) //copd or chf included, full sample
	mat cont[1,1]=r(N)

	tab meet_`crit'_copd_chf_req_n0, missing matcell(row1)
	mat crit_`crit'[1,2]=row1[1,1] //copd or chf is not required, limited sample
	mat cont[1,2]=row1[1,1]

//first column, full sample including copd/chf as criteria
local c=1
local r=2
foreach v in `outcome1'{
	sum `v' , detail
	mat crit_`crit'[`r',`c']=r(mean)
	mat crit_`crit'[`r'+1,`c']=r(sd)
	local r=`r'+2 //populates rows 2-7 for indicator variable outcomes
	}

local r=8
foreach v in `outcome2'{
	sum `v', detail
	mat crit_`crit'[`r',`c']=r(mean)
	mat cont[`r',`c']=r(mean)
	mat crit_`crit'[`r'+1,`c']=r(p50)
	mat cont[`r'+1,`c']=r(sd)
	mat crit_`crit'[`r'+2,`c']=r(sd)
	local r=`r'+3 //populates rows 8-34 for continuous variables
	}

//second column, excluding obs where copd / chf is only reason why meet criteria
local c=2
local r=2
foreach v in `outcome1'{
	sum `v' if meet_`crit'_copd_chf_req_n0==0, detail
	mat crit_`crit'[`r',`c']=r(mean)
	mat crit_`crit'[`r'+1,`c']=r(sd)
	local r=`r'+2 //populates rows 2-7 for indicator variable outcomes
	}

local r=8
foreach v in `outcome2'{
	sum `v' if meet_`crit'_copd_chf_req_n0==0, detail
	mat crit_`crit'[`r',`c']=r(mean)
	mat cont[`r',`c']=r(mean)
	mat crit_`crit'[`r'+1,`c']=r(p50)
	mat cont[`r'+1,`c']=r(sd)
	mat crit_`crit'[`r'+2,`c']=r(sd)
	local r=`r'+3 //populates rows 8-34 for continuous variables
	}


//pvalues comparing outcomes
//have to manually compute p values

//new matrices for n's of categorical variables
mat cat_1=J(2,2,.)
mat cat_2=J(2,2,.)
mat cat_3=J(2,2,.)

local i = 1
foreach v in `outcome1'{
	tab `v' , matcell(xx)
	mat cat_`i'[1,1]=xx[1,1]
	mat cat_`i'[2,1]=xx[2,1]

	tab `v' if meet_`crit'_copd_chf_req_n0==0, matcell(xx)
	mat cat_`i'[1,2]=xx[1,1]
	mat cat_`i'[2,2]=xx[2,1]
	local i=`i'+1 
	}

local c = 3
mat cat=J(7,2,.)
forvalues r = 2(2)6{
	local i = `r'/2
	mat cat[`r',1]=((cat_`i'[1,1]*cat_`i'[2,2]-cat_`i'[1,2]*cat_`i'[2,1])^2*(cat_`i'[1,1]+cat_`i'[1,2]+cat_`i'[2,1]+cat_`i'[2,2])) / ///
	((cat_`i'[1,1]+cat_`i'[1,2])*(cat_`i'[2,1]+cat_`i'[2,2])*(cat_`i'[1,2]+cat_`i'[2,2])*(cat_`i'[1,1]+cat_`i'[2,1])) //chisq stat
	mat cat[`r',2]= chi2tail(1,cat[`r',1]) //p-value

	mat crit_`crit'[`r',`c']=cat[`r',2]
	}

local r=8

forvalues r = 8(3)32{
	mat cont[`r',3]=sqrt(((cont[1,1]-1)*cont[`r'+1,1]^2+(cont[1,2]-1)*cont[`r'+1,2]^2) / (cont[1,1]+cont[1,2]-2))  //col 3 = pooled sd
	mat cont[`r',4]=(cont[`r',1]-cont[`r',2])/(cont[`r',3]*sqrt(1/cont[1,1]+1/cont[1,2])) //t-statistic
	mat cont[`r',5]=cont[1,1]+cont[1,2]-2 //dof
	mat cont[`r',6]=tprob(cont[`r',5],cont[`r',4]) //p-value
	}

forvalues r = 8(3)32{
	mat crit_`crit'[`r',`c']=cont[`r',6]
	}

mat rownames crit_`crit'="N" "Died, mean" "SD" "Hospice enr, mean" "SD" "Emerg or urgent hosp admit, mean" "SD" ///
"IP MC, mean" "Median" "SD" "SNF MC, mean" "Median" "SD" ///
"HH MC, mean" "Median" "SD" "Hospice MC, mean" "Median" "SD" ///
"Carrier MC, mean" "Median" "SD" "OP MC, mean" "Median" "SD" ///
"DME MC, mean" "Median" "SD" "Total MC, mean" "Median" "SD" ///
"Hospital nights, mean" "Median" "SD"

}

frmttable using "`logpath'\sic_Table8_outcomes_copd_chf", statmat(crit_a) ///
title("Comparison of outcomes at 1 year, criteria A" \ ///
"First interview when R meets criteria" \ ///
"Criteria including CHF &COPD definitions vs excluding them") ///
ctitle("" "CHF and COPD included" "CHF and COPD Excluded" "P-value") ///
note("Medicare spending adjusted for inflation and the CMS wage index." \ ///
"Criteria A = Serious medical illness and/or ADL impairment.") ///
sdec(2,2,3) replace

frmttable using "`logpath'\sic_Table8_outcomes_copd_chf", statmat(crit_b) ///
title("Comparison of outcomes at 1 year, criteria B" \ ///
"First interview when R meets criteria" \ ///
"Criteria including CHF &COPD definitions vs excluding them") ///
ctitle("" "CHF and COPD included" "CHF and COPD Excluded" "P-value") ///
note("Medicare spending adjusted for inflation and the CMS wage index" \ ///
"Criteria B = Criteria A and Nursing home resident and/or hospitalization") ///
sdec(2,2,3) addtable

frmttable using "`logpath'\sic_Table8_outcomes_copd_chf", statmat(crit_c) ///
title("Comparison of outcomes at 1 year, criteria C" \ ///
"First interview when R meets criteria" \ ///
"Criteria including CHF &COPD definitions vs excluding them") ///
ctitle("" "CHF and COPD included" "CHF and COPD Excluded" "P-value") ///
note("Medicare spending adjusted for inflation and the CMS wage index" \ ///
"Criteria C = Medical illness and ADL impairment and Nursing Home res and/or hospitalization.") ///
sdec(2,2,3) addtable

****************************************************
log close


H="Bar graph - p1 outcomes, criteria a,b,c"
/*Bar graphs comparing p1 outcomes of the 3 criteria

Note, this requires manual set up of data once its exported
into 3 separate .csv files*/

capture log close

clear all
set mem 500m
set more off

local logpath E:\data\serious_ill\logs
local datapath2 E:\data\serious_ill\int_data
local datapath E:\data\serious_ill\final_data

log using "`logpath'\9_bar_graph_p1_outcomes.txt", text replace

cd `datapath'

****************************************************

foreach crit in a b c{
	clear
	use n0_n1_p1_p2_x_criteria_`crit'_v1.dta if core_year_n0<2010

	//drop those R's that do not have p1 follow up at all
	gen p1_miss = 0
	replace p1_miss = 1 if (core_to_dod_2yr_n0==1 & ind_x_interview==0) | ///
		(core_to_dod_2yr_n0==0 & ind_p1_interview==0) | ///
		(core_to_dod_2yr_n0==0 & ind_p1_interview==1 & (part_ab_12m_p1!=1 | hmo_d_12m_p1!=0))
	tab p1_miss, missing
	drop if p1_miss==1

	//create indicators for each of the remaining 3 outcome possibilities
	gen p1_exit = 0
	replace p1_exit = 1 if ind_p1_interview==0 & core_to_dod_2yr_n0==1 & ind_x_interview==1
	
	gen p1_meet = 0
	replace p1_meet = 1 if criteria_`crit'_p1==1 & ind_p1_interview==1 & part_ab_12m_p1==1 & hmo_d_12m_p1==0
	
	gen p1_notmeet = 0
	replace p1_notmeet = 1 if criteria_`crit'_p1==0 & ind_p1_interview==1 & part_ab_12m_p1==1 & hmo_d_12m_p1==0
			
collapse (mean) p1_exit	p1_meet	p1_notmeet (count) criteria_`crit'_n0
list

//export excel `datapath'\excel_means_`crit', replace
outsheet using `datapath'\excel_means_`crit'.csv, comma replace
}
****************************************************
// Need to manually combine the 3 csv files into a single file
// with different criteria being different observations
****************************************************
clear

insheet using `datapath'\import_means.csv

sum n if _n==1
local n_a = r(mean)

sum n if _n==2
local n_b = r(mean)

sum n if _n==3
local n_c = r(mean)

graph hbar p1_exit p1_meet p1_notmeet , over(v1) percentage stack ///
	blabel(bar, position(center) format(%3.1f)) ///
	legend(lab(1 "Expired") lab(2 "Meets criteria p1") ///
	lab(3 "Does not meet criteria p1")) ///
	text(-1 79 "n=`n_a'", place(w)) ///
	text(-1 44 "n=`n_b'", place(w)) ///
	text(-1 9 "n=`n_c'", place(w)) ///
	title("P1 interview outcomes for R's with follow-up interview")
	
graph save `logpath'\bar_graph_p1_status, replace	


****************************************************
log close


H="Looking at dementia indicator"
/*Looking at dementia diagnosis and related HRS cognitive function variables*/

capture log close

clear all
set mem 500m
set more off

local logpath E:\data\serious_ill\logs
local datapath2 E:\data\serious_ill\int_data
local datapath E:\data\serious_ill\final_data

log using "`logpath'\10_compare_3_criteria_dementia.txt", text replace

cd `datapath'

****************************************************
mat dem=J(29,6,.)

local c=1
foreach crit in a b c{
	clear
	use n0_n1_p1_p2_x_criteria_`crit'_v1.dta if core_year_n0<2010 & meet_`crit'_dement_req_n0==1

	//lookinga t tics distribution
	sum core_year_n0
	mat dem[1,`c'] = r(N)
	tab proxy_core_n0, matcell(pr)
	mat dem[2,`c'] = pr[1,1] //not proxy interviews
	mat dem[2,`c'+1] = pr[2,1] //proxy interviews
	
	tab tics_cat_n0 proxy_core_n0, missing matcell(tics_`crit')
	mat dem[3,`c']=tics_`crit'[4,1]/dem[2,`c']*100  //missing
	mat dem[4,`c']=tics_`crit'[1,1]/dem[2,`c']*100 //normal
	mat dem[5,`c']=tics_`crit'[2,1]/dem[2,`c']*100 //mci
	mat dem[6,`c']=tics_`crit'[3,1]/dem[2,`c']*100 //demented
	
	mat dem[3,`c'+1]=tics_`crit'[4,2]/dem[2,`c'+1]*100  //missing
	mat dem[4,`c'+1]=tics_`crit'[1,2]/dem[2,`c'+1]*100 
	mat dem[5,`c'+1]=tics_`crit'[2,2]/dem[2,`c'+1]*100 
	mat dem[6,`c'+1]=tics_`crit'[3,2]/dem[2,`c'+1]*100 

	sum memory_hrs_n0 if proxy_core_n0==0
	mat dem[7,`c']=r(mean)*100  //missing
	
	sum memory_hrs_n0 if proxy_core_n0==1
	mat dem[7,`c'+1]=r(mean)*100  //missing	
	
	tab sr_memory_n0 proxy_core_n0,  missing matcell(ind_`crit')
	local r = 8
	forvalues i = 1/6{
		mat dem[`r',`c']=ind_`crit'[`i',1]/dem[2,`c']*100 
		mat dem[`r',`c'+1]=ind_`crit'[`i',2]/dem[2,`c'+1]*100 
		local r = `r'+1
	}
	
	tab sr_mem_change_n0 proxy_core_n0,  missing matcell(ind_`crit')
	local r = 14
	forvalues i = 1/4{
		mat dem[`r',`c']=ind_`crit'[`i',1]/dem[2,`c']*100 
		mat dem[`r',`c'+1]=ind_`crit'[`i',2]/dem[2,`c'+1]*100 
		local r = `r'+1
	}

	tab pr_memory_n0 proxy_core_n0,  missing matcell(ind_`crit')
	local r = 18
	forvalues i = 1/6{
		mat dem[`r',`c']=ind_`crit'[`i',1]/dem[2,`c']*100 
		mat dem[`r',`c'+1]=ind_`crit'[`i',2]/dem[2,`c'+1]*100 
		local r = `r'+1
	}
	
	tab pr_mem_change_n0 proxy_core_n0,  missing matcell(ind_`crit')
	local r = 24
		mat dem[`r',`c']=0 //no obs report 1 = better
		mat dem[`r',`c'+1]=0 
	
	local r = 25
	forvalues i = 1/3{
		mat dem[`r',`c']=ind_`crit'[`i',1]/dem[2,`c']*100 
		mat dem[`r',`c'+1]=ind_`crit'[`i',2]/dem[2,`c'+1]*100 
		local r = `r'+1
	}
	

	//have only 1 vs more than 1 dementia diagnosis
	gen dem_dx_gt1 = 0 if dem_dx_1yr_n0 ==1
	replace dem_dx_gt1 = 1 if dem_dx_1yr_n0>1 & dem_dx_1yr_n0!=.
	tab dem_dx_1yr_n0, missing
	tab dem_dx_gt1, missing //left as missing for those with no dementia dx

	tab dem_dx_gt1 proxy_core_n0,  missing matcell(ind_`crit')
	local r = 28
	//no observations have 1 dementia diagnosis and still meet criteria so manually fill in
		mat dem[`r',`c']=0 
		mat dem[`r',`c'+1]=0 
	local r = 29
		mat dem[`r',`c']=ind_`crit'[1,1]/dem[2,`c']*100 
		mat dem[`r',`c'+1]=ind_`crit'[1,2]/dem[2,`c'+1]*100 

		local c = `c'+2
	}

mat list dem
	
frmttable using "`logpath'\sic_Table10_dementia", statmat(dem) ///
title("Looking at Dementia Serious Illness Criteria" \ ///
"First interview when R meets criteria") ///
ctitle("" "Criteria A" "" "Criteria B" "" "Criteria C" "" \ ///
"" "Self ivw" "Proxy Ivw" "Self ivw" "Proxy Ivw" "Self ivw" "Proxy Ivw"  ) ///
rtitle("N overall" \ "N" \ "TICS missing" \ "TICS Normal >8, %" \ "MCI 5-8"\ "Demented 0-4" \ ///
"HRS Memory disease, % yes" \ "Self-rate memory 1= Excellent" \ "2=Very good" \ ///
"3=Good" \ "4=Fair" \ "5=Poor" \ "Missing" \ "Self-rate memory change 1=Better" \ ///
"2=Same" \ "3=Worse" \ "Missing" \ "Proxy-rate memory 1= Excellent" \ "2=Very good" \ ///
"3=Good" \ "4=Fair" \ "5=Poor" \ "Missing" \ "Proxy-rate memory change 1=Better" \ ///
"2=Same" \ "3=Worse" \ "Missing" \ "Only 1 dementia dx" \ "More than 1 dementia dx") ///
note("Criteria A = Serious medical illness and/or ADL impairment." \ ///
"Looking at R's where dementia diagnosis is required to meet criteria." \ ///
"Dementia diagnosis counts are for 1 year preceding the core interview.") ///
sdec(0\0\1) replace

****************************************************
log close


H="2008 survey, crit a,b,c vs none"
/*Looking at criteria a,b,c vs none for 2008 interview year*/

capture log close
clear all
set mem 500m
set more off

local logpath E:\data\serious_ill\logs
local datapath2 E:\data\serious_ill\int_data
local datapath E:\data\serious_ill\final_data

log using "`logpath'\11_2008_core_year_crit_vs_none.txt", text replace

cd `datapath2'

use ivws_crit_1.dta if core_year==2008 & /// 
age_ge_65==1 & xwalk_yes==1 & part_ab_12m==1 & hmo_d_12m==0
***************************************************************
//meet criteria variables
tab criteria_a, missing
tab criteria_b, missing
tab criteria_c, missing

gen no_crit = 0
replace no_crit=1 if criteria_a==0 & criteria_b==0 & criteria_c==0 
la var no_crit "Criteria not met, 1=yes"
tab no_crit, missing

//define another criteria - medical illness and ADL impairment (no utilization requirement)
tab smi_and_adl, missing
tab smi_and_adl criteria_a, missing
***************************************************************
//Table 1, do we identify high spenders?
sum core_year
local samp=r(N)

mat tab1_1=J(2,5,.)
local r = 1
local c = 1
foreach crit of varlist criteria_a criteria_b smi_and_adl criteria_c no_crit {
	sum `crit', detail
	mat tab1_1[`r',`c']=r(mean)*r(N) //first row = n
	mat tab1_1[`r'+1,`c']=r(mean)*100 //first row = n
	local c = `c'+1
}

mat rownames tab1_1="N" "% of 2008 R's"
frmttable, statmat(tab1_1) sdec(0\2) store(tab1_a)

//identify top 5 and 10% of spenders in 2008, 1 year post
sum tot_paid_by_mc_12m_wi, detail
local top5pct=r(p95)
local top10pct=r(p90)

foreach i in 5 10{
gen ind_top`i'pct=.
replace ind_top`i'pct=1 if tot_paid_by_mc_12m_wi>=`top`i'pct' & tot_paid_by_mc_12m_wi!=.
replace ind_top`i'pct=0 if tot_paid_by_mc_12m_wi<`top`i'pct' & tot_paid_by_mc_12m_wi!=.
tab ind_top`i'pct, missing
sum tot_paid_by_mc_12m_wi if ind_top`i'pct==1
sum tot_paid_by_mc_12m_wi if ind_top`i'pct==0
la var ind_top`i'pct "Top `i'% Medicare spending"
}

foreach i in 5 10{
	mat tab1_`i'=J(6,5,.)
	local c = 1
		foreach crit of varlist criteria_a criteria_b smi_and_adl criteria_c no_crit {
		//of top 5% how many are in criteria category?
			sum `crit' if ind_top`i'pct==1 
			mat tab1_`i'[1,`c']=r(mean)*100 //percent
			sum `crit' if ind_top`i'pct==1 & core_to_dod_1yr==1
			mat tab1_`i'[2,`c']=r(mean)*100 //percent
			sum `crit' if ind_top`i'pct==1 & core_to_dod_1yr==0
			mat tab1_`i'[3,`c']=r(mean)*100 //percent
			
			//now of those that meet criteria, how many are in top 5%?
			sum ind_top`i'pct if `crit'==1 
			mat tab1_`i'[4,`c']=r(mean)*100 //percent
			sum ind_top`i'pct if `crit'==1 & core_to_dod_1yr==1
			mat tab1_`i'[5,`c']=r(mean)*100 //percent
			sum ind_top`i'pct if `crit'==1 & core_to_dod_1yr==0
			mat tab1_`i'[6,`c']=r(mean)*100 //percent
			
			local c = `c'+1
		}
	mat rownames tab1_`i'="% top `i'% MC spending" "died" ///
		"did not die" ///
		"% meet crit in top `i'% spend" "died" "did not die"
	
	frmttable, statmat(tab1_`i') sdec(2) store(tab1_`i')
	}
	
outreg, replay(tab1_a) append(tab1_5) store(tab1_b)

outreg using `logpath'\sic_Tables_11_2008_wave_crit_a_b_c, ///
	replay(tab1_b) append(tab1_10) ///
	ctitles("","Criteria A","Criteria B","Crit B-2","Criteria C","None") ///
	title("Identifying top spenders, 2008 Interview Wave n=`samp'") ///
	note("Criteria A = Any serious medical illness and/or ADL impairment" \ ///
	"Criteria B = Criteria A and Urgent / Emergent hospitalization and/or NH resident" \ ///
	"Criteria B-2 = Medical illness and ADL Impairment, no util requirement" \ ///
	"Criteria C = Medical illness and ADL Impairment and hospitalization and/or NH resident" \ ///
	"Top spenders defined as top 5 or 10% of overall Medicare spending in the 1 year following" \ ///
	"the 2008 interview within this sample.") ///
	replace

//quick look at distribution of total medicare spending	
sum tot_paid_by_mc_12m_wi, detail
return list

mat mc=J(8,1,.)

local r=1
foreach s in N mean sd p50 p90 p95 min max{
mat mc[`r',1]=r(`s')
local r = `r'+1
}
mat list mc
mat rownames mc="N" "mean" "SD" "Median" "90%" "95%" "min" "max"
frmttable using `logpath'\sic_Tables_11_2008_wave_crit_a_b_c, statmat(mc) ///
	title("Distribution total Medicare spending, 2008 Interview Wave") ///
	note("Wage index and inflation adjusted Medicare spending" \ ///
	"Total across all claim types, 1 year after 2008 interview") ///
	addtable
	
//who are the top 5% of spenders??
local cvars ip_paid_by_mc_12m_wi snf_paid_by_mc_12m_wi hh_paid_by_mc_12m_wi hs_paid_by_mc_12m_wi ///
pb_paid_by_mc_12m_wi op_paid_by_mc_12m_wi dm_paid_by_mc_12m_wi tot_paid_by_mc_12m_wi ///
age_at_core networth_adj2010

local ivars female black white hisp ///
srh_pf srh_g srh_ve married smi_dem_ind smi_cancer_ind smi_esrd_ind ///
smi_chf_ind smi_copd_ind ///
smi_diab_compl_ind smi_liver_ind smi_als_ind smi_hip_ind ///
ser_med_illness adl_impair_core smi_and_adl smi_nh_ind ind_em_ur_adm_12m ///


mat tab1 = J(32,4,.)
mat tab1n = J(1,4,.)

	//assign variable names for use in the tables
la var ip_paid_by_mc_12m_wi "Inpatient"
la var snf_paid_by_mc_12m_wi "SNF"
la var hh_paid_by_mc_12m_wi "Home health" 
la var hs_paid_by_mc_12m_wi "Hospice" 
la var pb_paid_by_mc_12m_wi "Carrier"
la var op_paid_by_mc_12m_wi "Outpatient" 
la var dm_paid_by_mc_12m_wi "DME"
la var tot_paid_by_mc_12m_wi "Total"	
	
label var age_at_core "Age, mean (SD)"
label var networth_adj2010 "Net worth, mean (SD)"
label var female "Female, n (%)"
label var black "Black, n (%)"
label var white "non-Hispanic White, n (%)"
label var hisp "Hispanic, n (%)"

label var srh_pf "Poor/Fair, n (%)"
label var srh_g "Good, n (%)"
label var srh_ve "Very good/Excellent, n (%)"

label var married "Married, n (%)"
label var smi_dem_ind "Dementia, n (%)"
label var smi_cancer_ind "Cancer, n (%)"
label var smi_esrd_ind "ESRD, n (%)"
label var smi_chf_ind "CHF, n (%)"
label var smi_copd_ind "COPD, n (%)"

label var smi_diab_compl_ind "Diabetes, n (%)"
label var smi_liver_ind "Liver disease, n (%)"
label var smi_als_ind "ALS, n (%)"
label var smi_hip_ind "Hip Fracture, n (%)"
label var ser_med_illness "Any serious medical illness, n (%)"
label var adl_impair_core "ADL Impairment, n (%)"

label var smi_and_adl "Medical illness & ADL Impair., n (%)"
label var smi_nh_ind "Nursing home resident, n (%)"
label var ind_em_ur_adm_12m "Hospital admission, n (%)"
	
local c = 1	
foreach i in 1 0{	
	local r = 1
	foreach v in `cvars'{
		sum `v' if ind_top5pct==`i', detail
		mat tab1[`r',`c']=r(mean)
		mat tab1[`r',`c'+1]=r(sd)
		local r = `r'+1
	}

	foreach v in `ivars'{
	sum `v' if ind_top5pct==`i'
	mat tab1[`r',`c']=r(mean)*r(N) //n
	mat tab1[`r',`c'+1]=r(mean)*100 //percent
	local r = `r'+1
	}

	//n for last row
	sum core_year if ind_top5pct==`i'
	mat tab1n[1,`c']=r(N)
	
	local c = `c'+2
}

mat tab1n_2 = J(1,3,.)

mat tab1n_2[1,1]=tab1n[1,1]
mat tab1n_2[1,2]=tab1n[1,3]
mat tab1n_2[1,3]=tab1n[1,5]

mat rownames tab1=`cvars' `ivars'

mat list tab1
mat list tab1n_2

//save the table in frmttable	
mat dmat=(0,1,0,1)
mat ann=J(27,3,1)

frmttable, statmat(tab1) varlabels ///
	sdec(1\0\1) doubles(dmat) ///
	dbldiv(" (") annotate(ann) asymbol(")") ///
	store(tab1_1) 	

frmttable, statmat(tab1n_2) ///
	sdec(0)	store(tab1_2) ///
	rtitles("N")

//outreg, replay(tab1_a) merge(tab1_b) store(tab1_ab)
//outreg, replay(tab1_ab) merge(tab1_c) store(tab1_abc)

outreg using `logpath'\sic_Tables_11_2008_wave_crit_a_b_c, ///
	replay(tab1_1) append(tab1_2) ///
	ctitles("","Top 5%","Bottom 95%") ///
	title("2008 Interviews, Looking at top 5% of spenders")  ///
	note("Criteria A = Any serious medical illness and/or ADL impairment" \ ///
	"Criteria B = Criteria A and Urgent / Emergent hospitalization and/or NH resident" \ ///
	"Criteria C = Medical illness and ADL Impairment and hospitalization and/or NH resident") ///
	addtable

	
***************************************************************
//Table 2 - looking at outcomes
//table of 1 year outcomes for the 4 categories, not mutually exclusive groups
local outcome1 core_to_dod_1yr hs_admit_p12m ind_em_ur_adm_p12m

local outcome3 n_hospd_p12m

local outcome2 ip_paid_by_mc_12m_wi snf_paid_by_mc_12m_wi hh_paid_by_mc_12m_wi hs_paid_by_mc_12m_wi ///
pb_paid_by_mc_12m_wi op_paid_by_mc_12m_wi dm_paid_by_mc_12m_wi tot_paid_by_mc_12m_wi

la var core_to_dod_1yr "Died, n (%)"
la var hs_admit_p12m "Enrolled in hospice, n (%)"
la var ind_em_ur_adm_p12m "Hospital admission, n (%)"
la var n_hospd_p12m "Hospital nights, mean (sd)"

la var ip_paid_by_mc_12m_wi "Inpatient"
la var snf_paid_by_mc_12m_wi "SNF"
la var hh_paid_by_mc_12m_wi "Home health" 
la var hs_paid_by_mc_12m_wi "Hospice" 
la var pb_paid_by_mc_12m_wi "Carrier"
la var op_paid_by_mc_12m_wi "Outpatient" 
la var dm_paid_by_mc_12m_wi "DME"
la var tot_paid_by_mc_12m_wi "Total"

mat table2_n=J(1,4,.)
//row of n for each category
tab criteria_a ,matcell(row1a)
mat table2_n[1,1]=row1a[2,1]
tab criteria_b ,matcell(row1b)
mat table2_n[1,2]=row1b[2,1]
tab criteria_c ,matcell(row1c)
mat table2_n[1,3]=row1c[2,1]
tab no_crit ,matcell(row1d)
mat table2_n[1,4]=row1d[2,1]

mat rownames table2_n="N"
mat list table2_n
frmttable, statmat(table2_n) ///
	sdec(0) store(table2_n_1) ///
	rtitles("N")

mat table2_a=J(4,8,.)
local c=1
foreach crit of varlist criteria_a criteria_b criteria_c no_crit {
local r=1
foreach v in `outcome1'{ //indicator variables, report n (percent)
	sum `v' if `crit'==1, detail
	mat table2_a[`r',`c']=r(mean)*r(N) //n
	mat table2_a[`r',`c'+1]=r(mean)*100 //percent
	local r=`r'+1 
	}

foreach v in `outcome3'{ //hospital nights variable, report mean (sd)
	sum `v' if `crit'==1, detail
	mat table2_a[`r',`c']=r(mean) //mean
	mat table2_a[`r',`c'+1]=r(sd) //sd
	local r=`r'+1 
	}
local c=`c'+2	
}

mat rownames table2_a=`outcome1' `outcome3'
mat list table2_a

//save the table in frmttable	
mat dmat=(0,1,0,1,0,1,0,1)
mat ann=J(4,4,1)

frmttable, statmat(table2_a) varlabels ///
	sdec(1) doubles(dmat) ///
	dbldiv(" (") annotate(ann) asymbol(")") ///
	store(table2_a_1) 

//for spending variables where I report medians
mat table2_b=J(1,8,.) //for mean, sd
mat table2_c=J(1,8,.) //for median
mat table2_d=J(1,4,.) //for median

mat dmat_b=(0,1,0,1,0,1,0,1)
mat ann_b=J(1,4,1)
foreach v in `outcome2'{ //spending variables, report mean(sd),median

local c=1
foreach crit of varlist criteria_a criteria_b criteria_c no_crit {

	sum `v' if `crit'==1, detail
	mat table2_b[1,`c']=r(mean) //mean
	mat table2_b[1,`c'+1]=r(sd) //sd
	mat table2_c[1,`c']=r(p50) //median
	local c = `c'+2
	}
	
	mat table2_d[1,1]=table2_c[1,1]
	mat table2_d[1,2]=table2_c[1,3]
	mat table2_d[1,3]=table2_c[1,5]
	mat table2_d[1,4]=table2_c[1,7]
	
	local lbl: var label `v'
	label var `v' "`lbl' , mean (sd)"
	mat rownames table2_b=`v'
	
	frmttable, statmat(table2_b)  varlabels ///
		sdec(0) doubles(dmat) ///
		dbldiv(" (") annotate(ann) asymbol(")") ///
		append(table2_b_1) 
	
	label var `v' " median"
	mat rownames table2_d=`v'	
	
	frmttable, statmat(table2_d)  varlabels ///
		sdec(0) append(table2_b_1) 	
}

outreg, replay(table2_a_1) append(table2_b_1) store(table2_c_1)

outreg using `logpath'\sic_Tables_11_2008_wave_crit_a_b_c, ///
	replay(table2_c_1) append(table2_n_1) ///
	ctitles("","Criteria A","Criteria B","Criteria C","None") ///
	title("Table 3: 1 Year Outcomes, 2008 Interview Wave") ///
	note("Criteria A = Any serious medical illness and/or ADL impairment" \ ///
	"Criteria B = Criteria A and Urgent / Emergent hospitalization and/or NH resident" \ ///
	"Criteria C = Medical illness and ADL Impairment and hospitalization and/or NH resident") ///
	addtable

***************************************************************
log close


H="Symptoms, comparing a,b,c,none in 2010 crit"
/*Stata
Create tables comparing outcomes for the criteria
Switches  between criteria a, b, c datasets to create set 
of outcome tables

Final table list (tables 1-3 formatted for publication)
1. Typical table 1, sample characteristics for criteria a, b, and c
1a. Symptoms criteria a, b, c
2. 1 year outcomes, criteria a, b, c
3. 2010 1 year outcomes, criteria a,b,c and no criteria as comparison group

Original table list:
4. Breakdown of counts of each of the different criteria (uses
dataset prior to breaking out by interview timeline meeting criteria)
5. Looking at interview timing both pre and post meeting criteria
6. Looking at p1 outcomes
*/

capture log close

clear all
set mem 500m
set more off

local logpath E:\data\serious_ill\logs
local datapath2 E:\data\serious_ill\int_data
local datapath E:\data\serious_ill\final_data

log using "`logpath'\11a_compare_3_criteria_symptoms.txt", text replace

cd `datapath'

***************************************************************
***************************************************************
//Table 1a - looking at symptoms criteria a,b,c,none in 2010
***************************************************************
***************************************************************
local sx_vars1 pain_hrs_n0 symptoms_ivw dyspnea_hrs_n0n1 swelling_feet_hrs_n0n1 ///
dizzy_hrs_n0n1 back_pain_hrs_n0n1 headache_hrs_n0n1 cough_hrs_n0n1 insom_symptoms_ivw 

//insomnia variables 1 = most of the time, 2 = sometimes, 3=rarely,never	
local sx_vars2 insom_falling_asleep_n0n1 insom_waking_up_n0n1 ///
	insom_too_early_n0n1 insom_rested_n0n1

//first part, criteria a,b,c
mat tab1 = J(21,6,.)
mat tab1n = J(1,6,.)

local c = 1
foreach crit in a b c {
	clear
	use n0_n1_p1_p2_x_criteria_`crit'_v1.dta if core_year_n0<2012

la var pain_hrs_n0 "Often troubled by pain, n (%)"

la var symptoms_ivw "Symptoms from n1 ivw, n(%)"
la var dyspnea_hrs_n0n1 "Shortness of breath, n (%)"
la var swelling_feet_hrs_n0n1 "Persistent swelling feet, n (%)"
la var dizzy_hrs_n0n1 "Persistent dizziness, n (%)"
la var back_pain_hrs_n0n1 "Back pain, n (%)"
la var headache_hrs_n0n1 "Persistent headaches, n (%)"
la var cough_hrs_n0n1 "Persistent cough, n (%)"

la var insom_symptoms_ivw "Insomnia symptoms from n1 ivw, n(%)"
	
	local r = 1
	foreach v in `sx_vars1'{
	sum `v'
	mat tab1[`r',`c']=r(mean)*r(N) //n
	mat tab1[`r',`c'+1]=r(mean)*100 //percent
	local r = `r'+1
	}

	foreach v in `sx_vars2'{
	tab `v',matcell(m_`v')
	local n_`v'=r(N)
	forvalues i = 1/3{
		mat tab1[`r',`c']=m_`v'[`i',1] //n
		mat tab1[`r',`c'+1]=m_`v'[`i',1]/`n_`v''*100 //percent
		local r = `r'+1
		}
	}

	//n for last row
	sum core_year_n0
	mat tab1n[1,`c']=r(N)
	
	local c = `c'+2
}

mat tab1n_2 = J(1,3,.)

mat tab1n_2[1,1]=tab1n[1,1]
mat tab1n_2[1,2]=tab1n[1,3]
mat tab1n_2[1,3]=tab1n[1,5]

mat rownames tab1=`sx_vars1' "Diff falling asleep most of time" "Some of time" ///
"Rarely / Never" "Wake up at night most of time" "Some of time" ///
"Rarely / Never" "Wake up too early most of time" "Some of time" ///
"Rarely / Never" "Feel really rested most of time" "Some of time" ///
"Rarely / Never" 

mat list tab1
mat list tab1n_2

//save the table in frmttable	
mat dmat=(0,1,0,1,0,1)
mat ann=J(21,3,1)

frmttable, statmat(tab1) varlabels ///
	sdec(0) doubles(dmat) ///
	dbldiv(" (") annotate(ann) asymbol(")") ///
	store(tab1_1) 	

frmttable, statmat(tab1n_2) ///
	sdec(0)	store(tab1_2) ///
	rtitles("N")

outreg, replay(tab1_1) append(tab1_2) store(table1) ///
	ctitles("","Criteria A","Criteria B","Criteria C") ///
	title("Symptoms from n0 or n1 - Interview first meet criteria A, B, C")  ///
	note("Criteria A = Any serious medical illness and/or ADL impairment" \ ///
	"Criteria B = Criteria A and Urgent / Emergent hospitalization and/or NH resident" \ ///
	"Criteria C = Medical illness and ADL Impairment and hospitalization and/or NH resident" \ ///
	"Comparison Group= Subjects in the 2010 interview wave who met none of the 3 criteria.")

//next section - 2010 no criteria comparison group
clear
use n0_n1_p1_p2_x_criteria_2010_v1.dta

//meet criteria variables
tab criteria_a_n0, missing
tab criteria_b_n0, missing
tab criteria_c_n0, missing

gen no_crit = 0
replace no_crit=1 if criteria_a_n0==0 & criteria_b_n0==0 & criteria_c_n0==0 
la var no_crit "Criteria not met, 1=yes"
tab no_crit, missing
keep if no_crit==1
	
mat tab1_2010=J(21,2,.)
mat tab1n_2010 = J(1,1,.)

la var pain_hrs_n0 "Often troubled by pain, n (%)"

la var symptoms_ivw "Symptoms from n1 ivw, n(%)"
la var dyspnea_hrs_n0n1 "Shortness of breath, n (%)"
la var swelling_feet_hrs_n0n1 "Persistent swelling feet, n (%)"
la var dizzy_hrs_n0n1 "Persistent dizziness, n (%)"
la var back_pain_hrs_n0n1 "Back pain, n (%)"
la var headache_hrs_n0n1 "Persistent headaches, n (%)"
la var cough_hrs_n0n1 "Persistent cough, n (%)"

la var insom_symptoms_ivw "Insomnia symptoms from n1 ivw, n(%)"	
	
local c = 1	
local r = 1

foreach v in `sx_vars1'{
	sum `v'
	mat tab1_2010[`r',`c']=r(mean)*r(N) //n
	mat tab1_2010[`r',`c'+1]=r(mean)*100 //percent
	local r = `r'+1
}

	foreach v in `sx_vars2'{
	tab `v',matcell(m_`v')
	local n_`v'=r(N)
	forvalues i = 1/3{
		mat tab1_2010[`r',`c']=m_`v'[`i',1] //n
		mat tab1_2010[`r',`c'+1]=m_`v'[`i',1]/`n_`v''*100 //percent
		local r = `r'+1
		}
	}

//n for last row
sum core_year_n0
mat tab1n_2010[1,`c']=r(N)
	
mat rownames tab1_2010=`sx_vars1' "Diff falling asleep most of time" "Some of time" ///
"Rarely / Never" "Wake up at night most of time" "Some of time" ///
"Rarely / Never" "Wake up too early most of time" "Some of time" ///
"Rarely / Never" "Feel really rested most of time" "Some of time" ///
"Rarely / Never" 

mat list tab1_2010
mat list tab1n_2010

//save the table in frmttable	
mat dmat=(0,1)
mat ann=J(21,1,1)

frmttable, statmat(tab1_2010) varlabels ///
	sdec(0) doubles(dmat) ///
	dbldiv(" (") annotate(ann) asymbol(")") ///
	store(tab12010_1) 	

frmttable, statmat(tab1n_2010) ///
	sdec(0)	store(tab12010_2) ///
	rtitles("N")

outreg, replay(tab12010_1) append(tab12010_2) store(tab12010_ab)

********************************************************************			
outreg using `logpath'\sic_Tables_11a_symptoms_crit_a_b_c, ///
	replay(table1) merge(tab12010_ab) ///
	ctitles("","Criteria A","Criteria B","Criteria C","Comparison Group") ///
	replace

********************************************************************			
clear

********************************************************************			
//another version, this time comparing the n0 vs n1 responses
//for the criteria groups
********************************************************************			
local sx_vars1 pain_hrs_n0 symptoms_ivw dyspnea_hrs_n0n1 dyspnea_hrs_n0 dyspnea_hrs_n1 ///
swelling_feet_hrs_n0n1 swelling_feet_hrs_n0 swelling_feet_hrs_n1 ///
dizzy_hrs_n0n1 dizzy_hrs_n0 dizzy_hrs_n1 ///
back_pain_hrs_n0n1 back_pain_hrs_n0 back_pain_hrs_n1 ///
headache_hrs_n0n1 headache_hrs_n0 headache_hrs_n1 ///
cough_hrs_n0n1 cough_hrs_n0 cough_hrs_n1 insom_symptoms_ivw 

//insomnia variables 1 = most of the time, 2 = sometimes, 3=rarely,never	
local sx_vars2 insom_falling_asleep_n0n1 insom_falling_asleep_n0 ///
insom_falling_asleep_n1 insom_waking_up_n0n1 insom_waking_up_n0 ///
insom_waking_up_n1 insom_too_early_n0n1 insom_too_early_n0 ///
insom_too_early_n1 insom_rested_n0n1 insom_rested_n0 insom_rested_n1

//first part, criteria a,b,c
mat tab1 = J(57,6,.)
mat tab1n = J(1,6,.)

local c = 1
foreach crit in a b c {
	clear
	use n0_n1_p1_p2_x_criteria_`crit'_v1.dta if core_year_n0<2012

la var pain_hrs_n0 "Often troubled by pain n0, n (%)"

la var symptoms_ivw "Symptoms from n1 ivw, n(%)"

la var dyspnea_hrs_n0n1 "Shortness of breath, n0 or n1"
la var dyspnea_hrs_n0 "Shortness of breath, n0"
la var dyspnea_hrs_n1 "Shortness of breath, n1"

la var swelling_feet_hrs_n0n1 "Persistent swelling feet, n0 or n1"
la var swelling_feet_hrs_n0 "Persistent swelling feet, n0"
la var swelling_feet_hrs_n1 "Persistent swelling feet, n1"

la var dizzy_hrs_n0n1 "Persistent dizziness, n0 or n1"
la var dizzy_hrs_n0 "Persistent dizziness, n0"
la var dizzy_hrs_n1 "Persistent dizziness, n1"

la var back_pain_hrs_n0n1 "Back pain, n0 or n1"
la var back_pain_hrs_n0 "Back pain, n0"
la var back_pain_hrs_n1 "Back pain, n1"

la var headache_hrs_n0n1 "Persistent headaches, n0 or n1"
la var headache_hrs_n0 "Persistent headaches, n0"
la var headache_hrs_n1 "Persistent headaches, n1"

la var cough_hrs_n0n1 "Persistent cough, n0 or n1"
la var cough_hrs_n0 "Persistent cough, n0"
la var cough_hrs_n1 "Persistent cough, n1"

la var insom_symptoms_ivw "Insomnia symptoms from n1 ivw, n(%)"
	
	local r = 1
	foreach v in `sx_vars1'{
	sum `v'
	mat tab1[`r',`c']=r(mean)*r(N) //n
	mat tab1[`r',`c'+1]=r(mean)*100 //percent
	local r = `r'+1
	}

	foreach v in `sx_vars2'{
	tab `v',matcell(m_`v')
	local n_`v'=r(N)
	forvalues i = 1/3{
		mat tab1[`r',`c']=m_`v'[`i',1] //n
		mat tab1[`r',`c'+1]=m_`v'[`i',1]/`n_`v''*100 //percent
		local r = `r'+1
		}
	}

	//n for last row
	sum core_year_n0
	mat tab1n[1,`c']=r(N)
	
	local c = `c'+2
}

mat tab1n_2 = J(1,3,.)

mat tab1n_2[1,1]=tab1n[1,1]
mat tab1n_2[1,2]=tab1n[1,3]
mat tab1n_2[1,3]=tab1n[1,5]

mat rownames tab1=`sx_vars1' "n1n0 Diff fall asleep most time" "Some of time" ///
"Rarely / Never" "n0 Diff fall asleep most of time" "Some of time" ///
"Rarely / Never" "n1 Diff fall asleep most of time" "Some of time" ///
"Rarely / Never" "n1n0 Wake up at night most time" "Some of time" ///
"Rarely / Never" "n0 Wake up at night most time" "Some of time" ///
"Rarely / Never" "n1 Wake up at night most time" "Some of time" ///
"Rarely / Never" "n1n0 Wake up too early most time" "Some of time" ///
"Rarely / Never" "n0 Wake up too early most time" "Some of time" ///
"Rarely / Never" "n1 Wake up too early most time" "Some of time" ///
"Rarely / Never" "n1n0 Feel rested most time" "Some of time" ///
"Rarely / Never" "n0 Feel rested most time" "Some of time" ///
"Rarely / Never" "n1 Feel rested most time" "Some of time" ///
"Rarely / Never" 

mat list tab1
mat list tab1n_2

//save the table in frmttable	
mat dmat=(0,1,0,1,0,1)
mat ann=J(57,3,1)

frmttable, statmat(tab1) varlabels ///
	sdec(0) doubles(dmat) ///
	dbldiv(" (") annotate(ann) asymbol(")") ///
	store(tab1_1) 	

frmttable, statmat(tab1n_2) ///
	sdec(0)	store(tab1_2) ///
	rtitles("N")

outreg, replay(tab1_1) append(tab1_2) store(table1) ///
	ctitles("","Criteria A","Criteria B","Criteria C") ///
	title("Symptoms compare n0 or n1 - Interview first meet criteria A, B, C")  ///
	note("Criteria A = Any serious medical illness and/or ADL impairment" \ ///
	"Criteria B = Criteria A and Urgent / Emergent hospitalization and/or NH resident" \ ///
	"Criteria C = Medical illness and ADL Impairment and hospitalization and/or NH resident" \ ///
	"Comparison Group= Subjects in the 2010 interview wave who met none of the 3 criteria.")

*****************************************************
//next section - 2010 no criteria comparison group
clear
use n0_n1_p1_p2_x_criteria_2010_v1.dta

//meet criteria variables
tab criteria_a_n0, missing
tab criteria_b_n0, missing
tab criteria_c_n0, missing

gen no_crit = 0
replace no_crit=1 if criteria_a_n0==0 & criteria_b_n0==0 & criteria_c_n0==0 
la var no_crit "Criteria not met, 1=yes"
tab no_crit, missing
keep if no_crit==1
	
mat tab1_2010=J(57,2,.)
mat tab1n_2010 = J(1,1,.)

la var pain_hrs_n0 "Often troubled by pain n0, n (%)"
la var symptoms_ivw "Symptoms from n1 ivw, n(%)"

la var dyspnea_hrs_n0n1 "Shortness of breath, n0 or n1"
la var dyspnea_hrs_n0 "Shortness of breath, n0"
la var dyspnea_hrs_n1 "Shortness of breath, n1"

la var swelling_feet_hrs_n0n1 "Persistent swelling feet, n0 or n1"
la var swelling_feet_hrs_n0 "Persistent swelling feet, n0"
la var swelling_feet_hrs_n1 "Persistent swelling feet, n1"

la var dizzy_hrs_n0n1 "Persistent dizziness, n0 or n1"
la var dizzy_hrs_n0 "Persistent dizziness, n0"
la var dizzy_hrs_n1 "Persistent dizziness, n1"

la var back_pain_hrs_n0n1 "Back pain, n0 or n1"
la var back_pain_hrs_n0 "Back pain, n0"
la var back_pain_hrs_n1 "Back pain, n1"

la var headache_hrs_n0n1 "Persistent headaches, n0 or n1"
la var headache_hrs_n0 "Persistent headaches, n0"
la var headache_hrs_n1 "Persistent headaches, n1"

la var cough_hrs_n0n1 "Persistent cough, n0 or n1"
la var cough_hrs_n0 "Persistent cough, n0"
la var cough_hrs_n1 "Persistent cough, n1"

la var insom_symptoms_ivw "Insomnia symptoms from n1 ivw, n(%)"
	
local c = 1	
local r = 1

foreach v in `sx_vars1'{
	sum `v'
	mat tab1_2010[`r',`c']=r(mean)*r(N) //n
	mat tab1_2010[`r',`c'+1]=r(mean)*100 //percent
	local r = `r'+1
}

	foreach v in `sx_vars2'{
	tab `v',matcell(m_`v')
	local n_`v'=r(N)
	forvalues i = 1/3{
		mat tab1_2010[`r',`c']=m_`v'[`i',1] //n
		mat tab1_2010[`r',`c'+1]=m_`v'[`i',1]/`n_`v''*100 //percent
		local r = `r'+1
		}
	}

//n for last row
sum core_year_n0
mat tab1n_2010[1,`c']=r(N)
	
mat rownames tab1_2010=`sx_vars1' "n1n0 Diff fall asleep most time" "Some of time" ///
"Rarely / Never" "n0 Diff fall asleep most of time" "Some of time" ///
"Rarely / Never" "n1 Diff fall asleep most of time" "Some of time" ///
"Rarely / Never" "n1n0 Wake up at night most time" "Some of time" ///
"Rarely / Never" "n0 Wake up at night most time" "Some of time" ///
"Rarely / Never" "n1 Wake up at night most time" "Some of time" ///
"Rarely / Never" "n1n0 Wake up too early most time" "Some of time" ///
"Rarely / Never" "n0 Wake up too early most time" "Some of time" ///
"Rarely / Never" "n1 Wake up too early most time" "Some of time" ///
"Rarely / Never" "n1n0 Feel rested most time" "Some of time" ///
"Rarely / Never" "n0 Feel rested most time" "Some of time" ///
"Rarely / Never" "n1 Feel rested most time" "Some of time" ///
"Rarely / Never" 


mat list tab1_2010
mat list tab1n_2010

//save the table in frmttable	
mat dmat=(0,1)
mat ann=J(57,1,1)

frmttable, statmat(tab1_2010) varlabels ///
	sdec(0) doubles(dmat) ///
	dbldiv(" (") annotate(ann) asymbol(")") ///
	store(tab12010_1) 	

frmttable, statmat(tab1n_2010) ///
	sdec(0)	store(tab12010_2) ///
	rtitles("N")

outreg, replay(tab12010_1) append(tab12010_2) store(tab12010_ab)

********************************************************************			
outreg using `logpath'\sic_Tables_11a_symptoms_crit_a_b_c, ///
	replay(table1) merge(tab12010_ab) ///
	ctitles("","Criteria A","Criteria B","Criteria C","Comparison Group") ///
	addtable


********************************************************************			
log close 


H="Check for demo differences R link to MC claims vs no"
/*Checks for demo differences for those R's that allow for the link to
Medicare claims vs those that do not

Just uses 2008 wave
*/


capture log close

clear all
set mem 500m
set more off

local logpath E:\data\serious_ill\logs
local datapath2 E:\data\serious_ill\int_data
local datapath E:\data\serious_ill\final_data

log using "`logpath'\11b_demo_check_MC_link.txt", text replace

cd `datapath2'

/*needs work, this datset doesn't have those observations without the mc xwalk
need to find the one that makes the most sense to use!! 

Dataset created in the "Process Claims Relative to Core Interview Date section*/
use core_xwalk_1.dta 

//backfill education from 2004 or earlier
tab core_year educ,missing

sort id core_year
by id (core_year): carryforward educ , gen(educ1)

tab core_year educ1, missing

gen byte hseduc1=0 if educ1<=1
replace hseduc1=1 if educ1>1  & educ1 <.
tab hseduc1 if core_year==2008, missing

keep if core_year==2008
tab core_year, missing matcell(r1) //n with 2008 core

tab age_ge_65, missing matcell(r2) //n 2008+age 65+

//output n's to a table
mat ntable=J(2,1,.)
mat ntable[1,1]=r1[1,1]
mat ntable[2,1]=r2[2,1]
mat list ntable

frmttable using `logpath'\11b_2008_demo_mc_link_check, statmat(ntable) ///
title("2008 Core interviews") ///
ctitle("","n") ///
rtitle("2008 Core interviews" \ "Age 65+ at interview") ///
sdec(0) replace

tab xwalk_yes if age_ge_65==1, missing

***********************************************************************
//set up demo variables to use in table
//create categorical variable for the race/ethnicity variables
gen race_cat = .
replace race_cat=1 if white==1
replace race_cat=2 if black==1
replace race_cat=4 if other_na_api_race==1
replace race_cat=3 if hisp_eth==1
la var race_cat "Race/ethnicity - categorical"
la def race_cat 1 "White, non-Hispanic" 2 "Black" 3 "Hispanic" 4 "Other"
la val race_cat race_cat
tab race_cat race, missing

tab married, missing

tab medicaid,missing
tab adl_independent_core,missing
tab adl_partial_core,missing 
tab adl_severe_core,missing
tab adl_cat_core, missing
***********************************************************************
//table comparing demographic characteristics by allowing xwalk vs not
mat demo=J(17,3,.)

//first row, n of linked vs not linked sample
tab xwalk_yes if age_ge_65==1, missing matcell(d1)
mat demo[1,1]=d1[2,1] //non-linked n
mat demo[1,2]=d1[1,1] //linked n

mat list demo
local j=1
foreach i in 1 0 {
sum age_at_core if xwalk_yes==`i' & age_ge_65==1, detail //age
mat demo[2,`j']=r(mean)
mat demo[3,`j']=r(sd)

local r=4
foreach v in female hseduc1 married white black hisp_eth other_na_api_race {
sum `v' if xwalk_yes==`i' & age_ge_65==1, detail
mat demo[`r',`j']=r(mean)
local r=`r'+1 //rows 4-10
}

sum networth_adj2010 if xwalk_yes==`i' & age_ge_65==1, detail //age
mat demo[11,`j']=r(mean)
mat demo[12,`j']=r(p50)
mat demo[13,`j']=r(sd)

local r=14
foreach v in medicaid adl_independent_core adl_partial_core adl_severe_core {
sum `v' if xwalk_yes==`i' & age_ge_65==1, detail
mat demo[`r',`j']=r(mean)
local r=`r'+1 //rows 4-10
}

local j=`j'+1
}

//pvalues
ttest age_at_core if age_ge_65==1, by(xwalk_yes)
mat demo[2,3]=r(p) //p value from t-test
local r=4
foreach v in female hseduc1 married {
tab `v' xwalk_yes if age_ge_65==1, row chi
mat demo[`r',3]=r(p) //p value from chisq test
local r = `r'+1 //rows 4-6
}
tab race_cat xwalk_yes if age_ge_65==1, row chi
mat demo[7,3]=r(p) //p value from chisq test
ttest networth_adj2010 if age_ge_65==1, by(xwalk_yes)
mat demo[11,3]=r(p) //p value from t-test

tab medicaid xwalk_yes if age_ge_65==1, row chi
mat demo[14,3]=r(p) //p value from chisq test

tab adl_cat_core xwalk_yes if age_ge_65==1, row chi
mat demo[15,3]=r(p) //p value from chisq test

mat rownames demo="n" "Age, mean" "SD" "Female" "HS Degree" "Married" ///
"Non-Hispanic White" "Black" "Hispanic" "Other" "Net worth, mean" "Median" "SD" ///
"Medicaid, self-report" "ADL - Independent" "Partial dependence" "Severe dependence"

mat list demo

frmttable using `logpath'\11b_2008_demo_mc_link_check, statmat(demo) ///
title("Mean comparison of those with Medicare linkage or not") ///
ctitle("","With Medicare Link","No Medicare Link","P-value") ///
note("P values from t tests for continuous variables and" \ ///
"and chi squared statistics for categorical variables") ///
sdec(2,2,3) addtable



log close


H="Check n0 p1 change in status by criteria"
//looking at n0/p1 conflicts

capture log close

clear all
set more off

local logpath E:\data\serious_ill\logs
log using `logpath'\11c_n0p1_check_log.txt, text replace

cd E:\data\serious_ill\final_data
/*
use n0_n1_p1_p2_x_criteria_a_v1.dta if core_year_n0<2010,clear
tab falls_hrs_n0, missing
//start with cancer group n=126 that have yes in n0, no in p1
tab smi_cancer_ind_n0 smi_cancer_ind_p1, missing

//check elix
tab comorb_17_0_1yr_n0 comorb_17_0_1yr_p1 if smi_cancer_ind_n0==1 & smi_cancer_ind_p1==0
tab comorb_18_0_1yr_n0 comorb_18_0_1yr_p1 if smi_cancer_ind_n0==1 & smi_cancer_ind_p1==0
tab comorb_19_0_1yr_n0 comorb_19_0_1yr_p1 if smi_cancer_ind_n0==1 & smi_cancer_ind_p1==0

//check chronic conditions
tab cc_cncr_chronic_1yr_n0 cc_cncr_chronic_1yr_p1 if smi_cancer_ind_n0==1 & smi_cancer_ind_p1==0

gen cancer_cc_and_elix_p1=1 if comorb_17_0_1yr_p1==1 | comorb_18_0_1yr_p1==1 | comorb_19_0_1yr_p1==1 | cc_cncr_chronic_1yr_p1==1
replace cancer_cc_and_elix_p1=0 if comorb_17_0_1yr_p1==0 & comorb_18_0_1yr_p1==0 & comorb_19_0_1yr_p1==0 & cc_cncr_chronic_1yr_p1==0

tab cancer_cc_and_elix_p1 if smi_cancer_ind_n0==1 & smi_cancer_ind_p1==0

*******************************************************************************
//look at ADL change = impaired n0 but not in p1 n=383
tab adl_impair_core_n0 adl_impair_core_p1, matcell(t1) missing

**most had help with only one of the adl items in the n0 interview
tab adl_index_core_n0 adl_index_core_p1 if adl_ind_core_n_n0==0 & adl_ind_core_n_p1==1, missing
**had helper listed in the n0 interview but not in the p1 interview
tab adl_help_ind_n0 adl_help_ind_p1 if adl_ind_core_n_n0==0 & adl_ind_core_n_p1==1, missing
**hours per month help received, from helper file
sum adl_hlp_freq_imp_mo_n0  if adl_ind_core_n_n0==0 & adl_ind_core_n_p1==1
sum adl_hlp_freq_imp_mo_p1  if adl_ind_core_n_n0==0 & adl_ind_core_n_p1==1

//self report nursing home
tab nhres_n0 ind_snf_use_12m_n0 if adl_ind_core_n_n0==0 & adl_ind_core_n_p1==1, missing
tab nhres_p1 ind_snf_use_12m_p1 if adl_ind_core_n_n0==0 & adl_ind_core_n_p1==1, missing

//hospital admission
**self report since last core interview
tab hosp_last_2yr_n0 hosp_last_2yr_p1 if adl_ind_core_n_n0==0 & adl_ind_core_n_p1==1, missing
**from claims
tab ind_hosp_adm_12m_n0 ind_hosp_adm_12m_p1 if adl_ind_core_n_n0==0 & adl_ind_core_n_p1==1, missing

//if adl difficulty reported, what happens to the changes??
gen adl_diff_index_n0=adl_diff_dr_n0 + adl_diff_wk_n0 + adl_diff_bh_n0 + ///
 adl_diff_e_n0 + adl_diff_tx_n0 + adl_diff_t_n0
gen adl_diff_index_p1=adl_diff_dr_p1 + adl_diff_wk_p1 + adl_diff_bh_p1 + ///
 adl_diff_e_p1 + adl_diff_tx_p1 + adl_diff_t_p1
 
gen adl_diff_yes_n0=1 if adl_diff_index_n0>0 & adl_diff_index_n0~=.
replace adl_diff_yes_n0=0 if adl_diff_index_n0==0
gen adl_diff_yes_p1=1 if adl_diff_index_p1>0 & adl_diff_index_p1~=.
replace adl_diff_yes_p1=0 if adl_diff_index_p1==0

tab adl_diff_yes_n0 adl_diff_yes_p1 if adl_ind_core_n_n0==0 & adl_ind_core_n_p1==1, missing

//do they have illness?
tab ser_med_illness_n0 ser_med_illness_p1 if adl_ind_core_n_n0==0 & adl_ind_core_n_p1==1, missing
// Why are some missing in p1??? - because they don't have the p1 interview
tab xwalk_yes_p1 ser_med_illness_p1,missing
tab ser_med_illness_p1 core_year_p1 if adl_ind_core_n_n0==0 & adl_ind_core_n_p1==1 ///
& ind_p1_interview==1 & part_ab_12m_p1==1 & hmo_d_12m_p1==0,missing
*/
***********************************************************************
***********************************************************************
//tabulation
local fullp1 ind_p1_interview==1 & part_ab_12m_p1==1 & hmo_d_12m_p1==0

foreach c in smi a b c {
use n0_n1_p1_p2_x_criteria_`c'_v1.dta if core_year_n0<2010, clear

//adl status change table
//if adl difficulty reported, what happens to the changes??
gen adl_diff_index_n0=adl_diff_dr_n0 + adl_diff_wk_n0 + adl_diff_bh_n0 + ///
 adl_diff_e_n0 + adl_diff_tx_n0 + adl_diff_t_n0
gen adl_diff_index_p1=adl_diff_dr_p1 + adl_diff_wk_p1 + adl_diff_bh_p1 + ///
 adl_diff_e_p1 + adl_diff_tx_p1 + adl_diff_t_p1
 
gen adl_diff_yes_n0=1 if adl_diff_index_n0>0 & adl_diff_index_n0~=.
replace adl_diff_yes_n0=0 if adl_diff_index_n0==0
gen adl_diff_yes_p1=1 if adl_diff_index_p1>0 & adl_diff_index_p1~=.
replace adl_diff_yes_p1=0 if adl_diff_index_p1==0

//additional buckets - aggregated from above buckets
//still have trouble but not getting help
gen adl_trouble_no_help_p1=1 if (adl_diff_yes_p1==1 | falls_hrs_p1==1) & ///
 adl_impair_core_n0==1 & adl_impair_core_p1==0 & `fullp1'
gen adl_better_p1=1 if (adl_diff_yes_p1==0 & falls_hrs_p1==1) & ///
(falls_hrs_n0==1 | smi_hip_ind_n0==1 | hip_frac_hrs_n0==1 | cc_11_hipfrac_1yr_n0==1 ) & ///
 adl_impair_core_n0==1 & adl_impair_core_p1==0 & `fullp1'

tab adl_trouble_no_help_p1 adl_better_p1 , missing

//unknown reason
gen unk_1=1 if adl_trouble_no_help_p1==0 & adl_better_p1==0 & ///
adl_impair_core_n0==1 & adl_impair_core_p1==0 & `fullp1'
replace unk_1=0 if (adl_trouble_no_help_p1==1 | adl_better_p1==1) & ///
adl_impair_core_n0==1 & adl_impair_core_p1==0 & `fullp1'
la var unk_1 "Reason ADL not meet in p1 unknown"
tab unk_1, missing

//part 1 - meet ADL in n0, do not meet ADL in p1, regardless of overall criteria status
//overall n that are alive at p1, complete p1 interview (this matches Tables 7 log, Table 6
tab core_year_n0 if `fullp1', missing 
//functional status
tab adl_impair_core_n0  if `fullp1', missing //n that meets n0 with p1 follow up
tab adl_impair_core_p1 if adl_impair_core_n0==1 & `fullp1', matcell(adl) missing

mat t1=J(21,2,.)
mat t1[1,1]=r(N)
mat t1[2,1]=adl[1,1]
mat t1[2,2]=t1[2,1]/t1[1,1]*100
mat list t1

//now of this group that meets n0, not p1, why?
//r3: change from receiving help to having difficulty but not receiving help
//r4-6: what about hip fracture n0, could explain if getting better
//r7-8: falls n0 and p1
local r=3
foreach v in adl_diff_yes_p1 smi_hip_ind_n0 hip_frac_hrs_n0 cc_11_hipfrac_1yr_n0 ///
 falls_hrs_n0 falls_hrs_p1 unk_1 {
tab `v' if adl_impair_core_n0==1 & adl_impair_core_p1==0 & `fullp1', matcell(adl) missing
mat t1[`r',1]=adl[2,1]
mat t1[`r',2]=t1[`r',1]/t1[2,1]*100
local r = `r'+1
}

foreach v in  adl_trouble_no_help_p1 adl_better_p1 {
tab `v' if adl_impair_core_n0==1 & adl_impair_core_p1==0 & `fullp1', matcell(adl) missing
mat t1[`r',1]=adl[1,1]
mat t1[`r',2]=t1[`r',1]/t1[2,1]*100
local r = `r'+1
}

//part 2 - meet ADL in n0, do not meet ADL in p1, and do not meet overall criteria in p1
tab adl_impair_core_p1 if adl_impair_core_n0==1 & criteria_`c'_p1==0 & `fullp1', matcell(adl) missing
mat t1[12,1]=adl[1,1]
mat t1[12,2]=t1[`r',1]/t1[1,1]*100
mat list t1

local r=13
foreach v in adl_diff_yes_p1 smi_hip_ind_n0 hip_frac_hrs_n0 cc_11_hipfrac_1yr_n0 ///
 falls_hrs_n0 falls_hrs_p1 unk_1 {
tab `v' if adl_impair_core_n0==1 & adl_impair_core_p1==0 & criteria_`c'_p1==0 & `fullp1', matcell(adl) missing
mat t1[`r',1]=adl[2,1]
mat t1[`r',2]=t1[`r',1]/t1[12,1]*100
local r = `r'+1
}

foreach v in adl_trouble_no_help_p1 adl_better_p1 {
tab `v' if adl_impair_core_n0==1 & adl_impair_core_p1==0 & criteria_`c'_p1==0 & `fullp1', matcell(adl) missing
mat t1[`r',1]=adl[2,1]
mat t1[`r',2]=t1[`r',1]/t1[12,1]*100
local r = `r'+1
}

mat rownames t1="ADL Impaired n0 with full p1 ivw" "ADL Impaired n0, not p1" "Receive help n0, diff only p1" ///
"Hip fracture n0 per SMI def" "Hip fracture n0 self report" /// 
"Hip fracture chronic cond" "Fall n0 per self report"  "Fall p1 per self report" ///
"Unknown, none of above" "Still difficulty but no help" "ADL - recovered" "Don't meet criteria p1" ///
 "Receive help n0, diff only p1" ///
"Hip fracture n0 per SMI def" "Hip fracture n0 self report" /// 
"Hip fracture chronic cond" "Fall n0 per self report"  "Fall p1 per self report" ///
"Unknown, none of above" "Still difficulty but no help" "ADL - recovered" 

mat list t1

frmttable, statmat(t1) sdec(0,1) store(adl1_`c') ///
ctitles("" "Criteria `c'" "" \ "" "n" "%")

***********************************************************************
//Alzheimer's/dementia

//generate memory variables consistent across proxy and self report
gen mem_fp_p1=1 if inlist(sr_memory_p1,4,5) | inlist(pr_memory_p1,4,5)
replace mem_fp_p1=0 if inlist(sr_memory_p1,1,2,3) | inlist(pr_memory_p1,1,2,3)
tab mem_fp_p1, missing

gen mem_worse_p1=1 if sr_mem_change_p1==3 | pr_mem_change_p1==3
replace mem_worse_p1=0 if inlist(sr_mem_change_p1,1,2) | inlist(pr_mem_change_p1,1,2)

gen mem_same_p1=1 if sr_mem_change_p1==2 | pr_mem_change_p1==2
replace mem_same_p1=0 if inlist(sr_mem_change_p1,1,3) | inlist(pr_mem_change_p1,1,3)

gen mem_better_p1=1 if sr_mem_change_p1==1 | pr_mem_change_p1==1
replace mem_better_p1=0 if inlist(sr_mem_change_p1,2,3) | inlist(pr_mem_change_p1,2,3)

gen tics_mem_prob_p1=1 if inlist(tics_cat_p1,2,3)
replace tics_mem_prob_p1=0 if tics_cat_p1==1

//unknown reason
gen unk_2=1 if comorb_31_0_1yr_p1==0 & cc_3_alzhdmta_1yr_p1==0 & ///
 mem_fp_p1==0 & mem_worse_p1==0  & tics_mem_prob_p1==0 & ///
 smi_dem_ind_n0==1 & smi_dem_ind_p1==0 & `fullp1'
replace unk_2=0 if comorb_31_0_1yr_p1==1 | cc_3_alzhdmta_1yr_p1==1 | ///
 mem_fp_p1==1 | mem_worse_p1==1 | tics_mem_prob_p1==1 & ///
 (smi_dem_ind_n0==1 & smi_dem_ind_p1==0 & `fullp1')
la var unk_2 "Reason Dementia not meet in p1 unknown"
tab unk_2, missing

//overall n that are alive at p1, complete p1 interview (this matches Tables 7 log, Table 6
tab core_year_n0 if `fullp1', missing 
//functional status
tab smi_dem_ind_n0  if `fullp1', missing //n that meets n0 with p1 follow up
tab smi_dem_ind_p1 if smi_dem_ind_n0==1 & `fullp1', matcell(alz) missing

mat t1=J(19,2,.)
mat t1[1,1]=r(N)
mat t1[2,1]=alz[1,1]
mat t1[2,2]=t1[2,1]/t1[1,1]*100
mat list t1

//now of this group that meets n0, not p1, why?
//r3: elix
//r4: chronic conditions
//r5-8: self or proxy report during interview
//r9: tics from ivw
local r=3
foreach v in comorb_31_0_1yr_p1 cc_3_alzhdmta_1yr_p1 mem_fp_p1 mem_worse_p1 ///
  mem_same_p1 mem_better_p1 tics_mem_prob_p1 unk_2 {
tab `v' if smi_dem_ind_n0==1 & smi_dem_ind_p1==0 & `fullp1', matcell(alz) missing
mat t1[`r',1]=alz[2,1]
mat t1[`r',2]=t1[`r',1]/t1[2,1]*100
local r = `r'+1
}

//now get n that don't meet the overall criteria p1
tab smi_dem_ind_p1 if smi_dem_ind_n0==1 & `fullp1' & criteria_`c'_p1==0, matcell(alz) missing
mat t1[11,1]=alz[1,1]
mat t1[11,2]=t1[11,1]/t1[1,1]*100
local r=12
foreach v in comorb_31_0_1yr_p1 cc_3_alzhdmta_1yr_p1 mem_fp_p1 mem_worse_p1 ///
  mem_same_p1 mem_better_p1 tics_mem_prob_p1 unk_2 {
tab `v' if smi_dem_ind_n0==1 & smi_dem_ind_p1==0 & `fullp1' & criteria_`c'_p1==0, matcell(alz) missing
mat t1[`r',1]=alz[2,1]
mat t1[`r',2]=t1[`r',1]/t1[11,1]*100
local r = `r'+1
}

mat rownames t1="Alz/Dementia n0 with full p1 ivw" "Alz/Dementia n0, not p1" "Elix definition p1" ///
"Chronic condition def" "p1 report poor/fair memory" /// 
"p1 report worse memory" "p1 same memory"  "p1 better memory" ///
"p1 TICS MCI or Dementia" "Unknown, none of above" "Don't meet criteria p1" ///
"Elix definition p1" ///
"Chronic condition def" "p1 report poor/fair memory" /// 
"p1 report worse memory" "p1 same memory"  "p1 better memory" ///
"p1 TICS MCI or Dementia" "Unknown, none of above" 

mat list t1

frmttable, statmat(t1) sdec(0,1) store(alz1_`c') ///
ctitles("" "Criteria `c'" "" \ "" "n" "%")

***********************************************************************
//cancer

gen unk_3=1 if comorb_17_0_1yr_p1==0 & comorb_19_0_1yr_p1==0 & cc_cncr_chronic_1yr_p1==0 & ///
 smi_cancer_ind_n0==1 & smi_cancer_ind_p1==0 & `fullp1'
replace unk_3=0 if (comorb_17_0_1yr_p1==1 | comorb_19_0_1yr_p1==1 | cc_cncr_chronic_1yr_p1==1) & ///
 smi_cancer_ind_n0==1 & smi_cancer_ind_p1==0 & `fullp1' 
label var unk_3 "Reason Cancer not meet in p1 unknown"
tab unk_3, missing

//overall n that are alive at p1, complete p1 interview (this matches Tables 7 log, Table 6
tab core_year_n0 if `fullp1', missing 
//functional status
tab smi_cancer_ind_n0  if `fullp1', missing //n that meets n0 with p1 follow up
tab smi_cancer_ind_p1 if smi_cancer_ind_n0==1 & `fullp1', matcell(cancer) missing

mat t1=J(11,2,.)
mat t1[1,1]=r(N)
mat t1[2,1]=cancer[1,1]
mat t1[2,2]=t1[2,1]/t1[1,1]*100
mat list t1

//now of this group that meets n0, not p1, why?
//r3-5: other elixhauser definitions
//r6: chronic conditions
local r=3
foreach v in comorb_17_0_1yr_p1 comorb_19_0_1yr_p1 cc_cncr_chronic_1yr_p1 unk_3 {
tab `v' if smi_cancer_ind_n0==1 & smi_cancer_ind_p1==0 & `fullp1', matcell(cancer) missing
mat t1[`r',1]=cancer[2,1]
mat t1[`r',2]=t1[`r',1]/t1[2,1]*100
local r = `r'+1
}

//part 2 - group that doesn't meet criteria p1
tab smi_cancer_ind_p1 if smi_cancer_ind_n0==1 & `fullp1' & criteria_`c'_p1==0, matcell(cancer) missing
mat t1[`r',1]=cancer[1,1]
mat t1[`r',2]=t1[`r',1]/t1[1,1]*100

local r=8
foreach v in comorb_17_0_1yr_p1 comorb_19_0_1yr_p1 cc_cncr_chronic_1yr_p1 unk_3 {
tab `v' if smi_cancer_ind_n0==1 & smi_cancer_ind_p1==0 & `fullp1' & criteria_`c'_p1==0, matcell(cancer) missing
mat t1[`r',1]=cancer[2,1]
mat t1[`r',2]=t1[`r',1]/t1[7,1]*100
local r = `r'+1
}

mat rownames t1="Cancer n0 with full p1 ivw" "Cancer n0, not p1" "Elix 17 Lymphoma" ///
"Elix 19 Solid tumor wo Metast" "Cancer per chronic cond" /// 
"Unknown, none of above" "Don't meet criteria p1" ///
"Elix 17 Lymphoma" ///
"Elix 19 Solid tumor wo Metast" "Cancer per chronic cond" /// 
"Unknown, none of above"

mat list t1

frmttable, statmat(t1) sdec(0,1) store(cancer1_`c') ///
ctitles("" "Criteria `c'" "" \ "" "n" "%")

***********************************************************************
//Renal failure

gen unk_4=1 if comorb_34_0_1yr_p1==0 & smi_esrd_ind_n0==1 & smi_esrd_ind_p1==0 & `fullp1'
replace unk_4=0 if comorb_34_0_1yr_p1==1 & ///
 smi_esrd_ind_n0==1 & smi_esrd_ind_p1==0 & `fullp1' 
label var unk_4 "Reason Renal Failure not meet in p1 unknown"
tab unk_4, missing

//overall n that are alive at p1, complete p1 interview (this matches Tables 7 log, Table 6
tab core_year_n0 if `fullp1', missing 
//ESRD SMI status
tab smi_esrd_ind_n0  if `fullp1', missing //n that meets n0 with p1 follow up
tab smi_esrd_ind_p1 if smi_esrd_ind_n0==1 & `fullp1', matcell(esrd) missing

mat t1=J(7,2,.)
mat t1[1,1]=r(N)
mat t1[2,1]=esrd[1,1]
mat t1[2,2]=t1[2,1]/t1[1,1]*100
mat list t1

//now of this group that meets n0, not p1, why?
//r2: elix renal disease definition
local r=3
foreach v in comorb_34_0_1yr_p1 unk_4  {
tab `v' if smi_esrd_ind_n0==1 & smi_esrd_ind_p1==0 & `fullp1', matcell(esrd) missing
mat t1[`r',1]=esrd[2,1]
mat t1[`r',2]=t1[`r',1]/t1[2,1]*100
local r = `r'+1
}
//part 2 - subgroup that doesn't meet overall criteria p1
tab smi_esrd_ind_p1 if smi_esrd_ind_n0==1 & `fullp1' & criteria_`c'_p1==0, matcell(esrd) missing
mat t1[`r',1]=esrd[1,1]
mat t1[`r',2]=t1[`r',1]/t1[1,1]*100

local r=6
foreach v in comorb_34_0_1yr_p1 unk_4  {
tab `v' if smi_esrd_ind_n0==1 & smi_esrd_ind_p1==0 & `fullp1' & criteria_`c'_p1==0, matcell(esrd) missing
mat t1[`r',1]=esrd[2,1]
mat t1[`r',2]=t1[`r',1]/t1[5,1]*100
local r = `r'+1
}

mat rownames t1="Renal fail n0 with full p1 ivw" "Renal failure n0, not p1" "Renal disease, elix 34 p1" ///
"Unknown, none of above" "Don't meet criteria p1" "Renal disease, elix 34 p1" ///
"Unknown, none of above"

mat list t1

frmttable, statmat(t1) sdec(0,1) store(esrd1_`c') ///
ctitles("" "Criteria `c'" "" \ "" "n" "%")

***********************************************************************
//Heart failure
gen unk_5=1 if comorb_1_0_1yr_p1==0 & cc_8_chf_1yr_p1==0 & ///
 smi_chf_ind_n0==1 & smi_chf_ind_p1==0 & `fullp1'
replace unk_5=0 if (comorb_1_0_1yr_p1==1 | cc_8_chf_1yr_p1==1) & ///
 smi_chf_ind_n0==1 & smi_chf_ind_p1==0 & `fullp1' 
label var unk_5 "Reason Heart Failure not meet in p1 unknown"
tab unk_5, missing

//overall n that are alive at p1, complete p1 interview (this matches Tables 7 log, Table 6
tab core_year_n0 if `fullp1', missing 
//heart failure
tab smi_chf_ind_n0  if `fullp1', missing //n that meets n0 with p1 follow up
tab smi_chf_ind_p1 if smi_chf_ind_n0==1 & `fullp1', matcell(chf) missing

mat t1=J(9,2,.)
mat t1[1,1]=r(N)
mat t1[2,1]=chf[1,1]
mat t1[2,2]=t1[2,1]/t1[1,1]*100
mat list t1

//now of this group that meets n0, not p1, why?
//r3: elix
//r4: cc
local r=3
foreach v in comorb_1_0_1yr_p1 cc_8_chf_1yr_p1 unk_5 {
tab `v' if smi_chf_ind_n0==1 & smi_chf_ind_p1==0 & `fullp1', matcell(chf) missing
mat t1[`r',1]=chf[2,1]
mat t1[`r',2]=t1[`r',1]/t1[2,1]*100
local r = `r'+1
}

tab smi_chf_ind_p1 if smi_chf_ind_n0==1 & `fullp1' & criteria_`c'_p1==0, matcell(chf) missing
mat t1[`r',1]=chf[1,1]
mat t1[`r',2]=t1[`r',1]/t1[1,1]*100

local r=7
foreach v in comorb_1_0_1yr_p1 cc_8_chf_1yr_p1 unk_5 {
tab `v' if smi_chf_ind_n0==1 & smi_chf_ind_p1==0 & `fullp1' & criteria_`c'_p1==0, matcell(chf) missing
mat t1[`r',1]=chf[2,1]
mat t1[`r',2]=t1[`r',1]/t1[6,1]*100
local r = `r'+1
}


mat rownames t1="CHF n0 with full p1 ivw" "CHF n0, not p1" "CHF, elix 1 p1" ///
"CHF, chronic cond 8 p1" "Unknown, none of above" "Don't meet criteria p1" ///
"CHF, elix 1 p1" "CHF, chronic cond 8 p1" "Unknown, none of above"

mat list t1

frmttable, statmat(t1) sdec(0,1) store(chf1_`c') ///
ctitles("" "Criteria `c'" "" \ "" "n" "%")

***********************************************************************
//COPD
gen unk_6=1 if comorb_9_0_1yr_p1==0 & cc_7_copd_1yr_p1==0 & lung_o2_hrs_p1==0 & ///
 smi_copd_ind_n0==1 & smi_copd_ind_p1==0 & `fullp1'
replace unk_6=0 if (comorb_1_0_1yr_p1==1 | cc_8_chf_1yr_p1==1 | lung_o2_hrs_p1==1) & ///
 smi_copd_ind_n0==1 & smi_copd_ind_p1==0 & `fullp1' 
label var unk_6 "Reason COPD not meet in p1 unknown"
tab unk_6, missing

//overall n that are alive at p1, complete p1 interview (this matches Tables 7 log, Table 6
tab core_year_n0 if `fullp1', missing 

tab smi_copd_ind_n0  if `fullp1', missing //n that meets n0 with p1 follow up
tab smi_copd_ind_p1 if smi_copd_ind_n0==1 & `fullp1', matcell(copd) missing

mat t1=J(11,2,.)
mat t1[1,1]=r(N)
mat t1[2,1]=copd[1,1]
mat t1[2,2]=t1[2,1]/t1[1,1]*100
mat list t1

//now of this group that meets n0, not p1, why?
//r3: elix
//r4: cc
//r5: self report of oxygen use for lung condition
local r=3
foreach v in comorb_9_0_1yr_p1 cc_7_copd_1yr_p1 lung_o2_hrs_p1 unk_6 {
tab `v' if smi_copd_ind_n0==1 & smi_copd_ind_p1==0 & `fullp1', matcell(copd) missing
mat t1[`r',1]=copd[2,1]
mat t1[`r',2]=t1[`r',1]/t1[2,1]*100
local r = `r'+1
}
//part 2 - subgroup don't meet criteria p1
tab smi_copd_ind_p1 if smi_copd_ind_n0==1 & `fullp1' & criteria_`c'_p1==0, matcell(copd) missing
mat t1[`r',1]=copd[1,1]
mat t1[`r',2]=t1[`r',1]/t1[1,1]*100

local r=8
foreach v in comorb_9_0_1yr_p1 cc_7_copd_1yr_p1 lung_o2_hrs_p1 unk_6 {
tab `v' if smi_copd_ind_n0==1 & smi_copd_ind_p1==0 & `fullp1' & criteria_`c'_p1==0, matcell(copd) missing
mat t1[`r',1]=copd[2,1]
mat t1[`r',2]=t1[`r',1]/t1[7,1]*100
local r = `r'+1
}

mat rownames t1="COPD n0 with full p1 ivw" "COPD n0, not p1" "COPD, elix 9 p1" ///
"COPD, chronic cond 7 p1" "Self report O2 use p1" "Unknown, none of above" ///
"Don't meet criteria p1" "COPD, elix 9 p1" ///
"COPD, chronic cond 7 p1" "Self report O2 use p1" "Unknown, none of above"

mat list t1

frmttable, statmat(t1) sdec(0,1) store(copd1_`c') ///
ctitles("" "Criteria `c'" "" \ "" "n" "%")

***********************************************************************
//diabetes
gen unk_7=1 if comorb_10_0_1yr_p1==0 & comorb_11_0_1yr_p1==0 & cc_9_diabetes_1yr_p1==0 & ///
 smi_diab_compl_ind_n0==1 & smi_diab_compl_ind_p1==0 & `fullp1'
replace unk_7=0 if (comorb_10_0_1yr_p1==1 | comorb_11_0_1yr_p1==1 | cc_9_diabetes_1yr_p1==1) & ///
 smi_diab_compl_ind_n0==1 & smi_diab_compl_ind_p1==0 & `fullp1' 
label var unk_7 "Reason Diabetes not meet in p1 unknown"
tab unk_7, missing

//overall n that are alive at p1, complete p1 interview (this matches Tables 7 log, Table 6
tab core_year_n0 if `fullp1', missing 

tab smi_diab_compl_ind_n0  if `fullp1', missing //n that meets n0 with p1 follow up
tab smi_diab_compl_ind_p1 if smi_diab_compl_ind_n0==1 & `fullp1', matcell(diab) missing

mat t1=J(11,2,.)
mat t1[1,1]=r(N)
mat t1[2,1]=diab[1,1]
mat t1[2,2]=t1[2,1]/t1[1,1]*100
mat list t1

//now of this group that meets n0, not p1, why?
//r3,4: elix
//r5: cc
local r=3
foreach v in comorb_10_0_1yr_p1 comorb_11_0_1yr_p1 cc_9_diabetes_1yr_p1 unk_7 {
tab `v' if smi_diab_compl_ind_n0==1 & smi_diab_compl_ind_p1==0 & `fullp1', matcell(diab) missing
mat t1[`r',1]=diab[2,1]
mat t1[`r',2]=t1[`r',1]/t1[2,1]*100
local r = `r'+1
}

//part 2 - subgroup don't meet criteria p1
tab smi_diab_compl_ind_p1 if smi_diab_compl_ind_n0==1 & `fullp1' & criteria_`c'_p1==0, matcell(diab) missing
mat t1[`r',1]=diab[1,1]
mat t1[`r',2]=t1[`r',1]/t1[1,1]*100

local r=8
foreach v in comorb_10_0_1yr_p1 comorb_11_0_1yr_p1 cc_9_diabetes_1yr_p1 unk_7 {
tab `v' if smi_diab_compl_ind_n0==1 & smi_diab_compl_ind_p1==0 & `fullp1' & criteria_`c'_p1==0, matcell(diab) missing
mat t1[`r',1]=diab[2,1]
mat t1[`r',2]=t1[`r',1]/t1[7,1]*100
local r = `r'+1
}


mat rownames t1="Diabetes n0 with full p1 ivw" "Diabetes n0, not p1" "Diabetes, elix 10 p1" ///
"Diabetes, elix 11 p1" "Diabetes, chronic cond 9 p1" "Unknown, none of above" ///
"Don't meet criteria p1" "Diabetes, elix 10 p1" ///
"Diabetes, elix 11 p1" "Diabetes, chronic cond 9 p1" "Unknown, none of above"

mat list t1

frmttable, statmat(t1) sdec(0,1) store(diab1_`c') ///
ctitles("" "Criteria `c'" "" \ "" "n" "%")

***********************************************************************
//liver disease, have no way to check this one, no indicator for less severe condition
gen unk_8=1 if smi_liver_ind_n0==1 & smi_liver_ind_p1==0 & `fullp1'
label var unk_8 "Reason Liver Disease not meet in p1 unknown"
tab unk_8, missing

//overall n that are alive at p1, complete p1 interview (this matches Tables 7 log, Table 6
tab core_year_n0 if `fullp1', missing 

tab smi_liver_ind_n0  if `fullp1', missing //n that meets n0 with p1 follow up
tab smi_liver_ind_p1 if smi_liver_ind_n0==1 & `fullp1', matcell(liver) missing

mat t1=J(3,2,.)
mat t1[1,1]=r(N)
mat t1[2,1]=liver[1,1]
mat t1[2,2]=t1[2,1]/t1[1,1]*100
mat list t1

//part 2 = subgroup don't meet criteria p1
tab smi_liver_ind_p1 if smi_liver_ind_n0==1 & `fullp1' & criteria_`c'_p1==0, matcell(liver) missing
mat t1[3,1]=liver[1,1]
mat t1[3,2]=t1[3,1]/t1[1,1]*100

mat rownames t1="Liver dis n0 with full p1 ivw" "Liver dis n0, not p1"  ///
"Don't meet criteria p1" 

mat list t1

frmttable, statmat(t1) sdec(0,1) store(liv1_`c') ///
ctitles("" "Criteria `c'" "" \ "" "n" "%")

***********************************************************************
//ALS
gen unk_9=1 if smi_als_ind_n0==1 & smi_als_ind_p1==0 & `fullp1'
label var unk_9 "Reason ALS not meet in p1 unknown"
tab unk_9, missing

//no obs have conflict for criteria b+c so this is a little different than other illnesses
//overall n that are alive at p1, complete p1 interview (this matches Tables 7 log, Table 6
tab core_year_n0 if smi_als_ind_n0==1 & `fullp1', missing //n that meets n0 with p1 follow up
mat t1=J(3,2,.)
mat t1[1,1]=r(N)

//als n0 but not in p1
tab core_year_n0 if smi_als_ind_p1==0 & smi_als_ind_n0==1 & `fullp1', missing
mat t1[2,1]=r(N)
mat t1[2,2]=t1[2,1]/t1[1,1]*100
mat list t1

//now that have als change and also don't meet criteria p1
tab core_year_n0 if smi_als_ind_p1==0 & smi_als_ind_n0==1 & `fullp1' & criteria_`c'_p1==0, missing
mat t1[3,1]=r(N)
mat t1[3,2]=t1[3,1]/t1[1,1]*100

mat rownames t1="ALS n0 with full p1 ivw" "ALS n0, not p1" "Don't meet criteria p1"

mat list t1

frmttable, statmat(t1) sdec(0,1) store(als1_`c') ///
ctitles("" "Criteria `c'" "" \ "" "n" "%")

***********************************************************************
//HIV/AIDS
gen unk_10=1 if smi_hiv_ind_n0==1 & smi_hiv_ind_p1==0 & `fullp1'
label var unk_10 "Reason HIV not meet in p1 unknown"
tab unk_10, missing

//overall n that are alive at p1, complete p1 interview (this matches Tables 7 log, Table 6
tab core_year_n0 if smi_hiv_ind_n0==1 & `fullp1', missing //n that meets n0 with p1 follow up
mat t1=J(3,2,.)
mat t1[1,1]=r(N)

//als n0 but not in p1
tab core_year_n0 if smi_hiv_ind_p1==0 & smi_hiv_ind_n0==1 & `fullp1', missing
mat t1[2,1]=r(N)
mat t1[2,2]=t1[2,1]/t1[1,1]*100
mat list t1

//now that have hiv change and also don't meet criteria p1
tab core_year_n0 if smi_hiv_ind_p1==0 & smi_hiv_ind_n0==1 & `fullp1' & criteria_`c'_p1==0, missing
mat t1[3,1]=r(N)
mat t1[3,2]=t1[3,1]/t1[1,1]*100

mat rownames t1="HIV n0 with full p1 ivw" "HIV n0, not p1" "Don't meet criteria p1"

mat list t1

frmttable, statmat(t1) sdec(0,1) store(hiv1_`c') ///
ctitles("" "Criteria `c'" "" \ "" "n" "%")

***********************************************************************
//hip fracture
gen unk_11=1 if hip_frac_hrs_p1==0  & ///
 smi_hip_ind_n0==1 & smi_hip_ind_p1==0 & `fullp1'
replace unk_11=0 if (hip_frac_hrs_p1==1) & ///
 smi_hip_ind_n0==1 & smi_hip_ind_p1==0 & `fullp1'
label var unk_11 "Reason Hip fracture not meet in p1 unknown"
tab unk_11, missing
//overall n that are alive at p1, complete p1 interview (this matches Tables 7 log, Table 6
tab core_year_n0 if `fullp1', missing 


tab smi_hip_ind_n0  if `fullp1', missing //n that meets n0 with p1 follow up
tab smi_hip_ind_p1 if smi_hip_ind_n0==1 & `fullp1', matcell(hip) missing

mat t1=J(7,2,.)
mat t1[1,1]=r(N)
mat t1[2,1]=hip[1,1]
mat t1[2,2]=t1[2,1]/t1[1,1]*100
mat list t1

//now of this group that meets n0, not p1, why?
//r3: survey, asks if hip fracture since last interview
local r=3
foreach v in hip_frac_hrs_p1 unk_11 {
tab `v' if smi_hip_ind_n0==1 & smi_hip_ind_p1==0 & `fullp1', matcell(hip) missing
mat t1[`r',1]=hip[2,1]
mat t1[`r',2]=t1[`r',1]/t1[2,1]*100
local r = `r'+1
}

tab smi_hip_ind_p1 if smi_hip_ind_n0==1 & `fullp1' & criteria_`c'_p1==0, matcell(hip) missing
mat t1[`r',1]=hip[1,1]
mat t1[`r',2]=t1[`r',1]/t1[1,1]*100

local r=6
foreach v in hip_frac_hrs_p1 unk_11 {
tab `v' if smi_hip_ind_n0==1 & smi_hip_ind_p1==0 & `fullp1'& criteria_`c'_p1==0, matcell(hip) missing
mat t1[`r',1]=hip[2,1]
mat t1[`r',2]=t1[`r',1]/t1[5,1]*100
local r = `r'+1
}

mat rownames t1="Hip fracture n0 with full p1 ivw" "Hip fracture n0, not p1" "Hip fracture self report p1" ///
"Unknown, none of above" "Don't meet criteria p1"  "Hip fracture self report p1" ///
"Unknown, none of above"

mat list t1

frmttable, statmat(t1) sdec(0,1) store(hip1_`c') ///
ctitles("" "Criteria `c'" "" \ "" "n" "%")

****************************************************************************************
//now checking overall percent less severe vs unexplained don't meet criteria
egen unk_index=rowtotal(unk_1 unk_2 unk_3 unk_4 unk_5 unk_6 unk_7 unk_8 unk_9 unk_10 unk_11) 
tab unk_index, missing
tab unk_index unk_1, missing
tab unk_index if `fullp1', missing
tab unk_index if `fullp1'& criteria_`c'_p1==0, missing

//try concat instead
forvalues i = 1/11{
 gen unk_`i'a=unk_`i'
 replace unk_`i'a=9 if unk_`i'==.
}

egen unk_concat=concat(unk_1a unk_2a unk_3a unk_4a unk_5a unk_6a unk_7a unk_8a unk_9a unk_10a unk_11a)
tab unk_concat, missing
tab unk_concat if `fullp1', missing
tab unk_concat if `fullp1'& criteria_`c'_p1==0, missing

gen x1=1 if strpos(unk_concat,"1")
gen x2=1 if strpos(unk_concat,"0")
gen x3=3 if x1==1 & x2==1 //cat 3
replace x3=1 if x1==1 & x2==. //cat 1, not explained
replace x3=2 if x1==. & x2==1 //cat 2, less severe
tab x3 if `fullp1'& criteria_`c'_p1==0, missing
replace x3=1 if x3==. & `fullp1'& criteria_`c'_p1==0
replace x3=2 if x3==3
tab x3  if `fullp1'& criteria_`c'_p1==0, missing

//create table comparing the groups
mat t2=J(8,3,.)
tab x3  if `fullp1'& criteria_`c'_p1==0, matcell(t2m) missing
mat t2[1,1]=r(N) //n  that has interview, does not meet criteria p1
mat t2[2,1]=t2m[1,1] //not explained
mat t2[2,2]=t2[2,1]/t2[1,1]*100
mat t2[3,1]=t2m[2,1] //less severe
mat t2[3,2]=t2[3,1]/t2[1,1]*100

//get percent with adl improved
tab adl_better_p1 if `fullp1'& criteria_`c'_p1==0, matcell(t2m) missing
mat t2[4,1]=t2m[1,1] //better
mat t2[4,2]=t2[4,1]/t2[1,1]*100

//now get mc spending for those that meet vs not meet
sum tot_paid_by_mc_12m_wi_n0 if `fullp1'& criteria_`c'_p1==0
mat t2[5,1]=r(mean) 
sum tot_paid_by_mc_12m_wi_n0 if `fullp1'& criteria_`c'_p1==1
mat t2[6,1]=r(mean) 
sum tot_paid_by_mc_12m_wi_p1 if `fullp1'& criteria_`c'_p1==0
mat t2[7,1]=r(mean) 
sum tot_paid_by_mc_12m_wi_p1 if `fullp1'& criteria_`c'_p1==1
mat t2[8,1]=r(mean) 

mat rownames t2="N do not meet in p1" "Reason unknown" "Less severe condition coded" ///
"ADL Improved p1" "MC spend 1yr after n0, meet=0" "MC spend 1yr after n0, meet=1" ///
"MC spend 1yr after p1, meet=0" "MC spend 1yr after p1, meet=1"
frmttable, statmat(t2) sdec(0,1) store(x31_`c') ///
ctitles("" "Criteria `c'" "" \ "" "n" "%")

//export into csv for figure
//drop if missing followup altogether
	gen p1_miss = 0
	replace p1_miss = 1 if (core_to_dod_2yr_n0==1 & ind_x_interview==0) | ///
		(core_to_dod_2yr_n0==0 & ind_p1_interview==0) | ///
		(core_to_dod_2yr_n0==0 & ind_p1_interview==1 & (part_ab_12m_p1!=1 | hmo_d_12m_p1!=0))
	tab p1_miss, missing
	drop if p1_miss==1

gen stat_p1_cat=0 if core_to_dod_1yr_p1 //died

replace stat_p1_cat=1 if `fullp1'& criteria_`c'_p1==1 //meet criteria p1

replace stat_p1_cat=2 if `fullp1'& criteria_`c'_p1==0 & x3==2 //less severe p1

replace stat_p1_cat=3 if `fullp1'& criteria_`c'_p1==0 & x3==1 //don't meet, unknown reason

la def stat_p1_cat 0 "Died" 1 "Seriously ill" 2 "Lower severity illness" 3 "No longer meets"
la val stat_p1_cat stat_p1_cat
tab stat_p1_cat, missing gen(stat_p1_cat)

collapse (mean) stat_p1_cat1 stat_p1_cat2 stat_p1_cat3 stat_p1_cat4 (count) criteria_`c'_n0
list

//export excel excel_means_`c'_2, replace
outsheet using excel_means_`c'_2.csv, comma replace
}

****************************************************************************************
//now combine, output tables
//adl - starts the out document
outreg, replay(adl1_smi) merge(adl1_a) store(adl1)
outreg, replay(adl1) merge(adl1_b) store(adl2)
outreg using `logpath'\11c_sic_n0p1check, replay(adl2) merge(adl1_c) landscape ///
title("Table 1 - ADL Functional Limitations change") replace ///
note("Serious illness = Any serious medical illness" \ ///
"Criteria A = Any serious medical illness and/or ADL impairment" \ ///
"Criteria B = Criteria A and Urgent / Emergent hospitalization and/or NH resident" \ ///
"Criteria C = Medical illness and ADL Impairment and hospitalization and/or NH resident")


//dementia
outreg, replay(alz1_smi) merge(alz1_a) store(alz1)
outreg, replay(alz1) merge(alz1_b) store(alz2)
outreg using `logpath'\11c_sic_n0p1check, replay(alz2) merge(alz1_c) landscape ///
title("Table 2 - Alzheimer's/ Dementia change") addtable ///
note("Serious illness = Any serious medical illness" \ ///
"Criteria A = Any serious medical illness and/or ADL impairment" \ ///
"Criteria B = Criteria A and Urgent / Emergent hospitalization and/or NH resident" \ ///
"Criteria C = Medical illness and ADL Impairment and hospitalization and/or NH resident" \ ///
"Unknown = not elix, cc, report of fair/poor, worse or same, impaired tics" \ ///
"Memory rating by self report or proxy interview" \ ///
"TICS for self interview only, <=8=MCI or Dementia" )

//cancer
outreg, replay(cancer1_smi) merge(cancer1_a) store(cancer1)
outreg, replay(cancer1) merge(cancer1_b) store(cancer2)
outreg using `logpath'\11c_sic_n0p1check, replay(cancer2) merge(cancer1_c) landscape ///
title("Table 3 - Metastatic or Hematologic Cancer change") addtable ///
note("Serious illness = Any serious medical illness" \ ///
"Criteria A = Any serious medical illness and/or ADL impairment" \ ///
"Criteria B = Criteria A and Urgent / Emergent hospitalization and/or NH resident" \ ///
"Criteria C = Medical illness and ADL Impairment and hospitalization and/or NH resident")

//renal failure
outreg, replay(esrd1_smi) merge(esrd1_a) store(esrd1)
outreg, replay(esrd1) merge(esrd1_b) store(esrd2)
outreg using `logpath'\11c_sic_n0p1check, replay(esrd2) merge(esrd1_c) landscape ///
title("Table 4 - Renal failure change") addtable ///
note("Serious illness = Any serious medical illness" \ ///
"Criteria A = Any serious medical illness and/or ADL impairment" \ ///
"Criteria B = Criteria A and Urgent / Emergent hospitalization and/or NH resident" \ ///
"Criteria C = Medical illness and ADL Impairment and hospitalization and/or NH resident")

//heart failure
outreg, replay(chf1_smi) merge(chf1_a) store(chf1)
outreg, replay(chf1) merge(chf1_b) store(chf2)
outreg using `logpath'\11c_sic_n0p1check, replay(chf2) merge(chf1_c) landscape ///
title("Table 5 - Heart failure change") addtable ///
note("Serious illness = Any serious medical illness" \ ///
"Criteria A = Any serious medical illness and/or ADL impairment" \ ///
"Criteria B = Criteria A and Urgent / Emergent hospitalization and/or NH resident" \ ///
"Criteria C = Medical illness and ADL Impairment and hospitalization and/or NH resident")

//copd
outreg, replay(copd1_smi) merge(copd1_a) store(copd1)
outreg, replay(copd1) merge(copd1_b) store(copd2)
outreg using `logpath'\11c_sic_n0p1check, replay(copd2) merge(copd1_c) landscape ///
title("Table 6 - COPD change") addtable ///
note("Serious illness = Any serious medical illness" \ ///
"Criteria A = Any serious medical illness and/or ADL impairment" \ ///
"Criteria B = Criteria A and Urgent / Emergent hospitalization and/or NH resident" \ ///
"Criteria C = Medical illness and ADL Impairment and hospitalization and/or NH resident")

outreg, replay(diab1_smi) merge(diab1_a) store(diab1)
outreg, replay(diab1) merge(diab1_b) store(diab2)
outreg using `logpath'\11c_sic_n0p1check, replay(diab2) merge(diab1_c) landscape ///
title("Table 7 - Diabetes change") addtable ///
note("Serious illness = Any serious medical illness" \ ///
"Criteria A = Any serious medical illness and/or ADL impairment" \ ///
"Criteria B = Criteria A and Urgent / Emergent hospitalization and/or NH resident" \ ///
"Criteria C = Medical illness and ADL Impairment and hospitalization and/or NH resident")

//liver disease
outreg, replay(liv1_smi) merge(liv1_a) store(liv1)
outreg, replay(liv1) merge(liv1_b) store(liv2)
outreg using `logpath'\11c_sic_n0p1check, replay(liv2) merge(liv1_c) landscape ///
title("Table 8 - Liver disease change") addtable ///
note("Serious illness = Any serious medical illness" \ ///
"Criteria A = Any serious medical illness and/or ADL impairment" \ ///
"Criteria B = Criteria A and Urgent / Emergent hospitalization and/or NH resident" \ ///
"Criteria C = Medical illness and ADL Impairment and hospitalization and/or NH resident" \ ///
"Serious liver disease = elixhauser 14, we do not have an indicator for less severe" \ ///
"liver disease to partially explain the switch from yes in n0 to no in p1 so all cases are unexplained")

//ALS
outreg, replay(als1_smi) merge(als1_a) store(als1)
outreg, replay(als1) merge(als1_b) store(als2)
outreg using `logpath'\11c_sic_n0p1check, replay(als2) merge(als1_c) landscape ///
title("Table 9 - ALS change") addtable ///
note("Serious illness = Any serious medical illness" \ ///
"Criteria A = Any serious medical illness and/or ADL impairment" \ ///
"Criteria B = Criteria A and Urgent / Emergent hospitalization and/or NH resident" \ ///
"Criteria C = Medical illness and ADL Impairment and hospitalization and/or NH resident" \ ///
"ALS = elixhauser 33, we do not have an indicator for less severe" \ ///
"ALS to partially explain the switch from yes in n0 to no in p1 so all cases are unexplained")

//hiv/aids
outreg, replay(hiv1_smi) merge(hiv1_a) store(hiv1)
outreg, replay(hiv1) merge(hiv1_b) store(hiv2)
outreg using `logpath'\11c_sic_n0p1check, replay(hiv2) merge(hiv1_c) landscape ///
title("Table 10 - HIV/AIDS change") addtable ///
note("Serious illness = Any serious medical illness" \ ///
"Criteria A = Any serious medical illness and/or ADL impairment" \ ///
"Criteria B = Criteria A and Urgent / Emergent hospitalization and/or NH resident" \ ///
"Criteria C = Medical illness and ADL Impairment and hospitalization and/or NH resident"\ ///
"HIV = elixhauser 16, we do not have an indicator for less severe" \ ///
"HIV to partially explain the switch from yes in n0 to no in p1 so all cases are unexplained")

//hip fracture
outreg, replay(hip1_smi) merge(hip1_a) store(hip1)
outreg, replay(hip1) merge(hip1_b) store(hip2)
outreg using `logpath'\11c_sic_n0p1check, replay(hip2) merge(hip1_c) landscape ///
title("Table 11 - Hip fracture change") addtable ///
note("Serious illness = Any serious medical illness" \ ///
"Criteria A = Any serious medical illness and/or ADL impairment" \ ///
"Criteria B = Criteria A and Urgent / Emergent hospitalization and/or NH resident" \ ///
"Criteria C = Medical illness and ADL Impairment and hospitalization and/or NH resident")

//unexplained vs explained, and mc spending totals
outreg, replay(x31_smi) merge(x31_a) store(x31)
outreg, replay(x31) merge(x31_b) store(x32)
outreg using `logpath'\11c_sic_n0p1check, replay(x32) merge(x31_c) landscape ///
title("Table 12 - Overall percent explained") addtable ///
note("Serious illness = Any serious medical illness" \ ///
"Criteria A = Any serious medical illness and/or ADL impairment" \ ///
"Criteria B = Criteria A and Urgent / Emergent hospitalization and/or NH resident" \ ///
"Criteria C = Medical illness and ADL Impairment and hospitalization and/or NH resident")
***********************************************************************
//and make bar graph showing p1 follow up, figure 1
clear

insheet using import_means_2.csv

sum n if _n==1
local n_a = r(mean)

sum n if _n==2
local n_b = r(mean)

sum n if _n==3
local n_c = r(mean)

graph hbar p1_died p1_meet p1_less_severe p1_no_longer_meets , over(v1) percentage stack ///
	blabel(bar, position(center) format(%3.1f)) ///
	legend(lab(1 "Died") lab(2 "Seriously Ill") ///
	lab(3 "Lower Severity Illness") lab(4 "No Longer Meets Criteria")) ///
	text(-1 79 "n=`n_a'", place(w)) ///
	text(-1 44 "n=`n_b'", place(w)) ///
	text(-1 9 "n=`n_c'", place(w)) ///
	title("Figure 1. Two Year Follow Up")
	
graph save `logpath'\bar_graph_Figure1_p1_status, replace	


***********************************************************************
log close



H="Redo n0 p1 change in status chart for hsr revision"
//looking at n0/p1 conflicts

capture log close

clear all
set more off

local logpath E:\data\serious_ill\logs
log using `logpath'\11c_n0p1_check_log.txt, text replace

cd E:\data\serious_ill\final_data
/*
use n0_n1_p1_p2_x_criteria_a_v1.dta if core_year_n0<2010,clear
tab falls_hrs_n0, missing
//start with cancer group n=126 that have yes in n0, no in p1
tab smi_cancer_ind_n0 smi_cancer_ind_p1, missing

//check elix
tab comorb_17_0_1yr_n0 comorb_17_0_1yr_p1 if smi_cancer_ind_n0==1 & smi_cancer_ind_p1==0
tab comorb_18_0_1yr_n0 comorb_18_0_1yr_p1 if smi_cancer_ind_n0==1 & smi_cancer_ind_p1==0
tab comorb_19_0_1yr_n0 comorb_19_0_1yr_p1 if smi_cancer_ind_n0==1 & smi_cancer_ind_p1==0

//check chronic conditions
tab cc_cncr_chronic_1yr_n0 cc_cncr_chronic_1yr_p1 if smi_cancer_ind_n0==1 & smi_cancer_ind_p1==0

gen cancer_cc_and_elix_p1=1 if comorb_17_0_1yr_p1==1 | comorb_18_0_1yr_p1==1 | comorb_19_0_1yr_p1==1 | cc_cncr_chronic_1yr_p1==1
replace cancer_cc_and_elix_p1=0 if comorb_17_0_1yr_p1==0 & comorb_18_0_1yr_p1==0 & comorb_19_0_1yr_p1==0 & cc_cncr_chronic_1yr_p1==0

tab cancer_cc_and_elix_p1 if smi_cancer_ind_n0==1 & smi_cancer_ind_p1==0

*******************************************************************************
//look at ADL change = impaired n0 but not in p1 n=383
tab adl_impair_core_n0 adl_impair_core_p1, matcell(t1) missing

**most had help with only one of the adl items in the n0 interview
tab adl_index_core_n0 adl_index_core_p1 if adl_ind_core_n_n0==0 & adl_ind_core_n_p1==1, missing
**had helper listed in the n0 interview but not in the p1 interview
tab adl_help_ind_n0 adl_help_ind_p1 if adl_ind_core_n_n0==0 & adl_ind_core_n_p1==1, missing
**hours per month help received, from helper file
sum adl_hlp_freq_imp_mo_n0  if adl_ind_core_n_n0==0 & adl_ind_core_n_p1==1
sum adl_hlp_freq_imp_mo_p1  if adl_ind_core_n_n0==0 & adl_ind_core_n_p1==1

//self report nursing home
tab nhres_n0 ind_snf_use_12m_n0 if adl_ind_core_n_n0==0 & adl_ind_core_n_p1==1, missing
tab nhres_p1 ind_snf_use_12m_p1 if adl_ind_core_n_n0==0 & adl_ind_core_n_p1==1, missing

//hospital admission
**self report since last core interview
tab hosp_last_2yr_n0 hosp_last_2yr_p1 if adl_ind_core_n_n0==0 & adl_ind_core_n_p1==1, missing
**from claims
tab ind_hosp_adm_12m_n0 ind_hosp_adm_12m_p1 if adl_ind_core_n_n0==0 & adl_ind_core_n_p1==1, missing

//if adl difficulty reported, what happens to the changes??
gen adl_diff_index_n0=adl_diff_dr_n0 + adl_diff_wk_n0 + adl_diff_bh_n0 + ///
 adl_diff_e_n0 + adl_diff_tx_n0 + adl_diff_t_n0
gen adl_diff_index_p1=adl_diff_dr_p1 + adl_diff_wk_p1 + adl_diff_bh_p1 + ///
 adl_diff_e_p1 + adl_diff_tx_p1 + adl_diff_t_p1
 
gen adl_diff_yes_n0=1 if adl_diff_index_n0>0 & adl_diff_index_n0~=.
replace adl_diff_yes_n0=0 if adl_diff_index_n0==0
gen adl_diff_yes_p1=1 if adl_diff_index_p1>0 & adl_diff_index_p1~=.
replace adl_diff_yes_p1=0 if adl_diff_index_p1==0

tab adl_diff_yes_n0 adl_diff_yes_p1 if adl_ind_core_n_n0==0 & adl_ind_core_n_p1==1, missing

//do they have illness?
tab ser_med_illness_n0 ser_med_illness_p1 if adl_ind_core_n_n0==0 & adl_ind_core_n_p1==1, missing
// Why are some missing in p1??? - because they don't have the p1 interview
tab xwalk_yes_p1 ser_med_illness_p1,missing
tab ser_med_illness_p1 core_year_p1 if adl_ind_core_n_n0==0 & adl_ind_core_n_p1==1 ///
& ind_p1_interview==1 & part_ab_12m_p1==1 & hmo_d_12m_p1==0,missing
*/
***********************************************************************
***********************************************************************
//tabulation
local fullp1 ind_p1_interview==1 & part_ab_12m_p1==1 & hmo_d_12m_p1==0 & year(c_ivw_date_p1<=2011)

foreach c in a b c {
use n0_n1_p1_p2_x_criteria_`c'_v1.dta if core_year_n0<2012, clear
//adl status change table
//if adl difficulty reported, what happens to the changes??
gen adl_diff_index_n0=adl_diff_dr_n0 + adl_diff_wk_n0 + adl_diff_bh_n0 + ///
 adl_diff_e_n0 + adl_diff_tx_n0 + adl_diff_t_n0
gen adl_diff_index_p1=adl_diff_dr_p1 + adl_diff_wk_p1 + adl_diff_bh_p1 + ///
 adl_diff_e_p1 + adl_diff_tx_p1 + adl_diff_t_p1
 
gen adl_diff_yes_n0=1 if adl_diff_index_n0>0 & adl_diff_index_n0~=.
replace adl_diff_yes_n0=0 if adl_diff_index_n0==0
gen adl_diff_yes_p1=1 if adl_diff_index_p1>0 & adl_diff_index_p1~=.
replace adl_diff_yes_p1=0 if adl_diff_index_p1==0

//additional buckets - aggregated from above buckets
//still have trouble but not getting help
gen adl_trouble_no_help_p1=1 if (adl_diff_yes_p1==1 | falls_hrs_p1==1) & ///
 adl_impair_core_n0==1 & adl_impair_core_p1==0 & `fullp1'
gen adl_better_p1=1 if (adl_diff_yes_p1==0 & falls_hrs_p1==1) & ///
(falls_hrs_n0==1 | smi_hip_ind_n0==1 | hip_frac_hrs_n0==1 | cc_11_hipfrac_1yr_n0==1 ) & ///
 adl_impair_core_n0==1 & adl_impair_core_p1==0 & `fullp1'

tab adl_trouble_no_help_p1 adl_better_p1 , missing

//unknown reason
gen unk_1=1 if adl_trouble_no_help_p1==0 & adl_better_p1==0 & ///
adl_impair_core_n0==1 & adl_impair_core_p1==0 & `fullp1'
replace unk_1=0 if (adl_trouble_no_help_p1==1 | adl_better_p1==1) & ///
adl_impair_core_n0==1 & adl_impair_core_p1==0 & `fullp1'
la var unk_1 "Reason ADL not meet in p1 unknown"
tab unk_1, missing

//part 1 - meet ADL in n0, do not meet ADL in p1, regardless of overall criteria status
//overall n that are alive at p1, complete p1 interview (this matches Tables 7 log, Table 6
tab core_year_n0 if `fullp1', missing 
//functional status
tab adl_impair_core_n0  if `fullp1', missing //n that meets n0 with p1 follow up
tab adl_impair_core_p1 if adl_impair_core_n0==1 & `fullp1', matcell(adl) missing

mat t1=J(21,2,.)
mat t1[1,1]=r(N)
mat t1[2,1]=adl[1,1]
mat t1[2,2]=t1[2,1]/t1[1,1]*100
mat list t1

//now of this group that meets n0, not p1, why?
//r3: change from receiving help to having difficulty but not receiving help
//r4-6: what about hip fracture n0, could explain if getting better
//r7-8: falls n0 and p1
local r=3
foreach v in adl_diff_yes_p1 smi_hip_ind_n0 hip_frac_hrs_n0 cc_11_hipfrac_1yr_n0 ///
 falls_hrs_n0 falls_hrs_p1 unk_1 {
tab `v' if adl_impair_core_n0==1 & adl_impair_core_p1==0 & `fullp1', matcell(adl) missing
mat t1[`r',1]=adl[2,1]
mat t1[`r',2]=t1[`r',1]/t1[2,1]*100
local r = `r'+1
}

foreach v in  adl_trouble_no_help_p1 adl_better_p1 {
tab `v' if adl_impair_core_n0==1 & adl_impair_core_p1==0 & `fullp1', matcell(adl) missing
mat t1[`r',1]=adl[1,1]
mat t1[`r',2]=t1[`r',1]/t1[2,1]*100
local r = `r'+1
}

//part 2 - meet ADL in n0, do not meet ADL in p1, and do not meet overall criteria in p1
tab adl_impair_core_p1 if adl_impair_core_n0==1 & criteria_`c'_p1==0 & `fullp1', matcell(adl) missing
mat t1[12,1]=adl[1,1]
mat t1[12,2]=t1[`r',1]/t1[1,1]*100
mat list t1

local r=13
foreach v in adl_diff_yes_p1 smi_hip_ind_n0 hip_frac_hrs_n0 cc_11_hipfrac_1yr_n0 ///
 falls_hrs_n0 falls_hrs_p1 unk_1 {
tab `v' if adl_impair_core_n0==1 & adl_impair_core_p1==0 & criteria_`c'_p1==0 & `fullp1', matcell(adl) missing
mat t1[`r',1]=adl[2,1]
mat t1[`r',2]=t1[`r',1]/t1[12,1]*100
local r = `r'+1
}

foreach v in adl_trouble_no_help_p1 adl_better_p1 {
tab `v' if adl_impair_core_n0==1 & adl_impair_core_p1==0 & criteria_`c'_p1==0 & `fullp1', matcell(adl) missing
mat t1[`r',1]=adl[2,1]
mat t1[`r',2]=t1[`r',1]/t1[12,1]*100
local r = `r'+1
}

mat rownames t1="ADL Impaired n0 with full p1 ivw" "ADL Impaired n0, not p1" "Receive help n0, diff only p1" ///
"Hip fracture n0 per SMI def" "Hip fracture n0 self report" /// 
"Hip fracture chronic cond" "Fall n0 per self report"  "Fall p1 per self report" ///
"Unknown, none of above" "Still difficulty but no help" "ADL - recovered" "Don't meet criteria p1" ///
 "Receive help n0, diff only p1" ///
"Hip fracture n0 per SMI def" "Hip fracture n0 self report" /// 
"Hip fracture chronic cond" "Fall n0 per self report"  "Fall p1 per self report" ///
"Unknown, none of above" "Still difficulty but no help" "ADL - recovered" 

mat list t1

frmttable, statmat(t1) sdec(0,1) store(adl1_`c') ///
ctitles("" "Criteria `c'" "" \ "" "n" "%")

***********************************************************************
//Alzheimer's/dementia

//generate memory variables consistent across proxy and self report
gen mem_fp_p1=1 if inlist(sr_memory_p1,4,5) | inlist(pr_memory_p1,4,5)
replace mem_fp_p1=0 if inlist(sr_memory_p1,1,2,3) | inlist(pr_memory_p1,1,2,3)
tab mem_fp_p1, missing

gen mem_worse_p1=1 if sr_mem_change_p1==3 | pr_mem_change_p1==3
replace mem_worse_p1=0 if inlist(sr_mem_change_p1,1,2) | inlist(pr_mem_change_p1,1,2)

gen mem_same_p1=1 if sr_mem_change_p1==2 | pr_mem_change_p1==2
replace mem_same_p1=0 if inlist(sr_mem_change_p1,1,3) | inlist(pr_mem_change_p1,1,3)

gen mem_better_p1=1 if sr_mem_change_p1==1 | pr_mem_change_p1==1
replace mem_better_p1=0 if inlist(sr_mem_change_p1,2,3) | inlist(pr_mem_change_p1,2,3)

gen tics_mem_prob_p1=1 if inlist(tics_cat_p1,2,3)
replace tics_mem_prob_p1=0 if tics_cat_p1==1

//unknown reason
gen unk_2=1 if comorb_31_0_1yr_p1==0 & cc_3_alzhdmta_1yr_p1==0 & ///
 mem_fp_p1==0 & mem_worse_p1==0  & tics_mem_prob_p1==0 & ///
 smi_dem_ind_n0==1 & smi_dem_ind_p1==0 & `fullp1'
replace unk_2=0 if comorb_31_0_1yr_p1==1 | cc_3_alzhdmta_1yr_p1==1 | ///
 mem_fp_p1==1 | mem_worse_p1==1 | tics_mem_prob_p1==1 & ///
 (smi_dem_ind_n0==1 & smi_dem_ind_p1==0 & `fullp1')
la var unk_2 "Reason Dementia not meet in p1 unknown"
tab unk_2, missing

//overall n that are alive at p1, complete p1 interview (this matches Tables 7 log, Table 6
tab core_year_n0 if `fullp1', missing 
//functional status
tab smi_dem_ind_n0  if `fullp1', missing //n that meets n0 with p1 follow up
tab smi_dem_ind_p1 if smi_dem_ind_n0==1 & `fullp1', matcell(alz) missing

mat t1=J(19,2,.)
mat t1[1,1]=r(N)
mat t1[2,1]=alz[1,1]
mat t1[2,2]=t1[2,1]/t1[1,1]*100
mat list t1

//now of this group that meets n0, not p1, why?
//r3: elix
//r4: chronic conditions
//r5-8: self or proxy report during interview
//r9: tics from ivw
local r=3
foreach v in comorb_31_0_1yr_p1 cc_3_alzhdmta_1yr_p1 mem_fp_p1 mem_worse_p1 ///
  mem_same_p1 mem_better_p1 tics_mem_prob_p1 unk_2 {
tab `v' if smi_dem_ind_n0==1 & smi_dem_ind_p1==0 & `fullp1', matcell(alz) missing
mat t1[`r',1]=alz[2,1]
mat t1[`r',2]=t1[`r',1]/t1[2,1]*100
local r = `r'+1
}

//now get n that don't meet the overall criteria p1
tab smi_dem_ind_p1 if smi_dem_ind_n0==1 & `fullp1' & criteria_`c'_p1==0, matcell(alz) missing
mat t1[11,1]=alz[1,1]
mat t1[11,2]=t1[11,1]/t1[1,1]*100
local r=12
foreach v in comorb_31_0_1yr_p1 cc_3_alzhdmta_1yr_p1 mem_fp_p1 mem_worse_p1 ///
  mem_same_p1 mem_better_p1 tics_mem_prob_p1 unk_2 {
tab `v' if smi_dem_ind_n0==1 & smi_dem_ind_p1==0 & `fullp1' & criteria_`c'_p1==0, matcell(alz) missing
mat t1[`r',1]=alz[2,1]
mat t1[`r',2]=t1[`r',1]/t1[11,1]*100
local r = `r'+1
}

mat rownames t1="Alz/Dementia n0 with full p1 ivw" "Alz/Dementia n0, not p1" "Elix definition p1" ///
"Chronic condition def" "p1 report poor/fair memory" /// 
"p1 report worse memory" "p1 same memory"  "p1 better memory" ///
"p1 TICS MCI or Dementia" "Unknown, none of above" "Don't meet criteria p1" ///
"Elix definition p1" ///
"Chronic condition def" "p1 report poor/fair memory" /// 
"p1 report worse memory" "p1 same memory"  "p1 better memory" ///
"p1 TICS MCI or Dementia" "Unknown, none of above" 

mat list t1

frmttable, statmat(t1) sdec(0,1) store(alz1_`c') ///
ctitles("" "Criteria `c'" "" \ "" "n" "%")

***********************************************************************
//cancer

gen unk_3=1 if comorb_17_0_1yr_p1==0 & comorb_19_0_1yr_p1==0 & cc_cncr_chronic_1yr_p1==0 & ///
 smi_cancer_ind_n0==1 & smi_cancer_ind_p1==0 & `fullp1'
replace unk_3=0 if (comorb_17_0_1yr_p1==1 | comorb_19_0_1yr_p1==1 | cc_cncr_chronic_1yr_p1==1) & ///
 smi_cancer_ind_n0==1 & smi_cancer_ind_p1==0 & `fullp1' 
label var unk_3 "Reason Cancer not meet in p1 unknown"
tab unk_3, missing

//overall n that are alive at p1, complete p1 interview (this matches Tables 7 log, Table 6
tab core_year_n0 if `fullp1', missing 
//functional status
tab smi_cancer_ind_n0  if `fullp1', missing //n that meets n0 with p1 follow up
tab smi_cancer_ind_p1 if smi_cancer_ind_n0==1 & `fullp1', matcell(cancer) missing

mat t1=J(11,2,.)
mat t1[1,1]=r(N)
mat t1[2,1]=cancer[1,1]
mat t1[2,2]=t1[2,1]/t1[1,1]*100
mat list t1

//now of this group that meets n0, not p1, why?
//r3-5: other elixhauser definitions
//r6: chronic conditions
local r=3
foreach v in comorb_17_0_1yr_p1 comorb_19_0_1yr_p1 cc_cncr_chronic_1yr_p1 unk_3 {
tab `v' if smi_cancer_ind_n0==1 & smi_cancer_ind_p1==0 & `fullp1', matcell(cancer) missing
mat t1[`r',1]=cancer[2,1]
mat t1[`r',2]=t1[`r',1]/t1[2,1]*100
local r = `r'+1
}

//part 2 - group that doesn't meet criteria p1
tab smi_cancer_ind_p1 if smi_cancer_ind_n0==1 & `fullp1' & criteria_`c'_p1==0, matcell(cancer) missing
mat t1[`r',1]=cancer[1,1]
mat t1[`r',2]=t1[`r',1]/t1[1,1]*100

local r=8
foreach v in comorb_17_0_1yr_p1 comorb_19_0_1yr_p1 cc_cncr_chronic_1yr_p1 unk_3 {
tab `v' if smi_cancer_ind_n0==1 & smi_cancer_ind_p1==0 & `fullp1' & criteria_`c'_p1==0, matcell(cancer) missing
mat t1[`r',1]=cancer[2,1]
mat t1[`r',2]=t1[`r',1]/t1[7,1]*100
local r = `r'+1
}

mat rownames t1="Cancer n0 with full p1 ivw" "Cancer n0, not p1" "Elix 17 Lymphoma" ///
"Elix 19 Solid tumor wo Metast" "Cancer per chronic cond" /// 
"Unknown, none of above" "Don't meet criteria p1" ///
"Elix 17 Lymphoma" ///
"Elix 19 Solid tumor wo Metast" "Cancer per chronic cond" /// 
"Unknown, none of above"

mat list t1

frmttable, statmat(t1) sdec(0,1) store(cancer1_`c') ///
ctitles("" "Criteria `c'" "" \ "" "n" "%")

***********************************************************************
//Renal failure

gen unk_4=1 if comorb_34_0_1yr_p1==0 & smi_esrd_ind_n0==1 & smi_esrd_ind_p1==0 & `fullp1'
replace unk_4=0 if comorb_34_0_1yr_p1==1 & ///
 smi_esrd_ind_n0==1 & smi_esrd_ind_p1==0 & `fullp1' 
label var unk_4 "Reason Renal Failure not meet in p1 unknown"
tab unk_4, missing

//overall n that are alive at p1, complete p1 interview (this matches Tables 7 log, Table 6
tab core_year_n0 if `fullp1', missing 
//ESRD SMI status
tab smi_esrd_ind_n0  if `fullp1', missing //n that meets n0 with p1 follow up
tab smi_esrd_ind_p1 if smi_esrd_ind_n0==1 & `fullp1', matcell(esrd) missing

mat t1=J(7,2,.)
mat t1[1,1]=r(N)
mat t1[2,1]=esrd[1,1]
mat t1[2,2]=t1[2,1]/t1[1,1]*100
mat list t1

//now of this group that meets n0, not p1, why?
//r2: elix renal disease definition
local r=3
foreach v in comorb_34_0_1yr_p1 unk_4  {
tab `v' if smi_esrd_ind_n0==1 & smi_esrd_ind_p1==0 & `fullp1', matcell(esrd) missing
mat t1[`r',1]=esrd[2,1]
mat t1[`r',2]=t1[`r',1]/t1[2,1]*100
local r = `r'+1
}
//part 2 - subgroup that doesn't meet overall criteria p1
tab smi_esrd_ind_p1 if smi_esrd_ind_n0==1 & `fullp1' & criteria_`c'_p1==0, matcell(esrd) missing
mat t1[`r',1]=esrd[1,1]
mat t1[`r',2]=t1[`r',1]/t1[1,1]*100

local r=6
foreach v in comorb_34_0_1yr_p1 unk_4  {
tab `v' if smi_esrd_ind_n0==1 & smi_esrd_ind_p1==0 & `fullp1' & criteria_`c'_p1==0, matcell(esrd) missing
mat t1[`r',1]=esrd[2,1]
mat t1[`r',2]=t1[`r',1]/t1[5,1]*100
local r = `r'+1
}

mat rownames t1="Renal fail n0 with full p1 ivw" "Renal failure n0, not p1" "Renal disease, elix 34 p1" ///
"Unknown, none of above" "Don't meet criteria p1" "Renal disease, elix 34 p1" ///
"Unknown, none of above"

mat list t1

frmttable, statmat(t1) sdec(0,1) store(esrd1_`c') ///
ctitles("" "Criteria `c'" "" \ "" "n" "%")

***********************************************************************
//Heart failure
gen unk_5=1 if comorb_1_0_1yr_p1==0 & cc_8_chf_1yr_p1==0 & ///
 smi_chf_ind_n0==1 & smi_chf_ind_p1==0 & `fullp1'
replace unk_5=0 if (comorb_1_0_1yr_p1==1 | cc_8_chf_1yr_p1==1) & ///
 smi_chf_ind_n0==1 & smi_chf_ind_p1==0 & `fullp1' 
label var unk_5 "Reason Heart Failure not meet in p1 unknown"
tab unk_5, missing

//overall n that are alive at p1, complete p1 interview (this matches Tables 7 log, Table 6
tab core_year_n0 if `fullp1', missing 
//heart failure
tab smi_chf_ind_n0  if `fullp1', missing //n that meets n0 with p1 follow up
tab smi_chf_ind_p1 if smi_chf_ind_n0==1 & `fullp1', matcell(chf) missing

mat t1=J(9,2,.)
mat t1[1,1]=r(N)
mat t1[2,1]=chf[1,1]
mat t1[2,2]=t1[2,1]/t1[1,1]*100
mat list t1

//now of this group that meets n0, not p1, why?
//r3: elix
//r4: cc
local r=3
foreach v in comorb_1_0_1yr_p1 cc_8_chf_1yr_p1 unk_5 {
tab `v' if smi_chf_ind_n0==1 & smi_chf_ind_p1==0 & `fullp1', matcell(chf) missing
mat t1[`r',1]=chf[2,1]
mat t1[`r',2]=t1[`r',1]/t1[2,1]*100
local r = `r'+1
}

tab smi_chf_ind_p1 if smi_chf_ind_n0==1 & `fullp1' & criteria_`c'_p1==0, matcell(chf) missing
mat t1[`r',1]=chf[1,1]
mat t1[`r',2]=t1[`r',1]/t1[1,1]*100

local r=7
foreach v in comorb_1_0_1yr_p1 cc_8_chf_1yr_p1 unk_5 {
tab `v' if smi_chf_ind_n0==1 & smi_chf_ind_p1==0 & `fullp1' & criteria_`c'_p1==0, matcell(chf) missing
mat t1[`r',1]=chf[2,1]
mat t1[`r',2]=t1[`r',1]/t1[6,1]*100
local r = `r'+1
}


mat rownames t1="CHF n0 with full p1 ivw" "CHF n0, not p1" "CHF, elix 1 p1" ///
"CHF, chronic cond 8 p1" "Unknown, none of above" "Don't meet criteria p1" ///
"CHF, elix 1 p1" "CHF, chronic cond 8 p1" "Unknown, none of above"

mat list t1

frmttable, statmat(t1) sdec(0,1) store(chf1_`c') ///
ctitles("" "Criteria `c'" "" \ "" "n" "%")

***********************************************************************
//COPD
gen unk_6=1 if comorb_9_0_1yr_p1==0 & cc_7_copd_1yr_p1==0 & lung_o2_hrs_p1==0 & ///
 smi_copd_ind_n0==1 & smi_copd_ind_p1==0 & `fullp1'
replace unk_6=0 if (comorb_1_0_1yr_p1==1 | cc_8_chf_1yr_p1==1 | lung_o2_hrs_p1==1) & ///
 smi_copd_ind_n0==1 & smi_copd_ind_p1==0 & `fullp1' 
label var unk_6 "Reason COPD not meet in p1 unknown"
tab unk_6, missing

//overall n that are alive at p1, complete p1 interview (this matches Tables 7 log, Table 6
tab core_year_n0 if `fullp1', missing 

tab smi_copd_ind_n0  if `fullp1', missing //n that meets n0 with p1 follow up
tab smi_copd_ind_p1 if smi_copd_ind_n0==1 & `fullp1', matcell(copd) missing

mat t1=J(11,2,.)
mat t1[1,1]=r(N)
mat t1[2,1]=copd[1,1]
mat t1[2,2]=t1[2,1]/t1[1,1]*100
mat list t1

//now of this group that meets n0, not p1, why?
//r3: elix
//r4: cc
//r5: self report of oxygen use for lung condition
local r=3
foreach v in comorb_9_0_1yr_p1 cc_7_copd_1yr_p1 lung_o2_hrs_p1 unk_6 {
tab `v' if smi_copd_ind_n0==1 & smi_copd_ind_p1==0 & `fullp1', matcell(copd) missing
mat t1[`r',1]=copd[2,1]
mat t1[`r',2]=t1[`r',1]/t1[2,1]*100
local r = `r'+1
}
//part 2 - subgroup don't meet criteria p1
tab smi_copd_ind_p1 if smi_copd_ind_n0==1 & `fullp1' & criteria_`c'_p1==0, matcell(copd) missing
mat t1[`r',1]=copd[1,1]
mat t1[`r',2]=t1[`r',1]/t1[1,1]*100

local r=8
foreach v in comorb_9_0_1yr_p1 cc_7_copd_1yr_p1 lung_o2_hrs_p1 unk_6 {
tab `v' if smi_copd_ind_n0==1 & smi_copd_ind_p1==0 & `fullp1' & criteria_`c'_p1==0, matcell(copd) missing
mat t1[`r',1]=copd[2,1]
mat t1[`r',2]=t1[`r',1]/t1[7,1]*100
local r = `r'+1
}

mat rownames t1="COPD n0 with full p1 ivw" "COPD n0, not p1" "COPD, elix 9 p1" ///
"COPD, chronic cond 7 p1" "Self report O2 use p1" "Unknown, none of above" ///
"Don't meet criteria p1" "COPD, elix 9 p1" ///
"COPD, chronic cond 7 p1" "Self report O2 use p1" "Unknown, none of above"

mat list t1

frmttable, statmat(t1) sdec(0,1) store(copd1_`c') ///
ctitles("" "Criteria `c'" "" \ "" "n" "%")

***********************************************************************
//diabetes
gen unk_7=1 if comorb_10_0_1yr_p1==0 & comorb_11_0_1yr_p1==0 & cc_9_diabetes_1yr_p1==0 & ///
 smi_diab_compl_ind_n0==1 & smi_diab_compl_ind_p1==0 & `fullp1'
replace unk_7=0 if (comorb_10_0_1yr_p1==1 | comorb_11_0_1yr_p1==1 | cc_9_diabetes_1yr_p1==1) & ///
 smi_diab_compl_ind_n0==1 & smi_diab_compl_ind_p1==0 & `fullp1' 
label var unk_7 "Reason Diabetes not meet in p1 unknown"
tab unk_7, missing

//overall n that are alive at p1, complete p1 interview (this matches Tables 7 log, Table 6
tab core_year_n0 if `fullp1', missing 

tab smi_diab_compl_ind_n0  if `fullp1', missing //n that meets n0 with p1 follow up
tab smi_diab_compl_ind_p1 if smi_diab_compl_ind_n0==1 & `fullp1', matcell(diab) missing

mat t1=J(11,2,.)
mat t1[1,1]=r(N)
mat t1[2,1]=diab[1,1]
mat t1[2,2]=t1[2,1]/t1[1,1]*100
mat list t1

//now of this group that meets n0, not p1, why?
//r3,4: elix
//r5: cc
local r=3
foreach v in comorb_10_0_1yr_p1 comorb_11_0_1yr_p1 cc_9_diabetes_1yr_p1 unk_7 {
tab `v' if smi_diab_compl_ind_n0==1 & smi_diab_compl_ind_p1==0 & `fullp1', matcell(diab) missing
mat t1[`r',1]=diab[2,1]
mat t1[`r',2]=t1[`r',1]/t1[2,1]*100
local r = `r'+1
}

//part 2 - subgroup don't meet criteria p1
tab smi_diab_compl_ind_p1 if smi_diab_compl_ind_n0==1 & `fullp1' & criteria_`c'_p1==0, matcell(diab) missing
mat t1[`r',1]=diab[1,1]
mat t1[`r',2]=t1[`r',1]/t1[1,1]*100

local r=8
foreach v in comorb_10_0_1yr_p1 comorb_11_0_1yr_p1 cc_9_diabetes_1yr_p1 unk_7 {
tab `v' if smi_diab_compl_ind_n0==1 & smi_diab_compl_ind_p1==0 & `fullp1' & criteria_`c'_p1==0, matcell(diab) missing
mat t1[`r',1]=diab[2,1]
mat t1[`r',2]=t1[`r',1]/t1[7,1]*100
local r = `r'+1
}


mat rownames t1="Diabetes n0 with full p1 ivw" "Diabetes n0, not p1" "Diabetes, elix 10 p1" ///
"Diabetes, elix 11 p1" "Diabetes, chronic cond 9 p1" "Unknown, none of above" ///
"Don't meet criteria p1" "Diabetes, elix 10 p1" ///
"Diabetes, elix 11 p1" "Diabetes, chronic cond 9 p1" "Unknown, none of above"

mat list t1

frmttable, statmat(t1) sdec(0,1) store(diab1_`c') ///
ctitles("" "Criteria `c'" "" \ "" "n" "%")

***********************************************************************
//liver disease, have no way to check this one, no indicator for less severe condition
gen unk_8=1 if smi_liver_ind_n0==1 & smi_liver_ind_p1==0 & `fullp1'
label var unk_8 "Reason Liver Disease not meet in p1 unknown"
tab unk_8, missing

//overall n that are alive at p1, complete p1 interview (this matches Tables 7 log, Table 6
tab core_year_n0 if `fullp1', missing 

tab smi_liver_ind_n0  if `fullp1', missing //n that meets n0 with p1 follow up
tab smi_liver_ind_p1 if smi_liver_ind_n0==1 & `fullp1', matcell(liver) missing

mat t1=J(3,2,.)
mat t1[1,1]=r(N)
mat t1[2,1]=liver[1,1]
mat t1[2,2]=t1[2,1]/t1[1,1]*100
mat list t1

//part 2 = subgroup don't meet criteria p1
tab smi_liver_ind_p1 if smi_liver_ind_n0==1 & `fullp1' & criteria_`c'_p1==0, matcell(liver) missing
mat t1[3,1]=liver[1,1]
mat t1[3,2]=t1[3,1]/t1[1,1]*100

mat rownames t1="Liver dis n0 with full p1 ivw" "Liver dis n0, not p1"  ///
"Don't meet criteria p1" 

mat list t1

frmttable, statmat(t1) sdec(0,1) store(liv1_`c') ///
ctitles("" "Criteria `c'" "" \ "" "n" "%")

***********************************************************************
//ALS
gen unk_9=1 if smi_als_ind_n0==1 & smi_als_ind_p1==0 & `fullp1'
label var unk_9 "Reason ALS not meet in p1 unknown"
tab unk_9, missing

//no obs have conflict for criteria b+c so this is a little different than other illnesses
//overall n that are alive at p1, complete p1 interview (this matches Tables 7 log, Table 6
tab core_year_n0 if smi_als_ind_n0==1 & `fullp1', missing //n that meets n0 with p1 follow up
mat t1=J(3,2,.)
mat t1[1,1]=r(N)

//als n0 but not in p1
tab core_year_n0 if smi_als_ind_p1==0 & smi_als_ind_n0==1 & `fullp1', missing
mat t1[2,1]=r(N)
mat t1[2,2]=t1[2,1]/t1[1,1]*100
mat list t1

//now that have als change and also don't meet criteria p1
tab core_year_n0 if smi_als_ind_p1==0 & smi_als_ind_n0==1 & `fullp1' & criteria_`c'_p1==0, missing
mat t1[3,1]=r(N)
mat t1[3,2]=t1[3,1]/t1[1,1]*100

mat rownames t1="ALS n0 with full p1 ivw" "ALS n0, not p1" "Don't meet criteria p1"

mat list t1

frmttable, statmat(t1) sdec(0,1) store(als1_`c') ///
ctitles("" "Criteria `c'" "" \ "" "n" "%")

***********************************************************************
//HIV/AIDS
gen unk_10=1 if smi_hiv_ind_n0==1 & smi_hiv_ind_p1==0 & `fullp1'
label var unk_10 "Reason HIV not meet in p1 unknown"
tab unk_10, missing

//overall n that are alive at p1, complete p1 interview (this matches Tables 7 log, Table 6
tab core_year_n0 if smi_hiv_ind_n0==1 & `fullp1', missing //n that meets n0 with p1 follow up
mat t1=J(3,2,.)
mat t1[1,1]=r(N)

//als n0 but not in p1
tab core_year_n0 if smi_hiv_ind_p1==0 & smi_hiv_ind_n0==1 & `fullp1', missing
mat t1[2,1]=r(N)
mat t1[2,2]=t1[2,1]/t1[1,1]*100
mat list t1

//now that have hiv change and also don't meet criteria p1
tab core_year_n0 if smi_hiv_ind_p1==0 & smi_hiv_ind_n0==1 & `fullp1' & criteria_`c'_p1==0, missing
mat t1[3,1]=r(N)
mat t1[3,2]=t1[3,1]/t1[1,1]*100

mat rownames t1="HIV n0 with full p1 ivw" "HIV n0, not p1" "Don't meet criteria p1"

mat list t1

frmttable, statmat(t1) sdec(0,1) store(hiv1_`c') ///
ctitles("" "Criteria `c'" "" \ "" "n" "%")

***********************************************************************
//hip fracture
gen unk_11=1 if hip_frac_hrs_p1==0  & ///
 smi_hip_ind_n0==1 & smi_hip_ind_p1==0 & `fullp1'
replace unk_11=0 if (hip_frac_hrs_p1==1) & ///
 smi_hip_ind_n0==1 & smi_hip_ind_p1==0 & `fullp1'
label var unk_11 "Reason Hip fracture not meet in p1 unknown"
tab unk_11, missing
//overall n that are alive at p1, complete p1 interview (this matches Tables 7 log, Table 6
tab core_year_n0 if `fullp1', missing 


tab smi_hip_ind_n0  if `fullp1', missing //n that meets n0 with p1 follow up
tab smi_hip_ind_p1 if smi_hip_ind_n0==1 & `fullp1', matcell(hip) missing

mat t1=J(7,2,.)
mat t1[1,1]=r(N)
mat t1[2,1]=hip[1,1]
mat t1[2,2]=t1[2,1]/t1[1,1]*100
mat list t1

//now of this group that meets n0, not p1, why?
//r3: survey, asks if hip fracture since last interview
local r=3
foreach v in hip_frac_hrs_p1 unk_11 {
tab `v' if smi_hip_ind_n0==1 & smi_hip_ind_p1==0 & `fullp1', matcell(hip) missing
mat t1[`r',1]=hip[2,1]
mat t1[`r',2]=t1[`r',1]/t1[2,1]*100
local r = `r'+1
}

tab smi_hip_ind_p1 if smi_hip_ind_n0==1 & `fullp1' & criteria_`c'_p1==0, matcell(hip) missing
mat t1[`r',1]=hip[1,1]
mat t1[`r',2]=t1[`r',1]/t1[1,1]*100

local r=6
foreach v in hip_frac_hrs_p1 unk_11 {
tab `v' if smi_hip_ind_n0==1 & smi_hip_ind_p1==0 & `fullp1'& criteria_`c'_p1==0, matcell(hip) missing
mat t1[`r',1]=hip[2,1]
mat t1[`r',2]=t1[`r',1]/t1[5,1]*100
local r = `r'+1
}

mat rownames t1="Hip fracture n0 with full p1 ivw" "Hip fracture n0, not p1" "Hip fracture self report p1" ///
"Unknown, none of above" "Don't meet criteria p1"  "Hip fracture self report p1" ///
"Unknown, none of above"

mat list t1

frmttable, statmat(t1) sdec(0,1) store(hip1_`c') ///
ctitles("" "Criteria `c'" "" \ "" "n" "%")

****************************************************************************************
//now checking overall percent less severe vs unexplained don't meet criteria
egen unk_index=rowtotal(unk_1 unk_2 unk_3 unk_4 unk_5 unk_6 unk_7 unk_8 unk_9 unk_10 unk_11) 
tab unk_index, missing
tab unk_index unk_1, missing
tab unk_index if `fullp1', missing
tab unk_index if `fullp1'& criteria_`c'_p1==0, missing

//try concat instead
forvalues i = 1/11{
 gen unk_`i'a=unk_`i'
 replace unk_`i'a=9 if unk_`i'==.
}

egen unk_concat=concat(unk_1a unk_2a unk_3a unk_4a unk_5a unk_6a unk_7a unk_8a unk_9a unk_10a unk_11a)
tab unk_concat, missing
tab unk_concat if `fullp1', missing
tab unk_concat if `fullp1'& criteria_`c'_p1==0, missing

gen x1=1 if strpos(unk_concat,"1")
gen x2=1 if strpos(unk_concat,"0")
gen x3=3 if x1==1 & x2==1 //cat 3
replace x3=1 if x1==1 & x2==. //cat 1, not explained
replace x3=2 if x1==. & x2==1 //cat 2, less severe
tab x3 if `fullp1'& criteria_`c'_p1==0, missing
replace x3=1 if x3==. & `fullp1'& criteria_`c'_p1==0
replace x3=2 if x3==3
tab x3  if `fullp1'& criteria_`c'_p1==0, missing

//create table comparing the groups
mat t2=J(8,3,.)
tab x3  if `fullp1'& criteria_`c'_p1==0, matcell(t2m) missing
mat t2[1,1]=r(N) //n  that has interview, does not meet criteria p1
mat t2[2,1]=t2m[1,1] //not explained
mat t2[2,2]=t2[2,1]/t2[1,1]*100
mat t2[3,1]=t2m[2,1] //less severe
mat t2[3,2]=t2[3,1]/t2[1,1]*100

//get percent with adl improved
tab adl_better_p1 if `fullp1'& criteria_`c'_p1==0, matcell(t2m) missing
mat t2[4,1]=t2m[1,1] //better
mat t2[4,2]=t2[4,1]/t2[1,1]*100

//now get mc spending for those that meet vs not meet
sum tot_paid_by_mc_12m_wi_n0 if `fullp1'& criteria_`c'_p1==0
mat t2[5,1]=r(mean) 
sum tot_paid_by_mc_12m_wi_n0 if `fullp1'& criteria_`c'_p1==1
mat t2[6,1]=r(mean) 
sum tot_paid_by_mc_12m_wi_p1 if `fullp1'& criteria_`c'_p1==0
mat t2[7,1]=r(mean) 
sum tot_paid_by_mc_12m_wi_p1 if `fullp1'& criteria_`c'_p1==1
mat t2[8,1]=r(mean) 

mat rownames t2="N do not meet in p1" "Reason unknown" "Less severe condition coded" ///
"ADL Improved p1" "MC spend 1yr after n0, meet=0" "MC spend 1yr after n0, meet=1" ///
"MC spend 1yr after p1, meet=0" "MC spend 1yr after p1, meet=1"
frmttable, statmat(t2) sdec(0,1) store(x31_`c') ///
ctitles("" "Criteria `c'" "" \ "" "n" "%")

//export into csv for figure
//drop if missing followup altogether
	gen p1_miss = 0
	replace p1_miss = 1 if (core_to_dod_2yr_n0==1 & ind_x_interview==0) | ///
		(core_to_dod_2yr_n0==0 & ind_p1_interview==0) | ///
		(core_to_dod_2yr_n0==0 & ind_p1_interview==1 & (part_ab_12m_p1!=1 | hmo_d_12m_p1!=0))
	tab p1_miss, missing
	drop if p1_miss==1

gen stat_p1_cat=0 if core_to_dod_2yr_n0==1 //died

replace stat_p1_cat=1 if `fullp1'& criteria_`c'_p1==1 //meet criteria p1

replace stat_p1_cat=2 if `fullp1'& criteria_`c'_p1==0 & x3==2 //less severe p1

replace stat_p1_cat=3 if `fullp1'& criteria_`c'_p1==0 & x3==1 //don't meet, unknown reason

la def stat_p1_cat 0 "Died" 1 "Seriously ill" 2 "Lower severity illness" 3 "No longer meets"
la val stat_p1_cat stat_p1_cat
tab stat_p1_cat, missing gen(stat_p1_cat)

mat p1`c'=J(9,1,.)
local r=1

local n_`c'=_N 
forvalues i=0/3 {
	sum stat_p1_cat if stat_p1_cat==`i'
	mat p1`c'[`r',1]=r(N)
	mat p1`c'[`r'+1,1]=(r(N)/_N)*100
	scalar percent`i'`c'=(r(N)/_N)*100
	local r=`r'+2
}
mat p1`c'[9,1]=p1`c'[2,1]+p1`c'[4,1]+p1`c'[6,1]+p1`c'[8,1]


mat rownames p1`c'= "N Died" "%" "N Seriously Ill" "%" "N Less ill" "%" "N No meet" "%" "% Total"
}
frmttable, statmat(p1a) store(p1a) ctitles("" "Criteria A" ) ///
 title("2 Year follow-up")


frmttable, statmat(p1b) merge(p1a) store(p12) ctitles("" "Criteria B") ///
 title("2 Year follow-up")

frmttable using `logpath'\figure_1_table, statmat(p1c) merge(p12) ctitles("" "Criteria C") ///
 title("2 Year follow-up")

frmttable, replay(x31_a)
frmttable, replay(x31_b)
frmttable,replay(x31_c)

drop *

set obs 3

gen criteria ="a" in 1
replace criteria="b" in 2
replace criteria="c" in 3

forvalues i=0/3 {
	gen p2yr_`i'=.
	foreach c in a b c{
		replace p2yr_`i'=percent`i'`c' if criteria=="`c'"
}
}

label var p2yr_0 "Died"
label var p2yr_1 "Seriously Ill"
label var p2yr_2 "Lower Severity Illness" 
label var p2yr_3 "No longer meets"
encode criteria, gen(crit)
label define criteria 1 "Criteria A" ///
2 "Criteria B" ///
3 "Criteria C"

gen n=.
foreach c in a b c {
replace n=`n_`c'' if criteria=="`c'"
}

label values crit criteria
graph hbar p2yr_0 p2yr_1 p2yr_2 p2yr_3 , over(crit) percentage stack ///
	blabel(bar, position(center) format(%3.1f)) ///
	legend(lab(1 "Died") lab(2 "Seriously Ill") ///
	lab(3 "Lower Severity Illness") lab(4 "No Longer Meets Criteria")) ///
	text(-1 79 "n=`n_a'", place(w)) ///
	text(-1 44 "n=`n_b'", place(w)) ///
	text(-1 9 "n=`n_c'", place(w)) ///
	title("Figure 1. Two Year Follow Up")
	
graph save `logpath'\bar_graph_Figure1_p1_status, replace	

export excel using "E:\data\serious_ill\logs\means_p1_follow_up.xls", firstrow(varlabels)

H="xxxxNotes"
Helper files - A respondant gets an entry (or many entries) in the helper file
if they report getting help in the ADLs, IADLs and Money (MG062_1 or _2) questions:

data helper_check;
set core_pre.H10g_hp;
if MADLNDX=. & MIADLNDX=. & MMNYNDX=.;
run;
No observations without one of the three links.

Notes regarding Elixhauser comorbidity coding:
See the email list of ICD-9 codes provided by Amy on 4/3/14
This list modifies the original ICD-9 codes used to better suit the serious
illness definitions

From reading through Elixhauser et al (1998) the original purpose
was to identify comorbidities that are underlying conditions, so not the
reason for hospital admission. So if a diagnosis was the primary diagnosis,
or if it was related to the primary DRG of the patient, it was NOT used 
in coding the Elixhauser comorbidity index. This is different from what we are
doing in that we want to identify people with serious illness, regardless
(and in many cases specifically) if they are the primary disease or diagnosis.

****************************************************************
outcomes

at 1 year:
binary:
died 
hospice enrollment
hospital admission
continuous:
hospital nights
medicare costs

status at 2 years - from p1 interview
	died
	meet criteria
	did not meet criteria



H="xxxx Additional checks"
proc freq data=bid_dx_0_1yr;
table cc_1_ami  /missprint;
run;

proc freq data=bid_dx_0_1yr2;
table cc_1_ami  /missprint;
run;

proc freq data=sic_int.core_ids_elix_1yr;
table comorb:;
run;

proc sql;
select count(distinct cats(BID_HRS_19,core_year)) from sic_int.dx_0_1yr;
quit;



H="xxxxAdditional variables from claims"
/*********************************************************/
/******* Any admission to the ICU                *********/
/*********************************************************/
/*Comes from medpar claims
Code below from Melissa's hospice project, need to adapt
for the HRS linked MC claims*/

proc freq data=medpar2;
table ICU_IND_CD /missprint;
run;

/*create indicator for ICU and/or ED use during stay
ICUED=0 - no icu or ed use
=1 ED only
=2 ICU only
=3 ICU and ED*/
data medpar3;
	set medpar2;
	if ICU_IND_CD ~= . or INTNSV_CARE_DAY_CNT>0 then ICU = 1;
	if ICU_IND_CD = . and INTNSV_CARE_DAY_CNT=0 then ICU = 0;
	if SS_LS_SNF_IND_CD ~= 'N';
	ED = 0;
	if ER_CHRG_AMT > 0 then ED = 1;
	if ICU = 1 and ED = 1 then ICUED = 3;
	if ICU = 1 and ED = 0 then ICUED = 2;
	if ICU = 0 and ED = 1 then ICUED = 1;
	if ICU = 0 and ED = 0 then ICUED = 0;
	drop icu ed;
run;


/*Notes re OP ED Use, from Melissa's project
Uses Revenue center codes*/

data ed;
	set revenue0;
	if REV_CNTR >= 450 and REV_CNTR < 460;
	ed = 1;
run;

Each OP claim has up to 45 REV_CNTR variables:
 	RVCNTR01-RVCNTR45

H="Distribution of hospital days and costs"
/*distribution of hospital nights and costs for the
group that meets criteria A
hospital nights and costs are for the 12m after the interview
where first meet criteria*/

capture log close

clear all
set more off

local logpath E:\data\serious_ill\logs
local datapath2 E:\data\serious_ill\int_data
local datapath E:\data\serious_ill\final_data

log using "`logpath'\12a_dist_crit_a.txt", text replace

cd `datapath'

use n0_n1_p1_p2_x_criteria_a_v1.dta if core_year_n0<2012
****************************************************************
****************************************************************
gen smionly=criteria_smi_n0==1 & smi_and_adl_n0==0 & criteria_b_n0==0
gen funlimitonly=criteria_smi_n0==0 & criteria_b_n0==0
gen bonly=criteria_b_n0==1 & criteria_c_n0==0
gen aonly=criteria_b_n0==0

gen fullcrit=1
replace fullcrit=2 if smio==1
replace fullcrit=3 if smi_and_adl_n0==1 & funl==0
replace fullcrit=4 if bonly==1 & criteria_smi_n0==0
replace fullcrit=5 if bonly==1 & criteria_smi_n0==1
replace fullcrit=6 if criteria_c_n0==1

gen criteria=1
replace criteria=2 if criteria_b_n0==1
replace criteria=3 if criteria_c_n0==1

label define criteria 1 "Criteria A Only" 2 "Criteria B Only" 3 "Criteria C"

label values criteria criteria

sum n_hospd_p12m_n0, detail
histogram n_hospd_p12m_n0, freq

sum tot_paid_by_mc_12m_wi_n0, detail

gen hospd=n_hospd_p12m_n0
replace hospd=30 if hospd>30
sum hospd, detail  
gen i=100/`r(N)'

foreach var in funli smio smi_and_adl_n0 bonly criteria_c_n0 {
egen n`var'=sum(`var'==1)
gen i`var'=100/n`var'
by hospd, sort: egen h`var'=sum(`var'==1)
gen p`var'=h`var'/n`var'
}

hist hospd if hospd>=1, width(1) freq by(fullcrit, noyrescale)
hist hospd if hospd>=1, width(1) freq by(criteria, noyrescale)
graph save "`logpath'\hospital_days_hist", replace


kdensity tot_paid_by_mc_12m_wi_n0 if tot_paid_by_mc_12m_wi_n0<400000, ///
ytitle(density) subtitle("Density of Medicare payments, 1 year after meeting Criteria A")

preserve
replace tot_paid_by_mc_12m_wi_n0=74000.21 if tot_paid_by_mc_12m_wi_n0>74000.21
hist tot_paid_by_mc_12m_wi_n0, percent by(criteria)
graph save "`logpath'\medicare_spending_hist", replace


collapse (sum) i, by(hospd)

graph bar (asis) i, over(hospd, relabel(31 "30+")) ///
ytitle(percent)


restore

kdensity tot_paid_by_mc_12m_wi_n0 if tot_paid_by_mc_12m_wi_n0<400000, ///
ytitle(density) subtitle("Density of Medicare payments, 1 year after meeting Criteria A")

****************************************************************
log close


H="Comparison of those with zero utilization"
/*Creates histograms of utilization and tables to compare those with zero 
hospital days/medicare spending to those with some, looking at the 
Criteria A dataset*/

capture log close

clear all
set more off

local logpath E:\data\serious_ill\logs
local datapath2 E:\data\serious_ill\int_data
local datapath E:\data\serious_ill\final_data

log using "`logpath'\12a_dist_crit_a.txt", text replace

cd `datapath'

use n0_n1_p1_p2_x_criteria_a_v1.dta
drop if tot_paid_by_mc_12m_wi_n0<0 //drops one obs

****************************************************************
gen smionly=criteria_smi_n0==1 & smi_and_adl_n0==0 & criteria_b_n0==0
gen funlimitonly=criteria_smi_n0==0 & criteria_b_n0==0
gen bonly=criteria_b_n0==1 & criteria_c_n0==0
gen aonly=criteria_b_n0==0

gen fullcrit=1
replace fullcrit=2 if smio==1
replace fullcrit=3 if smi_and_adl_n0==1 & funl==0
replace fullcrit=4 if bonly==1 & criteria_smi_n0==0
replace fullcrit=5 if bonly==1 & criteria_smi_n0==1
replace fullcrit=6 if criteria_c_n0==1

gen criteria=1
replace criteria=2 if criteria_b_n0==1
replace criteria=3 if criteria_c_n0==1

label define criteria 1 "Criteria A Only" 2 "Criteria B Only" 3 "Criteria C"

label values criteria criteria

sum n_hospd_p12m_n0, detail
histogram n_hospd_p12m_n0, freq

sum tot_paid_by_mc_12m_wi_n0, detail

gen hospd=n_hospd_p12m_n0
replace hospd=30 if hospd>30
sum hospd, detail  
gen i=100/`r(N)'

foreach var in funli smio smi_and_adl_n0 bonly criteria_c_n0 {
egen n`var'=sum(`var'==1)
gen i`var'=100/n`var'
by hospd, sort: egen h`var'=sum(`var'==1)
gen p`var'=h`var'/n`var'
}

hist hospd if hospd>=1, width(1) freq by(fullcrit, noyrescale)
hist hospd if hospd>=1, width(1) freq by(criteria, noyrescale)
graph save "`logpath'\hospital_days_hist", replace

preserve
replace tot_paid_by_mc_12m_wi_n0=74000.21 if tot_paid_by_mc_12m_wi_n0>74000.21
hist tot_paid_by_mc_12m_wi_n0, percent by(criteria)
graph save "`logpath'\medicare_spending_hist", replace


collapse (sum) i, by(hospd)

graph bar (asis) i, over(hospd, relabel(31 "30+")) ///
ytitle(percent)


restore

kdensity tot_paid_by_mc_12m_wi_n0 if tot_paid_by_mc_12m_wi_n0<400000, ///
ytitle(density) subtitle("Density of Medicare payments, 1 year after meeting Criteria A")

****************************************************************
log close
gen ind_mc_paid_12m_n0=(tot_paid_by_mc_12m_wi_n0>0)
gen religvimp_n0=imprelig_n0==1

local cvarschar age_at_core_n0

local ivarschar female nw_lowest_n0 nw_midlow_n0 nw_midhigh_n0 nw_highest_n0 ///
re_white re_black re_hisp re_other_unk ///
hs_deg_ind religvimp_n0 srh_pf_n0 rel_nb_n0 married_n0 smi_nh_ind_n0 ///
medicaid_n0 champus_n0 medigap_n0 ///
core_to_dod_1yr_n0 criteria_a_n0 aonly criteria_b_n0 bonly criteria_c_n0 ///
smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 ///
smi_diab_compl_ind_n0 smi_liver_ind_n0 smi_als_ind_n0 smi_hip_ind_n0 ///
adl_stable_partial_n0n1 adl_stable_severe_n0n1 ///
adl_change_i_m_n0n1 adl_change_i_s_n0n1 adl_change_m_s_n0n1 

local cvarsutil tot_paid_by_mc_12m_wi_n0 ip_paid_by_mc_12m_wi_n0 snf_paid_by_mc_12m_wi_n0 hh_paid_by_mc_12m_wi_n0 ///
hs_paid_by_mc_12m_wi_n0 pb_paid_by_mc_12m_wi_n0 dm_paid_by_mc_12m_wi_n0


local ivarsutil ind_hosp_adm_p12m_n0 hs_admit_p12m_n0 



la var core_to_dod_1yr_n0 "Died"
la var hs_admit_p6m_n0 "Enrolled in hospice"
la var ind_em_ur_adm_p6m_n0 "Hospital admission"
la var n_hospd_p6m_n0 "Hospital nights"
la var ind_hosp_adm_p12m_n0 "Hospital admission"
la var ind_mc_paid_12m_n0 "Any Medicare Payments"
la var ip_paid_by_mc_12m_wi_n0 "Inpatient"
la var snf_paid_by_mc_12m_wi_n0 "SNF"
la var hh_paid_by_mc_12m_wi_n0 "Home health" 
la var hs_paid_by_mc_12m_wi_n0 "Hospice" 
la var pb_paid_by_mc_12m_wi_n0 "Carrier"
la var op_paid_by_mc_12m_wi_n0 "Outpatient" 
la var dm_paid_by_mc_12m_wi_n0 "DME"
la var tot_paid_by_mc_12m_wi_n0 "Total Medicare payments"

//creates tables of characteristics and utilization by zero hospitalization/medicare spending
foreach x in "char" "util" {

frmttable, clear(t2_2ind_hosp_adm_p12m_n0) 
frmttable, clear(t2_2ind_mc_paid_12m_n0)

foreach var in ind_hosp_adm_p12m_n0 ind_mc_paid_12m_n0 {

mat t2=J(1,6,.)

foreach v of local cvars`x' { //continuous variables
local c=1
	foreach i in 0 1 {
		qui sum `v' if `var'==`i'
		mat t2[1,`c']=r(mean)*1.00 //mean
		mat t2[1,`c'+1]=r(sd)*1.00 //sd
		local c = `c'+2
	}
	
	ttest `v', by(`var') //p-values
	mat t2[1,5]=r(p)
	
	mat rownames t2=`v'
	frmttable, statmat(t2) varlabels sdec(2,2,3\3,3,3) substat(1) store(t2_1)
	
	outreg, replay(t2_2`var') append(t2_1) store(t2_2`var')
}

foreach v of local ivars`x' { //indicator variables
local c=1
	foreach i in 0 1{
		qui sum `v' if `var'==`i'
		mat t2[1,`c']=r(mean)*100.00 //percent
		mat t2[1,`c'+1]=r(mean)*r(N) //n
		local c = `c'+2
	}
	tab `v' `var', chi2 //p-values
	mat t2[1,5]=r(p)
	
	mat rownames t2=`v'
	frmttable, statmat(t2) varlabels sdec(2,2,3\0,0,3) substat(1) store(t2_1)
	
	outreg, replay(t2_2`var') append(t2_1) store(t2_2`var')
}




//last row, n for each group
mat t2_n=J(1,3,.)
tab `var', matcell(t2n)
mat t2_n[1,1]=t2n[1,1]
mat t2_n[1,2]=t2n[2,1]
/*
tab ind_mc_paid_12m_n0, matcell(t2n1)
mat t2_n[1,5]=t2n1[1,1]
mat t2_n[1,6]=t2n1[2,1]
*/
mat rownames t2_n="N"
frmttable, statmat(t2_n) store(t2_n) sdec(0)

outreg, replay(t2_2`var') append(t2_n) store(t2_2`var')
}

outreg using "`logpath'\compare_zero_hospd`x'.rtf", replay(t2_2ind_hosp_adm_p12m_n0) merge(t2_2ind_mc_paid_12m_n0) replace ///
title("`x' by Hospital Admission & Medicare Payments p12m") ///
ctitles("","Never Admitted to Hospital","Admitted to Hospital","p-value","No Medicare Spending","Yes Medicare Spending","p-value") ///
note ("Sample limited to survey respondents first interview that meet Criteria A:" \ ///
"at least one serious medical illness and/or ADL impairment" \ ///
"Medicare spending in 2012$, wage index adjusted.")

}



H="Initial try of fmm model for costs and hosp"
/*first try of applying fmm to the criteria A sample*/

capture log close

clear all
set more off

local logpath E:\data\serious_ill\logs
local datapath2 E:\data\serious_ill\int_data
local datapath E:\data\serious_ill\final_data

log using "`logpath'\12_fmm_crit_a.txt", text replace

cd `datapath'

//sample that meets criteria a - n0=first year meets criteria a
use n0_n1_p1_p2_x_criteria_a_v1.dta if core_year_n0<2012
***************************************************************
la var n_hospd_p12m_n0 "Hospital nights"
la var tot_paid_by_mc_12m_wi_n0 "Total MC spending"

tab degree hs_deg_ind, missing //switched to tracker degree level variable
tab female, missing

gen religvimp_n0=1 if imprelig_n0==1
replace religvimp_n0=0 if inlist(imprelig_n0,2,3,4)
tab religvimp_n0, missing

//base no high school degree, male, white, adl improved or stable independent n1n0

local cvars age_at_core_n0

local ivars female re_black re_hisp re_other_unk ///
hs_deg_ind nw_midlow_n0 nw_midhigh_n0 nw_highest_n0 ///
religvimp_n0 srh_pf_n0 rel_nb_n0 married_n0 smi_nh_ind_n0 ///
medicaid_n0 champus_n0 medigap_n0 ///
smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 ///
smi_diab_compl_ind_n0 smi_liver_ind_n0 smi_als_ind_n0 smi_hip_ind_n0 ///
ind_em_ur_adm_12m_n0 ///
adl_stable_partial_n0n1 adl_stable_severe_n0n1 ///
adl_change_i_m_n0n1 adl_change_i_s_n0n1 adl_change_m_s_n0n1

foreach v in `cvars' `ivars'{
drop if `v'==.
}

tab n_hospd_p12m_n0, missing
sum n_hospd_p12m_n0, detail
histogram n_hospd_p12m_n0, freq
graph save `logpath'\hospd_a_hist, replace

sum tot_paid_by_mc_12m_wi_n0, detail
kdensity tot_paid_by_mc_12m_wi_n0, ///
ytitle(density) subtitle("Density of Medicare payments, 1 year after Criteria A interview")
graph save `logpath'\mc_paid_a_kdensity, replace


***************************************************************

//models for LOS
//nb-2
nbreg n_hospd_p12m_n0 `cvars' `ivars', vce(robust)

//zinb
zinb n_hospd_p12m_n0 `cvars' `ivars', inflate(`cvars' `ivars') vce(robust)

//poisson
poisson n_hospd_p12m_n0 `cvars' `ivars', vce(robust)

//fmm model, nb-2 dist, 2 comp
fmm n_hospd_p12m_n0 `cvars' `ivars', mix(negbin2) comp(2) vce(robust) iter(200) diff
est save `datapath'\fmm_2comp, replace
estat ic

//fmm model, nb-2 dist, 3 comp
/*fmm n_hospd_p12m_n0 `cvars' `ivars', mix(negbin2) comp(3) vce(robust)
est save `datapath'\fmm_3comp, replace
estat ic
*/
***************************************************************
//component density
predict yhat1, eq(component1)
predict yhat2, eq(component2)

sum yhat1
scalar yhat1mean = r(mean)

sum yhat2
scalar yhat2mean = r(mean)

scalar alpha1=`e(alpha1_est)'
scalar alpha2=`e(alpha2_est)'
scalar psi1=1/alpha1
scalar psi2=1/alpha2

gen y=.
gen f1=.
gen f2=.
forvalues i = 1/30 {
replace y = `i' in `i=`i'+1'
replace f1=exp(lngamma(`i'+psi1) - lngamma(`i'+1) - lngamma(psi1) ///
	+psi1*ln(1+yhat1mean*alpha1) - `i'*ln(1+1/(yhat1mean*alpha1))) in `=`i'+1'
replace f2=exp(lngamma(`i'+psi2) - lngamma(`i'+1) - lngamma(psi2) ///
	+psi2*ln(1+yhat2mean*alpha2) - `i'*ln(1+1/(yhat1mean*alpha2))) in `=`i'+1'
}

graph bar (asis) f1 f2, over(y, label(labsize(small))) ///
bar(1, color(midblue)) bar(2, color(orange)) ///
legend(label(1 "f(LOS|x,c=1)") label(1 "f(LOS|x,c=2)") row(1)) ///
title("Hospital nights 1 year after meet criteria A") ///
note("{&pi}{sub:1}=`:di %4.2f `=`e(pi1_est)''', {&pi}{sub:2}=`:di %4.2f `=`e(pi2_est)'''", size(medium))

***************************************************************
//looking at costs
sum tot_paid_by_mc_12m_wi_n0, detail
glm tot_paid_by_mc_12m_wi_n0 `cvars' `ivars', family(gamma) vce(robust)
glm , eform

//2 comp fmm
** does not run, get error that initial values are not feasible
//fmm tot_paid_by_mc_12m_wi_n0 `cvars' `ivars', components(2) ///
//	mixtureof(gamma) search(on) diff vce(robust)
	
	
	
***************************************************************
log close


H="Try FMM on 2010 interview sample and Criteria A sample"
/*Saves estimates from hospital  nights 2 and 3 component fmm models*/

foreach crit in  "a" {

capture log close
clear all
set more off

local logpath E:\data\serious_ill\logs
local datapath2 E:\data\serious_ill\int_data
local datapath E:\data\serious_ill\final_data

log using "`logpath'\13_fmm_`crit'_core.txt", text replace

cd `datapath'


use n0_n1_p1_p2_x_criteria_`crit'_v1.dta
***************************************************************
drop if tot_paid_by_mc_12m_wi_n0<0

la var n_hospd_p12m_n0 "Hospital nights"
la var tot_paid_by_mc_12m_wi_n0 "Total MC spending"

tab degree hs_deg_ind, missing //switched to tracker degree level variable
tab female, missing

gen religvimp_n0=1 if imprelig_n0==1
replace religvimp_n0=0 if inlist(imprelig_n0,2,3,4)
tab religvimp_n0, missing

gen smi_any_n0=1 if smi_count_n0>0
replace smi_any_n0=0 if smi_count_n0==0
tab smi_any_n0, m
//base no high school degree, male, white, adl improved or stable independent n1n0

local cvars age_at_core_n0


local ivars female re_white ///
hs_deg_ind nw_midlow_n0 nw_midhigh_n0 nw_highest_n0 ///
religvimp_n0 srh_pf_n0 rel_nb_n0 married_n0 smi_nh_ind_n0 ///
medicaid_n0 champus_n0 medigap_n0 ///
smi_any_n0 ind_em_ur_adm_12m_n0 ///
adl_impair_core_n0

//regional variables, split by quartile of hrr eol spending per dm atlas
local rvars tot_eol_spending_hrr_n0 hospital_care_intensity_n0 ///
	physicians_n0 specialists_n0 hospital_beds_n0

foreach v in `rvars' {
qui sum `v', detail
qui drop if `v'==.
}

xtile quintile_dm_2yr=tot_eol_spending_hrr_n0, nq(5)

tab quintile_dm_2yr, m
la var quintile_dm_2yr "Quintiles of 2 year Dartmouth EOL Medicare Spending, HRR level (within this sample)"
la val quintile_dm_2yr quint

sum tot_eol_spending_hrr_n0 if quintile_dm_2yr==1, detail
sum tot_eol_spending_hrr_n0 if quintile_dm_2yr==2, detail
sum tot_eol_spending_hrr_n0 if quintile_dm_2yr==3, detail
sum tot_eol_spending_hrr_n0 if quintile_dm_2yr==4, detail
sum tot_eol_spending_hrr_n0 if quintile_dm_2yr==5, detail

tab quintile_dm_2yr, gen(d_eol_spend_quint) missing

foreach v in `cvars' {
qui sum `v', detail
qui drop if `v'==.
}

foreach v in `ivars' {
qui tab `v', missing
drop if `v'==.
}


//now look at outcomes for the sample to be used for fmm
**************************************************************************

kdensity tot_paid_by_mc_12m_wi_n0, ///
ytitle(density) subtitle("Density of Medicare payments, 1 year after Core Interview")
graph save `logpath'\mc_paid_kdensity, replace

//hosp nights?
by n_hospd_p12m_n0, sort: egen hospd_freq=count(n_hospd_p12m_n0)
tab n_hospd_p12m_n0 if hospd_freq>10, m
sum n_hospd_p12m_n0, d
hist n_hospd_p12m_n0 if hospd_freq>10, freq
graph save `logpath'\hospd_hist, replace

//quick look at who meets the criteria

gen criteria=1
replace criteria=2 if criteria_b_n0==1
replace criteria=3 if criteria_c_n0==1

label define criteria 1 "Criteria A Only" 2 "Criteria B Only" 3 "Criteria C"
label values criteria criteria

tab criteria, missing


***************************************************************************
local da_quint d_eol_spend_quint1 d_eol_spend_quint2 d_eol_spend_quint3 ///
d_eol_spend_quint4

tab age_cat2_n0, gen(age_n0_ind)

//lee index of mortality
gen leeindex_n0=1
qui replace leeindex_n0=leeindex_n0+3 if age_n0_ind2==1
qui replace leeindex_n0=leeindex_n0+4 if  age_n0_ind3==1	
qui replace leeindex_n0=leeindex_n0+5 if age_n0_ind4 ==1
qui replace leeindex_n0=leeindex_n0+7 if age_n0_ind5 ==1
qui replace leeindex_n0=leeindex_n0+2 if female ==0
qui replace leeindex_n0=leeindex_n0+1 if dm_hrs_n0==1
qui replace leeindex_n0=leeindex_n0+2 if cancer_hrs_n0==1
qui replace leeindex_n0=leeindex_n0+2 if lung_hrs_n0== 1
qui replace leeindex_n0=leeindex_n0+2 if chf_hrs_n0 ==1
qui replace leeindex_n0=leeindex_n0+2 if smoke_curr_n0==1
qui replace leeindex_n0=leeindex_n0+1 if bmi_lt25_n0==1
qui replace leeindex_n0=leeindex_n0+2 if adl_diff_bh_n0==1
qui replace leeindex_n0=leeindex_n0+2 if iadl_diff_m_n0==1
qui replace leeindex_n0=leeindex_n0+1 if fl_diff_push_n0==1
qui replace leeindex_n0=leeindex_n0+2 if fl_diff_wk_many_n0==1

//generate inverse propensity score weight, 1/p if w=1 1/1-p if w=0

global weightvars age_n0_ind2 age_n0_ind3 age_n0_ind4 age_n0_ind5 female ///
dm_hrs_n0 cancer_hrs_n0 lung_hrs_n0 chf_hrs_n0 bmi_lt25_n0 smoke_curr_n0  ///
adl_diff_bh_n0 iadl_diff_m_n0 fl_diff_wk_many_n0 fl_diff_push_n0 

logit core_to_dod_1yr_n0 $weightvars
predict prob_death_1yr_n0 //generate new var-pscore
gen invpscore=(1/prob_death_1yr_n0) if core_to_dod_1yr_n0==1
replace invpscore=(1/(1-prob_death_1yr_n0)) if core_to_dod_1yr_n0==0

gen totplus1_wi_n0=tot_paid_by_mc_12m_wi_n0+1 //new variable amt paid +$1

//look at dist of tot medicare payments
sum tot_paid_by_mc_12m_wi_n0, d

// other way of getting around zeros, put in $100 and $1000 bins
gen tot_100bins_wi_12m=.
gen tot_1000bins_wi_12m=.

forvalues i = 1/5230 {

qui replace tot_100bins= `i' if tot_paid_by_mc_12m_wi_n0>=((`i'-1)*100) & ///
	tot_paid_by_mc_12m_wi_n0<(`i'*100)
qui replace tot_1000bins= `i' if tot_paid_by_mc_12m_wi_n0>=((`i'-1)*1000) & ///
	tot_paid_by_mc_12m_wi_n0<(`i'*1000)
}
gen tot_reportable_100bins=tot_100bi
replace tot_reportable_100bins=61 if tot_reportable_100b>61
tab tot_reportable_100b

by tot_100bins, sort: egen bins_freq=count(tot_100bins)
tab tot_100bins if bins_freq>10

gen tot_reportable_1000bins=tot_1000b
replace tot_reportable_1000b=68 if tot_1000b>68

tab tot_reportable_1000b
hist tot_reportable_1000, width(1) freq title("MC Spending, $1000 bins")
graph save `logpath'\tot_reportable_1000bins_hist, replace



******************************************************************

//hospital nights - base nb2 model
nbreg n_hospd_p12m_n0 `cvars' `ivars' `da_quint', vce(robust)
estat ic


fmm n_hospd_p12m_n0 `cvars' `ivars' `da_quint', components(2) mixtureof(negbin2) ///
	diff vce(robust)
estimates save hospd_`crit'_fmm_2comp, replace
predict phospd, posterior eq(component1)
predict phospd_1, eq(component1)
predict phospd_2, eq(component2)
predict phospd_0
estat ic

/* //does not converge for criteria a group
fmm n_hospd_p12m_n0 `cvars' `ivars' `da_quint', components(3) mixtureof(negbin2) ///
	diff vce(robust)
estimates save hospd_`crit'_fmm_3comp, replace
predict phospd3, posterior eq(component1)
*/

//looking at spending

//total medicare payments, different ways
glm totplus1_wi_n0 `cvars' `ivars' `da_quint', family(gamma) link(log) vce(robust)
glm, eform
estat ic
mat glmtotplus1=r(S)

fmm totplus1_wi_n0 `cvars' `ivars' `da_quint', components(2) ///
	mixtureof(gamma) search(on) diff vce(robust)
estimates save tot_paid_`crit'_fmm_2comp, replace
predict ptot1, posterior eq(component1)
predict ptot1_1, eq(component1)
predict ptot1_2, eq(component2)
predict ptot1_0
estat ic
mat totplus1=r(S)


/*
//does not converge
fmm totplus1_wi_n0 `cvars' `ivars' `da_quint', components(3) ///
	mixtureof(gamma) search(on) vce(robust)
estimates save tot_paid_`crit'_fmm_3comp, replace
*/

glm tot_100bins_wi_12m `cvars' `ivars' `da_quint', family(gamma) link(log) vce(robust)
glm, eform
estat ic
mat glm100bins=r(S)


fmm tot_100bins_wi_12m `cvars' `ivars' `da_quint', components(2) ///
	mixtureof(gamma) search(on) diff vce(robust)
predict pbinsgamma, posterior eq(component1)
predict pbinsgamma_1, eq(component1)
predict pbinsgamma_2, eq(component2)
predict pbinsgamma_0
estat ic
mat twocompglm100bins=r(S)



nbreg tot_100bins_wi_12m `cvars' `ivars' `da_quint'
estat ic
mat nb100bins=r(S)


fmm tot_100bins_wi_12m `cvars' `ivars' `da_quint', components(2) ///
	mixtureof(negbin2) diff vce(robust)
estimates save tot_100bins_`crit'_fmm_2comp, replace
predict pbins100, posterior eq(component1)
predict pbins100_1, eq(component1)
predict pbins100_2, eq(component2)
predict pbins100_0
estat ic
mat twocomp100bins=r(S)


/* does not converge with ipsw for any specification

nbreg tot_100bins_wi_12m `cvars' `ivars' `da_quint' [pw=invp]
estat ic
mat nbpw100bins=r(S)


fmm tot_100bins_wi_12m `cvars' `ivars' `da_quint' [pw=invp], components(2) ///
	mixtureof(negbin2) diff vce(robust)
estimates save tot_100bins_`crit'_fmm_pw_2comp, replace
predict pbins100pw, posterior eq(component1)
predict pbins100pw_1, eq(component1)
predict pbins100pw_2, eq(component2)
predict pbins100pw_0
estat ic
mat twocomppw100bins=r(S)
*/


nbreg tot_1000bins_wi_12m `cvars' `ivars' `da_quint'
estat ic
mat nb1000bins=r(S)


fmm tot_1000bins_wi_12m `cvars' `ivars' `da_quint', components(2) ///
	mixtureof(negbin2) diff vce(robust)
estimates save tot_1000bins_`crit'_fmm_2comp, replace
predict pbins1000, posterior eq(component1)
predict pbins1000_1, eq(component1)
predict pbins1000_2, eq(component2)
predict pbins1000_0
estat ic
mat twocomp1000bins=r(S)


corr phospd ptot1 pbinsgamma pbins100 pbins1000 //pbins100pw

di "glmtotplus1"
matlist glmtotplus1
di "twcomptotplus1"
matlist totplus1
di "glm100bins"
matlist glm100bins
di "twocompglm100bins"
matlist twocompglm100bins
di "nb100bins"
matlist nb100bins
di "twocomp100bins"
matlist twocomp100bins
*di "nbpw100bins"
*matlist nbpw100bins
*di "twocomppw100bins"
*matlist twocomppw100bins
di "nb1000bins"
matlist nb1000bins
di "twocomp1000bins"
matlist twocomp1000bins

//save this dataset

save n0_n1_p1_p2_x_criteria_`crit'_v2_fmm.dta, replace
log close
}



H="xxx2010 & crit a fmm hospital nights postestimation"
/*looking at postestimation for the fmm models for hospital days
for the 2010 sample in the previous section*/

foreach crit in "2010" "a" {
capture log close
clear all
set more off

local logpath E:\data\serious_ill\logs
local datapath2 E:\data\serious_ill\int_data
local datapath E:\data\serious_ill\final_data

log using "`logpath'\14_fmm_`crit'_core_postest_hospd.txt", text replace

cd `datapath'

use n0_n1_p1_p2_x_criteria_`crit'_v2_fmm.dta
***************************************************************
local cvars age_at_core_n0

local ivars female re_white ///
hs_deg_ind nw_midlow_n0 nw_midhigh_n0 nw_highest_n0 ///
religvimp_n0 srh_pf_n0 rel_nb_n0 married_n0 smi_nh_ind_n0 ///
medicaid_n0 champus_n0 medigap_n0 ///
smi_any_n0 ind_em_ur_adm_12m_n0 ///
adl_impair_core_n0

local da_quint d_eol_spend_quint1 d_eol_spend_quint2 d_eol_spend_quint3 ///
d_eol_spend_quint4


***************************************************************
//2 component postestimation
***************************************************************
estimates use hospd_`crit'_fmm_2comp
mat hospd_`crit'_fmm2=e(b)

fmm n_hospd_p12m_n0 `cvars' `ivars' `da_quint', components(2) mixtureof(negbin2) ///
 diff vce(robust) from(hospd_`crit'_fmm2) iter(0)

estat ic

***************************************************************
//component density
predict yhat1, eq(component1)
predict yhat2, eq(component2)

sum yhat1
scalar yhat1mean = r(mean)

sum yhat2
scalar yhat2mean = r(mean)

scalar alpha1=`e(alpha1_est)'
scalar alpha2=`e(alpha2_est)'
scalar psi1=1/alpha1
scalar psi2=1/alpha2

gen y=.
gen f1=.
gen f2=.
forvalues i = 1/30 {
qui replace y = `i' in `i=`i'+1'
qui replace f1=exp(lngamma(`i'+psi1) - lngamma(`i'+1) - lngamma(psi1) ///
	+psi1*ln(1+yhat1mean*alpha1) - `i'*ln(1+1/(yhat1mean*alpha1))) in `=`i'+1'
qui replace f2=exp(lngamma(`i'+psi2) - lngamma(`i'+1) - lngamma(psi2) ///
	+psi2*ln(1+yhat2mean*alpha2) - `i'*ln(1+1/(yhat1mean*alpha2))) in `=`i'+1'
}

graph bar (asis) f1 f2, over(y, label(labsize(small))) ///
bar(1, color(midblue)) bar(2, color(orange)) ///
legend(label(1 "f(LOS|x,c=1)") label(2 "f(LOS|x,c=2)") row(1)) ///
title("Hospital nights 1 year after 2008 Interview") ///
note("{&pi}{sub:1}=`:di %4.2f `=`e(pi1_est)''', {&pi}{sub:2}=`:di %4.2f `=`e(pi2_est)'''", size(medium))

graph save `logpath'\14_fmm_hospd_`crit'_2comp_freq.gph, replace

***************************************************************
//get posterior probability each component
predict po1_Xres, posterior eq(component1) //posterior prob comp 1
sum po1_Xres, detail
sca co_10pct=r(p10)
sca co_90pct=r(p90)
local p1=round(r(mean),.01)

gen likelycomp=1 if po1_Xres>co_90pct
replace likelycomp=2 if po1_Xres<=co_10pct
tab likelycomp, missing

***************************************************************
//regress post prob on covariates
reg po1_Xres `cvars' `ivars' `da_quint', beta vce(r)

outreg using `logpath'\14_fmm_hospd_`crit'_2comp_means, ///
replace stats(beta) ///
title("Hospital nights - regression posterior probability on expl variables") ///
ctitles("","Posterior probability Comp 1") ///
bdec(4) starlevels(10 5 1) ///
addrows("Probability","`p1'") varlabels

***************************************************************
//means of variables by component
drop if likelycomp==.

local covars age_at_core_n0 female re_white ///
hs_deg_ind nw_midlow_n0 nw_midhigh_n0 nw_highest_n0 ///
religvimp_n0 srh_pf_n0 rel_nb_n0 married_n0 smi_nh_ind_n0 ///
medicaid_n0 champus_n0 medigap_n0 ///
smi_any_n0 ind_em_ur_adm_12m_n0 ///
adl_impair_core_n0 d_eol_spend_quint1 d_eol_spend_quint2 d_eol_spend_quint3 ///
d_eol_spend_quint4
local n_models : word count `covars'

matrix means2=J(2*`n_models',2,.)
mean `covars', over(likelycomp)
mat means1=e(b)'
mat list means1

forval i=1/`n_models'{
	local v `: word `i' of `covars''
	ttest `v',by(likelycomp)
	local se`v' = r(se)
	local p`v' = r(p)
	local row`v' = 2*(`i'-1)+1
	mat means2[`row`v'',1]=`se`v''
	mat means2[`row`v'',2]=`p`v''
}

mat list means1
mat list means2
mat means=means1,means2
mat list means

frmttable using `logpath'\14_fmm_hospd_`crit'_2comp_means, ///
statmat(means) substat(0) sdec(3) ///
title("Means explanatory variables, 2 components") ///
ctitle("","component","means","standard errors","p-value") addtable

***************************************************************
//means of other health related variables by component
local othervars smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 smi_liver_ind_n0 ///
smi_hip_ind_n0 adl_stable_ind_n0n1 adl_stable_partial_n0n1 ///
adl_stable_severe_n0n1 adl_change_i_m_n0n1 adl_change_i_s_n0n1 ///
adl_change_m_s_n0n1

local n_models2 : word count `othervars'

matrix means2=J(2*`n_models2',2,.)
mean `othervars', over(likelycomp)
mat means1=e(b)'
mat list means1

forval i=1/`n_models2'{
	local v `: word `i' of `othervars''
	ttest `v',by(likelycomp)
	local se`v' = r(se)
	local p`v' = r(p)
	local row`v' = 2*(`i'-1)+1
	mat means2[`row`v'',1]=`se`v''
	mat means2[`row`v'',2]=`p`v''
}

mat list means1
mat list means2
mat means=means1,means2
mat list means

frmttable using `logpath'\14_fmm_hospd_`crit'_2comp_means, ///
statmat(means) substat(0) sdec(3) ///
title("Means other health related variables, 2 components") ///
ctitle("","component","means","standard errors","p-value") addtable

/*
***************************************************************
clear all
use n0_n1_p1_p2_x_criteria_`crit'_v2_fmm.dta

estimates use hospd_`crit'_fmm_3comp
mat hospd_`crit'_fmm3=e(b)

fmm n_hospd_p12m_n0 `cvars' `ivars' `da_quint' , components(3) mixtureof(negbin2) ///
 diff vce(robust) from(hospd_`crit'_fmm3) iter(0)

estat ic

***************************************************************

estimates use hospd_08_fmm_4comp
mat hospd_08_fmm4=e(b)

fmm n_hospd_p12m_n0 `cvars' `ivars', components(3) mixtureof(negbin2) ///
 diff vce(robust) from(hospd_08_fmm4) iter(0)

estat ic
*/
***************************************************************
log close
}


H="2010 & crit a fmm totplus1  postestimation"
/*looking at postestimation for the fmm models for totplus1
for the 2010 sample in the previous section*/

foreach crit in "2010" "a" {
capture log close
clear all
set more off

local logpath E:\data\serious_ill\logs
local datapath2 E:\data\serious_ill\int_data
local datapath E:\data\serious_ill\final_data

log using "`logpath'\14_fmm_`crit'_core_postest_totplus1.txt", text replace

cd `datapath'

use n0_n1_p1_p2_x_criteria_`crit'_v2_fmm.dta
***************************************************************
local cvars age_at_core_n0

local ivars female re_white ///
hs_deg_ind nw_midlow_n0 nw_midhigh_n0 nw_highest_n0 ///
religvimp_n0 srh_pf_n0 rel_nb_n0 married_n0 smi_nh_ind_n0 ///
medicaid_n0 champus_n0 medigap_n0 ///
smi_any_n0 ind_em_ur_adm_12m_n0 ///
adl_impair_core_n0

local da_quint d_eol_spend_quint1 d_eol_spend_quint2 d_eol_spend_quint3 ///
d_eol_spend_quint4


***************************************************************
//2 component postestimation
***************************************************************
estimates use tot_paid_`crit'_fmm_2comp
mat tot_paid_`crit'_fmm2=e(b)

fmm totplus1_wi_n0 `cvars' `ivars' `da_quint', components(2) mixtureof(gamma) ///
 diff vce(robust) search(on)

estat ic

***************************************************************
//component density
predict yhat0
predict yhat1, eq(component1)
predict yhat2, eq(component2)

sum yhat1
scalar yhat1mean = r(mean)

sum yhat2
scalar yhat2mean = r(mean)


twoway hist yhat1, percent  color(blue) finten(inten10) title("Predicted MC Payments") legend(label(1 Component1)) || hist yhat2, percent color(orange) legend(label(2 Component2)) fint(inten10)
graph save `logpath'\14_fmm_totplus1_`crit'_2comp_hist, replace
twoway kdensity yhat1, color(blue) legend(label(1 Component1)) title("Predicted MC Payments")|| kdensity yhat2, color(orange) legend(label(2 Component2)) || kdensity yhat0, color(gray) legend(label(3 Full Sample Prediction))
graph save `logpath'\14_fmm_totplus1_`crit'_2comp_kden, replace
**************************************************
//get posterior probability each component
predict po1_Xres, posterior eq(component1) //posterior prob comp 1
sum po1_Xres, detail
local p1=round(r(mean),.01)

gen likelycomp=1 if po1_Xres>.8
gen comp1_80=po1_Xres>.8
gen comp2_80=po1_Xres<=.2
replace likelycomp=2 if po1_Xres<=.8
tab likelycomp, missing

***************************************************************
//regress post prob on covariates
reg po1_Xres `cvars' `ivars' `da_quint', beta vce(r)

outreg using `logpath'\14_fmm_tot_plus1_`crit'_2comp_means, ///
replace stats(beta) ///
title("Total Paid + $1 - regression posterior probability on expl variables") ///
ctitles("","Posterior probability Comp 1") ///
bdec(4) starlevels(10 5 1) ///
addrows("Probability","`p1'") varlabels

***************************************************************
//means of variables by component
drop if likelycomp==.

local covars age_at_core_n0 female re_white ///
hs_deg_ind nw_midlow_n0 nw_midhigh_n0 nw_highest_n0 ///
religvimp_n0 srh_pf_n0 rel_nb_n0 married_n0 smi_nh_ind_n0 ///
medicaid_n0 champus_n0 medigap_n0 ///
smi_any_n0 ind_em_ur_adm_12m_n0 ///
adl_impair_core_n0 d_eol_spend_quint1 d_eol_spend_quint2 d_eol_spend_quint3 ///
d_eol_spend_quint4
local n_models : word count `covars'

matrix means2=J(2*`n_models',2,.)
mean `covars', over(likelycomp)
mat means1=e(b)'
mat list means1

forval i=1/`n_models'{
	local v `: word `i' of `covars''
	ttest `v',by(likelycomp)
	local se`v' = r(se)
	local p`v' = r(p)
	local row`v' = 2*(`i'-1)+1
	mat means2[`row`v'',1]=`se`v''
	mat means2[`row`v'',2]=`p`v''
}

mat list means1
mat list means2
mat means=means1,means2
mat list means

frmttable using `logpath'\14_fmm_tot_plus1_`crit'_2comp_means, ///
statmat(means) substat(0) sdec(3) varlabels ///
title("Means explanatory variables, 2 components") ///
ctitle("","component","means","standard errors","p-value") addtable

***************************************************************
//means of other health related variables by component
local othervars smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 smi_liver_ind_n0 ///
smi_hip_ind_n0 adl_stable_ind_n0n1 adl_stable_partial_n0n1 ///
adl_stable_severe_n0n1 adl_change_i_m_n0n1 adl_change_i_s_n0n1 ///
adl_change_m_s_n0n1

local n_models2 : word count `othervars'

matrix means2=J(2*`n_models2',2,.)
mean `othervars', over(likelycomp)
mat means1=e(b)'
mat list means1

forval i=1/`n_models2'{
	local v `: word `i' of `othervars''
	ttest `v',by(likelycomp)
	local se`v' = r(se)
	local p`v' = r(p)
	local row`v' = 2*(`i'-1)+1
	mat means2[`row`v'',1]=`se`v''
	mat means2[`row`v'',2]=`p`v''
}

mat list means1
mat list means2
mat means=means1,means2
mat list means

frmttable using `logpath'\14_fmm_tot_plus1_`crit'_2comp_means, ///
statmat(means) substat(0) sdec(3) varlabels ///
title("Means other health related variables, 2 components") ///
ctitle("","component","means","standard errors","p-value") addtable


local colvars1 female re_white hs_deg_ind nw_highest_n0 srh_pf_n0 rel_nb_n0 married_n0 ///
medigap_n0 smi_any_n0 ind_em_ur_adm_12m_n0 adl_impair_core_n0 
local colvars2 smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 smi_liver_ind_n0 ///
smi_hip_ind_n0 adl_stable_ind_n0n1 adl_stable_partial_n0n1 ///
adl_change_i_m_n0n1 adl_change_m_s_n0n1
local graphbars female re_white nw_highest_n0 champus_n0 medigap_n0 smi_any_n0 ///
adl_impair_core_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 ///
adl_stable_ind_n0n1 adl_change_i_m_n0n1

preserve

graph bar `colvars1' , over(likelycomp) 
graph save `logpath'\sigvars_xvars_totplus1_`crit', replace

graph bar `colvars2', over(likelycomp) 
graph save `logpath'\sigvars_othervars_totplus1_`crit', replace

collapse `colvars1' `colvars2', by(likelycomp)

foreach x of local colvars1 {
rename `x' covars`x'
}
foreach x of local colvars2 {
rename `x' othervars`x'
}

reshape long covars othervars, i(likelycomp) string
graph bar (asis) covars if covars!=., over(likelycomp) over(_j)
graph save `logpath'\covars_`crit', replace

graph bar (asis) othervars if othervars!=., over(likelycomp) over(_j)
graph save `logpath'\othervars_`crit', replace
restore


log close
}


H="2010 & crit a fmm totbins postestimation"
/*looking at postestimation for the fmm models for total paid in $100 & $1000 bins
for the 2010 sample in the previous section*/

foreach crit in  "2010" "a" {
capture log close
set more off

local logpath E:\data\serious_ill\logs
local datapath2 E:\data\serious_ill\int_data
local datapath E:\data\serious_ill\final_data

cd `datapath'

log using "`logpath'\14_fmm_`crit'_core_postest_bins.txt", text replace

foreach bins in "tot_100bins" "tot_1000bins" {
clear all


use n0_n1_p1_p2_x_criteria_`crit'_v2_fmm.dta
***************************************************************
local cvars age_at_core_n0

local ivars female re_white ///
hs_deg_ind nw_midlow_n0 nw_midhigh_n0 nw_highest_n0 ///
religvimp_n0 srh_pf_n0 rel_nb_n0 married_n0 smi_nh_ind_n0 ///
medicaid_n0 champus_n0 medigap_n0 ///
smi_any_n0 ind_em_ur_adm_12m_n0 ///
adl_impair_core_n0

local da_quint d_eol_spend_quint1 d_eol_spend_quint2 d_eol_spend_quint3 ///
d_eol_spend_quint4

***************************************************************
//2 component postestimation
***************************************************************
estimates use `bins'_`crit'_fmm_2comp
mat `bins'_`crit'_fmm2=e(b)

fmm `bins'_wi_12m `cvars' `ivars' `da_quint', components(2) mixtureof(negbin2) ///
 diff vce(robust) from(`bins'_`crit'_fmm2) iter(0)

estat ic

***************************************************************
//component density
predict yhat0
predict yhat1, eq(component1)
predict yhat2, eq(component2)

sum yhat1
scalar yhat1mean = r(mean)

sum yhat2
scalar yhat2mean = r(mean)


twoway hist yhat1, percent  color(blue) finten(inten10) title("Predicted MC Payments") legend(label(1 Component1)) || hist yhat2, percent color(orange) legend(label(2 Component2)) fint(inten10)
	graph save `logpath'\14_fmm_`bins'_`crit'_2comp_hist, replace
twoway kdensity yhat1, color(blue) legend(label(1 Component1)) title("Predicted MC Payments")|| kdensity yhat2, color(orange) legend(label(2 Component2)) || kdensity yhat0, color(gray) legend(label(3 Full Sample Prediction))
	graph save `logpath'\14_fmm_`bins'_`crit'_2comp_kden, replace
**************************************************
//get posterior probability each component
predict po1_Xres, posterior eq(component1) //posterior prob comp 1
sum po1_Xres, detail
local p1=round(r(mean),.01)

gen likelycomp=1 if po1_Xres>.8
replace likelycomp=2 if po1_Xres<=.2
tab likelycomp, missing

***************************************************************
//regress post prob on covariates
reg po1_Xres `cvars' `ivars' `da_quint', beta vce(r)

outreg using `logpath'\14_fmm_`bins'_`crit'_2comp_means, ///
replace stats(beta) ///
title("MC Payments `bins' - regression posterior probability on expl variables") ///
ctitles("","Posterior probability Comp 1") ///
bdec(4) starlevels(10 5 1) ///
addrows("Probability","`p1'") varlabels

***************************************************************
//means of variables by component
drop if likelycomp==.

local covars age_at_core_n0 female re_white ///
hs_deg_ind nw_midlow_n0 nw_midhigh_n0 nw_highest_n0 ///
religvimp_n0 srh_pf_n0 rel_nb_n0 married_n0 smi_nh_ind_n0 ///
medicaid_n0 champus_n0 medigap_n0 ///
smi_any_n0 ind_em_ur_adm_12m_n0 ///
adl_impair_core_n0 d_eol_spend_quint1 d_eol_spend_quint2 d_eol_spend_quint3 ///
d_eol_spend_quint4
local n_models : word count `covars'

matrix means2=J(2*`n_models',2,.)
mean `covars', over(likelycomp)
mat means1=e(b)'
mat list means1

forval i=1/`n_models'{
	local v `: word `i' of `covars''
	ttest `v',by(likelycomp)
	local se`v' = r(se)
	local p`v' = r(p)
	local row`v' = 2*(`i'-1)+1
	mat means2[`row`v'',1]=`se`v''
	mat means2[`row`v'',2]=`p`v''
}

mat list means1
mat list means2
mat means=means1,means2
mat list means

frmttable using `logpath'\14_fmm_`bins'_`crit'_2comp_means, ///
statmat(means) substat(0) sdec(3) varlabels ///
title("Means explanatory variables, 2 components") ///
ctitle("","component","means","standard errors","p-value") addtable

***************************************************************
//means of other health related variables by component
local othervars smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 smi_liver_ind_n0 ///
smi_hip_ind_n0 adl_stable_ind_n0n1 adl_stable_partial_n0n1 ///
adl_stable_severe_n0n1 adl_change_i_m_n0n1 adl_change_i_s_n0n1 ///
adl_change_m_s_n0n1

local n_models2 : word count `othervars'

matrix means2=J(2*`n_models2',2,.)
mean `othervars', over(likelycomp)
mat means1=e(b)'
mat list means1

forval i=1/`n_models2'{
	local v `: word `i' of `othervars''
	ttest `v',by(likelycomp)
	local se`v' = r(se)
	local p`v' = r(p)
	local row`v' = 2*(`i'-1)+1
	mat means2[`row`v'',1]=`se`v''
	mat means2[`row`v'',2]=`p`v''
}

mat list means1
mat list means2
mat means=means1,means2
mat list means

frmttable using `logpath'\14_fmm_`bins'_`crit'_2comp_means, ///
statmat(means) substat(0) sdec(3) varlabels ///
title("Means other health related variables, 2 components") ///
ctitle("","component","means","standard errors","p-value") addtable


local colvars1 female re_white hs_deg_ind nw_highest_n0 srh_pf_n0 rel_nb_n0 married_n0 ///
medigap_n0 smi_any_n0 ind_em_ur_adm_12m_n0 adl_impair_core_n0 
local colvars2 smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 smi_liver_ind_n0 ///
smi_hip_ind_n0 adl_stable_ind_n0n1 adl_stable_partial_n0n1 ///
adl_change_i_m_n0n1 adl_change_m_s_n0n1
local graphbars female re_white nw_highest_n0 champus_n0 medigap_n0 smi_any_n0 ///
adl_impair_core_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 ///
adl_stable_ind_n0n1 adl_change_i_m_n0n1

preserve

graph bar `colvars1' , over(likelycomp) 
graph save `logpath'\sigvars_xvars_`bins'_`crit', replace

graph bar `colvars2', over(likelycomp) 
graph save `logpath'\sigvars_othervars_`bins'_`crit', replace

collapse `colvars1' `colvars2', by(likelycomp)

foreach x of local colvars1 {
rename `x' covars`x'
}
foreach x of local colvars2 {
rename `x' othervars`x'
}

reshape long covars othervars, i(likelycomp) string
graph bar (asis) covars if covars!=., over(likelycomp) over(_j)
graph save `logpath'\covars_`crit', replace

graph bar (asis) othervars if othervars!=., over(likelycomp) over(_j)
graph save `logpath'\othervars_`crit', replace
restore


}
log close
}


H="crit a fmm null model"
note-this doesn't run.


/*Saves estimates from hospital  nights 2 and 3 component fmm models*/

foreach crit in  "a" {

capture log close
clear all
set more off

local logpath E:\data\serious_ill\logs
local datapath2 E:\data\serious_ill\int_data
local datapath E:\data\serious_ill\final_data

log using "`logpath'\13_fmm_`crit'_core.txt", text replace

cd `datapath'


use n0_n1_p1_p2_x_criteria_`crit'_v1.dta
***************************************************************
drop if tot_paid_by_mc_12m_wi_n0<0

la var n_hospd_p12m_n0 "Hospital nights"
la var tot_paid_by_mc_12m_wi_n0 "Total MC spending"

tab degree hs_deg_ind, missing //switched to tracker degree level variable
tab female, missing

gen religvimp_n0=1 if imprelig_n0==1
replace religvimp_n0=0 if inlist(imprelig_n0,2,3,4)
tab religvimp_n0, missing

gen smi_any_n0=1 if smi_count_n0>0
replace smi_any_n0=0 if smi_count_n0==0
tab smi_any_n0, m
//base no high school degree, male, white, adl improved or stable independent n1n0

local cvars age_at_core_n0


local ivars female re_white ///
hs_deg_ind nw_midlow_n0 nw_midhigh_n0 nw_highest_n0 ///
religvimp_n0 srh_pf_n0 rel_nb_n0 married_n0 smi_nh_ind_n0 ///
medicaid_n0 champus_n0 medigap_n0 ///
smi_any_n0 ind_em_ur_adm_12m_n0 ///
adl_impair_core_n0

//regional variables, split by quartile of hrr eol spending per dm atlas
local rvars tot_eol_spending_hrr_n0 hospital_care_intensity_n0 ///
	physicians_n0 specialists_n0 hospital_beds_n0

foreach v in `rvars' {
qui sum `v', detail
qui drop if `v'==.
}

xtile quintile_dm_2yr=tot_eol_spending_hrr_n0, nq(5)

tab quintile_dm_2yr, m
la var quintile_dm_2yr "Quintiles of 2 year Dartmouth EOL Medicare Spending, HRR level (within this sample)"
la val quintile_dm_2yr quint

sum tot_eol_spending_hrr_n0 if quintile_dm_2yr==1, detail
sum tot_eol_spending_hrr_n0 if quintile_dm_2yr==2, detail
sum tot_eol_spending_hrr_n0 if quintile_dm_2yr==3, detail
sum tot_eol_spending_hrr_n0 if quintile_dm_2yr==4, detail
sum tot_eol_spending_hrr_n0 if quintile_dm_2yr==5, detail

tab quintile_dm_2yr, gen(d_eol_spend_quint) missing

foreach v in `cvars' {
qui sum `v', detail
qui drop if `v'==.
}

foreach v in `ivars' {
qui tab `v', missing
drop if `v'==.
}


//now look at outcomes for the sample to be used for fmm
**************************************************************************

kdensity tot_paid_by_mc_12m_wi_n0, ///
ytitle(density) subtitle("Density of Medicare payments, 1 year after Core Interview")
graph save `logpath'\mc_paid_kdensity, replace

//hosp nights?
by n_hospd_p12m_n0, sort: egen hospd_freq=count(n_hospd_p12m_n0)
tab n_hospd_p12m_n0 if hospd_freq>10, m
sum n_hospd_p12m_n0, d
hist n_hospd_p12m_n0 if hospd_freq>10, freq
graph save `logpath'\hospd_hist, replace

//quick look at who meets the criteria

gen criteria=1
replace criteria=2 if criteria_b_n0==1
replace criteria=3 if criteria_c_n0==1

label define criteria 1 "Criteria A Only" 2 "Criteria B Only" 3 "Criteria C"
label values criteria criteria

tab criteria, missing


***************************************************************************
local da_quint d_eol_spend_quint1 d_eol_spend_quint2 d_eol_spend_quint3 ///
d_eol_spend_quint4

tab age_cat2_n0, gen(age_n0_ind)

//lee index of mortality
gen leeindex_n0=1
qui replace leeindex_n0=leeindex_n0+3 if age_n0_ind2==1
qui replace leeindex_n0=leeindex_n0+4 if  age_n0_ind3==1	
qui replace leeindex_n0=leeindex_n0+5 if age_n0_ind4 ==1
qui replace leeindex_n0=leeindex_n0+7 if age_n0_ind5 ==1
qui replace leeindex_n0=leeindex_n0+2 if female ==0
qui replace leeindex_n0=leeindex_n0+1 if dm_hrs_n0==1
qui replace leeindex_n0=leeindex_n0+2 if cancer_hrs_n0==1
qui replace leeindex_n0=leeindex_n0+2 if lung_hrs_n0== 1
qui replace leeindex_n0=leeindex_n0+2 if chf_hrs_n0 ==1
qui replace leeindex_n0=leeindex_n0+2 if smoke_curr_n0==1
qui replace leeindex_n0=leeindex_n0+1 if bmi_lt25_n0==1
qui replace leeindex_n0=leeindex_n0+2 if adl_diff_bh_n0==1
qui replace leeindex_n0=leeindex_n0+2 if iadl_diff_m_n0==1
qui replace leeindex_n0=leeindex_n0+1 if fl_diff_push_n0==1
qui replace leeindex_n0=leeindex_n0+2 if fl_diff_wk_many_n0==1

//generate inverse propensity score weight, 1/p if w=1 1/1-p if w=0

global weightvars age_n0_ind2 age_n0_ind3 age_n0_ind4 age_n0_ind5 female ///
dm_hrs_n0 cancer_hrs_n0 lung_hrs_n0 chf_hrs_n0 bmi_lt25_n0 smoke_curr_n0  ///
adl_diff_bh_n0 iadl_diff_m_n0 fl_diff_wk_many_n0 fl_diff_push_n0 

logit core_to_dod_1yr_n0 $weightvars
predict prob_death_1yr_n0 //generate new var-pscore
gen invpscore=(1/prob_death_1yr_n0) if core_to_dod_1yr_n0==1
replace invpscore=(1/(1-prob_death_1yr_n0)) if core_to_dod_1yr_n0==0

gen totplus1_wi_n0=tot_paid_by_mc_12m_wi_n0+1 //new variable amt paid +$1

//look at dist of tot medicare payments
sum tot_paid_by_mc_12m_wi_n0, d

// other way of getting around zeros, put in $100 and $1000 bins
gen tot_100bins_wi_12m=.
gen tot_1000bins_wi_12m=.

forvalues i = 1/5230 {

qui replace tot_100bins= `i' if tot_paid_by_mc_12m_wi_n0>=((`i'-1)*100) & ///
	tot_paid_by_mc_12m_wi_n0<(`i'*100)
qui replace tot_1000bins= `i' if tot_paid_by_mc_12m_wi_n0>=((`i'-1)*1000) & ///
	tot_paid_by_mc_12m_wi_n0<(`i'*1000)
}
gen tot_reportable_100bins=tot_100bi
replace tot_reportable_100bins=61 if tot_reportable_100b>61
tab tot_reportable_100b

by tot_100bins, sort: egen bins_freq=count(tot_100bins)
tab tot_100bins if bins_freq>10

gen tot_reportable_1000bins=tot_1000b
replace tot_reportable_1000b=68 if tot_1000b>68

tab tot_reportable_1000b
hist tot_reportable_1000, width(1) freq title("MC Spending, $1000 bins")
graph save `logpath'\tot_reportable_1000bins_hist, replace



******************************************************************

//hospital nights - base nb2 model
nbreg n_hospd_p12m_n0, prob( `cvars' `ivars' `da_quint') vce(robust)
estat ic

fmm n_hospd_p12m_n0, components(2) mixtureof(negbin2) ///
	diff vce(robust)

fmm n_hospd_p12m_n0, prob( `cvars' `ivars' `da_quint') components(2) mixtureof(negbin2) ///
	diff vce(robust)
estimates save hospd_`crit'_fmm_2comp, replace
predict phospd, posterior eq(component1)
predict phospd_1, eq(component1)
predict phospd_2, eq(component2)
predict phospd_0
estat ic

/* //does not converge for criteria a group
fmm n_hospd_p12m_n0, prob( `cvars' `ivars' `da_quint') components(3) mixtureof(negbin2) ///
	diff vce(robust)
estimates save hospd_`crit'_fmm_3comp, replace
predict phospd3, posterior eq(component1)
*/

//looking at spending

//total medicare payments, different ways

glm totplus1_wi_n0, prob( `cvars' `ivars' `da_quint') family(gamma) link(log) vce(robust)
glm, eform
estat ic
mat glmtotplus1=r(S)

fmm totplus1_wi_n0, components(2) ///
	mixtureof(gamma) search(on) diff vce(robust)

fmm totplus1_wi_n0, prob( `cvars' `ivars' `da_quint') components(2) ///
	mixtureof(gamma) search(on) diff vce(robust)
estimates save tot_paid_`crit'_fmm_2comp, replace
predict ptot1, posterior eq(component1)
predict ptot1_1, eq(component1)
predict ptot1_2, eq(component2)
predict ptot1_0
estat ic
mat totplus1=r(S)


/*
//does not converge
fmm totplus1_wi_n0, prob( `cvars' `ivars' `da_quint') components(3) ///
	mixtureof(gamma) search(on) vce(robust)
estimates save tot_paid_`crit'_fmm_3comp, replace
*/

glm tot_100bins_wi_12m, prob( `cvars' `ivars' `da_quint') family(gamma) link(log) vce(robust)
glm, eform
estat ic
mat glm100bins=r(S)

fmm tot_100bins_wi_12m, components(2) ///
	mixtureof(gamma) search(on) diff vce(robust)

fmm tot_100bins_wi_12m, prob( `cvars' `ivars' `da_quint') components(2) ///
	mixtureof(gamma) search(on) diff vce(robust)
predict pbinsgamma, posterior eq(component1)
predict pbinsgamma_1, eq(component1)
predict pbinsgamma_2, eq(component2)
predict pbinsgamma_0
estat ic
mat twocompglm100bins=r(S)



nbreg tot_100bins_wi_12m `cvars' `ivars' `da_quint'
estat ic
mat nb100bins=r(S)

fmm tot_100bins_wi_12m, components(2) ///
	mixtureof(negbin2) diff vce(robust)

fmm tot_100bins_wi_12m, prob( `cvars' `ivars' `da_quint') components(2) ///
	mixtureof(negbin2) diff vce(robust)
estimates save tot_100bins_`crit'_fmm_2comp, replace
predict pbins100, posterior eq(component1)
predict pbins100_1, eq(component1)
predict pbins100_2, eq(component2)
predict pbins100_0
estat ic
mat twocomp100bins=r(S)


/* does not converge with ipsw for any specification

nbreg tot_100bins_wi_12m `cvars' `ivars' `da_quint' [pw=invp]
estat ic
mat nbpw100bins=r(S)


fmm tot_100bins_wi_12m `cvars' `ivars' `da_quint' [pw=invp], components(2) ///
	mixtureof(negbin2) diff vce(robust)
estimates save tot_100bins_`crit'_fmm_pw_2comp, replace
predict pbins100pw, posterior eq(component1)
predict pbins100pw_1, eq(component1)
predict pbins100pw_2, eq(component2)
predict pbins100pw_0
estat ic
mat twocomppw100bins=r(S)
*/


nbreg tot_1000bins_wi_12m `cvars' `ivars' `da_quint'
estat ic
mat nb1000bins=r(S)


fmm tot_1000bins_wi_12m, prob( `cvars' `ivars' `da_quint') components(2) ///
	mixtureof(negbin2) diff vce(robust)
estimates save tot_1000bins_`crit'_fmm_2comp, replace
predict pbins1000, posterior eq(component1)
predict pbins1000_1, eq(component1)
predict pbins1000_2, eq(component2)
predict pbins1000_0
estat ic
mat twocomp1000bins=r(S)


corr phospd ptot1 pbinsgamma pbins100 pbins1000 //pbins100pw

di "glmtotplus1"
matlist glmtotplus1
di "twcomptotplus1"
matlist totplus1
di "glm100bins"
matlist glm100bins
di "twocompglm100bins"
matlist twocompglm100bins
di "nb100bins"
matlist nb100bins
di "twocomp100bins"
matlist twocomp100bins
*di "nbpw100bins"
*matlist nbpw100bins
*di "twocomppw100bins"
*matlist twocomppw100bins
di "nb1000bins"
matlist nb1000bins
di "twocomp1000bins"
matlist twocomp1000bins

//save this dataset

save n0_n1_p1_p2_x_criteria_`crit'_v2_fmm.dta, replace
log close
}



H="***********************************"


H="two-part model for hospital days"
foreach crit in  "a" {

capture log close
clear all
set more off

local logpath E:\data\serious_ill\logs
local datapath2 E:\data\serious_ill\int_data
local datapath E:\data\serious_ill\final_data

log using "`logpath'\15_twopart_hospd_`crit'_core.txt", text replace

cd `datapath'


use n0_n1_p1_p2_x_criteria_`crit'_v1.dta
***************************************************************
drop if tot_paid_by_mc_12m_wi_n0<0

la var n_hospd_p12m_n0 "Hospital nights"
la var tot_paid_by_mc_12m_wi_n0 "Total MC spending"

tab degree hs_deg_ind, missing //switched to tracker degree level variable
tab female, missing

gen religvimp_n0=1 if imprelig_n0==1
replace religvimp_n0=0 if inlist(imprelig_n0,2,3,4)
tab religvimp_n0, missing

gen smi_any_n0=1 if smi_count_n0>0
replace smi_any_n0=0 if smi_count_n0==0
tab smi_any_n0, m
//base no high school degree, male, white, adl improved or stable independent n1n0

local cvars age_at_core_n0


local ivars female re_white ///
hs_deg_ind nw_midlow_n0 nw_midhigh_n0 nw_highest_n0 ///
religvimp_n0 srh_pf_n0 rel_nb_n0 married_n0 smi_nh_ind_n0 ///
medicaid_n0 champus_n0 medigap_n0 ///
smi_any_n0 ind_em_ur_adm_12m_n0 ///
adl_impair_core_n0

//regional variables, split by quartile of hrr eol spending per dm atlas
local rvars tot_eol_spending_hrr_n0 hospital_care_intensity_n0 ///
	physicians_n0 specialists_n0 hospital_beds_n0

foreach v in `rvars' {
qui sum `v', detail
qui drop if `v'==.
}

global xvars `cvars' `ivars' hospital_care_intensity_n0 hospital_beds_n0 specialists_n0
 
xtile quintile_dm_2yr=tot_eol_spending_hrr_n0, nq(5)

tab quintile_dm_2yr, m
la var quintile_dm_2yr "Quintiles of 2 year Dartmouth EOL Medicare Spending, HRR level (within this sample)"
la val quintile_dm_2yr quint

sum tot_eol_spending_hrr_n0 if quintile_dm_2yr==1, detail
sum tot_eol_spending_hrr_n0 if quintile_dm_2yr==2, detail
sum tot_eol_spending_hrr_n0 if quintile_dm_2yr==3, detail
sum tot_eol_spending_hrr_n0 if quintile_dm_2yr==4, detail
sum tot_eol_spending_hrr_n0 if quintile_dm_2yr==5, detail

tab quintile_dm_2yr, gen(d_eol_spend_quint) missing

foreach v in `cvars' {
qui sum `v', detail
qui drop if `v'==.
}

foreach v in `ivars' {
qui tab `v', missing
drop if `v'==.
}

//hosp nights?
by n_hospd_p12m_n0, sort: egen hospd_freq=count(n_hospd_p12m_n0)
tab n_hospd_p12m_n0 if hospd_freq>10, m
sum n_hospd_p12m_n0, d
hist n_hospd_p12m_n0 if hospd_freq>10, freq
graph save `logpath'\hospd_hist, replace

//quick look at who meets the criteria

gen criteria=1
replace criteria=2 if criteria_b_n0==1
replace criteria=3 if criteria_c_n0==1

label define criteria 1 "Criteria A Only" 2 "Criteria B Only" 3 "Criteria C"
label values criteria criteria

tab criteria, missing


***************************************************************************
local da_quint quintile_dm_2yr

tab age_cat2_n0, gen(age_n0_ind)

//lee index of mortality
gen leeindex_n0=1
qui replace leeindex_n0=leeindex_n0+3 if age_n0_ind2==1
qui replace leeindex_n0=leeindex_n0+4 if  age_n0_ind3==1	
qui replace leeindex_n0=leeindex_n0+5 if age_n0_ind4 ==1
qui replace leeindex_n0=leeindex_n0+7 if age_n0_ind5 ==1
qui replace leeindex_n0=leeindex_n0+2 if female ==0
qui replace leeindex_n0=leeindex_n0+1 if dm_hrs_n0==1
qui replace leeindex_n0=leeindex_n0+2 if cancer_hrs_n0==1
qui replace leeindex_n0=leeindex_n0+2 if lung_hrs_n0== 1
qui replace leeindex_n0=leeindex_n0+2 if chf_hrs_n0 ==1
qui replace leeindex_n0=leeindex_n0+2 if smoke_curr_n0==1
qui replace leeindex_n0=leeindex_n0+1 if bmi_lt25_n0==1
qui replace leeindex_n0=leeindex_n0+2 if adl_diff_bh_n0==1
qui replace leeindex_n0=leeindex_n0+2 if iadl_diff_m_n0==1
qui replace leeindex_n0=leeindex_n0+1 if fl_diff_push_n0==1
qui replace leeindex_n0=leeindex_n0+2 if fl_diff_wk_many_n0==1


logit ind_hosp_adm_p12m_n0 $xvars, or
predict p, p
outreg using "`logpath'\hospnights_twopart.rtf", ///
title("Two Part Model, Hospital Nights, 12 Months After n0 Interview") replace ///
ctitle("" "Logit, Any Nights") varlabels
tnbreg n_hospd_p12m_n0 $xvars if ind_hosp_adm_p12m_n0==1
predict cm, cm

outreg using "`logpath'\hospnights_twopart.rtf", merge ///
ctitles("" "Logit, Any Nights" "TNBReg, Nights") varlabels
gen pred= p*cm

**compare means of actual days and unconditional predicted days at orignal values
sum n_hospd_p12m_n0 pred
sum n_hospd_p12m_n0 cm if ind_hosp_adm_p12m_n0==1 
drop p cm pred
}



capture program drop tpm_dummy
program define tpm_dummy, rclass



preserve
capture drop sd mean ave high orig p0 p cm p1 rr cm0 cm1 cdiff pred pred0 pred1 udiff
global preg `ivars' `da_quint'
logit ind_hosp_adm_p12m_n0 $xvars

**calculate predicted prob at original values
predict p, p
gen orig=`1'

*calcualte predicted prob when dumy=0
replace `1'=0
predict p0, p

*calculate when dummy==1
replace `1'=1
predict p1, p

*calculate relative risk
gen rr=p1/p0

*reset dummy back to orignal value
replace `1' =orig
drop orig
*conditional neg bin reg of the num of hosp days w/ those w/ days

tnbreg n_hospd_p12m_n0 $xvars if ind_hosp_adm_p12m_n0==1

* calculate cm 
predict cm, cm
gen orig=`1'

*calculate cond exp when dumy=0
replace `1' = 0
predict cm0, cm

*calculate when dummy==1
replace `1' = 1
predict cm1, cm

*calculate the diff in cond expectations
gen cdiff=cm1-cm0

*reset dummy back to orignal value
replace `1' = orig
drop orig

**calculate uncond expect at original values
gen pred = p*cm

**calculate uncond exp at dummy=0
gen pred0=p0*cm0

** calcualte uncond exp when dummy==1
gen pred1=p1*cm1

**calculate diff in unc expe
gen udiff=pred1-pred0

tempname y1 
sum rr, meanonly
scalar `y1'= r(mean)
return scalar rrboot=`y1'

tempname y2 
sum cdiff, meanonly
scalar `y2'=r(mean)
return scalar cdiffboot=`y2'

tempname y3
sum udiff, meanonly
scalar `y3'=r(mean)
return scalar udiffboot=`y3'
restore
end


**program to obtain estimates for cont vars
capture program drop tpm_1std
program define tpm_1std, rclass
preserve
capture drop sd mean ave high orig p0 p cm p1 rr cm0 cm1 cdiff pred pred0 pred1 udiff

qui logit ind_hosp_adm_p12m_n0 $xvars
* calculate pred prob at orignal valus
predict p, p
*calculate sd and mean of cvars
egen sd=sd(`1')
egen mean=mean(`1')
gen low=mean-sd
gen high=mean+sd
gen orig=`1'

*calculate pred prob when regressor set to mean minus one sd
replace `1'=low
predict p0, p
*calculate when mean plus one sd
replace `1'=high
predict p1, p
*calculate rr assoc with increase from mean-1 to mean+1

gen rr=p1/p0
*reset back to orignial value
replace `1'=orig

**conditional nbreg
tnbreg n_hospd_p12m_n0 $xvars if ind_hosp_adm_p12m_n0==1

*calculate cm
predict cm, cm

*calculate when mean-1
replace `1'=low
predict cm0, cm

*calculate when mean+1
replace `1'=high
predict cm1, cm

*calculate difference
gen cdiff=cm1-cm0

**reset value
replace `1'=orig

*calculate uncond exp. at original values
gen pred=p*cm
*calculate unc exp when mean-1
gen pred0=p0*cm0
*calculate uncon exp. when mean+1
gen pred1=p1*cm1
*compare means of actual and pred at original values
sum n_hospd_p12m_n0 pred

*calculate diff in unconditional expectations
gen udiff=pred1-pred0

tempname y1 
sum rr, meanonly
scalar `y1'=r(mean)
return scalar rrboot=`y1'

tempname y2
sum cdiff, meanonly
scalar `y2'=r(mean)
return scalar cdiffboot=`y2'

tempname y3 
sum udiff, meanonly
scalar `y3'=r(mean)
return scalar udiffboot=`y3'

end

****Run bottstrap

set seed 123
**list of cvars	
local var_list continuous_variables
**list of dummies
local var_list_dummy dummy_vars

local cvars age_at_core_n0


local ivars female re_white ///
hs_deg_ind nw_midlow_n0 nw_midhigh_n0 nw_highest_n0 ///
religvimp_n0 srh_pf_n0 rel_nb_n0 married_n0 smi_nh_ind_n0 ///
medicaid_n0 champus_n0 medigap_n0 ///
smi_any_n0 ind_em_ur_adm_12m_n0 ///
adl_impair_core_n0


**for cvars
foreach var of local cvars {
display " "
display "variable name========  `var'"
display "mean-1std vs mean+1std"
bootstrap "tpm_1std `var'" `var'_rr=r(rrboot) `var'_cdiff=r(cdiffboot) ///
`var'_udiff=r(udiffboot), reps(1000)
outreg using "`logpath'\bootstrap_twopart_hospd.rtf", replace
}

foreach var of local ivars {
display " "
display "variable name========  `var'"
display " "
bootstrap "tpm_dummy `var'" 	`var'_rr=r(rrboot) `var'_cdiff=r(cdiffboot) ///
`var'_udiff=r(udiffboot), reps(1000)
outreg using "`logpath'\bootstrap_twopart_hospd.rtf", append

}

foreach var in  hospital_care_intensity_n0 hospital_beds_n0 specialists_n0 {
display " "
display "variable name========  `var'"
display " "
bootstrap "tpm_dummy `var'" 	`var'_rr=r(rrboot) `var'_cdiff=r(cdiffboot) ///
`var'_udiff=r(udiffboot), reps(1000)
outreg using "`logpath'\bootstrap_twopart_hospd.rtf", append

}


global xvars `cvars' `ivars' hospital_care_intensity_n0 hospital_beds_n0 specialists_n0

hnblogit n_hospd_p12m_n0 $xvars 
qui outreg, varlabels
hnblogit n_hospd_p12m_n0 $xvars core_to_dod_1yr_n0 
qui outreg, merge varlabels
hnblogit n_hospd_p12m_n0 $xvars core_to_dod_1yr_n0  [pw=ebw]
qui outreg, merge varlabels
hnblogit n_hospd_p12m_n0 $xvars if core_to_dod_1yr_n0 ==0
qui outreg, merge varlabels
hnblogit n_hospd_p12m_n0 $xvars if core_to_dod_1yr_n0==1
outreg, merge varlabels


H="xxxchecking two-part using hnblogit"
foreach crit in  "a" {

capture log close
clear all
set more off

local logpath E:\data\serious_ill\logs
local datapath2 E:\data\serious_ill\int_data
local datapath E:\data\serious_ill\final_data

log using "`logpath'\hnblogit_hospd_`crit'_core.txt", text replace

cd `datapath'


use n0_n1_p1_p2_x_criteria_`crit'_v1.dta
***************************************************************
drop if tot_paid_by_mc_12m_wi_n0<0

la var n_hospd_p12m_n0 "Hospital nights"
la var tot_paid_by_mc_12m_wi_n0 "Total MC spending"

tab degree hs_deg_ind, missing //switched to tracker degree level variable
tab female, missing

gen religvimp_n0=1 if imprelig_n0==1
replace religvimp_n0=0 if inlist(imprelig_n0,2,3,4)
tab religvimp_n0, missing

gen smi_any_n0=1 if smi_count_n0>0
replace smi_any_n0=0 if smi_count_n0==0
tab smi_any_n0, m
//base no high school degree, male, white, adl improved or stable independent n1n0

local cvars age_at_core_n0


local ivars female re_white ///
hs_deg_ind nw_midlow_n0 nw_midhigh_n0 nw_highest_n0 ///
religvimp_n0 srh_pf_n0 rel_nb_n0 married_n0 smi_nh_ind_n0 ///
medicaid_n0 champus_n0 medigap_n0 ///
smi_any_n0 ind_em_ur_adm_12m_n0 ///
adl_impair_core_n0

//regional variables, split by quartile of hrr eol spending per dm atlas
local rvars tot_eol_spending_hrr_n0 hospital_care_intensity_n0 ///
	physicians_n0 specialists_n0 hospital_beds_n0

foreach v in `rvars' {
qui sum `v', detail
qui drop if `v'==.
}

global xvars `cvars' `ivars' hospital_care_intensity_n0 hospital_beds_n0 specialists_n0
 
xtile quintile_dm_2yr=tot_eol_spending_hrr_n0, nq(5)

tab quintile_dm_2yr, m
la var quintile_dm_2yr "Quintiles of 2 year Dartmouth EOL Medicare Spending, HRR level (within this sample)"
la val quintile_dm_2yr quint

sum tot_eol_spending_hrr_n0 if quintile_dm_2yr==1, detail
sum tot_eol_spending_hrr_n0 if quintile_dm_2yr==2, detail
sum tot_eol_spending_hrr_n0 if quintile_dm_2yr==3, detail
sum tot_eol_spending_hrr_n0 if quintile_dm_2yr==4, detail
sum tot_eol_spending_hrr_n0 if quintile_dm_2yr==5, detail

tab quintile_dm_2yr, gen(d_eol_spend_quint) missing

foreach v in `cvars' {
qui sum `v', detail
qui drop if `v'==.
}

foreach v in `ivars' {
qui tab `v', missing
drop if `v'==.
}

//hosp nights?
by n_hospd_p12m_n0, sort: egen hospd_freq=count(n_hospd_p12m_n0)
tab n_hospd_p12m_n0 if hospd_freq>10, m
sum n_hospd_p12m_n0, d
hist n_hospd_p12m_n0 if hospd_freq>10, freq
graph save `logpath'\hospd_hist, replace

//quick look at who meets the criteria

gen criteria=1
replace criteria=2 if criteria_b_n0==1
replace criteria=3 if criteria_c_n0==1

label define criteria 1 "Criteria A Only" 2 "Criteria B Only" 3 "Criteria C"
label values criteria criteria

tab criteria, missing


***************************************************************************
local da_quint quintile_dm_2yr

tab age_cat2_n0, gen(age_n0_ind)

//lee index of mortality
gen leeindex_n0=1
qui replace leeindex_n0=leeindex_n0+3 if age_n0_ind2==1
qui replace leeindex_n0=leeindex_n0+4 if  age_n0_ind3==1	
qui replace leeindex_n0=leeindex_n0+5 if age_n0_ind4 ==1
qui replace leeindex_n0=leeindex_n0+7 if age_n0_ind5 ==1
qui replace leeindex_n0=leeindex_n0+2 if female ==0
qui replace leeindex_n0=leeindex_n0+1 if dm_hrs_n0==1
qui replace leeindex_n0=leeindex_n0+2 if cancer_hrs_n0==1
qui replace leeindex_n0=leeindex_n0+2 if lung_hrs_n0== 1
qui replace leeindex_n0=leeindex_n0+2 if chf_hrs_n0 ==1
qui replace leeindex_n0=leeindex_n0+2 if smoke_curr_n0==1
qui replace leeindex_n0=leeindex_n0+1 if bmi_lt25_n0==1
qui replace leeindex_n0=leeindex_n0+2 if adl_diff_bh_n0==1
qui replace leeindex_n0=leeindex_n0+2 if iadl_diff_m_n0==1
qui replace leeindex_n0=leeindex_n0+1 if fl_diff_push_n0==1
qui replace leeindex_n0=leeindex_n0+2 if fl_diff_wk_many_n0==1


global xvars `cvars' `ivars' hospital_care_intensity_n0 hospital_beds_n0 specialists_n0

hnblogit n_hospd_p12m_n0 $xvars 
qui outreg, varlabels
hnblogit n_hospd_p12m_n0 $xvars core_to_dod_1yr_n0 
qui outreg, merge varlabels
hnblogit n_hospd_p12m_n0 $xvars core_to_dod_1yr_n0  [pw=ebw]
qui outreg, merge varlabels
hnblogit n_hospd_p12m_n0 $xvars if core_to_dod_1yr_n0 ==0
qui outreg, merge varlabels
hnblogit n_hospd_p12m_n0 $xvars if core_to_dod_1yr_n0==1
outreg, merge varlabels


H="**********************************"


H="xxxxPropensity score matching on mortality"
/*propensity score match on mortality
group that meets criteria A or medical illness only
use comments to switch between criteria
*/

capture log close

clear all
set more off

local crit a
//local crit smi
local logpath E:\data\serious_ill\logs
local datapath E:\data\serious_ill\final_data

log using "`logpath'\20_ps_match_mortality_crit_`crit'.txt", text replace

cd `datapath'

use n0_n1_p1_p2_x_criteria_`crit'_v1.dta if core_year_n0<2010
******************************************************************

******************************************************************
di "Criteria `crit' dataset"
******************************************************************
tab core_to_dod_1yr_n0, missing //mortality at 1 year
tab core_to_dod_1yr_p1, missing //at p1 interview

//no one with als=1 died within 1 year so cannot include in match variables list
tab smi_als_ind_n0 core_to_dod_1yr_n0, missing

//look at adl change variables, note if missing n1 interview, assigned to stable category
//based on adl status in period n0
tab adl_stable_ind_n0n1 adl_improved_n0n1 , missing //base case = independent,stable or improved
tab adl_stable_partial_n0n1, missing
tab adl_stable_severe_n0n1, missing
tab adl_change_i_m_n0n1, missing 
tab adl_change_i_s_n0n1, missing 
tab adl_change_m_s_n0n1, missing 
foreach v in adl_change_i_m_n0n1 adl_change_i_s_n0n1 adl_change_m_s_n0n1 {
replace `v'=0 if adl_stable_ind_n0n1==1 | adl_stable_partial_n0n1==1 | adl_stable_severe_n0n1==1
tab `v',missing
} 

//define matching variable list, drop if missing in any variables
//als indicator, all die within 1 year, so cannot include in the list
global matchvars age_at_core_n0 female re_white married_n0 networth_adj2012_n0 ///
hs_deg adl_stable_partial_n0n1 adl_stable_severe_n0n1 adl_change_i_m_n0n1 ///
 adl_change_i_s_n0n1 adl_change_m_s_n0n1 ///
 smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 ///
smi_liver_ind_n0  smi_hip_ind_n0 srh_pf_n0 

//n=4408 meet criteria A
//n=3596 meet Condition only criteria
foreach v in $matchvars{
sum `v', detail
bys core_to_dod_1yr_n0: sum `v'
drop if `v'==.
}

//n=4374 after drop missingness - Criteria A
//n=3578 after drop missingness - Condition Only criteria
tab core_to_dod_1yr_n0, missing //mortality at 1 year

******************************************************************
//sort data, generate propensity score
set seed 2000
gen x=uniform()
sort x

//generate pscore variable hs_pscore
pscore core_to_dod_1yr_n0 $matchvars, pscore(m1y_pscore) blockid(m1y_block) logit detail

psgraph, treated(core_to_dod_1yr_n0) pscore(m1y_pscore)

gen logitpscore=ln(m1y_pscore/(1-m1y_pscore))
sum logitpscore

sca cal_ps=r(sd)*0.02
sca list cal_ps

//rule of thumb 0.2*sd, we can use 0.02*sd, manually change this depending on which dataset used
//psmatch2 core_to_dod_1yr_n0,outcome(tot_paid_by_mc_6m_wi_n0) ///
//	pscore(m1y_pscore) radius caliper(.02081047) logit //criteria A caliper
psmatch2 core_to_dod_1yr_n0,outcome(tot_paid_by_mc_6m_wi_n0) ///
	pscore(m1y_pscore) radius caliper(.02178898) logit //criteria condition only caliper

//graph including off common support information
psgraph, treated(core_to_dod_1yr_n0) pscore(m1y_pscore)
graph save `logpath'\ps_dist_crit_`crit'.gph, replace

histogram m1y_pscore if _support==1, by(core_to_dod_1yr_n0) 

//look at balance of matched vs unmatched samples using %bias (std diff)
pstest $matchvars ,treated(core_to_dod_1yr_n0) both hist

mat vr=J(20,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $matchvars  {
sum `v' if core_to_dod_1yr_n0==1 //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if core_to_dod_1yr_n0==0 //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if core_to_dod_1yr_n0==1 & _support==1 //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if core_to_dod_1yr_n0==0 [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}

mat rownames vr="Age" "Female" "White" "Married" "Net Worth" ///
"HS Degree" "ADL Stable, Moderate" "ADL Stable, Severe" ///
"ADL Ind to Moderate" "ADL Ind to Severe" "ADL Mod to Severe" ///
 "Dementia" "Cancer" "ESRD" "CHF" ///
"COPD" "Diabetes" "Liver disease" "Hip Fracture" "SRH Fair/Poor" 

mat list vr

******************************************************************
//using this matching, 7 obs from the treatment group are dropped b/c they are off support
//0 are dropped b/c not matched (weight=.)
//_support ==1 if matched
tab _support, missing
tab _support if core_to_dod_1yr_n0==1, missing
tab _support if core_to_dod_1yr_n0==0, missing
tab _weight if core_to_dod_1yr_n0==1, missing
sum _weight if core_to_dod_1yr_n0==0

//thinking about how those that died will have truncated 1 year lookback for outcomes...
sum core_to_death_n0 if core_to_dod_1yr_n0==1, detail
histogram core_to_death_n0 if core_to_dod_1yr_n0==1

gen core_to_dod_1_2yr_n0=1 if core_to_death_n0<2 & core_to_death_n0>=1
tab core_to_dod_1_2yr_n0, missing
******************************************************************
//save the dataset
rename _weight ps_weight
rename _support ps_common_support

save n0_n1_p1_p2_x_criteria_`crit'_v1_psmatch.dta, replace


******************************************************************
log close


H="xxxxUnivariate and glm for psmatched sample"
/*using propensity score matched sample on mortality
from previous section, look at outcomes for
group that meets criteria a and condition only, use comments to set dataset
*/

capture log close

clear all
set more off

local crit a
local cdesc "Serious medical illness and/or ADL impairment"
//local crit smi
//local cdesc "Serious medical condition only"
local logpath E:\data\serious_ill\logs
local datapath E:\data\serious_ill\final_data

log using "`logpath'\21_ps_matched_outcomes1_crit_`crit'.txt", text replace

cd `datapath'

use n0_n1_p1_p2_x_criteria_`crit'_v1_psmatch.dta
***************************************************************
//look at those that died 1st 6 months, their utilization is truncated
tab core_to_dod_6m_n0 core_to_dod_1yr_n0, missing

***************************************************************
//table 1 compare pre-post matched samples
//on covariates used in matching

***************************************************************
//table 2 look at 6m outcomes pre-post matched samples
//show pvalues since looking at outcomes??

la var core_to_dod_1yr_n0 "Died, n (%)"
la var hs_admit_p6m_n0 "Enrolled in hospice, n (%)"
la var ind_em_ur_adm_p6m_n0 "Hospital admission, n (%)"
la var n_hospd_p6m_n0 "Hospital nights, mean (sd)"

la var ip_paid_by_mc_6m_wi_n0 "Inpatient"
la var snf_paid_by_mc_6m_wi_n0 "SNF"
la var hh_paid_by_mc_6m_wi_n0 "Home health" 
la var hs_paid_by_mc_6m_wi_n0 "Hospice" 
la var pb_paid_by_mc_6m_wi_n0 "Carrier"
la var op_paid_by_mc_6m_wi_n0 "Outpatient" 
la var dm_paid_by_mc_6m_wi_n0 "DME"
la var tot_paid_by_mc_6m_wi_n0 "Total Medicare payments"

local ivars ind_em_ur_adm_p6m_n0

local cvars n_hospd_p6m_n0 tot_paid_by_mc_6m_wi_n0 ip_paid_by_mc_6m_wi_n0 ///
snf_paid_by_mc_6m_wi_n0 hh_paid_by_mc_6m_wi_n0 hs_paid_by_mc_6m_wi_n0 ///
pb_paid_by_mc_6m_wi_n0 op_paid_by_mc_6m_wi_n0 dm_paid_by_mc_6m_wi_n0

//columns 1,2, before matching, 6m outcomes those that died vs didn't
mat t2=J(1,6,.)
foreach v in `ivars' { //indicator variables
local c=1
	foreach i in 1 0{
		sum `v' if core_to_dod_1yr_n0==`i'
		mat t2[1,`c']=r(mean)*r(N) //n
		mat t2[1,`c'+1]=r(mean)*100 //percent
		local c = `c'+2
	}
	tab `v' core_to_dod_1yr_n0, chi2 //p-values
	mat t2[1,5]=r(p)
	
	mat rownames t2=`v'
	frmttable, statmat(t2) varlabels sdec(0,0,3\2,2,2) substat(1) store(t2_1)
	
	outreg, replay(t2_2) append(t2_1) store(t2_2)
}

foreach v in `cvars' { //continuous variables
local c=1
	foreach i in 1 0{
		sum `v' if core_to_dod_1yr_n0==`i'
		mat t2[1,`c']=r(mean) //mean
		mat t2[1,`c'+1]=r(sd) //sd
		local c = `c'+2
	}
	ttest `v', by(core_to_dod_1yr_n0) //p-values
	mat t2[1,5]=r(p)
	
	mat rownames t2=`v'
	frmttable, statmat(t2) varlabels sdec(0,0,3\0,0,0) substat(1) store(t2_1)
	
	outreg, replay(t2_2) append(t2_1) store(t2_2)
}

//last row, n for each group
mat t2_n=J(1,2,.)
tab core_to_dod_1yr_n0, matcell(t2n)
mat t2_n[1,1]=t2n[2,1]
mat t2_n[1,2]=t2n[1,1]
mat rownames t2_n="N"
frmttable, statmat(t2_n) store(t2_n) sdec(0)

outreg, replay(t2_2) append(t2_n) store(t2_3) ///
title("Criteria `crit' Utilization Outcomes, by 1 year Mortality") ///
ctitles("","Died 1 year","Alive 1 year","p-value") ///
note("Utilization for 6 months after interview" \ ///
"Sample limited to survey respondents first interview that meet Criteria A:" \ ///
"at least one serious medical illness and/or ADL impairment" \ ///
"Medicare spending in 2012$, wage index adjusted.")

//now columns using propensity score matched sample
mat t2=J(1,6,.)
foreach v in `ivars' { //indicator variables
local c=1
	foreach i in 1 0{
		sum `v' if core_to_dod_1yr_n0==`i' [iweight=ps_weight]
		mat t2[1,`c']=r(mean)*r(N) //n
		mat t2[1,`c'+1]=r(mean)*100 //percent
		local c = `c'+2
	}
	logit core_to_dod_1yr_n0 `v' [iweight=ps_weight] //p-values
	test `v'
	mat t2[1,5]=r(p)
	
	mat rownames t2=`v'
	frmttable, statmat(t2) varlabels sdec(0,0,3\2,2,2) substat(1) store(t2m_1)
	
	outreg, replay(t2m_2) append(t2m_1) store(t2m_2)
}

foreach v in `cvars' { //continuous variables
local c=1
	foreach i in 1 0{
		sum `v' if core_to_dod_1yr_n0==`i' [iweight=ps_weight]
		mat t2[1,`c']=r(mean) //mean
		mat t2[1,`c'+1]=r(sd) //sd
		local c = `c'+2
	}
	logit core_to_dod_1yr_n0 `v' [iweight=ps_weight] //p-values
	test `v'
	mat t2[1,5]=r(p)
	
	mat rownames t2=`v'
	frmttable, statmat(t2) varlabels sdec(0,0,3\0,0,0) substat(1) store(t2m_1)
	
	outreg, replay(t2m_2) append(t2m_1) store(t2m_2)
}

//last row, n for each group
mat t2_n=J(1,2,.)
tab core_to_dod_1yr_n0 if ps_weight~=., matcell(t2n)
mat t2_n[1,1]=t2n[2,1]
mat t2_n[1,2]=t2n[1,1]
mat rownames t2_n="N"
frmttable, statmat(t2_n) store(t2_n) sdec(0)

outreg, replay(t2m_2) append(t2_n) store(t2m_3) 

outreg using `logpath'/21_ps_matched_outcomes_`crit', replace replay(t2_3) merge(t2m_3) ///
title("Criteria `crit' Utilization Outcomes, by 1 year Mortality" \ ///
"Comparing unmatched and matched samples") ///
ctitles("","Raw sample","","","Matched sample","","" \  ///
"","Died 1 year","Alive 1 year","p-value","Died 1 year","Alive 1 year","p-value") ///
note("Utilization for 6 months after interview" \ ///
"Sample limited to survey respondents first interview that meet Criteria `crit':" \ ///
`cdesc' \ ///
"Matched sample is propensity score matched for risk of mortality at 1 year" \ ///
"Medicare spending in 2012$, wage index adjusted." \ ///
"P-values for continuous variables from t-test, for binary variables from chi-squared statistic")
***************************************************************
//multivariate analysis, ps-matched sample using glm model
//2 versions, (1) excluding mortality on RHS, (2) including mortality
gen relig_vimp_n0=1 if imprelig_n0==1
replace relig_vimp_n0=0 if inlist(imprelig_n0,2,3,4)
tab relig_vimp_n0 imprelig_n0, missing

sum networth_adj2012_n0, detail
replace networth_adj2012_n0=networth_adj2012_n0/10000

/*Note--we are not clustering at eol spending quintile
//want to cluster at eol spending quintiles
sum tot_eol_spending_hrr_n0 , detail
sca sp_20=r(p20)
sca sp_40=r(p40)
sca sp_60=r(p60)
sca sp_80=r(p80)
xtile eol_spend_hrr_quint = tot_eol_spending_hrr_n0 , nquantiles(5)
la var eol_spend_hrr_quint "EOL Spending at HRR Quintiles 1=low, 5=high"
tab eol_spend_hrr_quint, missing
bys eol_spend_hrr_quint : sum tot_eol_spending_hrr_n0
*/
local matchvars age_at_core_n0 female re_white married_n0 networth_adj2012_n0 ///
hs_deg adl_stable_partial_n0n1 adl_stable_severe_n0n1 adl_change_i_m_n0n1 ///
 adl_change_i_s_n0n1 adl_change_m_s_n0n1 ///
 smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 ///
smi_liver_ind_n0  smi_hip_ind_n0 srh_pf_n0 

local addvars nhres_n0 rel_nb_n0 relig_vimp_n0 medicaid_n0 champus_n0 ///
medigap_n0 hospital_care_intensity_n0 hospital_beds_n0 specialists_n0

la var networth_adj2012_n0 "Net worth /$10,000"
la var smi_dem_ind_n0 "Dementia"
la var smi_cancer_ind_n0 "Metastatic Cancer"
la var smi_esrd_ind_n0 "End stage renal disease" 
la var smi_chf_ind_n0 "CHF with hospitalization" 
la var smi_copd_ind_n0 "COPD" 
la var smi_diab_compl_ind_n0 "Diabetes with complications"
la var smi_liver_ind_n0 "Advanced liver disease"
la var smi_hip_ind_n0 "Hip fracture"
la var relig_vimp_n0 "Religion very important"
la var hospital_care_intensity_n0 "Hospital care intensity index, HRR"
la var hospital_beds_n0 "Hospital beds/1000 residents, HRR"
la var specialists_n0 "Specialists /100,000 residents, HRR"

la var adl_stable_partial_n0n1 "ADL Stable, Partial Impairment"
la var adl_stable_severe_n0n1 "ADL Stable, Severe Impairment"
la var adl_change_i_m_n0n1 "ADL Independ to Partial Impair"
la var adl_change_i_s_n0n1 "ADL Independ to Severe Impair"
la var adl_change_m_s_n0n1 "ADL Partial to Severe Impair"

la var core_to_dod_1yr_n0 "Died within 1 year of interview"

***************************************************************
//glm outcome=spending, excluding mortality
glm tot_paid_by_mc_6m_wi_n0 `matchvars' `addvars' [iweight=ps_weight], ///
	fam(gamma) link(log) vce(robust)
	
glm, eform

outreg , stats(e_b e_ci) store(tab3) varlabels ///
title("Criteria `crit' 6 month utilization, GLM regression" \ ///
"using sample propensity score matched on 1 year mortality" \ ///
"Excluding mortality from RHS") ///
ctitle("","Total Medicare spending") ///
note("6 month Medicare spending for those R's that meet Criteria `crit'" \ ///
"Generalized linear model. For Medicare Costs: gamma distribution and log link" \ ///
"For hospital nights: Poisson distribution, log link" \ ///
"Exponentiated coefficients (rate ratios) and 95% confidence intervals reported." \ ///
"Robust standard errors")

//glm outcome=hospital nights
glm n_hospd_p6m_n0 `matchvars' `addvars' [iweight=ps_weight], ///
	fam(poisson) link(log)  vce(robust)
outreg using `logpath'/21_ps_matched_outcomes_`crit', addtable varlabels ///
stats(e_b e_ci) merge(tab3) ///
ctitle("","Hospital nights")

***************************************************************
//glm outcome=spending, including mortality
glm tot_paid_by_mc_6m_wi_n0 `matchvars' `addvars' core_to_dod_1yr_n0 [iweight=ps_weight], ///
	fam(gamma) link(log) vce(robust)
	
glm, eform

outreg , stats(e_b e_ci) store(tab3) varlabels ///
title("Criteria `crit' 6 month utilization, GLM regression" \ ///
"using sample propensity score matched on 1 year mortality" \ ///
"Including mortality on RHS") ///
ctitle("","Total Medicare spending") ///
note("6 month Medicare spending for those R's that meet Criteria `crit'" \ ///
"Generalized linear model. For Medicare Costs: gamma distribution and log link" \ ///
"For hospital nights: Poisson distribution, log link" \ ///
"Exponentiated coefficients (rate ratios) and 95% confidence intervals reported." \ ///
"Robust standard errors")

//glm outcome=hospital nights
glm n_hospd_p6m_n0 `matchvars' `addvars' core_to_dod_1yr_n0 [iweight=ps_weight], ///
	fam(poisson) link(log)  vce(robust)
outreg using `logpath'/21_ps_matched_outcomes_`crit', addtable varlabels ///
stats(e_b e_ci) merge(tab3) ///
ctitle("","Hospital nights")

***************************************************************

log close


H="Cross-tabs for variables from Lee paper"
/*cross-tabs for variables for ps match
group that meets criteria A or medical illness only
use comments to switch between criteria
*/

capture log close

clear all
set more off

local crit a
//local crit smi
local logpath E:\data\serious_ill\logs
local datapath E:\data\serious_ill\final_data

log using "`logpath'\22_xtabs_mortality_crit_`crit'.txt", text replace

cd `datapath'

use n0_n1_p1_p2_x_criteria_`crit'_v1.dta if core_year_n0<2012
******************************************************************
//Elix vs self report for chronic conditions

//either of the 2 diabetes elixhauser indicators
gen el_diab_10_11_n0=1 if comorb_10_0_1yr_n0==1 | comorb_11_0_1yr_n0==1
replace el_diab_10_11_n0=0 if comorb_10_0_1yr_n0==0 & comorb_11_0_1yr_n0==0

***Diabetes
//compare elixhauser vs self report
tab el_diab_10_11_n0 dm_hrs_n0, missing

//more strict serious medical illness diabetes vs self report
tab smi_diab_compl_ind_n0 dm_hrs_n0, missing

***Cancer
//cancer elixhauser vs self report
tab el_cancer_1yr_n0 cancer_hrs_n0, missing

//more strict serious medical illness cancer vs self report
tab smi_cancer_ind_n0  cancer_hrs_n0, missing

***Lung disease
//elixhauser COPD vs self report lung disease
tab comorb_9_0_1yr_n0 lung_hrs_n0, missing

//serious medical condition vs self report
tab smi_copd_ind_n0 lung_hrs_n0, missing

***CHF
//elixhauser CHF vs self report
tab comorb_1_0_1yr_n0 chf_hrs_n0, missing

//serious medical condition vs self report
tab smi_chf_ind_n0 chf_hrs_n0, missing

******************************************************************
//Charlson vs Elixhauser for chronic conditions

tab charls_1_0_1yr_n0 , missing //is there an elixhauser equivalent??
tab charls_2_0_1yr_n0 comorb_1_0_1yr_n0, missing 
tab charls_3_0_1yr_n0 comorb_5_0_1yr_n0, missing 
tab charls_4_0_1yr_n0 , missing //is there an elixhauser equivalent??
tab charls_5_0_1yr_n0 comorb_31_0_1yr_n0, missing 
tab charls_6_0_1yr_n0 comorb_9_0_1yr_n0 , missing
tab charls_7_0_1yr_n0 comorb_20_0_1yr_n0 , missing
tab charls_8_0_1yr_n0 comorb_15_0_1yr_n0 , missing
tab charls_9_0_1yr_n0 , missing //is there an elixhauser equivalent??
tab charls_10_0_1yr_n0 comorb_10_0_1yr_n0, missing
tab charls_11_0_1yr_n0 comorb_11_0_1yr_n0 , missing
tab charls_12_0_1yr_n0 comorb_7_0_1yr_n0 , missing
tab charls_13_0_1yr_n0 comorb_34_0_1yr_n0 , missing
tab charls_14_0_1yr_n0 comorb_19_0_1yr_n0 , missing
tab charls_15_0_1yr_n0 comorb_14_0_1yr_n0  , missing
tab charls_16_0_1yr_n0 comorb_18_0_1yr_n0 , missing
tab charls_17_0_1yr_n0 comorb_16_0_1yr_n0 , missing

******************************************************************
//Functional status from Lee paper, crosstab with adl impairment n0

tab adl_diff_bh_n0 adl_impair_core_n0, missing
tab iadl_diff_m_n0 adl_impair_core_n0, missing
tab fl_diff_wk_many_n0 adl_impair_core_n0, missing
tab fl_diff_push_n0 adl_impair_core_n0, missing

******************************************************************
//currently smokes

tab smoke_curr_n0, missing

//age 5 yr categories
tab age_cat2_n0, missing

//bmi
tab bmi_lt25_n0, missing
******************************************************************
log close


H="xxxxPropensity score match using Lee variables"
//We are not matching on propensity score--this has been replaced by that below.//
/*propensity score match on mortality
group that meets criteria A or medical illness only
use comments to switch between criteria
*/

capture log close

clear all
set more off

//local crit a
local crit smi
local logpath E:\data\serious_ill\logs
local datapath E:\data\serious_ill\final_data

log using "`logpath'\23_ps_match_mortality_crit_`crit'_lee_vars.txt", text replace

cd `datapath'

use n0_n1_p1_p2_x_criteria_`crit'_v1.dta if core_year_n0<2012
******************************************************************

******************************************************************
di "Criteria `crit' dataset"
******************************************************************
tab core_to_dod_1yr_n0, missing //mortality at 1 year
tab core_to_dod_1yr_p1, missing //at p1 interview

tab age_cat2_n0, gen(age_n0_ind)

//define matching variable list based on Lee prognostic index, drop if missing in any variables
global matchvars age_n0_ind2 age_n0_ind3 age_n0_ind4 age_n0_ind5 female ///
dm_hrs_n0 cancer_hrs_n0 lung_hrs_n0 chf_hrs_n0 bmi_lt25_n0 smoke_curr_n0  ///
adl_diff_bh_n0 iadl_diff_m_n0 fl_diff_wk_many_n0 fl_diff_push_n0 

//n=5297 meet criteria A
//n=4338 meet Condition only criteria
foreach v in $matchvars{
sum `v', detail
bys core_to_dod_1yr_n0: sum `v'
drop if `v'==.
}

//n=5099 after drop missingness - Criteria A
//n=4183 after drop missingness - Condition Only criteria
tab core_to_dod_1yr_n0, missing //mortality at 1 year

******************************************************************
//sort data, generate propensity score
set seed 2000
gen x=uniform()
sort x

//generate pscore variable hs_pscore
pscore core_to_dod_1yr_n0 $matchvars, pscore(m1y_pscore) blockid(m1y_block) logit detail

psgraph, treated(core_to_dod_1yr_n0) pscore(m1y_pscore)

gen logitpscore=ln(m1y_pscore/(1-m1y_pscore))
sum logitpscore

sca cal_ps=r(sd)*0.02
sca list cal_ps

//rule of thumb 0.2*sd, we can use 0.02*sd, manually change this depending on which dataset used
//psmatch2 core_to_dod_1yr_n0,outcome(tot_paid_by_mc_6m_wi_n0) ///
//	pscore(m1y_pscore) radius caliper(.01993145) logit //criteria A caliper
psmatch2 core_to_dod_1yr_n0,outcome(tot_paid_by_mc_6m_wi_n0) ///
	pscore(m1y_pscore) radius caliper(.02074116) logit //criteria condition only caliper

//graph including off common support information
psgraph, treated(core_to_dod_1yr_n0) pscore(m1y_pscore)
graph save `logpath'\ps_dist_crit_`crit'.gph, replace

histogram m1y_pscore if _support==1, by(core_to_dod_1yr_n0) 

//look at balance of matched vs unmatched samples using %bias (std diff)
pstest $matchvars ,treated(core_to_dod_1yr_n0) both hist

mat vr=J(15,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $matchvars  {
sum `v' if core_to_dod_1yr_n0==1 //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if core_to_dod_1yr_n0==0 //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if core_to_dod_1yr_n0==1 & _support==1 //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if core_to_dod_1yr_n0==0 [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}

mat rownames vr=$matchvars

mat list vr

******************************************************************
//using this matching, 
//criteria a group - 1 off support, 1 not matched (weight=.)
//smi group - 1 off support, 0 not matched
//_support ==1 if matched
tab _support, missing
tab _support if core_to_dod_1yr_n0==1, missing
tab _support if core_to_dod_1yr_n0==0, missing
tab _weight if core_to_dod_1yr_n0==1, missing
sum _weight if core_to_dod_1yr_n0==0

//thinking about how those that died will have truncated 1 year lookback for outcomes...
sum core_to_death_n0 if core_to_dod_1yr_n0==1, detail
histogram core_to_death_n0 if core_to_dod_1yr_n0==1

gen core_to_dod_1_2yr_n0=1 if core_to_death_n0<2 & core_to_death_n0>=1
tab core_to_dod_1_2yr_n0, missing
******************************************************************
//save the dataset
rename _weight ps_weight
rename _support ps_common_support

save n0_n1_p1_p2_x_criteria_`crit'_v1_psmatch_lee.dta, replace


******************************************************************
log close


H="xxxxUnivariate and glm for Lee matched sample"
//This is not being used.  Weighting, not matching on propensity.
/*using propensity score matched sample on mortality
from previous section, look at outcomes for
group that meets criteria a and condition only, use comments to set dataset
*/

capture log close

clear all
set more off

local crit a
local cdesc "Serious medical illness and/or ADL impairment"
//local crit smi
//local cdesc "Serious medical condition only"
local logpath E:\data\serious_ill\logs
local datapath E:\data\serious_ill\final_data

log using "`logpath'\24_ps_matched_outcomes1_crit_`crit'_lee_vars.txt", text replace

cd `datapath'

use n0_n1_p1_p2_x_criteria_`crit'_v1_psmatch_lee.dta
***************************************************************
//look at those that died 1st 6 months, their utilization is truncated
tab core_to_dod_6m_n0 core_to_dod_1yr_n0, missing

sum core_to_death_n0 if core_to_dod_6m_n0==1
local n6m=r(N)
histogram core_to_death_n0 if core_to_dod_6m_n0==1, frequency ///
	note("n=`n6m' died within 6 m of n0 core interview")
graph save `logpath'\hist_6m_`crit', replace

sum core_to_death_n0 if core_to_dod_1yr_n0==1
local n12m=r(N)
histogram core_to_death_n0 if core_to_dod_1yr_n0==1, frequency ///
	note("n=`n12m' died within 1 yr of n0 core interview")
graph save `logpath'\hist_1yr_`crit', replace

//histogram of hospital nights outcome
sum n_hospd_p6m_n0, detail
local n12m=r(N)
histogram n_hospd_p6m_n0, frequency ///
	note("n=`n12m' meet criteria `crit'")
graph save `logpath'\hist_6m_hospnights_`crit', replace

***************************************************************
//table 1 compare pre-post matched samples
//on covariates used in matching

***************************************************************
//table 2 look at 6m outcomes pre-post matched samples
//show pvalues since looking at outcomes??

la var core_to_dod_1yr_n0 "Died, n (%)"
la var hs_admit_p6m_n0 "Enrolled in hospice, n (%)"
la var ind_em_ur_adm_p6m_n0 "Hospital admission, n (%)"
la var n_hospd_p6m_n0 "Hospital nights, mean (sd)"

la var ip_paid_by_mc_6m_wi_n0 "Inpatient"
la var snf_paid_by_mc_6m_wi_n0 "SNF"
la var hh_paid_by_mc_6m_wi_n0 "Home health" 
la var hs_paid_by_mc_6m_wi_n0 "Hospice" 
la var pb_paid_by_mc_6m_wi_n0 "Carrier"
la var op_paid_by_mc_6m_wi_n0 "Outpatient" 
la var dm_paid_by_mc_6m_wi_n0 "DME"
la var tot_paid_by_mc_6m_wi_n0 "Total Medicare payments"

local ivars ind_em_ur_adm_p6m_n0

local cvars n_hospd_p6m_n0 tot_paid_by_mc_6m_wi_n0 ip_paid_by_mc_6m_wi_n0 ///
snf_paid_by_mc_6m_wi_n0 hh_paid_by_mc_6m_wi_n0 hs_paid_by_mc_6m_wi_n0 ///
pb_paid_by_mc_6m_wi_n0 op_paid_by_mc_6m_wi_n0 dm_paid_by_mc_6m_wi_n0

//columns 1,2, before matching, 6m outcomes those that died vs didn't
mat t2=J(1,6,.)
foreach v in `ivars' { //indicator variables
local c=1
	foreach i in 1 0{
		sum `v' if core_to_dod_1yr_n0==`i'
		mat t2[1,`c']=r(mean)*r(N) //n
		mat t2[1,`c'+1]=r(mean)*100 //percent
		local c = `c'+2
	}
	tab `v' core_to_dod_1yr_n0, chi2 //p-values
	mat t2[1,5]=r(p)
	
	mat rownames t2=`v'
	frmttable, statmat(t2) varlabels sdec(0,0,3\2,2,2) substat(1) store(t2_1)
	
	outreg, replay(t2_2) append(t2_1) store(t2_2)
}

foreach v in `cvars' { //continuous variables
local c=1
	foreach i in 1 0{
		sum `v' if core_to_dod_1yr_n0==`i'
		mat t2[1,`c']=r(mean) //mean
		mat t2[1,`c'+1]=r(sd) //sd
		local c = `c'+2
	}
	ttest `v', by(core_to_dod_1yr_n0) //p-values
	mat t2[1,5]=r(p)
	
	mat rownames t2=`v'
	frmttable, statmat(t2) varlabels sdec(0,0,3\0,0,0) substat(1) store(t2_1)
	
	outreg, replay(t2_2) append(t2_1) store(t2_2)
}

//last row, n for each group
mat t2_n=J(1,2,.)
tab core_to_dod_1yr_n0, matcell(t2n)
mat t2_n[1,1]=t2n[2,1]
mat t2_n[1,2]=t2n[1,1]
mat rownames t2_n="N"
frmttable, statmat(t2_n) store(t2_n) sdec(0)

outreg, replay(t2_2) append(t2_n) store(t2_3) ///
title("Criteria `crit' Utilization Outcomes, by 1 year Mortality") ///
ctitles("","Died 1 year","Alive 1 year","p-value") ///
note("Utilization for 6 months after interview" \ ///
"Sample limited to survey respondents first interview that meet Criteria A:" \ ///
"at least one serious medical illness and/or ADL impairment" \ ///
"Medicare spending in 2010$, wage index adjusted.")

//now columns using propensity score matched sample
mat t2=J(1,6,.)
foreach v in `ivars' { //indicator variables
local c=1
	foreach i in 1 0{
		sum `v' if core_to_dod_1yr_n0==`i' [iweight=ps_weight]
		mat t2[1,`c']=r(mean)*r(N) //n
		mat t2[1,`c'+1]=r(mean)*100 //percent
		local c = `c'+2
	}
	logit core_to_dod_1yr_n0 `v' [iweight=ps_weight] //p-values
	test `v'
	mat t2[1,5]=r(p)
	
	mat rownames t2=`v'
	frmttable, statmat(t2) varlabels sdec(0,0,3\2,2,2) substat(1) store(t2m_1)
	
	outreg, replay(t2m_2) append(t2m_1) store(t2m_2)
}

foreach v in `cvars' { //continuous variables
local c=1
	foreach i in 1 0{
		sum `v' if core_to_dod_1yr_n0==`i' [iweight=ps_weight]
		mat t2[1,`c']=r(mean) //mean
		mat t2[1,`c'+1]=r(sd) //sd
		local c = `c'+2
	}
	logit core_to_dod_1yr_n0 `v' [iweight=ps_weight] //p-values
	test `v'
	mat t2[1,5]=r(p)
	
	mat rownames t2=`v'
	frmttable, statmat(t2) varlabels sdec(0,0,3\0,0,0) substat(1) store(t2m_1)
	
	outreg, replay(t2m_2) append(t2m_1) store(t2m_2)
}

//last row, n for each group
mat t2_n=J(1,2,.)
tab core_to_dod_1yr_n0 if ps_weight~=., matcell(t2n)
mat t2_n[1,1]=t2n[2,1]
mat t2_n[1,2]=t2n[1,1]
mat rownames t2_n="N"
frmttable, statmat(t2_n) store(t2_n) sdec(0)

outreg, replay(t2m_2) append(t2_n) store(t2m_3) 

outreg using `logpath'/24_ps_matched_outcomes_`crit'_lee, replace replay(t2_3) merge(t2m_3) ///
title("Lee matching: Criteria `crit' Utilization Outcomes, by 1 year Mortality" \ ///
"Comparing unmatched and matched samples") ///
ctitles("","Raw sample","","","Matched sample","","" \  ///
"","Died 1 year","Alive 1 year","p-value","Died 1 year","Alive 1 year","p-value") ///
note("Utilization for 6 months after interview" \ ///
"Sample limited to survey respondents first interview that meet Criteria `crit':" \ ///
`cdesc' \ ///
"Matched sample is propensity score matched for risk of mortality at 1 year" \ ///
"Medicare spending in 2012$, wage index adjusted." \ ///
"P-values for continuous variables from t-test, for binary variables from chi-squared statistic")
***************************************************************
//multivariate analysis, ps-matched sample using glm model
//2 versions, (1) excluding mortality on RHS, (2) including mortality
gen relig_vimp_n0=1 if imprelig_n0==1
replace relig_vimp_n0=0 if inlist(imprelig_n0,2,3,4)
tab relig_vimp_n0 imprelig_n0, missing

//live alone?
tab hhm_n0,missing
generate livealone_n0=.
replace livealone_n0=1 if hhm_n0==0 & resspouse_n0==0
replace livealone_n0=0 if hhm_n0>0 | nhres_n0==1 | resspouse_n0==1
label variable livealone_n0 "Live Alone in Community n0"
//label define livealone 0 "No" 1 "Yes", modify
//label values livealone livealone
tab livealone_n0 core_year_n0, missing
tab hhm_n0 livealone_n0
tab livealone_n0 resspouse_n0

//age, 10 year groups
tab age_cat_n0, gen(age)
la var age1 "Age 65-74"
la var age2 "Age 75-84"
la var age3 "Age 85+"

//comorbidities using claims dx, data warehouse chronic conditions
local cc cc_ami_isch_1yr_n0 cc_8_chf_1yr_n0 cc_4_atrialfb_1yr_n0 ///
 cc_3_alzhdmta_1yr_n0 cc_9_diabetes_1yr_n0 cc_6_chrnkidn_1yr_n0 ///
 cc_7_copd_1yr_n0 cc_13_depressn_1yr_n0 cc_cncr_chronic_1yr_n0 ///
 cc_15_ra_oa_1yr_n0 cc_16_strketia_1yr_n0
foreach v in `cc' {
tab `v', missing
}
la var cc_ami_isch_1yr_n0 "Ischemic heart disease or myocardial infarction"
la var cc_8_chf_1yr_n0 "Congestive heart failure" 
la var cc_4_atrialfb_1yr_n0 "Atrial fibrillation"
la var cc_3_alzhdmta_1yr_n0 "Alzheimer disease or dementia"
la var cc_9_diabetes_1yr_n0 "Diabetes" 
la var cc_6_chrnkidn_1yr_n0 "Chronic kidney disease"
la var cc_7_copd_1yr_n0 "Chronic obstructive pulmonary disease"
la var cc_13_depressn_1yr_n0 "Depression" 
la var cc_cncr_chronic_1yr_n0 "Cancer"
la var cc_15_ra_oa_1yr_n0 "Arthritis"
la var cc_16_strketia_1yr_n0 "Stroke or transient ischemic attack"

//adl change categories, replace Lee functional variables
tab adl_stable_ind_n0n1 adl_improved_n0n1 , missing //base case = independent,stable or improved
tab adl_stable_partial_n0n1, missing
tab adl_stable_severe_n0n1, missing
tab adl_change_i_m_n0n1, missing 
tab adl_change_i_s_n0n1, missing 
tab adl_change_m_s_n0n1, missing 
foreach v in adl_change_i_m_n0n1 adl_change_i_s_n0n1 adl_change_m_s_n0n1 {
replace `v'=0 if adl_stable_ind_n0n1==1 | adl_stable_partial_n0n1==1 | adl_stable_severe_n0n1==1
tab `v',missing
} 

//want to cluster at eol spending quintiles
sum tot_eol_spending_hrr_n0 , detail
sca sp_20=r(p20)
sca sp_40=r(p40)
sca sp_60=r(p60)
sca sp_80=r(p80)
xtile eol_spend_hrr_quint = tot_eol_spending_hrr_n0 , nquantiles(5)
la var eol_spend_hrr_quint "EOL Spending at HRR Quintiles 1=low, 5=high"
tab eol_spend_hrr_quint, missing
bys eol_spend_hrr_quint : sum tot_eol_spending_hrr_n0

loneway tot_paid_by_mc_6m_wi_n0 eol_spend_hrr_quint 
loneway n_hospd_p6m_n0 eol_spend_hrr_quint 
loneway ind_hosp_adm_p6m_n0 eol_spend_hrr_quint 

local xvars age2 age3 female re_black re_hisp re_other_unk hs_deg_ind married_n0 ///
 nw_lowest_n0 nhres_n0 livealone_n0 rel_nb_n0 ///
 relig_vimp_n0  adl_stable_partial_n0n1 adl_stable_severe_n0n1 adl_change_i_m_n0n1 ///
 adl_change_i_s_n0n1 adl_change_m_s_n0n1 medicaid_n0 champus_n0 ///
 medigap_n0  srh_pf_n0  bmi_lt25_n0 smoke_curr_n0 `cc' ///
 hospital_care_intensity_n0 hospital_beds_n0 specialists_n0

la var female "Female"
la var relig_vimp_n0 "Religion very important"
la var hospital_care_intensity_n0 "Hospital care intensity index, HRR"
la var hospital_beds_n0 "Hospital beds/1000 residents, HRR"
la var specialists_n0 "Specialists /100,000 residents, HRR"

la var core_to_dod_1yr_n0 "Died within 1 year of interview"

***************************************************************
//glm outcome=spending, excluding mortality
glm tot_paid_by_mc_6m_wi_n0 `xvars' [iweight=ps_weight], ///
	fam(gamma) link(log) vce(cluster eol_spend_hrr_quint)
	
glm, eform

outreg , stats(e_b e_ci) store(tab3) varlabels ///
title("Lee matching: Criteria `crit' 6 month utilization, GLM regression" \ ///
"using sample propensity score matched on 1 year mortality" \ ///
"Excluding mortality from RHS") ///
ctitle("","Total Medicare spending") ///
note("6 month Medicare spending for those R's that meet Criteria `crit'" \ ///
"Generalized linear model. For Medicare Costs: gamma distribution and log link" \ ///
"For hospital nights: Poisson distribution, log link" \ ///
"For any hospitalization: Logit regression" \ ///
"Exponentiated coefficients (rate ratios) and 95% confidence intervals reported." \ ///
"Robust standard errors are clustered by 2yr EOL MC Spending Quintiles." \ ///
"Chronic conditions from claims diagnoses 1yr preceeding interview.")

//glm outcome=hospital nights
glm n_hospd_p6m_n0 `xvars' [iweight=ps_weight], ///
	fam(poisson) link(log)  vce(cluster eol_spend_hrr_quint)
outreg , varlabels ///
stats(e_b e_ci) merge(tab3) store(tab3_1) ///
ctitle("","Hospital nights")

//logit on any hospitalizations
logit ind_hosp_adm_p6m_n0 `xvars' [iweight=ps_weight], ///
	vce(cluster eol_spend_hrr_quint)
outreg using `logpath'/24_ps_matched_outcomes_`crit'_lee, addtable varlabels ///
stats(e_b e_ci) merge(tab3_1) ///
ctitle("","Any Hospitalization (binary)")


***************************************************************
//glm outcome=spending, including mortality
glm tot_paid_by_mc_6m_wi_n0 `xvars' core_to_dod_1yr_n0 [iweight=ps_weight], ///
	fam(gamma) link(log) vce(cluster eol_spend_hrr_quint)
	
glm, eform

outreg , stats(e_b e_ci) store(tab3) varlabels ///
title("Lee Matching: Criteria `crit' 6 month utilization, GLM regression" \ ///
"using sample propensity score matched on 1 year mortality" \ ///
"Including mortality on RHS") ///
ctitle("","Total Medicare spending") ///
note("6 month Medicare spending for those R's that meet Criteria `crit'" \ ///
"Generalized linear model. For Medicare Costs: gamma distribution and log link" \ ///
"For hospital nights: Poisson distribution, log link" \ ///
"For any hospitalization: Logit regression" \ ///
"Exponentiated coefficients (rate ratios) and 95% confidence intervals reported." \ ///
"Robust standard errors are clustered by 2yr EOL MC Spending Quintiles." \ ///
"Chronic conditions from claims diagnoses 1yr preceeding interview.")

//glm outcome=hospital nights
glm n_hospd_p6m_n0 `xvars' core_to_dod_1yr_n0 [iweight=ps_weight], ///
	fam(poisson) link(log)  vce(cluster eol_spend_hrr_quint)
outreg , varlabels ///
stats(e_b e_ci) merge(tab3) store(tab3_1) ///
ctitle("","Hospital nights")

//logit on any hospitalizations
logit ind_hosp_adm_p6m_n0 `xvars' core_to_dod_1yr_n0 [iweight=ps_weight], ///
	vce(cluster eol_spend_hrr_quint)
outreg using `logpath'/24_ps_matched_outcomes_`crit'_lee, addtable varlabels ///
stats(e_b e_ci) merge(tab3_1) ///
ctitle("","Any Hospitalization (binary)")

***************************************************************

log close


H="xxxxCheck of Lee prognostic index model"
/*propensity score match on mortality
group that meets criteria A or medical illness only
use comments to switch between criteria
*/

capture log close

clear all
set more off

local crit a
//local crit smi
local logpath E:\data\serious_ill\logs
local datapath E:\data\serious_ill\final_data

log using "`logpath'\25_check_lee_index_`crit'.txt", text replace

cd `datapath'

******************************************************************
******************************************************************
di "Criteria `crit' dataset"
******************************************************************
use n0_n1_p1_p2_x_criteria_`crit'_v1_psmatch_lee.dta

//4 year mortality for a more direct comparison to the Lee paper

gen core_to_dod_4yr_n0=1 if core_to_death_n0<=4 & dod_ind==1
replace core_to_dod_4yr_n0=0 if core_to_death_n0>4  & dod_ind==1
replace core_to_dod_4yr_n0=0 if dod_ind==0
tab core_to_dod_4yr_n0 core_to_dod_1yr_n0, missing
la var core_to_dod_4yr_n0 "Died within 4 yrs of core interview"

//lee index of mortality
gen leeindex_n0=1
replace leeindex_n0=leeindex_n0+3 if age_n0_ind2==1
replace leeindex_n0=leeindex_n0+4 if  age_n0_ind3==1	
replace leeindex_n0=leeindex_n0+5 if age_n0_ind4 ==1
replace leeindex_n0=leeindex_n0+7 if age_n0_ind5 ==1
replace leeindex_n0=leeindex_n0+2 if female ==0
replace leeindex_n0=leeindex_n0+1 if dm_hrs_n0==1
replace leeindex_n0=leeindex_n0+2 if cancer_hrs_n0==1
replace leeindex_n0=leeindex_n0+2 if lung_hrs_n0== 1
replace leeindex_n0=leeindex_n0+2 if chf_hrs_n0 ==1
replace leeindex_n0=leeindex_n0+2 if smoke_curr_n0==1
replace leeindex_n0=leeindex_n0+1 if bmi_lt25_n0==1
replace leeindex_n0=leeindex_n0+2 if adl_diff_bh_n0==1
replace leeindex_n0=leeindex_n0+2 if iadl_diff_m_n0==1
replace leeindex_n0=leeindex_n0+1 if fl_diff_push_n0==1
replace leeindex_n0=leeindex_n0+2 if fl_diff_wk_many_n0==1

//define matching variable list based on Lee prognostic index, drop if missing in any variables
global matchvars age_n0_ind2 age_n0_ind3 age_n0_ind4 age_n0_ind5 female ///
dm_hrs_n0 cancer_hrs_n0 lung_hrs_n0 chf_hrs_n0 bmi_lt25_n0 smoke_curr_n0  ///
adl_diff_bh_n0 iadl_diff_m_n0 fl_diff_wk_many_n0 fl_diff_push_n0 

logit core_to_dod_4yr_n0 $matchvars , or

lroc 

clear all

/*now do for 2010 sample as comparison, not limited to those that are seriously ill
**************************************************************
Update this to a group that you can get a full 4 year follow up
**************************************************************
*/
log close

local crit 2010
log using "`logpath'\25_check_lee_index_`crit'.txt", text replace

cd `datapath'

use n0_n1_p1_p2_x_criteria_`crit'_v1.dta if core_year_n0<2012

tab age_cat2_n0, gen(age_n0_ind)

foreach v in $matchvars {
drop if `v'==.
}

//lee index of mortality
gen leeindex_n0=1
replace leeindex_n0=leeindex_n0+3 if age_n0_ind2==1
replace leeindex_n0=leeindex_n0+4 if  age_n0_ind3==1	
replace leeindex_n0=leeindex_n0+5 if age_n0_ind4 ==1
replace leeindex_n0=leeindex_n0+7 if age_n0_ind5 ==1
replace leeindex_n0=leeindex_n0+2 if female ==0
replace leeindex_n0=leeindex_n0+1 if dm_hrs_n0==1
replace leeindex_n0=leeindex_n0+2 if cancer_hrs_n0==1
replace leeindex_n0=leeindex_n0+2 if lung_hrs_n0== 1
replace leeindex_n0=leeindex_n0+2 if chf_hrs_n0 ==1
replace leeindex_n0=leeindex_n0+2 if smoke_curr_n0==1
replace leeindex_n0=leeindex_n0+1 if bmi_lt25_n0==1
replace leeindex_n0=leeindex_n0+2 if adl_diff_bh_n0==1
replace leeindex_n0=leeindex_n0+2 if iadl_diff_m_n0==1
replace leeindex_n0=leeindex_n0+1 if fl_diff_push_n0==1
replace leeindex_n0=leeindex_n0+2 if fl_diff_wk_many_n0==1
gen core_to_dod_4yr_n0=1 if core_to_death_n0<=4 & dod_ind==1
replace core_to_dod_4yr_n0=0 if core_to_death_n0>4  & dod_ind==1
replace core_to_dod_4yr_n0=0 if dod_ind==0


tab core_to_dod_4yr_n0 core_to_dod_1yr_n0, missing
la var core_to_dod_4yr_n0 "Died within 4 yrs of core interview"

logit core_to_dod_4yr_n0 $matchvars , or

lroc 

******************************************************************
log close


H="Weighting by propensity score"
/*Generating Inverse Propensity Score Weights for sample to address truncated data
because of mortality
*/
foreach crit in  "2010" "a" "c"{
capture log close

clear all
set more off


local logpath E:\data\serious_ill\logs
local datapath E:\data\serious_ill\final_data

log using "`logpath'\23_inv_pweight_mortality_crit_`crit'_lee_vars.txt", text replace

cd `datapath'

use n0_n1_p1_p2_x_criteria_`crit'_v1.dta if core_year_n0<2012
******************************************************************

******************************************************************
di "Criteria `crit' dataset"
******************************************************************
tab core_to_dod_1yr_n0, missing //mortality at 1 year
tab core_to_dod_1yr_p1, missing //at p1 interview

tab age_cat2_n0, gen(age_n0_ind)

//define pscore variable list based on Lee prognostic index, drop if missing in any variables
global weightvars age_n0_ind2 age_n0_ind3 age_n0_ind4 age_n0_ind5 female ///
dm_hrs_n0 cancer_hrs_n0 lung_hrs_n0 chf_hrs_n0 bmi_lt25_n0 smoke_curr_n0  ///
adl_diff_bh_n0 iadl_diff_m_n0 fl_diff_wk_many_n0 fl_diff_push_n0 

//n=5297 meet criteria A
//n=4338 meet Condition only criteria
foreach v in $weightvars{
sum `v', detail
qui bys core_to_dod_1yr_n0: sum `v'
qui drop if `v'==.
}

//n=5099 after drop missingness - Criteria A
//n=4183 after drop missingness - Condition Only criteria
tab core_to_dod_1yr_n0, missing //mortality at 1 year

//lee index of mortality
gen leeindex_n0=1
replace leeindex_n0=leeindex_n0+3 if age_n0_ind2==1
replace leeindex_n0=leeindex_n0+4 if  age_n0_ind3==1	
replace leeindex_n0=leeindex_n0+5 if age_n0_ind4 ==1
replace leeindex_n0=leeindex_n0+7 if age_n0_ind5 ==1
replace leeindex_n0=leeindex_n0+2 if female ==0
replace leeindex_n0=leeindex_n0+1 if dm_hrs_n0==1
replace leeindex_n0=leeindex_n0+2 if cancer_hrs_n0==1
replace leeindex_n0=leeindex_n0+2 if lung_hrs_n0== 1
replace leeindex_n0=leeindex_n0+2 if chf_hrs_n0 ==1
replace leeindex_n0=leeindex_n0+2 if smoke_curr_n0==1
replace leeindex_n0=leeindex_n0+1 if bmi_lt25_n0==1
replace leeindex_n0=leeindex_n0+2 if adl_diff_bh_n0==1
replace leeindex_n0=leeindex_n0+2 if iadl_diff_m_n0==1
replace leeindex_n0=leeindex_n0+1 if fl_diff_push_n0==1
replace leeindex_n0=leeindex_n0+2 if fl_diff_wk_many_n0==1

******************************************************************

//generate inverse propensity score weight, 1/p if w=1 1/1-p if w=0
logit core_to_dod_1yr_n0 $weightvars
predict prob_death_1yr_n0 //generate new var-pscore
gen invpscore=(1/prob_death_1yr_n0) if core_to_dod_1yr_n0==1
replace invpscore=(1/(1-prob_death_1yr_n0)) if core_to_dod_1yr_n0==0


mat vr=J(15,6,.)
//compare variance weighted and unweighted covariates 
local i=1
foreach v in $weightvars  {
qui sum `v' if core_to_dod_1yr_n0==1 //get unweighted variance treated
mat vr[`i',1]=r(Var)
qui sum `v' if core_to_dod_1yr_n0==0 //get unweighted variance comparison 
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
qui sum `v' if core_to_dod_1yr_n0==1 [aw=invp] //get weighted variance treated 
mat vr[`i',4]=r(Var)
qui sum `v' if core_to_dod_1yr_n0==0 [aw=invp] //get weighted variance comparison 
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}

mat rownames vr=$weightvars

mat list vr


//thinking about how those that died will have truncated 1 year lookback for outcomes...
sum core_to_death_n0 if core_to_dod_1yr_n0==1, detail
histogram core_to_death_n0 if core_to_dod_1yr_n0==1

gen core_to_dod_1_2yr_n0=1 if core_to_death_n0<2 & core_to_death_n0>=1
tab core_to_dod_1_2yr_n0, missing
******************************************************************
//save the dataset
save n0_n1_p1_p2_x_criteria_`crit'_v1_inv_pweight_lee.dta, replace


******************************************************************
log close
}


H="Univariate and glm for weighted sample"

/*Weighted by inverse propensity for death w/in 1 yr
*/


foreach crit in "2010" "a" "c"{
capture log close

clear all
set more off

local logpath E:\data\serious_ill\logs
local datapath E:\data\serious_ill\final_data

log using "`logpath'\24_inv_pweight_mortality_outcomes1_crit_`crit'_lee_vars.txt", text replace

cd `datapath'

use n0_n1_p1_p2_x_criteria_a_v1_inv_pweight_lee.dta 
***************************************************************
//look at those that died 1st 6 months, their utilization is truncated
tab core_to_dod_6m_n0 core_to_dod_1yr_n0, missing

sum core_to_death_n0 if core_to_dod_6m_n0==1
local n6m=r(N)
histogram core_to_death_n0 if core_to_dod_6m_n0==1, frequency ///
	note("n=`n6m' died within 6 m of n0 core interview")
graph save `logpath'\hist_6m_`crit', replace

sum core_to_death_n0 if core_to_dod_1yr_n0==1
local n12m=r(N)
histogram core_to_death_n0 if core_to_dod_1yr_n0==1, frequency ///
	note("n=`n12m' died within 1 yr of n0 core interview")
graph save `logpath'\hist_1yr_`crit', replace

//histogram of hospital nights outcome
sum n_hospd_p6m_n0, detail
local n12m=r(N)
histogram n_hospd_p6m_n0, frequency ///
	note("n=`n12m' meet criteria `crit'")
graph save `logpath'\hist_6m_hospnights_`crit', replace

***************************************************************
//table 1 compare weighted/unweighted samples
//on covariates used for pscore

***************************************************************
//table 2 look at 6m outcomes weighted/unweighted sampless
//show pvalues since looking at outcomes??

la var core_to_dod_1yr_n0 "Died, n (%)"
la var hs_admit_p6m_n0 "Enrolled in hospice, n (%)"
la var ind_em_ur_adm_p6m_n0 "Hospital admission, n (%)"
la var n_hospd_p6m_n0 "Hospital nights, mean (sd)"

la var ip_paid_by_mc_6m_wi_n0 "Inpatient"
la var snf_paid_by_mc_6m_wi_n0 "SNF"
la var hh_paid_by_mc_6m_wi_n0 "Home health" 
la var hs_paid_by_mc_6m_wi_n0 "Hospice" 
la var pb_paid_by_mc_6m_wi_n0 "Carrier"
la var op_paid_by_mc_6m_wi_n0 "Outpatient" 
la var dm_paid_by_mc_6m_wi_n0 "DME"
la var tot_paid_by_mc_6m_wi_n0 "Total Medicare payments"

la var cc_ami_isch_1yr_n0 "Ischemic heart disease or myocardial infarction"
la var cc_8_chf_1yr_n0 "Congestive heart failure" 
la var cc_4_atrialfb_1yr_n0 "Atrial fibrillation"
la var cc_3_alzhdmta_1yr_n0 "Alzheimer disease or dementia"
la var cc_9_diabetes_1yr_n0 "Diabetes" 
la var cc_6_chrnkidn_1yr_n0 "Chronic kidney disease"
la var cc_7_copd_1yr_n0 "Chronic obstructive pulmonary disease"
la var cc_13_depressn_1yr_n0 "Depression" 
la var cc_cncr_chronic_1yr_n0 "Cancer"
la var cc_15_ra_oa_1yr_n0 "Arthritis"
la var cc_16_strketia_1yr_n0 "Stroke or transient ischemic attack"

local ivars ind_em_ur_adm_p6m_n0

local cvars n_hospd_p6m_n0 tot_paid_by_mc_6m_wi_n0 ip_paid_by_mc_6m_wi_n0 ///
snf_paid_by_mc_6m_wi_n0 hh_paid_by_mc_6m_wi_n0 hs_paid_by_mc_6m_wi_n0 ///
pb_paid_by_mc_6m_wi_n0 op_paid_by_mc_6m_wi_n0 dm_paid_by_mc_6m_wi_n0

//columns 1,2, unweighted, 6m outcomes those that died vs didn't
mat t2=J(1,6,.)
foreach v in `ivars' { //indicator variables
local c=1
	foreach i in 1 0{
		sum `v' if core_to_dod_1yr_n0==`i'
		mat t2[1,`c']=r(mean)*r(N) //n
		mat t2[1,`c'+1]=r(mean)*100 //percent
		local c = `c'+2
	}
	tab `v' core_to_dod_1yr_n0, chi2 //p-values
	mat t2[1,5]=r(p)
	
	mat rownames t2=`v'
	frmttable, statmat(t2) varlabels sdec(0,0,3\2,2,2) substat(1) store(t2_1)
	
	outreg, replay(t2_2) append(t2_1) store(t2_2)
}

foreach v in `cvars' { //continuous variables
local c=1
	foreach i in 1 0{
		sum `v' if core_to_dod_1yr_n0==`i'
		mat t2[1,`c']=r(mean) //mean
		mat t2[1,`c'+1]=r(sd) //sd
		local c = `c'+2
	}
	ttest `v', by(core_to_dod_1yr_n0) //p-values
	mat t2[1,5]=r(p)
	
	mat rownames t2=`v'
	frmttable, statmat(t2) varlabels sdec(0,0,3\0,0,0) substat(1) store(t2_1)
	
	outreg, replay(t2_2) append(t2_1) store(t2_2)
}

//last row, n for each group
mat t2_n=J(1,2,.)
tab core_to_dod_1yr_n0, matcell(t2n)
mat t2_n[1,1]=t2n[2,1]
mat t2_n[1,2]=t2n[1,1]
mat rownames t2_n="N"
frmttable, statmat(t2_n) store(t2_n) sdec(0)

outreg, replay(t2_2) append(t2_n) store(t2_3) ///
title("Criteria `crit' Utilization Outcomes, by 1 year Mortality") ///
ctitles("","Died 1 year","Alive 1 year","p-value") ///
note("Utilization for 6 months after interview" \ ///
"Sample limited to survey respondents first interview that meet Criteria A:" \ ///
"at least one serious medical illness and/or ADL impairment" \ ///
"Medicare spending in 2012$, wage index adjusted.")

//now columns using propensity score weights
mat t2=J(1,6,.)
foreach v in `ivars' { //indicator variables
local c=1
	foreach i in 1 0{
		sum `v' if core_to_dod_1yr_n0==`i' [aw=invp]
		mat t2[1,`c']=r(mean)*r(N) //n
		mat t2[1,`c'+1]=r(mean)*100 //percent
		local c = `c'+2
	}
	logit core_to_dod_1yr_n0 `v' [pw=invp] //p-values
	test `v'
	mat t2[1,5]=r(p)
	
	mat rownames t2=`v'
	frmttable, statmat(t2) varlabels sdec(0,0,3\2,2,2) substat(1) store(t2m_1)
	
	outreg, replay(t2m_2) append(t2m_1) store(t2m_2)
}

foreach v in `cvars' { //continuous variables
local c=1
	foreach i in 1 0{
		sum `v' if core_to_dod_1yr_n0==`i' [aw=invp]
		mat t2[1,`c']=r(mean) //mean
		mat t2[1,`c'+1]=r(sd) //sd
		local c = `c'+2
	}
	logit core_to_dod_1yr_n0 `v' [pw=invp] //p-values
	test `v'
	mat t2[1,5]=r(p)
	
	mat rownames t2=`v'
	frmttable, statmat(t2) varlabels sdec(0,0,3\0,0,0) substat(1) store(t2m_1)
	
	outreg, replay(t2m_2) append(t2m_1) store(t2m_2)
}

//last row, n for each group
mat t2_n=J(1,2,.)
tab core_to_dod_1yr_n0 if invp!=., matcell(t2n)
mat t2_n[1,1]=t2n[2,1]
mat t2_n[1,2]=t2n[1,1]
mat rownames t2_n="N"
frmttable, statmat(t2_n) store(t2_n) sdec(0)

outreg, replay(t2m_2) append(t2_n) store(t2m_3) 

outreg using "`logpath'\24_inv_pweight_outcomes_`crit'_lee", replace replay(t2_3) merge(t2m_3) ///
title("Lee Mortality: Criteria `crit' Utilization Outcomes, by 1 year Mortality" \ ///
"Comparing unweighted and weighted samples") ///
ctitles("","Raw sample","","","Weighted sample","","" \  ///
"","Died 1 year","Alive 1 year","p-value","Died 1 year","Alive 1 year","p-value") ///
note("Utilization for 6 months after interview" \ ///
"Sample limited to survey respondents first interview that meet Criteria `crit':" \ ///
"Weighted sample is inverse propensity score-weighted for risk of mortality at 1 year" \ ///
"Medicare spending in 2012$, wage index adjusted." \ ///
"P-values for continuous variables from t-test, for binary variables from chi-squared statistic")
***************************************************************
//multivariate analysis, ps-weighted sample using glm model
//2 versions, (1) excluding mortality on RHS, (2) including mortality

gen relig_vimp_n0=1 if imprelig_n0==1
replace relig_vimp_n0=0 if inlist(imprelig_n0,2,3,4)
tab relig_vimp_n0 imprelig_n0, missing

//live alone?
tab hhm_n0,missing
generate livealone_n0=.
replace livealone_n0=1 if hhm_n0==0 & resspouse_n0==0
replace livealone_n0=0 if hhm_n0>0 | nhres_n0==1 | resspouse_n0==1
label variable livealone_n0 "Live Alone in Community n0"
//label define livealone 0 "No" 1 "Yes", modify
//label values livealone livealone
tab livealone_n0 core_year_n0, missing
tab hhm_n0 livealone_n0
tab livealone_n0 resspouse_n0

//age, 10 year groups
tab age_cat_n0, gen(age)
la var age1 "Age 65-74"
la var age2 "Age 75-84"
la var age3 "Age 85+"

//comorbidities using claims dx, data warehouse chronic conditions
local cc cc_ami_isch_1yr_n0 cc_8_chf_1yr_n0 cc_4_atrialfb_1yr_n0 ///
 cc_3_alzhdmta_1yr_n0 cc_9_diabetes_1yr_n0 cc_6_chrnkidn_1yr_n0 ///
 cc_7_copd_1yr_n0 cc_13_depressn_1yr_n0 cc_cncr_chronic_1yr_n0 ///
 cc_15_ra_oa_1yr_n0 cc_16_strketia_1yr_n0
foreach v in `cc' {
tab `v', missing
}
la var cc_ami_isch_1yr_n0 "Ischemic heart disease or myocardial infarction"
la var cc_8_chf_1yr_n0 "Congestive heart failure" 
la var cc_4_atrialfb_1yr_n0 "Atrial fibrillation"
la var cc_3_alzhdmta_1yr_n0 "Alzheimer disease or dementia"
la var cc_9_diabetes_1yr_n0 "Diabetes" 
la var cc_6_chrnkidn_1yr_n0 "Chronic kidney disease"
la var cc_7_copd_1yr_n0 "Chronic obstructive pulmonary disease"
la var cc_13_depressn_1yr_n0 "Depression" 
la var cc_cncr_chronic_1yr_n0 "Cancer"
la var cc_15_ra_oa_1yr_n0 "Arthritis"
la var cc_16_strketia_1yr_n0 "Stroke or transient ischemic attack"

//adl change categories, replace Lee functional variables
tab adl_stable_ind_n0n1 adl_improved_n0n1 , missing //base case = independent,stable or improved
tab adl_stable_partial_n0n1, missing
tab adl_stable_severe_n0n1, missing
tab adl_change_i_m_n0n1, missing 
tab adl_change_i_s_n0n1, missing 
tab adl_change_m_s_n0n1, missing 
foreach v in adl_change_i_m_n0n1 adl_change_i_s_n0n1 adl_change_m_s_n0n1 {
replace `v'=0 if adl_stable_ind_n0n1==1 | adl_stable_partial_n0n1==1 | adl_stable_severe_n0n1==1
tab `v',missing
} 

//want to cluster at eol spending quintiles
sum tot_eol_spending_hrr_n0 , detail
sca sp_20=r(p20)
sca sp_40=r(p40)
sca sp_60=r(p60)
sca sp_80=r(p80)
xtile eol_spend_hrr_quint = tot_eol_spending_hrr_n0 , nquantiles(5)
la var eol_spend_hrr_quint "EOL Spending at HRR Quintiles 1=low, 5=high"
tab eol_spend_hrr_quint, missing
bys eol_spend_hrr_quint : sum tot_eol_spending_hrr_n0

loneway tot_paid_by_mc_6m_wi_n0 eol_spend_hrr_quint 
loneway n_hospd_p6m_n0 eol_spend_hrr_quint 
loneway ind_hosp_adm_p6m_n0 eol_spend_hrr_quint 

local xvars age2 age3 female re_black re_hisp re_other_unk hs_deg_ind married_n0 ///
 nw_lowest_n0 nhres_n0 livealone_n0 rel_nb_n0 ///
 relig_vimp_n0  adl_stable_partial_n0n1 adl_stable_severe_n0n1 adl_change_i_m_n0n1 ///
 adl_change_i_s_n0n1 adl_change_m_s_n0n1 medicaid_n0 champus_n0 ///
 medigap_n0  srh_pf_n0  bmi_lt25_n0 smoke_curr_n0 `cc' ///
 hospital_care_intensity_n0 hospital_beds_n0 specialists_n0

la var female "Female"
la var relig_vimp_n0 "Religion very important"
la var hospital_care_intensity_n0 "Hospital care intensity index, HRR"
la var hospital_beds_n0 "Hospital beds/1000 residents, HRR"
la var specialists_n0 "Specialists /100,000 residents, HRR"

la var core_to_dod_1yr_n0 "Died within 1 year of interview"

la var cc_ami_isch_1yr_n0 "Ischemic heart disease or myocardial infarction"
la var cc_8_chf_1yr_n0 "Congestive heart failure" 
la var cc_4_atrialfb_1yr_n0 "Atrial fibrillation"
la var cc_3_alzhdmta_1yr_n0 "Alzheimer disease or dementia"
la var cc_9_diabetes_1yr_n0 "Diabetes" 
la var cc_6_chrnkidn_1yr_n0 "Chronic kidney disease"
la var cc_7_copd_1yr_n0 "Chronic obstructive pulmonary disease"
la var cc_13_depressn_1yr_n0 "Depression" 
la var cc_cncr_chronic_1yr_n0 "Cancer"
la var cc_15_ra_oa_1yr_n0 "Arthritis"
la var cc_16_strketia_1yr_n0 "Stroke or transient ischemic attack"

***************************************************************

foreach weight in "" "[pw=invp]" {

//glm outcome=spending, excluding mortality
glm tot_paid_by_mc_6m_wi_n0 `xvars' `weight', ///
	fam(gamma) link(log) vce(robust)
	
glm, eform

outreg , stats(e_b e_ci) store(tab3) varlabels ///
title("Lee Mortality: Criteria `crit' 6 month utilization, GLM regression" \ ///
"using inverse propensity score weights`weight' 1 year mortality" \ ///
"Excluding mortality from RHS") ///
ctitle("","Total Medicare spending") ///
note("6 month Medicare spending for those R's that meet Criteria `crit'" \ ///
"Generalized linear model. For Medicare Costs: gamma distribution and log link" \ ///
"For hospital nights: Poisson distribution, log link" \ ///
"For any hospitalization: Logit regression" \ ///
"Exponentiated coefficients (rate ratios) and 95% confidence intervals reported." \ ///
"Robust standard errors." \ ///
"Chronic conditions from claims diagnoses 1yr preceeding interview.")

//glm outcome=hospital nights
glm n_hospd_p6m_n0 `xvars' `weight', ///
	fam(poisson) link(log)  vce(robust)
outreg , varlabels ///
stats(e_b e_ci) merge(tab3) store(tab3_1) ///
ctitle("","Hospital nights")

//logit on any hospitalizations
logit ind_hosp_adm_p6m_n0 `xvars' `weight', ///
	vce(robust)
outreg using "`logpath'\24_inv_pweight_outcomes_`crit'_lee", addtable varlabels ///
stats(e_b e_ci) merge(tab3_1) ///
ctitle("","Any Hospitalization (binary)")


***************************************************************
//glm outcome=spending, including mortality
glm tot_paid_by_mc_6m_wi_n0 `xvars' core_to_dod_1yr_n0 `weight', ///
	fam(gamma) link(log) vce(robust)
	
glm, eform

outreg , stats(e_b e_ci) store(tab3) varlabels ///
title("Lee Mortality: Criteria `crit' 6 month utilization, GLM regression" \ ///
"using inverse propensity score weights 1 year mortality" \ ///
"Including mortality on RHS") ///
ctitle("","Total Medicare spending") ///
note("6 month Medicare spending for those R's that meet Criteria `crit'" \ ///
"Generalized linear model. For Medicare Costs: gamma distribution and log link" \ ///
"For hospital nights: Poisson distribution, log link" \ ///
"For any hospitalization: Logit regression" \ ///
"Exponentiated coefficients (rate ratios) and 95% confidence intervals reported." \ ///
"Robust standard errors." \ ///
"Chronic conditions from claims diagnoses 1yr preceeding interview.")

//glm outcome=hospital nights
glm n_hospd_p6m_n0 `xvars' core_to_dod_1yr_n0 `weight', ///
	fam(poisson) link(log)  vce(robust)
outreg , varlabels ///
stats(e_b e_ci) merge(tab3) store(tab3_1) ///
ctitle("","Hospital nights")

//logit on any hospitalizations
logit ind_hosp_adm_p6m_n0 `xvars' core_to_dod_1yr_n0 `weight', ///
	vce(robust)
outreg using "`logpath'\24_inv_pweight_outcomes_`crit'_lee", addtable varlabels ///
stats(e_b e_ci) merge(tab3_1) ///
ctitle("","Any Hospitalization (binary)")
}
***************************************************************

log close
}


H="ebalance"
/*Generating Inverse Propensity Score Weights for sample to address truncated data
because of mortality
*/
foreach crit in  "2010" "a" "c"{
capture log close

clear all
set more off


local logpath E:\data\serious_ill\logs
local datapath E:\data\serious_ill\final_data

log using "`logpath'\23_inv_pweight_mortality_crit_`crit'_ebal.txt", text replace

cd `datapath'

use n0_n1_p1_p2_x_criteria_`crit'_v1.dta if core_year_n0<2012
******************************************************************

******************************************************************
di "Criteria `crit' dataset"
******************************************************************
tab core_to_dod_1yr_n0, missing //mortality at 1 year
tab core_to_dod_1yr_p1, missing //at p1 interview

tab age_cat2_n0, gen(age_n0_ind)

//define pscore variable list based on Lee prognostic index, drop if missing in any variables
global weightvars age_n0_ind2 age_n0_ind3 age_n0_ind4 age_n0_ind5 female ///
dm_hrs_n0 cancer_hrs_n0 lung_hrs_n0 chf_hrs_n0 bmi_lt25_n0 smoke_curr_n0  ///
adl_diff_bh_n0 iadl_diff_m_n0 fl_diff_wk_many_n0 fl_diff_push_n0 

//n=5297 meet criteria A
//n=4338 meet Condition only criteria
foreach v in $weightvars{
sum `v', detail
qui bys core_to_dod_1yr_n0: sum `v'
qui drop if `v'==.
}

//n=5099 after drop missingness - Criteria A
//n=4183 after drop missingness - Condition Only criteria
tab core_to_dod_1yr_n0, missing //mortality at 1 year

//lee index of mortality
gen leeindex_n0=1
replace leeindex_n0=leeindex_n0+3 if age_n0_ind2==1
replace leeindex_n0=leeindex_n0+4 if  age_n0_ind3==1	
replace leeindex_n0=leeindex_n0+5 if age_n0_ind4 ==1
replace leeindex_n0=leeindex_n0+7 if age_n0_ind5 ==1
replace leeindex_n0=leeindex_n0+2 if female ==0
replace leeindex_n0=leeindex_n0+1 if dm_hrs_n0==1
replace leeindex_n0=leeindex_n0+2 if cancer_hrs_n0==1
replace leeindex_n0=leeindex_n0+2 if lung_hrs_n0== 1
replace leeindex_n0=leeindex_n0+2 if chf_hrs_n0 ==1
replace leeindex_n0=leeindex_n0+2 if smoke_curr_n0==1
replace leeindex_n0=leeindex_n0+1 if bmi_lt25_n0==1
replace leeindex_n0=leeindex_n0+2 if adl_diff_bh_n0==1
replace leeindex_n0=leeindex_n0+2 if iadl_diff_m_n0==1
replace leeindex_n0=leeindex_n0+1 if fl_diff_push_n0==1
replace leeindex_n0=leeindex_n0+2 if fl_diff_wk_many_n0==1

******************************************************************

//generate inverse propensity score weight, 1/p if w=1 1/1-p if w=0
logit core_to_dod_1yr_n0 $weightvars
predict prob_death_1yr_n0 //generate new var-pscore
gen invpscore=(1/prob_death_1yr_n0) if core_to_dod_1yr_n0==1
replace invpscore=(1/(1-prob_death_1yr_n0)) if core_to_dod_1yr_n0==0

gen ebw=. 

ebalance core_to_dod_1yr_n0 $weightvars , tol(.01)
replace ebw = _webal
drop _webal


mat vr=J(15,6,.)
//compare variance weighted and unweighted covariates 
local i=1
foreach v in $weightvars  {
qui sum `v' if core_to_dod_1yr_n0==1 //get unweighted variance treated
mat vr[`i',1]=r(Var)
qui sum `v' if core_to_dod_1yr_n0==0 //get unweighted variance comparison 
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
qui sum `v' if core_to_dod_1yr_n0==1 [aw=ebw] //get weighted variance treated 
mat vr[`i',4]=r(Var)
qui sum `v' if core_to_dod_1yr_n0==0 [aw=ebw] //get weighted variance comparison 
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}

mat rownames vr=$weightvars

mat list vr


//thinking about how those that died will have truncated 1 year lookback for outcomes...
sum core_to_death_n0 if core_to_dod_1yr_n0==1, detail
histogram core_to_death_n0 if core_to_dod_1yr_n0==1

gen core_to_dod_1_2yr_n0=1 if core_to_death_n0<2 & core_to_death_n0>=1
tab core_to_dod_1_2yr_n0, missing
******************************************************************
//save the dataset
save n0_n1_p1_p2_x_criteria_`crit'_v1_ebal.dta, replace


******************************************************************
log close
}


H="Univariate and glm for entropy-weighted sample"

/*Weighted by inverse propensity for death w/in 1 yr
*/


foreach crit in "a" {
capture log close

clear all
set more off

local logpath E:\data\serious_ill\logs
local datapath E:\data\serious_ill\final_data

log using "`logpath'\24__ebw_mortality_outcomes1_crit_`crit'_lee_vars.txt", text replace

cd `datapath'

use n0_n1_p1_p2_x_criteria_`crit'_v1_ebal.dta 
***************************************************************
//look at those that died 1st 6 months, their utilization is truncated
tab core_to_dod_6m_n0 core_to_dod_1yr_n0, missing

sum core_to_death_n0 if core_to_dod_6m_n0==1
local n6m=r(N)
histogram core_to_death_n0 if core_to_dod_6m_n0==1, frequency ///
	note("n=`n6m' died within 6 m of n0 core interview")
graph save `logpath'\hist_6m_`crit', replace

sum core_to_death_n0 if core_to_dod_1yr_n0==1
local n12m=r(N)
histogram core_to_death_n0 if core_to_dod_1yr_n0==1, frequency ///
	note("n=`n12m' died within 1 yr of n0 core interview")
graph save `logpath'\hist_1yr_`crit', replace

//histogram of hospital nights outcome
sum n_hospd_p6m_n0, detail
local n12m=r(N)
histogram n_hospd_p6m_n0, frequency ///
	note("n=`n12m' meet criteria `crit'")
graph save `logpath'\hist_6m_hospnights_`crit', replace

***************************************************************
//table 1 compare weighted/unweighted samples
//on covariates used for pscore

***************************************************************
//table 2 look at 6m outcomes weighted/unweighted sampless
//show pvalues since looking at outcomes??

la var core_to_dod_1yr_n0 "Died, n (%)"
la var hs_admit_p6m_n0 "Enrolled in hospice, n (%)"
la var ind_em_ur_adm_p6m_n0 "Hospital admission, n (%)"
la var n_hospd_p6m_n0 "Hospital nights, mean (sd)"

la var ip_paid_by_mc_6m_wi_n0 "Inpatient"
la var snf_paid_by_mc_6m_wi_n0 "SNF"
la var hh_paid_by_mc_6m_wi_n0 "Home health" 
la var hs_paid_by_mc_6m_wi_n0 "Hospice" 
la var pb_paid_by_mc_6m_wi_n0 "Carrier"
la var op_paid_by_mc_6m_wi_n0 "Outpatient" 
la var dm_paid_by_mc_6m_wi_n0 "DME"
la var tot_paid_by_mc_6m_wi_n0 "Total Medicare payments"

la var cc_ami_isch_1yr_n0 "Ischemic heart disease or myocardial infarction"
la var cc_8_chf_1yr_n0 "Congestive heart failure" 
la var cc_4_atrialfb_1yr_n0 "Atrial fibrillation"
la var cc_3_alzhdmta_1yr_n0 "Alzheimer disease or dementia"
la var cc_9_diabetes_1yr_n0 "Diabetes" 
la var cc_6_chrnkidn_1yr_n0 "Chronic kidney disease"
la var cc_7_copd_1yr_n0 "Chronic obstructive pulmonary disease"
la var cc_13_depressn_1yr_n0 "Depression" 
la var cc_cncr_chronic_1yr_n0 "Cancer"
la var cc_15_ra_oa_1yr_n0 "Arthritis"
la var cc_16_strketia_1yr_n0 "Stroke or transient ischemic attack"

local ivars ind_em_ur_adm_p6m_n0

local cvars n_hospd_p6m_n0 tot_paid_by_mc_6m_wi_n0 ip_paid_by_mc_6m_wi_n0 ///
snf_paid_by_mc_6m_wi_n0 hh_paid_by_mc_6m_wi_n0 hs_paid_by_mc_6m_wi_n0 ///
pb_paid_by_mc_6m_wi_n0 op_paid_by_mc_6m_wi_n0 dm_paid_by_mc_6m_wi_n0

//columns 1,2, unweighted, 6m outcomes those that died vs didn't
mat t2=J(1,6,.)
foreach v in `ivars' { //indicator variables
local c=1
	foreach i in 1 0{
		sum `v' if core_to_dod_1yr_n0==`i'
		mat t2[1,`c']=r(mean)*r(N) //n
		mat t2[1,`c'+1]=r(mean)*100 //percent
		local c = `c'+2
	}
	tab `v' core_to_dod_1yr_n0, chi2 //p-values
	mat t2[1,5]=r(p)
	
	mat rownames t2=`v'
	frmttable, statmat(t2) varlabels sdec(0,0,3\2,2,2) substat(1) store(t2_1)
	
	outreg, replay(t2_2) append(t2_1) store(t2_2)
}

foreach v in `cvars' { //continuous variables
local c=1
	foreach i in 1 0{
		sum `v' if core_to_dod_1yr_n0==`i'
		mat t2[1,`c']=r(mean) //mean
		mat t2[1,`c'+1]=r(sd) //sd
		local c = `c'+2
	}
	ttest `v', by(core_to_dod_1yr_n0) //p-values
	mat t2[1,5]=r(p)
	
	mat rownames t2=`v'
	frmttable, statmat(t2) varlabels sdec(0,0,3\0,0,0) substat(1) store(t2_1)
	
	outreg, replay(t2_2) append(t2_1) store(t2_2)
}

//last row, n for each group
mat t2_n=J(1,2,.)
tab core_to_dod_1yr_n0, matcell(t2n)
mat t2_n[1,1]=t2n[2,1]
mat t2_n[1,2]=t2n[1,1]
mat rownames t2_n="N"
frmttable, statmat(t2_n) store(t2_n) sdec(0)

outreg, replay(t2_2) append(t2_n) store(t2_3) ///
title("Criteria `crit' Utilization Outcomes, by 1 year Mortality") ///
ctitles("","Died 1 year","Alive 1 year","p-value") ///
note("Utilization for 6 months after interview" \ ///
"Sample limited to survey respondents first interview that meet Criteria A:" \ ///
"at least one serious medical illness and/or ADL impairment" \ ///
"Medicare spending in 2012$, wage index adjusted.")

//now columns using propensity score weights
mat t2=J(1,6,.)
foreach v in `ivars' { //indicator variables
local c=1
	foreach i in 1 0{
		sum `v' if core_to_dod_1yr_n0==`i' [aw=ebw]
		mat t2[1,`c']=r(mean)*r(N) //n
		mat t2[1,`c'+1]=r(mean)*100 //percent
		local c = `c'+2
	}
	logit core_to_dod_1yr_n0 `v' [pw=ebw] //p-values
	test `v'
	mat t2[1,5]=r(p)
	
	mat rownames t2=`v'
	frmttable, statmat(t2) varlabels sdec(0,0,3\2,2,2) substat(1) store(t2m_1)
	
	outreg, replay(t2m_2) append(t2m_1) store(t2m_2)
}

foreach v in `cvars' { //continuous variables
local c=1
	foreach i in 1 0{
		sum `v' if core_to_dod_1yr_n0==`i' [aw=ebw]
		mat t2[1,`c']=r(mean) //mean
		mat t2[1,`c'+1]=r(sd) //sd
		local c = `c'+2
	}
	logit core_to_dod_1yr_n0 `v' [pw=ebw] //p-values
	test `v'
	mat t2[1,5]=r(p)
	
	mat rownames t2=`v'
	frmttable, statmat(t2) varlabels sdec(0,0,3\0,0,0) substat(1) store(t2m_1)
	
	outreg, replay(t2m_2) append(t2m_1) store(t2m_2)
}

//last row, n for each group
mat t2_n=J(1,2,.)
tab core_to_dod_1yr_n0 if ebw!=., matcell(t2n)
mat t2_n[1,1]=t2n[2,1]
mat t2_n[1,2]=t2n[1,1]
mat rownames t2_n="N"
frmttable, statmat(t2_n) store(t2_n) sdec(0)

outreg, replay(t2m_2) append(t2_n) store(t2m_3) 

outreg using "`logpath'\24__ebw_outcomes_`crit'_lee", replace replay(t2_3) merge(t2m_3) ///
title("Lee Mortality: Criteria `crit' Utilization Outcomes, by 1 year Mortality" \ ///
"Comparing unweighted and weighted samples") ///
ctitles("","Raw sample","","","Weighted sample","","" \  ///
"","Died 1 year","Alive 1 year","p-value","Died 1 year","Alive 1 year","p-value") ///
note("Utilization for 6 months after interview" \ ///
"Sample limited to survey respondents first interview that meet Criteria `crit':" \ ///
"Weighted sample is inverse propensity score-weighted for risk of mortality at 1 year" \ ///
"Medicare spending in 2012$, wage index adjusted." \ ///
"P-values for continuous variables from t-test, for binary variables from chi-squared statistic")
***************************************************************
//multivariate analysis, ps-weighted sample using glm model
//2 versions, (1) excluding mortality on RHS, (2) including mortality

gen relig_vimp_n0=1 if imprelig_n0==1
replace relig_vimp_n0=0 if inlist(imprelig_n0,2,3,4)
tab relig_vimp_n0 imprelig_n0, missing

//live alone?
tab hhm_n0,missing
generate livealone_n0=.
replace livealone_n0=1 if hhm_n0==0 & resspouse_n0==0
replace livealone_n0=0 if hhm_n0>0 | nhres_n0==1 | resspouse_n0==1
label variable livealone_n0 "Live Alone in Community n0"
//label define livealone 0 "No" 1 "Yes", modify
//label values livealone livealone
tab livealone_n0 core_year_n0, missing
tab hhm_n0 livealone_n0
tab livealone_n0 resspouse_n0

//age, 10 year groups
tab age_cat_n0, gen(age)
la var age1 "Age 65-74"
la var age2 "Age 75-84"
la var age3 "Age 85+"

//comorbidities using claims dx, data warehouse chronic conditions
local cc cc_ami_isch_1yr_n0 cc_8_chf_1yr_n0 cc_4_atrialfb_1yr_n0 ///
 cc_3_alzhdmta_1yr_n0 cc_9_diabetes_1yr_n0 cc_6_chrnkidn_1yr_n0 ///
 cc_7_copd_1yr_n0 cc_13_depressn_1yr_n0 cc_cncr_chronic_1yr_n0 ///
 cc_15_ra_oa_1yr_n0 cc_16_strketia_1yr_n0
foreach v in `cc' {
tab `v', missing
}
la var cc_ami_isch_1yr_n0 "Ischemic heart disease or myocardial infarction"
la var cc_8_chf_1yr_n0 "Congestive heart failure" 
la var cc_4_atrialfb_1yr_n0 "Atrial fibrillation"
la var cc_3_alzhdmta_1yr_n0 "Alzheimer disease or dementia"
la var cc_9_diabetes_1yr_n0 "Diabetes" 
la var cc_6_chrnkidn_1yr_n0 "Chronic kidney disease"
la var cc_7_copd_1yr_n0 "Chronic obstructive pulmonary disease"
la var cc_13_depressn_1yr_n0 "Depression" 
la var cc_cncr_chronic_1yr_n0 "Cancer"
la var cc_15_ra_oa_1yr_n0 "Arthritis"
la var cc_16_strketia_1yr_n0 "Stroke or transient ischemic attack"

//adl change categories, replace Lee functional variables
tab adl_stable_ind_n0n1 adl_improved_n0n1 , missing //base case = independent,stable or improved
tab adl_stable_partial_n0n1, missing
tab adl_stable_severe_n0n1, missing
tab adl_change_i_m_n0n1, missing 
tab adl_change_i_s_n0n1, missing 
tab adl_change_m_s_n0n1, missing 
foreach v in adl_change_i_m_n0n1 adl_change_i_s_n0n1 adl_change_m_s_n0n1 {
replace `v'=0 if adl_stable_ind_n0n1==1 | adl_stable_partial_n0n1==1 | adl_stable_severe_n0n1==1
tab `v',missing
} 

//want to cluster at eol spending quintiles
sum tot_eol_spending_hrr_n0 , detail
sca sp_20=r(p20)
sca sp_40=r(p40)
sca sp_60=r(p60)
sca sp_80=r(p80)
xtile eol_spend_hrr_quint = tot_eol_spending_hrr_n0 , nquantiles(5)
la var eol_spend_hrr_quint "EOL Spending at HRR Quintiles 1=low, 5=high"
tab eol_spend_hrr_quint, missing
bys eol_spend_hrr_quint : sum tot_eol_spending_hrr_n0

loneway tot_paid_by_mc_6m_wi_n0 eol_spend_hrr_quint 
loneway n_hospd_p6m_n0 eol_spend_hrr_quint 
loneway ind_hosp_adm_p6m_n0 eol_spend_hrr_quint 

local xvars age2 age3 female re_black re_hisp re_other_unk hs_deg_ind married_n0 ///
 nw_lowest_n0 nhres_n0 livealone_n0 rel_nb_n0 ///
 relig_vimp_n0  adl_stable_partial_n0n1 adl_stable_severe_n0n1 adl_change_i_m_n0n1 ///
 adl_change_i_s_n0n1 adl_change_m_s_n0n1 medicaid_n0 champus_n0 ///
 medigap_n0  srh_pf_n0  bmi_lt25_n0 smoke_curr_n0 `cc' ///
 hospital_care_intensity_n0 hospital_beds_n0 specialists_n0

la var female "Female"
la var relig_vimp_n0 "Religion very important"
la var hospital_care_intensity_n0 "Hospital care intensity index, HRR"
la var hospital_beds_n0 "Hospital beds/1000 residents, HRR"
la var specialists_n0 "Specialists /100,000 residents, HRR"

la var core_to_dod_1yr_n0 "Died within 1 year of interview"

la var cc_ami_isch_1yr_n0 "Ischemic heart disease or myocardial infarction"
la var cc_8_chf_1yr_n0 "Congestive heart failure" 
la var cc_4_atrialfb_1yr_n0 "Atrial fibrillation"
la var cc_3_alzhdmta_1yr_n0 "Alzheimer disease or dementia"
la var cc_9_diabetes_1yr_n0 "Diabetes" 
la var cc_6_chrnkidn_1yr_n0 "Chronic kidney disease"
la var cc_7_copd_1yr_n0 "Chronic obstructive pulmonary disease"
la var cc_13_depressn_1yr_n0 "Depression" 
la var cc_cncr_chronic_1yr_n0 "Cancer"
la var cc_15_ra_oa_1yr_n0 "Arthritis"
la var cc_16_strketia_1yr_n0 "Stroke or transient ischemic attack"

***************************************************************

foreach weight in "" "[pw=ebw]" {

//glm outcome=spending, excluding mortality
glm tot_paid_by_mc_6m_wi_n0 `xvars' `weight', ///
	fam(gamma) link(log) vce(robust)
	
glm, eform

outreg , stats(e_b e_ci) store(tab3) varlabels ///
title("Lee Mortality: Criteria `crit' 6 month utilization, GLM regression" \ ///
"using entropy-balanced weights`weight' 1 year mortality" \ ///
"Excluding mortality from RHS") ///
ctitle("","Total Medicare spending") ///
note("6 month Medicare spending for those R's that meet Criteria `crit'" \ ///
"Generalized linear model. For Medicare Costs: gamma distribution and log link" \ ///
"For hospital nights: Poisson distribution, log link" \ ///
"For any hospitalization: Logit regression" \ ///
"Exponentiated coefficients (rate ratios) and 95% confidence intervals reported." \ ///
"Robust standard errors." \ ///
"Chronic conditions from claims diagnoses 1yr preceeding interview.")

//glm outcome=hospital nights
glm n_hospd_p6m_n0 `xvars' `weight', ///
	fam(poisson) link(log)  vce(robust)
outreg , varlabels ///
stats(e_b e_ci) merge(tab3) store(tab3_1) ///
ctitle("","Hospital nights")

//logit on any hospitalizations
logit ind_hosp_adm_p6m_n0 `xvars' `weight', ///
	vce(robust)
outreg using "`logpath'\24__ebw_outcomes_`crit'_lee", addtable varlabels ///
stats(e_b e_ci) merge(tab3_1) ///
ctitle("","Any Hospitalization (binary)")
/*

***************************************************************
//glm outcome=spending, including mortality
glm tot_paid_by_mc_6m_wi_n0 `xvars' core_to_dod_1yr_n0 `weight', ///
	fam(gamma) link(log) vce(robust)
	
glm, eform

outreg , stats(e_b e_ci) store(tab3) varlabels ///
title("Lee Mortality: Criteria `crit' 6 month utilization, GLM regression" \ ///
"using inverse propensity score weights 1 year mortality" \ ///
"Including mortality on RHS") ///
ctitle("","Total Medicare spending") ///
note("6 month Medicare spending for those R's that meet Criteria `crit'" \ ///
"Generalized linear model. For Medicare Costs: gamma distribution and log link" \ ///
"For hospital nights: Poisson distribution, log link" \ ///
"For any hospitalization: Logit regression" \ ///
"Exponentiated coefficients (rate ratios) and 95% confidence intervals reported." \ ///
"Robust standard errors." \ ///
"Chronic conditions from claims diagnoses 1yr preceeding interview.")

//glm outcome=hospital nights
glm n_hospd_p6m_n0 `xvars' core_to_dod_1yr_n0 `weight', ///
	fam(poisson) link(log)  vce(robust)
outreg , varlabels ///
stats(e_b e_ci) merge(tab3) store(tab3_1) ///
ctitle("","Hospital nights")

//logit on any hospitalizations
logit ind_hosp_adm_p6m_n0 `xvars' core_to_dod_1yr_n0 `weight', ///
	vce(robust)
outreg using "`logpath'\24__ebw_outcomes_`crit'_lee", addtable varlabels ///
stats(e_b e_ci) merge(tab3_1) ///
ctitle("","Any Hospitalization (binary)")
*/
}
***************************************************************

log close
}

gen alive_1yr_n0=core_to_dod_1yr_n0*-1 +1
ebalance alive_ $weightvars , tol(.01)
outreg, clear
glm tot_paid_by_mc_6m_wi_n0 `xvars', robust link(log) fam(gamma)
outreg, varlabels
glm tot_paid_by_mc_6m_wi_n0 `xvars'  if core_to_dod_1yr_n0==1, robust link(log) fam(gamma)
outreg, merge store(glm1) varlabels
glm tot_paid_by_mc_6m_wi_n0 `xvars' if core_to_dod_1yr_n0==0, robust link(log) fam(gamma)
outreg, merge store(glm1) varlabels
foreach weight in "ebw" "_w" {
glm tot_paid_by_mc_6m_wi_n0 `xvars' [pw=`weight'], robust link(log) fam(gamma)
outreg, merge store(glm1) varlabels
}


gen ind_lee = leein>=14


outreg using "`logpath'\outcomes_different_weights.rtf", ///
replay(glm1) title("GLM 6M Medicare Spending, under different weights") ///
ctitles("" "Unweighted" "Dead 1yr" "Alive 1yr" "WDead==1" "WAlive==1") replace

qui glm tot_paid_by_mc_6m_wi_n0 `xvars' , robust link(log) fam(gamma)
qui outreg, varlabels
estat ic
qui glm tot_paid_by_mc_6m_wi_n0 `xvars'  leein, robust link(log) fam(gamma)
qui outreg, merge store(glm1) varlabels
estat ic
qui glm tot_paid_by_mc_6m_wi_n0 `xvars'  ind_lee, robust link(log) fam(gamma)
qui outreg, merge store(glm1) varlabels
estat ic
qui glm tot_paid_by_mc_6m_wi_n0 `xvars'  prob_death_1, robust link(log) fam(gamma)
qui outreg, merge store(glm1) varlabels
estat ic
outreg using "`logpath'\outcomes_different_weights.rtf", ///
replay(glm1) title("GLM with prognosis control") ///
ctitles("" "No prog" "Lee" "Lee>=14" "Pscore") addtable

qui reg tot_paid_by_mc_6m_wi_n0 `xvars' core_to_dod_1yr_n0, robust
outreg
qui reg tot_paid_by_mc_6m_wi_n0 `xvars' core_to_dod_1yr_n0 [pw=ebw], robust
outreg, merge
qui reg tot_paid_by_mc_6m_wi_n0 `xvars' core_to_dod_1yr_n0 [pw=_w], robust
outreg, merge




H="**********************************"


H="Tables including 24m spending"
capture log close

clear all
set more off

local logpath E:\data\serious_ill\logs
local datapath E:\data\serious_ill\final_data

log using "`logpath'\tables_inc_24m_symptoms_helper", text replace

cd `datapath'

use n0_n1_p1_p2_x_criteria_a_v1.dta if core_year_n0<2012

//gen vars used in fmm & ps matching
gen religvimp_n0=1 if imprelig_n0==1
replace religvimp_n0=0 if inlist(imprelig_n0,2,3,4)
tab religvimp_n0, missing

gen smi_any_n0=1 if smi_count_n0>0
replace smi_any_n0=0 if smi_count_n0==0
tab smi_any_n0, m

	//assign variable names for use in the tables
label var age_at_core_n0 "Age, mean"
label var networth_adj2012_n0 "Net worth, mean (SD)"
label var female "Female"
label var re_black "Black"
label var re_white "non-Hispanic White"
label var re_hisp "Hispanic"
label var re_other_unk "Other or Unknown"
label var educ_level_lt_hs "Less than HS Deg."

label var educ_level_hs "High school degree"
label var educ_level_somcol "Some college"
label var educ_level_col "Four year college deg."
label var srh_pf_n0 "SRH Poor/Fair"
label var srh_g_n0 "SRH Good"
label var srh_ve_n0 "SRH Very good/Excellent"

label var married_n0 "Married"
label var smi_dem_ind_n0 "Dementia"
label var smi_cancer_ind_n0 "Cancer"
label var smi_esrd_ind_n0 "ESRD"
label var smi_chf_ind_n0 "CHF"
label var smi_copd_ind_n0 "COPD"
label var religvimp_n0 "Religion v. Important"

label var smi_diab_compl_ind_n0 "Diabetes"
label var smi_liver_ind_n0 "Liver disease"
label var smi_als_ind_n0 "ALS"
label var smi_hip_ind_n0 "Hip Fracture"
label var el_ge3_comorb_1yr_n0 "3 or more comorbid conditions*"

label var ser_med_illness_n0 "Any serious medical illness"
label var adl_impair_core_n0 "ADL Impairment"
label var hlphrs "Total Helper Hours, mean"
label var n_hp "Total Number Helpers, mean"

label var smi_and_adl_n0 "Medical illness & ADL Impair."
label var smi_nh_ind_n0 "Nursing home resident"
label var ind_em_ur_adm_12m_n0 "Hospital admission"
label var adl_stable_ind_n0n1 "ADL Stable, independent"
label var adl_stable_partial_n0n1 "ADL Stable, partial dep."

label var adl_stable_severe_n0n1 "ADL Stable, severe dep."
label var adl_change_i_m_n0n1 "ADL Indep to Partial Dep"
label var adl_change_i_s_n0n1 "ADL Indep to Severe Dep"
label var adl_change_m_s_n0n1 "ADL Partial to Severe Dep"

label var hospital_care_intensity_n0 "HCI Index"


local cat core_to_dod_2yr_n0 p_low_ut brief_1st p_high

local covars age_at_core_n0 female re_black re_white re_hisp married_n0 ///
hs_deg_ind nw_lowest_n0 nw_midlow_n0 nw_midhigh_n0 nw_highest_n0 ///
religvimp_n0 srh_pf_n0 srh_g_n0 srh_ve_n0 rel_nb_n0 smi_nh_ind_n0 ///
medicaid_n0 champus_n0 medigap_n0 ///
ind_em_ur_adm_12m_n0 smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 ///
smi_diab_compl_ind_n0 smi_liver_ind_n0 adl_impair_core_n0 n_hp hlphrs 

foreach x of local covars {
	drop if `x'==.
}

mat money=J(5,6,.)
local c=1

foreach i in by_mc_12m 2nd_yr by_mc_24m {
	sum tot_paid_`i'_wi_n0
	mat money[1,`c']=r(mean)
	mat money[1,`c'+1]=r(sd)
	local r=2
	
	foreach x of local cat {
		sum tot_paid_`i'_wi_n0 if `x'==1
		mat money[`r',`c']=r(mean)
		mat money[`r',`c'+1]=r(sd)
		local r=`r'+1
}
	local c=`c'+2
}

mat rownames money="Full Sample" "Died w/in 2 Yrs" ///
 "Persist Low" "Brief High (1st yr only)"  "Persist High"

matlist money

frmttable, statmat(money) varlabels title("Spending over time by Mortality & Expenditure Levels") ///
ctitles("" "Mean 12m" "SD" "Mean 2nd Yr" "SD" "Mean 24m" "SD") sdec(2) ///
 store(money)

outreg using "`logpath'\utilization_groups_2yr_spending", replay(money) replace


local n_models : word count `covars'

mat demo=J(`n_models',5,.)
local r=1

	

foreach v of local covars {
	sum `v'
	mat demo[`r',1]=r(mean)	
	if "`v'"=="age_at_core_n0" |"`v'"=="n_hp" | "`v'"=="hlphrs" {
		sum `v'
		mat demo[`r',1]=r(mean)	
		local c=2
		foreach x of local cat {
			sum `v' if `x'==1
			mat demo[`r',`c']=r(mean)
			ttest `v', by(`x')
			*mat demo[`r',`c'+1]=r(p)
			local c=`c'+1
}
		local r=`r'+1
}


	else {
		sum `v'
		mat demo[`r',1]=r(mean)*100
		local c=2
			foreach x of local cat {
				sum `v' if `x'==1
				mat demo[`r',`c']=r(mean)*100
				/*tab `v' `x', chi2
				mat demo[`r',`c'+1]=r(p)*/
			local c=`c'+1
}
		local r=`r'+1
}
}
mat rownames demo=`covars' 
frmttable, statmat(demo) store(demo) title("Characteristics by Mortality & Expenditure Levels, %") ///
ctitles("" "Full Sample" "Died w/in 2 Yrs" ///
 "Persist Low" "Brief High (1st yr only)"  "Persist High") varlabels 


mat n=J(1,5,.)

sum core_to_dod_1yr_n0
mat n[1,1]=r(N)

local c=2

foreach x of local cat {
	sum core_to_dod_1yr_n0 if `x'==1
	mat n[1,`c']=r(N)
	local c=`c'+1
}

mat rownames n="N"

frmttable, statmat(n) ///
ctitles("" "Full Sample" "Died w/in 2 Yrs" ///
 "Persist Low" "Brief High (1st yr only)"  "Persist High")sdec(0) store(n)
 
local sx_vars1 pain_hrs_n0 falls_hrs_n0 incont_hrs_n0 symptoms_ivw dyspnea_hrs_n0n1 swelling_feet_hrs_n0n1 ///
dizzy_hrs_n0n1 back_pain_hrs_n0n1 headache_hrs_n0n1 cough_hrs_n0n1 insom_symptoms_ivw 

//insomnia variables 1 = most of the time, 2 = sometimes, 3=rarely,never	
local sx_vars2 insom_falling_asleep_n0n1 insom_waking_up_n0n1 ///
	insom_too_early_n0n1 insom_rested_n0n1

local sxvars `sx_vars1' `sx_vars2'

local rownum : word count `sx_vars1' `sx_vars2' `sx_vars2' `sx_vars2'

//first part, criteria a
mat tab1 = J(`rownum',5,.)
mat tab1n = J(1,6,.)


la var pain_hrs_n0 "Often troubled by pain"
la var falls_hrs_n0 "Falls"
la var incont_hrs_n0 "Incontinence"
la var symptoms_ivw "Symptoms from n1 ivw"
la var dyspnea_hrs_n0n1 "Shortness of breath"
la var swelling_feet_hrs_n0n1 "Persistent swelling feet"
la var dizzy_hrs_n0n1 "Persistent dizziness"
la var back_pain_hrs_n0n1 "Back pain"
la var headache_hrs_n0n1 "Persistent headaches"
la var cough_hrs_n0n1 "Persistent cough"

la var insom_symptoms_ivw "Insomnia symptoms from n1 ivw"

local r=1
local c=2
foreach v of local sx_vars1 {
	sum `v'
	mat tab1[`r',1]=r(mean)*100
	local r=`r'+1
}

foreach x of local cat {
	local r=1
	foreach v of local sx_vars1 {
		sum `v' if `x'==1
		mat tab1[`r',`c']=r(mean)*100
		local r=`r'+1
}
	local c = `c'+1
}


foreach v in `sx_vars2'{
	tab `v',matcell(m_`v')
	local n_`v'=r(N)
	forvalues i = 1/3{
		mat tab1[`r',1]=m_`v'[`i',1]/`n_`v''*100 //percent
		local r = `r'+1
}
}

local c=2

foreach x of local cat {
local r=12
	foreach v in `sx_vars2'{
		tab `v' if `x'==1,matcell(m_`v')
		local n_`v'=r(N)
		forvalues i = 1/3 {
			mat tab1[`r',`c']=m_`v'[`i',1]/`n_`v''*100 //percent
			local r = `r'+1
}
}
	local c=`c'+1
}

mat rownames tab1=`sx_vars1' "Diff falling asleep most of time" "Some of time" ///
"Rarely / Never" "Wake up at night most of time" "Some of time" ///
"Rarely / Never" "Wake up too early most of time" "Some of time" ///
"Rarely / Never" "Feel really rested most of time" "Some of time" ///
"Rarely / Never" 

frmttable, statmat(tab1) store(tab1)  varlabels ///
ctitles("" "Full Sample" "Died w/in 2 Yrs" ///
 "Persist Low" "Brief High (1st yr only)"  "Persist High") sdec(2) ///
title("Symptoms by Mortality and Expenditure Levels, %")


outreg using "`logpath'\utilization_groups_2yr_spending", replay(demo) ///
append(n) addtable

outreg using "`logpath'\utilization_groups_2yr_spending", replay(tab1) addtable
mat tab=J(`n_models',9,.)

local r=1
local c=2

foreach v of local covars {
	sum `v' 
	if "`v'"=="age_at_core_n0" |"`v'"=="n_hp" | "`v'"=="hlphrs" {
		mat tab[`r',1]=r(mean)
}
	else {
		mat tab[`r',1]=r(mean)*100
}	
local r=`r'+1
}

foreach x in h_tot_1 h2_tot_1 p_hi p2_h {
	local r=1
	foreach v of local covars {
		sum `v' if `x'==1
		if "`v'"=="age_at_core_n0" |"`v'"=="n_hp" | "`v'"=="hlphrs" {
			mat tab[`r',`c']=r(mean)
}
		else {
			mat tab[`r',`c']=r(mean)*100
}
		ttest `v'=`=tab[`r',1]' if `x'==1
		mat tab[`r',`c'+1]=r(p)
		local r=`r'+1
}
	local c = `c'+2
}
mat rownames tab=`covars'


frmttable, statmat(tab) ctitles("" "Full Sample" "1yr, Full" "P" "No D 1yr" ///
"P" "High Full" "P" "No D 1yr" "P") varlabels



H="Prelim Regressions 24m spending"
capture log close

clear all
set more off

local logpath E:\data\serious_ill\logs
local datapath E:\data\serious_ill\final_data

log using "`logpath'\regs_inc_24m_symptoms_helper", text replace

cd `datapath'

use n0_n1_p1_p2_x_criteria_a_v1.dta if core_year_n0<2012

//gen vars used in fmm & ps matching
gen religvimp_n0=1 if imprelig_n0==1
replace religvimp_n0=0 if inlist(imprelig_n0,2,3,4)
tab religvimp_n0, missing

gen smi_any_n0=1 if smi_count_n0>0
replace smi_any_n0=0 if smi_count_n0==0
tab smi_any_n0, m

	//assign variable names for use in the tables
label var age_at_core_n0 "Age, mean"
label var networth_adj2012_n0 "Net worth, mean (SD)"
label var female "Female"
label var re_black "Black"
label var re_white "non-Hispanic White"
label var re_hisp "Hispanic"
label var re_other_unk "Other or Unknown"
label var educ_level_lt_hs "Less than HS Deg."

label var educ_level_hs "High school degree"
label var educ_level_somcol "Some college"
label var educ_level_col "Four year college deg."
label var srh_pf_n0 "SRH Poor/Fair"
label var srh_g_n0 "SRH Good"
label var srh_ve_n0 "SRH Very good/Excellent"

label var married_n0 "Married"
label var smi_dem_ind_n0 "Dementia"
label var smi_cancer_ind_n0 "Cancer"
label var smi_esrd_ind_n0 "ESRD"
label var smi_chf_ind_n0 "CHF"
label var smi_copd_ind_n0 "COPD"
label var religvimp_n0 "Religion v. Important"

label var smi_diab_compl_ind_n0 "Diabetes"
label var smi_liver_ind_n0 "Liver disease"
label var smi_als_ind_n0 "ALS"
label var smi_hip_ind_n0 "Hip Fracture"
label var el_ge3_comorb_1yr_n0 "3 or more comorbid conditions*"

label var ser_med_illness_n0 "Any serious medical illness"
label var adl_impair_core_n0 "ADL Impairment"
label var hlphrs "Total Helper Hours, mean"
label var n_hp "Total Number Helpers, mean"

label var smi_and_adl_n0 "Medical illness & ADL Impair."
label var smi_nh_ind_n0 "Nursing home resident"
label var ind_em_ur_adm_12m_n0 "Hospital admission"
label var adl_stable_ind_n0n1 "ADL Stable, independent"
label var adl_stable_partial_n0n1 "ADL Stable, partial dep."

label var adl_stable_severe_n0n1 "ADL Stable, severe dep."
label var adl_change_i_m_n0n1 "ADL Indep to Partial Dep"
label var adl_change_i_s_n0n1 "ADL Indep to Severe Dep"
label var adl_change_m_s_n0n1 "ADL Partial to Severe Dep"

label var hospital_care_intensity_n0 "HCI Index"


local cat core_to_dod_2yr_n0 p_low_ut brief_1st p_high

label var age_at_core_n0 "Age" 
label var n_hp "N Helpers"
label var hlphrs "Helper Hours"
local xvars age_cat_n0 female re_black re_hisp re_other married_n0 ///
hs_deg_ind nw_midlow_n0 nw_midhigh_n0 nw_highest_n0 ///
religvimp_n0 srh_g_n0 srh_ve_n0 rel_nb_n0 smi_nh_ind_n0 ///
medicaid_n0 champus_n0 medigap_n0 ///
ind_em_ur_adm_12m_n0 smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 ///
smi_diab_compl_ind_n0 smi_liver_ind_n0 adl_impair_core_n0 hlphrs ///
hospital_care_intensity_n0

outreg, clear

foreach x in tot_paid_by_mc_12m_wi_n0 tot_paid_by_mc_24m_wi_n0 {
	glm `x' `xvars' , link(log) family(gamma)
	outreg, merge varlabels
	glm `x' `xvars' if core_to_dod_1yr_n0==0, family(gamma) link(log)
	outreg, merge varlabels
}

foreach x in h_tot_1 p_hi {
	logit `x' `xvars', or
	*margins, dydx(*) post
	outreg, merge varlabels
	logit `x' `xvars' if core_to_dod_1yr_n0==0, or
	outreg, merge varlabels
}

outreg using "`logpath'\reg_results_2yr.rtf", replay varlabels ///
title("Regressions by Mortality & Expenditure Level") ///
ctitles("" "Tot 12m, Full" "No DOD 1yr" "Tot 24m, Full" "No DOD 1yr" ///
"Brief High, Full" "No DOD 1yr" "Persist High, Full" "No DOD 1yr") replace ///
note("GLM Regressions on 12 and 24m total medicare spending, Logistic regressions on high utilization categories")

logit p_hi `xvars', or
predict p1
outreg, varlabels

logit p_hi `xvars' if h_tot_1==1 & core_to_dod_1yr_n0==0, or
predict p2
outreg, merge varlabels

outreg using "`logpath'\reg_results_2yr.rtf", replay varlabels ///
title("Regressions by Mortality & Expenditure Level") ///
ctitles("" "Persist High, Full" "Conditional on 1yr Survival & 1 yr High Spending") ///
addtable

logit h_tot_2 `xvars' if core_to_dod_1yr_n0==0 
outreg, varlabels
logit h_tot_2 `xvars' h_tot_1 if core_to_dod_1yr_n0==0 
outreg, merge varlabels
logit h_tot_2 `xvars'  if core_to_dod_1yr_n0==0 & h_tot_1==1
outreg, merge varlabels

qui glm tot_paid_by_mc_24m_wi_n0 `xvars', fam(gamma) link(log)
qui outreg, varlabels
qui glm tot_paid_by_mc_24m_wi_n0 `xvars' if core_to_dod_1yr_n0==0, fam(gamma) link(log)
qui outreg, merge varlabels
qui glm tot_paid_by_mc_24m_wi_n0 `xvars' if core_to_dod_2yr_n0==0, fam(gamma) link(log)
qui outreg, merge varlabels
qui glm tot_paid_by_mc_24m_wi_n0 `xvars' if core_to_dod_2yr_n0==1, fam(gamma) link(log)
qui outreg, merge varlabels

outreg, replay ctitles("" "24m spending, full" "No DOD 1yr" "No DOD 2yr" "Yes DOD 2yr")

qui logit core_to_dod_1yr_n0 `xvars', or
qui outreg, varlabels
qui logit core_to_dod_2yr_n0 `xvars', or
outreg, varlabels merge


H="Mlogit, 24m spending"
capture log close

clear all
set more off

local logpath E:\data\serious_ill\logs
local datapath E:\data\serious_ill\final_data

log using "`logpath'\mlogit_inc_24m.txt", text replace

cd `datapath'

use n0_n1_p1_p2_x_criteria_a_v1.dta if core_year_n0<2012

//gen vars used in fmm & ps matching

generate livealone_n0=.
replace livealone_n0=1 if hhm_n0==0 & resspouse_n0==0
replace livealone_n0=0 if hhm_n0>0 | nhres_n0==1 | resspouse_n0==1
label variable livealone_n0 "Live Alone in Community n0"

gen religvimp_n0=imprelig_n0==1
tab religvimp_n0, missing

gen smi_any_n0=1 if smi_count_n0>0
replace smi_any_n0=0 if smi_count_n0==0
tab smi_any_n0, m

	//assign variable names for use in the tables
label var age_at_core_n0 "Age, mean"
label var networth_adj2012_n0 "Net worth, mean (SD)"
label var female "Female"
label var re_black "Black"
label var re_white "non-Hispanic White"
label var re_hisp "Hispanic"
label var re_other_unk "Other or Unknown"
label var educ_level_lt_hs "Less than HS Deg."

label var educ_level_hs "High school degree"
label var educ_level_somcol "Some college"
label var educ_level_col "Four year college deg."
label var srh_pf_n0 "SRH Poor/Fair"
label var srh_g_n0 "SRH Good"
label var srh_ve_n0 "SRH Very good/Excellent"

label var married_n0 "Married"
label var smi_dem_ind_n0 "Dementia"
label var smi_cancer_ind_n0 "Cancer"
label var smi_esrd_ind_n0 "ESRD"
label var smi_chf_ind_n0 "CHF"
label var smi_copd_ind_n0 "COPD"
label var religvimp_n0 "Religion v. Important"

label var smi_diab_compl_ind_n0 "Diabetes"
label var smi_liver_ind_n0 "Liver disease"
label var smi_als_ind_n0 "ALS"
label var smi_hip_ind_n0 "Hip Fracture"
label var el_ge3_comorb_1yr_n0 "3 or more comorbid conditions*"

label var ser_med_illness_n0 "Any serious medical illness"
label var adl_impair_core_n0 "ADL Impairment"
label var hlphrs "Total Helper Hours, mean"
label var n_hp "Total Number Helpers, mean"

label var smi_and_adl_n0 "Medical illness & ADL Impair."
label var smi_nh_ind_n0 "Nursing home resident"
label var ind_em_ur_adm_12m_n0 "Hospital admission"
label var adl_stable_ind_n0n1 "ADL Stable, independent"
label var adl_stable_partial_n0n1 "ADL Stable, partial dep."

label var adl_stable_severe_n0n1 "ADL Stable, severe dep."
label var adl_change_i_m_n0n1 "ADL Indep to Partial Dep"
label var adl_change_i_s_n0n1 "ADL Indep to Severe Dep"
label var adl_change_m_s_n0n1 "ADL Partial to Severe Dep"

label var hospital_care_intensity_n0 "HCI Index"


local cat core_to_dod_2yr_n0 p_low_ut brief_1st p_high

label var age_at_core_n0 "Age" 
label var n_hp "N Helpers"
label var hlphrs "Helper Hours"
local xvars age_cat_n0 i.female i.re_black i.re_hisp i.re_other i.married_n0 ///
i.hs_deg_ind i.nw_lowest_n0 ///
i.religvimp_n0 i.srh_pf_n0 i.livealone_n0 i.rel_nb_n0  i.smi_nh_ind_n0 ///
medicaid_n0 champus_n0 medigap_n0 ///
i.ind_em_ur_adm_12m_n0 i.smi_dem_ind_n0 i.smi_cancer_ind_n0 i.smi_esrd_ind_n0 ///
i.smi_chf_ind_n0 i.smi_copd_ind_n0 ///
i.smi_diab_compl_ind_n0 i.smi_liver_ind_n0 i.adl_impair_core_n0 hlphrs ///
bmi_n0 i.smoke_curr_n0 hospital_care_intensity_n0
/*
mlogit h_type `xvars'
margins, dydx(*) pr(outcome(1)) post
outreg, varlabels 

mlogit h_type `xvars'
margins, dydx(*) pr(outcome(2)) post
outreg, merge varlabels
mlogit h_type `xvars'
margins, dydx(*) pr(outcome(3)) post
outreg, merge varlabels
*/
gen l_tot_1=h_tot_1==0

qui logit p_l `xvars'
qui margins, dydx(*) post
qui outreg,  varlabels
qui logit h_tot_1 `xvars'
qui margins, dydx(*) post
qui outreg, merge varlabels
qui logit h_tot_1 `xvars' if p_high==0
qui margins, dydx(*) post
qui outreg, merge varlabels
qui logit p_high `xvars'
qui margins, dydx(*) post
qui outreg, merge varlabels
qui logit p_high `xvars' if h_tot_1==1
qui margins, dydx(*) post
qui outreg, merge varlabels 

outreg, replay ctitles("" "Persist Low" "Brief High" "Brief High (no p)" ///
 "Persist High" "Persist High conditional")

logit p_l `xvars'
outreg, varlabels
logit h_tot_1 `xvars'
outreg, merge varlabels
logit p_high `xvars'
outreg, merge varlabels
logit p_high `xvars' if core_to_dod_1yr_n0==0
outreg, merge varlabels
reg tot_paid_by_mc_12m_wi_n0 `xvars'
outreg, merge varlabels
reg tot_paid_by_mc_24m_wi_n0 `xvars'
outreg, merge varlabels

outreg, replay varlabels ctitles("" "low" "brief hi


H="xxxxlooking at 24m spending for all****"
cd E:\data\surgery_hysterectomy\int_2012clms

use "E:\data\surgery_hysterectomy\int_2012clms\core_2000_2012.dta", clear 
keep hhid pn id core_year c_ivw_date
merge m:1 hhid pn using "E:\data\surgery_hysterectomy\int_2012clms\cmsxref2012.dta", ///
keep(match) keepusing(bid)

gen rate=.



local days 30 60 90 183 365 730
local source op pb dm hh hs
levelsof core_year, local(years)
drop _m

/*
foreach x in `years' {
	
	preserve
	di `x'
	keep if core_year==`x'
	merge 1:m bid_hrs_21 using mp_2000_2012.dta, ///
	 keep(match) keepusing(admit_date disch_date pmt_amt ssl passthru)
	gen core_to_admit=admit_date-c_ivw_date
	gen core_to_disch=disch_date-c_ivw_date
	gen los=disch_date-admit_date
	replace los=1 if los==0
	
	replace rate=1 if year(admit_date)>=2012
	replace rate=1.03902 if year(admit_date)==2011 
	replace rate=1.07086 if year(admit_date)==2010 
	replace rate=1.10835 if year(admit_date)==2009 
	replace rate=1.1439 if year(admit_date)==2008 
	replace rate=1.1923 if year(admit_date)==2007 
	replace rate=1.25586 if year(admit_date)==2006 
	replace rate=1.30783 if year(admit_date)==2005 
	replace rate=1.37027 if year(admit_date)==2004 
	replace rate=1.43908 if year(admit_date)==2003 
	replace rate=1.50337 if year(admit_date)==2002 
	replace rate=1.57963 if year(admit_date)==2001 
	replace rate=1.65519 if year(admit_date)==2000 
	replace rate=1.72641 if year(admit_date)<=1999 

	replace pmt_amt=pmt_amt+passthru
	replace pmt_amt=pmt_amt*rate

	foreach d of local days {
		gen in_n`d'=core_to_admit>=-`d' & core_to_disch<=0
		gen in_p`d'=core_to_admit>=0 & core_to_disch<=`d'
		replace in_n`d'=-(core_to_admit/los) if core_to_disch>=0& core_to_admit<=0
		replace in_p`d'=core_to_disch/los if core_to_disch>=0 & core_to_admit<=0
		replace in_n`d'=(`d'+core_to_disch)/los if core_to_disch>=-`d' & core_to_disch<=0 & core_to_admit<=-`d'
		replace in_p`d'=(`d'-core_to_admit)/los if core_to_disch>=`d' & core_to_admit<=`d' & core_to_admit>=0
		gen ip1_amt_paid_n`d'=in_n`d'*pmt_amt if ssl!="N"
		gen ip1_amt_paid_p`d'=in_p`d'*pmt_amt if ssl!="N"
		gen sn1_amt_paid_n`d'=in_n`d'*pmt_amt if ssl=="N"
		gen sn1_amt_paid_p`d'=in_p`d'*pmt_amt if ssl=="N"
		foreach t in ip sn {
			egen `t'_amt_paid_n`d'=total(`t'1_amt_paid_n`d'), by(id)
			egen `t'_amt_paid_p`d'=total(`t'1_amt_paid_p`d'), by(id)
}
}
	drop _m admit_date disch_date pmt_amt core_to_admit core_to_disch ///
	 los in_n* in_p* *1_amt_paid_* ssl rate
	duplicates drop
	collapse ip* sn*, by(id core_year c_ivw_date)

	save mp_`x', replace
	
	restore
}


foreach s of local source {
	di "`s'"
	foreach x in `years' {
		preserve
		di `x'
		keep if core_year==`x'

		merge 1:m bid_hrs_21 using `s'_2000_2012.dta, ///
		 keep(match) keepusing(admit_date disch_date pmt_amt)

		gen core_to_admit=admit_date-c_ivw_date
		gen core_to_disch=disch_date-c_ivw_date
		drop if core_to_admit>730
		drop if core_to_disch<-730
		gen los=disch_date-admit_date
		replace los=1 if los==0
		
		replace rate=1 if year(admit_date)>=2012
		replace rate=1.03902 if year(admit_date)==2011 
		replace rate=1.07086 if year(admit_date)==2010 
		replace rate=1.10835 if year(admit_date)==2009 
		replace rate=1.1439 if year(admit_date)==2008 
		replace rate=1.1923 if year(admit_date)==2007 
		replace rate=1.25586 if year(admit_date)==2006 
		replace rate=1.30783 if year(admit_date)==2005 
		replace rate=1.37027 if year(admit_date)==2004 
		replace rate=1.43908 if year(admit_date)==2003 
		replace rate=1.50337 if year(admit_date)==2002 
		replace rate=1.57963 if year(admit_date)==2001 
		replace rate=1.65519 if year(admit_date)==2000 
		replace rate=1.72641 if year(admit_date)<=1999 
		
		replace pmt_amt=pmt_amt*rate

		foreach d of local days {
			gen in_n`d'=core_to_admit>=-`d' & core_to_disch<=0
			gen in_p`d'=core_to_admit>=0 & core_to_disch<=`d'
			replace in_n`d'=-(core_to_admit/los) if core_to_disch>=0& core_to_admit<=0
			replace in_p`d'=core_to_disch/los if core_to_disch>=0 & core_to_admit<=0
			replace in_n`d'=(`d'+core_to_disch)/los if core_to_disch>=-`d' & core_to_disch<=0 & core_to_admit<=-`d'
			replace in_p`d'=(`d'-core_to_admit)/los if core_to_disch>=`d' & core_to_admit<=`d' & core_to_admit>=0

			gen amt_paid_n`d'=in_n`d'*pmt_amt
			gen amt_paid_p`d'=in_p`d'*pmt_amt
			by id c_ivw_date, sort: egen `s'_amt_paid_n`d'=total(amt_paid_n`d')
			by id c_ivw_date, sort: egen `s'_amt_paid_p`d'=total(amt_paid_p`d')
	}
		drop _m admit_date disch_date pmt_amt core_to_admit core_to_disch ///
		 los in_n* in_p* amt_paid_* rate
		duplicates drop
		save `s'_`x', replace
		restore
}
}
*/

clear
local source2 mp op pb hs hh dm 
local source3 ip op pb hs hh dm sn

foreach s of local source2 {
	foreach x of local years {
		if `x'==1998 {
			use `s'_`x'
}
		else  {
			append using `s'_`x'
}
}
	save `s'_paid_1998_2012, replace
}

foreach s of local source2 {
	if "`s'"=="mp" {
		use `s'_paid_1998_2012, clear
}
	else {
		merge 1:1 id core_year using `s'_paid_1998_2012, nogen
}
}

foreach d of local days {
	gen tot_paid_by_mc_n`d'=0
	gen tot_paid_by_mc_p`d'=0
	foreach s of local source3 {
		replace `s'_amt_paid_n`d'=0 if `s'_amt_paid_n`d'==.
		replace `s'_amt_paid_p`d'=0 if `s'_amt_paid_p`d'==.
		replace tot_paid_by_mc_n`d'=tot_paid_by_mc_n`d'+`s'_amt_paid_n`d'
		replace tot_paid_by_mc_p`d'=tot_paid_by_mc_p`d'+`s'_amt_paid_p`d'
}
}

save mc_clms_730_days_1998_2012, replace



/* and now sas, which doesn't work for reasons i don't understand.
/*Add total Medicare payments from claims 1 year after interview
and 6m after interview*/

/*Claims files from 2000-2012, claims pulled in previous section
to get just claims that are within 1 year of the interview dates
for those interviews were r>65 and ffs medicare 1 yr prior to ivw*/

/**********************************************************/
/**********************************************************/
/*totals from mp file*/
/*Note: variable SSLSSNF from mp claims is N=Skilled nursing facility*/
/*Two totals are calculated - one for skilled nursing facility claims
and one for all other claims in the mp file (inpatient claims)*/
/**********************************************************/
/**********************************************************/

/*if wage index is missing, set to 1 and identify with an indicator variable*/
libname sic "E:\data\serious_ill\int_data";
/*hrs cleaned path*/
libname hrs_fnl 'E:\data\hrs_cleaned';

/*medicare xwalk and claims path*/
libname medi 'E:\data\cms_DUA_24548_2012';


data core_id;
set sic.core_age_zip_wi_da; 
if wage_index_2012_2=. then do;
	wage_index_missing_yes = 1;
	wage_index_2012_2 = 1;
end;
run; 


data crosswalk_1;
set medi.cmsxref2012;
keep bid_hrs_21 hhid pn;
run;

data crosswalk_2;
set crosswalk_1;
bid_hrs=bid_hrs_21;
id=trim(hhid)||trim(pn);
drop hhid pn;
drop bid_hrs_21;
run;

/*bring in xwalk id to core interview dataset*/
proc sql;
create table core_merged as select
a.c_ivw_date,a.core_year,a.id,b.bid_hrs,a.wage_index_2012_2,a.age_at_core,wage_index_missing_yes,b.* from
core_id a
left join
crosswalk_2 b
on a.id=b.id;
quit;


%macro mp(days_start=,days_after_core=,source=,time_label=);

proc sql;
create table &source._meet_post as select a.*,b.c_ivw_date,b.core_year
from medi.&source._2000_2012 a inner join
core_merged b
on trim(left(a.bid_hrs_21))=trim(left(b.bid_hrs))
and &days_start<=a.disch_date-b.c_ivw_date<=&days_after_core;
quit; 

proc sql;
create table &source._meet2_post as select a.*,b.c_ivw_date,b.core_year
from medi.&source._2000_2012 a inner join
core_merged b
on trim(left(a.bid_hrs_21))=trim(left(b.bid_hrs))
and a.disch_date-b.c_ivw_date>&days_after_core and a.admit_date-b.c_ivw_date<=&days_after_core;
quit;

data &source._meet3_post_&days_after_core.;
set &source._meet_post &source._meet2_post;
format admit_date date9. disch_date date9.;
run;

%mend;

%macro other(days_start=,days_after_core=,source= );

proc sql;
create table &source._meet_post_&days_after_core. as select 
a.*,b.c_ivw_date,b.core_year
from medi.&source._2000_2012(keep=admit_date BID_hrs_21 pmt_amt) a inner join
core_merged b
on trim(left(a.bid_hrs_21))=trim(left(b.bid_hrs))
and &days_start<=a.admit_date-b.c_ivw_date<=&days_after_core;
quit;

%mend;


/*2 year claims lists*/
%mp(days_start=0,days_after_core=730,source=mp );
%other(days_start=0,days_after_core=730,source=op );
%other(days_start=0,days_after_core=730,source=pb );
%other(days_start=0,days_after_core=730,source=hh );
%other(days_start=0,days_after_core=730,source=hs );
%other(days_start=0,days_after_core=730,source=dm );


/*1 year claims lists*/
%mp(days_start=0,days_after_core=365,source=mp );
%other(days_start=0,days_after_core=365,source=op );
%other(days_start=0,days_after_core=365,source=pb );
%other(days_start=0,days_after_core=365,source=hh );
%other(days_start=0,days_after_core=365,source=hs );
%other(days_start=0,days_after_core=365,source=dm );

/*6 months claims lists*/
%mp(days_start=0,days_after_core=183,source=mp );
%other(days_start=0,days_after_core=183,source=op );
%other(days_start=0,days_after_core=183,source=pb );
%other(days_start=0,days_after_core=183,source=hh );
%other(days_start=0,days_after_core=183,source=hs );
%other(days_start=0,days_after_core=183,source=dm );



%macro mp(month_n=,days_start=,days_after_core=,source=,equ=,name=);
%let source0=mp;

/*Case 1 - no adjustment needed - claims where entire claim is within the x months after the interview*/
proc sql;
create table &source._meet_post_1 as select *
from &source0._meet3_post_&days_after_core.(where=(trim(left(SSLSSNF))&equ.="N")) 
where &days_start<=disch_date-c_ivw_date<=&days_after_core and
&days_start<=admit_date-c_ivw_date<=&days_after_core;
quit;

data zz_&source._meet_post_1;
set &source._meet_post_1;
ivw_to_admit=admit_date-c_ivw_date;
ivw_to_disch=disch_date-c_ivw_date;
run;
proc means; var ivw_to_admit ivw_to_disch; run;

/*Case 2 - adjustment needed because part of stay is in the window but part is after the window has ended
Claims with admission date within start of x months but discharge date is after the x month window*/
proc sql;
create table &source._meet2_post as select *
from &source0._meet3_post_&days_after_core.(where=(trim(left(SSLSSNF))&equ.="N")) 
where disch_date-c_ivw_date>&days_after_core and 0<=admit_date-c_ivw_date<=&days_after_core;
quit;

data zz_&source._meet2_post;
set &source._meet2_post;
ivw_to_admit=admit_date-c_ivw_date;
ivw_to_disch=disch_date-c_ivw_date;
run;
proc means; var ivw_to_admit ivw_to_disch; run;


/*identify fraction of claims that span x month period that should be 
attributed to the x month period
by just using the fraction of time that was included in the span*/
data &source._meet3_post;
set &source._meet2_post;
pct_xm=((c_ivw_date+&days_after_core)-admit_date)/(disch_date-admit_date);
array list pmt_amt passthru;
do over list;
if list=. then list=0;
/*scale the partial claims by the time within the x month period*/
list=list*pct_xm;
end;

run;

/*Case 3 - adjustment needed because part of stay is in the window but part is before the window started
Claims with discharge date within start of x months but admit date is before the interview date*/
proc sql;
create table &source._meet4_post as select *
from &source0._meet3_post_&days_after_core.(where=(trim(left(SSLSSNF))&equ.="N")) 
where disch_date-c_ivw_date<=&days_after_core and admit_date-c_ivw_date<&days_start;
quit;

data zz_&source._meet4_post;
set &source._meet4_post;
ivw_to_admit=admit_date-c_ivw_date;
ivw_to_disch=disch_date-c_ivw_date;
run;
proc means; var ivw_to_admit ivw_to_disch; run;


data &source._meet5_post;
set &source._meet4_post;
pct_xm=(disch_date-c_ivw_date)/(disch_date-admit_date);
array list pmt_amt passthru;
do over list;
if list=. then list=0;
/*scale the partial claims by the time within the x month period*/
list=list*pct_xm;
end;

run;

/*adjust for inflation, Uses CPI for Medical Services from 
BLS website, accessed 5/4/2015*/

/*create table merging both the claims fully in the 2 year period 
and those partially in that time
adjust for inflation here also*/
data &source._cost_post;
set &source._meet_post_1 &source._meet3_post &source._meet5_post;
array list pmt_amt passthru;
do over list;
if list=. then list=0;
end;

if year(admit_date)>=2012 then rate=1;
if year(admit_date)=2011 then rate=1.03902;
if year(admit_date)=2010 then rate=1.07086;
if year(admit_date)=2009 then rate=1.10835;
if year(admit_date)=2008 then rate=1.1439;
if year(admit_date)=2007 then rate=1.1923;
if year(admit_date)=2006 then rate=1.25586;
if year(admit_date)=2005 then rate=1.30783;
if year(admit_date)=2004 then rate=1.37027;
if year(admit_date)=2003 then rate=1.43908;
if year(admit_date)=2002 then rate=1.50337;
if year(admit_date)=2001 then rate=1.57963;
if year(admit_date)=2000 then rate=1.65519;
if year(admit_date)<=1999 then rate=1.72641;


&source._paid_by_mc=rate*(pmt_amt+passthru);
run;

*calculates total of mc charges for the claim type by hrs bid;
proc sql;
create table &source._pay_post as select distinct bid_hrs_21,core_year,
sum(&source._paid_by_mc) as &source._paid_by_mc 
from &source._cost_post group by BID_HRS_21,core_year;
quit;

*merges the totals above with the full interview list;
proc sql;
create table &source._&name. as select
a.BID_hrs,a.id,a.core_year,coalesce(b.&source._paid_by_mc,0) as &source._paid_by_mc_&name.
from core_merged a
left join
 &source._pay_post b
 on trim(left(a.BID_hrs))=trim(left(b.bid_hrs_21)) and a.core_year=b.core_year;
 quit;

 proc sort data=&source._&name. ;
 by BID_hrs core_year;
 run;
%mend;

/*Runs macro to get total for the SNF claims*/
%mp(days_start=0,days_after_core=730,source=snf,equ=,name=24m );
%mp(days_start=0,days_after_core=365,source=snf,equ=,name=12m );
%mp(days_start=0,days_after_core=183,source=snf,equ=,name=6m );
/*Runs macro to get total for the inpatient (not SNF) claims*/
%mp(days_start=0,days_after_core=730,source=ip,equ=~,name=24m );
%mp(days_start=0,days_after_core=365,source=ip,equ=~,name=12m );
%mp(days_start=0,days_after_core=183,source=ip,equ=~,name=6m );

/**********************************************************/
/**********************************************************/
/*totals from other claim types*/
/**********************************************************/
/**********************************************************/
/*macro to calculate totals for the claims that are not in medpar files*/
%macro all_other(source=,month_n=,days_start=,days_after_core=);

/*Adjust for inflation*/
data &source._meet2_post;
set &source._meet_post_&days_after_core.;
/*adjust to 2012 dollars*/
if year(admit_date)>=2012 then rate=1;
if year(admit_date)=2011 then rate=1.03902;
if year(admit_date)=2010 then rate=1.07086;
if year(admit_date)=2009 then rate=1.10835;
if year(admit_date)=2008 then rate=1.1439;
if year(admit_date)=2007 then rate=1.1923;
if year(admit_date)=2006 then rate=1.25586;
if year(admit_date)=2005 then rate=1.30783;
if year(admit_date)=2004 then rate=1.37027;
if year(admit_date)=2003 then rate=1.43908;
if year(admit_date)=2002 then rate=1.50337;
if year(admit_date)=2001 then rate=1.57963;
if year(admit_date)=2000 then rate=1.65519;
if year(admit_date)<=1999 then rate=1.72641;

&source._paid_by_mc=rate*(pmt_amt);
run;

/*Calculate total mc payments by ID*/
proc sql;
create table &source._pay_post as select distinct BID_hrs_21,core_year,
sum(&source._paid_by_mc) as &source._paid_by_mc
from &source._meet2_post group by BID_hrs_21,core_year;
quit;

/*merge in mc totals with interview list*/
proc sql;
create table &source.&month_n._post as select
a.BID_hrs,a.id,a.core_year,coalesce(b.&source._paid_by_mc,0) as &source._paid_by_mc&month_n 
from core_merged a
left join
 &source._pay_post b
 on trim(left(a.BID_hrs))=trim(left(b.BID_hrs_21)) and a.core_year=b.core_year;
 quit;

 proc sort data=&source&month_n._post ;
 by BID_hrs core_year;
 run;
 %mend all_other;
/******************************************************************/
/* Run the macro over the mc claims files for 2 years prior to death*/
/******************************************************************/
 %all_other(source=op,month_n=_24m,days_start=0,days_after_core=730);
  %all_other(source=pb,month_n=_24m,days_start=0,days_after_core=730);
   %all_other(source=hh,month_n=_24m,days_start=0,days_after_core=730);
    %all_other(source=hs,month_n=_24m,days_start=0,days_after_core=730);
     %all_other(source=dm,month_n=_24m,days_start=0,days_after_core=730);

 %all_other(source=op,month_n=_12m,days_start=0,days_after_core=365);
  %all_other(source=pb,month_n=_12m,days_start=0,days_after_core=365);
   %all_other(source=hh,month_n=_12m,days_start=0,days_after_core=365);
    %all_other(source=hs,month_n=_12m,days_start=0,days_after_core=365);
     %all_other(source=dm,month_n=_12m,days_start=0,days_after_core=365);

 %all_other(source=op,month_n=_6m,days_start=0,days_after_core=183);
  %all_other(source=pb,month_n=_6m,days_start=0,days_after_core=183);
   %all_other(source=hh,month_n=_6m,days_start=0,days_after_core=183);
    %all_other(source=hs,month_n=_6m,days_start=0,days_after_core=183);
     %all_other(source=dm,month_n=_6m,days_start=0,days_after_core=183);

/******************************************************************/
/* Merge into single file, by id and interview */
/******************************************************************/
*first merge 12m and 6m spending into single dataset;
data mc_costs_all;
merge ip_24m snf_24m hh_24m_post hs_24m_post pb_24m_post op_24m_post dm_24m_post
ip_12m snf_12m hh_12m_post hs_12m_post pb_12m_post op_12m_post dm_12m_post
 ip_6m snf_6m hh_6m_post hs_6m_post pb_6m_post op_6m_post dm_6m_post;
by BID_hrs core_year;
run;


/******************************************************************/
/* Adjust for the wage index */
/******************************************************************/

data wi;
set core_merged;
where bid_hrs~=' ';
keep wage_index_2012_2 wage_index_missing_yes bid_hrs core_year;
run;

data mc_costs_all_1;
set mc_costs_all;
where bid_hrs~=' ';
run;

*add wage index to the costs totals files;
proc sql;
create table mc_costs_all_wi_1(drop=bid_hrs2 core_year2) as select *
from mc_costs_all_1 a left join
wi(rename=(bid_hrs=bid_hrs2) rename=(core_year=core_year2)) b
on a.bid_hrs=b.bid_hrs2 and a.core_year=b.core_year2;
quit;

%macro wage_ind(source=);
data mc_costs_all_wi_2;
set mc_costs_all_wi_1;
&source._paid_by_mc_24m_wi = &source._paid_by_mc_24m / wage_index_2012_2;
&source._paid_by_mc_12m_wi = &source._paid_by_mc_12m / wage_index_2012_2;
&source._paid_by_mc_6m_wi = &source._paid_by_mc_6m / wage_index_2012_2;
run;
%mend;

%wage_ind(source=ip);
%wage_ind(source=snf);
 %wage_ind(source=op);
  %wage_ind(source=pb);
   %wage_ind(source=hh);
    %wage_ind(source=hs);
     %wage_ind(source=dm);

/******************************************************************/
/* Get totals across all claim types */
/******************************************************************/

data mc_costs_12m_6m;
set mc_costs_all_wi_2;
/*total not adjusted for wage index*/
tot_paid_by_mc_24m=sum(of ip_paid_by_mc_24m snf_paid_by_mc_24m hh_paid_by_mc_24m hs_paid_by_mc_24m
pb_paid_by_mc_24m op_paid_by_mc_24m dm_paid_by_mc_24m);

tot_paid_by_mc_12m=sum(of ip_paid_by_mc_12m snf_paid_by_mc_12m hh_paid_by_mc_12m hs_paid_by_mc_12m
pb_paid_by_mc_12m op_paid_by_mc_12m dm_paid_by_mc_12m);

tot_paid_by_mc_6m=sum(of ip_paid_by_mc_6m snf_paid_by_mc_6m hh_paid_by_mc_6m hs_paid_by_mc_6m
pb_paid_by_mc_6m op_paid_by_mc_6m dm_paid_by_mc_6m);

/*wage index adjusted*/
tot_paid_by_mc_24m_wi=sum(of ip_paid_by_mc_24m_wi snf_paid_by_mc_24m_wi hh_paid_by_mc_24m_wi hs_paid_by_mc_24m_wi
pb_paid_by_mc_24m_wi op_paid_by_mc_24m_wi dm_paid_by_mc_24m_wi);

tot_paid_by_mc_12m_wi=sum(of ip_paid_by_mc_12m_wi snf_paid_by_mc_12m_wi hh_paid_by_mc_12m_wi hs_paid_by_mc_12m_wi
pb_paid_by_mc_12m_wi op_paid_by_mc_12m_wi dm_paid_by_mc_12m_wi);

tot_paid_by_mc_6m_wi=sum(of ip_paid_by_mc_6m_wi snf_paid_by_mc_6m_wi hh_paid_by_mc_6m_wi hs_paid_by_mc_6m_wi
pb_paid_by_mc_6m_wi op_paid_by_mc_6m_wi dm_paid_by_mc_6m_wi);

/*label variables*/
label tot_paid_by_mc_24m="Medicare payment total 2 years following interview"
ip_paid_by_mc_24m="IP Medicare payments 2 years following interview" 
snf_paid_by_mc_24m="SNF Medicare payments 2 years following interview"
hh_paid_by_mc_24m="Home health Medicare payments 2 years following interview" 
hs_paid_by_mc_24m="Hospice Medicare payments 2 years following interview"
pb_paid_by_mc_24m="Carrier Medicare payments 2 years following interview" 
op_paid_by_mc_24m="OP Medicare payments 2 years following interview" 
dm_paid_by_mc_24m="DME Medicare payments 2 years following interview"

tot_paid_by_mc_24m_wi="WI adj Medicare payment total 2 years following interview"
ip_paid_by_mc_24m_wi="WI adj IP Medicare payments 2 years following interview" 
snf_paid_by_mc_24m_wi="WI adj SNF Medicare payments 2 years following interview"
hh_paid_by_mc_24m_wi="WI adj Home health Medicare payments 2 years following interview" 
hs_paid_by_mc_24m_wi="WI adj Hospice Medicare payments 2 years following interview"
pb_paid_by_mc_24m_wi="WI adj Carrier Medicare payments 2 years following interview" 
op_paid_by_mc_24m_wi="WI adj OP Medicare payments 2 years following interview" 
dm_paid_by_mc_24m_wi="WI adj DME Medicare payments 2 years following interview"
;
/*label variables*/
label tot_paid_by_mc_12m="Medicare payment total 1 year following interview"
ip_paid_by_mc_12m="IP Medicare payments 1 year following interview" 
snf_paid_by_mc_12m="SNF Medicare payments 1 year following interview"
hh_paid_by_mc_12m="Home health Medicare payments 1 year following interview" 
hs_paid_by_mc_12m="Hospice Medicare payments 1 year following interview"
pb_paid_by_mc_12m="Carrier Medicare payments 1 year following interview" 
op_paid_by_mc_12m="OP Medicare payments 1 year following interview" 
dm_paid_by_mc_12m="DME Medicare payments 1 year following interview"

tot_paid_by_mc_12m_wi="WI adj Medicare payment total 1 year following interview"
ip_paid_by_mc_12m_wi="WI adj IP Medicare payments 1 year following interview" 
snf_paid_by_mc_12m_wi="WI adj SNF Medicare payments 1 year following interview"
hh_paid_by_mc_12m_wi="WI adj Home health Medicare payments 1 year following interview" 
hs_paid_by_mc_12m_wi="WI adj Hospice Medicare payments 1 year following interview"
pb_paid_by_mc_12m_wi="WI adj Carrier Medicare payments 1 year following interview" 
op_paid_by_mc_12m_wi="WI adj OP Medicare payments 1 year following interview" 
dm_paid_by_mc_12m_wi="WI adj DME Medicare payments 1 year following interview"
;

label tot_paid_by_mc_6m="Medicare payment total 6 months following interview"
ip_paid_by_mc_6m="IP Medicare payments 6 months following interview" 
snf_paid_by_mc_6m="SNF Medicare payments 6 months following interview"
hh_paid_by_mc_6m="Home health Medicare payments 6 months following interview" 
hs_paid_by_mc_6m="Hospice Medicare payments 6 months following interview"
pb_paid_by_mc_6m="Carrier Medicare payments 6 months following interview" 
op_paid_by_mc_6m="OP Medicare payments 6 months following interview" 
dm_paid_by_mc_6m="DME Medicare payments 6 months following interview"

tot_paid_by_mc_6m_wi="WI adj Medicare payment total 6 months following interview"
ip_paid_by_mc_6m_wi="WI adj IP Medicare payments 6 months following interview" 
snf_paid_by_mc_6m_wi="WI adj SNF Medicare payments 6 months following interview"
hh_paid_by_mc_6m_wi="WI adj Home health Medicare payments 6 months following interview" 
hs_paid_by_mc_6m_wi="WI adj Hospice Medicare payments 6 months following interview"
pb_paid_by_mc_6m_wi="WI adj Carrier Medicare payments 6 months following interview" 
op_paid_by_mc_6m_wi="WI adj OP Medicare payments 6 months following interview" 
dm_paid_by_mc_6m_wi="WI adj DME Medicare payments 6 months following interview"
;
run;


*merge into overall dataset*;
proc sql;
create table core_ids_init_outcomes_2(drop=bid_hrs2 id2 core_year2 wi) as select * from
core_merged a left join
mc_costs_12m_6m(rename=(bid_hrs=bid_hrs2) rename=(id=id2) rename=(core_year=core_year2) rename=(wage_index_2012_2=wi)) b
on trim(left(a.bid_hrs))=trim(left(b.bid_hrs2)) and a.core_year=b.core_year2;
quit;

proc export data=core_ids_init_outcomes_2 outfile="E:\data\Evan_SAS_practice\mc_costs_by_ivw_all.dta" replace;
run;


H="spending distribution for HSR revision"
cd "E:\data\serious_ill\logs"

use "E:\data\serious_ill\final_data\n0_n1_p1_p2_x_criteria_2008_v1.dta", clear
gen crit="2008"
gen crit_exclusive="2008, does not meet criteria" if criteria_a_n0==0
drop dod_claims*
append using  "E:\data\serious_ill\final_data\n0_n1_p1_p2_x_criteria_a_v1.dta"
replace crit="Criteria A" if crit==""
drop dod_claims*
replace crit_exclusive="Criteria A only" if crit=="Criteria A" & criteria_b_n0==0
append using  "E:\data\serious_ill\final_data\n0_n1_p1_p2_x_criteria_b_v1.dta"
replace crit="Criteria B" if crit==""
replace crit_exclusive="Criteria B only" if crit=="Criteria B" & criteria_c_n0==0
append using  "E:\data\serious_ill\final_data\n0_n1_p1_p2_x_criteria_c_v1.dta"
replace crit="Criteria C" if crit==""
replace crit_exclusive="Criteria C" if crit=="Criteria C"
gen tot=tot_paid_by_mc_12m_wi_n0
replace tot=100000 if tot>100000

drop if core_year_n0==2012

label var crit "Criteria"
label var crit_exclusive "Criteria, Exclusive"
label var tot "WI adj Total Spending by Medicare"

mat crit=J(8,4,.)
mat crit_exclusive=J(8,4,.)
local r=1
local c=1

foreach x in crit crit_exclusive {
	rename `x' `x'2
	encode `x'2, gen(`x')
	drop `x'2
	di "`x'"
	forvalues i=1/4 { 
		sum tot_paid_by_mc_12m_wi_n0 if `x'==`i'
}
}

foreach x in crit crit_exclusive {
	di "`x'"
	forvalues i=1/4 { 
		sum tot_paid_by_mc_12m_wi_n0 if `x'==`i',d
		mat `x'[1,`c']=r(mean)
		mat `x'[2,`c']=r(p50)
		mat `x'[3,`c']=r(p5)
		mat `x'[4,`c']=r(p10)
		mat `x'[5,`c']=r(p25)
		mat `x'[6,`c']=r(p75)
		mat `x'[7,`c']=r(p90)
		mat `x'[8,`c']=r(p95)
		local c=`c'+1
}
	local c=1
	mat rownames `x'="Mean" "Median" "5th Percentile" "10th" "25th" "75th" "90th" "95th"
}

frmttable using "E:\data\serious_ill\logs\spending_distribution_tables.rtf", ///
statmat(crit) ctitles("" "2008" "Criteria A" "Criteria B" "Criteria C") ///
title("Total Medicare Expenditures") replace

frmttable using "E:\data\serious_ill\logs\spending_distribution_tables.rtf", ///
statmat(crit_exclusive) ctitles("" "2008" "Criteria A" "Criteria B" "Criteria C") ///
title("Total Medicare Expenditures, Exclusive") addtable

hist tot, by(crit) bin(41) percent
graph save "E:\data\serious_ill\logs\spending distribution", replace
hist tot, by(crit_exclusive) bin(41) percent
graph save "E:\data\serious_ill\logs\spending distribution exclusive", replace

foreach i in 1 {
*log using "E:\data\serious_ill\logs\spending distribution.txt", text replace
foreach x in crit crit_exclusive {
	di "`x'"
	forvalues i=1/4 { 
		sum tot_paid_by_mc_12m_wi_n0 if `x'==`i'
}
}



foreach x in crit crit_exclusive {
	di "`x'"
	forvalues i=1/4 { 
		sum tot_paid_by_mc_12m_wi_n0 if `x'==`i',d
}
}
}
forvalues i=1/4 {
cumul tot_paid_by_mc_12m_wi_n0 if crit==`i', gen(c`i')
cumul tot_paid_by_mc_12m_wi_n0 if crit_e==`i', gen(ce`i')
}

gen criteria=criteria_a_n0
replace criteria=2 if criteria_b_n0==1
replace criteria=3 if criteria_c_n0==1
forvalues i=0/3 {
cumul tot_paid_by_mc_12m_wi_n0 if crit==1 & criteria==`i', gen(c2008`i')
}

twoway (line tot c20080, sort) (line tot c20081, sort) (line tot c20082, sort) ///
(line tot c20083, sort), ///
 title("Cumulative distribution of Spending by Criteria, 2008 only") legend(label(1 "Does not meet") ///
 label(2 "Criteria A") label(3  "Criteria B") label(4  "Criteria C")) xlab(#11)
graph save "E:\data\serious_ill\logs\spending distribution 2008", replace

twoway (line tot_paid_by_mc_12m_wi_n0 c1, sort) (line tot_paid_by_mc_12m_wi_n0 c2, sort) (line tot_paid_by_mc_12m_wi_n0 c3, sort) ///
(line tot_paid_by_mc_12m_wi_n0 c4, sort), ///
 title("Cumulative distribution of Spending by Criteria") legend(label(1 "2008") ///
 label(2 "Criteria A") label(3  "Criteria B") label(4  "Criteria C")) xlab(#11)
graph save "E:\data\serious_ill\logs\spending distribution 1", replace  
  
twoway (line tot_paid_by_mc_12m_wi_n0 ce1, sort) (line tot_paid_by_mc_12m_wi_n0 ce2, sort) (line tot_paid_by_mc_12m_wi_n0 ce3, sort) ///
(line tot_paid_by_mc_12m_wi_n0 ce4, sort), ///
 title("Cumulative distribution of Spending by Criteria, Exclusive") legend(label(1 "2008") ///
  label(2 "Criteria A") label(3  "Criteria B") label(4  "Criteria C")) xlab(#11)
graph save "E:\data\serious_ill\logs\spending distribution exclusive", replace  

twoway (line tot c1 , sort) (line tot  c2, sort) (line tot  c3, sort) ///
(line tot c4 , sort), ///
 title("Cumulative distribution of Spending by Criteria") legend(label(1 "2008") ///
 label(2 "Criteria A") label(3  "Criteria B") label(4  "Criteria C")) xlab(#11)
graph save "E:\data\serious_ill\logs\spending distribution topcoded", replace  

twoway (line tot ce1, sort) (line tot ce2, sort) (line tot ce3, sort) ///
(line tot ce4, sort), ///
 title("Cumulative distribution of Spending by Criteria, Exclusive") legend(label(1 "2008") ///
  label(2 "Criteria A") label(3  "Criteria B") label(4  "Criteria C")) xlab(#11)
graph save "E:\data\serious_ill\logs\spending distribution exclusive topcoded", replace  

label define hcat 0 "0" 1 "1" 2 "2 or more"

foreach i in 6 12 {
	gen hosp_cat_`i'm=n_ip_admit_p`i'm_n0
	replace hosp_cat_`i'=2 if hosp_cat_`i'>2 & hosp_cat_`i'!=.
	label values hosp_cat_`i' hcat
	label var hosp_cat_`i' "Hospital Admissions, within `i' months" 
}



foreach x in crit crit_e {
	local r=1
	local c=1
	mat hcat`x'=J(4,7,.)
	forvalues i=1/4 {
		foreach j in 6 12 {
			tab hosp_cat_`j'm if `x'==`i', matcell(j1)
			sum hosp_cat_`j'm if `x'==`i'
			mat hcat`x'[`r',`c']=(j1[1,1]/r(N))*100
			mat hcat`x'[`r',`c'+1]=(j1[2,1]/r(N))*100
			mat hcat`x'[`r',`c'+2]=(j1[3,1]/r(N))*100
			local c=`c'+3
			mat hcat`x'[`r',7]=r(N)
}
		local r=`r'+1
		local c=1
}
	mat rownames hcat`x'="2008" "Criteria A" "Criteria B" "Criteria C"
}

frmttable using "E:\data\serious_ill\logs\hospitalizations_categorical", ///
statmat(hcatcrit) title("Hospitalizations by Criteria") ctitles("" "0 6m" ///
"1 6m" "2+ 6m" "0 12m" "1 12m" "2+ 12m" "N") sdec(2,2,2,2,2,2,0) replace

frmttable using "E:\data\serious_ill\logs\hospitalizations_categorical" ///
, statmat(hcatcrit_e) title("Hospitalizations by Criteria, Exclusive") ctitles("" "0 6m" ///
"1 6m" "2+ 6m" "0 12m" "1 12m" "2+ 12m" "N") sdec(2,2,2,2,2,2,0) addtable

*log close


H="comparison those who don't give medicare info"
use "E:\data\serious_ill\int_data\core_ids_1yr_criteria_5.dta", clear
keep if core_year==2008
drop if age_at_core<66
tab medicare xwalk

gen mclink=medicare==1 & xwalk==0 
replace mclink=2 if medicare==0 & xwalk==0
label define mclink 0 "Provided Medicare Link" 1 "Refused" 2 "Not in Medicare"
label var mclink mclink
gen nolink=mclink==1
gen n=1
local cvars age_at_core networth_adj2012

gen college=inlist(degree,4,5,6)
gen highschool=inlist(degree,1,2)
label var college "College Degree or Higher"
label var highschool "HS Degree or GED"
tab tics_cat, gen(tics_cat)
label var tics_cat1 "TICS Normal"
label var tics_cat2 "TICS MCI"
label var tics_cat3 "TICS Demented"

local ivars female black white hisp_eth other_race highschool college married ///
medicaid medigap champus srh_pf srh_g ///
srh_ve adl_impair_core core_to_dod_1yr

local rn : word count `cvars' `ivars' n 
local r=1
local c=1

mat chars=J(`rn',7,.)

foreach i in 2 1 0 {
	foreach x of local cvars {
		sum `x' if mclink==`i'
		mat chars[`r',`c']=r(mean)
		mat chars[`r',`c'+1]=r(N)
		ttest `x' if mclink!=2, by(mclink)
		mat chars[`r',7]=r(p)
		local r=`r'+1
}
	foreach x of local ivars {
		sum `x' if mclink==`i'
		mat chars[`r',`c']=r(mean)*100
		mat chars[`r',`c'+1]=r(N)
		tab `x' mclink if mclink!=2,chi2
		mat chars[`r',7]=r(p)
		local r=`r'+1
}
	sum n if mclink==`i'
	mat chars[`r',`c'+1]=r(N)
	local c=`c'+2
	local r=1
	
}

mat rownames chars= `cvars' `ivars' N

frmttable using "E:\data\serious_ill\logs\Medicare_characteristics.rtf", ///
statmat(chars) ctitles("" "Not in Medicare"  "N" ///
"SR Medicare, No Link" "N" "Provided Medicare Link" "N" "P") ///
varlabels sdec(2,0,2,0,2,0,3) note("2008 Wave Respondents 66+ years of age" ///
"Mean of continuous vars, % of binary" ///
"P-value among those with reported Medicare, by link status, from t-test or chi2") ///
title("Sample Characteristics by Medicare Crosswalk Status") replace


H="*********************************************"


H="HCC risk adjustment"
/* HCC data to serious illness files 
 12022015 revise top% HCC spending to be based on total HCC NOT actual spending
 
 ave medicare spending per enrollee for 2007was $9418 (taken 12022015 from 
 www.kff.org/medicare/stat-indicator/per-enrollee-spending-by-residence)
 CPI inflation to 2012 is 10043.13 (www.bls.gov/data/inflation_calculator.htm)
*/

clear all
set more off, perm

local logpath E:\data\serious_ill\logs
local datapath E:\data\serious_ill\final_data

cd `datapath'

* CRITERIA A + HCC in 2008
use n0_n1_p1_p2_x_criteria_a_v1 if core_year_n0==2008
* add the HCC data		 
drop _merge 
merge 1:1 id using "E:\data\cms_DUA_24548_2012\HCC2008.dta" //, nogenerate
tab _merge
keep if _merge==3
gen criteria_a_file=m
save n0_n1_p1_p2_x_criteria_a_hcc08, replace


* CRITERIA B + HCC in 2008
use n0_n1_p1_p2_x_criteria_b_v1 if core_year_n0==2008
* add the HCC data		 
drop _merge 
merge 1:1 id using "E:\data\cms_DUA_24548_2012\HCC2008.dta" //, nogenerate
tab _merge
keep if _merge==3
gen criteria_b_file=1
save n0_n1_p1_p2_x_criteria_b_hcc08, replace


* CRITERIA C + HCC in 2008
use n0_n1_p1_p2_x_criteria_c_v1 if core_year_n0==2008
* add the HCC data		 
drop _merge 
merge 1:1 id using "E:\data\cms_DUA_24548_2012\HCC2008.dta" //, nogenerate
tab _merge
keep if _merge==3
gen criteria_c_file=1
save n0_n1_p1_p2_x_criteria_c_hcc08, replace


* CRITERIA COMPARISON + HCC in 2008
use n0_n1_p1_p2_x_criteria_2008_v1
keep if (criteria_a_n0==0 & criteria_b_n0==0 & criteria_c_n0==0) 
* add the HCC data		 
drop _merge 
merge 1:1 id using "E:\data\cms_DUA_24548_2012\HCC2008.dta" //, nogenerate
tab _merge
keep if _merge==3
gen criteria_0_file=1
save n0_n1_p1_p2_x_criteria_comp_hcc08, replace



* combine 2008 data and create HCC risk adj and spending 
use n0_n1_p1_p2_x_criteria_a_hcc08 
append using "n0_n1_p1_p2_x_criteria_b_hcc08" ///
             "n0_n1_p1_p2_x_criteria_c_hcc08" ///
             "n0_n1_p1_p2_x_criteria_comp_hcc08"
gen group=0
   replace group=1 if criteria_a_file==1			 
   replace group=2 if criteria_b_file==1	
   replace group=3 if criteria_c_file==1	
tab group

gen hcc_adj       = score_community
  replace hcc_adj = score_institutional if nhres_n0==1 
  replace hcc_adj = score_new_enrollee if new==1 
gen hcc_spend     = hcc_sp_2008_adj2012 * hcc_adj
save "E:\data\serious_ill\final_data\n0_n1_p1_p2_x_criteria_all_hcc08.dta", replace


/*************************************************************/
* create histograms of HCC spending
use n0_n1_p1_p2_x_criteria_a_hcc08 
histogram hcc_spend, percent title("Criteria A") ysc(r(0 30)) ylabel(0(5)30)
graph save `logpath'\hcc_hist_a, replace
use n0_n1_p1_p2_x_criteria_b_hcc08 
histogram hcc_spend, percent title("Criteria B") ysc(r(0 30)) ylabel(0(5)30)
graph save `logpath'\hcc_hist_b, replace
use n0_n1_p1_p2_x_criteria_c_hcc08 
histogram hcc_spend, percent title("Criteria C") ysc(r(0 30)) ylabel(0(5)30)
graph save `logpath'\hcc_hist_c, replace
use n0_n1_p1_p2_x_criteria_comp_hcc08 
histogram hcc_spend, percent title("Comparison") ysc(r(0 30)) ylabel(0(5)30)
graph save `logpath'\hcc_hist_comp, replace	
gr combine `logpath'\hcc_hist_a.gph `logpath'\hcc_hist_b.gph `logpath'\hcc_hist_c.gph `logpath'\hcc_hist_comp.gph 
*graph save `logpath'\hcc_hist_combined, replace	
graph export `logpath'\hcc_hist_combined.png, as(png) replace



/*************************************************************
/ Explore the relationship between actual spending and HCC spending
/ 1) actual spending for 2008 cohort- identify top 10% spenders
/ 2) HCC spending for 2008 cohort - how many of the top 10% where acurately identified
/ 3) Repeat for each criteria group
/ 4) Repeat using 5% and 20% alternatives
*/
use n0_n1_p1_p2_x_criteria_all_hcc08 

* compute frailty adjustment : replace difficulty in/out of chairs with diffulty transfer to bed
tab1 adl_diff_dr_n0 adl_diff_wk_n0 adl_diff_bh_n0 adl_diff_e_n0 adl_diff_t_n0 adl_diff_tx_n0, missing
gen adl_num0=adl_diff_dr_n0 + adl_diff_wk_n0 + adl_diff_bh_n0 + adl_diff_e_n0 + adl_diff_t_n0 + adl_diff_tx_n0
gen frailty_current= -0.141
  replace frailty_current= 0.171 if adl_num0>0 & adl_num0<3
  replace frailty_current= 0.344 if adl_num0>2 & adl_num0<5
  replace frailty_current= 1.088 if adl_num0>4 
gen frailty_nonmed= -0.089
  replace frailty_nonmed= 0.110 if adl_num0>0 & adl_num0<3
  replace frailty_nonmed= 0.200 if adl_num0>2 & adl_num0<5
  replace frailty_nonmed= 0.377 if adl_num0>4 
gen frailty_med= -0.183
  replace frailty_med= 0.024 if adl_num0>0 & adl_num0<3
  replace frailty_med= 0.132 if adl_num0>2 & adl_num0<5
  replace frailty_med= 0.188 if adl_num0>4  
gen frailty_adj=(0.90 * frailty_current) + (0.10 * frailty_nonmed) if medicaid_n0==0
  replace frailty_adj=(0.90 * frailty_current) + (0.10 * frailty_med) if medicaid_n0==1
gen hcc_adj_frailty=  hcc_adj + frailty_adj
gen hcc_spend_frailty= hcc_sp_2008_adj2012 * hcc_adj_frailty
tab frailty_adj
sum hcc_adj_frailty hcc_adj hcc_spend hcc_spend_frailty, d

* residual expenditures
gen hcc_med_resid=tot_paid_by_mc_12m_wi_n0 - hcc_spend
gen hcc_med_frailty_resid= tot_paid_by_mc_12m_wi_n0 - hcc_spend_frailty

gen hcc_med_dif=hcc_spend - tot_paid_by_mc_12m_wi_n0
gen hcc_med_dif100= hcc_med_dif
   replace hcc_med_dif100= -100000 if hcc_med_dif< -100000
   replace hcc_med_dif100= 100000 if hcc_med_dif> 100000
   
* get top 20% 10% 5% cut offs 
tab tot_paid_by_mc_12m_wi_n0 
tab hcc_spend

gen spend_med5=0
gen spend_med10=0
gen spend_med20=0
   replace spend_med5=1 if tot_paid_by_mc_12m_wi_n0 > 58245.13 
   replace spend_med10=1 if tot_paid_by_mc_12m_wi_n0 > 35363.7
   replace spend_med20=1 if tot_paid_by_mc_12m_wi_n0 > 16482.45 
gen spend_hcc5=0
gen spend_hcc10=0
gen spend_hcc20=0
   replace spend_hcc5=1 if hcc_spend > 40644.55 
   replace spend_hcc10=1 if hcc_spend > 31053.36
   replace spend_hcc20=1 if hcc_spend > 20287.12  
gen spend_med_hcc5=0
   replace spend_med_hcc5=1 if (spend_hcc5==1 & spend_med5==1)   
   replace spend_med_hcc5=2 if (spend_hcc5==1 & spend_med5==0)   
   replace spend_med_hcc5=3 if (spend_hcc5==0 & spend_med5==1)    
gen spend_med_hcc10=0
   replace spend_med_hcc10=1 if (spend_hcc10==1 & spend_med10==1)   
   replace spend_med_hcc10=2 if (spend_hcc10==1 & spend_med10==0)   
   replace spend_med_hcc10=3 if (spend_hcc10==0 & spend_med10==1) 
gen spend_med_hcc20=0
   replace spend_med_hcc20=1 if (spend_hcc20==1 & spend_med20==1)   
   replace spend_med_hcc20=2 if (spend_hcc20==1 & spend_med20==0)   
   replace spend_med_hcc20=3 if (spend_hcc20==0 & spend_med20==1) 

lab def grp 0 "Comparison" 1 "Criteria A" 2 "Criteria B" 3 "Criteria C"
lab def grp10 0 "Both <10%" 1 "Both 10%" 2 "HCC 10% Med<10%" 3 "HCC<10% Med 10%"
lab def grp5 0 "Both <5%" 1 "Both 5%" 2 "HCC 5% Med<5%" 3 "HCC<5% Med 5%"
lab def grp20 0 "Both <20%" 1 "Both 20%" 2 "HCC 20% Med<20%" 3 "HCC<20% Med 20%"

lab val group grp 
lab val spend_med_hcc5 grp5 
lab val spend_med_hcc10 grp10  
lab val spend_med_hcc20 grp20

la var spend_med5 "Medicare Spending Top 5%"
la var spend_med10 "Medicare Spending Top 10%"
la var spend_med20 "Medicare Spending Top 20%"
la var spend_hcc5 "HCC Spending in Medicare Top 5%"
la var spend_hcc10 "HCC Spending in Medicare Top 10%"
la var spend_hcc20 "HCC Spending in Medicare Top 20"
la var spend_med_hcc5 "Concordance betw HCC & Medicare 5%"
la var spend_med_hcc10 "Concordance betw HCC & Medicare 10%"
la var spend_med_hcc20 "Concordance betw HCC & Medicare 20%"   
la var core_to_dod_1yr_n0 "Died, n (%)"
la var hs_admit_p12m_n0 "Enrolled in hospice, n (%)"
la var ind_em_ur_adm_p12m_n0 "Hospital admission, n (%)"
la var n_hospd_p12m_n0 "Hospital nights, mean (sd)"
la var hcc_spend "CMS HCC Spending, mean (sd)"
la var hcc_adj "CMS HCC Risk Adjustment Score, mean (sd)"
la var hcc_med_dif "CMS HCC - Medicare Spending 2008"
la var hcc_med_dif100 "CMS HCC - Medicare Spending min/max 100,000 2008"
la var hcc_sp_2008_adj2012 "2008 Ave Medicare spending per beneficiary adj to 2012"
la var hcc_med_resid "2008 Actual paid - HCC predicted" 
la var hcc_med_frailty_resid "2008 Actual paid - HCC predicted adj for frailty" 


la var ip_paid_by_mc_12m_wi_n0 "Inpatient"
la var snf_paid_by_mc_12m_wi_n0 "SNF"
la var hh_paid_by_mc_12m_wi_n0 "Home health" 
la var hs_paid_by_mc_12m_wi_n0 "Hospice" 
la var pb_paid_by_mc_12m_wi_n0 "Carrier"
la var op_paid_by_mc_12m_wi_n0 "Outpatient" 
la var dm_paid_by_mc_12m_wi_n0 "DME"
la var tot_paid_by_mc_12m_wi_n0 "Total"
la var cost_mos_n0 "Costs per month"

** graph HCC and Medicare spending    
twoway (scatter hcc_spend tot_paid_by_mc_12m_wi_n0, ytitle(HCC Spending) ///
  yline(50000 100000) xtitle(Medicare Spending)  xline(50000 100000) msize(tiny) ///
  by(, title(Medicare and HCC Spending 2008)) by(group))
** use graph editor to add line indicating HCC=Medicare
graph export "E:\projects\serious_illness_cohort\archive_logs\20151202\HCC Medicare spending 2008 4 groups.png", ///
 as(png) replace   
** graph the difference between HCC and Medicare spending (min/max 100,000)    
histogram hcc_med_dif100, percent ytitle(Percent) ///
  xtitle(HCC Spending - Medicare Spending 2008) by(group)
graph export "E:\projects\serious_illness_cohort\archive_logs\20151202\HCC Medicare difference 2008 4 groups.png", ///
 as(png) replace   

bysort group: cumul hcc_med_resid, gen(percent_resid)
bysort group: cumul hcc_med_frailty_resid, gen(percent_frail_resid) 
twoway (scatter hcc_med_resid percent_resid, ytitle(Residual Spending) ///
  yline(0) xtitle(Percent) msize(tiny) ///
  by(, title(Residual Spending 2008)) by(group))

** graph Spending residuals  
separate hcc_med_resid, by(group) 
twoway (line hcc_med_resid0 percent_resid, sort) ///
 (line hcc_med_resid1 percent_resid, sort) ///
 (line hcc_med_resid2 percent_resid, sort) ///
 (line hcc_med_resid3 percent_resid, sort), ///
  ytitle(Residual Spending) yline(0) xtitle(Percent) /// 
  legend(order (1 "Comparison" 2 "Criteria A" 3 "Criteria B" 4 "Criteria C"))
graph export "E:\projects\serious_illness_cohort\archive_logs\20151202\HCC Spending Residuals 2008 4 groups.png", ///
 as(png) replace   
** graph Spending residuals adjusted for frailty 
separate hcc_med_frailty_resid, by(group) 
twoway (line hcc_med_frailty_resid0 percent_frail_resid, sort) ///
 (line hcc_med_frailty_resid1 percent_frail_resid, sort ) ///
 (line hcc_med_frailty_resid2 percent_frail_resid, sort ) ///
 (line hcc_med_frailty_resid3 percent_frail_resid, sort ), ///
  ytitle(Residual Spending) yline(0) xtitle(Percent) ///
  legend(order (1 "Comparison" 2 "Criteria A" 3 "Criteria B" 4 "Criteria C"))
 graph export "E:\projects\serious_illness_cohort\archive_logs\20151202\HCC Spending Residuals with Frailty Adjustment 2008 4 groups.png", ///
 as(png) replace  
 
** graph spending not/adjusted for frailty
bysort group: cumul hcc_spend, gen(percent_spend)
bysort group: cumul hcc_spend_frailty, gen(percent_frail_spend) 
bysort group: cumul tot_paid_by_mc_12m_wi_n0, gen(percent_actual)
gen total_max100=tot_paid_by_mc_12m_wi_n0
   replace total_max100=100000 if tot_paid_by_mc_12m_wi_n0>100000
twoway  (line total_max100 percent_actual , sort ) ///
  (line hcc_spend percent_spend , sort )  /// 
  (line hcc_spend_frailty percent_frail_spend , sort ), ///
  ytitle(Spending) xtitle(Percent) legend(order(1 "Actual Spending (max 100K)" ///
  2 "HCC Estimate" 3 "HCC Adjusted for Frailty"))  ///
  by(,title(Actual & Estimated Spending 2008)) by(group)
graph export "E:\projects\serious_illness_cohort\archive_logs\20151202\Actual (max 100K) and Estimated Spending 2008 4 groups.png", ///
 as(png) replace  
 
log using "E:\projects\serious_illness_cohort\archive_logs\20151202\2008 t-test spending 4 groups.doc", replace
by group, sort :mvtest means hcc_spend tot_paid_by_mc_12m_wi_n0
log close
/*ttest hcc_spend =  tot_paid_by_mc_12m_wi_n0 if group==0
ttest hcc_spend =  tot_paid_by_mc_12m_wi_n0 if group==1
ttest hcc_spend =  tot_paid_by_mc_12m_wi_n0 if group==2
ttest hcc_spend =  tot_paid_by_mc_12m_wi_n0 if group==3 */
 
 
** top 10%  
mat table_x=J(12,4,.) //12 rows by 4 columns
local r=1
local c=1
forvalues g = 0/3{  // criteria groups coded 0-3 comp, A, B, C
foreach x in spend_med10 spend_hcc10  {  // dichotomous variables
sum `x' if group==`g'
mat table_x[`r',`c']=r(N)*r(mean)
local r=`r'+1
mat table_x[`r',`c']=r(mean)*100
local r=`r'+1
}

tab spend_med_hcc10 if group==`g', matcell(spendx)  // categorical variable w 4 categories
forvalues i = 1/4{  // concordance groups coded 0-3 
mat table_x[`r',`c']=spendx[`i',1]
local r=`r'+1
mat table_x[`r',`c']=(spendx[`i',1]/r(N))*100
local r=`r'+1
}
local c=`c'+1
local r=1
}
//mat rownames table_x=spend_med10 "   Percent" spend_hcc10 "   Percent" ///
//"Both <10%" "   Percent" "Both 10%" "   Percent" "HCC 10% Med<10%" "   Percent" "HCC<10% Med 10%" "   Percent"
frmttable using "E:\projects\serious_illness_cohort\archive_logs\20151202\HCC Medicare concordance 10percent 11242015.rtf", ///
   statmat(table_x) ///
   title("Table X: 2008 Medicare and HCC Spending - Top 10%") ///
   rtitle("Medicare Spending Top 10%" \"   Percent" \"HCC Spending in Medicare Top 10%" ///
   \ "   Percent"\ "Both <10%"\ "   Percent"\ "Both 10%" \"   Percent" \"HCC 10% Med<10%" ///
   \ "   Percent"\ "HCC<10% Med 10%" \"   Percent") ///
   ctitle("" "Comparison" "Criteria" "Criteria B" "Criteria C") ///
   note("Top 10% of Medicare spending for all groups 2008 was $35,363.70 or more and HCC spending $31,053.36 or more") ///
   sdec(0\2\0\2\0\2\0\2\0\2\0\2) varlabels replace 


** top 5%  
mat table_y=J(12,4,.) //12 rows by 4 columns
local r=1
local c=1
forvalues h = 0/3{  // criteria groups coded 0-3 comp, A, B, C
foreach y in spend_med5 spend_hcc5  {  // dichotomous variables
sum `y' if group==`h'
mat table_y[`r',`c']=r(N)*r(mean)
local r=`r'+1
mat table_y[`r',`c']=r(mean)*100
local r=`r'+1
}

tab spend_med_hcc5 if group==`h', matcell(spendy)  // categorical variable w 4 categories
forvalues j = 1/4{  // concordance groups coded 0-3 
mat table_y[`r',`c']=spendy[`j',1]
local r=`r'+1
mat table_y[`r',`c']=(spendy[`j',1]/r(N))*100
local r=`r'+1
}
local c=`c'+1
local r=1
}
//mat rownames table_y=spend_med5 "   Percent" spend_hcc5 "   Percent" ///
//"Both <5%" "   Percent" "Both 5%" "   Percent" "HCC 5% Med<5%" "   Percent" "HCC<5% Med 5%" "   Percent"
frmttable using "E:\projects\serious_illness_cohort\archive_logs\20151202\HCC Medicare concordance 5percent 11252015.rtf", ///
   statmat(table_y) ///
   title("Table X: 2008 Medicare and HCC Spending - Top 5%") ///
   rtitle("Medicare Spending Top 5%" \"   Percent" \"HCC Spending in Medicare Top 5%" ///
   \ "   Percent"\ "Both <5%"\ "   Percent"\ "Both 5%" \"   Percent" \"HCC 5% Med<5%" ///
   \ "   Percent"\ "HCC<5% Med 5%" \"   Percent") ///
   ctitle("" "Comparison" "Criteria" "Criteria B" "Criteria C") ///
   note("Top 5% of Medicare spending for all groups 2008 was $58,245.13 or more and HCC spending $20,287.12 or more") ///
   sdec(0\2\0\2\0\2\0\2\0\2\0\2) varlabels replace 
 
   
** top 20%  
mat table_z=J(12,4,.) //12 rows by 4 columns
local r=1
local c=1
forvalues f = 0/3{  // criteria groups coded 0-3 comp, A, B, C
foreach z in spend_med20 spend_hcc20  {  // dichotomous variables
sum `z' if group==`f'
mat table_z[`r',`c']=r(N)*r(mean)
local r=`r'+1
mat table_z[`r',`c']=r(mean)*100
local r=`r'+1
}

tab spend_med_hcc20 if group==`f', matcell(spendz)  // categorical variable w 4 categories
forvalues k = 1/4{  // concordance groups coded 0-3 
mat table_z[`r',`c']=spendz[`k',1]
local r=`r'+1
mat table_z[`r',`c']=(spendz[`k',1]/r(N))*100
local r=`r'+1
}
local c=`c'+1
local r=1
}
//mat rownames table_z=spend_med20 "   Percent" spend_hcc20 "   Percent" ///
//"Both <20%" "   Percent" "Both 20%" "   Percent" "HCC 20% Med<20%" "   Percent" "HCC<20% Med 20%" "   Percent"
frmttable using "E:\projects\serious_illness_cohort\archive_logs\20151202\HCC Medicare concordance 20percent 11252015.rtf", ///
   statmat(table_z) ///
   title("Table X: 2008 Medicare and HCC Spending - Top 20%") ///
   rtitle("Medicare Spending Top 20%" \"   Percent" \"HCC Spending in Medicare Top 20%" ///
   \ "   Percent"\ "Both <20%"\ "   Percent"\ "Both 20%" \"   Percent" \"HCC 20% Med<20%" ///
   \ "   Percent"\ "HCC<20% Med 20%" \"   Percent") ///
   ctitle("" "Comparison" "Criteria" "Criteria B" "Criteria C") ///
   note("Top 20% of Medicare spending for all groups 2008 was $16,482.45 or more and HCC spending $16,482.45 or more") ///
   sdec(0\2\0\2\0\2\0\2\0\2\0\2) varlabels replace 
     
   
   
   


tab spend_med10 group, col    
tab spend_hcc10 group, col   
tab spend_med_hcc10 group, col 

tab spend_med5 group, col   
tab spend_hcc5 group, col    
tab spend_med_hcc5 group, col 

tab spend_med20 group, col    
tab spend_hcc20 group, col    
tab spend_med_hcc20 group, col  

log close

// local outcome1 spend_med10 spend_hcc10 spend_med_hcc10 
//   spend_med5 spend_hcc5 spend_med_hcc5  spend_med20 spend_hcc20 spend_med_hcc20 

tab spend_med10 group, col    
tab spend_hcc10 group, col   
tab spend_med_hcc10 group, col 


***************************************************************
***************************************************************
//Table 2 - Looking at 1 year outcomes, 3 criteria
***************************************************************
***************************************************************
//use dataset with outcomes, just obs that meet interview sample inclusion criteria

foreach crit in a b c comp{
	frmttable, clear(table2_b_1)
	clear
	use n0_n1_p1_p2_x_criteria_`crit'_hcc08.dta

local outcome1 core_to_dod_1yr_n0 hs_admit_p12m_n0 ind_em_ur_adm_p12m_n0

local outcome3 n_hospd_p12m_n0 hcc_spend hcc_adj

local outcome2 ip_paid_by_mc_12m_wi_n0 snf_paid_by_mc_12m_wi_n0 hh_paid_by_mc_12m_wi_n0 ///
 hs_paid_by_mc_12m_wi_n0 pb_paid_by_mc_12m_wi_n0 op_paid_by_mc_12m_wi_n0 ///
 dm_paid_by_mc_12m_wi_n0 tot_paid_by_mc_12m_wi_n0 cost_mos_n0 

mat table2_n=J(1,1,.)
//row of n for each category
tab core_year_n0 , missing
mat table2_n[1,1]=r(N)

mat rownames table2_n="N"
mat list table2_n
frmttable, statmat(table2_n) ///
	sdec(0) store(table2_n_1) ///
	rtitles("N")

mat table2_a=J(6,2,.)
local c=1
local r=1
foreach v in `outcome1'{ //indicator variables, report n (percent)
	sum `v' , detail
	mat table2_a[`r',`c']=r(mean)*r(N) //n
	mat table2_a[`r',`c'+1]=r(mean)*100 //percent
	local r=`r'+1 
	}

foreach v in `outcome3'{ //continuous variables, report mean (sd)
	sum `v' , detail
	mat table2_a[`r',`c']=r(mean) //mean
	mat table2_a[`r',`c'+1]=r(sd) //sd
	local r=`r'+1 
	}

mat rownames table2_a=`outcome1' `outcome3'
mat list table2_a

//save the table in frmttable	
mat dmat=(0,1)
mat ann=J(6,1,1)

frmttable, statmat(table2_a) varlabels ///
	sdec(1) doubles(dmat) ///
	dbldiv(" (") annotate(ann) asymbol(")") ///
	store(table2_a_1) 

//for spending variables where we report medians
mat table2_b=J(1,2,.) //for mean, sd
mat table2_c=J(1,1,.) //for median

mat dmat_b=(0,1)
mat ann_b=J(1,1,1)
foreach v in `outcome2'{ //spending variables, report mean(sd),median

local c=1
	sum `v', detail
	mat table2_b[1,`c']=r(mean) //mean
	mat table2_b[1,`c'+1]=r(sd) //sd
	mat table2_c[1,`c']=r(p50) //median

	local lbl: var label `v'
	label var `v' "`lbl' , mean (sd)"
	mat rownames table2_b=`v'

	frmttable, statmat(table2_b)  varlabels ///
		sdec(0) doubles(dmat) ///
		dbldiv(" (") annotate(ann) asymbol(")") ///
		append(table2_b_1) 
	
	label var `v' " median"
	mat rownames table2_c=`v'	
	
	frmttable, statmat(table2_c)  varlabels ///
		sdec(0) append(table2_b_1) 	
}

outreg, replay(table2_a_1) append(table2_b_1) store(table2_c_1)
outreg, replay(table2_c_1) append(table2_n_1) store(table2_`crit')

}

outreg, replay(table2_comp) merge(table2_a) store(table2_1)
outreg, replay(table2_1) merge(table2_b) store(table2_2)

outreg using `logpath'\HCC_4grps.rtf, ///
replay(table2_2) merge(table2_c) store(table2_3) ///
	ctitles("","Criteria A","Criteria B","Criteria C", "Comparison") ///
	title("Table 2: 1 Year Outcomes, Year R first meets criteria") ///
	note("Criteria A = Any serious medical illness and/or ADL impairment" \ ///
	"Criteria B = Criteria A and Urgent / Emergent hospitalization and/or NH resident" \ ///
	"Criteria C = Medical illness and ADL Impairment and hospitalization and/or NH resident" \ ///
	"Comparison") 
	
	

H="HCC/Medicare Concordance 2008"
use "E:\data\serious_ill\final_data\n0_n1_p1_p2_x_criteria_allx_hcc08.dta", clear
log using "E:\data\serious_ill\logs\HCC_Medicare_spending", replace

gen criteria_0_n0=!criteria_a_n0
gen criteria_all_n0=1
sum tot_paid_by_mc_12m_wi_n0,d
gen spend_med5=tot_paid_by_mc_12m_wi_n0>=r(p95)
sum hcc_spend,d
gen spend_hcc5=hcc_spend>=r(p95)
mat these=J(19,5,.)
local r=1
local c=1

foreach x in all a b c 0 {
	sum tot_paid_by_mc_12m_wi_n0 if criteria_`x'_n0==1
	mat these[`r',`c']=r(N)
	mat these[`r'+1,`c']=r(mean)
	mat these[`r'+2,`c']=r(sd)
	local r=`r'+3
	sum hcc_spend if criteria_`x'_n0==1
	mat these[`r',`c']=r(mean)
	mat these[`r'+1,`c']=r(sd)
	ttest tot_paid_by_mc_12m_wi_n0=hcc_spend if criteria_`x'_n0==1
	mat these[`r'+2,`c']=r(p)
	local r=`r'+4
	foreach y in med hcc {
		sum spend_`y'5 if criteria_`x'_n0==1
		mat these[`r',`c']=r(mean)*r(N)
		mat these[`r'+1,`c']=r(mean)*100
		local r=`r'+2
}
	foreach y in 0 1 {
		foreach i in 0 1 {
			sum criteria_all_n0 if criteria_`x'_n0==1 & spend_hcc5==`i' & spend_med5==`y'
			mat these[`r',`c']=r(N)
			mat these[`r'+1,`c']=(r(N)/these[1,`c'])*100
			local r=`r'+2
}
}
	local r=1
	local c=`c'+1
}

mat rownames these = "N" "Mean Medicare Spending" "SD" "Mean HCC predicted" ///
 "SD" "P-value, TTest HCC=Spend" "" "N top 5 Spend" "% top 5 Spend" "N top 5 HCC" ///
 "% top 5 HCC" "N Both not top5" "%" "N HCC only top5" "%" "N Spend only top5" ///
 "%" "Both top 5" "%"

frmttable using "E:\data\serious_ill\logs\HCC_Medicare_spending_concordance", ///
 statmat(these) ctitles("" "Total" "Criteria A" "Criteria B" "Criteria C" "None") ///
 title("Spending and HCC predicted Spending by Criteria") replace ///
 sdec(0\2\2\2\2\3\0\0\2\0\2\0\2\0\2\0\2\0\2) note("wave year 2008" ///
 "top 5% Medicare spending>=$56,262.87 top 5% HCC predicted spending>=$39,399.20")


H="death propensity redux"
capture log close

import excel "E:\data\Dartmouth_misc\EOL_mc_2yrs_HRR\DAP_HRR_03_07_to_merge.xls", sheet("Sheet1") firstrow case(lower) clear
keep hrr totalmedic
rename hrr hrr_number_n0
xtile eol_spending_quintile=tot, nq(5)
xtile eol_spending_quartile=tot, nq(4)
gen eol_spending_3_cat=eol_spending_quartile
replace eol_spending_3_cat=eol_spending_3_cat-1 if inlist(eol_spending_3_cat,3,4)
label define eol_spending_3_cat 1 "Bottome Quartile" 2 "Middle 50%" 3 "Top quartile"
label values eol_spending_3_cat eol_spending_3_cat
gen eol_spending_low=eol_spending_3_cat==1
gen eol_spending_mid=eol_spending_3_cat==2
gen eol_spending_high=eol_spending_3_cat==3
label var eol_spending_low "Bottom Quartile EOL spending by Dartmouth HRR"
label var eol_spending_mid "Middle 50% EOL spending by Dartmouth HRR"
label var eol_spending_high "Top Quartile EOL spending by Dartmouth HRR"
label var eol_spending_3_cat "EOL Spending Group by Dartmouth HRR, Adjusted"
label var eol_spending_quintile "EOL Spending Quintile by Dartmouth HRR, Adjusted"
tempfile temp1
save "`temp1'"

clear all
set more off

local logpath E:\data\serious_ill\logs
local datapath E:\data\serious_ill\final_data

*log using "`logpath'\tables_inc_24m_symptoms_helper", text replace
foreach orange in 1 {
cd `datapath'

use n0_n1_p1_p2_x_criteria_a_v1.dta if core_year_n0<2012
merge m:1 hrr_number_n0 using "`temp1'", keep(match master) nogen
drop if hospital_care_intensity_n0==.
gen age2=age_at_core_n0^2
tab age_cat2_n0, gen(age_n0_ind)
gen age_veryold=age_at_core_n0>=85
gen religvimp_n0=1 if imprelig_n0==1
replace religvimp_n0=0 if inlist(imprelig_n0,2,3,4)
tab religvimp_n0, missing
gen smi_any_n0=1 if smi_count_n0>0
replace smi_any_n0=0 if smi_count_n0==0
tab smi_any_n0, m
qui xtile quint_cd_n0=contact_days_n0, nq(5)
qui xtile quintile_dm_2yr=tot_eol_spending_hrr_n0, nq(5)
gen notwhite=re_white==0 if re_white!=.
label var notwhite "Not non-Hispanic White"
tab quintile_dm_2yr, m
la var quintile_dm_2yr "Quintiles of 2 year Dartmouth EOL Medicare Spending, HRR level (within this sample)"
la val quintile_dm_2yr quint

sum tot_eol_spending_hrr_n0 if quintile_dm_2yr==1, detail
sum tot_eol_spending_hrr_n0 if quintile_dm_2yr==2, detail
sum tot_eol_spending_hrr_n0 if quintile_dm_2yr==3, detail
sum tot_eol_spending_hrr_n0 if quintile_dm_2yr==4, detail
sum tot_eol_spending_hrr_n0 if quintile_dm_2yr==5, detail


tab quintile_dm_2yr, gen(d_eol_spend_quint) missing
sum hlphrs,d
gen hlphrs_group=hlphrs>r(p50)
replace hlphrs_group=2 if hlphrs>r(p75)
gen hlphrs_high=hlphrs_group==2
gen cd2=contact_days_n0^2
log using `logpath'\propensity_crosstabs.txt, text replace
local matchvars age_at_core_n0 female notwhite married_n0 i.nw_quartile_65_n0 ///
hs_deg adl_stable_partial_n0n1 adl_stable_severe_n0n1 adl_change_i_m_n0n1 ///
 adl_change_i_s_n0n1 adl_change_m_s_n0n1 ///
smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 ///
smi_liver_ind_n0  smi_hip_ind_n0 smi_nh_ind_n0 srh_pf_n0 ///
dm_hrs_n1 cancer_hrs_n1 lung_hrs_n1 chf_hrs_n1 bmi_lt25_n0 smoke_curr_n0  ///
adl_diff_bh_n0 iadl_diff_m_n0 fl_diff_wk_many_n0 fl_diff_push_n0 ///
ind_em_ur_adm_12m_n0 rel_nb_n0 medicaid_n0 champus_n0 medigap_n0 ///
adl_index_core_n0 el_ge3_comorb_1yr_n0 i.quint_cd_n0 hlphrs



label var tot_paid_by_mc_12m_wi_n0 "Tot MC Payments, 12M following ivw"
logit core_to_dod_1yr_n0 `matchvars', nolog

estat ic
predict pdeath
drop if pdeath==.
qui sum pdeath,d
//regional variables, split by quartile of hrr eol spending per dm atlas
local rvars tot_eol_spending_hrr_n0 hospital_care_intensity_n0 ///
	physicians_n0 specialists_n0 hospital_beds_n0


qui xtile hci=hospital_care_intensity_n0, nq(5)

gen adl_stable=adl_stable_partial_n0n1
replace adl_stable=1 if adl_stable_severe_n0n==1
gen adl_decline=adl_change_i_m_n0n1 
replace adl_decline=1 if adl_change_i_s_n0n1==1
replace adl_decline=1 if adl_change_m_s_n0n1==1

qui xtile pdeath_tert=pdeath,nq(3)
gen pdeath_low=pdeath_te==1
gen pdeath_mid=pdeath_te==2
gen pdeath_high=pdeath_te==3

local cvars age_at_core_n0

local ivars female notwhite ///
hs_deg_ind nw_lowest_n0 ///
 smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 ///
smi_liver_ind_n0  smi_hip_ind_n0 smi_nh_ind_n0 ///
religvimp_n0 srh_pf_n0 rel_nb_n0 married_n0  ///
medicaid_n0 champus_n0 medigap_n0 ///
adl_stable adl_decline el_ge3_comorb_1yr_n0 /*i.core_year_n0 ///
hlphrs_high */

foreach x in `cvars' `ivars' eol_spending_quintile {
	if "`x'"!="i.core_year_n0" {
	qui drop if `x'==.
}
}
tab core_to_dod_1yr_n0
di "Bottom third of likelihood of death"
sum pdeath if pdeath_low
sum core_to_dod_1yr_n0 if pdeath_low
di "Middle third"
sum pdeath if pdeath_mid
sum core_to_dod_1yr_n0 if pdeath_mid
di "Top third"
sum pdeath if pdeath_high
sum core_to_dod_1yr_n0 if pdeath_high

foreach x in `ivars' age_cat2_n0 eol_spending_quintile {
	if "`x'"!="i.core_year_n0" {
	tab `x' pdeath_tert, row column nokey
}
}
capture log close
}
sum pdeath
replace pdeath_low=pdeath<=r(mean)
replace pdeath_high=pdeath>r(mean)

gen pdeath_full_sample=1
/*
foreach i in full_sample low high {
qui glm tot_paid_by_mc_12m_wi_n0 `cvars' `ivars' i.eol_spending_3_cat if pdeath_`i', link(log) fam(gamma) eform
qui outreg, stat(e_b p) varlabels
qui glm tot_paid_by_mc_12m_wi_n0 `cvars' `ivars' i.eol_spending_3_cat core_to_dod_1yr_n0 if pdeath_`i', link(log) fam(gamma) eform
qui outreg , stat(e_b p) varlabels merge
if "`i'"=="full_sample" {
qui outreg using `logpath'\propensity_death_tot_spend_halves.rtf, replace varlabels replay ///
title("Probability of death is `i'")
}
else {
qui outreg using `logpath'\propensity_death_tot_spend_halves.rtf, addtable varlabels replay ///
title("Probability of death is `i'")
}
}

foreach i in full_sample low high {
qui logit ind_hosp_adm_p12m_n0 `cvars' `ivars' i.eol_spending_3_cat if pdeath_`i', or
qui outreg, stat(e_b p) varlabels
qui logit ind_hosp_adm_p12m_n0 `cvars' `ivars' i.eol_spending_3_cat core_to_dod_1yr_n0 if pdeath_`i', or
qui outreg , stat(e_b p) varlabels merge
if "`i'"=="full_sample" {
qui outreg using `logpath'\propensity_death_hosp_adm_halves.rtf, replace varlabels replay ///
title("Probability of death is `i'")
}
else {
qui outreg using `logpath'\propensity_death_hosp_adm_halves.rtf, addtable varlabels replay ///
title("Probability of death is `i'")
}
}
*/
/*three groups: <10%,10-25, >25%*/

replace pdeath_low=pdeath<.1
replace pdeath_mid=pdeath>=.1 & pdeath<.25
replace pdeath_high=pdeath>=.25

gen pdeath_group=pdeath_low
replace pdeath_group=2 if pdeath_mid
replace pdeath_group=3 if pdeath_high
label define pdeath_group 1 "Low: <10%" 2 "Mid: 10<=Prob death<25%" 3 "High: >=25%"
label values pdeath_group pdeath_group
foreach i in full_sample low mid high {
qui glm tot_paid_by_mc_12m_wi_n0 `cvars' `ivars' i.eol_spending_3_cat if pdeath_`i', link(log) fam(gamma) eform
qui outreg, stat(e_b p) varlabels
qui glm tot_paid_by_mc_12m_wi_n0 `cvars' `ivars' i.eol_spending_3_cat core_to_dod_1yr_n0 if pdeath_`i', link(log) fam(gamma) eform
qui outreg , stat(e_b p) varlabels merge
if "`i'"=="full_sample" {
qui outreg using `logpath'\propensity_death_tot_spend_lt10gt10gt25.rtf, replace varlabels replay ///
title("Probability of death is `i'")
}
else {
qui outreg using `logpath'\propensity_death_tot_spend_lt10gt10gt25.rtf, addtable varlabels replay ///
title("Probability of death is `i'")
}
}

foreach i in full_sample low mid high {
qui logit ind_hosp_adm_p12m_n0 `cvars' `ivars' i.eol_spending_3_cat if pdeath_`i', or
qui outreg, stat(e_b p) varlabels
qui logit ind_hosp_adm_p12m_n0 `cvars' `ivars' i.eol_spending_3_cat core_to_dod_1yr_n0 if pdeath_`i', or
qui outreg , stat(e_b p) varlabels merge
if "`i'"=="full_sample" {
qui outreg using `logpath'\propensity_death_hosp_adm_lt10gt10gt25.rtf, replace varlabels replay ///
title("Probability of death is `i'")
}
else {
qui outreg using `logpath'\propensity_death_hosp_adm_lt10gt10gt25.rtf, addtable varlabels replay ///
title("Probability of death is `i'")
}
}

foreach blue in red {
capture log close 
log using `logpath'\propensity_death_sum_vars.txt, text replace

tab pdeath_group core_to_dod_1yr_n0, row col

mat tab=J(3,9,.)
local r=1
local c=1
forvalues i=1/3 {
	foreach g in "0,1" 0 1 {
		qui sum tot_paid_by_mc_12m_wi_n0 if pdeath_group==`i' & inlist(core_to_dod_1yr_n0,`g'),d
		mat tab[`r',`c']=r(p50)
		mat tab[`r',`c'+1]=r(mean)
		mat tab[`r',`c'+2]=r(sd)
		local r=`r'+1
}
	local r=1
	local c=`c'+3
}
mat rownames tab="Full Sample" "Survived" "Died"

frmttable, statmat(tab) title(MC Spending by death and probability of death) ///
ctitles("""" "Low: <10%" """" "Mid: 10<=Prob death<25%" """" "High: >=25%"\"" ///
"Median" "Mean" "SD" "Median" "Mean" "SD" "Median" "Mean" "SD") note(2012$ WI adjusted)
}

tab hs_admit_p12m_n0 

gen mult_ip_adm_p12m_n0=n_ip_admit_p12m_n0>1
gen mult_ed_vis_p12m_n0=n_ed_ip_p12m_n0+n_ed_op_visits_p12m_n0>=2
gen ind_icu_vis_p12m_n0=n_icu_admit_p12m_n0>=1
tab loc_hosp_x
replace loc_hosp_x=0 if core_to_dod_1yr_n0==0
label var loc_hosp_x "Death in the hospital within one year"
label var mult_ip_adm_p12m_n0 "Multiple hospital admissions 12m after ivw"
label var mult_ed_vis_p12m_n0 "Multiple ED visits 12m after ivw"
label var ind_icu_vis_p12m_n0 "Indicator any ICU days 12m after ivw"
local yvars hs_admit_p12m_n0 mult_ip_adm_p12m_n0 mult_ed_vis_p12m_n0 ///
 ind_icu_vis_p12m_n0 loc_hosp_x
tokenize yvars


foreach x in hs_admit_p12m_n0 mult_ip_adm_p12m_n0 mult_ed_vis_p12m_n0 ///
 ind_icu_vis_p12m_n0 loc_hosp_x {
	if "`x'"=="hs_admit_p12m_n0" {
		local j="hs_adm"
}
	else if "`x'"=="mult_ip_adm_p12m_n0"{
		local j="mult_adm"
}
	else if "`x'"=="loc_hosp_x" {
		local j="death_in_hosp"
}
	else if "`x'"=="mult_ed_vis_p12m_n0" {
		local j="mult_ed"
}
	else if "`x'"=="ind_icu_vis_p12m_n0" {
		local j="ind_icu"
}
	foreach i in full_sample low mid high {
		qui logit `x' `cvars' `ivars' i.eol_spending_3_cat if pdeath_`i', or
		qui outreg, stat(e_b p) varlabels
		qui logit `x' `cvars' `ivars' i.eol_spending_3_cat core_to_dod_1yr_n0 if pdeath_`i', or
		qui outreg , stat(e_b p) varlabels merge
		if "`i'"=="full_sample" {
		qui outreg using `logpath'\propensity_death_`j'_lt10gt10gt25.rtf, replace varlabels replay ///
		title("Probability of death is `i'")
}
	else {
		qui outreg using `logpath'\propensity_death_`j'_lt10gt10gt25.rtf, addtable varlabels replay ///
		title("Probability of death is `i'")
}
}
}

save n0_n1_p1_p2_x_criteria_a_death_propensity.dta, replace


H="different model specs"
capture log close

import excel "E:\data\Dartmouth_misc\EOL_mc_2yrs_HRR\DAP_HRR_03_07_to_merge.xls", sheet("Sheet1") firstrow case(lower) clear
keep hrr totalmedic
rename hrr hrr_number_n0
xtile eol_spending_quintile=tot, nq(5)
xtile eol_spending_quartile=tot, nq(4)
gen eol_spending_3_cat=eol_spending_quartile
replace eol_spending_3_cat=eol_spending_3_cat-1 if inlist(eol_spending_3_cat,3,4)
label define eol_spending_3_cat 1 "Bottome Quartile" 2 "Middle 50%" 3 "Top quartile"
label values eol_spending_3_cat eol_spending_3_cat
gen eol_spending_low=eol_spending_3_cat==1
gen eol_spending_mid=eol_spending_3_cat==2
gen eol_spending_high=eol_spending_3_cat==3
label var eol_spending_low "Bottom Quartile EOL spending by Dartmouth HRR"
label var eol_spending_mid "Middle 50% EOL spending by Dartmouth HRR"
label var eol_spending_high "Top Quartile EOL spending by Dartmouth HRR"
label var eol_spending_3_cat "EOL Spending Group by Dartmouth HRR, Adjusted"
label var eol_spending_quintile "EOL Spending Quintile by Dartmouth HRR, Adjusted"
tempfile temp1
save "`temp1'"

clear all
set more off

local logpath E:\data\serious_ill\logs
local datapath E:\data\serious_ill\final_data

*log using "`logpath'\model_`orange'_tables_inc_24m_symptoms_helper", text replace
cd `datapath'

use n0_n1_p1_p2_x_criteria_a_v1.dta if core_year_n0<2012
merge m:1 hrr_number_n0 using "`temp1'", keep(match master) nogen
drop if hospital_care_intensity_n0==.
gen age2=age_at_core_n0^2
tab age_cat2_n0, gen(age_n0_ind)
gen age_veryold=age_at_core_n0>=85
gen religvimp_n0=1 if imprelig_n0==1
replace religvimp_n0=0 if inlist(imprelig_n0,2,3,4)
tab religvimp_n0, missing
gen smi_any_n0=1 if smi_count_n0>0
replace smi_any_n0=0 if smi_count_n0==0
tab smi_any_n0, m
qui xtile quint_cd_n0=contact_days_n0, nq(5)
qui xtile quintile_dm_2yr=tot_eol_spending_hrr_n0, nq(5)
gen white=re_white
gen black=re_black
gen hisp=re_hisp
gen notwhite=re_white==0 if re_white!=.
label var notwhite "Not non-Hispanic White"
tab quintile_dm_2yr, m
la var quintile_dm_2yr "Quintiles of 2 year Dartmouth EOL Medicare Spending, HRR level (within this sample)"
la val quintile_dm_2yr quint

sum tot_eol_spending_hrr_n0 if quintile_dm_2yr==1, detail
sum tot_eol_spending_hrr_n0 if quintile_dm_2yr==2, detail
sum tot_eol_spending_hrr_n0 if quintile_dm_2yr==3, detail
sum tot_eol_spending_hrr_n0 if quintile_dm_2yr==4, detail
sum tot_eol_spending_hrr_n0 if quintile_dm_2yr==5, detail


tab quintile_dm_2yr, gen(d_eol_spend_quint) missing
sum hlphrs,d
gen hlphrs_group=hlphrs>r(p50)
replace hlphrs_group=2 if hlphrs>r(p75)
gen hlphrs_high=hlphrs_group==2
gen cd2=contact_days_n0^2



qui xtile hci=hospital_care_intensity_n0, nq(5)

gen adl_stable=adl_stable_partial_n0n1
replace adl_stable=1 if adl_stable_severe_n0n==1
gen adl_decline=adl_change_i_m_n0n1 
replace adl_decline=1 if adl_change_i_s_n0n1==1
replace adl_decline=1 if adl_change_m_s_n0n1==1

gen mult_ip_adm_p12m_n0=n_ip_admit_p12m_n0>1
gen mult_ed_vis_p12m_n0=n_ed_ip_p12m_n0+n_ed_op_visits_p12m_n0>=2
gen ind_icu_vis_p12m_n0=n_icu_admit_p12m_n0>=1
tab loc_hosp_x
replace loc_hosp_x=0 if core_to_dod_1yr_n0==0
label var loc_hosp_x "Death in the hospital within one year"
label var mult_ip_adm_p12m_n0 "Multiple hospital admissions 12m after ivw"
label var mult_ed_vis_p12m_n0 "Multiple ED visits 12m after ivw"
label var ind_icu_vis_p12m_n0 "Indicator any ICU days 12m after ivw"

foreach orange in 1 2 {
log using `logpath'\model_`orange'_propensity_crosstabs.txt, text replace
foreach blue in 1 {

local matchvars1 age_at_core_n0 female notwhite married_n0 i.nw_quartile_65_n0 ///
hs_deg adl_stable_partial_n0n1 adl_stable_severe_n0n1 adl_change_i_m_n0n1 ///
 adl_change_i_s_n0n1 adl_change_m_s_n0n1 ///
smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 ///
smi_liver_ind_n0  smi_hip_ind_n0 smi_nh_ind_n0 srh_pf_n0 ///
dm_hrs_n1 cancer_hrs_n1 lung_hrs_n1 chf_hrs_n1 bmi_lt25_n0 smoke_curr_n0  ///
adl_diff_bh_n0 iadl_diff_m_n0 fl_diff_wk_many_n0 fl_diff_push_n0 ///
ind_em_ur_adm_12m_n0 rel_nb_n0 medicaid_n0 champus_n0 medigap_n0 ///
adl_index_core_n0 el_ge3_comorb_1yr_n0 i.quint_cd_n0 hlphrs


local matchvars2 age_at_core_n0 female black hisp married_n0 ///
smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 ///
smi_liver_ind_n0  smi_hip_ind_n0 smi_nh_ind_n0 srh_pf_n0 ///
bmi_lt25_n0 smoke_curr_n0  ///
adl_diff_bh_n0 iadl_diff_m_n0 fl_diff_wk_many_n0 fl_diff_push_n0 ///
ind_em_ur_adm_12m_n0 adl_index_core_n0 el_ge3_comorb_1yr_n0 

label var tot_paid_by_mc_12m_wi_n0 "Tot MC Payments, 12M following ivw"


logit core_to_dod_1yr_n0 `matchvars`orange'', nolog or

estat ic
predict pdeath`orange'
drop if pdeath`orange'==.
qui sum pdeath`orange',d
//regional variables, split by quartile of hrr eol spending per dm atlas
local rvars tot_eol_spending_hrr_n0 hospital_care_intensity_n0 ///
	physicians_n0 specialists_n0 hospital_beds_n0


qui xtile pdeath`orange'_tert=pdeath`orange',nq(3)
gen pdeath`orange'_low=pdeath`orange'_te==1
gen pdeath`orange'_mid=pdeath`orange'_te==2
gen pdeath`orange'_high=pdeath`orange'_te==3

local cvars age_at_core_n0

local ivars female notwhite ///
hs_deg_ind nw_lowest_n0 ///
 smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 ///
smi_liver_ind_n0  smi_hip_ind_n0 smi_nh_ind_n0 ///
religvimp_n0 srh_pf_n0 rel_nb_n0 married_n0  ///
medicaid_n0 champus_n0 medigap_n0 ///
adl_stable adl_decline el_ge3_comorb_1yr_n0 /*i.core_year_n0 ///
hlphrs_high */

foreach x in `cvars' `ivars' eol_spending_quintile {
	if "`x'"!="i.core_year_n0" {
	qui drop if `x'==.
}
}
tab core_to_dod_1yr_n0
di "Bottom third of likelihood of death"
sum pdeath`orange' if pdeath`orange'_low
sum core_to_dod_1yr_n0 if pdeath`orange'_low
di "Middle third"
sum pdeath`orange' if pdeath`orange'_mid
sum core_to_dod_1yr_n0 if pdeath`orange'_mid
di "Top third"
sum pdeath`orange' if pdeath`orange'_high
sum core_to_dod_1yr_n0 if pdeath`orange'_high

foreach x in `ivars' age_cat2_n0 eol_spending_quintile {
	if "`x'"!="i.core_year_n0" {
	tab `x' pdeath`orange'_tert, row column nokey
}
}
capture log close
}
sum pdeath`orange'
replace pdeath`orange'_low=pdeath`orange'<=r(mean)
replace pdeath`orange'_high=pdeath`orange'>r(mean)

gen pdeath`orange'_full_sample=1
/*
foreach i in full_sample low high {
qui glm tot_paid_by_mc_12m_wi_n0 `cvars' `ivars' i.eol_spending_3_cat if pdeath`orange'_`i', link(log) fam(gamma) eform
qui outreg, stat(e_b p) varlabels
qui glm tot_paid_by_mc_12m_wi_n0 `cvars' `ivars' i.eol_spending_3_cat core_to_dod_1yr_n0 if pdeath`orange'_`i', link(log) fam(gamma) eform
qui outreg , stat(e_b p) varlabels merge
if "`i'"=="full_sample" {
qui outreg using `logpath'\model_`orange'_propensity_death_tot_spend_halves.rtf, replace varlabels replay ///
title("Probability of death is `i'")
}
else {
qui outreg using `logpath'\model_`orange'_propensity_death_tot_spend_halves.rtf, addtable varlabels replay ///
title("Probability of death is `i'")
}
}

foreach i in full_sample low high {
qui logit ind_hosp_adm_p12m_n0 `cvars' `ivars' i.eol_spending_3_cat if pdeath`orange'_`i', or
qui outreg, stat(e_b p) varlabels
qui logit ind_hosp_adm_p12m_n0 `cvars' `ivars' i.eol_spending_3_cat core_to_dod_1yr_n0 if pdeath`orange'_`i', or
qui outreg , stat(e_b p) varlabels merge
if "`i'"=="full_sample" {
qui outreg using `logpath'\model_`orange'_propensity_death_hosp_adm_halves.rtf, replace varlabels replay ///
title("Probability of death is `i'")
}
else {
qui outreg using `logpath'\model_`orange'_propensity_death_hosp_adm_halves.rtf, addtable varlabels replay ///
title("Probability of death is `i'")
}
}
*/
/*three groups: <10%,10-25, >25%*/

replace pdeath`orange'_low=pdeath`orange'<.1
replace pdeath`orange'_mid=pdeath`orange'>=.1 & pdeath`orange'<.25
replace pdeath`orange'_high=pdeath`orange'>=.25

gen pdeath`orange'_group=pdeath`orange'_low
replace pdeath`orange'_group=2 if pdeath`orange'_mid
replace pdeath`orange'_group=3 if pdeath`orange'_high
label define pdeath`orange'_group 1 "Low: <10%" 2 "Mid: 10<=Prob death<25%" 3 "High: >=25%"
label values pdeath`orange'_group pdeath`orange'_group
foreach i in full_sample low mid high {
qui glm tot_paid_by_mc_12m_wi_n0 `cvars' `ivars' i.eol_spending_3_cat if pdeath`orange'_`i', link(log) fam(gamma) eform
qui outreg, stat(e_b p) varlabels
qui glm tot_paid_by_mc_12m_wi_n0 `cvars' `ivars' i.eol_spending_3_cat core_to_dod_1yr_n0 if pdeath`orange'_`i', link(log) fam(gamma) eform
qui outreg , stat(e_b p) varlabels merge
if "`i'"=="full_sample" {
qui outreg using `logpath'\model_`orange'_propensity_death_tot_spend_lt10gt10gt25.rtf, replace varlabels replay ///
title("Probability of death is `i'")
}
else {
qui outreg using `logpath'\model_`orange'_propensity_death_tot_spend_lt10gt10gt25.rtf, addtable varlabels replay ///
title("Probability of death is `i'")
}
}

foreach i in full_sample low mid high {
qui logit ind_hosp_adm_p12m_n0 `cvars' `ivars' i.eol_spending_3_cat if pdeath`orange'_`i', or
qui outreg, stat(e_b p) varlabels
qui logit ind_hosp_adm_p12m_n0 `cvars' `ivars' i.eol_spending_3_cat core_to_dod_1yr_n0 if pdeath`orange'_`i', or
qui outreg , stat(e_b p) varlabels merge
if "`i'"=="full_sample" {
qui outreg using `logpath'\model_`orange'_propensity_death_hosp_adm_lt10gt10gt25.rtf, replace varlabels replay ///
title("Probability of death is `i'")
}
else {
qui outreg using `logpath'\model_`orange'_propensity_death_hosp_adm_lt10gt10gt25.rtf, addtable varlabels replay ///
title("Probability of death is `i'")
}
}

foreach blue in red {
capture log close 
log using `logpath'\model_`orange'_propensity_death_sum_vars.txt, text replace

tab pdeath`orange'_group core_to_dod_1yr_n0, row col

mat tab=J(3,9,.)
local r=1
local c=1
forvalues i=1/3 {
	foreach g in "0,1" 0 1 {
		qui sum tot_paid_by_mc_12m_wi_n0 if pdeath`orange'_group==`i' & inlist(core_to_dod_1yr_n0,`g'),d
		mat tab[`r',`c']=r(p50)
		mat tab[`r',`c'+1]=r(mean)
		mat tab[`r',`c'+2]=r(sd)
		local r=`r'+1
}
	local r=1
	local c=`c'+3
}
mat rownames tab="Full Sample" "Survived" "Died"

frmttable, statmat(tab) title(MC Spending by death and probability of death) ///
ctitles("""" "Low: <10%" """" "Mid: 10<=Prob death<25%" """" "High: >=25%"\"" ///
"Median" "Mean" "SD" "Median" "Mean" "SD" "Median" "Mean" "SD") note(2012$ WI adjusted)
}

tab hs_admit_p12m_n0 


local yvars hs_admit_p12m_n0 mult_ip_adm_p12m_n0 mult_ed_vis_p12m_n0 ///
 ind_icu_vis_p12m_n0 loc_hosp_x
tokenize yvars


foreach x in hs_admit_p12m_n0 mult_ip_adm_p12m_n0 mult_ed_vis_p12m_n0 ///
 ind_icu_vis_p12m_n0 loc_hosp_x {
	if "`x'"=="hs_admit_p12m_n0" {
		local j="hs_adm"
}
	else if "`x'"=="mult_ip_adm_p12m_n0"{
		local j="mult_adm"
}
	else if "`x'"=="loc_hosp_x" {
		local j="death_in_hosp"
}
	else if "`x'"=="mult_ed_vis_p12m_n0" {
		local j="mult_ed"
}
	else if "`x'"=="ind_icu_vis_p12m_n0" {
		local j="ind_icu"
}
	foreach i in full_sample low mid high {
		qui logit `x' `cvars' `ivars' i.eol_spending_3_cat if pdeath`orange'_`i', or
		qui outreg, stat(e_b p) varlabels
		qui logit `x' `cvars' `ivars' i.eol_spending_3_cat core_to_dod_1yr_n0 if pdeath`orange'_`i', or
		qui outreg , stat(e_b p) varlabels merge
		if "`i'"=="full_sample" {
		qui outreg using `logpath'\model_`orange'_propensity_death_`j'_lt10gt10gt25.rtf, replace varlabels replay ///
		title("Probability of death is `i'")
}
	else {
		qui outreg using `logpath'\model_`orange'_propensity_death_`j'_lt10gt10gt25.rtf, addtable varlabels replay ///
		title("Probability of death is `i'")
}
}
	foreach i in full_sample low mid high {
		qui logit `x' `cvars' `ivars' i.eol_spending_3_cat if pdeath`orange'_`i', or
		margins, dydx(*) post
		qui outreg, stat(b p) varlabels
		qui logit `x' `cvars' `ivars' i.eol_spending_3_cat core_to_dod_1yr_n0 if pdeath`orange'_`i', or
		margins, dydx(*) post
		qui outreg, stat(b p) varlabels merge
		if "`i'"=="full_sample" {
		qui outreg using `logpath'\model_`orange'_propensity_death_`j'_margins.rtf, ///
		replace varlabels replay ///
		title("Probability of death is `i'")
}
	else {
		qui outreg using `logpath'\model_`orange'_propensity_death_`j'_margins.rtf, ///
		addtable varlabels replay ///
		title("Probability of death is `i'")
}
}

}
log close
}
save n0_n1_p1_p2_x_criteria_a_death_propensity.dta, replace


H="sample chars by death propensity group"
clear all
set more off

local logpath E:\data\serious_ill\logs
local datapath E:\data\serious_ill\final_data

cd `datapath'

use  n0_n1_p1_p2_x_criteria_a_death_propensity.dta

local cvars age_at_core_n0 networth_adj2012_n0
rename pdeath1* pdeath*
local ivars female re_black re_white re_hisp re_other_unk ///
educ_level_lt_hs educ_level_hs educ_level_somcol educ_level_col ///
srh_pf_n0 srh_g_n0 srh_ve_n0 married_n0 smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 ///
smi_diab_compl_ind_n0 smi_liver_ind_n0 smi_als_ind_n0 smi_hip_ind_n0 el_ge3_comorb_1yr_n0 ///
adl_stable_ind_n0n1 adl_stable_partial_n0n1 adl_stable_severe_n0n1 ///
adl_change_i_m_n0n1 adl_change_i_s_n0n1 adl_change_m_s_n0n1 adl_stable adl_decline ///
ser_med_illness_n0 adl_impair_core_n0 smi_and_adl_n0 smi_nh_ind_n0 ind_em_ur_adm_12m_n0 ///
eol_spending_low eol_spending_mid eol_spending_high int_intubation_12m int_trach_12m ///
int_gastro_tude_12m int_hemodia_12m int_enteral_nut_12m int_cpr_12m int_any_12m 
gen miss=0

foreach x in `cvars' `ivars' {

replace miss=1 if `x'==.
}
drop if miss==1
local rn : word count `cvars' `ivars' 1


mat tab1=J(`rn',8,.)
local r=1
local c=1

foreach i in full_sample low mid high {
	foreach x of local cvars {
		qui sum `x' if pdeath_`i'==1 
		mat tab1[`r',`c']=r(mean)
		mat tab1[`r',`c'+1]=r(sd)
		local r=`r'+1
}
	foreach x of local ivars {
		qui sum `x' if pdeath_`i'==1
		mat tab1[`r',`c']=r(mean)*r(N)
		mat tab1[`r',`c'+1]=r(mean)*100
		local r=`r'+1
}
	mat tab1[`r',`c']=r(N)
	local r=1
	local c=`c'+2
}
mat rownames tab1=`cvars' `ivars' N

frmttable using `logpath'\table_1_and_outcomes_pdeath_3_groups.doc, replace statmat(tab1) varlabels  title("Sample Characteristics by Propensity 1 yr Mortality") ///
 ctitles("" "Full Sample Mean/N" "SD/%" "Prob death Low Mean/N" "SD/%" "Med" "SD/%" "High" "SD/%") ///
 sdec(2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\0,2,0,2,0,2,0,2) ///
 note("Death propensity modeled on age; sex; race/ethnicity (black/hispanic/other); married; SMI indicators for dementia, cancer, ESRD, CHF, COPD, diabetes, hip fracture," ///
"and nursing home status; BMI <25; smoking status; difficulty bathing, handling money, walking, and pushing/pulling; index of assistance with ADLs; prior year urgent/emergent admission; >=3 Elixhauser comorbidities; and indicator for SRH poor/fair" ///
"HRR spending Quartile last two years of life 2003-2007") 
	

mat tab1=J(`rn',6,.)
local r=1
local c=1

foreach i in low mid high {
	foreach x of local cvars {
		qui sum `x' if pdeath_`i'==1 
		mat tab1[`r',`c']=r(mean)
		capture ttest `x' if pdeath_low==1 | pdeath_`i'==1, by(pdeath_group)
		mat tab1[`r',`c'+1]=r(p)
		local r=`r'+1
}
	foreach x of local ivars {
		qui sum `x' if pdeath_`i'==1
		mat tab1[`r',`c']=r(mean)*100
		qui tab `x' pdeath_group if pdeath_low==1 | pdeath_`i'==1, chi2
		mat tab1[`r',`c'+1]=r(p)
		local r=`r'+1
}
	qui sum `x' if pdeath_`i'==1
	mat tab1[`r',`c']=r(N)
	local r=1
	local c=`c'+2
}
mat rownames tab1=`cvars' `ivars' N

frmttable using `logpath'\table_1_and_outcomes_pdeath_3_groups.doc, addtable statmat(tab1) varlabels  title("Sample Characteristics by Propensity 1 yr Mortality") ///
 ctitles("" "Prob death Low Mean/%" "" "Prob death Med" "P" "Prob death High" "P") ///
 sdec(2,3,2,3,2,3) ///
 note("HRR spending Quartile last two years of life 2003-2007" "P-values compared to baseline of low probability group")

 
 
local outcome3 ind_hosp_adm_p12m_n0 ///
 mult_ip_adm_p12m_n0 mult_ed_vis_p12m_n0 ///
 ind_icu_vis_p12m_n0 hs_admit_p12m_n0 ///
 core_to_dod_1yr_n0 loc_hosp_x

local outcome2 n_hospd_p12m_n0

local outcome1 ip_paid_by_mc_12m_wi_n0 snf_paid_by_mc_12m_wi_n0 hh_paid_by_mc_12m_wi_n0 ///
 hs_paid_by_mc_12m_wi_n0 pb_paid_by_mc_12m_wi_n0 op_paid_by_mc_12m_wi_n0 ///
 dm_paid_by_mc_12m_wi_n0 tot_paid_by_mc_12m_wi_n0   
 
local rn : word count `outcome1' `outcome1' `outcome2' `outcome2' `outcome3' 1


mat tab1=J(`rn',8,.)
local r=1
local c=1

foreach i in full_sample low mid high {
	foreach x in `outcome1' `outcome2' {
		sum `x' if pdeath_`i'==1,d
		mat tab1[`r',`c']=r(mean)
		mat tab1[`r',`c'+1]=r(sd)
		mat tab1[`r'+1,`c']=r(p50)
		local r=`r'+2
}
	foreach x in `outcome3' {
		qui sum `x' if pdeath_`i'==1
		mat tab1[`r',`c']=r(mean)*r(N)
		mat tab1[`r',`c'+1]=r(mean)*100
		local r=`r'+1
}
	mat tab1[`r',`c']=r(N)
	local r=1
	local c=`c'+2
}
mat rownames tab1="IP MC payments 12m post ivw" ///
"	Median" "SNF MC payments 12m post ivw" ///
"	Median" "HH MC payments 12m post ivw" ///
"	Median" "HS MC payments 12m post ivw" ///
"	Median" "PB MC payments 12m post ivw" ///
"	Median" "OP MC payments 12m post ivw" ///
"	Median" "DME MC payments 12m post ivw" ///
"	Median" "Total MC payments 12m post ivw" ///
"	Median" "n hospital nights 12m post ivw" ///
"	Median"  `outcome3' N

frmttable using `logpath'\table_1_and_outcomes_pdeath_3_groups.doc,  addtable ///
statmat(tab1) varlabels  title("One Year Outcomes by Propensity 1 yr Mortality") ///
 ctitles("" "Full Sample Mean/N" "SD/%" "Prob death Low Mean/N" "SD/%" "Med" "SD/%" "High" "SD/%") ///
 sdec(2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\ ///
 2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\ ///
 2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\0,2,0,2,0,2,0,2) ///
 /*rtitles("IP MC payments 12m post ivw (mean,SD)" \ ///
"	Median"\"SNF MC payments 12m post ivw (mean,SD)" \ ///
"	Median"\"HH MC payments 12m post ivw (mean,SD)" \ ///
"	Median"\"HS MC payments 12m post ivw (mean,SD)" \ ///
"	Median"\"PB MC payments 12m post ivw (mean,SD)" \ ///
"	Median"\"OP MC payments 12m post ivw (mean,SD)" \ ///
"	Median"\"DME MC payments 12m post ivw (mean,SD)" \ ///
"	Median"\"Total MC payments 12m post ivw (mean,SD)" \ ///
"	Median"\"n hospital nights 12m post ivw (mean,SD)" \ ///
"	Median" ind_hosp_adm_p12m_n0\ ///
 mult_ip_adm_p12m_n0\ mult_ed_vis_p12m_n0\ ///
 ind_icu_vis_p12m_n0\ hs_admit_p12m_n0\ ///
 core_to_dod_1yr_n0\ loc_hosp_x\ N) ///
*/ note("All costs WI adjusted 2012$"\"P-values compared to baseline of low probability group") 
local rn : word count `outcome1'  `outcome2' `outcome3' 1
	

mat tab1=J(`rn',6,.)
local r=1
local c=1

foreach i in low mid high {
	foreach x in `outcome1' `outcome2' {
		qui sum `x' if pdeath_`i'==1 
		mat tab1[`r',`c']=r(mean)
		capture ttest `x' if pdeath_low==1 | pdeath_`i'==1, by(pdeath_group)
		mat tab1[`r',`c'+1]=r(p)
		local r=`r'+1
}
	foreach x in `outcome3' {
		qui sum `x' if pdeath_`i'==1
		mat tab1[`r',`c']=r(mean)*100
		qui tab `x' pdeath_group if pdeath_low==1 | pdeath_`i'==1, chi2
		mat tab1[`r',`c'+1]=r(p)
		local r=`r'+1
}
	qui sum `x' if pdeath_`i'==1
	mat tab1[`r',`c']=r(N)
	local r=1
	local c=`c'+2
}
mat rownames tab1=`outcome1' `outcome2' `outcome3' N

frmttable using `logpath'\table_1_and_outcomes_pdeath_3_groups.doc,  addtable ///
statmat(tab1) varlabels  title("One Year Outcomes by Propensity 1 yr Mortality") ///
 ctitles("" "Prob death Low Mean/%" "" "Prob death Med" "P" "Prob death High" "P") ///
 sdec(2,3,2,3,2,3) ///
 note("All costs WI adjusted 2012$" "P-values compared to baseline of low probability group")
preserve
gen tot1000=tot_paid_by_mc_12m_wi_n0/1000
collapse (mean)tot= tot1000 (sd) sd=tot1000 (count) n=tot1000, by(pdeath_group core_to_dod_1yr_n0)
label var tot "Total paid by Medicare 12m post ivw, 1000s of WI 2012$"
 gen hitot=tot+invttail(n-1,0.025)*(sd/sqrt(n))
gen lotot=tot-invttail(n-1,0.025)*(sd/sqrt(n))
graph twoway (bar tot core) (rcap hitot lotot core), by(pde)
graph save `logpath'\mean_spend_by_pdeath_ci, replace
graph twoway (bar tot pde) (rcap hitot lotot pde), by(core)
graph save `logpath'\mean_spend_by_mortality_ci, replace

export excel using "E:\data\serious_ill\logs\spending_means_by_group_for_bars.xls", sheetreplace firstrow(varlabels )
restore
foreach x in `outcome1' `outcome2' `outcome3' {
	sum `x'
}


H="adjusted and unadjusted models by propensity"
local logpath E:\data\serious_ill\logs
local datapath E:\data\serious_ill\final_data
capture log close
*log using "`logpath'\tables_inc_24m_symptoms_helper", text replace
cd `datapath'
log using `logpath'\propensity_death_adjusted_and_unadjusted_log.txt, text replace

use n0_n1_p1_p2_x_criteria_a_death_propensity.dta, clear 

local cvars age_at_core_n0

local ivars female notwhite ///
hs_deg_ind nw_lowest_n0 ///
 smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 ///
smi_liver_ind_n0  smi_hip_ind_n0 smi_nh_ind_n0 ///
religvimp_n0 srh_pf_n0 rel_nb_n0 married_n0  ///
medicaid_n0 champus_n0 medigap_n0 ///
adl_stable adl_decline el_ge3_comorb_1yr_n0

local mvars  smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 ///
smi_liver_ind_n0  smi_hip_ind_n0 smi_nh_ind_n0 ///
srh_pf_n0 adl_stable adl_decline el_ge3_comorb_1yr_n0

local nvars age_at_core_n0 female notwhite ///
hs_deg_ind nw_lowest_n0 ///
religvimp_n0 rel_nb_n0 married_n0  ///
medicaid_n0 champus_n0 medigap_n0 ///

local rn : word count `nvars' `mvars' 1 1 
mat tab1=J(`rn',8,.)
local r=1
local c=1
foreach y in _full_sample _low _mid _high {
	foreach x in `nvars' `mvars' {
		qui glm tot_paid_by_mc_12m_wi_n0 `x' if pdeath`y'==1, fam(gamma) link(log) eform
		mat beta=e(b)
		mat tab1[`r',`c']=exp(beta[1,1])
		mat p=r(table)
		mat tab1[`r',`c'+1]=p[4,1]
		local r=`r'+1
}
	qui glm tot_paid_by_mc_12m_wi_n0 i.eol_spending_3_cat if pdeath`y'==1, fam(gamma) link(log) eform
	mat p=r(table)
	mat tab1[`r',`c']=p[1,2]
	mat tab1[`r'+1,`c']=p[1,3]
	mat tab1[`r',`c'+1]=p[4,2]
	mat tab1[`r'+1,`c'+1]=p[4,3]

	local c=`c'+2
	local r=1
}

mat rownames tab1=`nvars' `mvars' eol_spending_mid eol_spending_high

frmttable using `logpath'\propensity_death_tot_unadjusted, statmat(tab1) ctitles("" "Full Sample" "p" ///
 "Prob <.1" "p" "Prob .1-.25" "p" "Prob >.25" "p") ///
title("Unadjusted regressions, 12m spending") ///
note("all models are glm with family gamma and link log, exponentiated coefficients" ///
"Total Medicare spending WI adjusted 2012$") sdec(3) varlabels replace

local i=1
local j "Full Sample" 


foreach y in _full_sample _low _mid _high {
	local k=1
	if `i'==2 {
		local j "Probability of death <.10"
}
	if `i'==3 {
		local j "Probability of death .10-.25"
}
	if `i'==4 {
		local j "Probability of death >.25"
}
	qui glm tot_paid_by_mc_12m_wi_n0 `nvars' `mvars' eol_spending_mid eol_spending_high if pdeath`y'==1, fam(gamma) link(log) eform
	qui outreg, varlabels ctitles("" "`k'") stats(e_b p)
	local k=`k'+1
	foreach x in `mvars' {
		if "`x'"!="adl_stable" {
			if "`x'"=="adl_decline" {
				qui glm tot_paid_by_mc_12m_wi_n0 `nvars' eol_spending_mid eol_spending_high adl_stable `x'  if pdeath`y'==1, fam(gamma) link(log) eform
}
			else {
				qui glm tot_paid_by_mc_12m_wi_n0 `nvars' eol_spending_mid eol_spending_high `x' if pdeath`y'==1, fam(gamma) link(log) eform
}
		qui outreg, merge varlabels ctitles("" "`k'") stats(e_b p)
		local k=`k'+1
}
}
	local i=`i'+1
	outreg using `logpath'\propensity_death_tot_unadjusted, replay addtable ///
	 title("Adjusted Regressions,12m spending" "`j'") ///
 	 note("All models are GLM with family gamma and link log, exponentiated coefficients" ///
	 "Total Medicare spending WI adjusted 2012$" "* p<0.05; ** p<0.01") basefont(fs10)
}

local i=1
local j "Full Sample" 

foreach y in _full_sample _low _mid _high {
	local k=1
	if `i'==2 {
		local j "Probability of death <.10"
}
	if `i'==3 {
		local j "Probability of death .10-.25"
}
	if `i'==4 {
		local j "Probability of death >.25"
}
	qui glm tot_paid_by_mc_12m_wi_n0 `nvars' `mvars' eol_spending_mid eol_spending_high if pdeath`y'==1, fam(gamma) link(log) eform
	qui outreg, varlabels ctitles("" "`k'") stats(e_b p)
	local k=`k'+1
	foreach x in `nvars' eol_spending_mid eol_spending_high {
		qui glm tot_paid_by_mc_12m_wi_n0 `mvars' `x' if pdeath`y'==1, fam(gamma) link(log) eform
		qui outreg, merge varlabels ctitles("" "`k'") stats(e_b p)
		local k=`k'+1
}
	local i=`i'+1
	outreg using `logpath'\propensity_death_tot_unadjusted, replay addtable ///
	 title("Adjusted Regressions, 12m spending" "`j'") ///
	 note("All models are GLM with family gamma and link log, exponentiated coefficients" ///
	 "Total Medicare spending WI adjusted 2012$" "* p<0.05; ** p<0.01") basefont(fs10)
}

/*
local rn : word count `mvars' `nvars' 
mat tab1=J(`rn',6,.)
local r=1
local c=1
foreach y in _full_sample _low _high {
	foreach x in `mvars' {
		qui glm tot_paid_by_mc_12m_wi_n0 `x' `nvars' i.eol_spending_group if pdeath`y'==1, fam(gamma) link(log) eform
		mat beta=e(b)
		mat tab1[`r',`c']=exp(beta[1,1])
		mat p=r(table)
		mat tab1[`r',`c'+1]=p[4,1]
		local r=`r'+1
}		
	foreach x in `nvars' i.eol_spending_group {
		qui glm tot_paid_by_mc_12m_wi_n0 `x' `mvars' if pdeath`y'==1, fam(gamma) link(log) eform
		mat beta=e(b)
		mat tab1[`r',`c']=exp(beta[1,1])
		mat p=r(table)
		mat tab1[`r',`c'+1]=p[4,1]
		local r=`r'+1
}
	local c=`c'+2
	local r=1
}

mat rownames tab1=`mvars' `nvars'

frmttable using `logpath'\propensity_death_tot_unadjusted, statmat(tab1) ctitles("" "Full Sample" "p" ///
 "Prob <.1" "p" "Prob >.25" "p") title("Adjusted regressions, 12m spending") ///
 note("all models are qui glm with family gamma and link log, exponentiated coefficients" ///
 "Coefficients for health variables reflect models controlling for non-health variables and vice versa") ///
 sdec(3) varlabels addtable

*/


frmttable using `logpath'\propensity_death_tot_unadjusted_printable, statmat(tab1) ctitles("" "Full Sample" "p" ///
 "Prob <.1" "p" "Prob >.25" "p") ///
title("Unadjusted regressions, 12m spending") note(all models are glm with family ///
gamma and link log, exponentiated coefficients) sdec(3) varlabels replace

local i=1
local j "Full Sample" 


foreach y in _full_sample _low _mid _high {
	local k=1
	if `i'==2 {
		local j "Probability of death <.10"
}
	if `i'==3 {
		local j "Probability of death .10-.25"
}
	if `i'==4 {
		local j "Probability of death >.25"
}
	qui glm tot_paid_by_mc_12m_wi_n0 `nvars' `mvars' eol_spending_mid eol_spending_high if pdeath`y'==1, fam(gamma) link(log) eform
	qui outreg, varlabels ctitles("" "`k'") stats(e_b p)
	local k=`k'+1
	foreach x in `mvars' {
		if "`x'"!="adl_stable" {
			if "`x'"=="adl_decline" {
				qui glm tot_paid_by_mc_12m_wi_n0 `nvars' eol_spending_mid eol_spending_high adl_stable `x'  if pdeath`y'==1, fam(gamma) link(log) eform
}
			else {	
				qui glm tot_paid_by_mc_12m_wi_n0 `nvars' eol_spending_mid eol_spending_high `x' if pdeath`y'==1, fam(gamma) link(log) eform
}
		qui outreg, merge varlabels ctitles("" "`k'") stats(e_b p)
		local k=`k'+1
		if `k'==8 {
		outreg using `logpath'\propensity_death_tot_unadjusted_printable, replay addtable ///
		 title("Adjusted Regressions, 12m spending" "`j'") ///
		 note("All models are GLM with family gamma and link log, exponentiated coefficients" ///
		 "Total Medicare spending WI adjusted 2012$" "* p<0.05; ** p<0.01") basefont(fs10)
		local k=1
		qui glm tot_paid_by_mc_12m_wi_n0 `nvars' `mvars' eol_spending_mid eol_spending_high if pdeath`y'==1, fam(gamma) link(log) eform
		qui outreg, varlabels ctitles("" "`k'") stats(e_b p)
		local k=8
}
}
}

	local i=`i'+1
	outreg using `logpath'\propensity_death_tot_unadjusted_printable, replay addtable ///
	 title("Adjusted Regressions,12m spending" "`j'") ///
 	 note("All models are GLM with family gamma and link log, exponentiated coefficients" ///
	 "Total Medicare spending WI adjusted 2012$" "* p<0.05; ** p<0.01") basefont(fs10)
}

local i=1
local j "Full Sample" 

foreach y in _full_sample _low _mid _high {
	local k=1
	if `i'==2 {
		local j "Probability of death <.10"
}
	if `i'==3 {
		local j "Probability of death .10-.25"
}
	if `i'==4 {
		local j "Probability of death >.25"
}
	qui glm tot_paid_by_mc_12m_wi_n0 `nvars' `mvars' eol_spending_mid eol_spending_high if pdeath`y'==1, fam(gamma) link(log) eform
	qui outreg, varlabels ctitles("" "`k'") stats(e_b p)
	local k=`k'+1
	foreach x in `nvars' "eol_spending_mid eol_spending_high" {
		qui glm tot_paid_by_mc_12m_wi_n0 `mvars' `x' if pdeath`y'==1, fam(gamma) link(log) eform
		qui outreg, merge varlabels ctitles("" "`k'") stats(e_b p)
		local k=`k'+1
	if `k'==8 {
		outreg using `logpath'\propensity_death_tot_unadjusted_printable, replay addtable ///
		 title("Adjusted Regressions, 12m spending" "`j'") ///
		 note("All models are GLM with family gamma and link log, exponentiated coefficients" ///
		 "Total Medicare spending WI adjusted 2012$" "* p<0.05; ** p<0.01") basefont(fs10)
		local k=1
		qui glm tot_paid_by_mc_12m_wi_n0 `nvars' `mvars' eol_spending_mid eol_spending_high if pdeath`y'==1, fam(gamma) link(log) eform
		qui outreg, varlabels ctitles("" "`k'") stats(e_b p)
		local k=8
}
}
	outreg using `logpath'\propensity_death_tot_unadjusted_printable, replay addtable ///
	 title("Adjusted Regressions,12m spending" "`j'") ///
 	 note("All models are GLM with family gamma and link log, exponentiated coefficients" ///
	 "Total Medicare spending WI adjusted 2012$" "* p<0.05; ** p<0.01") basefont(fs10)
	local i=`i'+1

}


H="pulling in continuous fee for service by month"
libname ser_ill "E:\data\serious_ill\final_data";
libname medi "E:\data\cms_DUA_24548_2012";
proc import datafile="E:\data\serious_ill\final_data\n0_n1_p1_p2_x_criteria_a_death_propensity.dta" out=serill; 
run;

data serill2;
set serill;
keep bid_hrs c_ivw_year_n0 c_ivw_month_n0;
run;

data denom;
set medi.dn_2000_2012;
run;

proc sql;
create table dn as select 
a.*,b.buyin12 as buyin1,b.year,b.HMOIND12 as hmoind1 from
serill2 a 
left join
denom b 
on a.bid_hrs=b.bid_hrs_21 and a.c_ivw_year_n0=b.year;
quit;

proc sql;
create table dn2 as select 
a.*,b.buyin12 as buyin2,b.year,b.HMOIND12 as hmoind2 from
serill2 a 
left join
denom b 
on a.bid_hrs=b.bid_hrs_21 and a.c_ivw_year_n0+1=b.year;
quit;

proc sql;
create table dn3 as select * from
dn a
left join 
dn2 b
on a.bid_hrs=b.bid_hrs and a.c_ivw_month_n0=b.c_ivw_month_n0;
quit;

data dn4;
set dn3;
buyin1a=substr(buyin1,c_ivw_month_n0,13-c_ivw_month_n0);
hmoind1a=substr(hmoind1,c_ivw_month_n0,13-c_ivw_month_n0);
buyin_2y=trim(buyin1a) || trim(buyin2);
hmo_2y=trim(hmoind1a) || trim(hmoind2);

/*create length of continous a&b and non-hmo coverage vars*/
if indexc(buyin_2y,"0","1","2","A","B")=0 then part_ab_p_mos=length(buyin_2y)-1;
if indexc(buyin_2y,"0","1","2","A","B") then part_ab_p_mos=indexc(buyin_2y,"0","1","2","A","B")-2;
if indexc(hmo_2y,"1","2","4","A","B","C")=0 then non_hmo_d_p_mos=length(hmo_2y)-1;
if indexc(hmo_2y,"1","2","4","A","B","C") then non_hmo_d_p_mos=indexc(hmo_2y,"1","2","4","A","B","C")-2;
if part_ab_p_mos<=non_hmo_d_p_mos then cont_ffs_p_mos=part_ab_p_mos;
if non_hmo_d_p_mos<part_ab_p_mos then cont_ffs_p_mos=non_hmo_d_p_mos;
if cont_ffs_p_mos>12 then cont_ffs_p_mos=12;
if cont_ffs_p_mos<0 then cont_ffs_p_mos=0;
run;

proc export data=dn4 outfile="E:\data\serious_ill\int_data\insurance_a.dta" replace; run;


H="***********************************"


H="different model specs"
capture log close

import excel "E:\data\Dartmouth_misc\EOL_mc_2yrs_HRR\DAP_HRR_03_07_to_merge.xls", sheet("Sheet1") firstrow case(lower) clear
keep hrr totalmedic
rename hrr hrr_number_n0
xtile eol_spending_quintile=tot, nq(5)
xtile eol_spending_quartile=tot, nq(4)
gen eol_spending_3_cat=eol_spending_quartile
replace eol_spending_3_cat=eol_spending_3_cat-1 if inlist(eol_spending_3_cat,3,4)
label define eol_spending_3_cat 1 "Bottome Quartile" 2 "Middle 50%" 3 "Top quartile"
label values eol_spending_3_cat eol_spending_3_cat
gen eol_spending_low=eol_spending_3_cat==1
gen eol_spending_mid=eol_spending_3_cat==2
gen eol_spending_high=eol_spending_3_cat==3
label var eol_spending_low "Bottom Quartile EOL spending by Dartmouth HRR"
label var eol_spending_mid "Middle 50% EOL spending by Dartmouth HRR"
label var eol_spending_high "Top Quartile EOL spending by Dartmouth HRR"
label var eol_spending_3_cat "EOL Spending Group by Dartmouth HRR, Adjusted"
label var eol_spending_quintile "EOL Spending Quintile by Dartmouth HRR, Adjusted"
tempfile temp1
save "`temp1'"

clear all
set more off

local logpath E:\data\serious_ill\logs
local datapath E:\data\serious_ill\final_data

cd `datapath'

use n0_n1_p1_p2_x_criteria_a_v1.dta if core_year_n0<2012
merge m:1 hrr_number_n0 using "`temp1'", keep(match master) nogen
drop if hospital_care_intensity_n0==.
gen age2=age_at_core_n0^2
tab age_cat2_n0, gen(age_n0_ind)
gen age_veryold=age_at_core_n0>=85
gen religvimp_n0=1 if imprelig_n0==1
replace religvimp_n0=0 if inlist(imprelig_n0,2,3,4)
tab religvimp_n0, missing
gen smi_any_n0=1 if smi_count_n0>0
replace smi_any_n0=0 if smi_count_n0==0
tab smi_any_n0, m
qui xtile quint_cd_n0=contact_days_n0, nq(5)
qui xtile quintile_dm_2yr=tot_eol_spending_hrr_n0, nq(5)
gen white=re_white
gen black=re_black
gen hisp=re_hisp
gen notwhite=re_white==0 if re_white!=.
label var notwhite "Not non-Hispanic White"
tab quintile_dm_2yr, m
la var quintile_dm_2yr "Quintiles of 2 year Dartmouth EOL Medicare Spending, HRR level (within this sample)"
la val quintile_dm_2yr quint

sum tot_eol_spending_hrr_n0 if quintile_dm_2yr==1, detail
sum tot_eol_spending_hrr_n0 if quintile_dm_2yr==2, detail
sum tot_eol_spending_hrr_n0 if quintile_dm_2yr==3, detail
sum tot_eol_spending_hrr_n0 if quintile_dm_2yr==4, detail
sum tot_eol_spending_hrr_n0 if quintile_dm_2yr==5, detail
/*
qui xtile dq=tot_eol_spending_hrr_n0,nq(4)
replace dq=dq-1 if dq>2
replace eol_spending_3=dq
*/
gen region=inlist(state_wave_n0,"CT","ME","MA","NH","RI","VT","NJ","NY","PA")
replace region=2 if inlist(state_wave_n0,"IN","IL","MI","OH","WI" ) | ///
inlist(state_wave_n0,"IA","KS","MN","MO","NE","ND","SD")
replace region=3 if inlist(state_wave_n0,"DE","DC","FL","GA","MD","SC","NC") | ///
inlist(state_wave_n0,"VA","WV","AL","KY","MS","TN") 
replace region=3 if inlist(state_wave_n0,"AR","LA","OK","TX")
replace region=4 if inlist(state_wave_n0,"AZ","CO","ID","NM","MT") | ///
inlist(state_wave_n0,"UT","NV","WY","AK","CA","HI","OR","WA")
gen northeast=region==1
gen midwest=region==2
gen south=region==3
gen west=region==4
label var northeast "Northeast"
label var midwest "Midwest"
label var south "South"
label var west "West"

tab quintile_dm_2yr, gen(d_eol_spend_quint) missing
sum hlphrs,d
gen hlphrs_group=hlphrs>r(p50)
replace hlphrs_group=2 if hlphrs>r(p75)
gen hlphrs_high=hlphrs_group==2
gen cd2=contact_days_n0^2



qui xtile hci=hospital_care_intensity_n0, nq(5)


gen mult_ip_adm_p12m_n0=n_ip_admit_p12m_n0>1
gen mult_ed_vis_p12m_n0=n_ed_ip_p12m_n0+n_ed_op_visits_p12m_n0>=2
gen ind_icu_vis_p12m_n0=n_icu_admit_p12m_n0>=1
tab loc_hosp_x
replace loc_hosp_x=0 if core_to_dod_1yr_n0==0
label var loc_hosp_x "Death in the hospital within one year"
label var mult_ip_adm_p12m_n0 "Multiple hospital admissions 12m after ivw"
label var mult_ed_vis_p12m_n0 "Multiple ED visits 12m after ivw"
label var ind_icu_vis_p12m_n0 "Indicator any ICU days 12m after ivw"

//use n1s if n0s are missing
replace bmi_lt25_n0=bmi_rand_n1<25 if !missing(bmi_rand_n1) & missing(bmi_rand_n0)
foreach x in  dm_hrs cancer_hrs lung_hrs chf_hrs adl_diff_bh iadl_diff_m ///
fl_diff_wk_many fl_diff_push medicaid champus medigap /*adl_index_core*/ {
	replace `x'_n0=`x'_n1 if `x'_n0==.
}

//set adls to stable if n1s missing 
local adl=1
foreach x in partial severe {
	replace adl_stable_`x'_n0n1=adl_cat_core_n0==`adl' if adl_cat_core_n1==. & !missing(adl_cat_core_n0)
	local adl=`adl'+1
}
foreach x of varlist adl_change*n0n1 {
	replace `x'=0 if `x'==. & !missing(adl_cat_core_n0)
}
gen adl_stable=adl_stable_partial_n0n1
replace adl_stable=1 if adl_stable_severe_n0n==1
gen adl_decline=adl_change_i_m_n0n1 
replace adl_decline=1 if adl_change_i_s_n0n1==1
replace adl_decline=1 if adl_change_m_s_n0n1==1
label var adl_stable "R ADL Stable, not independent, n1 to n0"
label var adl_decline "R ADL Decline, n1 to n0"
replace adl_decline=0 if adl_decline==. & !missing(adl_stable)
//get informal helper hours category and any informal help
gen anyhours_i=hlphrs_i>0 & !missing(hlphrs_i)
gen anyhelp_i=n_i>0 & !missing(n_i)
gen hlphrs_i_group=hlphrs_i>=60 & hlphrs_i!=.
*replace hlphrs_i_g=2 if hlphrs_i>30 & hlphrs_i!=.
*replace hlphrs_i_g=3 if hlphrs_i>60 & hlphrs_i!=.
label var anyhours_i "1+ hour of informal help/month"
label var anyhelp_i "1+ informal helper identified"
label var hlphrs_i_group "Indicator 60+ hours informal help per month"
label define hlphrs_i_group 0 "0-60" 1 /*"1-60" 3*/ ">60"
label values hlphrs_i_group hlphrs_i_group
local matchvars2 age_at_core_n0 female black hisp /*notwhite*/ married_n0 i.nw_quartile_65_n0 ///
hs_deg /*adl_stable adl_decline*/ ///
adl_stable_partial_n0n1 adl_stable_severe_n0n1 adl_change_i_m_n0n1 ///
 adl_change_i_s_n0n1 adl_change_m_s_n0n1 ///
smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 ///
smi_liver_ind_n0  smi_hip_ind_n0 smi_nh_ind_n0 srh_pf_n0 ///
dm_hrs_n0 cancer_hrs_n0 lung_hrs_n0 chf_hrs_n0 bmi_lt25_n0 smoke_curr_n0  ///
adl_diff_bh_n0 iadl_diff_m_n0 fl_diff_wk_many_n0 fl_diff_push_n0 ///
ind_em_ur_adm_12m_n0 rel_nb_n0 medicaid_n0 champus_n0 medigap_n0 ///
adl_index_core_n0 el_ge3_comorb_1yr_n0 i.quint_cd_n0 hlphrs_i_group ///
midwest south west i.eol_spending_3_cat


local matchvars1 age_at_core_n0 female black hisp /*notwhite*/ married_n0 ///
smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 ///
smi_liver_ind_n0  smi_hip_ind_n0 smi_nh_ind_n0 ///
bmi_lt25_n0 smoke_curr_n0  srh_pf_n0 ///
adl_diff_bh_n0 iadl_diff_m_n0 fl_diff_wk_many_n0 fl_diff_push_n0 ///
ind_em_ur_adm_12m_n0 adl_index_core_n0 el_ge3_comorb_1yr_n0 ///eol_spending_3_cat 
midwest south west hlphrs_i_group

label var tot_paid_by_mc_12m_wi_n0 "Tot MC Payments, 12M following ivw"

local mvars  smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 ///
smi_liver_ind_n0  smi_hip_ind_n0 smi_nh_ind_n0 ///
srh_pf_n0 adl_stable adl_decline el_ge3_comorb_1yr_n0

local nvars age_at_core_n0 female black hisp ///notwhite ///
hs_deg_ind nw_lowest_n0 ///
religvimp_n0 rel_nb_n0 married_n0  ///
medicaid_n0 champus_n0 medigap_n0 ///
midwest west south hlphrs_i_group
gen n=1
*gen missinganyresearch=0
/*
foreach x in `nvars' `mvars' {
qui sum n if `x'==.
if r(N)>0 {
di "`x'"
di r(N)
}
}
*/
outreg, clear
log using `logpath'\death_propensity_2_models.txt, text replace
foreach model in 1 2 {


logit core_to_dod_1yr_n0 `matchvars`model'', nolog or
qui outreg, stats(e_b p) merge varlabels ctitles("" "Model `model'")
estat ic
predict pdeath`model'
*drop if pdeath`model'==.
qui sum pdeath`model',d

gen pdeath`model'_full_sample=1 if !missing(pdeath`model')
gen pdeath`model'_low=pdeath`model'<.1 if !missing(pdeath`model')
gen pdeath`model'_mid=pdeath`model'>=.1 & pdeath`model'<.25 if !missing(pdeath`model')
gen pdeath`model'_high=pdeath`model'>=.25 if !missing(pdeath`model')

gen pdeath`model'_group=pdeath`model'_low==1 if !missing(pdeath`model')
replace pdeath`model'_group=2 if pdeath`model'_mid==1
replace pdeath`model'_group=3 if pdeath`model'_high==1
label define pdeath`model'_group 1 "Low: <10%" 2 "Mid: 10<=Prob death<25%" 3 "High: >=25%"
label values pdeath`model'_group pdeath`model'_group

}
*drop if pdeath2==.
qui outreg using "`logpath'\propensity_death_2_modelsregion.rtf", replay replace ///
 note("Logit model, Odds Ratios Reported")
outreg, clear
foreach grp in _full_sample _low _mid _high {
forvalues j=1/2 {
glm tot_paid_by_mc_12m_wi_n0 `nvars' `mvars' i.eol_spending_3_cat ///
 if pdeath`j'`grp'==1, nolog eform link(log) fam(gamma)
qui margins, dydx(*) post
qui outreg, merge stats(b p)varlabels //ctitles("" "Group `i' Model `j'") 
}
}
local templab : var label tot_paid_by_mc_12m_wi_n0
qui outreg using "`logpath'\propensity_death_2_modelsregion.rtf", replay ///
ctitles("" "Full 1" "Full 2" "Low 1" "Low 2" "Mid1" "Mid2" ///
"High1" "High2") addtable ///
note("Model 1 death propensity modeled on age; sex; race/ethnicity (black/hispanic/other); married;" ///
"SMI indicators for dementia, cancer, ESRD, CHF, COPD, diabetes, hip fracture," ///
"and nursing home status; BMI <25; smoking status; difficulty bathing, handling money, walking, and pushing/pulling;" ///
"index of assistance with ADLs; prior year urgent/emergent admission; >=3 Elixhauser comorbidities; and indicator for SRH poor/fair" ///
"Model 2 includes Model 1 vars as well as indicators of networth (quartile); HS degree;" ///
"change in ADLs n1 to n0 and overall ADL independence status; presence of relatives nearby" ///
"survey reports for dementia, cancer, lung, CHF; insurance status(Medicaid, CHAMPUS, Medigap); contact days (quintiles); and helper hours" ///
"Medicare spending is WI adjusted in 2012$; GLM with family gamma and log link, average marginal effects reported") ///
title(`templab')

//pull intensive procedures
merge 1:1 bid_hrs c_ivw_year_n0 using "E:\data\serious_ill\int_data\insurance_a.dta", ///
keep(match master) nogen
	foreach x of varlist int_* {
	replace `x'=0 if `x'==.
}

foreach y in ind_hosp_adm_p12m_n0 mult_ip_adm_p12m_n0 ind_icu_vis_p12m_n0 int_any_12m {
	local templab : var label `y'
	outreg, clear
	foreach grp in _full_sample _low _mid _high {
		forvalues j=1/2 {
			logit `y' `nvars' `mvars' i.eol_spending_3_cat ///
			if pdeath`j'`grp'==1, nolog or
			*qui margins, dydx(*) post
			qui outreg, merge stats(e_b p)varlabels //ctitles("" "Group `i' Model `j'") 
}
}
qui outreg using "`logpath'\propensity_death_2_modelsregion.rtf", ///
replay ctitles("" "Full 1" "Full 2" "Low 1" "Low 2" "Mid1" "Mid2" "High1" "High2") addtable ///
note("Model 1 death propensity modeled on age; sex; race/ethnicity (black/hispanic/other); married; SMI indicators for dementia, cancer, ESRD, CHF, COPD, diabetes, hip fracture," ///
"and nursing home status; BMI <25; smoking status; difficulty bathing, handling money, walking, and pushing/pulling; index of assistance with ADLs; prior year urgent/emergent admission; >=3 Elixhauser comorbidities; and indicator for SRH poor/fair" ///
"Model 2 includes Model 1 vars as well as indicators of networth (quartile); HS degree; change in ADLs n1 to n0 and overall ADL independence status;" ///
"survey reports for dementia, cancer, lung, CHF; insurance status(Medicaid, CHAMPUS, Medigap); contact days (quintiles); and helper hours" "Logistic regression, odds ratios reported") ///
 title(`templab')
 }
mat excel=J(1,1,.)
putexcel A1=matrix(excel) using ///
"E:\data\serious_ill\logs\marginsforcharts.xls", replace
local r=1
forvalues j=1/2 {
	foreach grp in full_sample low mid high {
		local names ", names"
		local col A
		if "`grp'"!="full_sample" {
			*local names ""
			*local col B
}
		qui glm tot_paid_by_mc_12m_wi_n0 `nvars' `mvars' i.eol_spending_3_cat ///
		if pdeath`j'_`grp'==1, link(log) fam(gamma)
		qui margins, over(eol_spending_3_cat) post
		mat marg=e(b)
		mat rownames marg=`grp'`j'
		mat colnames marg="Low spending" "Mid spending" "High spending"
		putexcel `col'`r'=matrix(marg`names') using ///
		"E:\data\serious_ill\logs\marginsforcharts.xls", ///
		sheet("Adjusted MC Spending") modify
		qui logit core_to_dod_1yr_n0 `nvars' `ivars' i.eol_spending_3_cat ///
		if pdeath`j'_`grp'==1
		qui margins, over(eol_spending_3_cat) post
		mat marg=e(b)
		mat rownames marg=`grp'`j'
		putexcel `col'`r'=matrix(marg`names') using ///
		"E:\data\serious_ill\logs\marginsforcharts.xls", ///
		sheet("Adjusted Mortality") modify

		local r=`r'+2
}
	local r=`r'+1
}


local c=1
tokenize A B C D 
mat actual=J(9,7,.)
mat ns=J(9,7,.)
foreach x in tot_paid_by_mc_12m_wi_n0 core_to_dod_1yr_n0 {
	local r=1
	forvalues j=1/2 {
		foreach grp in full_sample low mid high {
			forvalues i=1/3 {
				sum `x' if pdeath`j'_`grp'==1 & eol_spending_3_cat==`i'
				mat actual[`r',`c']=r(mean)	
				mat ns[`r',`c']=r(N)
				local c=`c'+1
}
			local c=`c'-3
			local r=`r'+1
}
		local r=`r'+1
}
	local c=5
}
foreach m in actual ns {
	mat rownames `m'="Full sample" "Low" "Mid" "High" "Model 2" "Full sample" "Low" "Mid" "High" 
	mat colnames `m'="Low spending" "Mid spending" "High spending" "Mortality" "Low" "Mid" "High Spending"
	putexcel A1=matrix(`m',names) using ///
	"E:\data\serious_ill\logs\marginsforcharts.xls", ///
	sheet(`m') modify
}
/*
merge 1:1 bid_hrs c_ivw_year_n0 using "E:\data\serious_ill\int_data\insurance_a.dta", ///
keep(match master) nogen

gen ffsmosp12m=0
forvalues i=1/12 {
replace ffsmosp12m=ffsmosp12m+1 if inlist(substr(hmo_2y,`i'+1,1),"0","4") & ///
inlist(substr(buyin_2y,`i'+1,1),"3","C")
}
gen tot_annualized=tot_paid_by_mc_12m_wi_n0*12/ffsmosp12m
replace tot_an=tot_paid_by_mc_12m_wi_n0*12 if ffsmosp12m==0	
label var tot_an "Total Paid by Medicare 12m after core, annualized"	
outreg, clear
foreach grp in _full_sample _low _mid _high {
forvalues j=1/2 {
glm tot_an `nvars' `mvars' i.eol_spending_3_cat ///
 if pdeath`j'`grp'==1, nolog eform link(log) fam(gamma)
qui margins, dydx(*) post
qui outreg, merge stats(b p)varlabels //ctitles("" "Group `i' Model `j'") 
}
}


qui outreg using "`logpath'\propensity_death_2_modelannualized.rtf", replay ///
ctitles("" "Full 1" "Full 2" "Low 1" "Low 2" "Mid1" "Mid2" ///
"High1" "High2") replace ///
note("Model 1 death propensity modeled on age; sex; race/ethnicity (black/hispanic/other); married;" ///
"SMI indicators for dementia, cancer, ESRD, CHF, COPD, diabetes, hip fracture," ///
"and nursing home status; BMI <25; smoking status; difficulty bathing, handling money, walking, and pushing/pulling;" ///
"index of assistance with ADLs; prior year urgent/emergent admission; >=3 Elixhauser comorbidities; and indicator for SRH poor/fair" ///
"Model 2 includes Model 1 vars as well as indicators of networth (quartile); HS degree;" ///
"change in ADLs n1 to n0 and overall ADL independence status; presence of relatives nearby" ///
"survey reports for dementia, cancer, lung, CHF; insurance status(Medicaid, CHAMPUS, Medigap); contact days (quintiles); and helper hours" ///
"Medicare spending is WI adjusted in 2012$, multiplied by (12/FFS mos); GLM with family gamma and log link, average marginal effects reported") ///
title(tot_annualized)
*/
foreach x in `matchvars1' `nvars' `mvars' {
drop if `x'==.
}
save n0_n1_p1_p2_x_criteria_a_death_propensity.dta, replace


H="sample chars by death propensity group"
clear all
set more off

local logpath E:\data\serious_ill\logs
local datapath E:\data\serious_ill\final_data

cd `datapath'

use  n0_n1_p1_p2_x_criteria_a_death_propensity.dta

local cvars age_at_core_n0 networth_adj2012_n0
rename pdeath1* pdeath*
local ivars female re_black re_white re_hisp re_other_unk ///
educ_level_lt_hs educ_level_hs educ_level_somcol educ_level_col ///
married_n0 medicaid_n0 champus_n0 medigap_n0 srh_pf_n0 srh_g_n0 srh_ve_n0  ///
smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 ///
smi_diab_compl_ind_n0 smi_liver_ind_n0 smi_als_ind_n0 smi_hip_ind_n0 el_ge3_comorb_1yr_n0 ///
/*adl_stable_ind_n0n1 adl_stable_partial_n0n1 adl_stable_severe_n0n1 ///
adl_change_i_m_n0n1 adl_change_i_s_n0n1 adl_change_m_s_n0n1 */ ///
ser_med_illness_n0 adl_stable_ind_n0n1 adl_stable adl_decline adl_impair_core_n0 smi_and_adl_n0 smi_nh_ind_n0 ind_em_ur_adm_12m_n0 ///
eol_spending_low eol_spending_mid eol_spending_high int_intubation_12m int_trach_12m ///
int_gastro_tude_12m int_hemodia_12m int_enteral_nut_12m int_cpr_12m int_any_12m ///
northeast midwest south west hlphrs_i_group
gen miss=0

foreach x in `cvars' `ivars' {

replace miss=1 if `x'==.
}
drop if miss==1

local rn : word count `cvars' `ivars' 1


mat tab1=J(`rn',8,.)
local r=1
local c=1

foreach i in full_sample low mid high {
	foreach x of local cvars {
		qui sum `x' if pdeath_`i'==1 
		mat tab1[`r',`c']=r(mean)
		mat tab1[`r',`c'+1]=r(sd)
		local r=`r'+1
}
	foreach x of local ivars {
		qui sum `x' if pdeath_`i'==1
		mat tab1[`r',`c']=r(mean)*r(N)
		mat tab1[`r',`c'+1]=r(mean)*100
		local r=`r'+1
}
	mat tab1[`r',`c']=r(N)
	local r=1
	local c=`c'+2
}
mat rownames tab1=`cvars' `ivars' N

frmttable using `logpath'\table_1_and_outcomes_pdeath_3_groups.doc, replace statmat(tab1) varlabels  title("Sample Characteristics by Propensity 1 yr Mortality") ///
 ctitles("" "Full Sample Mean/N" "SD/%" "Prob death Low Mean/N" "SD/%" "Med" "SD/%" "High" "SD/%") ///
 sdec(2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\0,2,0,2,0,2,0,2) ///
 note("Death propensity modeled on age; sex; race/ethnicity (black/hispanic/other); married; SMI indicators for dementia, cancer, ESRD, CHF, COPD, diabetes, hip fracture," ///
"and nursing home status; BMI <25; smoking status; difficulty bathing, handling money, walking, and pushing/pulling; index of assistance with ADLs; prior year urgent/emergent admission;" ///
">=3 Elixhauser comorbidities; 60+hours informal help/month; Census region; and indicator for SRH poor/fair" ///
"HRR spending Quartile last two years of life 2003-2007") 
	

mat tab1=J(`rn',6,.)
local r=1
local c=1

foreach i in low mid high {
	foreach x of local cvars {
		qui sum `x' if pdeath_`i'==1 
		mat tab1[`r',`c']=r(mean)
		capture ttest `x' if pdeath_low==1 | pdeath_`i'==1, by(pdeath_group)
		mat tab1[`r',`c'+1]=r(p)
		local r=`r'+1
}
	foreach x of local ivars {
		qui sum `x' if pdeath_`i'==1
		mat tab1[`r',`c']=r(mean)*100
		qui tab `x' pdeath_group if pdeath_low==1 | pdeath_`i'==1, chi2
		mat tab1[`r',`c'+1]=r(p)
		local r=`r'+1
}
	qui sum `x' if pdeath_`i'==1
	mat tab1[`r',`c']=r(N)
	local r=1
	local c=`c'+2
}
mat rownames tab1=`cvars' `ivars' N

frmttable using `logpath'\table_1_and_outcomes_pdeath_3_groups.doc, addtable statmat(tab1) varlabels  title("Sample Characteristics by Propensity 1 yr Mortality") ///
 ctitles("" "Prob death Low Mean/%" "" "Prob death Med" "P" "Prob death High" "P") ///
 sdec(2,3,2,3,2,3) ///
 note("HRR spending Quartile last two years of life 2003-2007" "P-values compared to baseline of low probability group")

 
 
local outcome3 ind_hosp_adm_p12m_n0 ///
 mult_ip_adm_p12m_n0 mult_ed_vis_p12m_n0 ///
 ind_icu_vis_p12m_n0 hs_admit_p12m_n0 ///
 core_to_dod_1yr_n0 loc_hosp_x

local outcome2 n_hospd_p12m_n0

local outcome1 ip_paid_by_mc_12m_wi_n0 snf_paid_by_mc_12m_wi_n0 hh_paid_by_mc_12m_wi_n0 ///
 hs_paid_by_mc_12m_wi_n0 pb_paid_by_mc_12m_wi_n0 op_paid_by_mc_12m_wi_n0 ///
 dm_paid_by_mc_12m_wi_n0 tot_paid_by_mc_12m_wi_n0   
 
local rn : word count `outcome1' `outcome1' `outcome2' `outcome2' `outcome3' 1


mat tab1=J(`rn',8,.)
local r=1
local c=1

foreach i in full_sample low mid high {
	foreach x in `outcome1' `outcome2' {
		sum `x' if pdeath_`i'==1,d
		mat tab1[`r',`c']=r(mean)
		mat tab1[`r',`c'+1]=r(sd)
		mat tab1[`r'+1,`c']=r(p50)
		local r=`r'+2
}
	foreach x in `outcome3' {
		qui sum `x' if pdeath_`i'==1
		mat tab1[`r',`c']=r(mean)*r(N)
		mat tab1[`r',`c'+1]=r(mean)*100
		local r=`r'+1
}
	mat tab1[`r',`c']=r(N)
	local r=1
	local c=`c'+2
}
mat rownames tab1="IP MC payments 12m post ivw" ///
"	Median" "SNF MC payments 12m post ivw" ///
"	Median" "HH MC payments 12m post ivw" ///
"	Median" "HS MC payments 12m post ivw" ///
"	Median" "PB MC payments 12m post ivw" ///
"	Median" "OP MC payments 12m post ivw" ///
"	Median" "DME MC payments 12m post ivw" ///
"	Median" "Total MC payments 12m post ivw" ///
"	Median" "n hospital nights 12m post ivw" ///
"	Median"  `outcome3' N

frmttable using `logpath'\table_1_and_outcomes_pdeath_3_groups.doc,  addtable ///
statmat(tab1) varlabels  title("One Year Outcomes by Propensity 1 yr Mortality") ///
 ctitles("" "Full Sample Mean/N" "SD/%" "Prob death Low Mean/N" "SD/%" "Med" "SD/%" "High" "SD/%") ///
 sdec(2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\ ///
 2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\ ///
 2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\0,2,0,2,0,2,0,2) ///
 /*rtitles("IP MC payments 12m post ivw (mean,SD)" \ ///
"	Median"\"SNF MC payments 12m post ivw (mean,SD)" \ ///
"	Median"\"HH MC payments 12m post ivw (mean,SD)" \ ///
"	Median"\"HS MC payments 12m post ivw (mean,SD)" \ ///
"	Median"\"PB MC payments 12m post ivw (mean,SD)" \ ///
"	Median"\"OP MC payments 12m post ivw (mean,SD)" \ ///
"	Median"\"DME MC payments 12m post ivw (mean,SD)" \ ///
"	Median"\"Total MC payments 12m post ivw (mean,SD)" \ ///
"	Median"\"n hospital nights 12m post ivw (mean,SD)" \ ///
"	Median" ind_hosp_adm_p12m_n0\ ///
 mult_ip_adm_p12m_n0\ mult_ed_vis_p12m_n0\ ///
 ind_icu_vis_p12m_n0\ hs_admit_p12m_n0\ ///
 core_to_dod_1yr_n0\ loc_hosp_x\ N) ///
*/ note("All costs WI adjusted 2012$"\"P-values compared to baseline of low probability group") 
local rn : word count `outcome1'  `outcome2' `outcome3' 1
	

mat tab1=J(`rn',6,.)
local r=1
local c=1

foreach i in low mid high {
	foreach x in `outcome1' `outcome2' {
		qui sum `x' if pdeath_`i'==1 
		mat tab1[`r',`c']=r(mean)
		capture ttest `x' if pdeath_low==1 | pdeath_`i'==1, by(pdeath_group)
		mat tab1[`r',`c'+1]=r(p)
		local r=`r'+1
}
	foreach x in `outcome3' {
		qui sum `x' if pdeath_`i'==1
		mat tab1[`r',`c']=r(mean)*100
		qui tab `x' pdeath_group if pdeath_low==1 | pdeath_`i'==1, chi2
		mat tab1[`r',`c'+1]=r(p)
		local r=`r'+1
}
	qui sum `x' if pdeath_`i'==1
	mat tab1[`r',`c']=r(N)
	local r=1
	local c=`c'+2
}
mat rownames tab1=`outcome1' `outcome2' `outcome3' N

frmttable using `logpath'\table_1_and_outcomes_pdeath_3_groups.doc,  addtable ///
statmat(tab1) varlabels  title("One Year Outcomes by Propensity 1 yr Mortality") ///
 ctitles("" "Prob death Low Mean/%" "" "Prob death Med" "P" "Prob death High" "P") ///
 sdec(2,3,2,3,2,3) ///
 note("All costs WI adjusted 2012$" "P-values compared to baseline of low probability group")
preserve
gen tot1000=tot_paid_by_mc_12m_wi_n0/1000
collapse (mean)tot= tot1000 (sd) sd=tot1000 (count) n=tot1000, by(pdeath_group core_to_dod_1yr_n0)
label var tot "Total paid by Medicare 12m post ivw, 1000s of WI 2012$"
 gen hitot=tot+invttail(n-1,0.025)*(sd/sqrt(n))
gen lotot=tot-invttail(n-1,0.025)*(sd/sqrt(n))
graph twoway (bar tot core) (rcap hitot lotot core), by(pde)
graph save `logpath'\mean_spend_by_pdeath_ci, replace
graph twoway (bar tot pde) (rcap hitot lotot pde), by(core)
graph save `logpath'\mean_spend_by_mortality_ci, replace

export excel using "E:\data\serious_ill\logs\spending_means_by_group_for_bars.xls", sheetreplace firstrow(varlabels )
restore
foreach x in `outcome1' `outcome2' `outcome3' {
	sum `x'
}


H="formatted tables for paper"
capture log close

import excel "E:\data\Dartmouth_misc\EOL_mc_2yrs_HRR\DAP_HRR_03_07_to_merge.xls", sheet("Sheet1") firstrow case(lower) clear
keep hrr totalmedic
rename hrr hrr_number_n0
xtile eol_spending_quintile=tot, nq(5)
xtile eol_spending_quartile=tot, nq(4)
gen eol_spending_3_cat=eol_spending_quartile
replace eol_spending_3_cat=eol_spending_3_cat-1 if inlist(eol_spending_3_cat,3,4)
label define eol_spending_3_cat 1 "Bottome Quartile" 2 "Middle 50%" 3 "Top quartile"
label values eol_spending_3_cat eol_spending_3_cat
gen eol_spending_low=eol_spending_3_cat==1
gen eol_spending_mid=eol_spending_3_cat==2
gen eol_spending_high=eol_spending_3_cat==3
label var eol_spending_low "Bottom Quartile EOL spending by Dartmouth HRR"
label var eol_spending_mid "Middle 50% EOL spending by Dartmouth HRR"
label var eol_spending_high "Top Quartile EOL spending by Dartmouth HRR"
label var eol_spending_3_cat "EOL Spending Group by Dartmouth HRR, Adjusted"
label var eol_spending_quintile "EOL Spending Quintile by Dartmouth HRR, Adjusted"
tempfile temp1
save "`temp1'"

clear all
set more off

local logpath E:\data\serious_ill\logs
local datapath E:\data\serious_ill\final_data

cd `datapath'

use  n0_n1_p1_p2_x_criteria_a_v1.dta if core_year_n0<2012

merge m:1 hrr_number_n0 using "`temp1'", keep(match master) nogen
drop if hospital_care_intensity_n0==.
gen smi_any_n0=1 if smi_count_n0>0
replace smi_any_n0=0 if smi_count_n0==0
gen region=inlist(state_wave_n0,"CT","ME","MA","NH","RI","VT","NJ","NY","PA")
replace region=2 if inlist(state_wave_n0,"IN","IL","MI","OH","WI" ) | ///
inlist(state_wave_n0,"IA","KS","MN","MO","NE","ND","SD")
replace region=3 if inlist(state_wave_n0,"DE","DC","FL","GA","MD","SC","NC") | ///
inlist(state_wave_n0,"VA","WV","AL","KY","MS","TN") 
replace region=3 if inlist(state_wave_n0,"AR","LA","OK","TX")
replace region=4 if inlist(state_wave_n0,"AZ","CO","ID","NM","MT") | ///
inlist(state_wave_n0,"UT","NV","WY","AK","CA","HI","OR","WA")
gen northeast=region==1
gen midwest=region==2
gen south=region==3
gen west=region==4
label var northeast "Northeast"
label var midwest "Midwest"
label var south "South"
label var west "West"
gen hlphrs_i_group=hlphrs_i>=60 & hlphrs_i!=.
label var hlphrs_i_group "Indicator 60+ hours informal help per month"
label define hlphrs_i_group 0 "0-60" 1 ">60"
label values hlphrs_i_group hlphrs_i_group

gen mult_ip_adm_p12m_n0=n_ip_admit_p12m_n0>1
gen mult_ed_vis_p12m_n0=n_ed_ip_p12m_n0+n_ed_op_visits_p12m_n0>=2
gen ind_icu_vis_p12m_n0=n_icu_admit_p12m_n0>=1
tab loc_hosp_x
replace loc_hosp_x=0 if core_to_dod_1yr_n0==0
label var loc_hosp_x "Death in the hospital within one year"
label var mult_ip_adm_p12m_n0 "Multiple hospital admissions 12m after ivw"
label var mult_ed_vis_p12m_n0 "Multiple ED visits 12m after ivw"
label var ind_icu_vis_p12m_n0 "Indicator any ICU days 12m after ivw"

gen religvimp_n0=1 if imprelig_n0==1
replace religvimp_n0=0 if inlist(imprelig_n0,2,3,4)
//use n1s if n0s are missing
replace bmi_lt25_n0=bmi_rand_n1<25 if !missing(bmi_rand_n1) & missing(bmi_rand_n0)
foreach x in  dm_hrs cancer_hrs lung_hrs chf_hrs adl_diff_bh iadl_diff_m ///
fl_diff_wk_many fl_diff_push medicaid champus medigap /*adl_index_core*/ {
	replace `x'_n0=`x'_n1 if `x'_n0==.
}
local matchvars age_at_core_n0 female re_black re_hisp married_n0 ///
smi_nh_ind_n0 smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 ///
smi_liver_ind_n0  smi_hip_ind_n0 ///
el_ge3_comorb_1yr_n0 bmi_lt25_n0 smoke_curr_n0  srh_pf_n0 ///
adl_diff_bh_n0 iadl_diff_m_n0 fl_diff_wk_many_n0 fl_diff_push_n0 ///
ind_em_ur_adm_12m_n0 adl_index_core_n0 hlphrs_i_group ///
midwest south west

local cvars1 age_at_core_n0
local cvars2 networth_adj2012_n0
*rename pdeath1* pdeath*
local ivars1 female re_white re_black re_hisp married_n0 educ_level_lt_hs 
local ivars2 medigap_n0 medicaid_n0 champus_n0 nhres_n0 srh_pf_n0 ///
smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 smi_chf_ind_n0 ///
smi_copd_ind_n0 smi_diab_compl_ind_n0 smi_liver_ind_n0 smi_hip_ind_n0 ///
el_ge3_comorb_1yr_n0 ser_med_illness_n0 adl_impair_core_n0 smi_and_adl_n0 ///
ind_em_ur_adm_12m_n0 eol_spending_low eol_spending_mid eol_spending_high

local coutcomes tot_paid_by_mc_12m_wi_n0 ip_paid_by_mc_12m_wi_n0 n_hospd_p12m_n0 
local ioutcomes ind_hosp_adm_p12m_n0 mult_ip_adm_p12m_n0 mult_ed_vis_p12m_n0 ind_icu_vis_p12m_n0 ///
hs_admit_p12m_n0 core_to_dod_1yr_n0 loc_hosp_x

foreach x in `matchvars' {
drop if `x'==.
}

local rn : word count  `cvars1' `cvars2' `ivars1' `ivars2' 1 `coutcomes' 1 `ioutcomes'  1

logit core_to_dod_1yr_n0 `matchvars', or
outreg using `logpath'\formatted_tables.doc, replace stats(e_b) starlevels(5) ///
 starloc(1) bdec(2) varlabels
predict pdeath
gen pdeath_low=pdeath<.1
gen pdeath_mid=pdeath>=.1 & pdeath<.25
gen pdeath_high=pdeath>.25
gen pdeath_full_sample=1
gen pdeath_group=pdeath_low
replace pdeath_group=2 if pdeath_mid
replace pdeath_group=3 if pdeath_high
drop if missing(pdeath)
label var pdeath_low "Prob. 1yr mortality <.1"
label var pdeath_mid "Prob. 1yr mortality .1-.25"
label var pdeath_high "Prob. 1yr mortality >.25"
label var pdeath_full "Full cohort"

foreach x in `cvars1' `cvars2' `ivars1' `ivars2' {
drop if `x'==.
}


mat tab1=J(`rn',4,.)
mat stars=J(`rn',4,0)
local r=1
local c=1
foreach i in full_sample low mid high {
	foreach round in 1 2 {
		foreach x of local cvars`round' {
			qui sum `x' if pdeath_`i'==1 
			mat tab1[`r',`c']=r(mean)
			if inlist("`i'","mid","high") {
				ttest `x' if pdeath_`i'==1 | pdeath_low==1, by(pdeath_group)
				mat stars[`r',`c']=(r(p)<.01) + (r(p)<.05)
}
			local r=`r'+1
}
		foreach x of local ivars`round' {
			qui sum `x' if pdeath_`i'==1
			mat tab1[`r',`c']=r(mean)*100
			if inlist("`i'","mid","high") {
				tab `x' pdeath_group if pdeath_`i'==1 | pdeath_low==1, chi2
				mat stars[`r',`c']=(r(p)<.01) + (r(p)<.05)
}
			local r=`r'+1
}
}
	local r=`r'+1

	
	foreach x of local coutcomes {
		sum `x' if pdeath_`i'==1,d
		mat tab1[`r',`c']=r(mean)
		if inlist("`i'","mid","high") {
			ttest `x' if pdeath_`i'==1 | pdeath_low==1, by(pdeath_group)
			mat stars[`r',`c']=(r(p)<.01) + (r(p)<.05)
}
		local r=`r'+1
		if "`x'"=="tot_paid_by_mc_12m_wi_n0" {
			sum `x' if pdeath_`i'==1,d
			mat tab1[`r',`c']=r(p50)
			local r=`r'+1
}
}
	foreach x of local ioutcomes {
		qui sum `x' if pdeath_`i'==1
		mat tab1[`r',`c']=r(mean)*100
			if inlist("`i'","mid","high") {
				tab `x' pdeath_group if pdeath_`i'==1 | pdeath_low==1, chi2
				mat stars[`r',`c']=(r(p)<.01) + (r(p)<.05)
}
			local r=`r'+1
}
	sum female if pdeath_`i'==1
	mat tab1[`r',`c']=r(N)
	local r=1
	local c=`c'+1
}

mat rownames tab1=`cvars1' `ivars1' `cvars2' `ivars2' "Outcome Measures Over 1 Year" ///
tot_paid_by_mc_12m_wi_n0 "Median" ip_paid_by_mc_12m_wi_n0 n_hospd_p12m_n0 `ioutcomes' N

frmttable using `logpath'\formatted_tables.doc, replace statmat(tab1) addtable  title("Sample Characteristics by Propensity 1 yr Mortality") ///
 ctitles("" "Full Sample Mean" "Prob death Low" "Med" "High" ) ///
 sdec(1) annotate(stars) asymbol(*,*) ///
 varlabels
  
local mvars  smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 ///
smi_liver_ind_n0  smi_hip_ind_n0 /*smi_nh_ind_n0*/ ///
srh_pf_n0 adl_impair_core_n0 hlphrs_i_group el_ge3_comorb_1yr_n0
label var black "African American Race"
local nvars age_at_core_n0 female re_blac re_hisp ///notwhite ///
hs_deg_ind nw_lowest_n0 ///
religvimp_n0 rel_nb_n0 married_n0 smi_nh_ind_n0 ///
medicaid_n0 champus_n0 medigap_n0


local rn : word count `nvars' `mvars' 1 1 
mat tab1=J(`rn'+3,4,.)
mat stars=J(`rn'+3,4,0)
local r=1
local c=1
foreach y in _full_sample _low _mid _high {
	foreach x in `nvars' `mvars' {
		qui glm tot_paid_by_mc_12m_wi_n0 `x' if pdeath`y'==1, fam(gamma) link(log) eform
		mat beta=e(b)
		mat tab1[`r',`c']=exp(beta[1,1])
		mat p=r(table)
		mat stars[`r',`c']=(p[4,1]<.05) + (p[4,1]<.01)
		local r=`r'+1
}
	qui glm tot_paid_by_mc_12m_wi_n0 i.region if pdeath`y'==1, fam(gamma) link(log) eform
	mat p=r(table)
	mat tab1[`r',`c']=p[1,2]
	mat tab1[`r'+1,`c']=p[1,3]
	mat tab1[`r'+2,`c']=p[1,4]
	mat stars[`r',`c']=(p[4,2]<.05) + (p[4,2]<.01)
	mat stars[`r'+1,`c']=(p[4,3]<.05) + (p[4,3]<.01)
	mat stars[`r'+2,`c']=(p[4,4]<.05) + (p[4,4]<.01)
	local r=`r'+3
	qui glm tot_paid_by_mc_12m_wi_n0 i.eol_spending_3_cat if pdeath`y'==1, fam(gamma) link(log) eform
	mat p=r(table)
	mat tab1[`r',`c']=p[1,2]
	mat tab1[`r'+1,`c']=p[1,3]
	mat stars[`r',`c']=(p[4,2]<.05) + (p[4,2]<.01)
	mat stars[`r'+1,`c']=(p[4,3]<.05) + (p[4,3]<.01)


	local c=`c'+1
	local r=1
}

mat rownames tab1=`nvars' `mvars' Midwest South West eol_spending_mid eol_spending_high
frmttable using `logpath'\formatted_tables.doc, statmat(tab1) ctitles("" "Full cohort"  ///
 "Prob <.1"  "Prob .1-.25"  "Prob >.25" ) ///
title("Table 2. Unadjusted bivariate relationships, 12m spending") ///
note("all models are glm with family gamma and link log, exponentiated coefficients; *p<0.05" ///
"Total Medicare spending WI adjusted 2012$") sdec(2) varlabels addtable ///
annotate(stars) asymbol(*,*)

outreg, clear 
local tab=4


foreach y in _full_sample _low _mid _high {
	qui glm tot_paid_by_mc_12m_wi_n0 `nvars' `mvars' midwest south west eol_spending_mid ///
	eol_spending_high if pdeath`y'==1, fam(gamma) link(log) eform
	qui outreg, merge stats(e_b) varlabels starloc(1) starlevels(5) bdec(2) //nosubstat summstat()
}
outreg using `logpath'\formatted_tables.doc, replay addtable ///
title(Table 3. Factors associated with total Medicare spending over 12 months, among cohort with incident serious illness+ ///
stratified by probability of death.) ctitles("" "Full cohort" "Prob <.1"  "Prob .1-.25"  "Prob >.25") ///
note(*p<0.05) nocons  bdec(2)
foreach dep in mult_ip_adm_p12m_n0 ind_icu_vis_p12m_n0 {
outreg, clear

foreach y in _full_sample _low _mid _high {
	qui logit `dep' `nvars' `mvars' midwest south west eol_spending_mid ///
	eol_spending_high if pdeath`y'==1, or
	qui outreg, merge stats(e_b) varlabels starloc(1) starlevels(5) bdec(2) //nosubstat summstat()
}
if "`dep'"=="mult_ip_adm_p12m_n0" {
	local j = "having more than 1 hospital admission"
}
	else local j="having at least 1 intensive care unit admission"
	
outreg using `logpath'\formatted_tables.doc, replay addtable ///
title(Table `tab'. Factors associated with `j' over 12 months, among cohort with incident serious illness+ ///
stratified by probability of death.) ctitles("" "Full cohort" "Prob <.1"  "Prob .1-.25"  "Prob >.25") ///
note(*p<0.05) nocons  bdec(2)
local tab=`tab'+1
}

foreach x in _low _mid _high {
gen black`x'=re_black==1 & eol_spending`x'==1
}
local num=1
gen race_region=0 
forvalues j=1/3 {
forvalues i=0/1 {
	replace race_region=`num' if eol_spending_3==`j' & re_black==`i'
	local num=`num'+1
}	
}
label define race_region 1 "Non-black, lowest quartile HRR EOL spending" ///
2 "Black, lowest quartile HRR EOL spending" 3 "Non-black, middle 50% HRR EOL spending" ///
4 "Black, middle 50% HRR EOL spending" 5 "Non-black, top quartile HRR EOL spending" ///
6 "Black, top quartile HRR EOL spending"
label values race_region race_region
local num=1
gen race_region2=0 
forvalues i=0/1 {
	forvalues j=1/3 {
		replace race_region2=`num' if eol_spending_3==`j' & re_black==`i'
		local num=`num'+1
}	
}
label define race_region2 1 "Non-black, lowest quartile HRR EOL spending" ///
2 "Non-black, middle 50% HRR EOL spending" 3 "Non-black, top quartile HRR EOL spending" ///
4 "Black, lowest quartile HRR EOL spending" 5 "Black, middle 50% HRR EOL spending" ///
6 "Black, top quartile HRR EOL spending"
label values race_region2 race_region2

outreg, clear
local nvars age_at_core_n0 female ///
hs_deg_ind nw_lowest_n0 ///
religvimp_n0 rel_nb_n0 married_n0 smi_nh_ind_n0 ///
medicaid_n0 champus_n0 medigap_n0 
foreach y in _full_sample _low _mid _high {
	qui glm tot_paid_by_mc_12m_wi_n0 `nvars' `mvars' midwest south west i.race_region ///
	 if pdeath`y'==1, fam(gamma) link(log) eform
	qui outreg, merge stats(e_b) varlabels starloc(1) starlevels(5) bdec(2) //nosubstat summstat()
}
outreg using `logpath'\formatted_tables.doc, replay addtable ///
title(Race Region interaction) ctitles("" "Full cohort" "Prob <.1"  "Prob .1-.25"  "Prob >.25") ///
note(*p<0.05) nocons  bdec(2)

outreg, clear

foreach y in _full_sample _low _mid _high {
	qui glm tot_paid_by_mc_12m_wi_n0 `nvars' `mvars' midwest south west i.race_region ///
	 if pdeath`y'==1, fam(gamma) link(log) eform
	margins, dydx(*) post
	qui outreg, merge stats(b) varlabels starloc(1) starlevels(5) bdec(2) //nosubstat summstat()
}
outreg using `logpath'\formatted_tables.doc, replay addtable ///
title(Race Region interaction, Marginal Effects) ctitles("" "Full cohort" "Prob <.1"  "Prob .1-.25"  "Prob >.25") ///
note(*p<0.05) nocons  bdec(2)

outreg, clear
/*foreach r in 0 1 {
foreach y in _full_sample _low _mid _high {
	qui glm tot_paid_by_mc_12m_wi_n0 `nvars' `mvars' midwest south west eol_spending_mid ///
	 eol_spending_high if re_black==`r' & pdeath`y'==1, fam(gamma) link(log) eform
	margins, dydx(*) post
	qui outreg, merge stats(b) varlabels starloc(1) starlevels(5) bdec(2) //nosubstat summstat()
}
}
outreg using `logpath'\formatted_tables.doc, replay addtable ///
title(Race Region interaction, Marginal Effects) ctitles("" "Full cohort" "Prob <.1"  "Prob .1-.25"  "Prob >.25") ///
note(*p<0.05) nocons  bdec(2)
*/
outreg, clear

foreach y in _full_sample _low _mid _high {
	qui glm tot_paid_by_mc_12m_wi_n0 `nvars' `mvars' midwest south west i.race_region ///
	 if pdeath`y'==1, fam(gamma) link(log) eform
	margins, dydx(race_region) post
	foreach x in b ci_l ci_u {
		qui outreg, merge stats(`x') varlabels nostars bdec(2) //nosubstat summstat()
}
}
outreg using `logpath'\formatted_tables.doc, replay addtable ///
title(Race Region interaction, Marginal Effects) ctitles("" "Full cohort" "LL" "UL" ///
"Prob <.1" "LL" "UL"  "Prob .1-.25" "LL" "UL"  "Prob >.25" "LL" "UL" ) ///
note(*p<0.05) nocons  bdec(2) nostars

outreg, clear
foreach y in _full_sample _low _mid _high {
	qui glm tot_paid_by_mc_12m_wi_n0 `nvars' `mvars' midwest south west i.race_region2 ///
	 if pdeath`y'==1, fam(gamma) link(log) eform
	margins, dydx(race_region) post
	foreach x in b ci_l ci_u {
		qui outreg, merge stats(`x') varlabels nostars bdec(2) //nosubstat summstat()
}
}
outreg using `logpath'\formatted_tables.doc, replay addtable ///
title(Race Region interaction, Marginal Effects) ctitles("" "Full cohort" "LL" "UL" ///
"Prob <.1" "LL" "UL"  "Prob .1-.25" "LL" "UL"  "Prob >.25" "LL" "UL" ) ///
note(*p<0.05) nocons  bdec(2) nostars

outreg, clear

foreach y in _full_sample _low _mid _high {
	qui glm tot_paid_by_mc_12m_wi_n0 `nvars' `mvars' midwest south west i.race_region2 ///
	 if pdeath`y'==1, fam(gamma) link(log) eform
	margins race_region2, post
	foreach x in b ci_l ci_u {
		qui outreg, merge stats(`x') varlabels nostars bdec(2) //nosubstat summstat()
}
}
outreg using `logpath'\formatted_tables.doc, replay addtable ///
title(Race Region interaction, Predictive Margins) ctitles("" "Full cohort" "LL" "UL" ///
"Prob <.1" "LL" "UL"  "Prob .1-.25" "LL" "UL"  "Prob >.25" "LL" "UL" ) ///
note(*p<0.05) nocons  bdec(2) nostars

save `datapath'\n0_n1_p1_p2_x_criteria_a_death_propensity.dta, replace


H="adjusted and unadjusted models by propensity"
local logpath E:\data\serious_ill\logs
local datapath E:\data\serious_ill\final_data
capture log close
*log using "`logpath'\tables_inc_24m_symptoms_helper", text replace
cd `datapath'
log using `logpath'\propensity_death_adjusted_and_unadjusted_log.txt, text replace

use n0_n1_p1_p2_x_criteria_a_death_propensity.dta, clear 

*rename pdeath1* pdeath*
local cvars age_at_core_n0



local mvars  smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 ///
smi_liver_ind_n0  smi_hip_ind_n0 /*smi_nh_ind_n0*/ ///
srh_pf_n0 adl_impair_core_n0 hlphrs_i_group el_ge3_comorb_1yr_n0
local nvars age_at_core_n0 female re_black re_hisp ///notwhite ///
hs_deg_ind nw_lowest_n0 ///
religvimp_n0 rel_nb_n0 married_n0 smi_nh_ind_n0 ///
medicaid_n0 champus_n0 medigap_n0

local rn : word count `nvars' `mvars' 1 1 
mat tab1=J(`rn'+3,8,.)
local r=1
local c=1
foreach y in _full_sample _low _mid _high {
	foreach x in `nvars' `mvars' {
		qui glm tot_paid_by_mc_12m_wi_n0 `x' if pdeath`y'==1, fam(gamma) link(log) eform
		mat beta=e(b)
		mat tab1[`r',`c']=exp(beta[1,1])
		mat p=r(table)
		mat tab1[`r',`c'+1]=p[4,1]
		local r=`r'+1
}
	qui glm tot_paid_by_mc_12m_wi_n0 i.region if pdeath`y'==1, fam(gamma) link(log) eform
	mat p=r(table)
	mat tab1[`r',`c']=p[1,2]
	mat tab1[`r'+1,`c']=p[1,3]
	mat tab1[`r'+2,`c']=p[1,4]
	mat tab1[`r',`c'+1]=p[4,2]
	mat tab1[`r'+1,`c'+1]=p[4,3]
	mat tab1[`r'+2,`c'+1]=p[4,4]
	local r=`r'+3
	qui glm tot_paid_by_mc_12m_wi_n0 i.eol_spending_3_cat if pdeath`y'==1, fam(gamma) link(log) eform
	mat p=r(table)
	mat tab1[`r',`c']=p[1,2]
	mat tab1[`r'+1,`c']=p[1,3]
	mat tab1[`r',`c'+1]=p[4,2]
	mat tab1[`r'+1,`c'+1]=p[4,3]


	local c=`c'+2
	local r=1
}

mat rownames tab1=`nvars' `mvars' Midwest South West eol_spending_mid eol_spending_high

frmttable using `logpath'\propensity_death_tot_unadjusted, statmat(tab1) ctitles("" "Full Sample" "p" ///
 "Prob <.1" "p" "Prob .1-.25" "p" "Prob >.25" "p") ///
title("Unadjusted regressions, 12m spending") ///
note("all models are glm with family gamma and link log, exponentiated coefficients" ///
"Total Medicare spending WI adjusted 2012$") sdec(3) varlabels replace

local i=1
local j "Full Sample" 


foreach y in _full_sample _low _mid _high {
	local k=1
	if `i'==2 {
		local j "Probability of death <.10"
}
	if `i'==3 {
		local j "Probability of death .10-.25"
}
	if `i'==4 {
		local j "Probability of death >.25"
}
	qui glm tot_paid_by_mc_12m_wi_n0 `nvars' `mvars' midwest south west eol_spending_mid eol_spending_high if pdeath`y'==1, fam(gamma) link(log) eform
	qui outreg, varlabels ctitles("" "`k'") stats(e_b p)
	local k=`k'+1
	foreach x in `mvars' {
		if "`x'"!="adl_stable" {
			if "`x'"=="adl_decline" {
				qui glm tot_paid_by_mc_12m_wi_n0 `nvars' midwest south west eol_spending_mid eol_spending_high adl_stable `x'  if pdeath`y'==1, fam(gamma) link(log) eform
}
			else {
				qui glm tot_paid_by_mc_12m_wi_n0 `nvars' midwest south west eol_spending_mid eol_spending_high `x' if pdeath`y'==1, fam(gamma) link(log) eform
}
		qui outreg, merge varlabels ctitles("" "`k'") stats(e_b p)
		local k=`k'+1
}
}
	local i=`i'+1
	outreg using `logpath'\propensity_death_tot_unadjusted, replay addtable ///
	 title("Adjusted Regressions,12m spending" "`j'") ///
 	 note("All models are GLM with family gamma and link log, exponentiated coefficients" ///
	 "Total Medicare spending WI adjusted 2012$" "* p<0.05; ** p<0.01") basefont(fs10)
}

local i=1
local j "Full Sample" 

foreach y in _full_sample _low _mid _high {
	local k=1
	if `i'==2 {
		local j "Probability of death <.10"
}
	if `i'==3 {
		local j "Probability of death .10-.25"
}
	if `i'==4 {
		local j "Probability of death >.25"
}
	qui glm tot_paid_by_mc_12m_wi_n0 `nvars' `mvars' midwest south west eol_spending_mid eol_spending_high if pdeath`y'==1, fam(gamma) link(log) eform
	qui outreg, varlabels ctitles("" "`k'") stats(e_b p)
	local k=`k'+1
	foreach x in `nvars' "midwest south west" "eol_spending_mid eol_spending_high" {
		qui glm tot_paid_by_mc_12m_wi_n0 `mvars' `x' if pdeath`y'==1, fam(gamma) link(log) eform
		qui outreg, merge varlabels ctitles("" "`k'") stats(e_b p)
		local k=`k'+1
}
	local i=`i'+1
	outreg using `logpath'\propensity_death_tot_unadjusted, replay addtable ///
	 title("Adjusted Regressions, 12m spending" "`j'") ///
	 note("All models are GLM with family gamma and link log, exponentiated coefficients" ///
	 "Total Medicare spending WI adjusted 2012$" "* p<0.05; ** p<0.01") basefont(fs10)
}

/*
local rn : word count `mvars' `nvars' 
mat tab1=J(`rn',6,.)
local r=1
local c=1
foreach y in _full_sample _low _high {
	foreach x in `mvars' {
		qui glm tot_paid_by_mc_12m_wi_n0 `x' `nvars' i.eol_spending_group if pdeath`y'==1, fam(gamma) link(log) eform
		mat beta=e(b)
		mat tab1[`r',`c']=exp(beta[1,1])
		mat p=r(table)
		mat tab1[`r',`c'+1]=p[4,1]
		local r=`r'+1
}		
	foreach x in `nvars' i.eol_spending_group {
		qui glm tot_paid_by_mc_12m_wi_n0 `x' `mvars' if pdeath`y'==1, fam(gamma) link(log) eform
		mat beta=e(b)
		mat tab1[`r',`c']=exp(beta[1,1])
		mat p=r(table)
		mat tab1[`r',`c'+1]=p[4,1]
		local r=`r'+1
}
	local c=`c'+2
	local r=1
}

mat rownames tab1=`mvars' `nvars'

frmttable using `logpath'\propensity_death_tot_unadjusted, statmat(tab1) ctitles("" "Full Sample" "p" ///
 "Prob <.1" "p" "Prob >.25" "p") title("Adjusted regressions, 12m spending") ///
 note("all models are qui glm with family gamma and link log, exponentiated coefficients" ///
 "Coefficients for health variables reflect models controlling for non-health variables and vice versa") ///
 sdec(3) varlabels addtable

*/


frmttable using `logpath'\propensity_death_tot_unadjusted_printable, statmat(tab1) ctitles("" "Full Sample" "p" ///
 "Prob <.1" "p" "Prob >.25" "p") ///
title("Unadjusted regressions, 12m spending") note(all models are glm with family ///
gamma and link log, exponentiated coefficients) sdec(3) varlabels replace

local i=1
local j "Full Sample" 


foreach y in _full_sample _low _mid _high {
	local k=1
	if `i'==2 {
		local j "Probability of death <.10"
}
	if `i'==3 {
		local j "Probability of death .10-.25"
}
	if `i'==4 {
		local j "Probability of death >.25"
}
	qui glm tot_paid_by_mc_12m_wi_n0 `nvars' `mvars' midwest south west eol_spending_mid eol_spending_high if pdeath`y'==1, fam(gamma) link(log) eform
	qui outreg, varlabels ctitles("" "`k'") stats(e_b p)
	local k=`k'+1
	foreach x in `mvars' {
		if "`x'"!="adl_stable" {
			if "`x'"=="adl_decline" {
				qui glm tot_paid_by_mc_12m_wi_n0 `nvars' midwest south west eol_spending_mid eol_spending_high adl_stable `x'  if pdeath`y'==1, fam(gamma) link(log) eform
}
			else {	
				qui glm tot_paid_by_mc_12m_wi_n0 `nvars' midwest south west eol_spending_mid eol_spending_high `x' if pdeath`y'==1, fam(gamma) link(log) eform
}
		qui outreg, merge varlabels ctitles("" "`k'") stats(e_b p)
		local k=`k'+1
		if `k'==8 {
		outreg using `logpath'\propensity_death_tot_unadjusted_printable, replay addtable ///
		 title("Adjusted Regressions, 12m spending" "`j'") ///
		 note("All models are GLM with family gamma and link log, exponentiated coefficients" ///
		 "Total Medicare spending WI adjusted 2012$" "* p<0.05; ** p<0.01") basefont(fs10)
		local k=1
		qui glm tot_paid_by_mc_12m_wi_n0 `nvars' `mvars' eol_spending_mid eol_spending_high if pdeath`y'==1, fam(gamma) link(log) eform
		qui outreg, varlabels ctitles("" "`k'") stats(e_b p)
		local k=8
}
}
}

	local i=`i'+1
	outreg using `logpath'\propensity_death_tot_unadjusted_printable, replay addtable ///
	 title("Adjusted Regressions,12m spending" "`j'") ///
 	 note("All models are GLM with family gamma and link log, exponentiated coefficients" ///
	 "Total Medicare spending WI adjusted 2012$" "* p<0.05; ** p<0.01") basefont(fs10)
}

local i=1
local j "Full Sample" 

foreach y in _full_sample _low _mid _high {
	local k=1
	if `i'==2 {
		local j "Probability of death <.10"
}
	if `i'==3 {
		local j "Probability of death .10-.25"
}
	if `i'==4 {
		local j "Probability of death >.25"
}
	qui glm tot_paid_by_mc_12m_wi_n0 `nvars' `mvars' midwest south west eol_spending_mid eol_spending_high if pdeath`y'==1, fam(gamma) link(log) eform
	qui outreg, varlabels ctitles("" "`k'") stats(e_b p)
	local k=`k'+1
	foreach x in `nvars' "midwest south west" "eol_spending_mid eol_spending_high" {
		qui glm tot_paid_by_mc_12m_wi_n0 `mvars' `x' if pdeath`y'==1, fam(gamma) link(log) eform
		qui outreg, merge varlabels ctitles("" "`k'") stats(e_b p)
		local k=`k'+1
	if `k'==8 {
		outreg using `logpath'\propensity_death_tot_unadjusted_printable, replay addtable ///
		 title("Adjusted Regressions, 12m spending" "`j'") ///
		 note("All models are GLM with family gamma and link log, exponentiated coefficients" ///
		 "Total Medicare spending WI adjusted 2012$" "* p<0.05; ** p<0.01") basefont(fs10)
		local k=1
		qui glm tot_paid_by_mc_12m_wi_n0 `nvars' `mvars' midwest south west eol_spending_mid eol_spending_high if pdeath`y'==1, fam(gamma) link(log) eform
		qui outreg, varlabels ctitles("" "`k'") stats(e_b p)
		local k=8
}
}
	outreg using `logpath'\propensity_death_tot_unadjusted_printable, replay addtable ///
	 title("Adjusted Regressions,12m spending" "`j'") ///
 	 note("All models are GLM with family gamma and link log, exponentiated coefficients" ///
	 "Total Medicare spending WI adjusted 2012$" "* p<0.05; ** p<0.01") basefont(fs10)
	local i=`i'+1

}


H="*****************************************"


H="gom"


H="prior fmm"
clear all
capture log close
set more off
local logpath E:\data\serious_ill\logs
local datapath E:\data\serious_ill\final_data
cd `logpath'
use `datapath'\n0_n1_p1_p2_x_criteria_a_death_propensity.dta, clear

xtile cd=contact_days_n0, nq(4)
replace cd=cd-1 if cd>2
gen cd_low=cd==1
gen cd_mid=cd==2
gen cd_high=cd==3

gen totplus1_wi_n0=tot_paid_by_mc_12m_wi_n0+1 //new variable amt paid +$1
replace totplus1_wi_n0=1 if totplus1<0
local cvars age_at_core_n0

replace pain_hrs_n0=0 if missing(pain_hrs_n0)
local ivars female re_white ///
hs_deg_ind nw_midlow_n0 nw_midhigh_n0 nw_highest_n0 ///
religvimp_n0 srh_pf_n0 rel_nb_n0 married_n0 smi_nh_ind_n0 ///
medicaid_n0 champus_n0 medigap_n0 ///
smi_any_n0 ind_em_ur_adm_12m_n0 ///
adl_impair_core_n0
local region midwest south west eol_spending_mid eol_spending_high

local mvars  smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 ///
smi_liver_ind_n0  smi_hip_ind_n0 /*smi_nh_ind_n0*/ ///
srh_pf_n0 adl_impair_core_n0 hlphrs_i_group el_ge3_comorb_1yr_n0
local nvars age_at_core_n0 female re_black re_hisp ///notwhite ///
hs_deg_ind nw_lowest_n0 ///
religvimp_n0 rel_nb_n0 married_n0 smi_nh_ind_n0 ///
medicaid_n0 champus_n0 medigap_n0


log using `logpath'\fmm_prior_2.txt, text replace

forvalues i=2/7 {
qui fmm totplus1_wi_n0, mix(gamma) search(on) comp(`i') diff iterate(100)
estimates save `logpath'\est`i', replace
qui fmm totplus1_wi_n0, mix(gamma) search(on) comp(`i') prob(`cvars' `ivars' `region') diff iter(100)
estimates save `logpath'\est`i'prior, replace
estimates use est`i'
}

forvalues i=2/7 {
estimates use est`i'
estat ic
}


forvalues i=2/5 {
estimates use est`i'
qui fmm totplus1_wi_n0, mix(gamma) search(on) comp(`i') prob(`mvars' `nvars' `region') diff iter(145)
estimates save est`i'prior2, replace
}

forvalues i=2/5 {
di "`i' Comp"
foreach x in "" 2 {
estimates use est`i'prior`x'
estat ic
}
}



estimates use est3
estimates replay
qui fmm totplus1_wi_n0, mix(gamma) search(on) comp(2) diff iter(145)

qui fmm totplus1_wi_n0, mix(gamma) search(on) comp(3) diff iter(145)

qui fmm totplus1_wi_n0, mix(gamma) search(on) comp(3) prob(`mvars' `nvars' `region') diff iter(145)
predict pcomp1, prior eq(component1)
predict pcomp2, prior eq(component2)
predict pcomp3, prior eq(component3)
gen n=1
gen comp=1
replace comp=2 if pcomp2>=pcomp1
replace comp=3 if pcomp3>=pcomp2 & pcomp3>=pcomp1
local mvars  smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 ///
smi_liver_ind_n0  smi_hip_ind_n0 /*smi_nh_ind_n0*/ ///
srh_pf_n0 adl_impair_core_n0 hlphrs_i_group el_ge3_comorb_1yr_n0 criteria_b_n0 criteria_c_n0
local nvars age_at_core_n0 female re_black re_hisp ///notwhite ///
hs_deg_ind nw_lowest_n0 ///
religvimp_n0 rel_nb_n0 married_n0 smi_nh_ind_n0 ///
medicaid_n0 champus_n0 medigap_n0
local coutcomes tot_paid_by_mc_12m_wi_n0 ip_paid_by_mc_12m_wi_n0 n_hospd_p12m_n0 
local ioutcomes ind_hosp_adm_p12m_n0 mult_ip_adm_p12m_n0 mult_ed_vis_p12m_n0 ind_icu_vis_p12m_n0 ///
hs_admit_p12m_n0 core_to_dod_1yr_n0 loc_hosp_x



local rn : word count `mvars' `nvars' `coutcomes' `ioutcomes' N
local r=1
local c=1

mat tab=J(`rn',8,.)
mat stars=J(`rn',8,0)

foreach i in "1,2,3" 1 2 3 {
foreach x in `nvars' `mvars' `coutcomes' `ioutcomes' {
	sum `x' if inlist(comp,`i')
	if !inlist("`x'","age_at_core_n0","tot_paid_by_mc_12m_wi_n0","ip_paid_by_mc_12m_wi_n0","n_hospd_p12m_n0") {
		mat tab[`r',`c']=r(mean)*100
		if inlist("`i'","2","3") {
			tab `x' comp if inlist(comp,1,`i'), chi2
			mat tab[`r',`c'+1]=r(p)
			mat stars[`r',`c'+1]=(r(p)<.05) + (r(p)<.01)
}
}
	else {
		mat tab[`r',`c']=r(mean)
		if inlist("`i'","2","3") {
			ttest `x' if inlist(comp,1,`i'), by(comp)
			mat tab[`r',`c'+1]=r(p)
			mat stars[`r',`c'+1]=(r(p)<.05) + (r(p)<.01)
}
}
	local r=`r'+1
}
	sum n if inlist(comp,`i')
	mat tab[`r',`c']=r(N)
	local r=1
	local c=`c'+2
}

mat rownames tab=`nvars' `mvars' `coutcomes' `ioutcomes' N

frmttable using FMM_prior_table1.rtf, statmat(tab) title("Characteristics, 3 comp") ///
 ctitles("" "Full Sample" "Comp1" "Comp2" "Comp3") ///
 varlabels substat(1) annotate(stars) asymbol(*,**) replace
	
local spec1 `cvars' `ivars' `region'
local spec1 `nvars' `mvars' `region'
local spec2 age_at_core_n0 female re_black re_hisp hs_deg_ind nw_lowest_n0 ///
 married_n0 nhres_n0 smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 ///
smi_liver_ind_n0  smi_hip_ind_n0 /*smi_nh_ind_n0*/ ///
srh_pf_n0 adl_impair_core_n0 hlphrs_i_group el_ge3_comorb_1yr_n0 pain_hrs_n0 
local spec3 `spec2' cd_mid cd_high 
local spec4 `spec3' eol_spending_mid eol_spending_high
local spec5 `spec3' `region'
local spec6 `spec2' pain_hrs_n0 cd_mid cd_high 
local spec7 age_at_core_n0 female re_black re_hisp hs_deg_ind nw_lowest_n0 ///
married_n0 nhres_n0 srh_pf_n0 adl_impair_core_n0 hlphrs_i_group ///
el_ge3_comorb_1yr_n0 pain_hrs_n0 cd_mid cd_high 


outreg, clear
forvalues i=1/7 {
di "spec `i'"
estimates use est3
qui estimates replay
qui fmm totplus1, mix(gamma) search(on) comp(3) prob(`spec`i'') diff  iter(100)
estimates store spec`i'
estat ic
qui margins, dydx(*) predict(eq(component1) prior) post noesample
qui outreg, merge varlabels

}
outreg, replay
log close

save `datapath'\criteria_a_fmm, replace

H="**********************************************"


H="2010 NPI"
/* 2010 HRS NPI */

use "E:\data\serious_ill\final_data\n0_n1_p1_p2_x_criteria_2010.dta", clear
keep bid_hrs c_ivw_date_n0

****** SAS CODE **********; 

*HRS CLAIMS TO EXTRACT UNIQUE NPI;

libname merged "E:\data\cms_DUA_24548_2012";


data mpwide (keep= bid_hrs_21 from_dt thru_dt NPI hcpscd01--hcpscd45);
set merged.op_2000_2012(rename=(at_npi = NPI));
run;

/*
data test;
set mpwide;
miss = 0;
if NPI = . then miss = 1;
run;


proc means data = test; var miss; run;

*/



data opclaims (keep= bid_hrs_21 from_dt thru_dt NPI HCPCS_CD);
set mpwide;
array dx hcpscd01--hcpscd45;
do over dx;
HCPCS_CD=dx;
output;
end;
run;


data opclaims;
set opclaims;
cptcodes = input(compress(hcpcs_cd,'ABCDEFGHIJKLMNOPQRSTUVWXYZ/',),8.);
run;

data opclaims;
set opclaims;
cptflag = 0;
IF (99200 < cptcodes= < 99206) or (99210 < cptcodes <99216) or (99380 < cptcodes <99388) or (99390 < cptcodes < 99398) or (99303 < cptcodes < 99351) THEN cptflag = 1;
run;

data opclaims;
set opclaims;
gflag = indexc(hcpcs_cd, "G");
run;

data opclaims;
set opclaims;
IF (gflag = 1) and (437 < cptcodes < 440) then cptflag = 1;
IF (gflag = 1) and (cptcodes = 402) then cptflag = 1;
run; 

data opclaims1;
set opclaims(rename=(from_dt = admit_date thru_dt = disch_date));
where cptflag = 1;
run;

/*Carrier file */

data carrier (keep = bid_hrs_21 admit_date disch_date prfnpi01--prfnpi13 hcpcs_cd);
set merged.pb_2000_2012;
array dx hcpscd01--hcpscd13;
do over dx;
HCPCS_CD=dx;
output;
end;
run;

data carrier;
set carrier;
cptcodes = input(compress(hcpcs_cd,'ABCDEFGHIJKLMNOPQRSTUVWXYZ/',),8.);
run;


/*

data test1;
set carrier;
miss = 0;
if prfnpi01 = . then miss = 1;
run;

proc means data = test1; var miss; run;

*/


data carrier;
set carrier;
cptflag = 0;
IF (99200 < cptcodes= < 99206) or (99210 < cptcodes <99216) or (99380 < cptcodes <99388) or (99390 < cptcodes < 99398) or (99303 < cptcodes < 99351) THEN cptflag = 1;
run;

data carrier;
set carrier;
gflag = indexc(hcpcs_cd, "G");
run;

data carrier;
set carrier; 
IF (gflag = 1) and (437 < cptcodes < 440) then cptflag = 1;
IF (gflag = 1) and (cptcodes = 402) then cptflag = 1;
run; 

data carrier;
set carrier;
where cptflag = 1;
run;

data carrier1 (keep = bid_hrs_21 admit_date disch_date NPI hcpcs_cd);
set carrier;
array dx prfnpi01--prfnpi13;
do over dx;
NPI=dx;
output;
end;
run;

proc export data=opclaims1 outfile="C:\Users\rahmao03\Documents\opclaims_hrs.dta" dbms = dta replace;
proc export data=carrier1 outfile="C:\Users\rahmao03\Documents\carrier_hrs.dta" dbms = dta replace;



******** BACK TO STATA ***********;

use "C:\Users\rahmao03\Documents\opclaims_hrs.dta", clear

gen date1 = date(admit_date, "YMD")
format date1 %td

gen date2 = date(admit_date, "YMD")
format date2 %td 
gen yr = year(admit_date)
drop if yr < 2010 | yr > 2011
drop yr


drop admit_date disch_date cptflag cptcodes gflag
rename date1 admit_date
rename date2 disch_date

save "C:\Users\rahmao03\Documents\opclaims_hrs.dta", replace

use "C:\Users\rahmao03\Documents\carrier_hrs.dta", clear
format admit_date %td
format disch_date %td
gen yr = year(admit_date)
drop if yr < 2010 | yr > 2011
drop yr
save "C:\Users\rahmao03\Documents\carrier_hrs.dta", replace

append using "C:\Users\rahmao03\Documents\opclaims_hrs.dta"

saveold "C:\Users\rahmao03\Documents\npi_hrs.dta", replace



/*import and merge in SAS then export back to Stata */

**SAS**;

proc import datafile="C:\Users\rahmao03\Documents\bid_hrs1.dta" out=bid dbms = dta replace;
run;

proc import datafile="C:\Users\rahmao03\Documents\npi_hrs.dta" out=npi dbms = dta replace;
run;


proc sql;
create table npi_1 as select a.*, b.*
from bid as a
left join npi as b
on a.bid_hrs = b.bid_hrs_21
order by a.bid_hrs;
quit;

proc export data=npi_1 outfile="C:\Users\rahmao03\Documents\npi_hrs_v1.dta" dbms =dta replace;

**Stata**;

use "C:\Users\rahmao03\Documents\npi_hrs_v1.dta", clear

format admit_date %td
format disch_date %td


gen count = admit_date - c_ivw_date_n0 
keep if (count>=0 & count <=365)

drop count
duplicates drop bid_hrs npi, force
duplicates report

*bysort bid_hrs: gen npi_cnt = _N
destring npi, replace

egen npi_count = count(npi), by(bid_hrs)
cap drop _m
merge m:1 bid_hrs using "E:\data\serious_ill\final_data\n0_n1_p1_p2_x_criteria_2010.dta"
duplicates drop bid_hrs ,force
replace npi_count = 0 if npi_count==.

save "E:\data\serious_ill\final_data\n0_n1_p1_p2_x_criteria_2010_npi.dta", replace
