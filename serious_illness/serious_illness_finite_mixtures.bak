= V4 Outline MultiLine NoSorting TabWidth=30

H=" "
Serious illness FMM

Uses the serious illness dataset created in E:\hrs_code\serious_illnes\Serious_illness_cohort_2014.txt



H="FMM null models"
clear all
capture log close
set more off
local logpath E:\data\serious_ill\logs
local datapath E:\data\serious_ill\final_data
cd `logpath'
use `datapath'\n0_n1_p1_p2_x_criteria_a_death_propensity.dta, clear

xtile cd=contact_days_n0, nq(4)
replace cd=cd-1 if cd>2
gen cd_low=cd==1
gen cd_mid=cd==2
gen cd_high=cd==3

gen totplus1_wi_n0=tot_paid_by_mc_12m_wi_n0+1 //new variable amt paid +$1
replace totplus1_wi_n0=1 if totplus1<0
local cvars age_at_core_n0

replace pain_hrs_n0=0 if missing(pain_hrs_n0)
local ivars female re_white ///
hs_deg_ind nw_midlow_n0 nw_midhigh_n0 nw_highest_n0 ///
religvimp_n0 srh_pf_n0 rel_nb_n0 married_n0 smi_nh_ind_n0 ///
medicaid_n0 champus_n0 medigap_n0 ///
smi_any_n0 ind_em_ur_adm_12m_n0 ///
adl_impair_core_n0
local region midwest south west eol_spending_mid eol_spending_high

local mvars  smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 ///
smi_liver_ind_n0  smi_hip_ind_n0 /*smi_nh_ind_n0*/ ///
srh_pf_n0 adl_impair_core_n0 hlphrs_i_group el_ge3_comorb_1yr_n0
local nvars age_at_core_n0 female re_black re_hisp ///notwhite ///
hs_deg_ind nw_lowest_n0 ///
religvimp_n0 rel_nb_n0 married_n0 smi_nh_ind_n0 ///
medicaid_n0 champus_n0 medigap_n0
local spec2 age_at_core_n0 female re_black re_hisp hs_deg_ind nw_lowest_n0 ///
 married_n0 nhres_n0 smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 ///
smi_liver_ind_n0  smi_hip_ind_n0 /*smi_nh_ind_n0*/ ///
srh_pf_n0 adl_impair_core_n0 hlphrs_i_group el_ge3_comorb_1yr_n0 pain_hrs_n0 
local spec3 `spec2' cd_mid cd_high 
/*
log using `logpath'\fmm2_normals_prior.txt, text replace

forvalues i=2/5 {
fmm totplus1_wi_n0 , mix(normal) comp(`i') diff iterate(200)
estat ic
estimates save `logpath'\est`i', replace
}
forvalues i=2/5 {
fmm totplus1_wi_n0, mix(normal) search(on) comp(`i') iterate(200)
estat ic
estimates save `logpath'\est`i', replace
}*//*
forvalues i=2/5 {
fmm tot_paid_by_mc_12m_wi_n0, mix(normal) search(on) comp(`i') diff iterate(200)
estat ic
estimates save `logpath'\est`i', replace
}

forvalues i= 2(3)5 {
estimates use est`i'
estimates replay
fmm tot_paid_by_mc_12m_wi_n0, prob(`cvars' `ivars' `region') mix(normal) ///
 comp(`i') iterate(200)
estat ic
}
*/
forvalues i= 2(3)5 {
estimates use est`i'
qui estimates replay
fmm tot_paid_by_mc_12m_wi_n0, prob(`spec3' eol_spending_mid eol_spending_high) mix(normal) ///
search(on) comp(`i') diff iterate(500)
estat ic
estimates save `logpath'\est`i'_prior, replace
}
*/
*log close


H="FMM with priors added"


H="table"
clear all
capture log close
set more off
local logpath E:\data\serious_ill\logs
local datapath E:\data\serious_ill\final_data
cd `logpath'
use `datapath'\n0_n1_p1_p2_x_criteria_a_death_propensity.dta, clear

gen totplus1_wi_n0=tot_paid_by_mc_12m_wi_n0+1 //new variable amt paid +$1
replace totplus1_wi_n0=1 if totplus1<0
local cvars age_at_core_n0


local ivars female re_white ///
hs_deg_ind nw_midlow_n0 nw_midhigh_n0 nw_highest_n0 ///
religvimp_n0 srh_pf_n0 rel_nb_n0 married_n0 smi_nh_ind_n0 ///
medicaid_n0 champus_n0 medigap_n0 ///
smi_any_n0 ind_em_ur_adm_12m_n0 ///
adl_impair_core_n0
local region midwest south west eol_spending_mid eol_spending_high

local mvars  smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 ///
smi_liver_ind_n0  smi_hip_ind_n0 /*smi_nh_ind_n0*/ ///
srh_pf_n0 adl_impair_core_n0 hlphrs_i_group el_ge3_comorb_1yr_n0
local nvars age_at_core_n0 female re_black re_hisp ///notwhite ///
hs_deg_ind nw_lowest_n0 ///
religvimp_n0 rel_nb_n0 married_n0 smi_nh_ind_n0 ///
medicaid_n0 champus_n0 medigap_n0

log using `logpath'\fmm_priors.txt, text replace
forvalues i=2/6 {
qui fmm totplus1_wi_n0, mix(gamma) comp(`i') diff iterate(100)
estimates save `logpath'\est`i', replace
qui fmm totplus1_wi_n0, mix(gamma) comp(`i') prob(`cvars' `ivars' `region') diff iter(100)
estimates save `logpath'\est`i'prior, replace
estimates use est`i'
}

forvalues i=2/7 {
estimates use est`i'
estat ic
}

forvalues i=2/6 {
estimates use est`i'prior
estat ic
}

forvalues i=2/5 {
estimates use est`i'
qui fmm totplus1_wi_n0, mix(gamma) comp(`i') prob(`mvars' `nvars' `region') diff iter(145)
estimates save est`i'prior2, replace
}

forvalues i=2/5 {
di "`i' Comp"
foreach x in "" 2 {
estimates use est`i'prior`x'
estat ic
}
}

log close

estimates use est3prior2
estimates replay
predict pcomp1, prior eq(component1)
predict pcomp2, prior eq(component2)
predict pcomp3, prior eq(component3)
gen comp=1
replace comp=2 if pcomp2>=pcomp1
replace comp=3 if pcomp3>=pcomp2 & pcomp3>=pcomp1
local mvars  smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 ///
smi_liver_ind_n0  smi_hip_ind_n0 /*smi_nh_ind_n0*/ ///
srh_pf_n0 adl_impair_core_n0 hlphrs_i_group el_ge3_comorb_1yr_n0 criteria_b_n0 criteria_c_n0
local nvars age_at_core_n0 female re_black re_hisp ///notwhite ///
hs_deg_ind nw_lowest_n0 ///
religvimp_n0 rel_nb_n0 married_n0 smi_nh_ind_n0 ///
medicaid_n0 champus_n0 medigap_n0
local coutcomes tot_paid_by_mc_12m_wi_n0 ip_paid_by_mc_12m_wi_n0 n_hospd_p12m_n0 
local ioutcomes ind_hosp_adm_p12m_n0 mult_ip_adm_p12m_n0 mult_ed_vis_p12m_n0 ind_icu_vis_p12m_n0 ///
hs_admit_p12m_n0 core_to_dod_1yr_n0 loc_hosp_x



local rn : word count `mvars' `nvars' `coutcomes' `ioutcomes'
local r=1
local c=1

mat tab=J(`rn',8,.)
mat stars=J(`rn',8,0)

foreach i in "1,2,3" 1 2 3 {
foreach x in `nvars' `mvars' `coutcomes' `ioutcomes' {
	sum `x' if inlist(comp,`i')
	if !inlist("`x'""age_at_core_n0","tot_paid_by_mc_12m_wi_n0","ip_paid_by_mc_12m_wi_n0","n_hospd_p12m_n0") {
		mat tab[`r',`c']=r(mean)*100
		if inlist("`i'","2","3") {
			tab `x' comp if inlist(comp,1,`i'), chi2
			mat tab[`r',`c'+1]=r(p)
			mat stars[`r',`c'+1]=(r(p)<.05) + (r(p)<.01)
}
}
	else {
		mat tab[`r',`c']=r(mean)
		if inlist("`i'","2","3") {
			ttest `x' if inlist(comp,1,`i'), by(comp)
			mat tab[`r',`c'+1]=r(p)
			mat stars[`r',`c'+1]=(r(p)<.05) + (r(p)<.01)
}
}
	local r=`r'+1
}
	local r=1
	local c=`c'+2
}

mat rownames tab=`nvars' `mvars' `coutcomes' `ioutcomes'

frmttable, statmat(tab) title("Characteristics, 3 comp") ctitles("" "Comp1" "Comp2" "Comp3) ///
 varlabels substat(1) annotate(stars) starlevel(*,**)
	

H="FMM null, mixture of normals"
clear all
capture log close
set more off
local logpath "E:\data\serious_ill\logs"
local datapath E:\data\serious_ill\final_data
cd `logpath'
use `datapath'\n0_n1_p1_p2_x_criteria_a_death_propensity.dta, clear

xtile cd=contact_days_n0, nq(4)
replace cd=cd-1 if cd>2
gen cd_low=cd==1
gen cd_mid=cd==2
gen cd_high=cd==3

gen totplus1_wi_n0=tot_paid_by_mc_12m_wi_n0+1 //new variable amt paid +$1
replace totplus1_wi_n0=1 if totplus1<0
local cvars age_at_core_n0

replace pain_hrs_n0=0 if missing(pain_hrs_n0)
local ivars female re_white ///
hs_deg_ind nw_midlow_n0 nw_midhigh_n0 nw_highest_n0 ///
religvimp_n0 srh_pf_n0 rel_nb_n0 married_n0 smi_nh_ind_n0 ///
medicaid_n0 champus_n0 medigap_n0 ///
smi_any_n0 ind_em_ur_adm_12m_n0 ///
adl_impair_core_n0
local region midwest south west eol_spending_mid eol_spending_high

local mvars  smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 ///
smi_liver_ind_n0  smi_hip_ind_n0 /*smi_nh_ind_n0*/ ///
srh_pf_n0 adl_impair_core_n0 hlphrs_i_group el_ge3_comorb_1yr_n0
local nvars age_at_core_n0 female re_black re_hisp ///notwhite ///
hs_deg_ind nw_lowest_n0 ///
religvimp_n0 rel_nb_n0 married_n0 smi_nh_ind_n0 ///
medicaid_n0 champus_n0 medigap_n0
local spec2 age_at_core_n0 female re_black re_hisp hs_deg_ind nw_lowest_n0 ///
 married_n0 nhres_n0 smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 ///
smi_liver_ind_n0  smi_hip_ind_n0 /*smi_nh_ind_n0*/ ///
srh_pf_n0 adl_impair_core_n0 hlphrs_i_group el_ge3_comorb_1yr_n0 pain_hrs_n0 
local spec3 `spec2' cd_mid cd_high 


local xvars age_at_core_n0 female re_black re_hisp hs_deg_ind nw_lowest_n0 ///
 married_n0 nhres_n0 smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 ///
smi_liver_ind_n0  smi_hip_ind_n0 /*smi_nh_ind_n0*/ ///
srh_pf_n0 adl_impair_core_n0 hlphrs_i_group el_ge3_comorb_1yr_n0 pain_hrs_n0 ///
cd_mid cd_high eol_spending_low

//determined by BIC comparison to use just eol spending low rather than mid & high
//better to use cd_mid & high than just cd_low, better just to use nw low

//joint test shows that hip liver dementia nhres married HS degree not significant


log using `logpath'\fmm2_normals_prior.txt, text replace
local xvars age_at_core_n0 female re_black re_hisp nw_lowest_n0 ///
smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 ///
srh_pf_n0 adl_impair_core_n0 hlphrs_i_group el_ge3_comorb_1yr_n0 pain_hrs_n0 ///
cd_mid cd_high eol_spending_low

estimates use est5
fmm tot_paid_by_mc_12m_wi_n0, prob(`xvars' eol_spending_low) mix(normal) comp(5) iterate(100)  
estat ic
estimates save `logpath'\est5_prior, replace
foreach x of local xvars {
test `x'
}

log close


H="margins"
clear all
capture log close
set more off
local logpath "E:\data\serious_ill\logs"
local datapath E:\data\serious_ill\final_data
cd `logpath'
use `datapath'\n0_n1_p1_p2_x_criteria_a_death_propensity.dta, clear
gen core_year=core_year_n0
merge 1:1 id core_year using E:\data\hrs_public_2012\dementia\pdem_withvarnames_ebl, keep(match master) nogen

gen ldem_gt50=pdem>=.5 if !missing(pdem)
xtile cd=contact_days_n0, nq(4)
replace cd=cd-1 if cd>2
gen cd_low=cd==1
gen cd_mid=cd==2
gen cd_high=cd==3

gen totplus1_wi_n0=tot_paid_by_mc_12m_wi_n0+1 //new variable amt paid +$1
replace totplus1_wi_n0=1 if totplus1<0
local cvars age_at_core_n0

replace pain_hrs_n0=0 if missing(pain_hrs_n0)
log using `logpath'\fmm_normals_prior_margins.txt, text replace

local xvars age_at_core_n0 female re_black re_hisp nw_lowest_n0 ///
ldem_gt50 smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 ///
srh_pf_n0 adl_impair_core_n0 hlphrs_i_group el_ge3_comorb_1yr_n0 pain_hrs_n0 ///
cd_mid cd_high eol_spending_low

estimates use est5
estat ic
qui fmm tot_paid_by_mc_12m_wi_n0, prob(`xvars' eol_spending_low) mix(normal) comp(5) iterate(100)  
estat ic
estimates replay
di "AMEs"
forvalues i=1/5 {
di "Component `i'"
margins, dydx(*) predict(eq(component`i') prior)
}
di "Predictive Margins"
forvalues i=1/5 {
di "Component `i'"
margins, predict(eq(component`i') prior)
}
log close


H="margins, outreg"
clear all
capture log close
set more off
local logpath "E:\data\serious_ill\logs"
local datapath E:\data\serious_ill\final_data
cd `logpath'
use `datapath'\n0_n1_p1_p2_x_criteria_a_death_propensity.dta, clear
gen core_year=core_year_n0
merge 1:1 id core_year using E:\data\hrs_public_2012\dementia\pdem_withvarnames_ebl, keep(match master) nogen

gen ldem_gt50=pdem>=.5 if !missing(pdem)
xtile cd=contact_days_n0, nq(4)
replace cd=cd-1 if cd>2
gen cd_low=cd==1
gen cd_mid=cd==2
gen cd_high=cd==3

gen totplus1_wi_n0=tot_paid_by_mc_12m_wi_n0+1 //new variable amt paid +$1
replace totplus1_wi_n0=1 if totplus1<0
local cvars age_at_core_n0

replace pain_hrs_n0=0 if missing(pain_hrs_n0)

local xvars age_at_core_n0 female re_black re_hisp nw_lowest_n0 ///
smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 ///
srh_pf_n0 adl_impair_core_n0 hlphrs_i_group el_ge3_comorb_1yr_n0 pain_hrs_n0 ///
cd_mid cd_high eol_spending_low ldem_gt50

capture log close
log using "FMM_normal_5comp_margins_dem.txt", text replace

outreg, clear

estimates use est5
estimates replay
qui fmm tot_paid_by_mc_12m_wi_n0, prob(`xvars') mix(normal) comp(5) iterate(100)  
estimates replay
forvalues i=1/5 {
qui estimates use est5
qui fmm tot_paid_by_mc_12m_wi_n0, prob(`xvars') mix(normal) comp(5) iterate(100)  
margins, dydx(*) predict(eq(component`i') prior) post 
qui outreg, varlabels merge ctitles("" "Comp `i'")
}
outreg using "FMM_normal_5comp_margins", replay replace title(Average marginal effects)
outreg, clear 
forvalues i=1/5 {
qui estimates use est5
qui fmm tot_paid_by_mc_12m_wi_n0, prob(`xvars') mix(normal) comp(5) iterate(100)  
margins, predict(eq(component`i') prior) post
qui outreg, varlabels merge ctitles("" "Comp `i'")
}
outreg using "FMM_normal_5comp_margins", replay addtable title(Margins)


H="margins, looking at dementia"
local xvars age_at_core_n0 female re_black re_hisp nw_lowest_n0 ///
smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 ///
srh_pf_n0 adl_impair_core_n0 hlphrs_i_group el_ge3_comorb_1yr_n0 pain_hrs_n0 ///
cd_mid cd_high eol_spending_low

/*
qui glm tot_paid_by_mc_12m_wi_n0 `xvars'  if !missing(ldem_g), link(log) fam(gamma)
estat ic 
qui glm tot_paid_by_mc_12m_wi_n0 `xvars' ldem_g if !missing(ldem_g), link(log) fam(gamma)
estat ic 
margins, dydx(ldem_g)
qui glm tot_paid_by_mc_12m_wi_n0 `xvars' smi_dem_ind_n0  if !missing(ldem_g), link(log) fam(gamma)
estat ic 
margins, dydx(smi_dem_ind_n0)
qui glm tot_paid_by_mc_12m_wi_n0 `xvars' comorb_31_0_1yr_n0 if !missing(ldem_g), link(log) fam(gamma)
estat ic 
margins, dydx(comorb_31_0_1yr_n0)

capture log close
*log using "fmm_dementia.txt", text replace
foreach 1 in 0 {
foreach x in ldem_gt50 smi_dem_ind_n0 {
estimates use est5
qui fmm tot_paid_by_mc_12m_wi_n0  if !missing(ldem_g), prob(`xvars' `x' ) mix(normal) comp(5) iterate(100)  
test `x'
estat ic
}
estimates use est5
qui fmm tot_paid_by_mc_12m_wi_n0   if !missing(ldem_g), prob(`xvars' eol_spending_low) mix(normal) comp(5) iterate(100)  
estat ic
}
log close

forvalues i=2/6 {
fmm tot_paid_by_mc_12m_wi_n0 `xvars' ldem_g, mix(normal) comp(`i')
estat ic
}
*/
capture log close
log using "Different specs.txt", text replace
local x2  age_at_core_n0 female re_black re_hisp nw_lowest_n0 ///
smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 ///
srh_pf_n0 adl_impair_core_n0 hlphrs_i_group el_ge3_comorb_1yr_n0 pain_hrs_n0 ///
cd_mid cd_high eol_spending_low ldem_g

estimates use est5
qui fmm tot_paid_by_mc_12m_wi_n0 if !missing(ldem_g), prob(`x2') ///
mix(normal) comp(5) iterate(100)  
estat ic
tokenize `x2'
local wc : word count `x2'

forvalues i=1/`wc' {
	local xs
foreach x in `x2' {
	if "`x'" !="``i''" local xs `xs' `x' 
}
	di "``i''"
estimates use est5
qui fmm tot_paid_by_mc_12m_wi_n0 if !missing(ldem_g), prob(`xs') ///
mix(normal) comp(5) iterate(100)  
estat ic
}
log close


H="table 1s"
clear all
capture log close
set more off
local logpath E:\data\serious_ill\logs
local datapath E:\data\serious_ill\final_data
cd `logpath'
use `datapath'\n0_n1_p1_p2_x_criteria_a_death_propensity.dta, clear
gen core_year=core_year_n0
merge 1:1 id core_year using E:\data\hrs_public_2012\dementia\pdem_withvarnames_ebl, keep(match master) nogen

gen totplus1_wi_n0=tot_paid_by_mc_12m_wi_n0+1 //new variable amt paid +$1
replace totplus1_wi_n0=1 if totplus1<0
local cvars age_at_core_n0
gen ldem_gt50=pdem>=.5 & !missing(pdem)
xtile cd=contact_days_n0, nq(4)
replace cd=cd-1 if cd>2
gen cd_low=cd==1
gen cd_mid=cd==2
gen cd_high=cd==3

local ivars female re_white ///
hs_deg_ind nw_midlow_n0 nw_midhigh_n0 nw_highest_n0 ///
religvimp_n0 srh_pf_n0 rel_nb_n0 married_n0 smi_nh_ind_n0 ///
medicaid_n0 champus_n0 medigap_n0 ///
smi_any_n0 ind_em_ur_adm_12m_n0 ///
adl_impair_core_n0
local region midwest south west eol_spending_mid eol_spending_high

local mvars  smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 ///
smi_liver_ind_n0  smi_hip_ind_n0 /*smi_nh_ind_n0*/ ///
srh_pf_n0 adl_impair_core_n0 hlphrs_i_group el_ge3_comorb_1yr_n0
local nvars age_at_core_n0 female re_black re_hisp ///notwhite ///
hs_deg_ind nw_lowest_n0 ///
religvimp_n0 rel_nb_n0 married_n0 smi_nh_ind_n0 ///
medicaid_n0 champus_n0 medigap_n0

local xvars age_at_core_n0 female re_black re_hisp nw_lowest_n0 ///
smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 ///
srh_pf_n0 adl_impair_core_n0 hlphrs_i_group el_ge3_comorb_1yr_n0 pain_hrs_n0 ///
cd_mid cd_high eol_spending_low ldem_gt50
sum `xvars' `othervars' 
*log using `logpath'\fmm_priors.txt, text replace
/*
forvalues i=2/6 {
qui fmm totplus1_wi_n0, mix(gamma) comp(`i') diff iterate(100)
estimates save `logpath'\est`i', replace
qui fmm totplus1_wi_n0, mix(gamma) comp(`i') prob(`cvars' `ivars' `region') diff iter(100)
estimates save `logpath'\est`i'prior, replace
estimates use est`i'
}

forvalues i=2/7 {
estimates use est`i'
estat ic
}

forvalues i=2/6 {
estimates use est`i'prior
estat ic
}

forvalues i=2/5 {
estimates use est`i'
qui fmm totplus1_wi_n0, mix(gamma) comp(`i') prob(`mvars' `nvars' `region') diff iter(145)
estimates save est`i'prior2, replace
}

forvalues i=2/5 {
di "`i' Comp"
foreach x in "" 2 {
estimates use est`i'prior`x'
estat ic
}
}

log close
*/
estimates use est5
fmm tot_paid_by_mc_12m_wi_n0, prob(`xvars' `othervars' ) mix(normal) comp(5) iterate(100)  
/*estimates save est5_prior, replace

estimates use est5_prior
estimates replay*/
forvalues i=1/5 {
predict priorcomp`i', prior eq(component`i')
predict postcomp`i', posterior eq(component`i')
predict p`i', eq(component`i')
}

gen prior=0 if !missing(priorcomp1)
gen post=0 if !missing(priorcomp1)
forvalues i=1/5 {
replace prior=`i' if priorcomp`i'>=priorcomp1 & priorcomp`i'>=priorcomp2 & priorcomp`i'>=priorcomp3 & priorcomp`i'>=priorcomp4 & priorcomp`i'>=priorcomp5
replace post=`i' if postcomp`i'>=postcomp1 & postcomp`i'>=postcomp2 & postcomp`i'>=postcomp3 & postcomp`i'>=postcomp4 & postcomp`i'>=postcomp5
}

local mvars  smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 ///
smi_liver_ind_n0  smi_hip_ind_n0 /*smi_nh_ind_n0*/ ///
srh_pf_n0 adl_impair_core_n0 hlphrs_i_group el_ge3_comorb_1yr_n0 criteria_b_n0 criteria_c_n0
local nvars age_at_core_n0 female re_black re_hisp ///notwhite ///
hs_deg_ind nw_lowest_n0 ///
religvimp_n0 rel_nb_n0 married_n0 smi_nh_ind_n0 ///
medicaid_n0 champus_n0 medigap_n0 ldem_gt50
local coutcomes tot_paid_by_mc_12m_wi_n0 ip_paid_by_mc_12m_wi_n0 n_hospd_p12m_n0 
local ioutcomes ind_hosp_adm_p12m_n0 mult_ip_adm_p12m_n0 mult_ed_vis_p12m_n0 ind_icu_vis_p12m_n0 ///
hs_admit_p12m_n0 core_to_dod_1yr_n0 loc_hosp_x

gen n=1
replace pain_hrs_n0=0 if missing(pain_hrs_n0)

local xvars age_at_core_n0 female re_black re_hisp nw_lowest_n0 ///
smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 ///
srh_pf_n0 adl_impair_core_n0 hlphrs_i_group el_ge3_comorb_1yr_n0 pain_hrs_n0 ///
cd_mid cd_high eol_spending_low ldem_gt50

local othervars smi_dem_ind_n0 smi_liver_ind_n0  smi_hip_ind_n0 ///
criteria_b_n0 criteria_c_n0 hs_deg_ind religvimp_n0 rel_nb_n0 married_n0 smi_nh_ind_n0 ///
medicaid_n0 champus_n0 medigap_n0 

label var ldem_gt50 "Probability of dementia>.5"
label var core_to_dod_1yr_n0 "Death within one year of interview"
label var cd_mid "Contact Days: Middle 50%"
label var cd_high "Contact Days: Top quartile"
foreach pri in prior post {

local rn : word count `xvars' `othervars' `coutcomes' `ioutcomes' 1 1
local r=1
local c=1


mat tab=J(`rn',12,.)
mat stars=J(`rn',12,0)

foreach i in 1 2 3 4 5 {
foreach x in `xvars' `othervars'  `coutcomes' `ioutcomes' {
	qui sum `x' [aw=`pri'comp`i']
	if !inlist("`x'","age_at_core_n0","tot_paid_by_mc_12m_wi_n0","ip_paid_by_mc_12m_wi_n0","n_hospd_p12m_n0") {
		mat tab[`r',`c']=r(mean)*100
		/*if !inlist("`i'","1") {
			tab `x' comp if inlist(comp,1,`i'), chi2
			mat tab[`r',`c'+1]=r(p)
			mat stars[`r',`c'+1]=(r(p)<.05) + (r(p)<.01)
}*/
}
	else {
		mat tab[`r',`c']=r(mean)
	/*	if !inlist("`i'","1") {
			ttest `x' if inlist(comp,1,`i'), by(comp)
			mat tab[`r',`c'+1]=r(p)
			mat stars[`r',`c'+1]=(r(p)<.05) + (r(p)<.01)
}*/
}
	local r=`r'+1
}
	sum n [aw=`pri'comp`i']
	mat tab[`r',`c']=r(sum_w)
	mat tab[`r'+1,`c']=r(mean)*r(N)
	local r=1
	local c=`c'+2
}

mat rownames tab=`xvars' `othervars'  `coutcomes' `ioutcomes' N(weight) N

frmttable using "FMM_5comp_`pri'_table1.rtf", replace statmat(tab) ///
title("Characteristics,5 comp (weighted by `pri' probability)") ctitles("" "Comp1" "Comp2" "Comp3" ///
"Comp4" "Comp5") ///
 varlabels substat(1) annotate(stars) asymbol(*,**)
	
twoway kdensity postcomp1 || kdensity postcomp2 || kdensity postcomp3 || kdensity postcomp4 || ///
 kdensity postcomp5

twoway kdensity tot_paid_by_mc_12m_wi_n0 if post==1 || kdensity tot_paid_by_mc_12m_wi_n0 if post==2 || kdensity tot_paid_by_mc_12m_wi_n0 if post==3 || kdensity tot_paid_by_mc_12m_wi_n0 if post==4 || ///
 kdensity tot_paid_by_mc_12m_wi_n0 if post==5
 
twoway kdensity priorcomp1 || kdensity priorcomp2 || kdensity priorcomp3 || kdensity priorcomp4 || ///
 kdensity priorcomp5

twoway kdensity tot_paid_by_mc_12m_wi_n0 if prior==1 || kdensity tot_paid_by_mc_12m_wi_n0 if prior==2 || kdensity tot_paid_by_mc_12m_wi_n0 if prior==3 || kdensity tot_paid_by_mc_12m_wi_n0 if prior==4 || ///
 kdensity tot_paid_by_mc_12m_wi_n0 if prior==5
 
gen lntot=ln(tot_paid_by_mc_12m_wi_n0) 
twoway kdensity lntot if prior==1 || kdensity lntot if prior==2 || kdensity lntot if prior==3 || kdensity lntot if prior==4 || ///
 kdensity lntot if prior==5

 twoway kdensity lntot if post==1 || kdensity lntot if post==2 || kdensity lntot if post==3 || kdensity lntot if post==4 || ///
 kdensity lntot if post==5

local rn : word count `xvars' `othervars'  `coutcomes' `ioutcomes' 1
local r=1
local c=1


mat tab=J(`rn',12,.)
mat stars=J(`rn',12,0)

foreach i in 1 2 3 4 5 {
foreach x in `xvars' `othervars'  `coutcomes' `ioutcomes' {
	qui sum `x' if inlist(`pri',`i')
	if !inlist("`x'","age_at_core_n0","tot_paid_by_mc_12m_wi_n0","ip_paid_by_mc_12m_wi_n0","n_hospd_p12m_n0") {
		mat tab[`r',`c']=r(mean)*100
		/*if !inlist("`i'","1") {
			tab `x' comp if inlist(comp,1,`i'), chi2
			mat tab[`r',`c'+1]=r(p)
			mat stars[`r',`c'+1]=(r(p)<.05) + (r(p)<.01)
}*/
}
	else {
		mat tab[`r',`c']=r(mean)
	/*	if !inlist("`i'","1") {
			ttest `x' if inlist(comp,1,`i'), by(comp)
			mat tab[`r',`c'+1]=r(p)
			mat stars[`r',`c'+1]=(r(p)<.05) + (r(p)<.01)
}*/
}
	local r=`r'+1
}
	sum n if `pri'==`i'
	mat tab[`r',`c']=r(N)
	local r=1
	local c=`c'+2
}

mat rownames tab=`xvars' `othervars'  `coutcomes' `ioutcomes' N

frmttable using "FMM_5comp_`pri'_table1.rtf", addtable statmat(tab) ///
title("Characteristics,5 comp (Most likely component, `pri' probability)") ctitles("" "Comp1" "Comp2" "Comp3" ///
"Comp4" "Comp5") ///
 varlabels substat(1) annotate(stars) asymbol(*,**)
}	


H="FMM on hospital days"


H="likely splitting into two subprojects--identification and prediction"


H="************************"


H="Idenitfying high-spending groups"


H="*******************"


H="HCC 2012 model applied to all waves"


H="get index date and dxs for HCC model"
libname proj_int 'E:\data\serious_ill\int_data'; 
libname proj_fin 'E:\data\serious_ill\final_data';
libname hcc 'E:\Code modules\hcc\2012MidyearFinalModel\CMS-HCC_2012software_MA_Cost';
libname medi 'E:\data\cms_DUA_24548_2012';

/*get index*/
option nofmterr;


data index(keep= id bid_hrs_21 index_year index_date);
set proj_fin.n0_n1_p1_p2_x_criteria_a;
index_date=c_ivw_date_n0;
index_year=year(index_date);
bid_hrs_21=bid_hrs;
run;

%macro getmeet(source=,time=);

proc sql;
create table &source._meet_&time. as select * from
index a
left join
medi.&source._2000_2012 b
on a.bid_hrs_21=b.bid_hrs_21 and b.admit_date<=a.index_date<=b.admit_date+&time;
quit;

%mend;

%getmeet(source=mp,time=365);
%getmeet(source=op,time=365);
%getmeet(source=pb,time=365);
%getmeet(source=hh,time=365);
%getmeet(source=dm,time=365);
%getmeet(source=hs,time=365);

data meet_all1(keep=bid_hrs_21 diag);
set mp_meet_365 op_meet_365 pb_meet_365 hh_meet_365 dm_meet_365 hs_meet_365;
array dx dgns_cd01-dgns_cd25 dgnscd01-dgnscd25 ad_dgns PRNCPAL_DGNS_CD ADMTG_DGNS_CD;
do over dx;
diag=dx;
output;
end;
run;

data meet_all;
set meet_all1;
if diag~='';
run;

proc sort data=meet_all out=proj_int.diag nodup;
by bid_hrs_21 diag;
run;

/*need to get sex, dob, mcaid, nemcaid, & orec from dn file*/
proc sql;
create table dn as select * from
index a 
left join
medi.dn_2000_2012 b
on a.bid_hrs_21=b.bid_hrs_21 and a.index_year=b.year;
quit;

proc sort;
by bid_hrs_21 year;
run;

data dn2;
set dn;
dob=birth_date;
mcaid=buyin_mo>0;
by bid_hrs_21;
if first.bid_hrs_21 then fyear=year;
run;

data proj_int.person(keep=bid_hrs_21 orec mcaid nemcaid dob sex);
set dn2;
if year=index_year;
nemcaid=buyin_mo>0 and fyear=index_year;
run;


H="Call the HCC model"

  LIBNAME LIBRARY "E:\Code modules\hcc\2012MidyearFinalModel\CMS-HCC_2012software_MA_Cost";
  FILENAME IN0 "E:\Code modules\hcc\2012MidyearFinalModel\CMS-HCC_2012software_MA_Cost";
  LIBNAME  IN1 "E:\data\serious_ill\int_data";
  LIBNAME  IN2 "E:\data\serious_ill\int_data";
  LIBNAME  INCOEF "E:\Code modules\hcc\2012MidyearFinalModel\CMS-HCC_2012software_MA_Cost";
  LIBNAME  OUT "E:\data\serious_ill\int_data";
  
 ***********************************************************************
 *
 *   DESCRIPTION:
 *
 * V1212F1P program creates seventy HCC variables (&CMSHCC) and four
 * score variables for each person who is present in a person file
 * supplied by a user.
 * If a person has at least one diagnosis in DIAG file (supplied by a
 * user) then HCC variables are created, otherwise HCCs are set to 0 .
 * Score variables are created using coefficients from 4 final models:
 * community, institutional, new enrollees, and SNP new enrollees.
 *
 * Assumptions about input files:
 *   - both files are sorted by person ID
 *
 *   - person level file has the following variables:
 *     :&IDVAR   - person ID variable (it is a macro parameter, HICNO
 *                 for Medicare data)
 *     :DOB      - date of birth
 *     :SEX      - sex
 *     :OREC     - original reason for entitlement
 *     :MCAID    - Medicaid dummy variable (base year)
 *     :NEMCAID  - Medicaid dummy variable for new enrollees (predicted
 *                 year)
 *
 *   - diagnosis level file has the following vars:
 *     :&IDVAR   - person ID variable (it is a macro parameter, HICNO
 *                 for Medicare data)
 *     :DIAG     - diagnosis
 *
 * The program supplies parameters to a main macro %V1212F1M that calls
 * other external macros:
 *
 *      %AGESEXNV  - create age/sex, originally disabled, disabled vars
 *      %EDITICD9  - perform edits to diagnosis
 *      %V12H70M   - assign one ICD9 to multiple CCs
 *      %V12H70L1  - assign labels to HCCs
 *      %V12H70H   - set HCC=0 according to hierarchies
 *      %SCOREVAR  - calculate a score variable
 *
 *
 * Program steps:
 *         step1: include external macros
 *         step2: define internal macro variables
 *         step3: merge person and diagnosis files outputting one
 *                record per person for each input person level record
 *         step3.1: declaration section
 *         step3.2: bring regression coefficients
 *         step3.3: merge person and diagnosis file
 *         step3.4: for the first record for a person set CC to 0
 *                  and calculate age
 *         step3.5: if there are any diagnoses for a person
 *                  then do the following:
 *                   - create CC using format $I12121Y11Y12YC
 *                   - perform ICD9 edits using macro EDITICD9
 *                   - create additional CC using V12H70M macro
 *         step3.6: for the last record for a person do the
 *                  following:
 *                   - create demographic variables needed
 *                     for regressions (macro AGESEXNV)
 *                   - create HCC using hierarchies (macro V12H70H)
 *                   - create HCC interaction variables
 *                   - create HCC and DISABL interaction variables
 *                   - set HCCs and interaction vars to zero if there
 *                     are no diagnoses for a person
 *                   - create score for community model
 *                   - create score for institutional model
 *                   - create score for new enrollee model
 *                   - create score for SNP new enrollee model
 *                   - normalize score if needed
 *         step4: data checks and proc contents
 *
 *   USER CUSTOMIZATION:
 * A user must supply 2 files with the variables described above and
 * set the following parameters:
 *      INP      - SAS input person dataset
 *      IND      - SAS input diagnosis dataset
 *      OUTDATA  - SAS output dataset
 *      IDVAR    - name of person id variable (HICNO for medicare data)
 *      KEEPVAR  - variables to keep in the output dataset
 *      SEDITS   - a switch that controls whether to perform edits on 
 *                 ICD9. 1-YES, 0-NO
 *      DATE_ASOF- reference date to calculate age. Set to February 1 of 
 *                 the payment year for consistency with CMS. 
 *                 The default value in the code below is 1FEB2012.
 *      FMNAME   - format name (set to I12121Y11Y12YC by default)
 *      DF       - normalization factor (set to 1 by default)
 ***********************************************************************;

 %LET INPUTVARS=%STR(DOB MCAID NEMCAID OREC);

 %*demographic variables;
 %LET DEMVARS  =%STR(AGEF ORIGDS DISABL
                     F0_34  F35_44 F45_54 F55_59 F60_64 F65_69
                     F70_74 F75_79 F80_84 F85_89 F90_94 F95_GT
                     M0_34  M35_44 M45_54 M55_59 M60_64 M65_69
                     M70_74 M75_79 M80_84 M85_89 M90_94 M95_GT
                     NEF0_34  NEF35_44 NEF45_54 NEF55_59 NEF60_64
                     NEF65    NEF66    NEF67    NEF68    NEF69
                     NEF70_74 NEF75_79 NEF80_84 NEF85_89 NEF90_94
                     NEF95_GT
                     NEM0_34  NEM35_44 NEM45_54 NEM55_59 NEM60_64
                     NEM65    NEM66    NEM67    NEM68    NEM69
                     NEM70_74 NEM75_79 NEM80_84 NEM85_89 NEM90_94
                     NEM95_GT);

 %*list of HCCs included in models;
 %LET CMSHCC = %STR(
      HCC1      HCC2      HCC5     HCC7       HCC8
      HCC9      HCC10     HCC15    HCC16      HCC17
      HCC18     HCC19     HCC21    HCC25      HCC26
      HCC27     HCC31     HCC32    HCC33      HCC37
      HCC38     HCC44     HCC45    HCC51      HCC52
      HCC54     HCC55     HCC67    HCC68      HCC69
      HCC70     HCC71     HCC72    HCC73      HCC74
      HCC75     HCC77     HCC78    HCC79      HCC80
      HCC81     HCC82     HCC83    HCC92      HCC95
      HCC96     HCC100    HCC101   HCC104     HCC105
      HCC107    HCC108    HCC111   HCC112     HCC119
      HCC130    HCC131    HCC132   HCC148     HCC149
      HCC150    HCC154    HCC155   HCC157     HCC158
      HCC161    HCC177    HCC164   HCC174     HCC176);

 %*list of CCs that correspond to model HCCs;
 %LET CMSCC = %STR(
      CC1       CC2       CC5      CC7        CC8
      CC9       CC10      CC15     CC16       CC17
      CC18      CC19      CC21     CC25       CC26
      CC27      CC31      CC32     CC33       CC37
      CC38      CC44      CC45     CC51       CC52
      CC54      CC55      CC67     CC68       CC69
      CC70      CC71      CC72     CC73       CC74
      CC75      CC77      CC78     CC79       CC80
      CC81      CC82      CC83     CC92       CC95
      CC96      CC100     CC101    CC104      CC105
      CC107     CC108     CC111    CC112      CC119
      CC130     CC131     CC132    CC148      CC149
      CC150     CC154     CC155    CC157      CC158
      CC161     CC177     CC164    CC174      CC176);

 %LET SCOREVARS=%STR(SCORE_COMMUNITY
                     SCORE_INSTITUTIONAL
                     SCORE_NEW_ENROLLEE
                     SCORE_SNP_NEW_ENROLLEE);

 %* include main macro;
 %INCLUDE IN0(V1212F1M)/SOURCE2;

  %V1212F1M(INP      =IN1.PERSON,
            IND      =IN2.DIAG,
            OUTDATA  =OUT.PERSONOUT,
            IDVAR    =BID_HRS_21,
            KEEPVAR  =BID_HRS_21 &SCOREVARS &DEMVARS 
                      &CMSHCC &CMSCC,
            SEDITS   =1,
            DATE_ASOF="1FEB2012"D);



proc export data=out.personout outfile="E:\data\serious_ill\int_data\hrs_ser_ill_hcc.dta" replace; run;

H="run normal and glm fmms"
clear all
capture log close
set more off
local logpath "E:\data\serious_ill\logs"
local datapath E:\data\serious_ill\final_data
cd `logpath'
use `datapath'\n0_n1_p1_p2_x_criteria_a_death_propensity.dta, clear
gen core_year=core_year_n0
merge 1:1 id core_year using E:\data\hrs_public_2012\dementia\pdem_withvarnames_ebl, keep(match master) nogen

gen ldem_gt50=pdem>=.5 if !missing(pdem)
xtile cd=contact_days_n0, nq(4)
replace cd=cd-1 if cd>2
gen cd_low=cd==1
gen cd_mid=cd==2
gen cd_high=cd==3

gen totplus1_wi_n0=tot_paid_by_mc_12m_wi_n0+1 //new variable amt paid +$1
replace totplus1_wi_n0=1 if totplus1<0
local cvars age_at_core_n0

replace pain_hrs_n0=0 if missing(pain_hrs_n0)

local xvars age_at_core_n0 female re_black re_hisp nw_lowest_n0 ///
smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 ///
srh_pf_n0 adl_impair_core_n0 hlphrs_i_group el_ge3_comorb_1yr_n0 pain_hrs_n0 ///
cd_mid cd_high eol_spending_low ldem_gt50

gen tot2=tot_paid_by_mc_24m_wi_n0-tot_paid_by_mc_12m_wi_n0 if core_to_dod_1yr_n0==0 ///
& core_year_n0<=2010
replace tot_paid_by_mc_12m_wi_n0=1 if tot_paid_by_mc_12m_wi_n0<=0
replace tot_paid_by_mc_12m_wi_n0=tot_paid_by_mc_12m_wi_n0/1000
replace tot2=tot2/1000
replace age_at_core_n0=age_at_core_n0/10

capture log close
log using "FMM_normal_5comp_margins_dem_14.txt", text replace


forvalues i=2/5 {
	fmm `i', startvalues(randomid, seed(123)) emopts(iter(30)) iter(500) lcprob(`xvars'): ///
	regress tot_paid_by_mc_12m_wi_n0
	estimates store estfmm`i'norm
	estimates save estimates/estfmm`i'norm, replace
}
forvalues i=2/5 {
	fmm `i', startvalues(randomid, seed(123)) emopts(iter(30)) iter(500) lcprob(`xvars'): ///
	glm tot_paid_by_mc_12m_wi_n0, link(log) fam(gamma)
	estimates store estfmm`i'lgam
	estimates save estimates/estfmm`i'lgam, replace
}
est stats *


H="table 1s, stata 15"
>clear all
capture log close
set more off
local logpath E:\data\serious_ill\logs
local datapath E:\data\serious_ill\final_data
cd `logpath'
use `datapath'\n0_n1_p1_p2_x_criteria_a_death_propensity.dta, clear
gen core_year=core_year_n0
merge 1:1 id core_year using E:\data\hrs_public_2012\dementia\pdem_withvarnames_ebl, keep(match master) nogen

gen totplus1_wi_n0=tot_paid_by_mc_12m_wi_n0+1 //new variable amt paid +$1
replace totplus1_wi_n0=1 if totplus1<0
local cvars age_at_core_n0
gen ldem_gt50=pdem>=.5 & !missing(pdem)
xtile cd=contact_days_n0, nq(4)
replace cd=cd-1 if cd>2
gen cd_low=cd==1
gen cd_mid=cd==2
gen cd_high=cd==3

local ivars female re_white ///
hs_deg_ind nw_midlow_n0 nw_midhigh_n0 nw_highest_n0 ///
religvimp_n0 srh_pf_n0 rel_nb_n0 married_n0 smi_nh_ind_n0 ///
medicaid_n0 champus_n0 medigap_n0 ///
smi_any_n0 ind_em_ur_adm_12m_n0 ///
adl_impair_core_n0
local region midwest south west eol_spending_mid eol_spending_high

local mvars  smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 ///
smi_liver_ind_n0  smi_hip_ind_n0 /*smi_nh_ind_n0*/ ///
srh_pf_n0 adl_impair_core_n0 hlphrs_i_group el_ge3_comorb_1yr_n0
local nvars age_at_core_n0 female re_black re_hisp ///notwhite ///
hs_deg_ind nw_lowest_n0 ///
religvimp_n0 rel_nb_n0 married_n0 smi_nh_ind_n0 ///
medicaid_n0 champus_n0 medigap_n0

local xvars age_at_core_n0 female re_black re_hisp nw_lowest_n0 ///
smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 ///
srh_pf_n0 adl_impair_core_n0 hlphrs_i_group el_ge3_comorb_1yr_n0 pain_hrs_n0 ///
cd_mid cd_high eol_spending_low ldem_gt50
sum `xvars' `othervars' 
*log using `logpath'\fmm_priors.txt, text replace
/*
forvalues i=2/6 {
qui fmm totplus1_wi_n0, mix(gamma) comp(`i') diff iterate(100)
estimates save `logpath'\est`i', replace
qui fmm totplus1_wi_n0, mix(gamma) comp(`i') prob(`cvars' `ivars' `region') diff iter(100)
estimates save `logpath'\est`i'prior, replace
estimates use est`i'
}

forvalues i=2/7 {
estimates use est`i'
estat ic
}

forvalues i=2/6 {
estimates use est`i'prior
estat ic
}

forvalues i=2/5 {
estimates use est`i'
qui fmm totplus1_wi_n0, mix(gamma) comp(`i') prob(`mvars' `nvars' `region') diff iter(145)
estimates save est`i'prior2, replace
}

forvalues i=2/5 {
di "`i' Comp"
foreach x in "" 2 {
estimates use est`i'prior`x'
estat ic
}
}

log close
*/
estimates use est5
fmm tot_paid_by_mc_12m_wi_n0, prob(`xvars' `othervars' ) mix(normal) comp(5) iterate(100)  
/*estimates save est5_prior, replace

estimates use est5_prior
estimates replay*/
forvalues i=1/5 {
predict priorcomp`i', prior eq(component`i')
predict postcomp`i', posterior eq(component`i')
predict p`i', eq(component`i')
}

gen prior=0 if !missing(priorcomp1)
gen post=0 if !missing(priorcomp1)
forvalues i=1/5 {
replace prior=`i' if priorcomp`i'>=priorcomp1 & priorcomp`i'>=priorcomp2 & priorcomp`i'>=priorcomp3 & priorcomp`i'>=priorcomp4 & priorcomp`i'>=priorcomp5
replace post=`i' if postcomp`i'>=postcomp1 & postcomp`i'>=postcomp2 & postcomp`i'>=postcomp3 & postcomp`i'>=postcomp4 & postcomp`i'>=postcomp5
}

local mvars  smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 ///
smi_liver_ind_n0  smi_hip_ind_n0 /*smi_nh_ind_n0*/ ///
srh_pf_n0 adl_impair_core_n0 hlphrs_i_group el_ge3_comorb_1yr_n0 criteria_b_n0 criteria_c_n0
local nvars age_at_core_n0 female re_black re_hisp ///notwhite ///
hs_deg_ind nw_lowest_n0 ///
religvimp_n0 rel_nb_n0 married_n0 smi_nh_ind_n0 ///
medicaid_n0 champus_n0 medigap_n0 ldem_gt50
local coutcomes tot_paid_by_mc_12m_wi_n0 ip_paid_by_mc_12m_wi_n0 n_hospd_p12m_n0 
local ioutcomes ind_hosp_adm_p12m_n0 mult_ip_adm_p12m_n0 mult_ed_vis_p12m_n0 ind_icu_vis_p12m_n0 ///
hs_admit_p12m_n0 core_to_dod_1yr_n0 loc_hosp_x

gen n=1
replace pain_hrs_n0=0 if missing(pain_hrs_n0)

local xvars age_at_core_n0 female re_black re_hisp nw_lowest_n0 ///
smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 ///
srh_pf_n0 adl_impair_core_n0 hlphrs_i_group el_ge3_comorb_1yr_n0 pain_hrs_n0 ///
cd_mid cd_high eol_spending_low ldem_gt50

local othervars smi_dem_ind_n0 smi_liver_ind_n0  smi_hip_ind_n0 ///
criteria_b_n0 criteria_c_n0 hs_deg_ind religvimp_n0 rel_nb_n0 married_n0 smi_nh_ind_n0 ///
medicaid_n0 champus_n0 medigap_n0 

label var ldem_gt50 "Probability of dementia>.5"
label var core_to_dod_1yr_n0 "Death within one year of interview"
label var cd_mid "Contact Days: Middle 50%"
label var cd_high "Contact Days: Top quartile"
foreach pri in prior post {

local rn : word count `xvars' `othervars' `coutcomes' `ioutcomes' 1 1
local r=1
local c=1


mat tab=J(`rn',12,.)
mat stars=J(`rn',12,0)

foreach i in 1 2 3 4 5 {
foreach x in `xvars' `othervars'  `coutcomes' `ioutcomes' {
	qui sum `x' [aw=`pri'comp`i']
	if !inlist("`x'","age_at_core_n0","tot_paid_by_mc_12m_wi_n0","ip_paid_by_mc_12m_wi_n0","n_hospd_p12m_n0") {
		mat tab[`r',`c']=r(mean)*100
		/*if !inlist("`i'","1") {
			tab `x' comp if inlist(comp,1,`i'), chi2
			mat tab[`r',`c'+1]=r(p)
			mat stars[`r',`c'+1]=(r(p)<.05) + (r(p)<.01)
}*/
}
	else {
		mat tab[`r',`c']=r(mean)
	/*	if !inlist("`i'","1") {
			ttest `x' if inlist(comp,1,`i'), by(comp)
			mat tab[`r',`c'+1]=r(p)
			mat stars[`r',`c'+1]=(r(p)<.05) + (r(p)<.01)
}*/
}
	local r=`r'+1
}
	sum n [aw=`pri'comp`i']
	mat tab[`r',`c']=r(sum_w)
	mat tab[`r'+1,`c']=r(mean)*r(N)
	local r=1
	local c=`c'+2
}

mat rownames tab=`xvars' `othervars'  `coutcomes' `ioutcomes' N(weight) N

frmttable using "FMM_5comp_`pri'_table1.rtf", replace statmat(tab) ///
title("Characteristics,5 comp (weighted by `pri' probability)") ctitles("" "Comp1" "Comp2" "Comp3" ///
"Comp4" "Comp5") ///
 varlabels substat(1) annotate(stars) asymbol(*,**)
	
twoway kdensity postcomp1 || kdensity postcomp2 || kdensity postcomp3 || kdensity postcomp4 || ///
 kdensity postcomp5

twoway kdensity tot_paid_by_mc_12m_wi_n0 if post==1 || kdensity tot_paid_by_mc_12m_wi_n0 if post==2 || kdensity tot_paid_by_mc_12m_wi_n0 if post==3 || kdensity tot_paid_by_mc_12m_wi_n0 if post==4 || ///
 kdensity tot_paid_by_mc_12m_wi_n0 if post==5
 
twoway kdensity priorcomp1 || kdensity priorcomp2 || kdensity priorcomp3 || kdensity priorcomp4 || ///
 kdensity priorcomp5

twoway kdensity tot_paid_by_mc_12m_wi_n0 if prior==1 || kdensity tot_paid_by_mc_12m_wi_n0 if prior==2 || kdensity tot_paid_by_mc_12m_wi_n0 if prior==3 || kdensity tot_paid_by_mc_12m_wi_n0 if prior==4 || ///
 kdensity tot_paid_by_mc_12m_wi_n0 if prior==5
 
gen lntot=ln(tot_paid_by_mc_12m_wi_n0) 
twoway kdensity lntot if prior==1 || kdensity lntot if prior==2 || kdensity lntot if prior==3 || kdensity lntot if prior==4 || ///
 kdensity lntot if prior==5

 twoway kdensity lntot if post==1 || kdensity lntot if post==2 || kdensity lntot if post==3 || kdensity lntot if post==4 || ///
 kdensity lntot if post==5

local rn : word count `xvars' `othervars'  `coutcomes' `ioutcomes' 1
local r=1
local c=1


mat tab=J(`rn',12,.)
mat stars=J(`rn',12,0)

foreach i in 1 2 3 4 5 {
foreach x in `xvars' `othervars'  `coutcomes' `ioutcomes' {
	qui sum `x' if inlist(`pri',`i')
	if !inlist("`x'","age_at_core_n0","tot_paid_by_mc_12m_wi_n0","ip_paid_by_mc_12m_wi_n0","n_hospd_p12m_n0") {
		mat tab[`r',`c']=r(mean)*100
		/*if !inlist("`i'","1") {
			tab `x' comp if inlist(comp,1,`i'), chi2
			mat tab[`r',`c'+1]=r(p)
			mat stars[`r',`c'+1]=(r(p)<.05) + (r(p)<.01)
}*/
}
	else {
		mat tab[`r',`c']=r(mean)
	/*	if !inlist("`i'","1") {
			ttest `x' if inlist(comp,1,`i'), by(comp)
			mat tab[`r',`c'+1]=r(p)
			mat stars[`r',`c'+1]=(r(p)<.05) + (r(p)<.01)
}*/
}
	local r=`r'+1
}
	sum n if `pri'==`i'
	mat tab[`r',`c']=r(N)
	local r=1
	local c=`c'+2
}

mat rownames tab=`xvars' `othervars'  `coutcomes' `ioutcomes' N

frmttable using "FMM_5comp_`pri'_table1.rtf", addtable statmat(tab) ///
title("Characteristics,5 comp (Most likely component, `pri' probability)") ctitles("" "Comp1" "Comp2" "Comp3" ///
"Comp4" "Comp5") ///
 varlabels substat(1) annotate(stars) asymbol(*,**)
}	


H="************************"


H="Predicting spending in out-years"


H="*****************"


H="stata 15 fmm HRS"
clear all
capture log close
set more off
local logpath E:\data\serious_ill\logs
local datapath E:\data\serious_ill\final_data
cd `logpath'
use `datapath'\n0_n1_p1_p2_x_criteria_a_death_propensity.dta, clear
gen core_year=core_year_n0
merge 1:1 id core_year using E:\data\hrs_public_2012\dementia\pdem_withvarnames_ebl, keep(match master) nogen

gen totplus1_wi_n0=tot_paid_by_mc_12m_wi_n0+1 //new variable amt paid +$1
replace totplus1_wi_n0=1 if totplus1<0
local cvars age_at_core_n0
gen ldem_gt50=pdem>=.5 if !missing(pdem)
xtile cd=contact_days_n0, nq(4)
replace cd=cd-1 if cd>2
gen cd_low=cd==1
gen cd_mid=cd==2
gen cd_high=cd==3
gen n=1
replace pain_hrs_n0=0 if missing(pain_hrs_n0)
local ivars female re_white ///
hs_deg_ind nw_midlow_n0 nw_midhigh_n0 nw_highest_n0 ///
religvimp_n0 srh_pf_n0 rel_nb_n0 married_n0 smi_nh_ind_n0 ///
medicaid_n0 champus_n0 medigap_n0 ///
smi_any_n0 ind_em_ur_adm_12m_n0 ///
adl_impair_core_n0
local region midwest south west eol_spending_mid eol_spending_high

local mvars  smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 ///
smi_liver_ind_n0  smi_hip_ind_n0 /*smi_nh_ind_n0*/ ///
srh_pf_n0 adl_impair_core_n0 hlphrs_i_group el_ge3_comorb_1yr_n0
local nvars age_at_core_n0 female re_black re_hisp ///notwhite ///
hs_deg_ind nw_lowest_n0 ///
religvimp_n0 rel_nb_n0 married_n0 smi_nh_ind_n0 ///
medicaid_n0 champus_n0 medigap_n0

log using `logpath'\fmm_5_15_prior_post_ols_pr, replace
local xvars age_at_core_n0 female re_black re_hisp nw_lowest_n0 ///
smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 ///
srh_pf_n0 adl_impair_core_n0 hlphrs_i_group el_ge3_comorb_1yr_n0 pain_hrs_n0 ///
cd_mid cd_high eol_spending_low ldem_gt50 ///smi_dem_ind_n0

sum `xvars' `othervars' 

gen tot2=tot_paid_by_mc_24m_wi_n0-tot_paid_by_mc_12m_wi_n0 if core_to_dod_1yr_n0==0 ///
& core_year_n0<=2010
replace tot_paid_by_mc_12m_wi_n0=tot_paid_by_mc_12m_wi_n0/1000
replace tot2=tot2/1000

reg tot_paid_by_mc_12m_wi_n0 `xvars'
predict preg

forvalues i=2/5 {
	di _n "Classes = `i'"
	/*capture noisily fmm `i', lcprob(`xvars') iter(40) diff: regress tot_paid_by_mc_12m_wi_n0
	if _rc!=0*/ fmm `i', startvalues(randompr, seed(123)) iter(400) lcprob(`xvars') ///
	diff: regress tot_paid_by_mc_12m_wi_n0
	estimates store fmm`i'pr
}
est stats *


local denominator "(1+exp(_b[2.Class:_cons])+exp(_b[3.Class:_cons])+exp(_b[4.Class:_cons])+exp(_b[5.Class:_cons]))"
nlcom (pi1: 1/`denominator') ///
	 (pi2: exp(_b[2.Class:_cons])/`denominator') ///
	 (pi3: exp(_b[3.Class:_cons])/`denominator') ///
	 (pi4: exp(_b[4.Class:_cons])/`denominator') ///
	 (pi5: exp(_b[5.Class:_cons])/`denominator')

predict pfmm, marginal
predict pfmmpost, pmarginal

sum preg pfmm pfmmp tot_paid_by_mc_12m_wi_n0 tot2
reg tot2 preg
reg tot2 pfmm
reg tot2 pfmmpost

centile tot2, centile(99 99.5 99.9)

qplot preg pfmm pfmmpost, xvariable(tot2) ///
	mcolor(green orange ebblue) msymbol(smcircle smcircle smcircle) msize(tiny tiny tiny) ///
	xlabel(0(50)200) ylabel(0(50)200) recast(scatter) ///
	addplot(function y=x, range(0 200) lcolor(gs12)) ///
	legend(order(1 "ols regression" 2 "fmm prior probability weighted" ///
		3 "fmm posterior probability weighted") holes(3) symxsize(*.5)) ///
	xtitle(Expenditures in year 2) ytitle(Predicted expenditures in year 2) ///
	subtitle(Quantile-quantile plots of predicted and actual expenditures) ///
	xsize(8) ysize(6)

graph save HRS_fmm_5_15_prior_post_ols, replace
graph export HRS_fmm_5_15_prior_post_ols.pdf, replace
xtile tot2cat = tot2 , nq(10)
xtile regcat = preg , nq(10)
xtile fmmcat = pfmm , nq(10)
xtile fmmpostcat = pfmmpost , nq(10)

tab regcat tot2cat, row
tab fmmcat tot2cat, row
tab fmmpostcat tot2cat, row


H="stata 15 fmm NHATS"
/*note--as of 11/3/17, can't get to converge on more than 3 components*/


clear all
mata: mata clear
set more off
capture log close
import excel "E:\data\Dartmouth_misc\EOL_mc_2yrs_HRR\DAP_HRR_03_07_to_merge.xls", sheet("Sheet1") firstrow case(lower) clear
keep hrr totalmedic
rename hrr hrr
xtile eol_spending_quintile=tot, nq(5)
xtile eol_spending_quartile=tot, nq(4)
gen eol_spending_3_cat=eol_spending_quartile
replace eol_spending_3_cat=eol_spending_3_cat-1 if inlist(eol_spending_3_cat,3,4)
label define eol_spending_3_cat 1 "Bottome Quartile" 2 "Middle 50%" 3 "Top quartile"
label values eol_spending_3_cat eol_spending_3_cat
gen eol_spending_low=eol_spending_3_cat==1
gen eol_spending_mid=eol_spending_3_cat==2
gen eol_spending_high=eol_spending_3_cat==3
label var eol_spending_low "Bottom Quartile EOL spending by Dartmouth HRR"
label var eol_spending_mid "Middle 50% EOL spending by Dartmouth HRR"
label var eol_spending_high "Top Quartile EOL spending by Dartmouth HRR"
label var eol_spending_3_cat "EOL Spending Group by Dartmouth HRR, Adjusted"
label var eol_spending_quintile "EOL Spending Quintile by Dartmouth HRR, Adjusted"
tab eol_spending_quartile, gen(eol_spend_quart)
label var eol_spend_quart1 "Quartile EOL spending by HRR: Low"
label var eol_spend_quart2 "Quartile EOL spending by HRR: Mid-low"
label var eol_spend_quart3 "Quartile EOL spending by HRR: Mid-high"
label var eol_spend_quart4 "Quartile EOL spending by HRR: High"
tempfile temp1
save "`temp1'"


clear all
capture log close
set more off



local logpath E:\nhats\data\projects\serious_ill\logs
local datapath E:\nhats\data\projects\serious_ill\final_data
cd `logpath'
use `datapath'\serious_ill_nhats_sample.dta, clear
merge m:1 spid using "E:\nhats\data\HRR Codes\NHATS_HRR_xref_R1_R2_STATA\NHATS_Round_1_HRR_xref", ///
gen(hrrmerge) keep(match) 
rename hrrn hrr
merge m:1 hrr using `temp1', keep(match master) gen(dmouthmerge)
merge m:1 spid wave using "E:\nhats\data\NHATS cleaned\sp_round_1_6.dta", nogen ///
keep(match master)
gen totplus1=tot_paid_by_mc_12m+1 //new variable amt paid +$1
replace totplus1=1 if totplus1<0
local cvars age_at_core
keep if criteria_a==1 & wave<=3
sort spid wave
by spid: keep if _n==1
/*xtile cd=contact_days, nq(4)
replace cd=cd-1 if cd>2
gen cd_low=cd==1
gen cd_mid=cd==2
gen cd_high=cd==3*/
gen n=1
*replace pain_hrs=0 if missing(pain_hrs)
local ivars female re_white ///
hs_deg_ind nw_midlow nw_midhigh nw_highest ///
religvimp srh_fp rel_nb married smi_nh_ind ///
medicaid champus medigap ///
smi_any ind_em_ur_adm_12m ///
adl_impair_core
local region midwest south west eol_spending_mid eol_spending_high

local mvars  smi_dem_ind smi_cancer_ind smi_esrd_ind ///
smi_chf_ind smi_copd_ind smi_diab_compl_ind ///
smi_liver_ind  smi_hip_ind /*smi_nh_ind*/ ///
srh_fp adl_impair_core hlphrs_i_group el_ge3_comorb_1yr
local nvars age_at_core female re_black re_hisp ///notwhite ///
hs_deg_ind nw_lowest ///
religvimp rel_nb married smi_nh_ind ///
medicaid champus medigap

log using `logpath'\nhats_fmm_5_15_prior_post_ols_pr, replace
local xvars age_at_core female re_black re_hisp nw_lowest ///
smi_cancer_ind smi_esrd_ind ///
smi_chf_ind smi_copd_ind smi_diab_compl_ind ///
srh_fp adl_impair_core hlphrs_i_group el_ge3_comorb_1yr pain_hrs ///
cd_mid cd_high eol_spending_low ldem_gt50 ///smi_dem_ind

gen sr_hosp_cat=1 if !sr_hosp_ind
replace sr_hosp_cat=2 if sr_hosp_ind==1
replace sr_hosp_cat=3 if sr_hosp_stays==2
replace sr_hosp_cat=4 if sr_hosp_stays>=3 & !missing(sr_hosp_stays)
label define sr_hosp_cat 1 "No hospital stays" 2 "1 hospital stay" 3 "2 stays" ///
4 "3+ stays"
label values sr_hosp_cat

local xvars age female black hisp 1.income_cat ///
smi_cancer_ind smi_esrd_ind smi_chf_ind smi_copd_ind smi_diab_compl_ind ///
srh_fp  adl_impair sr_numconditions1 ind_pain ///
i.sr_hosp_cat eol_spending_low prob_dem


sum `xvars' `othervars' 

gen tot2=tot_paid_by_mc_24m-tot_paid_by_mc_12m if died_12==0 ///
& wave<=2
replace tot_paid_by_mc_12m=tot_paid_by_mc_12m/1000
replace tot2=tot2/1000

reg tot_paid_by_mc_12m `xvars'
predict preg

forvalues i=2/4 {
	di _n "Classes = `i'"
	/*capture noisily fmm `i', lcprob(`xvars') iter(40) diff: regress tot_paid_by_mc_12m
	if _rc!=0*/ fmm `i', startvalues(randompr, seed(123)) iter(50) lcprob(`xvars') ///
	diff: regress tot_paid_by_mc_12m
	estimates store fmm`i'pr
}
est stats *


local denominator "(1+exp(_b[2.Class:_cons])+exp(_b[3.Class:_cons])/*+exp(_b[4.Class:_cons])+exp(_b[5.Class:_cons])*/)"
nlcom (pi1: 1/`denominator') ///
	 (pi2: exp(_b[2.Class:_cons])/`denominator') ///
	 (pi3: exp(_b[3.Class:_cons])/`denominator') ///
	 /*(pi4: exp(_b[4.Class:_cons])/`denominator') ///
	 (pi5: exp(_b[5.Class:_cons])/`denominator')
*/
predict pfmm, marginal
predict pfmmpost, pmarginal

sum preg pfmm pfmmp tot_paid_by_mc_12m tot2
reg tot2 preg
reg tot2 pfmm
reg tot2 pfmmpost

centile tot2, centile(99 99.5 99.9)

qplot preg pfmm pfmmpost, xvariable(tot2) ///
	mcolor(green orange ebblue) msymbol(smcircle smcircle smcircle) msize(tiny tiny tiny) ///
	xlabel(0(50)200) ylabel(0(50)200) recast(scatter) ///
	addplot(function y=x, range(0 200) lcolor(gs12)) ///
	legend(order(1 "ols regression" 2 "fmm prior probability weighted" ///
		3 "fmm posterior probability weighted") holes(3) symxsize(*.5)) ///
	xtitle(Expenditures in year 2) ytitle(Predicted expenditures in year 2) ///
	subtitle(Quantile-quantile plots of predicted and actual expenditures) ///
	xsize(8) ysize(6)


graph save NHATS_3_15_ols_prior_post, replace
graph export NHATS_3_15_ols_prior_post.pdf, replace	

xtile tot2cat = tot2 , nq(10)
xtile regcat = preg , nq(10)
xtile fmmcat = pfmm , nq(10)
xtile fmmpostcat = pfmmpost , nq(10)

tab regcat tot2cat, row
tab fmmcat tot2cat, row
tab fmmpostcat tot2cat, row


H="false dataset fmm"
clear all
set more off
set scheme s1color

local logpath "E:\data\serious_ill\fmm\logs\"
capture log close
capture log using "`logpath'\fmmlog", replace
// capture log close
// log using "C:\Users\bollee01\Desktop\fmm\fmmlog", replace

capture cd "J:\Geriatrics\PCare\HRS Projects\Files HRS server\Evan Bollens-Lund\20171023\"
capture cd "C:\Users\pdeb\Research\FMM-spending"
capture cd "E:\Files to move out\Evan\20171023"

use limited_dataset_with_false_spending.dta

replace age_at_core_n0 = age_at_core_n0/10
replace expend = expend/1000
replace exp2 = exp2/1000
recode comor_c_hrs_n0 (3=2)

local clinivars  cancer_hrs_n0 lung_o2_hrs_n0 chfadmit_hrs_n0 stroke_hrs_n0 /*dm_kidn_hrs_n0*/  ///
hip_frac_hrs_n0 srh_pf_n0 adl_impair_core_n0 i.comor_c_hrs_n0 ldem_gt50 cd_mid cd_high

local demovars age_at_core_n0 female black hisp hlphrs_i_group eol_spending_low

sum `demovars' `clinivars' expend exp2

reg expe `demovars' `clinivars'
predict preg
estimates store reg

forvalues i=2/5 {
di _n "Classes = `i'"
capture noisily fmm `i', lcprob(`demovars' `clinivars') iter(40) diff: regress expend
if _rc!=0 fmm `i', startvalues(randomid, seed(123)) iter(40) lcprob(`demovars' `clinivars') diff: ///
regress expend
estimates store fmm`i'
}

est stats *

local denominator "(1+exp(_b[2.Class:_cons])+exp(_b[3.Class:_cons])+exp(_b[4.Class:_cons])+exp(_b[5.Class:_cons]))"
nlcom (pi1: 1/`denominator') ///
	 (pi2: exp(_b[2.Class:_cons])/`denominator') ///
	 (pi3: exp(_b[3.Class:_cons])/`denominator') ///
	 (pi4: exp(_b[4.Class:_cons])/`denominator') ///
	 (pi5: exp(_b[5.Class:_cons])/`denominator')

predict pfmm, marginal
predict pfmmpost, pmarginal

sum preg pfmm pfmmp expend exp2
reg exp2 preg
reg exp2 pfmm
reg exp2 pfmmpost

centile exp2, centile(99 99.5 99.9)

qplot preg pfmm pfmmpost, xvariable(exp2) ///
	mcolor(green orange ebblue) msymbol(smcircle smcircle smcircle) msize(tiny tiny tiny) ///
	xlabel(0(20)140) ylabel(0(20)140) recast(scatter) ///
	addplot(function y=x, range(0 140) lcolor(gs12)) ///
	legend(order(1 "ols regression" 2 "fmm prior probability weighted" ///
		3 "fmm posterior probability weighted") holes(3) symxsize(*.5)) ///
	xtitle(Expenditures in year 2) ytitle(Predicted expenditures in year 2) ///
	subtitle(Quantile-quantile plots of predicted and actual expenditures) ///
	xsize(8) ysize(6)

xtile totexp2cat = exp2 , nq(10)
xtile regcat = preg , nq(10)
xtile fmmcat = pfmm , nq(10)
xtile fmmpostcat = pfmmpost , nq(10)

tab regcat totexp2cat, row
tab fmmcat totexp2cat, row
tab fmmpostcat totexp2cat, row


H="cutting limited dataset"
clear all
capture log close
set more off
local logpath E:\data\serious_ill\logs
local datapath E:\data\serious_ill\final_data
cd `logpath'
use `datapath'\n0_n1_p1_p2_x_criteria_a_death_propensity.dta, clear
gen core_year=core_year_n0
merge 1:1 id core_year using E:\data\hrs_public_2012\dementia\pdem_withvarnames_ebl, keep(match master) nogen

gen totplus1_wi_n0=tot_paid_by_mc_12m_wi_n0+1 //new variable amt paid +$1
replace totplus1_wi_n0=1 if totplus1<0
local cvars age_at_core_n0
gen ldem_gt50=pdem>=.5 if !missing(pdem)
xtile cd=contact_days_n0, nq(4)
replace cd=cd-1 if cd>2
gen cd_low=cd==1
gen cd_mid=cd==2
gen cd_high=cd==3
gen n=1
replace pain_hrs_n0=0 if missing(pain_hrs_n0)
local ivars female re_white ///
hs_deg_ind nw_midlow_n0 nw_midhigh_n0 nw_highest_n0 ///
religvimp_n0 srh_pf_n0 rel_nb_n0 married_n0 smi_nh_ind_n0 ///
medicaid_n0 champus_n0 medigap_n0 ///
smi_any_n0 ind_em_ur_adm_12m_n0 ///
adl_impair_core_n0
local region midwest south west eol_spending_mid eol_spending_high

local mvars  smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 ///
smi_liver_ind_n0  smi_hip_ind_n0 /*smi_nh_ind_n0*/ ///
srh_pf_n0 adl_impair_core_n0 hlphrs_i_group el_ge3_comorb_1yr_n0
local nvars age_at_core_n0 female re_black re_hisp ///notwhite ///
hs_deg_ind nw_lowest_n0 ///
religvimp_n0 rel_nb_n0 married_n0 smi_nh_ind_n0 ///
medicaid_n0 champus_n0 medigap_n0

local xvars age_at_core_n0 female re_black re_hisp nw_lowest_n0 ///
smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 ///
srh_pf_n0 adl_impair_core_n0 hlphrs_i_group el_ge3_comorb_1yr_n0 pain_hrs_n0 ///
cd_mid cd_high eol_spending_low ldem_gt50
sum `xvars' `othervars' 

local sr cancer_hrs_n0 lung_hrs_n0 chf_hrs_n0 chfadmit_hrs_n0 stroke_hrs_n0 falls_hrs_n0 incont_hrs_n0 pain_hrs_n0 htn_hrs_n0 dm_hrs_n0 psych_hrs_n0 arth_hrs_n0 hip_frac_hrs_n0
local sr2 dm_ins_hrs_n0 dm_kidn_hrs_n0 pain_limit_act_hrs_n0 heart_hrs_n0 ///
lung_lim_hrs_n0 lung_o2_hrs_n0 cancer_treat_hrs_n0 comor*hrs*n0
gen tot2=tot_paid_by_mc_24m_wi_n0-tot_paid_by_mc_12m_wi_n0

replace tot2=. if c_ivw_year_n0>=2011
replace tot2=. if core_to_dod_1yr_n0==1

keep cd `xvars' `sr' `sr2' id tot_paid_by_mc_12m_wi_n0 *adl_index*n0 ///
iadl_independent_core_n0 nw_quartile*_n0 eol_spending_3_cat tot2
label var cd_mid "Middle 50% of healthcare contact days 12m prior to ivw"
label var cd_high "Top 25% of healthcare contact days 12m prior to ivw"
gen white_oth=!re_black & !re_hisp
gen hisp=re_hisp
gen black=re_black
label var white_oth "Non-Hispanic white or other race"
label var black "Non-Hispanic black"
label var hisp "Hispanic"
drop smi* re_* el_ge
drop if missing(ldem)

set seed 042387
gen perm1=rnormal()
set seed 092317
gen perm2=rnormal(1,3)*1000
gen tot=tot_paid
sum tot,d
replace tot=r(p99) if tot>r(p99)
gen expend=tot+perm2-1000
replace expe=exp+2000 if exp<0
replace expend=0 if inrange(exp,-1000,0)
replace expend=-expend-200 if expend<0
gen exp2=tot2
label var exp2 "Falsified Medicare expenditures 12-24m after ivw"
set seed 1
gen perm3=rnormal(1000,300)
sum exp2,d
replace exp2=r(p99) if exp2>r(p99) & !missing(exp2)
replace exp2=exp2+perm3-1000
sort perm1
gen obs_num=_n
save `datapath'\limited_dataset_restricted.dta, replace
drop id tot* perm*
order obs_num
label var obs_num "Unique Identifier"
label var expe "Falsified Medicare expenditures one year after interview"
save `datapath'\limited_dataset_with_false_spending.dta, replace
drop if obs_num>5000
log using "E:\Files to move out\Evan\20171023\limited_ser_ill_dataset_varlist", replace
describe
log close


H="stata 15 fmm HRS GLMs & normals"
clear all
capture log close
set more off
local logpath E:\data\serious_ill\logs
local datapath E:\data\serious_ill\final_data
cd `logpath'
use `datapath'\n0_n1_p1_p2_x_criteria_a_death_propensity.dta, clear
gen core_year=core_year_n0
merge 1:1 id core_year using E:\data\hrs_public_2012\dementia\pdem_withvarnames_ebl, keep(match master) nogen

gen totplus1_wi_n0=tot_paid_by_mc_12m_wi_n0+1 //new variable amt paid +$1
replace totplus1_wi_n0=1 if totplus1<0
local cvars age_at_core_n0
gen ldem_gt50=pdem>=.5 if !missing(pdem)
xtile cd=contact_days_n0, nq(4)
replace cd=cd-1 if cd>2
gen cd_low=cd==1
gen cd_mid=cd==2
gen cd_high=cd==3
gen n=1
replace pain_hrs_n0=0 if missing(pain_hrs_n0)
local ivars female re_white ///
hs_deg_ind nw_midlow_n0 nw_midhigh_n0 nw_highest_n0 ///
religvimp_n0 srh_pf_n0 rel_nb_n0 married_n0 smi_nh_ind_n0 ///
medicaid_n0 champus_n0 medigap_n0 ///
smi_any_n0 ind_em_ur_adm_12m_n0 ///
adl_impair_core_n0
local region midwest south west eol_spending_mid eol_spending_high

local mvars  smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 ///
smi_liver_ind_n0  smi_hip_ind_n0 /*smi_nh_ind_n0*/ ///
srh_pf_n0 adl_impair_core_n0 hlphrs_i_group el_ge3_comorb_1yr_n0
local nvars age_at_core_n0 female re_black re_hisp ///notwhite ///
hs_deg_ind nw_lowest_n0 ///
religvimp_n0 rel_nb_n0 married_n0 smi_nh_ind_n0 ///
medicaid_n0 champus_n0 medigap_n0

log using `logpath'\fmm_5_15_ols_glm, replace
local xvars age_at_core_n0 female re_black re_hisp nw_lowest_n0 ///
smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 ///
srh_pf_n0 adl_impair_core_n0 hlphrs_i_group el_ge3_comorb_1yr_n0 pain_hrs_n0 ///
cd_mid cd_high eol_spending_low ldem_gt50 ///smi_dem_ind_n0

sum `xvars' `othervars' 

gen tot2=tot_paid_by_mc_24m_wi_n0-tot_paid_by_mc_12m_wi_n0 if core_to_dod_1yr_n0==0 ///
& core_year_n0<=2010
replace tot_paid_by_mc_12m_wi_n0=1 if tot_paid_by_mc_12m_wi_n0<=0
replace tot_paid_by_mc_12m_wi_n0=tot_paid_by_mc_12m_wi_n0/1000
replace tot2=tot2/1000
replace age_at_core_n0=age_at_core_n0/10

/*glm tot_paid_by_mc_12m_wi_n0 `xvars', link(log) fam(gamma)
predict preg

forvalues i=2/5 {
	di _n "Classes = `i'"
	/*capture noisily fmm `i', lcprob(`xvars') iter(40) diff: regress tot_paid_by_mc_12m_wi_n0
	if _rc!=0*/ fmm `i', startvalues(randompr, seed(123)) iter(400) lcprob(`xvars') ///
	diff: glm tot_paid_by_mc_12m_wi_n0 `xvars', link(log) fam(gamma)
	estimates store fmm`i'pr
}
est stats *
*/
glm tot_paid_by_mc_12m_wi_n0 `xvars', family(gaussian) link(identity)
est save glmnor, replace
est store glmnor

forvalues j=2/5 {
	di "fmmnorxc `j'"
	fmm `j', startvalues(randomid, seed(123)) emopts(iter(50)) iter(500) lcprob(`xvars'): ///
		glm tot_paid_by_mc_12m_wi_n0, family(gaussian) link(identity)
	est save fmmnorxc`j', replace
	est store fmmnorxc`j'
}
forvalues j=2/5 {
	di "fmmnorcx `j'"
	fmm `j', startvalues(randomid, seed(123)) emopts(iter(50)) iter(500): ///
		glm tot_paid_by_mc_12m_wi_n0 `xvars', family(gaussian) link(identity)
	est save fmmnorcx`j', replace
	est store fmmnorcx`j'
}
forvalues j=2/5 {
	di "fmmnorxx `j'"
	fmm `j', startvalues(randomid, seed(123)) emopts(iter(50)) iter(500) lcprob(`xvars'): ///
		glm tot_paid_by_mc_12m_wi_n0 `xvars', family(gaussian) link(identity)
	est save fmmnorxx`j', replace
	est store fmmnorxx`j'
}

est stats *

glm tot_paid_by_mc_12m_wi_n0 `xvars', family(gamma) link(log)
est save glmgam, replace
est store glmgam

forvalues j=2/5 {
	di "fmmgamxc `j'"
	fmm `j', startvalues(randomid, seed(123)) emopts(iter(50)) iter(500) lcprob(`xvars'): ///
		glm tot_paid_by_mc_12m_wi_n0, family(gamma) link(log)
	est save fmmgamxc`j', replace
	est store fmmgamxc`j'
}
forvalues j=2/5 {
	di "fmmgamcx `j'"
	fmm `j', startvalues(randomid, seed(123)) emopts(iter(50)) iter(500): ///
		glm tot_paid_by_mc_12m_wi_n0 `xvars', family(gamma) link(log)
	est save fmmgamcx`j', replace
	est store fmmgamcx`j'
}
forvalues j=2/5 {
	di "fmmgamxx `j'"
	fmm `j', startvalues(randomid, seed(123)) emopts(iter(50)) iter(500) lcprob(`xvars'): ///
		glm tot_paid_by_mc_12m_wi_n0 `xvars', family(gamma) link(log)
	est save fmmgamxx`j', replace
	est store fmmgamxx`j'
}

est stats *

log close


H="stata 15 fmm postestimation"
clear all
capture log close
set more off
local logpath E:\data\serious_ill\logs
local datapath E:\data\serious_ill\final_data
cd `logpath'
use `datapath'\n0_n1_p1_p2_x_criteria_a_death_propensity.dta, clear
gen core_year=core_year_n0
merge 1:1 id core_year using E:\data\hrs_public_2012\dementia\pdem_withvarnames_ebl, keep(match master) nogen

gen totplus1_wi_n0=tot_paid_by_mc_12m_wi_n0+1 //new variable amt paid +$1
replace totplus1_wi_n0=1 if totplus1<0
local cvars age_at_core_n0
gen ldem_gt50=pdem>=.5 if !missing(pdem)
xtile cd=contact_days_n0, nq(4)
replace cd=cd-1 if cd>2
gen cd_low=cd==1
gen cd_mid=cd==2
gen cd_high=cd==3
gen n=1
replace pain_hrs_n0=0 if missing(pain_hrs_n0)
local ivars female re_white ///
hs_deg_ind nw_midlow_n0 nw_midhigh_n0 nw_highest_n0 ///
religvimp_n0 srh_pf_n0 rel_nb_n0 married_n0 smi_nh_ind_n0 ///
medicaid_n0 champus_n0 medigap_n0 ///
smi_any_n0 ind_em_ur_adm_12m_n0 ///
adl_impair_core_n0
local region midwest south west eol_spending_mid eol_spending_high

local mvars  smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 ///
smi_liver_ind_n0  smi_hip_ind_n0 /*smi_nh_ind_n0*/ ///
srh_pf_n0 adl_impair_core_n0 hlphrs_i_group el_ge3_comorb_1yr_n0
local nvars age_at_core_n0 female re_black re_hisp ///notwhite ///
hs_deg_ind nw_lowest_n0 ///
religvimp_n0 rel_nb_n0 married_n0 smi_nh_ind_n0 ///
medicaid_n0 champus_n0 medigap_n0

log using `logpath'\fmm_5_15_ols_glm_post, replace
local xvars age_at_core_n0 female re_black re_hisp nw_lowest_n0 ///
smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 ///
srh_pf_n0 adl_impair_core_n0 hlphrs_i_group el_ge3_comorb_1yr_n0 pain_hrs_n0 ///
cd_mid cd_high eol_spending_low ldem_gt50 ///smi_dem_ind_n0

sum `xvars' `othervars' 

gen tot2=tot_paid_by_mc_24m_wi_n0-tot_paid_by_mc_12m_wi_n0 if core_to_dod_1yr_n0==0 ///
& core_year_n0<=2010
replace tot_paid_by_mc_12m_wi_n0=1 if tot_paid_by_mc_12m_wi_n0<=0
replace tot_paid_by_mc_12m_wi_n0=tot_paid_by_mc_12m_wi_n0/1000
replace tot2=tot2/1000
replace age_at_core_n0=age_at_core_n0/10

/*glm tot_paid_by_mc_12m_wi_n0 `xvars', link(log) fam(gamma)
predict preg

forvalues i=2/5 {
	di _n "Classes = `i'"
	/*capture noisily fmm `i', lcprob(`xvars') iter(40) diff: regress tot_paid_by_mc_12m_wi_n0
	if _rc!=0*/ fmm `i', startvalues(randompr, seed(123)) iter(400) lcprob(`xvars') ///
	diff: glm tot_paid_by_mc_12m_wi_n0 `xvars', link(log) fam(gamma)
	estimates store fmm`i'pr
}
est stats *
*/
glm tot_paid_by_mc_12m_wi_n0 `xvars', family(gaussian) link(identity)
est save glmnor, replace
est store glmnor
estimates use glmnor
glm
predict pglmnor

glm tot_paid_by_mc_12m_wi_n0 `xvars', family(gamma) link(log)
estimates save glmlgam, replace
est store glmgam
estimates use glmgam
glm
predict pglmgam

estimates use fmmnorxc5
fmm
local denominator "(1+exp(_b[2.Class:_cons])+exp(_b[3.Class:_cons])+exp(_b[4.Class:_cons])+exp(_b[5.Class:_cons]))"
nlcom (pi1: 1/`denominator') ///
	 (pi2: exp(_b[2.Class:_cons])/`denominator') ///
	 (pi3: exp(_b[3.Class:_cons])/`denominator') ///
	 (pi4: exp(_b[4.Class:_cons])/`denominator') ///
	 (pi5: exp(_b[5.Class:_cons])/`denominator')
predict pfmmnor, marginal
predict pfmmnorpost, pmarginal

estimates use fmmgamxc4
fmm
local denominator "(1+exp(_b[2.Class:_cons])+exp(_b[3.Class:_cons])+exp(_b[4.Class:_cons]))" //+exp(_b[5.Class:_cons]))"
nlcom (pi1: 1/`denominator') ///
	 (pi2: exp(_b[2.Class:_cons])/`denominator') ///
	 (pi3: exp(_b[3.Class:_cons])/`denominator') ///
	 (pi4: exp(_b[4.Class:_cons])/`denominator') ///
	// (pi5: exp(_b[5.Class:_cons])/`denominator')
predict pfmmgam, marginal
predict pfmmgampost, pmarginal


sum tot_paid_by_mc_12m_wi_n0,d
foreach v of varlist tot2 pglmnor pglmgam  pfmmnor pfmmgam  pfmmnorpost pfmmgampost {
replace `v' = min(`v',250) if !missing(`v')
_pctile `v', p(90)
gen `v'_90 = `v'>`r(r1)'
}

reg tot2 pglmnor
reg tot2 pfmmnor
reg tot2 pfmmnorpost

reg tot2 pglmgam
reg tot2 pfmmgam
reg tot2 pfmmgampost

tab pglmnor_90 tot2_90, row
tab pglmgam_90 tot2_90, row
tab pfmmnorpost_90 tot2_90, row
tab pfmmgampost_90 tot2_90, row

log close

centile tot2,c(90 95 99 99.5 99.9)
local rc1 `r(c_1)'
local rc2 `r(c_2)'
local rc3 `r(c_3)'
local rc4 `r(c_4)'
local rc5 `r(c_5)'

qplot pglmnor pglmgam pfmmnorpost pfmmgampost, xvariable(tot2) ///
	mcolor(orange*0.5 ebblue*0.5 orange ebblue) ///
	msymbol(smcircle smcircle smcircle smcircle) ///
	msize(tiny tiny tiny tiny) ///
	xaxis(1 2) xlabel(0(50)250,axis(1)) ylabel(0(50)250, angle(horizontal)) ///
	xlabel(`rc1' "90" `rc2' "95" `rc3' "99" `rc4' "99.5" `rc5' "99.9", axis(2)) ///
	addplot(function y=x, range(0 250) lcolor(gs12) ///
		 xline(`rc1' `rc2' `rc3' `rc4' `rc5', lcolor(gs14))) ///
	legend(order(1 "normal" 2 "gamma" 3 "fmm 5-normal" 4 "fmm 4-gamma") ///
		symxsize(*.5) colfirst) ///
	xtitle(Expenditures in year 2, axis(1)) ytitle(Predicted expenditures in year 2) ///
	xtitle(Percentiles of expenditures in year 2, axis(2)) ///
	subtitle(Quantile-quantile plots of predicted and actual expenditures) ///
	scale(0.8) xsize(5.5) ysize(6)

graph export qqplot.pdf, replace

translate fmm_5_15_ols_glm_post.smcl fmm_5_15_ols_glm_post.pdf, replace
/*
!"C:\Program Files\gs\gs9.19\bin\gswin64.exe" -q -dNOPAUSE -dBATCH -sDEVICE=pdfwrite -dAutoRotatePages=/None -sOutputFile=fmm2p.pdf fmm2plog.pdf qqplot.pdf
winexec "C:\Program Files\SumatraPDF\SumatraPDF.exe" fmm2p.pdf
*/
exit


H="stata 15 postestimation II"
clear all
capture log close
set more off
local logpath E:\data\serious_ill\logs
local datapath E:\data\serious_ill\final_data
cd `logpath'
use `datapath'\n0_n1_p1_p2_x_criteria_a_death_propensity.dta, clear
gen core_year=core_year_n0
merge 1:1 id core_year using E:\data\hrs_public_2012\dementia\pdem_withvarnames_ebl, keep(match master) nogen

gen totplus1_wi_n0=tot_paid_by_mc_12m_wi_n0+1 //new variable amt paid +$1
replace totplus1_wi_n0=1 if totplus1<0
local cvars age_at_core_n0
gen ldem_gt50=pdem>=.5 if !missing(pdem)
xtile cd=contact_days_n0, nq(4)
replace cd=cd-1 if cd>2
gen cd_low=cd==1
gen cd_mid=cd==2
gen cd_high=cd==3
gen n=1
replace pain_hrs_n0=0 if missing(pain_hrs_n0)
local ivars female re_white ///
hs_deg_ind nw_midlow_n0 nw_midhigh_n0 nw_highest_n0 ///
religvimp_n0 srh_pf_n0 rel_nb_n0 married_n0 smi_nh_ind_n0 ///
medicaid_n0 champus_n0 medigap_n0 ///
smi_any_n0 ind_em_ur_adm_12m_n0 ///
adl_impair_core_n0
local region midwest south west eol_spending_mid eol_spending_high

local mvars  smi_dem_ind_n0 smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 ///
smi_liver_ind_n0  smi_hip_ind_n0 /*smi_nh_ind_n0*/ ///
srh_pf_n0 adl_impair_core_n0 hlphrs_i_group el_ge3_comorb_1yr_n0
local nvars age_at_core_n0 female re_black re_hisp ///notwhite ///
hs_deg_ind nw_lowest_n0 ///
religvimp_n0 rel_nb_n0 married_n0 smi_nh_ind_n0 ///
medicaid_n0 champus_n0 medigap_n0

log using `logpath'\fmm_5_15_ols_glm_post2, replace
local xvars age_at_core_n0 female re_black re_hisp nw_lowest_n0 ///
smi_cancer_ind_n0 smi_esrd_ind_n0 ///
smi_chf_ind_n0 smi_copd_ind_n0 smi_diab_compl_ind_n0 ///
srh_pf_n0 adl_impair_core_n0 hlphrs_i_group el_ge3_comorb_1yr_n0 pain_hrs_n0 ///
cd_mid cd_high eol_spending_low ldem_gt50 ///smi_dem_ind_n0

sum `xvars' `othervars' 

gen tot2=tot_paid_by_mc_24m_wi_n0-tot_paid_by_mc_12m_wi_n0 if core_to_dod_1yr_n0==0 ///
& core_year_n0<=2010
replace tot_paid_by_mc_12m_wi_n0=1 if tot_paid_by_mc_12m_wi_n0<=0
replace tot_paid_by_mc_12m_wi_n0=tot_paid_by_mc_12m_wi_n0/1000
replace tot2=tot2/1000
replace age_at_core_n0=age_at_core_n0/10

/*glm tot_paid_by_mc_12m_wi_n0 `xvars', link(log) fam(gamma)
predict preg

forvalues i=2/5 {
	di _n "Classes = `i'"
	/*capture noisily fmm `i', lcprob(`xvars') iter(40) diff: regress tot_paid_by_mc_12m_wi_n0
	if _rc!=0*/ fmm `i', startvalues(randompr, seed(123)) iter(400) lcprob(`xvars') ///
	diff: glm tot_paid_by_mc_12m_wi_n0 `xvars', link(log) fam(gamma)
	estimates store fmm`i'pr
}
est stats *
*/
glm tot_paid_by_mc_12m_wi_n0 `xvars', family(gaussian) link(identity)
est save glmnor, replace
est store glmnor
estimates use glmnor
glm
predict pglmnor

glm tot_paid_by_mc_12m_wi_n0 `xvars', family(gamma) link(log)
estimates save glmgam, replace
est store glmgam
estimates use glmgam
glm
predict pglmgam
estimates use fmmnorxc5
fmm
local denominator "(1+exp(_b[2.Class:_cons])+exp(_b[3.Class:_cons])+exp(_b[4.Class:_cons])+exp(_b[5.Class:_cons]))"
nlcom (pi1: 1/`denominator') ///
	 (pi2: exp(_b[2.Class:_cons])/`denominator') ///
	 (pi3: exp(_b[3.Class:_cons])/`denominator') ///
	 (pi4: exp(_b[4.Class:_cons])/`denominator') ///
	 (pi5: exp(_b[5.Class:_cons])/`denominator')
predict pfmmxc, marginal
predict pfmmxcpost, pmarginal

estimates use fmmnorcx5
fmm
local denominator "(1+exp(_b[2.Class:_cons])+exp(_b[3.Class:_cons])+exp(_b[4.Class:_cons])+exp(_b[5.Class:_cons]))"
nlcom (pi1: 1/`denominator') ///
	 (pi2: exp(_b[2.Class:_cons])/`denominator') ///
	 (pi3: exp(_b[3.Class:_cons])/`denominator') ///
	 (pi4: exp(_b[4.Class:_cons])/`denominator') ///
	 (pi5: exp(_b[5.Class:_cons])/`denominator')
predict pfmmcx, marginal
predict pfmmcxpost, pmarginal

estimates use fmmnorxx5
fmm
local denominator "(1+exp(_b[2.Class:_cons])+exp(_b[3.Class:_cons])+exp(_b[4.Class:_cons])+exp(_b[5.Class:_cons]))"
nlcom (pi1: 1/`denominator') ///
	 (pi2: exp(_b[2.Class:_cons])/`denominator') ///
	 (pi3: exp(_b[3.Class:_cons])/`denominator') ///
	 (pi4: exp(_b[4.Class:_cons])/`denominator') ///
	 (pi5: exp(_b[5.Class:_cons])/`denominator')
predict pfmmxx, marginal
predict pfmmxxpost, pmarginal


foreach v of varlist tot2 pfmmxcpost pfmmcxpost pfmmxxpost {
replace `v' = min(`v',250) if !missing(`v')
_pctile `v', p(90)
gen `v'_90 = `v'>`r(r1)'
}

reg tot2 pfmmxcpost
reg tot2 pfmmcxpost
reg tot2 pfmmxxpost

tab pfmmxcpost_90 tot2_90, row
tab pfmmcxpost_90 tot2_90, row
tab pfmmxxpost_90 tot2_90, row

log close

centile tot2,c(90 95 99 99.5 99.9)
local rc1 `r(c_1)'
local rc2 `r(c_2)'
local rc3 `r(c_3)'
local rc4 `r(c_4)'
local rc5 `r(c_5)'


/*
qplot pfmmxcpost pfmmcxpost pfmmxxpost, xvariable(tot2) ///
	mcolor(orange*0.5 ebblue*0.5 orange ebblue) ///
	msymbol(smcircle smcircle smcircle smcircle) ///
	msize(tiny tiny tiny tiny) ///
	xaxis(1 2) xlabel(0(50)250,axis(1)) ylabel(0(50)250, angle(horizontal)) ///
	xlabel(`rc1' "90" `rc2' "95" `rc3' "99" `rc4' "99.5" `rc5' "99.9", axis(2)) ///
	addplot(function y=x, range(0 250) lcolor(gs12) ///
		 xline(`rc1' `rc2' `rc3' `rc4' `rc5', lcolor(gs14))) ///
	legend(order(1 "normal" 2 "gamma" 3 "fmm 5-normal" 4 "fmm 5-gamma") ///
		symxsize(*.5) colfirst) ///
	xtitle(Expenditures in year 2, axis(1)) ytitle(Predicted expenditures in year 2) ///
	xtitle(Percentiles of expenditures in year 2, axis(2)) ///
	subtitle(Quantile-quantile plots of predicted and actual expenditures) ///
	scale(0.8) xsize(5.5) ysize(6)
*/

qplot pfmmxcpost pfmmcxpost pfmmxxpost, xvariable(tot2) ///
	mcolor(orange dkgreen ebblue) ///
	msymbol(smcircle smcircle smcircle) ///
	msize(tiny tiny tiny) ///
	xaxis(1 2) xlabel(0(50)250,axis(1)) ylabel(0(50)250, angle(horizontal)) ///
	xlabel(`rc1' "90" `rc2' "95" `rc3' "99" `rc4' "99.5" `rc5' "99.9", axis(2)) ///
	addplot(function y=x, range(0 250) lcolor(gs12) ///
		 xline(`rc1' `rc2' `rc3' `rc4' `rc5', lcolor(gs14))) ///
	legend(order(1 "fmm 5-lc(X) xb(C)" 2 "fmm 5-lc(C) xb(X)" 3 "fmm 5-lc(X) xb(X)") ///
		symxsize(*.5) colfirst) ///
	xtitle(Expenditures in year 2, axis(1)) ytitle(Predicted expenditures in year 2) ///
	xtitle(Percentiles of expenditures in year 2, axis(2)) ///
	subtitle(Q! plots of predicted and actual expenditures from Normal FMM) ///
	scale(0.8) xsize(5.5) ysize(6)
	
graph export qqplot2.pdf, replace

translate fmm_5_15_ols_glm_post2.smcl fmm_5_15_ols_glm_post2.pdf, replace
/*
!"C:\Program Files\gs\gs9.19\bin\gswin64.exe" -q -dNOPAUSE -dBATCH -sDEVICE=pdfwrite -dAutoRotatePages=/None -sOutputFile=fmm2p.pdf fmm2plog.pdf qqplot.pdf
winexec "C:\Program Files\SumatraPDF\SumatraPDF.exe" fmm2p.pdf
*/
exit
