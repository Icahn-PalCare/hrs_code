= V4 Outline MultiLine NoSorting TabWidth=30

H="Analysis for spouse depression hospice use paper"
/*uses dataset created in spouse_2010.txt code file

compares spousal depression for decedents that used hospice vs those that did not

propensity score match for hospice use, then doubly robust second estimation step
to look at any depression improvement and clinical improvement post death in spouses

Several iterations of the analysis are included in this code under different headings.
A brief description of sections follows (skip to section 20 for JAMA submission Oct. 2014):

4. Sum stats, unmatched: Defines matching variables global for the first set of analyses
Saves dataset used for next section (final_data/spouse_data_sample_v2.dta)

** Next sections, all exclude those with S p1 interview w/i 90 days of R's death
** until noted that it changes in section xx
5. Analysis - S CESD Score Improves post R's death: Treatment = 1+ days hospice use
Sample excludes those with S p1 interview within 90 days of R's death

6. Creates Tables 1 & 2 - Decedent/Spouse Descr Char: Uses matching / sample in previous section
Creates tables of overall sample characteristics before matching, then compares
means before and after matching for Decedent and Spouse characteristics

7. Sub-sample of spouse caregivers - Runs analysis same as above, except
only on subsample of spouses who are primary caregivers
(Treat = 1+ day hospice use, excludes S p1 ivw within 90 days of R's death)

8. Run with subsample interview > 1 year - 
Treatment = 3+ days hospice use, Control = 0 days hospice use
Subsample where Spouse p1 interview > 1 year after R's death
Because of sample restriction, defines new $matchvars2 variable list

9. Helpers, run with subsample interview > 1 year - Same as previous selction
but with subsample of spouse caregivers only
(Treat=3+ days hospice use, Control = 0 days, Spouse p1 interview > 1 year after R's death)
Again need to define new $matchvars2 variable list

10. Analysis - Hospice use >=3d alternate definitions - 
Runs two versions of the ps analysis
1. Treat=3+ days, control = 0 days
2. Treat=7+ days, control = 0 days

11. Analysis - Hospice use 3,7 days, Helpers - Same as previous section
but with subsample of spouse caregivers only
Again, two versions 3+ vs 0 days and 7+ vs 0 days

12. Create bar graph - Bar graph of mean % of sample with improved CES-D
split by hospice and non-hospice groups
Uses weighting to get matched sample from ps match 1+day hospice use 
saved in section 5 above
2 versions of graph, first is just interviews where p1 ivw > 1 year after R's death
second is for full sample

13. OR Plot, Clinical improv and any improv for helpers, timing
Plots of odds ratios from the doubly robust logit regressions for three samples
Treat = 3+ days hospice / Control = 0 days hospice
Uses results saved from sections 10 (full sample), 11 (helpers) and 8 (p1 ivw > 1 year)

14. OR Plot, Rev 2 adding Helper > 1 year
Plot of odds ratios, similar to above but with additional set of OR's included
for the subsample of caregivers with p1 interview > 1 year from R's death

** Note the next 5 sections save log files to the /july2014 subfolder
15. Overall, comp hospice use defs, w/o excluding 1-2, 1-6 day users
Runs ps match for 3 hospice use definitions 
	1. 1+ day vs 0 days
	2. 3+ days vs 0-2 days
	3. 7+ days vs 0-6 days

16. Tables 1&2 - 3 day hospice use treatment
Creates decedent / spouse characteristics tables for both unmatched and matched samples
using the 3+ days vs 0-2 days hospice use definition
Weighting saved from previons section (15)

17. Now do for spouses that are caregivers
Same as step 15, 3 different hospice use definitions, but for caregiver only sub-sample

18. Now for interviews 12m after death, all and caregivers
Hospice use definition: 3+ days vs 0-2 days
Two versions, one whole sample, one just caregivers
Just dyads where Spouse p1 interview 12m or more after R's death

19. Ivws between 3-12m after death, all and caregivers
Same as 18 above, but sample limited to those with p1 interview 3-12m after R's death

** Note the next 5 sections save log files to the /august2014 subfolder
** This is the version used for the JAMA submission in October 2014
20. Allow p1 ivws 0-3m after R's death
Same as section 15 above but includes observations with p1 interviews 0-3m after R's death 
Runs ps match for 3 hospice use definitions 
	1. 1+ day vs 0 days
	2. 3+ days vs 0-2 days
	3. 7+ days vs 0-6 days


*/

H="Define sample "
/*This switches to Stata using data dataset exported in previous section*/

/*Full decedent sample (2002-2010 exit interviews( is restricted to:
1. Decedents with n1 core interview
2. With medicare xwalk id
3. With FFS medicare last 6 months of life
4. Married at time of death
5. With spouse p1 interview

Additional variables to consider for sensitivity analysis:
1. P1 interview within 90 days of R's death
2. R died suddenly as defined by either no comorbidities 12 m before
death or cause of death = accident, suicide, homicide

Added new column for alternative married definition allowing for 
either married or living with partner coded directly from the survey questions

*/

capture log close

clear all
set mem 500m
set more off

//Amy's PC
local logpath E:\data\spouse\logs
local datapath E:\data\spouse\final_data

log using "`logpath'\1-HRS_Spouse_sample.txt", text replace

cd `datapath'

use spouse_data_full.dta

//set matrix for sample size determination table
mat deced_core=J(11,4,.)

//all decedents from 2002-2010 exit interviews
sum r_exit_year_x, detail
mat deced_core[1,1]=r(N)

//check of married decedents
tab r_married_x, missing
label define marital 1 "Married" 2 "Separated" 3 "Divorced" 4 "Widowed" 5 "Never Married" 6 "Other/Don't Know", modify
label values r_marital_x marital
tab r_marital_x, missing

tab r_married_x r_married_or_part_v2, missing
tab r_marital_x r_married_or_part_v2, missing

tab r_female_x s_female_n1 if r_married_or_part_v2==1 & r_married_x==0, missing

gen n1core_ind=.
replace n1core_ind=0 if  r_core_year_n1==.
replace n1core_ind=1 if  r_core_year_n1!=.
tab n1core_ind, missing

tab n1core_ind r_exit_year_x , missing
tab r_core_year_n1 r_exit_year_x , missing

//decedents with n1 core interview
sum r_exit_year_x if n1core_ind==1, detail
mat deced_core[2,1]=r(N)

//decedents with n1 core + xwalk
sum r_exit_year_x if n1core_ind==1 & r_xwalk_yes==1, detail
mat deced_core[3,1]=r(N)

//with ffs mc last 6 months of life
//have parst a and b coverage and no hmo
gen byte ins_ind=.
replace ins_ind=1 if r_part_ab_6m==1 & r_hmo_d_6m==0
replace ins_ind=0 if r_part_ab_6m!=1 | r_hmo_d_6m!=0
tab ins_ind, missing

//decedents with n1 core + xwalk + ffs mc last 6 months of life
sum r_exit_year_x if n1core_ind==1 & r_xwalk_yes==1 & ins_ind==1, detail
mat deced_core[4,1]=r(N)

//decedents with n1 core + xwalk + married
//who meets core, xwalk but marital status conflict??
tab r_married_x r_married_or_part_v2 if n1core_ind==1 & r_xwalk_yes==1 & ins_ind==1, missing
foreach y in 2002 2004 2006 2008 2010{
tab r_married_x r_married_or_part_v2 if r_exit_year_x==`y' & n1core_ind==1 & r_xwalk_yes==1 & ins_ind==1, missing
}

sum r_exit_year_x if n1core_ind==1 & r_xwalk_yes==1 & ins_ind==1 &  r_married_x==1, detail
mat deced_core[5,1]=r(N)

sum r_exit_year_x if n1core_ind==1 & r_xwalk_yes==1 & ins_ind==1 &  r_married_or_part_v2_x==1, detail
mat deced_core[5,4]=r(N)

//have spouse p1 interview
gen byte sp1core_ind=.
replace sp1core_ind=0 if s_core_year_p1==.
replace sp1core_ind=1 if s_core_year_p1!=.
tab sp1core_ind, missing
tab sp1core_ind r_exit_year_x , missing
tab s_core_year_p1 r_exit_year_x , missing

//decedents with n1 core + xwalk + married + spouse p1 interview
sum r_exit_year_x if n1core_ind==1 & r_xwalk_yes==1 & ins_ind==1 &  r_married_x==1 & sp1core_ind==1, detail
mat deced_core[6,1]=r(N)

sum r_exit_year_x if n1core_ind==1 & r_xwalk_yes==1 & ins_ind==1 &  r_married_or_part_v2_x==1 & sp1core_ind==1, detail
mat deced_core[6,4]=r(N)

//have spouse n1 interview
gen byte sn1core_ind=.
replace sn1core_ind=0 if s_core_year_n1==.
replace sn1core_ind=1 if s_core_year_n1!=.
tab sn1core_ind, missing
tab sn1core_ind r_exit_year_x , missing
tab s_core_year_n1 r_exit_year_x , missing

//decedents with n1 core + xwalk + married + spouse p1 and n1 interview
sum r_exit_year_x if n1core_ind==1 & r_xwalk_yes==1 & ins_ind==1 &  r_married_x==1 & sp1core_ind==1 & sn1core_ind==1, detail
mat deced_core[7,1]=r(N)

sum r_exit_year_x if n1core_ind==1 & r_xwalk_yes==1 & ins_ind==1 &  r_married_or_part_v2_x==1 & sp1core_ind==1 & sn1core_ind==1, detail
mat deced_core[7,4]=r(N)

//p1 interview within 30, 90 days of r's death
gen days_p1_core_dead =  s_c_ivw_date_p1 -  r_death_date_e
gen p1_wi_90d = .
replace p1_wi_90d=1 if days_p1_core_dead<=90
replace p1_wi_90d=0 if (days_p1_core_dead>90 & days_p1_core_dead!=.)
la var p1_wi_90d "p1 interview w/i 90 days r death"
tab p1_wi_90d, missing

gen p1_wi_30d = .
replace p1_wi_30d=1 if days_p1_core_dead<=30
replace p1_wi_30d=0 if (days_p1_core_dead>30 & days_p1_core_dead!=.)
la var p1_wi_30d "p1 interview w/i 30 days r death"
tab p1_wi_30d, missing

//decedents with n1 core + xwalk + married + spouse p1 interview + p1 > 90 days post death
sum r_exit_year_x if n1core_ind==1 & r_xwalk_yes==1 & ins_ind==1 &  r_married_x==1 & /// 
sp1core_ind==1 & sn1core_ind==1 & p1_wi_90d==0, detail
mat deced_core[8,1]=r(N)

sum r_exit_year_x if n1core_ind==1 & r_xwalk_yes==1 & ins_ind==1 &  r_married_or_part_v2_x==1 & /// 
sp1core_ind==1 & sn1core_ind==1 & p1_wi_90d==0, detail
mat deced_core[8,4]=r(N)

//no comorbidities
gen byte no_el_comorb_12m = .
replace no_el_comorb_12m =1 if comorb_all_0d_n12m==0
replace no_el_comorb_12m =0 if (comorb_all_0d_n12m>0 & comorb_all_0d_n12m!=.)
la var no_el_comorb_12m "Ind. for no Elix comorb 12m before death"
tab no_el_comorb_12m , missing

//what about no chronic conditions?
gen cc_all_count_12m = cc_1_ami_n12mn0 + cc_2_alzh_n12mn0 + cc_3_alzhdmta_n12mn0 + ///
cc_4_atrialfb_n12mn0 + cc_5_cataract_n12mn0 + cc_6_chrnkidn_n12mn0 + ///
cc_7_copd_n12mn0 + cc_8_chf_n12mn0 + cc_9_diabetes_n12mn0 + cc_10_glaucoma_n12mn0 + ///
cc_11_hipfrac_n12mn0 + cc_12_ischmcht_n12mn0 + cc_13_depressn_n12mn0 + ///
cc_14_osteoprs_n12mn0 + cc_15_ra_oa_n12mn0 + cc_16_strketia_n12mn0 + ///
cc_17_cncrbrst_n12mn0 + cc_18_cncrclrc_n12mn0 + cc_19_cncrprst_n12mn0 + ///
cc_20_cncrlung_n12mn0 + cc_21_cncrendm_n12mn0

tab cc_all_count_12m, missing

//cc's excluding cataract and glaucoma
gen cc_all_count_12m_2 = cc_1_ami_n12mn0 + cc_2_alzh_n12mn0 + cc_3_alzhdmta_n12mn0 + ///
cc_4_atrialfb_n12mn0 + /*cc_5_cataract_n12mn0 +*/ cc_6_chrnkidn_n12mn0 + ///
cc_7_copd_n12mn0 + cc_8_chf_n12mn0 + cc_9_diabetes_n12mn0 + /*cc_10_glaucoma_n12mn0 +*/ ///
cc_11_hipfrac_n12mn0 + cc_12_ischmcht_n12mn0 + cc_13_depressn_n12mn0 + ///
cc_14_osteoprs_n12mn0 + cc_15_ra_oa_n12mn0 + cc_16_strketia_n12mn0 + ///
cc_17_cncrbrst_n12mn0 + cc_18_cncrclrc_n12mn0 + cc_19_cncrprst_n12mn0 + ///
cc_20_cncrlung_n12mn0 + cc_21_cncrendm_n12mn0
la var cc_all_count_12m_2 "Count of cc's, excludes cataract and glaucoma"

tab cc_all_count_12m_2, missing

tab cc_all_count_12m cc_all_count_12m_2, missing

gen byte no_cc_12m = .
replace no_cc_12m =1 if cc_all_count_12m ==0
replace no_cc_12m =0 if (cc_all_count_12m >0 & cc_all_count_12m !=.)
la var no_cc_12m "Ind. for no Chronic conditions 12m before death"
tab no_cc_12m , missing

gen byte no_cc_12m_excl_cataract = .
replace no_cc_12m_excl_cataract =1 if cc_all_count_12m_2==0
replace no_cc_12m_excl_cataract =0 if (cc_all_count_12m_2>0 & cc_all_count_12m_2!=.)
la var no_cc_12m_excl_cataract "Ind. for no Chronic conditions 12m before death"
tab no_cc_12m_excl_cataract , missing


//cell using elixhauser
//decedents with n1 core + xwalk + married + spouse p1 interview + p1 > 90 days post death
sum r_exit_year_x if n1core_ind==1 & r_xwalk_yes==1 & ins_ind==1 &  r_married_x==1 & /// 
sp1core_ind==1 & sn1core_ind==1 & p1_wi_90d==0 & no_el_comorb_12m==0, detail
mat deced_core[9,1]=r(N)

//cell using chronic conditions
//decedents with n1 core + xwalk + married + spouse p1 interview + p1 > 90 days post death
sum r_exit_year_x if n1core_ind==1 & r_xwalk_yes==1 & ins_ind==1 &  r_married_x==1 & /// 
sp1core_ind==1 & sn1core_ind==1 & p1_wi_90d==0 & no_cc_12m==0, detail
mat deced_core[9,2]=r(N)

//cell using chronic conditions, v2 excluding cataract and glaucoma
//decedents with n1 core + xwalk + married + spouse p1 interview + p1 > 90 days post death
sum r_exit_year_x if n1core_ind==1 & r_xwalk_yes==1 & ins_ind==1 &  r_married_x==1 & /// 
sp1core_ind==1 & sn1core_ind==1 & p1_wi_90d==0 & no_cc_12m_excl_cataract==0, detail
mat deced_core[9,3]=r(N)

sum r_exit_year_x if n1core_ind==1 & r_xwalk_yes==1 & ins_ind==1 &  r_married_or_part_v2_x==1 & /// 
sp1core_ind==1 & sn1core_ind==1 & p1_wi_90d==0 & no_cc_12m_excl_cataract==0, detail
mat deced_core[9,4]=r(N)

//cause of death = Accidents, Suicide, Homicide (var = 12)
tab r_cause_death_12_n_e, missing
replace r_cause_death_12_n_e=. if r_cause_death_12_n_e==14
gen byte sudden_cause_death = .
replace sudden_cause_death =1 if r_cause_death_12_n_e==12
replace sudden_cause_death =0 if (r_cause_death_12_n_e!=12 & r_cause_death_12_n_e!=.)
la var sudden_cause_death "Cause of death = accidents, suicide, homicide"
tab sudden_cause_death, missing

//using elixhauser
//decedents with n1 core + xwalk + married + spouse p1 interview + p1 > 90 days post death
sum r_exit_year_x if n1core_ind==1 & r_xwalk_yes==1 & ins_ind==1 &  r_married_x==1 & /// 
sp1core_ind==1 & sn1core_ind==1 & p1_wi_90d==0 & no_el_comorb_12m==0 & sudden_cause_death==0, detail
mat deced_core[10,1]=r(N)

//using ccs
//decedents with n1 core + xwalk + married + spouse p1 interview + p1 > 90 days post death
sum r_exit_year_x if n1core_ind==1 & r_xwalk_yes==1 & ins_ind==1 &  r_married_x==1 & /// 
sp1core_ind==1 & sn1core_ind==1 & p1_wi_90d==0 & no_cc_12m==0 & sudden_cause_death==0, detail
mat deced_core[10,2]=r(N)

//using ccs v2
//decedents with n1 core + xwalk + married + spouse p1 interview + p1 > 90 days post death
sum r_exit_year_x if n1core_ind==1 & r_xwalk_yes==1 & ins_ind==1 &  r_married_x==1 & /// 
sp1core_ind==1 & sn1core_ind==1 & p1_wi_90d==0 & no_cc_12m_excl_cataract==0 & sudden_cause_death==0, detail
mat deced_core[10,3]=r(N)

sum r_exit_year_x if n1core_ind==1 & r_xwalk_yes==1 & ins_ind==1 &  r_married_or_part_v2_x==1 & /// 
sp1core_ind==1 & sn1core_ind==1 & p1_wi_90d==0 & no_cc_12m_excl_cataract==0 & sudden_cause_death==0, detail
mat deced_core[10,4]=r(N)

//full n1 p1 cesd interview?
gen byte cesd_miss_n1 = 0
replace cesd_miss_n1 =1 if s_cesd_tot_n1==.
gen byte cesd_miss_p1 = 0
replace cesd_miss_p1 =1 if s_cesd_tot_p1==.
tab cesd_miss_n1 cesd_miss_p1 , missing
gen byte cesd_miss_n1_p1 = 0
replace cesd_miss_n1_p1 =1 if cesd_miss_n1==1 | cesd_miss_p1 ==1
la var cesd_miss_n1_p1 "CESD missing either n1 or p1"
tab cesd_miss_n1_p1 , missing

//using elixhauser
//decedents with n1 core + xwalk + married + spouse p1 interview + p1 > 90 days post death
sum r_exit_year_x if n1core_ind==1 & r_xwalk_yes==1 & ins_ind==1 &  r_married_x==1 & /// 
sp1core_ind==1 & sn1core_ind==1 & p1_wi_90d==0 & no_el_comorb_12m==0 & sudden_cause_death==0 & cesd_miss_n1_p1==0, detail
mat deced_core[11,1]=r(N)

//using ccs
//decedents with n1 core + xwalk + married + spouse p1 interview + p1 > 90 days post death
sum r_exit_year_x if n1core_ind==1 & r_xwalk_yes==1 & ins_ind==1 &  r_married_x==1 & /// 
sp1core_ind==1 & sn1core_ind==1 & p1_wi_90d==0 & no_cc_12m==0 & sudden_cause_death==0 & cesd_miss_n1_p1==0, detail
mat deced_core[11,2]=r(N)

//using ccs v2
//decedents with n1 core + xwalk + married + spouse p1 interview + p1 > 90 days post death
sum r_exit_year_x if n1core_ind==1 & r_xwalk_yes==1 & ins_ind==1 &  r_married_x==1 & /// 
sp1core_ind==1 & sn1core_ind==1 & p1_wi_90d==0 & no_cc_12m_excl_cataract==0 & sudden_cause_death==0 & cesd_miss_n1_p1==0, detail
mat deced_core[11,3]=r(N)

sum r_exit_year_x if n1core_ind==1 & r_xwalk_yes==1 & ins_ind==1 &  r_married_or_part_v2_x==1 & /// 
sp1core_ind==1 & sn1core_ind==1 & p1_wi_90d==0 & no_cc_12m_excl_cataract==0 & sudden_cause_death==0 & cesd_miss_n1_p1==0, detail
mat deced_core[11,4]=r(N)

mat list deced_core
	
frmttable using `logpath'\2010_sample_est , statmat(deced_core) ///
	title("2010 sample size estimate - requiring an n1 core interview") ///
	ctitle("","Elix - n","CCs - n", "CC, no cataract, glaucoma","Married or Partnered") ///
	rtitle("All decedents from exit interviews" \ "With n1 core interview" \ ///
	"With mc xwalk id" \ "With FFS mc last 6 months of life" \ "Married at time of death" \ ///
	"Spouse p1 core interview" \"Spouse n1 core interview" \ "p1 ivw 90+ days from r's death" \ ///
	"No comorb 12m before death" \ "Accidents, Suicide, Homicide = cause of death" \ ///
	"Full CESD interview n1 and p1") ///
	sdec(0) replace


tab r_exit_year_x if n1core_ind==1 & r_xwalk_yes==1 & ins_ind==1 & r_married_x==1 & sp1core_ind==1 & sn1core_ind==1
**************************************************
//Another version of the sample table, dropping where ivw < 90 days last
//revised to split up causes of missing cesd score (proxy or just missing)
mat samp2=J(12,2,.)

forvalues i = 1/7{
mat samp2[`i',1]=deced_core[`i',1]
mat samp2[`i',2]=deced_core[`i',4]
}

//cell using chronic conditions, v2 excluding cataract and glaucoma
//decedents with n1 core + xwalk + married + spouse p1 interview 
sum r_exit_year_x if n1core_ind==1 & r_xwalk_yes==1 & ins_ind==1 &  r_married_x==1 & /// 
sp1core_ind==1 & sn1core_ind==1 & no_cc_12m_excl_cataract==0, detail
mat samp2[8,1]=r(N)

sum r_exit_year_x if n1core_ind==1 & r_xwalk_yes==1 & ins_ind==1 &  r_married_or_part_v2_x==1 & /// 
sp1core_ind==1 & sn1core_ind==1 & no_cc_12m_excl_cataract==0, detail
mat samp2[8,2]=r(N)

//using ccs v2, excluding sudden cause of death
//decedents with n1 core + xwalk + married + spouse p1 interview 
sum r_exit_year_x if n1core_ind==1 & r_xwalk_yes==1 & ins_ind==1 &  r_married_x==1 & /// 
sp1core_ind==1 & sn1core_ind==1 & no_cc_12m_excl_cataract==0 & sudden_cause_death==0, detail
mat samp2[9,1]=r(N)

sum r_exit_year_x if n1core_ind==1 & r_xwalk_yes==1 & ins_ind==1 &  r_married_or_part_v2_x==1 & /// 
sp1core_ind==1 & sn1core_ind==1 & no_cc_12m_excl_cataract==0 & sudden_cause_death==0, detail
mat samp2[9,2]=r(N)

gen byte proxy_n1_or_p1 = 0
replace proxy_n1_or_p1 =1 if s_proxy_core_p1==1 | s_proxy_core_n1==1

tab proxy_n1_or_p1 cesd_miss_n1_p1 if n1core_ind==1 & r_xwalk_yes==1 & ins_ind==1 &  r_married_x==1 & /// 
sp1core_ind==1 & sn1core_ind==1 & no_cc_12m_excl_cataract==0 & sudden_cause_death==0, missing

//missing cesd b/c proxy interview - so not asked
sum r_exit_year_x if n1core_ind==1 & r_xwalk_yes==1 & ins_ind==1 &  r_married_x==1 & /// 
sp1core_ind==1 & sn1core_ind==1 & no_cc_12m_excl_cataract==0 & sudden_cause_death==0 & ///
proxy_n1_or_p1==0, detail
mat samp2[10,1]=r(N)

sum r_exit_year_x if n1core_ind==1 & r_xwalk_yes==1 & ins_ind==1 &  r_married_or_part_v2_x==1 & /// 
sp1core_ind==1 & sn1core_ind==1 & no_cc_12m_excl_cataract==0 & sudden_cause_death==0 & ///
proxy_n1_or_p1==0, detail
mat samp2[10,2]=r(N)

//using ccs v2
//decedents with n1 core + xwalk + married + spouse p1 interview 
sum r_exit_year_x if n1core_ind==1 & r_xwalk_yes==1 & ins_ind==1 &  r_married_x==1 & /// 
sp1core_ind==1 & sn1core_ind==1 & no_cc_12m_excl_cataract==0 & sudden_cause_death==0 & ///
proxy_n1_or_p1==0 & cesd_miss_n1_p1==0, detail
mat samp2[11,1]=r(N)

sum r_exit_year_x if n1core_ind==1 & r_xwalk_yes==1 & ins_ind==1 &  r_married_or_part_v2_x==1 & /// 
sp1core_ind==1 & sn1core_ind==1 & no_cc_12m_excl_cataract==0 & sudden_cause_death==0 & ///
proxy_n1_or_p1==0 & cesd_miss_n1_p1==0, detail
mat samp2[11,2]=r(N)

//decedents with n1 core + xwalk + married + spouse p1 interview + p1 > 90 days post death
sum r_exit_year_x if n1core_ind==1 & r_xwalk_yes==1 & ins_ind==1 &  r_married_x==1 & /// 
sp1core_ind==1 & sn1core_ind==1 & no_cc_12m_excl_cataract==0 ///
& sudden_cause_death==0 & cesd_miss_n1_p1==0 & p1_wi_90d==0, detail
mat samp2[12,1]=r(N)

sum r_exit_year_x if n1core_ind==1 & r_xwalk_yes==1 & ins_ind==1 &  r_married_or_part_v2_x==1 & /// 
sp1core_ind==1 & sn1core_ind==1 & no_cc_12m_excl_cataract==0 ///
& sudden_cause_death==0 & cesd_miss_n1_p1==0 & p1_wi_90d==0, detail
mat samp2[12,2]=r(N)

frmttable using `logpath'\2010_sample_est , statmat(samp2) ///
	title("v2 2010 sample size estimate - requiring an n1 core interview") ///
	ctitle("", "CC, no cataract, glaucoma - n","Married or live w partner") ///
	rtitle("All decedents from exit interviews" \ "With n1 core interview" \ ///
	"With mc xwalk id" \ "With FFS mc last 6 months of life" \ "Married at time of death" \ ///
	"Spouse p1 core interview" \"Spouse n1 core interview"  \ ///
	"No comorb 12m before death" \ "Accidents, Suicide, Homicide = cause of death" \ ///
	"Not Proxy n1 or p1 s interview" \ "Full CESD interview n1 and p1" \ ///
	"p1 ivw 90+ days from r's death") ///
	sdec(0) addtable
**************************************************
//save a version of this dataset with the sample criteria variables created prior to dropping
//observations that don't meet the criteria
save  spouse_data_full_v1.dta, replace

**************************************************
//who are the observations that are dropped b/c of the choice of marital status variable??
preserve

keep if n1core_ind==1 & r_xwalk_yes==1 & ins_ind==1 &  r_married_or_part_v2_x==1 & /// 
sp1core_ind==1 & sn1core_ind==1 & no_cc_12m_excl_cataract==0 & sudden_cause_death==0 & ///
proxy_n1_or_p1==0 & cesd_miss_n1_p1==0

tab r_married_x, missing

tab r_female_x s_female_n1 if r_married_x==0, missing
tab r_married_n1 if r_married_x==0, missing

restore	
	
**************************************************
/*drop observations not in the sample*/
drop if n1core_ind==0
drop if r_xwalk_yes==0
drop if ins_ind==0 
drop if r_married_x==0 
drop if sp1core_ind==0
drop if sn1core_ind==0

tab r_exit_year_x r_core_year_n1

la def r_cause_death_12_n_e 1 "Infectious disease" 2 "HIV/AIDS" ///
3 "Cardiovascular disease" 4 "Chronic lower respiratory disease" ///
5 "Other Respiratory disease" 6 "Diabetes" 7 "Alzheimers Disease" ///
9 "Neoplasms" 10 "Kidney Disease (not infectious)" ///
11 "Liver, Gallbladder, Stomach and/or Intestinal disease" ///
12 "Accidents, Suicide, Homicide" 13 "Other"

la val r_cause_death_12_n_e r_cause_death_12_n_e
tab r_cause_death_12_n_e, missing

***********************************************************
***********************************************************
//second table looking at spouse missing cesd data
***********************************************************
***********************************************************
mat cesd_miss=J(4,4,.)
mat cesd_miss[1,1]=deced_core[10,1] //sample w/ p1>90d, no sudden death restriction added

tab cesd_miss_n1 if (p1_wi_90d==0 & no_el_comorb_12m==0 & ///
 sudden_cause_death==0), missing matcell(cesdtab1)

mat cesd_miss[2,1]=cesdtab1[2,1] //overall missing count n1 cesd

tab cesd_miss_n1 s_proxy_core_n1 if (p1_wi_90d==0 & no_el_comorb_12m==0 & ///
 sudden_cause_death==0), missing matcell(cesdtab2)

mat cesd_miss[2,2]=cesdtab2[2,1] //missing s n1 cesd but no proxy
mat cesd_miss[2,3]=cesdtab2[2,2] //missing s n1 cesd b/c of proxy ivw

tab cesd_miss_p1 if (p1_wi_90d==0 & no_el_comorb_12m==0 & ///
 sudden_cause_death==0), missing matcell(cesdtab3)

mat cesd_miss[3,1]=cesdtab3[2,1] //overall missing count p1 cesd

tab cesd_miss_p1 s_proxy_core_p1 if (p1_wi_90d==0 & no_el_comorb_12m==0 & ///
 sudden_cause_death==0), missing matcell(cesdtab4)

mat cesd_miss[3,2]=cesdtab4[2,1] //missing s p1 cesd but no proxy
mat cesd_miss[3,3]=cesdtab4[2,2] //missing s p1 cesd b/c of proxy ivw

gen byte cesd_miss_n1p1 = 0
replace cesd_miss_n1p1 = 1 if cesd_miss_n1==1 | cesd_miss_p1==1 
tab cesd_miss_n1p1 , missing

//moved above
//gen byte proxy_n1_or_p1 = 0
//replace proxy_n1_or_p1 =1 if s_proxy_core_p1==1 | s_proxy_core_n1==1

gen byte proxy_n1_and_p1 = 0
replace proxy_n1_and_p1 =1 if s_proxy_core_p1==1 & s_proxy_core_n1==1

tab cesd_miss_n1p1 if (p1_wi_90d==0 & no_el_comorb_12m==0 & ///
 sudden_cause_death==0), missing matcell(cesdtab5)

mat cesd_miss[4,1]=cesdtab5[2,1] //overall missing count p1 or n1 cesd

tab cesd_miss_n1p1 proxy_n1_or_p1 if (p1_wi_90d==0 & no_el_comorb_12m==0 & ///
 sudden_cause_death==0), missing matcell(cesdtab6)

mat cesd_miss[4,2]=cesdtab6[2,1] //missing both n1 p1 no proxy

tab cesd_miss_n1p1 proxy_n1_and_p1 if (p1_wi_90d==0 & no_el_comorb_12m==0 & ///
 sudden_cause_death==0), missing matcell(cesdtab7)

mat cesd_miss[4,4]=cesdtab7[2,2] //both n1 p1 no proxy

mat cesd_miss[4,3]=(cesd_miss[4,1] - cesd_miss[4,2] - cesd_miss[4,4] ) //either n1 or p1 proxy, but not both

mat list cesd_miss

frmttable using `logpath'\2010_sample_est , statmat(cesd_miss) ///
	title("Spouse CESD N1 and P1 missing-ness") ///
	ctitle("","overall n","missing, no proxy","proxy interview","") ///
	rtitle("Overall sample" \ "Missing n1 CESD score" \ ///
	"Missing p1 CESD score" \ "Missing either n1 or p1 CESD") ///
	sdec(0) addtable

save spouse_data_sample.dta, replace
**************************************************
log close



H="Perform variable cleaning on the sample"
/*perform variable cleaning and generation on the sample as defined as
decedents with
	1. r's n1 core interview
	2. r's mc xwalk id
	3. FFS mc in last 6 months of life
	4. married at time of death
	5. spouse n1 and p1 core interview
*/

capture log close

clear all
set mem 500m
set more off

//Amy's PC
local logpath E:\data\spouse\logs
local datapath E:\data\spouse\final_data

log using "`logpath'\2-HRS_Spouse_var_cleaning.txt", text replace

cd `datapath'

use spouse_data_sample.dta

//fill in missing gender for spouse gender variable
tab s_female, missing
//use spouse p1 interview to fill in missing gender
replace s_female=s_female_p1 if s_female==.
la var s_female "S Female"
la def fem 0 "Male" 1 "Female"
la val s_female r_female fem
tab s_female, missing

//code r-education variable using all interview information where
//there are no conflicts to try and avoid missingness when
//when use n1 and n2 core, still have lots of missing obs for 2010 decedents
//so brought in n3 core education variable to go back to 2004
gen r_educ = r_educ_n1
replace r_educ = r_educ_n2 if (r_educ_n1==.)
replace r_educ = r_educ_n3 if (r_educ_n1==. & r_educ_n2==.)
label variable r_educ "R's Eduction, Highest Level, imputed from all interviews"
label define r_educ 0 "No Formal Education" 1 "Grades 1-11" 2 "High School" 3 "Some College" 4 "College" ///
      5 "Post College", modify
label values r_educ r_educ 
tab r_educ, missing

//create r hs degree variable
gen byte r_hseduc_n1_n3 = .
replace r_hseduc_n1_n3=0 if inlist(r_educ,0,1)
replace r_hseduc_n1_n3=1 if inlist(r_educ,2,3,4,5)
la var r_hseduc_n1_n3 "HS Degree using n1-n3 core, 1=yes"
tab r_hseduc_n1_n3, missing

//code s-education variable using all interview information where
//there are no conflicts to try and avoid missingness when
//when use n1 and n2 core, still have lots of missing obs for 2010 decedents
//so brought in n3 core education variable to go back to 2004
gen s_educ = s_educ_n1
replace s_educ = s_educ_n2 if (s_educ_n1==.)
replace s_educ = s_educ_n3 if (s_educ_n1==. & s_educ_n2==.)
label variable s_educ "S's Eduction, Highest Level, imputed from all interviews"
label define s_educ 0 "No Formal Education" 1 "Grades 1-11" 2 "High School" 3 "Some College" 4 "College" ///
      5 "Post College", modify
label values s_educ s_educ 
tab s_educ, missing

//create s hs degree variable
gen byte s_hseduc_n1_n3 = .
replace s_hseduc_n1_n3=0 if inlist(s_educ,0,1)
replace s_hseduc_n1_n3=1 if inlist(s_educ,2,3,4,5)
la var s_hseduc_n1_n3 "S HS Degree using n1-n3 core, 1=yes"
la def hs 0 "No HS degree" 1 "HS Degree"
la val s_hseduc_n1_n3 r_hseduc_n1_n3 hs
tab s_hseduc_n1_n3, missing

//label spouse shr poor/fair variable
la def srhfp 0 "SRH Good, VG, or Exc" 1 "SRH Fair or Poor"
la val s_srh_pf_p1 srhfp

*******************************************************************
//create spouse CESD change variables to look at changes
//in spouse CESD scores between n1 and p1 interviews
*******************************************************************

//change cesd count n1 to p1?
gen s_cesdchange= s_cesd_tot_p1- s_cesd_tot_n1
tab s_cesdchange, missing
la var s_cesdchange "Change in S's CESD count n1 to p1"
*histogram s_cesdchange

//CESD improvement indicator
gen byte s_cesdbetter=.
replace s_cesdbetter= 1 if s_cesdchange <0
replace s_cesdbetter= 0 if (s_cesdchange >=0 & s_cesdchange !=.)
la var s_cesdbetter "S CESD Improvement n1 to p1"

//CESD decline indicator
gen byte s_cesdworse=.
replace s_cesdworse= 1 if (s_cesdchange >0 & s_cesdchange !=.)
replace s_cesdworse= 0 if s_cesdchange <=0 
la var s_cesdworse"S CESD Decline n1 to p1"

//CESD decline indicator
gen byte s_cesdsame=.
replace s_cesdsame= 1 if s_cesdchange ==0
replace s_cesdsame= 0 if (s_cesdchange !=0 & s_cesdchange !=.)
la var s_cesdsame "S CESD Stable n1 to p1"

tab s_cesdchange s_cesdbetter, missing
tab s_cesdchange s_cesdworse, missing
tab s_cesdchange s_cesdsame , missing

//cesd change categorical variable
gen s_cesdchange_3 =.
replace s_cesdchange_3 =1 if (s_cesdchange <0 & s_cesdchange!=.) // improvement
replace s_cesdchange_3 =-1 if (s_cesdchange >0 & s_cesdchange!=.) //decline
replace s_cesdchange_3 =0 if (s_cesdchange ==0) //no change
la var s_cesdchange_3 "S CESD change categories n1 to p1"
la def s_cesdchange_3 1 "Improvement" 0 "No change" -1 "Decline"
la val s_cesdchange_3 s_cesdchange_3 
tab s_cesdchange_3, missing

//cesd improved from >=3 to 3-  look at CESD 3 clin depression change (three options compared to improved or not*
gen s_cesd_ge3_change= s_cesd_tot_ge3_p1- s_cesd_tot_ge3_n1

//cesd improved: 3 or higher in n1 to less than 3 in p1
gen byte s_cesd_ge3better = .
replace s_cesd_ge3better = 1 if s_cesd_ge3_change < 0
replace s_cesd_ge3better = 0 if (s_cesd_ge3_change >= 0 & s_cesd_ge3_change !=.)
la var s_cesd_ge3better "S CESD change from 3+ n1 to <3 p1"
tab s_cesd_ge3better s_cesd_ge3_change, missing

//cesd same or better: 2 or higher in n1 to less than 3 in p1 or no change
gen byte s_cesd_ge3betterorsame = .
replace s_cesd_ge3betterorsame = 1 if s_cesd_ge3_change<=0
replace s_cesd_ge3betterorsame = 0 if (s_cesd_ge3_change > 0 & s_cesd_ge3_change !=.)
la var s_cesd_ge3betterorsame "S CESD no change or change from 3+ n1 to <3 p1"
tab s_cesd_ge3betterorsame s_cesd_ge3_change, missing

*******************************************************************
//Other spouse depression variables change n1 to p1
*******************************************************************

//spouse change in psych condition variables from hrs core n1 to p1
gen byte s_psych_imp_n1p1 = 0
replace s_psych_imp_n1p1  = 1 if s_psych_hrs_n1==1 & s_psych_hrs_p1==0
replace s_psych_imp_n1p1 = . if s_psych_hrs_n1==. | s_psych_hrs_p1==.
la var s_psych_imp_n1p1 "S Improvement Psych condition n1 to p1"
tab s_psych_imp_n1p1 , missing

gen byte s_psych_worse_n1p1 = 0
replace s_psych_worse_n1p1  = 1 if s_psych_hrs_n1==0 & s_psych_hrs_p1==1
replace s_psych_worse_n1p1 = . if s_psych_hrs_n1==. | s_psych_hrs_p1==.
la var s_psych_worse_n1p1 "S Decline Psych condition n1 to p1"
tab s_psych_worse_n1p1 , missing

gen byte s_psych_same_n1p1 = 0
replace s_psych_same_n1p1  = 1 if (s_psych_hrs_n1==0 & s_psych_hrs_p1==0) | (s_psych_hrs_n1==1 & s_psych_hrs_p1==1)  
replace s_psych_same_n1p1 = . if s_psych_hrs_n1==. | s_psych_hrs_p1==.
la var s_psych_same_n1p1 "S No Change Psych condition n1 to p1"
tab s_psych_same_n1p1 , missing

gen s_psych_cat_n1p1 = .
replace s_psych_cat_n1p1 = 0 if s_psych_imp_n1p1==1
replace s_psych_cat_n1p1 = 1 if s_psych_worse_n1p1==1
replace s_psych_cat_n1p1 = 2 if s_psych_same_n1p1==1
la var s_psych_cat_n1p1 "S Change in Psych Cond n1 to p1"
la def psych_cat 0 "Improved" 1 "Worse" 2 "No Change"
la val s_psych_cat_n1p1 psych_cat
tab s_psych_cat_n1p1 , missing

//spouse change in psych treatment, etc variables from hrs core n1 to p1
gen byte s_psych_treat_imp_n1p1 = 0
replace s_psych_treat_imp_n1p1 = 1 if s_psych_treat_n1==1 & s_psych_treat_p1==0
replace s_psych_treat_imp_n1p1 = . if s_psych_treat_n1==. | s_psych_treat_p1==.
la var s_psych_treat_imp_n1p1 "S Psych treat n1 to no treat p1"
tab s_psych_treat_imp_n1p1 , missing

gen byte s_psych_treat_worse_n1p1 = 0
replace s_psych_treat_worse_n1p1 = 1 if s_psych_treat_n1==0 & s_psych_treat_p1==1
replace s_psych_treat_worse_n1p1 = . if s_psych_treat_n1==. | s_psych_treat_p1==.
la var s_psych_treat_worse_n1p1 "S No psych treat n1 to treat p1"
tab s_psych_treat_worse_n1p1 , missing

gen byte s_psych_treat_same_n1p1 = 0
replace s_psych_treat_same_n1p1 = 1 if (s_psych_treat_n1==0 & s_psych_treat_p1==0) ///
	| (s_psych_treat_n1==1 & s_psych_treat_p1==1)  
replace s_psych_treat_same_n1p1 = . if s_psych_treat_n1==. | s_psych_treat_p1==.
la var s_psych_treat_same_n1p1 "S No Change Psych treat n1 to p1"
tab s_psych_treat_same_n1p1 , missing

gen s_psych_treat_cat_n1p1 = .
replace s_psych_treat_cat_n1p1 = 0 if s_psych_treat_imp_n1p1 ==1
replace s_psych_treat_cat_n1p1 = 1 if s_psych_treat_worse_n1p1 ==1
replace s_psych_treat_cat_n1p1 = 2 if s_psych_treat_same_n1p1 ==1
la var s_psych_treat_cat_n1p1 "S Change in Psych Treat n1 to p1"
la def s_psych_treat 0 "Yes n1 to no n2" 1 "No n1 to yes n2" 2 "No Change"
la val s_psych_treat_cat_n1p1 s_psych_treat
tab s_psych_treat_cat_n1p1 , missing

//spouse change in psych medications variables from hrs core n1 to p1
gen byte s_psych_med_imp_n1p1 = 0
replace s_psych_med_imp_n1p1 = 1 if s_psych_med_n1==1 & s_psych_med_p1==0
replace s_psych_med_imp_n1p1 = . if s_psych_med_n1==. | s_psych_med_p1==.
la var s_psych_med_imp_n1p1 "S Psych meds n1 to no meds p1"
tab s_psych_med_imp_n1p1 , missing

gen byte s_psych_med_worse_n1p1 = 0
replace s_psych_med_worse_n1p1 = 1 if s_psych_med_n1==0 & s_psych_med_p1==1
replace s_psych_med_worse_n1p1 = . if s_psych_med_n1==. | s_psych_med_p1==.
la var s_psych_med_worse_n1p1 "S No psych med n1 to med p1"
tab s_psych_med_worse_n1p1 , missing

gen byte s_psych_med_same_n1p1 = 0
replace s_psych_med_same_n1p1 = 1 if (s_psych_med_n1==0 & s_psych_med_p1==0) ///
	| (s_psych_med_n1==1 & s_psych_med_p1==1)  
replace s_psych_med_same_n1p1 = . if s_psych_med_n1==. | s_psych_med_p1==.
la var s_psych_med_same_n1p1 "S No Change Psych med n1 to p1"
tab s_psych_med_same_n1p1 , missing

gen s_psych_med_cat_n1p1 = .
replace s_psych_med_cat_n1p1 = 0 if s_psych_med_imp_n1p1 ==1
replace s_psych_med_cat_n1p1 = 1 if s_psych_med_worse_n1p1 ==1
replace s_psych_med_cat_n1p1 = 2 if s_psych_med_same_n1p1 ==1
la var s_psych_med_cat_n1p1 "S Change in Psych Medic n1 to p1"
la val s_psych_med_cat_n1p1 s_psych_treat
tab s_psych_med_cat_n1p1 , missing

//spouse overall psych problems variable from hrs core n1 to p1
gen byte s_psych_oa_imp_n1p1 = 0
replace s_psych_oa_imp_n1p1 = 1 if s_psych_overall_hrs_n1==1 & s_psych_overall_hrs_p1==0
replace s_psych_oa_imp_n1p1 = . if s_psych_overall_hrs_n1==. | s_psych_overall_hrs_p1==.
la var s_psych_oa_imp_n1p1 "S Psych Cond Overall n1 to no p1"
tab s_psych_oa_imp_n1p1 , missing

gen byte s_psych_oa_worse_n1p1 = 0
replace s_psych_oa_worse_n1p1 = 1 if s_psych_overall_hrs_n1==0 & s_psych_overall_hrs_p1==1
replace s_psych_oa_worse_n1p1 = . if s_psych_overall_hrs_n1==. | s_psych_overall_hrs_p1==.
la var s_psych_oa_worse_n1p1 "S No psych cond overall n1 to yes p1"
tab s_psych_oa_worse_n1p1 , missing

gen byte s_psych_oa_same_n1p1 = 0
replace s_psych_oa_same_n1p1 = 1 if (s_psych_overall_hrs_n1==0 & s_psych_overall_hrs_p1==0) ///
	| (s_psych_overall_hrs_n1==1 & s_psych_overall_hrs_p1==1)  
replace s_psych_oa_same_n1p1 = . if s_psych_overall_hrs_n1==. | s_psych_overall_hrs_p1==.
la var s_psych_oa_same_n1p1 "S No Change Psych overall n1 to p1"
tab s_psych_oa_same_n1p1 , missing

gen s_psych_oa_cat_n1p1 = .
replace s_psych_oa_cat_n1p1 = 0 if s_psych_oa_imp_n1p1 ==1
replace s_psych_oa_cat_n1p1 = 1 if s_psych_oa_worse_n1p1 ==1
replace s_psych_oa_cat_n1p1 = 2 if s_psych_oa_same_n1p1 ==1
la var s_psych_oa_cat_n1p1 "S Change in Psych OA condition n1 to p1"
la val s_psych_oa_cat_n1p1 s_psych_treat
tab s_psych_oa_cat_n1p1 , missing


//spouse ever drink indicator from hrs core n1 to p1
gen byte s_ever_drink_imp_n1p1 = 0
replace s_ever_drink_imp_n1p1 = 1 if s_ever_drink_n1==1 & s_ever_drink_p1==0
replace s_ever_drink_imp_n1p1 = . if s_ever_drink_n1==. | s_ever_drink_p1==.
la var s_ever_drink_imp_n1p1 "S ever drink = yes n1 to no p1"
tab s_ever_drink_imp_n1p1, missing

gen byte s_ever_drink_worse_n1p1 = 0
replace s_ever_drink_worse_n1p1 = 1 if s_ever_drink_n1==0 & s_ever_drink_p1==1
replace s_ever_drink_worse_n1p1 = . if s_ever_drink_n1==. | s_ever_drink_p1==.
la var s_ever_drink_worse_n1p1 "S ever drink = no n1 to yes p1"
tab s_ever_drink_worse_n1p1 , missing

gen byte s_ever_drink_same_n1p1 = 0
replace s_ever_drink_same_n1p1 = 1 if (s_ever_drink_n1==0 & s_ever_drink_p1==0) ///
	| (s_ever_drink_n1==1 & s_ever_drink_p1==1)  
replace s_ever_drink_same_n1p1 = . if s_ever_drink_n1==. | s_ever_drink_p1==.
la var s_ever_drink_same_n1p1 "S No Change ever drink n1 to p1"
tab s_ever_drink_same_n1p1 , missing

gen s_ever_drink_cat_n1p1 = .
replace s_ever_drink_cat_n1p1 = 0 if s_ever_drink_imp_n1p1 ==1
replace s_ever_drink_cat_n1p1 = 1 if s_ever_drink_worse_n1p1 ==1
replace s_ever_drink_cat_n1p1 = 2 if s_ever_drink_same_n1p1 ==1
la var s_ever_drink_cat_n1p1 "S Change in Ever drink status n1 to p1"
la val s_ever_drink_cat_n1p1 s_psych_treat
tab s_ever_drink_cat_n1p1, missing

gen change_drinks = s_n_drinks_3m_p1 - s_n_drinks_3m_n1 
gen byte s_drink_more_n1p1 = .
replace s_drink_more_n1p1 = 1 if change_drinks > 0 & change_drinks!=.
replace s_drink_more_n1p1 = 0 if change_drinks <= 0

gen byte s_drink_less_n1p1 = .
replace s_drink_less_n1p1 = 1 if change_drinks < 0 
replace s_drink_less_n1p1 = 0 if change_drinks >= 0 & change_drinks!=.

gen byte s_drink_same_n1p1 = .
replace s_drink_same_n1p1 = 1 if change_drinks==0
replace s_drink_same_n1p1 = 0 if change_drinks != 0 & change_drinks!=.

la var s_drink_more_n1p1 "Number alc drinks increased n1 to p1"
la var s_drink_less_n1p1 "Number alc drinks decreased n1 to p1"
la var s_drink_same_n1p1 "Number alc drinks same n1 to p1"
tab s_drink_more_n1p1, missing
tab s_drink_less_n1p1 , missing
tab s_drink_same_n1p1 , missing

drop change_drinks

gen s_drink_cat_n1p1 = .
replace s_drink_cat_n1p1 = 0 if s_drink_more_n1p1 ==1
replace s_drink_cat_n1p1 = 1 if s_drink_less_n1p1 ==1
replace s_drink_cat_n1p1 = 2 if s_drink_same_n1p1 ==1
la var s_ever_drink_cat_n1p1 "S Change in Ever drink status n1 to p1"
la def drinks 0 "Drinks more" 1 "Drinks less" 2 "No change"
la val s_drink_cat_n1p1 drinks 
tab s_drink_cat_n1p1, missing

gen byte s_alcoh_mis_imp_n1p1 = 0
replace s_alcoh_mis_imp_n1p1 = 1 if s_alcohol_mis_n1==1 & s_alcohol_mis_p1==0
replace s_alcoh_mis_imp_n1p1 = . if s_alcohol_mis_n1==. | s_alcohol_mis_p1==.

gen byte s_alcoh_mis_worse_n1p1 = 0
replace s_alcoh_mis_worse_n1p1 = 1 if s_alcohol_mis_n1==0 & s_alcohol_mis_p1==1
replace s_alcoh_mis_worse_n1p1 = . if s_alcohol_mis_n1==. | s_alcohol_mis_p1==.

gen byte s_alcoh_mis_same_n1p1 = 0
replace s_alcoh_mis_same_n1p1 = 1 if (s_alcohol_mis_n1==0 & s_alcohol_mis_p1==0) ///
	| (s_alcohol_mis_n1==1 & s_alcohol_mis_p1==1)  
replace s_alcoh_mis_same_n1p1 = . if s_alcohol_mis_n1==. | s_alcohol_mis_p1==.

la var s_alcoh_mis_imp_n1p1 "Alcohol misuse n1 to no p1"
la var s_alcoh_mis_worse_n1p1 "No alcohol misuse n1 to yes p1"
la var s_alcoh_mis_same_n1p1 "Alcohol misuse same n1 to p1"
tab s_alcoh_mis_imp_n1p1 , missing
tab s_alcoh_mis_worse_n1p1 , missing
tab s_alcoh_mis_same_n1p1 , missing

gen s_alcoh_mis_cat_n1p1 = .
replace s_alcoh_mis_cat_n1p1 = 0 if s_alcoh_mis_imp_n1p1 ==1
replace s_alcoh_mis_cat_n1p1 = 1 if s_alcoh_mis_worse_n1p1 ==1
replace s_alcoh_mis_cat_n1p1 = 2 if s_alcoh_mis_same_n1p1 ==1
la var s_alcoh_mis_cat_n1p1 "S Change in Alcohol misuse n1 to p1"
la val s_alcoh_mis_cat_n1p1 s_psych_treat
tab s_alcoh_mis_cat_n1p1 , missing

gen byte s_vig_act_imp_n1p1 = 0
replace s_vig_act_imp_n1p1 = 1 if s_vig_phy_act_n1==0 & s_vig_phy_act_p1==1
replace s_vig_act_imp_n1p1 = . if s_vig_phy_act_n1==. | s_vig_phy_act_p1==.

gen byte s_vig_act_worse_n1p1 = 0
replace s_vig_act_worse_n1p1 = 1 if s_vig_phy_act_n1==1 & s_vig_phy_act_p1==0
replace s_vig_act_worse_n1p1 = . if s_vig_phy_act_n1==. | s_vig_phy_act_p1==.

gen byte s_vig_act_same_n1p1 = 0
replace s_vig_act_same_n1p1 = 1 if (s_vig_phy_act_n1==0 & s_vig_phy_act_p1==0) ///
	| (s_vig_phy_act_n1==1 & s_vig_phy_act_p1==1)  
replace s_vig_act_same_n1p1 = . if s_vig_phy_act_n1==. | s_vig_phy_act_p1==.

la var s_vig_act_imp_n1p1 "No vigorous phys activity n1 to yes p1"
la var s_vig_act_worse_n1p1 "Vigorous phys activity n1 to no p1"
la var s_vig_act_same_n1p1 "Vig physical activity same n1 to p1"
tab s_vig_act_imp_n1p1 , missing
tab s_vig_act_worse_n1p1 , missing
tab s_vig_act_same_n1p1 , missing

gen s_vig_act_cat_n1p1 = .
replace s_vig_act_cat_n1p1 = 0 if s_vig_act_imp_n1p1 ==1
replace s_vig_act_cat_n1p1 = 1 if s_vig_act_worse_n1p1 ==1
replace s_vig_act_cat_n1p1 = 2 if s_vig_act_same_n1p1 ==1
la var s_vig_act_cat_n1p1 "S Change in vigorous activity n1 to p1"
la def vig_act 0 "no n1 to yes p1" 1 "yes n1 to no p1" 2 "No change"
la val s_vig_act_cat_n1p1 vig_act 
tab s_vig_act_cat_n1p1 , missing

gen byte s_help_friends_imp_n1p1 = 0
replace s_help_friends_imp_n1p1 = 1 if s_help_friends_n1==0 & s_help_friends_p1==1
replace s_help_friends_imp_n1p1 = . if s_help_friends_n1==. | s_help_friends_p1==.

gen byte s_help_friends_worse_n1p1 = 0
replace s_help_friends_worse_n1p1 = 1 if s_help_friends_n1==1 & s_help_friends_p1==0
replace s_help_friends_worse_n1p1 = . if s_help_friends_n1==. | s_help_friends_p1==.

gen byte s_help_friends_same_n1p1 = 0
replace s_help_friends_same_n1p1 = 1 if (s_help_friends_n1==0 & s_help_friends_p1==0) ///
	| (s_help_friends_n1==1 & s_help_friends_p1==1)  
replace s_help_friends_same_n1p1 = . if s_help_friends_n1==. | s_help_friends_p1==.

la var s_help_friends_imp_n1p1 "Does not help friends n1 to does help p1"
la var s_help_friends_worse_n1p1 "Helps friends n1 to no p1"
la var s_help_friends_same_n1p1 "Same help friends n1 to p1"
tab s_help_friends_imp_n1p1 , missing
tab s_help_friends_worse_n1p1 , missing
tab s_help_friends_same_n1p1 , missing

gen s_help_friends_cat_n1p1 = .
replace s_help_friends_cat_n1p1 = 0 if s_help_friends_imp_n1p1 ==1
replace s_help_friends_cat_n1p1 = 1 if s_help_friends_worse_n1p1 ==1
replace s_help_friends_cat_n1p1 = 2 if s_help_friends_same_n1p1 ==1
la var s_help_friends_cat_n1p1 "S Change in help friends ind n1 to p1"
la val s_help_friends_cat_n1p1 vig_act 
tab s_help_friends_cat_n1p1 , missing

gen change_hrs_help_friends = s_help_friends_hours_p1 - s_help_friends_hours_n1
gen byte s_help_friends_hrs_more_n1p1 = .
replace s_help_friends_hrs_more_n1p1 = 1 if change_hrs_help_friends > 0 & change_hrs_help_friends !=.
replace s_help_friends_hrs_more_n1p1 = 0 if change_hrs_help_friends <= 0 & change_hrs_help_friends !=.
gen byte s_help_friends_hrs_less_n1p1 = .
replace s_help_friends_hrs_less_n1p1 = 1 if change_hrs_help_friends < 0 & change_hrs_help_friends !=.
replace s_help_friends_hrs_less_n1p1 = 0 if change_hrs_help_friends >= 0 & change_hrs_help_friends !=.
gen byte s_help_friends_hrs_same_n1p1 = .
replace s_help_friends_hrs_same_n1p1 = 1 if change_hrs_help_friends == 0 
replace s_help_friends_hrs_same_n1p1 = 0 if change_hrs_help_friends != 0 & change_hrs_help_friends !=.

la var s_help_friends_hrs_more_n1p1 "Hours helping friends increased n1 to p1"
la var s_help_friends_hrs_less_n1p1 "Hours helping friends decreased n1 to p1"
la var s_help_friends_hrs_same_n1p1 "Hours helping friends same n1 to p1"
tab s_help_friends_hrs_more_n1p1 change_hrs_help_friends, missing
tab s_help_friends_hrs_less_n1p1 change_hrs_help_friends, missing
tab s_help_friends_hrs_same_n1p1 change_hrs_help_friends, missing

gen s_help_friends_hrs_cat_n1p1 = .
replace s_help_friends_hrs_cat_n1p1 = 0 if s_help_friends_hrs_more_n1p1 ==1
replace s_help_friends_hrs_cat_n1p1 = 1 if s_help_friends_hrs_less_n1p1 ==1
replace s_help_friends_hrs_cat_n1p1 = 2 if s_help_friends_hrs_same_n1p1 ==1
la var s_help_friends_hrs_cat_n1p1 "S Change in help friends hours n1 to p1"
la def help_friends_hrs 0 "Hours increased" 1 "Hours decreased" 2 "No change"
la val s_help_friends_hrs_cat_n1p1 help_friends_hrs 
tab s_help_friends_hrs_cat_n1p1 , missing

drop change_hrs_help_friends

gen s_friend_imp_n1p1 = 0
replace s_friend_imp_n1p1 = 1 if s_friend_n1==0 & s_friend_p1==1
replace s_friend_imp_n1p1 = . if s_friend_n1==. | s_friend_p1==.

gen s_friend_worse_n1p1 = 0
replace s_friend_worse_n1p1 = 1 if s_friend_n1==1 & s_friend_p1==0
replace s_friend_worse_n1p1 = . if s_friend_n1==. | s_friend_p1==.

gen byte s_friend_same_n1p1 = 0
replace s_friend_same_n1p1 = 1 if (s_friend_n1==0 & s_friend_p1==0) ///
	| (s_friend_n1==1 & s_friend_p1==1)  
replace s_friend_same_n1p1 = . if s_friend_n1==. | s_friend_p1==.

la var s_friend_imp_n1p1 "S No friends nearby n1 to yes p1"
la var s_friend_worse_n1p1 "S Friends nearby n1 to no p1"
la var s_friend_same_n1p1 "S Friends nearby same n1 to p1"
tab s_friend_imp_n1p1 , missing
tab s_friend_worse_n1p1 , missing
tab s_friend_same_n1p1 , missing

gen s_friend_cat_n1p1 = .
replace s_friend_cat_n1p1 = 0 if s_friend_imp_n1p1 ==1
replace s_friend_cat_n1p1 = 1 if s_friend_worse_n1p1 ==1
replace s_friend_cat_n1p1 = 2 if s_friend_same_n1p1 ==1
la var s_friend_cat_n1p1 "S Change in friends nearby n1 to p1"
la val s_friend_cat_n1p1 vig_act 
tab s_friend_cat_n1p1 , missing


gen byte s_soc_visit_imp_n1p1 = 0
replace s_soc_visit_imp_n1p1 = 1 if s_soc_visit_n1==0 & s_soc_visit_p1==1
replace s_soc_visit_imp_n1p1 = . if s_soc_visit_n1==. | s_soc_visit_p1==.

gen byte s_soc_visit_worse_n1p1 = 0
replace s_soc_visit_worse_n1p1 = 1 if s_soc_visit_n1==1 & s_soc_visit_p1==0
replace s_soc_visit_worse_n1p1 = . if s_soc_visit_n1==. | s_soc_visit_p1==.

gen byte s_soc_visit_same_n1p1 = 0
replace s_soc_visit_same_n1p1 = 1 if (s_soc_visit_n1==1 & s_soc_visit_p1==1) ///
	| (s_soc_visit_n1==0 & s_soc_visit_p1==0)
replace s_soc_visit_same_n1p1 = . if s_soc_visit_n1==. | s_soc_visit_p1==.

la var s_soc_visit_imp_n1p1 "S No social visits n1 to yes p1"
la var s_soc_visit_worse_n1p1 "S Social visits n1 to no p1"
la var s_soc_visit_same_n1p1 "S Social visits same n1 to p1"
tab s_soc_visit_imp_n1p1 , missing
tab s_soc_visit_worse_n1p1 , missing
tab s_soc_visit_same_n1p1 , missing

gen s_soc_visit_cat_n1p1 = .
replace s_soc_visit_cat_n1p1 = 0 if s_soc_visit_imp_n1p1 ==1
replace s_soc_visit_cat_n1p1 = 1 if s_soc_visit_worse_n1p1 ==1
replace s_soc_visit_cat_n1p1 = 2 if s_soc_visit_same_n1p1 ==1
la var s_soc_visit_cat_n1p1 "S Change in social visits ind n1 to p1"
la val s_soc_visit_cat_n1p1 vig_act 
tab s_soc_visit_cat_n1p1 , missing

gen change_soc_visit = s_soc_visit_cat_p1 - s_soc_visit_cat_n1
gen byte s_soc_visit_cnt_more_n1p1 = .
replace s_soc_visit_cnt_more_n1p1 =1 if change_soc_visit >0 & change_soc_visit !=.
replace s_soc_visit_cnt_more_n1p1 =0 if change_soc_visit <=0 & change_soc_visit !=.
gen byte s_soc_visit_cnt_less_n1p1 = .
replace s_soc_visit_cnt_less_n1p1 =1 if change_soc_visit <0 & change_soc_visit !=.
replace s_soc_visit_cnt_less_n1p1 =0 if change_soc_visit >=0 & change_soc_visit !=.
gen byte s_soc_visit_cnt_same_n1p1 = .
replace s_soc_visit_cnt_same_n1p1 =1 if change_soc_visit ==0
replace s_soc_visit_cnt_same_n1p1 =0 if change_soc_visit !=0 & change_soc_visit !=.
la var s_soc_visit_cnt_more_n1p1 "S More social visits n1 to p1"
la var s_soc_visit_cnt_less_n1p1 "S fewer social visits n1 to p1"
la var s_soc_visit_cnt_same_n1p1 "S same social visits n1 to p1"
tab s_soc_visit_cnt_more_n1p1 change_soc_visit , missing
tab s_soc_visit_cnt_less_n1p1 change_soc_visit , missing
tab s_soc_visit_cnt_same_n1p1 change_soc_visit , missing

gen s_soc_visit_cnt_cat_n1p1 = .
replace s_soc_visit_cnt_cat_n1p1 = 0 if s_soc_visit_imp_n1p1 ==1
replace s_soc_visit_cnt_cat_n1p1 = 1 if s_soc_visit_worse_n1p1 ==1
replace s_soc_visit_cnt_cat_n1p1 = 2 if s_soc_visit_cnt_same_n1p1 ==1
la var s_soc_visit_cnt_cat_n1p1 "S Change in number of social visits n1 to p1"
la def soc_visit_cnt 0 "More soc visits" 1 "Fewer soc visits" 2 "No change"
la val s_soc_visit_cnt_cat_n1p1 soc_visit_cnt 
tab s_soc_visit_cnt_cat_n1p1 , missing

drop change_soc_visit

*******************************************************************
//ADL helper n1 to x interview variables
*******************************************************************
//spouse helper
gen byte adl_help_sp_more_n1x = 0
replace adl_help_sp_more_n1x = 1 if r_adl_sp_helper_n1==0 & r_adl_sp_helper_x==1
replace adl_help_sp_more_n1x = . if r_adl_sp_helper_n1==. | r_adl_sp_helper_x==.

gen byte adl_help_sp_less_n1x = 0
replace adl_help_sp_less_n1x = 1 if r_adl_sp_helper_n1==1 & r_adl_sp_helper_x==0
replace adl_help_sp_less_n1x = . if r_adl_sp_helper_n1==. | r_adl_sp_helper_x==.

gen byte adl_help_sp_same_n1x = 0
replace adl_help_sp_same_n1x = 1 if (r_adl_sp_helper_n1==0 & r_adl_sp_helper_x==0) ///
| (r_adl_sp_helper_n1==1 & r_adl_sp_helper_x==1)
replace adl_help_sp_same_n1x = . if r_adl_sp_helper_n1==. | r_adl_sp_helper_x==.
la var adl_help_sp_more_n1x "S main adl helper =no n1, yes=x" 
la var adl_help_sp_less_n1x "S main adl helper =yes n1, no=x" 
la var adl_help_sp_same_n1x "S main adl helper no change" 
tab adl_help_sp_more_n1x , missing
tab adl_help_sp_less_n1x , missing
tab adl_help_sp_same_n1x , missing

gen adl_help_sp_cat_n1x = .
replace adl_help_sp_cat_n1x = 0 if adl_help_sp_more_n1x ==1
replace adl_help_sp_cat_n1x = 1 if adl_help_sp_less_n1x ==1
replace adl_help_sp_cat_n1x = 2 if adl_help_sp_same_n1x ==1
la var adl_help_sp_cat_n1x "R Change S main ADL helper n1 to p1"
la val adl_help_sp_cat_n1x vig_act 
tab adl_help_sp_cat_n1x , missing


//other, non-spouse helper
gen byte adl_help_oth_more_n1x = 0
replace adl_help_oth_more_n1x = 1 if r_adl_oth_helper_n1==0 & r_adl_oth_helper_x==1
replace adl_help_oth_more_n1x = . if r_adl_oth_helper_n1==. | r_adl_oth_helper_x==.

gen byte adl_help_oth_less_n1x = 0
replace adl_help_oth_less_n1x = 1 if r_adl_oth_helper_n1==1 & r_adl_oth_helper_x==0
replace adl_help_oth_less_n1x = . if r_adl_oth_helper_n1==. | r_adl_oth_helper_x==.

gen byte adl_help_oth_same_n1x = 0
replace adl_help_oth_same_n1x = 1 if (r_adl_oth_helper_n1==0 & r_adl_oth_helper_x==0) ///
| (r_adl_oth_helper_n1==1 & r_adl_oth_helper_x==1)
replace adl_help_oth_same_n1x = . if r_adl_oth_helper_n1==. | r_adl_oth_helper_x==.
la var adl_help_oth_more_n1x "Other main adl helper =no n1, yes=x" 
la var adl_help_oth_less_n1x "Other main adl helper =yes n1, no=x" 
la var adl_help_oth_same_n1x "Other main adl helper no change" 
tab adl_help_oth_more_n1x , missing
tab adl_help_oth_less_n1x , missing
tab adl_help_oth_same_n1x , missing

gen adl_help_oth_cat_n1x = .
replace adl_help_oth_cat_n1x = 0 if adl_help_oth_more_n1x ==1
replace adl_help_oth_cat_n1x = 1 if adl_help_oth_less_n1x ==1
replace adl_help_oth_cat_n1x = 2 if adl_help_oth_same_n1x ==1
la var adl_help_oth_cat_n1x "R Change other main ADL helper n1 to p1"
la val adl_help_oth_cat_n1x vig_act 
tab adl_help_oth_cat_n1x , missing


//number of adl helpers
gen change_adl_help = r_adl_helper_count_x - r_adl_helper_count_n1

gen byte adl_help_count_more_n1x = .
replace adl_help_count_more_n1x =1 if change_adl_help > 0 & change_adl_help !=.
replace adl_help_count_more_n1x =0 if change_adl_help <= 0 & change_adl_help !=.

gen byte adl_help_count_less_n1x = .
replace adl_help_count_less_n1x =1 if change_adl_help < 0 & change_adl_help !=.
replace adl_help_count_less_n1x =0 if change_adl_help >= 0 & change_adl_help !=.

gen byte adl_help_count_same_n1x = .
replace adl_help_count_same_n1x =1 if change_adl_help == 0 
replace adl_help_count_same_n1x =0 if change_adl_help != 0 & change_adl_help !=.

la var adl_help_count_more_n1x "No ADL helpers increased n1 to x" 
la var adl_help_count_less_n1x "No ADL helpers decreased n1 to x" 
la var adl_help_count_same_n1x "No ADL helpers same n1 to x" 
tab adl_help_count_more_n1x , missing
tab adl_help_count_less_n1x , missing
tab adl_help_count_same_n1x , missing

gen adl_help_count_cat_n1x = .
replace adl_help_count_cat_n1x = 0 if adl_help_count_more_n1x ==1
replace adl_help_count_cat_n1x = 1 if adl_help_count_less_n1x ==1
replace adl_help_count_cat_n1x = 2 if adl_help_count_same_n1x ==1
la var adl_help_oth_cat_n1x "R Change other main ADL helper n1 to p1"
la def help_count 0 "More helpers" 1 "Fewer helpers" 2 "No change"
la val adl_help_count_cat_n1x help_count 
tab adl_help_count_cat_n1x , missing


*******************************************************************
//IADL helper n1 to x interview variables
*******************************************************************
//spouse helper
gen byte iadl_help_sp_more_n1x = 0
replace iadl_help_sp_more_n1x = 1 if r_iadl_sp_helper_n1==0 & r_iadl_sp_helper_x==1
replace iadl_help_sp_more_n1x = . if r_iadl_sp_helper_n1==. | r_iadl_sp_helper_x==.

gen byte iadl_help_sp_less_n1x = 0
replace iadl_help_sp_less_n1x = 1 if r_iadl_sp_helper_n1==1 & r_iadl_sp_helper_x==0
replace iadl_help_sp_less_n1x = . if r_iadl_sp_helper_n1==. | r_iadl_sp_helper_x==.

gen byte iadl_help_sp_same_n1x = 0
replace iadl_help_sp_same_n1x = 1 if (r_iadl_sp_helper_n1==0 & r_iadl_sp_helper_x==0) ///
| (r_iadl_sp_helper_n1==1 & r_iadl_sp_helper_x==1)
replace iadl_help_sp_same_n1x = . if r_iadl_sp_helper_n1==. | r_iadl_sp_helper_x==.
la var iadl_help_sp_more_n1x "S main iadl helper =no n1, yes=x" 
la var iadl_help_sp_less_n1x "S main iadl helper =yes n1, no=x" 
la var iadl_help_sp_same_n1x "S main iadl helper no change" 
tab iadl_help_sp_more_n1x , missing
tab iadl_help_sp_less_n1x , missing
tab iadl_help_sp_same_n1x , missing

gen iadl_help_sp_cat_n1x = .
replace iadl_help_sp_cat_n1x = 0 if iadl_help_sp_more_n1x ==1
replace iadl_help_sp_cat_n1x = 1 if iadl_help_sp_less_n1x ==1
replace iadl_help_sp_cat_n1x = 2 if iadl_help_sp_same_n1x ==1
la var iadl_help_sp_cat_n1x "R Change S main IADL helper n1 to p1"
la val iadl_help_sp_cat_n1x vig_act 
tab iadl_help_sp_cat_n1x , missing

//other, non-spouse helper
gen byte iadl_help_oth_more_n1x = 0
replace iadl_help_oth_more_n1x = 1 if r_iadl_oth_helper_n1==0 & r_iadl_oth_helper_x==1
replace iadl_help_oth_more_n1x = . if r_iadl_oth_helper_n1==. | r_iadl_oth_helper_x==.

gen byte iadl_help_oth_less_n1x = 0
replace iadl_help_oth_less_n1x = 1 if r_iadl_oth_helper_n1==1 & r_iadl_oth_helper_x==0
replace iadl_help_oth_less_n1x = . if r_iadl_oth_helper_n1==. | r_iadl_oth_helper_x==.

gen byte iadl_help_oth_same_n1x = 0
replace iadl_help_oth_same_n1x = 1 if (r_iadl_oth_helper_n1==0 & r_iadl_oth_helper_x==0) ///
| (r_iadl_oth_helper_n1==1 & r_iadl_oth_helper_x==1)
replace iadl_help_oth_same_n1x = . if r_iadl_oth_helper_n1==. | r_iadl_oth_helper_x==.
la var iadl_help_oth_more_n1x "Other main iadl helper =no n1, yes=x" 
la var iadl_help_oth_less_n1x "Other main iadl helper =yes n1, no=x" 
la var iadl_help_oth_same_n1x "Other main iadl helper no change" 
tab iadl_help_oth_more_n1x , missing
tab iadl_help_oth_less_n1x , missing
tab iadl_help_oth_same_n1x , missing

gen iadl_help_oth_cat_n1x = .
replace iadl_help_oth_cat_n1x = 0 if iadl_help_oth_more_n1x ==1
replace iadl_help_oth_cat_n1x = 1 if iadl_help_oth_less_n1x ==1
replace iadl_help_oth_cat_n1x = 2 if iadl_help_oth_same_n1x ==1
la var iadl_help_oth_cat_n1x "R Change other main IADL helper n1 to p1"
la val iadl_help_oth_cat_n1x vig_act 
tab iadl_help_oth_cat_n1x , missing

//number of iadl helpers
gen change_iadl_help = r_iadl_helper_count_x - r_iadl_helper_count_n1

gen byte iadl_help_count_more_n1x = .
replace iadl_help_count_more_n1x =1 if change_iadl_help > 0 & change_iadl_help !=.
replace iadl_help_count_more_n1x =0 if change_iadl_help <= 0 & change_iadl_help !=.

gen byte iadl_help_count_less_n1x = .
replace iadl_help_count_less_n1x =1 if change_iadl_help < 0 & change_iadl_help !=.
replace iadl_help_count_less_n1x =0 if change_iadl_help >= 0 & change_iadl_help !=.

gen byte iadl_help_count_same_n1x = .
replace iadl_help_count_same_n1x =1 if change_iadl_help == 0 
replace iadl_help_count_same_n1x =0 if change_iadl_help != 0 & change_iadl_help !=.

la var iadl_help_count_more_n1x "No iadl helpers increased n1 to x" 
la var iadl_help_count_less_n1x "No iadl helpers decreased n1 to x" 
la var iadl_help_count_same_n1x "No iadl helpers same n1 to x" 
tab iadl_help_count_more_n1x , missing
tab iadl_help_count_less_n1x , missing
tab iadl_help_count_same_n1x , missing

gen iadl_help_count_cat_n1x = .
replace iadl_help_count_cat_n1x = 0 if iadl_help_count_more_n1x ==1
replace iadl_help_count_cat_n1x = 1 if iadl_help_count_less_n1x ==1
replace iadl_help_count_cat_n1x = 2 if iadl_help_count_same_n1x ==1
la var iadl_help_oth_cat_n1x "R Change other main IADL helper n1 to p1"
la val iadl_help_count_cat_n1x help_count 
tab iadl_help_count_cat_n1x , missing


*******************************************************************
//Respondant variables
*******************************************************************

//indicator for hospice use 12 months preceeding death
gen byte r_hs_12m = .
replace r_hs_12m = 1 if hs_los_12m != 0 & hs_los_12m != .
replace r_hs_12m = 0 if hs_los_12m == 0 
la var r_hs_12m "Indicator hospice use last 12 months of life"
la def hs 0 "No hospice use" 1 "Hospice use", replace
tab r_hs_12m, missing

//create new hospice variables
//note if hs use 1-2 days, then missing by this definition
gen r_hs_12m_gt3d = .
replace r_hs_12m_gt3d = 1 if hs_los_12m >= 3 & hs_los_12m != .
replace r_hs_12m_gt3d = 0 if hs_los_12m == 0 
la var r_hs_12m_gt3d "Indicator hospice use last 12 months of life"
la def r_hs_12m_gt3d  0 "No hospice use" 1 "3+ days hospice use", replace
la val r_hs_12m_gt3d r_hs_12m_gt3d
tab r_hs_12m_gt3d r_hs_12m, missing
tab hs_los_12m r_hs_12m_gt3d , missing

//create new hospice variables
//note if hs use 1-6 days, then missing by this definition
gen r_hs_12m_gt7d = .
replace r_hs_12m_gt7d = 1 if hs_los_12m >= 7 & hs_los_12m != .
replace r_hs_12m_gt7d = 0 if hs_los_12m == 0 
la var r_hs_12m_gt7d "Indicator hospice use last 12 months of life"
la def r_hs_12m_gt7d  0 "No hospice use" 1 "7+ days hospice use", replace
la val r_hs_12m_gt7d r_hs_12m_gt7d
tab r_hs_12m_gt7d r_hs_12m, missing
tab hs_los_12m r_hs_12m_gt7d , missing

//indicator for hospice use 24 months preceeding death
gen byte r_hs_24m = .
replace r_hs_24m = 1 if hs_los_24m != 0 & hs_los_24m != .
replace r_hs_24m = 0 if hs_los_24m == 0 
la var r_hs_24m "Indicator hospice use last 24 months of life"
tab r_hs_24m, missing

//indicator for SNF use 24 months preceeding death
gen byte r_snf_24m = .
replace r_snf_24m = 1 if snf_los_24m != 0 & snf_los_24m != .
replace r_snf_24m = 0 if snf_los_24m == 0 
la var r_snf_24m "Indicator SNF use last 24 months of life"
tab r_snf_24m, missing

//indicator for hospital admission 24 months preceeding death
gen byte r_ip_24m = .
replace r_ip_24m = 1 if ip_los_24m != 0 & ip_los_24m != .
replace r_ip_24m = 0 if ip_los_24m == 0 
la var r_ip_24m "Indicator SNF use last 24 months of life"
tab r_ip_24m, missing

//create new los variables that are missing if no utilization
gen hs_los_12m_miss = hs_los_12m 
replace hs_los_12m_miss = . if hs_los_12m==0
la var hs_los_12m_miss "Hospice LOS 12 m - missing if LOS = 0"

gen hs_los_24m_miss = hs_los_24m 
replace hs_los_24m_miss = . if hs_los_24m==0
la var hs_los_24m_miss "Hospice LOS 24 m - missing if LOS = 0"

gen snf_los_24m_miss = snf_los_24m 
replace snf_los_24m_miss = . if snf_los_24m==0
la var snf_los_24m_miss "SNF LOS 24 m - missing if LOS = 0"

gen ip_los_24m_miss = ip_los_24m 
replace ip_los_24m_miss = . if ip_los_24m==0
la var ip_los_24m_miss "Hospital LOS 24 m - missing if LOS = 0"

//create dichotomous vars for comorbidity index categories
gen byte s_hrs_comorb_none_n1 = .
replace s_hrs_comorb_none_n1=1 if s_comor_c_hrs_n1==0
replace s_hrs_comorb_none_n1=0 if s_comor_c_hrs_n1!=0 & s_comor_c_hrs_n1!=.
la var s_hrs_comorb_none_n1 "Comorbidity index ind - none"

gen byte s_hrs_comorb_mild_n1 = .
replace s_hrs_comorb_mild_n1 =1 if s_comor_c_hrs_n1==1
replace s_hrs_comorb_mild_n1 =0 if s_comor_c_hrs_n1!=1 & s_comor_c_hrs_n1!=.
la var s_hrs_comorb_mild_n1 "Comorbidity index ind - mild 1-3"

gen byte s_hrs_comorb_mod_n1 = .
replace s_hrs_comorb_mod_n1=1 if s_comor_c_hrs_n1==2
replace s_hrs_comorb_mod_n1=0 if s_comor_c_hrs_n1!=2 & s_comor_c_hrs_n1!=.
la var s_hrs_comorb_mod_n1 "Comorbidity index ind - moderate 4-6"

gen byte s_hrs_comorb_sev_n1 = .
replace s_hrs_comorb_sev_n1=1 if s_comor_c_hrs_n1==3
replace s_hrs_comorb_sev_n1=0 if s_comor_c_hrs_n1!=3 & s_comor_c_hrs_n1!=.
la var s_hrs_comorb_sev_n1 "Comorbidity index ind - severe 7+"

tab s_hrs_comorb_none_n1, missing
tab s_hrs_comorb_mild_n1, missing
tab s_hrs_comorb_mod_n1, missing
tab s_hrs_comorb_sev_n1, missing

la def comor_c 0 "None" 1 "Mild (1-3)" 2 "Moderate (4-6)" 3 "Severe (7+)"
la val s_comor_c_hrs_p1 s_comor_c_hrs_n1 comor_c

//spouse p1 comorbidities from HRS
tab s_cancer_hrs_p1, missing
tab s_lung_hrs_p1, missing 
tab s_heart_hrs_p1, missing 
tab s_chf_hrs_p1, missing 
tab s_stroke_hrs_p1, missing 
tab s_memory_hrs_p1, missing
tab s_htn_hrs_p1, missing 
tab s_dm_hrs_p1, missing 
tab s_psych_hrs_p1, missing

/*************************************************************************/
//interview timeline variables
/*************************************************************************/
gen r_days_n1_core_dead =  r_death_date_e - r_c_ivw_date_n1 
gen s_days_n1_core_dead =  r_death_date_e - s_c_ivw_date_n1 
gen r_days_x_exit_dead =   r_e_ivw_date_x - r_death_date_e
label var days_p1_core_dead "Days from R's death to S p1 interview"
tab days_p1_core_dead, missing

//indicator for p1 ivw within 1 year of r's death
gen s_1yr_p1_core_dead = .
replace s_1yr_p1_core_dead =1 if days_p1_core_dead <366 & days_p1_core_dead !=.
replace s_1yr_p1_core_dead =0 if days_p1_core_dead >=366 & days_p1_core_dead !=.
la var s_1yr_p1_core_dead "S P1 Core within 1 year of R's death"
tab s_1yr_p1_core_dead , missing

//categorical variable for interview timing from r's death
gen days_p1_core_dod_cat = .
replace days_p1_core_dod_cat = 0 if 0<=days_p1_core_dead & days_p1_core_dead<183
replace days_p1_core_dod_cat = 1 if 183<=days_p1_core_dead & days_p1_core_dead<366
replace days_p1_core_dod_cat = 2 if 366<=days_p1_core_dead & days_p1_core_dead<548
replace days_p1_core_dod_cat = 3 if 548<=days_p1_core_dead & days_p1_core_dead<731
replace days_p1_core_dod_cat = 4 if 731<=days_p1_core_dead & days_p1_core_dead !=.
la def days_p1_core_dod_cat 0 "0-6 months" 1 "6-12 months" 2 "12-18 months" ///
3 "18-24 months" 4 "24+ months"
la var days_p1_core_dod_cat "Days from R death to p1 interview, categorical"
la val days_p1_core_dod_cat days_p1_core_dod_cat 
tab days_p1_core_dod_cat , missing

//create associated indicator variables
gen byte days_p1_core_dod_lt6m = 0
replace days_p1_core_dod_lt6m = 1 if days_p1_core_dod_cat == 0
gen byte days_p1_core_dod_6_12m = 0
replace days_p1_core_dod_6_12m = 1 if days_p1_core_dod_cat == 1
gen byte days_p1_core_dod_12_18m = 0
replace days_p1_core_dod_12_18m = 1 if days_p1_core_dod_cat == 2
gen byte days_p1_core_dod_18_24m = 0
replace days_p1_core_dod_18_24m = 1 if days_p1_core_dod_cat == 3
gen byte days_p1_core_dod_gt2yr = 0
replace days_p1_core_dod_gt2yr = 1 if days_p1_core_dod_cat == 4

gen byte days_p1_core_dod_gt18mo = 0
replace days_p1_core_dod_gt18mo = 1 if inlist(days_p1_core_dod_cat,3,4)

la var days_p1_core_dod_lt6m "R death to P1 ivw lt 6m"
la var days_p1_core_dod_6_12m "R death to P1 ivw 6-12m"
la var days_p1_core_dod_12_18m "R death to P1 ivw 12-18m"
la var days_p1_core_dod_18_24m "R death to P1 ivw 18-24m"
la var days_p1_core_dod_gt2yr "R death to P1 ivw gt 2yr"
la var days_p1_core_dod_gt18mo "R death to P1 ivw gt 18m"

foreach v in days_p1_core_dod_lt6m days_p1_core_dod_6_12m days_p1_core_dod_12_18m ///
	days_p1_core_dod_18_24m days_p1_core_dod_gt2yr days_p1_core_dod_gt18mo {
	replace `v'=. if days_p1_core_dod_cat==.
	tab `v', missing
	}

//r's death year variable
gen r_death_year = year(r_death_date_e)
tab r_death_year , missing
la def year 2001 "2001" 2002 "2002" 2003 "2003" 2004 "2004" 2005 "2005" ///
2006 "2006" 2007 "2007" 2008 "2008" 2009 "2009" 2010 "2010"
la val r_death_year year 

//additional value labels added for spouse new variables
la def help_hours 0 "None" 1 "lt 100 hours" 2 "101-200 hours" 3 "gt 200 hours", replace
la val s_help_friends_hours_n1 s_help_friends_hours_p1 help_hours

la def soc_visit_cat 0 "None or almost never" 1 "Less than 1xper week" ///
2 "Between 1x per day up to 1x per week" 3 "At least 1x per day"
la val s_soc_visit_cat_n1 s_soc_visit_cat_n2 soc_visit_cat

label def decmaker 0 "N/A No EOL care decision made" 1 "Patient" ///
     2 "Spouse or Partner or Exit Int Proxy" ///
     3 "Child/Child-in-law/Grandchild" 4 "Other Relative" 5 "Friend" ///
     6 "Physician/Health Care Provider" 7 "Minister/Rabbi/Priest" ///
     8 "Other" 9 "Don't Know/Refused", modify
la val  r_decmaker_x decmaker

//additional variable labels for r variables
la var r_srh_pf_n1 "R Self rated health fair or poor"

//create missing category for advanced directive variable
tab r_advdir_x , missing
replace r_advdir_x = 2 if r_advdir_x == .
la def r_advdir_x 0 "No" 1 "Yes" 2 "Unknown"
la val r_advdir_x r_advdir_x 
tab r_advdir_x , missing
gen r_advdir_y = 0
replace r_advdir_y = 1 if r_advdir_x ==1
gen r_advdir_n = 0
replace r_advdir_n = 1 if r_advdir_x ==0
gen r_advdir_miss = 0
replace r_advdir_miss = 1 if r_advdir_x ==2
la var r_advdir_y "R advance directive x interview"
la var r_advdir_n "R no advance directive x interview"
la var r_advdir_miss "R advance directive status unknown x interview"
tab r_advdir_y 
tab r_advdir_n
tab r_advdir_miss

//if don't know, discussion of eol care preferences needs to be coded as missing
replace r_discuss_x=. if r_discuss_x==9
tab r_discuss_x, missing

save spouse_data_sample_v1.dta, replace

//create a copy of the dataset with the restricted variables dropped
//direct from restricted interviews
drop *_e zip*

//from exit ivw dataset
drop r_e_ivw_day_x r_e_ivw_month_x r_e_ivw_year_x r_e_ivw_date_x ///
 s_e_ivw_day_x s_e_ivw_month_x s_e_ivw_year_x s_e_ivw_date_x 

//other interview dates 
drop r_c_ivw_month_n1 r_c_ivw_day_n1 r_c_ivw_year_n1 r_c_ivw_day_imp_n1 r_c_ivw_date_n1 ///
 r_c_ivw_month_n2 r_c_ivw_day_n2 r_c_ivw_year_n2 r_c_ivw_day_imp_n2 r_c_ivw_date_n2  r_c_ivw_date_n3 ///
 s_c_ivw_month_n1 s_c_ivw_day_n1 s_c_ivw_year_n1 s_c_ivw_day_imp_n1 s_c_ivw_date_n1 ///
 s_c_ivw_month_n2 s_c_ivw_day_n2 s_c_ivw_year_n2 s_c_ivw_day_imp_n2 s_c_ivw_date_n2 s_c_ivw_date_n3 ///
 s_c_ivw_month_p1 s_c_ivw_day_p1 s_c_ivw_year_p1 s_c_ivw_day_imp_p1 s_c_ivw_date_p1

save spouse_data_sample_public.dta, replace

log close


H="Check difference in s proxy interviews"
/*Prior to dropping those observations without full CESD interviews
do a check of spouse characteristics of those with
proxy interviews as a robustness check

Find that we have higher rates of memory disease and 
psychiatric conditions for spouses that have interview by proxy */

capture log close

clear all
set mem 500m
set more off

//Amy's PC
local logpath E:\data\spouse\logs
local datapath E:\data\spouse\final_data

log using "`logpath'\3-HRS_Spouse_Proxy_Diff.txt", text replace

cd `datapath'

use spouse_data_sample_v1.dta if (p1_wi_90d==0 & no_el_comorb_12m==0 & sudden_cause_death==0)
//use spouse_data_sample_public.dta if (p1_wi_90d==0 & no_el_comorb_12m==0 & sudden_cause_death==0)
******************************************************************
******************************************************************
//create a table of spouse characteristics
//checking if those with proxy interviews are different from
//those with regular interviews (b/c cesd missing if proxy)
******************************************************************
******************************************************************
tab proxy_n1_or_p1, missing
tab proxy_n1_and_p1, missing
gen no_proxy=1
replace no_proxy=0 if proxy_n1_or_p1
la var proxy_n1_or_p1 "At least 1 proxy interview n1 or p1"
tab no_proxy proxy_n1_or_p1, missing

local sdemovar3 s_female s_white_e s_hseduc_n1_n3 ///
s_medicaid_n1 s_srh_pf_n1 s_smoke_curr_n1 s_alcohol_mis_n1 ///
s_vig_phy_act_n1 s_hrs_comorb_none_n1 s_hrs_comorb_mild_n1 ///
s_hrs_comorb_mod_n1 s_hrs_comorb_sev_n1 ///
 s_cancer_hrs_n1 s_lung_hrs_n1 s_heart_hrs_n1 s_chf_hrs_n1 ///
s_stroke_hrs_n1 s_memory_hrs_n1  s_htn_hrs_n1 s_dm_hrs_n1 s_psych_hrs_n1 ///
s_cancer_hrs_p1 s_lung_hrs_p1 s_heart_hrs_p1 s_chf_hrs_p1 ///
s_stroke_hrs_p1 s_memory_hrs_p1  s_htn_hrs_p1 s_dm_hrs_p1 s_psych_hrs_p1 s_1yr_p1_core_dead

mat sdemo2=J(34,3,.)

//first row, n of hospice and non-hospice
tab proxy_n1_or_p1, missing matcell(sd1)
mat sdemo2[1,1]=sd1[2,1] //no proxy ivw n
mat sdemo2[1,2]=sd1[1,1] //proxy ivw n

local j=1
foreach h in proxy_n1_or_p1 no_proxy {
sum s_age if `h'==1, detail //age
mat sdemo2[2,`j']=r(mean)
mat sdemo2[3,`j']=r(sd)
local i=4
foreach v in `sdemovar3' {
	sum `v' if `h'==1, detail 
	mat sdemo2[`i',`j']=r(mean)*100
	local i=`i'+1 //populates rows 4-34
	}
local j=`j'+1
}

//p-values
ttest s_age, by(proxy_n1_or_p1) //age
mat sdemo2[2,3]=r(p)
local i=4
foreach v in `sdemovar3' {
	tab proxy_n1_or_p1 `v', row chi2 
	mat sdemo2[`i',3]=r(p)
	local i=`i'+1 //populates rows 4-34
	}

mat rownames sdemo2 ="Sample size n" "Age at r's death, mean" "SD" "Female" "Non-Hispanic White" ///
"Education, High school grad" "Medicaid" "SRH poor or fair" ///
"Currently smoker" "Alcohol mis-use" "Vigorous physical activity" ///
"Comorbidity index - none" "Mild (1-3)" "Moderate (4-6)" "Severe (7+)" ///
"Cancer n1" "Lung disease n1" "Heart disease n1" "CHF n1" "Stroke / TIA n1" ///
"Memory disease n1" "Hypertension n1" "Diabetes n1" "Psychiatric condition n1" ///
"Cancer p1" "Lung disease p1" "Heart disease p1" "CHF p1" "Stroke / TIA p1" ///
"Memory disease p1" "Hypertension p1" "Diabetes p1" "Psychiatric condition p1" ///
"p1 ivw wi 1 year of R death"

mat list sdemo2

frmttable using `logpath'\spo_proxy_check, statmat(sdemo2) ///
title("Unweighted sample - Spouse characteristics - proxy interviews") ///
ctitle("","Proxy Interview","Self Interview","P-value") ///
sdec(2,2,3) replace

log close

H="Sum stats, unmatched"
/*This Stata code creates clean variables and outputs
tables to the file logs\spo_initial_tables.doc

It also defines the variables that are used to create the propensity score
matched sample in the global "matchvars"
 */


capture log close

clear all
set mem 500m
set more off

//Amy's PC
local logpath E:\data\spouse\logs
local datapath E:\data\spouse\final_data

log using "`logpath'\4-HRS_Spouse_sum_stats_tables.txt", text replace

cd `datapath'

//n=907
use spouse_data_sample_v1.dta if (p1_wi_90d==0 & no_cc_12m_excl_cataract==0 & sudden_cause_death==0 & cesd_miss_n1_p1==0 )

tab r_hs_12m_gt3d, missing

//n=907, keep 1-2 day hospice use for tables (KO email 4/11)
//n=856, excluding those with 1-2 days hospice use
//drop if r_hs_12m_gt3d==.

***************************************************************************************
** User Note: If want to change the list of variables used in propensity score matching
** for the next few sections, change it here
***************************************************************************************
//rg modified list
//uses net worth quartiles, high is omitted category
//uses count of cc's, excluding glaucoma and cataract for number of chronic conditions
//does not include variabes that are highly correlated ( only uses s_ age, white, hs educ, not r_)
//does not include regional variables, region should not matter!
global matchvars cc_all_count_12m_2 cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y r_advdir_miss r_discuss_x r_srh_pf_n1 ///
s_age s_female s_white_e  s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1	

//drop observations with missing covariates (22 obs)
//n=885
foreach v of varlist $matchvars {
tab `v', missing
drop if `v'==.
}

gen byte non_hosp=.
replace non_hosp=1 if r_hs_12m==0
replace non_hosp=0 if r_hs_12m==1
tab non_hosp r_hs_12m, missing

//save this n=818 dataset, this is the starting point for all final tables
save spouse_data_sample_v2.dta, replace

sum r_age, detail

//just verifies original age variable, its right
gen age2 =  (r_death_date_e - r_birth_date_e)/365
sum age2, detail

sum r_female
sca sample_N=r(N) //defines full sample size N for tables
tab r_female, missing
tab r_hseduc, missing

tab r_hisp_eth_e, missing
tab r_white_e, missing
tab r_black_e, missing
tab r_other_na_api_race_e, missing

sum r_networth_adj2010_n1, detail

tab r_nhres_n1, missing

tab r_imprelig_vimp_n1, missing

tab r_adl_cat_core_n1, missing
tab r_adl_cat_core_n2, missing

tab r_adl_stable_partial_n1n2, missing

//hospital death
tab r_location_x r_loc_hosp_x, missing



******************************************************************
******************************************************************
//create a table of decedent characteristics
******************************************************************
******************************************************************
local t1vars r_medicaid_n1 r_nhres_n1 r_nhres_x r_advdir_y r_advdir_n ///
r_advdir_miss r_adl_stable_ind_n1n2 ///
r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 r_adl_change_i_m_n1n2 ///
r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss cc_3_alzhdmta_n12mn0 ///
cc_6_chrnkidn_n12mn0 cc_12_ischmcht_n12mn0 cc_8_chf_n12mn0 ///
cc_9_diabetes_n12mn0 cc_7_copd_n12mn0 cc_16_strketia_n12mn0 ///
cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 cc_11_hipfrac_n12mn0 ///
cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 cc_15_ra_oa_n12mn0 

sum r_age, detail


mat demo=J(42,3,.)

//first row, n of hospice users and non-users
tab r_hs_12m, missing matcell(d1)
mat demo[1,1]=d1[2,1] //non-hospice n
mat demo[1,2]=d1[1,1] //hospice users n

local j=1
foreach h in r_hs_12m non_hosp {
sum r_age if `h'==1, detail //age
mat demo[2,`j']=r(mean)
mat demo[3,`j']=r(sd)
sum r_female if `h'==1, detail //female
mat demo[4,`j']=r(mean)*100
sum r_white_e if `h'==1, detail //non-hispanic, white
mat demo[5,`j']=r(mean)*100
sum r_hseduc_n1_n3 if `h'==1, detail //hs education+
mat demo[6,`j']=r(mean)*100
sum r_networth_adj2010_n1 if `h'==1, detail //net worth
mat demo[7,`j']=r(mean)
mat demo[8,`j']=r(sd)
local i=9
foreach v in `t1vars' {
	sum `v' if `h'==1, detail 
	mat demo[`i',`j']=r(mean)*100
	local i=`i'+1 //populates rows 9-34
	}
sum cc_all_count_12m_2 if `h'==1, detail //count of chronic conditions
mat demo[35,`j']=r(mean)
mat demo[36,`j']=r(sd)
sum hospital_beds if `h'==1, detail //hospital beds
mat demo[37,`j']=r(mean)
mat demo[38,`j']=r(sd)
sum medical_specialists if `h'==1, detail //medical specialists
mat demo[39,`j']=r(mean)
mat demo[40,`j']=r(sd)
sum hci_index if `h'==1, detail //hci index
mat demo[41,`j']=r(mean)
mat demo[42,`j']=r(sd)
local j=`j'+1
}

//pvalues
logit r_hs_12m r_age
test r_age
mat demo[2,3]=r(p) //p value from t-test
local j=4
foreach v in r_female r_white_e r_hseduc_n1_n3{
	logit r_hs_12m `v' 
	test `v'
	mat demo[`j',3]=r(p) //p value from chisq test
	local j = `j'+1 //rows 4-6
}
logit r_hs_12m r_networth_adj2010_n1
test r_networth_adj2010_n1
mat demo[7,3]=r(p) //p value from t-test
local j=9
foreach v in `t1vars' {
	logit r_hs_12m `v'
	test `v' 
	mat demo[`j',3]=r(p)
	local j=`j'+1 //populates rows 9-34
}
local j=35
foreach v in cc_all_count_12m_2 hospital_beds medical_specialists hci_index{
	logit r_hs_12m `v'
	test `v'
	mat demo[`j',3]=r(p) //p value from t-test
	local j=`j'+2 //rows 35-41
}

mat rownames demo ="Sample n" "Age at death, years, mean" "SD" "Female, %" "Race, Non-Hispanic White, %" ///
"Education, High School Grad" "Net worth, 2010US$, mean" "SD" "Medicaid, %" ///
"Nursing home resident n1, %" "Nursing home resident exit" "Had advance directive" ///
"Did not have advance directive" "Advance directive status unknown" ///
"Stable, Indep in ADLs n2 to n1" ///
"Stable, Moderate 1-3 ADL" "Stable, Severe 4-6 ADL" ///
"Declined, Indep to Moderate" "Declined, Moderate to Severe" ///
"Declined, Independent to Severe" "Unknown" "Alzheimers/Dementia" "Chronic Kidney Disease" ///
"Ischemic Heart Disease" "Congestive Heart Failure" "Diabetes" "COPD" ///
"Stroke or TIA" "Cancer" "Atrial Fibrillation" "Hip Fracture" "Depression" "Osteoporosis" ///
"Arthritis" "Count of chronic conditions" "SD" "Hosp beds per 10,000 res, mean" "SD" ///
"Specialists per 100,000, mean" "SD" "HCI index, mean" "SD"

mat list demo

frmttable using `logpath'\spo_initial_tables, statmat(demo) ///
title("Unweighted Sample - Decedent characteristics") ///
ctitle("","Hospice users","Non-hospice users","P-value") ///
sdec(2,2,3) replace

******************************************************************
******************************************************************
//create a table of spouse characteristics
******************************************************************
******************************************************************

local sdemovar1 s_female s_white_e s_hseduc_n1_n3 ///
s_medicaid_n1 s_srh_pf_n1 s_smoke_curr_n1 s_alcohol_mis_n1 ///
s_vig_phy_act_n1 s_hrs_comorb_none_n1 s_hrs_comorb_mild_n1 ///
s_hrs_comorb_mod_n1 s_cancer_hrs_n1 ///
s_lung_hrs_n1 s_heart_hrs_n1 s_chf_hrs_n1 s_stroke_hrs_n1 ///
s_memory_hrs_n1 s_htn_hrs_n1 s_dm_hrs_n1 s_psych_hrs_n1 

local sdemovar2 s_cesd_tot_ge3_n1 ///
s_cesd_tot_ge3_p1 s_cesd_ge3better s_cesdbetter s_cesdsame s_cesdworse 

local sdemovar3 days_p1_core_dod_lt6m days_p1_core_dod_6_12m days_p1_core_dod_12_18m ///
	days_p1_core_dod_18_24m days_p1_core_dod_gt2yr 

mat sdemo=J(40,3,.)

//first row, n of hospice and non-hospice
tab r_hs_12m, missing matcell(sd1)
mat sdemo[1,1]=sd1[2,1] //non-hospice n
mat sdemo[1,2]=sd1[1,1] //hospice users n

local j=1
foreach h in r_hs_12m non_hosp {
sum s_age if `h'==1, detail //age
mat sdemo[2,`j']=r(mean)
mat sdemo[3,`j']=r(sd)
local i=4
foreach v in `sdemovar1' {
	sum `v' if `h'==1, detail 
	mat sdemo[`i',`j']=r(mean)*100
	local i=`i'+1 //populates rows 4-23
	}
sum s_cesd_tot_n1 if `h'==1, detail //cesd score n1
mat sdemo[24,`j']=r(mean)
sum s_cesd_tot_p1 if `h'==1, detail //cesd score p1
mat sdemo[25,`j']=r(mean)
sum s_cesdchange if `h'==1, detail //cesd score change n1 to p1
mat sdemo[26,`j']=r(mean)
local i=27
foreach v in `sdemovar2' {
	sum `v' if `h'==1, detail 
	mat sdemo[`i',`j']=r(mean)*100
	local i=`i'+1 //populates rows 27-32
	}
sum days_p1_core_dead if `h'==1, detail //days to p1 ivw
mat sdemo[33,`j']=r(mean)
mat sdemo[34,`j']=r(sd)
sum s_1yr_p1_core_dead if `h'==1, detail
mat sdemo[35,`j']=r(mean)*100
local i=36
foreach v in `sdemovar3' {
	sum `v' if `h'==1, detail 
	mat sdemo[`i',`j']=r(mean)*100
	local i=`i'+1 //populates rows 36-40
	}
local j=`j'+1
}

//p-values
logit r_hs_12m s_age
test s_age
mat sdemo[2,3]=r(p)
local i=4
foreach v in `sdemovar1' {
	logit r_hs_12m `v'
	test `v'
	mat sdemo[`i',3]=r(p)
	local i=`i'+1 //populates rows 4-23
	}
local i=24
foreach v in s_cesd_tot_n1 s_cesd_tot_p1 s_cesdchange{
	logit r_hs_12m `v'
	test `v'
	mat sdemo[`i',3]=r(p)
	local i=`i'+1 //populates rows 24-26
	}
local i=27
foreach v in `sdemovar2' {
	logit r_hs_12m `v'
	test `v'
	mat sdemo[`i',3]=r(p)
	local i=`i'+1 //populates rows 27-32
}
logit r_hs_12m days_p1_core_dead //days to p1 ivw
test days_p1_core_dead 
mat sdemo[33,`j']=r(p)
logit r_hs_12m s_1yr_p1_core_dead //p1 1 yr of death
test s_1yr_p1_core_dead 
mat sdemo[35,3]=r(p)
local i=36
foreach v in `sdemovar3' {
	logit r_hs_12m `v' 
	test `v'
	mat sdemo[`i',3]=r(p)
	local i=`i'+1 //populates rows 36-40
}

//can't do logit to get test for alchool misuse because no obs in hs group have it
tab s_alcohol_mis_n1 r_hs_12m, row chi2
mat sdemo[10,3]=r(p)

mat rownames sdemo ="Sample size n" "Age at r's death, mean" "SD" "Female" "Non-Hispanic White" ///
"Education, High school grad" "Medicaid" "SRH poor or fair" ///
"Currently smoker" "Alcohol mis-use" "Vigorous physical activity" ///
"Comorbidity index - none" "Mild (1-3)" "Moderate (4-6)" ///
"Cancer" "Lung disease" "Heart disease" "CHF" "Stroke" "Memory disease" ///
"Hypertension" "Diabetes" "Psychological problems" ///
"CESD-D raw score n1, mean" "CESD-D raw score p1, mean" "Change in raw CESD n1 to p1" ///
"Clinical depression pre death" "Clinical depression post death" ///
 "Clin depr n1 but no p1" "CESD Improved post death" ///
"Same CESD post death" "CESD Declined post death" "Days R DOD to S P1 ivw" ///
"SD" "P1 ivw wi 1 year of death" "R DOD to P1 ivw 3-6m" "R DOD to P1 ivw 6-12m" ///
 "R DOD to P1 ivw 12-18m"  "R DOD to P1 ivw 18-24m"  "R DOD to P1 ivw 2yr+"

mat list sdemo

frmttable using `logpath'\spo_initial_tables, statmat(sdemo) ///
title("Unweighted sample - Spouse characteristics") ///
ctitle("","Hospice users","Non-hospice users","P-value") ///
sdec(2,2,3) addtable

******************************************************************
******************************************************************
//Additional spouse table of new variables re. 
//depressive symptoms
//note !!last time I manually added in total n for categorical variables!!!
******************************************************************
******************************************************************
local spdepr1 s_psych_hrs_n1 s_psych_hrs_p1 s_psych_imp_n1p1 s_psych_worse_n1p1 ///
s_psych_same_n1p1 s_psych_treat_n1 s_psych_treat_p1 s_psych_treat_imp_n1p1 s_psych_treat_worse_n1p1 ///
s_psych_treat_same_n1p1 s_psych_med_n1 s_psych_med_p1 s_psych_med_imp_n1p1 ///
s_psych_med_worse_n1p1 s_psych_med_same_n1p1 s_psych_overall_hrs_n1 s_psych_overall_hrs_p1 ///
s_psych_oa_imp_n1p1 s_psych_oa_worse_n1p1 s_psych_oa_same_n1p1 s_ever_drink_n1 s_ever_drink_p1 ///
s_ever_drink_imp_n1p1 s_ever_drink_worse_n1p1 s_ever_drink_same_n1p1 

local spdepr1a s_drink_more_n1p1 s_drink_less_n1p1 s_drink_same_n1p1 ///
s_alcohol_mis_n1 s_alcohol_mis_p1 s_alcoh_mis_imp_n1p1 s_alcoh_mis_worse_n1p1 ///
s_alcoh_mis_same_n1p1 s_vig_phy_act_n1 s_vig_phy_act_p1 s_vig_act_imp_n1p1 ///
s_vig_act_worse_n1p1 s_vig_act_same_n1p1 s_help_friends_n1 s_help_friends_p1 ///
s_help_friends_imp_n1p1 s_help_friends_worse_n1p1 s_help_friends_same_n1p1 

local spdepr2 s_help_friends_hrs_more_n1p1 s_help_friends_hrs_less_n1p1 s_help_friends_hrs_same_n1p1 ///
s_friend_n1 s_friend_p1 s_friend_imp_n1p1 s_friend_worse_n1p1 s_friend_same_n1p1 ///
s_soc_visit_n1 s_soc_visit_p1 s_soc_visit_imp_n1p1 s_soc_visit_worse_n1p1 s_soc_visit_same_n1p1

local spdepr3 s_soc_visit_cnt_more_n1p1 s_soc_visit_cnt_less_n1p1 s_soc_visit_cnt_same_n1p1 ///
r_adl_sp_helper_n1 r_adl_sp_helper_x r_adl_oth_helper_n1 r_adl_oth_helper_x /// 

local spdepr4 adl_help_sp_more_n1x adl_help_sp_less_n1x adl_help_sp_same_n1x ///
adl_help_oth_more_n1x adl_help_oth_less_n1x adl_help_oth_same_n1x adl_help_count_more_n1x ///
adl_help_count_less_n1x adl_help_count_same_n1x r_iadl_sp_helper_n1 r_iadl_sp_helper_x ///
r_iadl_oth_helper_n1 r_iadl_oth_helper_x 

local spdepr5 iadl_help_sp_more_n1x iadl_help_sp_less_n1x iadl_help_sp_same_n1x ///
iadl_help_oth_more_n1x iadl_help_oth_less_n1x iadl_help_oth_same_n1x iadl_help_count_more_n1x ///
iadl_help_count_less_n1x iadl_help_count_same_n1x ///
r_hh_worker_n1 r_hh_worker_x r_lwill_x r_lw_all_x r_lw_lim_x r_lw_whld_x ///
r_lw_comf_x r_adapp_x r_adprob_x r_hcp_x r_discuss_x r_eoldec_x ///
r_capacity_x 

local spdepr6 r_dec_all_x r_dec_lim_x r_dec_whld_x r_dec_comf_x 

mat sp_new_vars=J(135,5,.)
//first row, n for hospice and non-hospice
tab r_hs_12m, missing matcell(sd2)
mat sp_new_vars[1,1]=sd2[2,1] //hospice users n
mat sp_new_vars[1,3]=sd2[1,1] //non-hospice n

tab s_alcohol_mis_n1 if r_hs_12m==1, missing
tab s_alcohol_mis_p1 if r_hs_12m==1, missing


local j=1
foreach h in r_hs_12m non_hosp {
local i=2
foreach v in `spdepr1' {
	sum `v' if `h'==1, detail 
	mat sp_new_vars[`i',`j']=r(N)
	mat sp_new_vars[`i',`j'+1]=r(mean)*100
	local i=`i'+1 //populates rows 2-26 (25)
	}
sum s_n_drinks_3m_n1  if `h'==1, detail 	
	mat sp_new_vars[27,`j']=r(N)
	mat sp_new_vars[27,`j'+1]=r(mean)
sum s_n_drinks_3m_p1  if `h'==1, detail 	
	mat sp_new_vars[28,`j']=r(N)
	mat sp_new_vars[28,`j'+1]=r(mean)
local i=29
foreach v in `spdepr1a' {
	sum `v' if `h'==1, detail 
	mat sp_new_vars[`i',`j']=r(N)
	mat sp_new_vars[`i',`j'+1]=r(mean)*100
	local i=`i'+1 //populates rows 29-46 (18)
	}	
tab s_help_friends_hours_n1 if `h'==1, missing matcell(nv1)
local r=1
forvalues k=47/50{
	mat sp_new_vars[`k',`j']=nv1[`r',1] //var=0 n
	mat sp_new_vars[`k',`j'+1]=nv1[`r',1]/r(N) *100 //pct
	local r=`r'+1
}
tab s_help_friends_hours_p1 if `h'==1, missing matcell(nv2)
local r=1
forvalues k=51/54{
	mat sp_new_vars[`k',`j']=nv2[`r',1] //var=0 n
	mat sp_new_vars[`k',`j'+1]=nv2[`r',1]/r(N) *100 //pct
	local r=`r'+1
}
local i=55
foreach v in `spdepr2' {
	sum `v' if `h'==1, detail 
	mat sp_new_vars[`i',`j']=r(N)
	mat sp_new_vars[`i',`j'+1]=r(mean)*100
	local i=`i'+1 //populates rows 55-67 (13)
	}
tab s_soc_visit_cat_n1 if `h'==1, missing matcell(nv3)
local r=1
forvalues k=68/71{
	mat sp_new_vars[`k',`j']=nv3[`r',1] //var=0 n
	mat sp_new_vars[`k',`j'+1]=nv3[`r',1]/r(N) *100 //pct
	local r=`r'+1
}
tab s_soc_visit_cat_p1 if `h'==1, missing matcell(nv4)
local r=1
forvalues k=72/75{
	mat sp_new_vars[`k',`j']=nv4[`r',1] //var=0 n
	mat sp_new_vars[`k',`j'+1]=nv4[`r',1]/r(N) *100 //pct
	local r=`r'+1
}
local i=76
foreach v in `spdepr3' {
	sum `v' if `h'==1, detail 
	mat sp_new_vars[`i',`j']=r(N)
	mat sp_new_vars[`i',`j'+1]=r(mean)*100
	local i=`i'+1 //populates rows 76-82 (7)
	}
sum r_adl_helper_count_n1  if `h'==1, detail 	
	mat sp_new_vars[83,`j']=r(N)
	mat sp_new_vars[83,`j'+1]=r(mean)
sum r_adl_helper_count_x  if `h'==1, detail 	
	mat sp_new_vars[84,`j']=r(N)
	mat sp_new_vars[84,`j'+1]=r(mean)	
local i=85
foreach v in `spdepr4' {
	sum `v' if `h'==1, detail 
	mat sp_new_vars[`i',`j']=r(N)
	mat sp_new_vars[`i',`j'+1]=r(mean)*100
	local i=`i'+1 //populates rows 85-97 (13)
	}
sum r_iadl_helper_count_n1  if `h'==1, detail 	
	mat sp_new_vars[98,`j']=r(N)
	mat sp_new_vars[98,`j'+1]=r(mean)
sum r_iadl_helper_count_x  if `h'==1, detail 	
	mat sp_new_vars[99,`j']=r(N)
	mat sp_new_vars[99,`j'+1]=r(mean)
local i=100
foreach v in `spdepr5' {
	sum `v' if `h'==1, detail 
	mat sp_new_vars[`i',`j']=r(N)
	mat sp_new_vars[`i',`j'+1]=r(mean)*100
	local i=`i'+1 //populates rows 100-121 (22)
	}	
tab r_decmaker_x if `h'==1, missing matcell(nv5)
local r=1
forvalues k=122/131{
	mat sp_new_vars[`k',`j']=nv5[`r',1] //var=0 n
	mat sp_new_vars[`k',`j'+1]=nv5[`r',1]/r(N) *100 //pct
	local r=`r'+1
}
local i=132
foreach v in `spdepr6' {
	sum `v' if `h'==1, detail 
	mat sp_new_vars[`i',`j']=r(N)
	mat sp_new_vars[`i',`j'+1]=r(mean)*100
	local i=`i'+1 //populates rows 132-135 (4)
	}
local j=`j'+2
}

//pvalues
local i=2
tab r_hs_12m s_psych_hrs_n1 , row chi
mat sp_new_vars[2,5]=r(p) //p value from chisq test
tab r_hs_12m s_psych_hrs_p1 , row chi
mat sp_new_vars[3,5]=r(p) //p value from chisq test

tab  s_psych_cat_n1p1 r_hs_12m, chi2
mat sp_new_vars[4,5]=r(p)

tab r_hs_12m s_psych_treat_n1, row chi
mat sp_new_vars[7,5]=r(p) //p value from chisq test
tab r_hs_12m s_psych_treat_p1, row chi
mat sp_new_vars[8,5]=r(p) //p value from chisq test

tab  s_psych_treat_cat_n1p1 r_hs_12m, chi2
mat sp_new_vars[9,5]=r(p)

tab r_hs_12m s_psych_med_n1, row chi
mat sp_new_vars[12,5]=r(p) //p value from chisq test
tab r_hs_12m s_psych_med_p1, row chi
mat sp_new_vars[13,5]=r(p) //p value from chisq test

tab  s_psych_med_cat_n1p1 r_hs_12m, chi2
mat sp_new_vars[14,5]=r(p)

tab r_hs_12m s_psych_overall_hrs_n1, row chi
mat sp_new_vars[17,5]=r(p) //p value from chisq test
tab r_hs_12m s_psych_overall_hrs_p1, row chi
mat sp_new_vars[18,5]=r(p) //p value from chisq test

tab  s_psych_oa_cat_n1p1 r_hs_12m, chi2
mat sp_new_vars[19,5]=r(p)

tab r_hs_12m s_ever_drink_n1, row chi
mat sp_new_vars[22,5]=r(p) //p value from chisq test
tab r_hs_12m s_ever_drink_p1, row chi
mat sp_new_vars[23,5]=r(p) //p value from chisq test

tab  s_ever_drink_cat_n1p1 r_hs_12m, chi2
mat sp_new_vars[24,5]=r(p)

ttest s_n_drinks_3m_n1, by(r_hs_12m)
mat sp_new_vars[27,5]=r(p) //p value from t-test
ttest s_n_drinks_3m_p1, by(r_hs_12m)
mat sp_new_vars[28,5]=r(p) //p value from t-test

tab s_drink_cat_n1p1 r_hs_12m, chi2
mat sp_new_vars[29,5]=r(p)

tab r_hs_12m s_alcohol_mis_n1, row chi
mat sp_new_vars[32,5]=r(p) //p value from chisq test
tab r_hs_12m s_alcohol_mis_p1, row chi
mat sp_new_vars[33,5]=r(p) //p value from chisq test

tab  s_alcoh_mis_cat_n1p1 r_hs_12m, chi2
mat sp_new_vars[34,5]=r(p)

tab r_hs_12m s_vig_phy_act_n1, row chi
mat sp_new_vars[37,5]=r(p) //p value from chisq test
tab r_hs_12m s_vig_phy_act_p1, row chi
mat sp_new_vars[38,5]=r(p) //p value from chisq test

tab  s_vig_act_cat_n1p1 r_hs_12m, chi2
mat sp_new_vars[39,5]=r(p)

tab r_hs_12m s_help_friends_n1, row chi
mat sp_new_vars[42,5]=r(p) //p value from chisq test
tab r_hs_12m s_help_friends_p1, row chi
mat sp_new_vars[43,5]=r(p) //p value from chisq test

tab  s_help_friends_cat_n1p1 r_hs_12m, chi2
mat sp_new_vars[44,5]=r(p)

tab  s_help_friends_hours_n1 r_hs_12m, chi2
mat sp_new_vars[47,5]=r(p)
tab  s_help_friends_hours_p1 r_hs_12m, chi2
mat sp_new_vars[51,5]=r(p)

tab  s_help_friends_hrs_cat_n1p1 r_hs_12m, chi2
mat sp_new_vars[55,5]=r(p)

tab r_hs_12m s_friend_n1 , row chi
mat sp_new_vars[58,5]=r(p) //p value from chisq test
tab r_hs_12m s_friend_p1 , row chi
mat sp_new_vars[59,5]=r(p) //p value from chisq test

tab  s_friend_cat_n1p1  r_hs_12m, chi2
mat sp_new_vars[60,5]=r(p)


tab r_hs_12m s_soc_visit_n1 , row chi
mat sp_new_vars[63,5]=r(p) //p value from chisq test
tab r_hs_12m s_soc_visit_p1 , row chi
mat sp_new_vars[64,5]=r(p) //p value from chisq test

tab  s_soc_visit_cat_n1p1  r_hs_12m, chi2
mat sp_new_vars[65,5]=r(p)

tab s_soc_visit_cat_n1 r_hs_12m, chi2
mat sp_new_vars[68,5]=r(p)
tab s_soc_visit_cat_p1 r_hs_12m, chi2
mat sp_new_vars[72,5]=r(p)

tab  s_soc_visit_cnt_cat_n1p1  r_hs_12m, chi2
mat sp_new_vars[76,5]=r(p)

tab r_hs_12m r_adl_sp_helper_n1 , row chi
mat sp_new_vars[79,5]=r(p) //p value from chisq test
tab r_hs_12m r_adl_sp_helper_x , row chi
mat sp_new_vars[80,5]=r(p) //p value from chisq test
tab r_hs_12m r_adl_oth_helper_n1 , row chi
mat sp_new_vars[81,5]=r(p) //p value from chisq test
tab r_hs_12m r_adl_oth_helper_x , row chi
mat sp_new_vars[82,5]=r(p) //p value from chisq test

ttest r_adl_helper_count_n1, by(r_hs_12m)
mat sp_new_vars[83,5]=r(p) //p value from t-test
ttest r_adl_helper_count_x, by(r_hs_12m)
mat sp_new_vars[84,5]=r(p) //p value from t-test

tab  adl_help_sp_cat_n1x r_hs_12m, chi2
mat sp_new_vars[85,5]=r(p)

tab  adl_help_oth_cat_n1x r_hs_12m, chi2
mat sp_new_vars[88,5]=r(p)

tab  adl_help_count_cat_n1x r_hs_12m, chi2
mat sp_new_vars[91,5]=r(p)

tab r_hs_12m r_adl_sp_helper_n1 , row chi
mat sp_new_vars[94,5]=r(p) //p value from chisq test
tab r_hs_12m r_adl_sp_helper_x , row chi
mat sp_new_vars[95,5]=r(p) //p value from chisq test
tab r_hs_12m r_adl_oth_helper_n1 , row chi
mat sp_new_vars[96,5]=r(p) //p value from chisq test
tab r_hs_12m r_adl_oth_helper_x , row chi
mat sp_new_vars[97,5]=r(p) //p value from chisq test

ttest r_adl_helper_count_n1, by(r_hs_12m)
mat sp_new_vars[98,5]=r(p) //p value from t-test
ttest r_adl_helper_count_x, by(r_hs_12m)
mat sp_new_vars[99,5]=r(p) //p value from t-test

tab  adl_help_sp_cat_n1x r_hs_12m, chi2
mat sp_new_vars[100,5]=r(p)

tab  adl_help_oth_cat_n1x r_hs_12m, chi2
mat sp_new_vars[103,5]=r(p)

tab  adl_help_count_cat_n1x r_hs_12m, chi2
mat sp_new_vars[106,5]=r(p)

local spdeprpval1 r_hh_worker_n1 r_hh_worker_x r_lwill_x r_lw_all_x r_lw_lim_x r_lw_whld_x ///
r_lw_comf_x r_adapp_x r_adprob_x r_hcp_x r_discuss_x r_eoldec_x ///
r_capacity_x 

local i=107
foreach v in `spdeprpval1 ' {
	tab r_hs_12m `v', row chi 
	mat sp_new_vars[`i',5]=r(p)
	local i=`i'+1 //populates rows 107-121
	}
tab r_decmaker_x r_hs_12m, chi2
mat sp_new_vars[122,5]=r(p)
local i=132
foreach v in `spdepr6' {
	tab r_hs_12m `v', row chi 
	mat sp_new_vars[`i',5]=r(p)
	local i=`i'+1 //populates rows 132-135
	}
	
mat rownames sp_new_vars ="Sample size n" "S Psychiatric Condition n1" "S Psychiatric Condition p1" ///
"S Psych Cond in n1 to none in p1" "S no psych cond n1 to yes in p1" "S no change n1 p1" ///  
"S Psychiatric Treatment n1" "S Psychiatric Treatment p1" ///
"S Psych treat in n1, none in p1" "S no psych treat n1, yes in p1" "S no change n1 p1" /// 
"S Psychiatric Medication n1" "S Psychiatric Medication p1" ///
"S Psych med in n1 to none in p1" "S no psych med n1 to yes in p1" "S no change n1 p1" ///
"S Psychiatric Overall Ind n1" "S Psychiatric Overall Ind p1" ///
"S OA Psych cond n1 to no p1" "S no oa psych cond n1 to yes p1" "S no change n1 p1" ///
"S Ever drink n1" "S Ever drink p1" "S drink n1 to doesn't drink p1" "S doesn't drink n1 to drink p1" ///
"S drink status same n1 p1" "S Number drinks n1"  ///
"S Number drinks p1" "S No drinks increased n1 to p1" "S No drinks decreased n1 to p1" ///
"S No drinks same n1 to p1" "S Alcohol misuse n1" "S Alcohol misuse p1" ///
"S Alcohol misuse n1 to none p1" "S no alcohol misuse n1 to yes p1" ///
"S Alcohol misuse same n1 to p1" "S Vig Physical Act n1" ///
"S Vig Physical Act p1" "S no Vig Phys act n1 to yes p1" "S Vig phys act n1 to none p1" ///
"S Vig Phys act same n1 to p1" "S Help Friends n1" "S Help Friends p1" ///
"S No help friends n1 to yes p1" "S Help friends n1 to no p1" "S Help friends same n1 p1" ///
 "S Help friends=none n1" ///
"S Help friends=<100 hours n1" "S Help friends=101-200 hours n1" "S Help friends=gt 200 hours n1"  ///
"S Help friends=none p1" "S Help friends=<100 hours p1" "S Help friends=101-200 hours p1" ///
"S Help friends=gt 200 hours p1" ///
"S Help friends more n1 to p1" "S Help friends less n1 to p1" "S help friends same n1 to p1" ///
"S Friends nearby n1" "S Friends nearby p1" "S no friends nearby n1, yes p1" ///
"S Friends nearby n1, no p1" "S friends nearby same n1 p1" ///
"S Social visits n1" "S Social visits p1" "S No social visits n1 to yes p1" "S Social visits n1 to none p1" ///
"S Social visits same n1 p1" "S Visits=none or almost never n1" "S Visits <1/week n1" "S Visits <1/day n1" ///
"S Visits gt 1/day n1" "S Visits=none or almost never p1" "S Visits <1/week p1" "S Visits <1/day p1" ///
"S Visits gt 1/day p1" "S More social visits n1 to p1" "S Fewer social visits n1 to p1" ///
"S Same social visits n1 to p1" ///
"R ADL Helper = S n1" "R ADL Helper = S x" "R ADL Helper = Other n1" ///
"R ADL Helper = Other x" "R Count ADL Helpers n1 (mean)" "R Count ADL Helpers x (mean)" ///
"R ADL Helper S no n1, yes x" "R ADL Helper yes S n1, no x" "R ADL Helper S no change" ///
"R ADL Helper Oth no n1, yes x" "R ADL Helper Oth yes  n1, no x" "R ADL Helper Oth no change" ///
"R more adl helpers n1 to x" "R fewer adl helpers n1 to x" ///
"R same adl helpers n1 to x" ///
"R IADL Helper = S n1" "R IADL Helper = S x" "R IADL Helper = Other n1" ///
"R IADL Helper = Other x" "R Count IADL Helpers n1 (mean)" "R Count IADL Helpers x (mean)" ///
"R IADL Helper S no n1, yes x" "R IADL Helper yes S n1, no x" "R IADL Helper S no change" ///
"R IADL Helper Oth no n1, yes x" "R IADL Helper Oth yes  n1, no x" "R IADL Helper Oth no change" ///
"R more iadl helpers n1 to x" "R fewer iadl helpers n1 to x" ///
"R same iadl helpers n1 to x" ///
"R HH Worker n1" "R HH Worker x" "R Living Will?" ///
"LW - All care possible" "LW - Limit some care" ///
"LW - Withhold some care" "LW - Focus on Comfort" "Advance directive was applicable" ///
"Trouble following AD" "Durable power of attorney" "Discussion of EOL care pref" ///
"EOL Care decisions made" "R able to participate in dec" "Decision maker = NA" ///
"Patient" "Spouse" "Child/Grandchild" "Other relative" "Friend" "Physician" "Minister/Rabbi/Priest" ///
"Other" "Don't know, Refused" "Decision - All care possible" "D - Limit some care" ///
"D Withhold some care" "D Focus on comfort"

mat list sp_new_vars

frmttable using `logpath'\spo_initial_tables, statmat(sp_new_vars) ///
title("Additional variables") ///
ctitle("","N - hospice", "Mean, %","N - non-hospice", "Mean, %", "P-value") ///
note("P values from chi squared statistics") ///
sdec(0,2,0,2,3) addtable


******************************************************************
******************************************************************
//create a table of interview timelines
******************************************************************
******************************************************************

local timevars r_days_n1_core_dead s_days_n1_core_dead ///
r_days_x_exit_dead days_p1_core_dead
mat ivwtime=J(4,2,.)
local i=1
foreach v in `timevars'{
	sum `v', detail
	mat ivwtime[`i',1]=r(mean)
	mat ivwtime[`i',2]=r(sd)
	local i=`i'+1
}

mat rownames ivwtime = "R's pre-death core interview" "S's pre-death core interview" ///
"R's exit interview" "S's post-death core interview"

frmttable using `logpath'\spo_initial_tables, statmat(ivwtime) ///
title("Interview timeline for decedent and spouse") ///
ctitle("","Mean, days","SD") ///
sdec(2,2) addtable
		

******************************************************************
******************************************************************
// Table of hospice, snf, hospital use last 24 months of life
// also includes regional controls
******************************************************************
******************************************************************
local hosp r_hs_12m hs_los_12m hs_los_12m_miss r_hs_12m_gt3d r_hs_12m_gt7d ///
r_hs_24m hs_los_24m hs_los_24m_miss ///
r_snf_24m snf_los_24m snf_los_24m_miss ///
r_ip_24m ip_los_24m ip_los_24m_miss r_loc_hosp_x ///
r_advdir_x hospital_beds medical_specialists

mat hosp_use=J(18,6,.)
local i=1
foreach v in `hosp'{
	sum `v', detail
	mat hosp_use[`i',1]=r(N) //N
	mat hosp_use[`i',2]=sample_N - r(N) //N missing
	mat hosp_use[`i',3]=r(mean) //mean
	mat hosp_use[`i',4]=r(p50) //median
	mat hosp_use[`i',5]=r(min) //min
	mat hosp_use[`i',6]=r(max) //max
	local i=`i'+1
}
mat rownames hosp_use = "Ind Any Hospice use last 12m" "Hospice LOS last 12m" ///
"Hospice LOS last 12m if LOS gt 0" "3+ Days Hospice use" "7+ Days Hospice use" ///
"Ind Hospice use last 24m" "Hospice LOS last 24m" ///
"Hospice LOS last 24m if LOS gt 0" "Ind SNF use last 24m" "SNF LOS last 24m" ///
"SNF LOS last 24m if LOS gt 0" "Ind IP adm last 24m" ///
"Hospital LOS last 24m" "Hospital LOS last 24m, LOS gt 0" ///
"Hospital death" "Advance directive" ///
"Hospital beds per 1,000 res" "Med specialists per 100,000 res" 

mat list hosp_use

frmttable using `logpath'\spo_initial_tables, statmat(hosp_use) ///
title("Service use last 2 years of life and regional vars") ///
ctitle("","N","N missing","Mean","Median","Min","Max") ///
sdec(0,0,2,0,0,0) addtable


******************************************************************
******************************************************************
// Tables of comorbidity / chronic conditions measures
******************************************************************
******************************************************************
local hcc cc_1_ami_n12mn0 cc_2_alzh_n12mn0 cc_3_alzhdmta_n12mn0 ///
cc_4_atrialfb_n12mn0 cc_5_cataract_n12mn0 cc_6_chrnkidn_n12mn0 ///
cc_7_copd_n12mn0 cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_10_glaucoma_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_12_ischmcht_n12mn0 cc_13_depressn_n12mn0 ///
cc_14_osteoprs_n12mn0 cc_15_ra_oa_n12mn0 cc_16_strketia_n12mn0 ///
cc_17_cncrbrst_n12mn0 cc_18_cncrclrc_n12mn0 cc_19_cncrprst_n12mn0 ///
cc_20_cncrlung_n12mn0 cc_21_cncrendm_n12mn0 cc_ami_isch_n12mn0 ///
cc_alzheim_n12mn0 cc_cncr_chronic_n12mn0

local elix comorb_1_0d_n12m comorb_2_0d_n12m comorb_3_0d_n12m comorb_4_0d_n12m ///
comorb_5_0d_n12m comorb_6_0d_n12m comorb_7_0d_n12m comorb_8_0d_n12m ///
comorb_9_0d_n12m comorb_10_0d_n12m comorb_11_0d_n12m comorb_12_0d_n12m ///
comorb_13_0d_n12m comorb_14_0d_n12m comorb_15_0d_n12m comorb_16_0d_n12m ///
comorb_17_0d_n12m comorb_18_0d_n12m comorb_19_0d_n12m comorb_20_0d_n12m ///
comorb_21_0d_n12m comorb_22_0d_n12m comorb_23_0d_n12m comorb_24_0d_n12m ///
comorb_25_0d_n12m comorb_26_0d_n12m comorb_27_0d_n12m comorb_28_0d_n12m ///
comorb_29_0d_n12m comorb_30_0d_n12m comorb_31_0d_n12m comorb_all_0d_n12m

mat hcc_mean=J(24,2,.)
local i=1
foreach v in `hcc'{
	sum `v'
	mat hcc_mean[`i',1]=r(mean)
	mat hcc_mean[`i',2]=r(N)
	local i=`i'+1
}

mat rownames hcc_mean ="AMI" "Alzheimer's" "Alzheimer's or Dementia" "Atrial Fibrillation" ///
"Cataract" "Chronic Kidney Disease" ///
"COPD" "CHF" "Diabetes" "Glaucoma" "Hip fracture" "Ischemic Heart Disease" "Depression" ///
"Osteoporosis" "Rheumatoid Arthritis" "Stroke" "Cancer - Breast" "Cancer - Colorectal" "Cancer - Prostate" ///
"Cancer - Lung" "Cancer - Endometrial" "AMI+ISCH" "Alzh + Dementia" "Cancer - any"


mat el_mean=J(32,2,.)
local i=1
foreach v in `elix'{
	sum `v'
	mat el_mean[`i',1]=r(mean)
	mat el_mean[`i',2]=r(N)
	local i=`i'+1
}

mat rownames el_mean = "Congestive Heart Failure" "Cardiac Arrhythmias" "Valvular Disease" ///
"Pulmonary Circulation Disorders" "Peripheral Vascular Disorders" "Hypertension" ///
 "Paralysis" "Other Neurological Disorders" "Chronic Pulmonary Disease" "Diabetes, uncomplicated" ///
 "Diabetes, complicated" "Hypothyroidism" "Renal Failure" "Liver Disease" ///
 "Peptic Ulcer Disease" "AIDS" "Lymphoma" "Metastatic Cancer" ///
 "Solid Tumor without Metastasis" "Rheumatoid Arthritis" ///
 "Coagulopathy" "Obesity" "Weight Loss" "Fluid and Electrolyte Disorders" ///
 "Blood Loss Anemia" "Deficiency Anemias" "Alcohol Abuse" "Drug Abuse" "Psychoses" "Depression" ///
 "Dementia" "Total Elix comorb"

mat list hcc_mean
mat list el_mean

	
frmttable using `logpath'\spo_initial_tables, statmat(hcc_mean) ///
title("R's Chronic conditions") ctitle("","Mean","N") ///
sdec(2,0) addtable
 
frmttable using `logpath'\spo_initial_tables, statmat(el_mean) ///
title("R's Elixhauser comorbidities") ctitle("","Mean","N") ///
sdec(2,0) addtable 
 
log close


H="Analysis - S CESD Score Improves post R's death"
/*Outcome variable is: CESD improvement indicator, ie any improvement 
in CESD score from n1 to p1

This Stata code runs following analyses:
1. Unmatched logit regression on spouse depressive symptoms
2. Determines propensity scores
3. Px matched logit regression on reduced spouse depressive symptoms 

Note caliper set for use with dataset that excludes the regional variables when matching!*/

capture log close

clear all
set mem 500m
set more off
set scheme s1color

//Amy's PC
local logpath E:\data\spouse\logs
local datapath E:\data\spouse\final_data

//RG PC
//local logpath C:\data\Spouse\logs
//local datapath C:\data\Spouse

log using "`logpath'\5-HRS_Spouse_analysis.txt", text replace

cd `datapath'

use spouse_data_sample_v2.dta
//use spouse_data_sample_public.dta if (p1_wi_90d==0 & no_cc_12m_excl_cataract==0 & sudden_cause_death==0 & cesd_miss_n1_p1==0)

tab s_comor_c_hrs_n1 s_cesdbetter, chi2
tab s_comor_c_hrs_n1 r_hs_12m, chi2

*****************************************************************************
*****************************************************************************
//Unmatched logit regression hospice use on reduced spousal depression
*****************************************************************************
*****************************************************************************
local xvars c.s_age i.s_female i.s_white_e i.s_hseduc_n1_n3 i.s_srh_pf_p1 ///
i.s_hrs_comorb_mild_n1 i.s_hrs_comorb_mod_n1 i.s_psych_overall_hrs_n1 

local yearvars ib2000.r_death_year 

logit s_cesdbetter i.r_hs_12m `xvars' `yearvars', or

outreg using `logpath'\spouse_analysis, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment - Unmatched" \ ///
	"Outcome = CESD Score Decreased (by any amount) n1 to p1") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and no comorbidities.") ///
	varlabels starlevels(10 5 1)  summstat( N) replace
 	
*****************************************************************************
*****************************************************************************
//Run on larger sample without exclusions for p1 ivw 90+days from death ,etc
//Note this sample is not right, if going to use this table in the final results
//reported, need to update it! 
//Uses dataset prior to dropping variables that are missing
*****************************************************************************
*****************************************************************************
clear

use spouse_data_sample_v1.dta
//use spouse_data_sample_public.dta

logit s_cesdbetter i.r_hs_12m `xvars' `yearvars', or

outreg using `logpath'\spouse_analysis, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment - Unmatched" \ ///
	"Sample without exclusions for p1 ivw time, comorbidities, sudden death" \ ///
	"Outcome = CESD Score Decreased (by any amount) n1 to p1") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and no comorbidities.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable
  
*****************************************************************************
*****************************************************************************
//Px score matching
*****************************************************************************
*****************************************************************************
clear 

//go back to sample restricted on p1 ivw time from death, etc.
use spouse_data_sample_v2.dta 
//use spouse_data_sample_public.dta if (p1_wi_90d==0 & no_cc_12m_excl_cataract==0 & sudden_cause_death==0 & cesd_miss_n1_p1==0)

//check correlation, do not use both r, s age, race, educ
pwcorr r_age s_age, sig
pwcorr r_white_e s_white_e, sig
pwcorr r_hseduc_n1_n3 s_hseduc_n1_n3, sig
pwcorr r_medicaid_n1 s_medicaid_n1, sig

//original list from ling's code
local matchvars_orig comorb_all_0d_n12m cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 r_age r_female r_white_e  r_hseduc_n1_n3 r_networth_n1 ///
r_nhres_n1 r_imprelig_vimp_n1 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_medicaid_n1 ///
r_champus_n1 r_medigap_n1 r_advdir_x r_discuss_x r_srh_pf_n1 ///
hci_index hospital_beds specialists	

//rg modified list
//See tab Sum stats, unmatched for variable list 

tab r_hs_12m, missing

//first sort data randomly
set seed 2000
gen x=uniform()
sort x


*****************************************************************************
*****************************************************************************
//Using Stata's pscore to generate px scores
*****************************************************************************
*****************************************************************************

//generate pscore variable hs_pscore
pscore r_hs_12m $matchvars, pscore(hs_pscore) blockid(hs_block) logit detail

//graph without dropping any observations in the matching process
psgraph, treated(r_hs_12m) pscore(hs_pscore)
graph save `logpath'/psgraph_1 ,replace

//implement radius matching
gen logitpscore=ln(hs_pscore/(1-hs_pscore))
sum logitpscore

sca cal_ps1=r(sd)*0.02
sca list cal_ps1

***************************************************************************************
** User Note: If change variable or sample list, need to update the caliper here
***************************************************************************************
//rule of thumb 0.2*sd, we can use 0.02*sd
psmatch2  r_hs_12m,outcome(s_cesdbetter) pscore(hs_pscore) radius caliper(.01713619) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(r_hs_12m) pscore(hs_pscore)
graph save `logpath'/psgraph_2 ,replace

histogram hs_pscore if _support==1, by(r_hs_12m) 

//look at balance of matched vs unmatched samples
pstest $matchvars ,treated(r_hs_12m) both hist
graph save `logpath'/psmatch_1 ,replace

***************************************************************************************
** User Note: If change list of continuous variables, need to update the list here
** to create qqplots here
***************************************************************************************
//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age{
gen `v'_treated = `v' if r_hs_12m==1 & _support==1
gen `v'_comparison = `v' if r_hs_12m==0 & _support==1
qqplot `v'_treated `v'_comparison
graph save `logpath'/qqplot_`v', replace
}

***************************************************************************************
** User Note: If change number of variables, matrix size needs to be adjusted
** number of rows = 40 in mat vr definition, this will change if number of variables changes
***************************************************************************************
mat vr=J(40,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $matchvars  {
sum `v' if r_hs_12m==1 //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if r_hs_12m==0 //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if r_hs_12m==1 & _support==1 //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if r_hs_12m==0 [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}

***************************************************************************************
** User Note: If change variable list, update rownames here to match
***************************************************************************************
mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1"

mat list vr

//look at standardized differences to assess balance - section removed
//standardized difference same as bias reported when run pstest command above

***************************************************************************************
** User Note: If change variable list / caliper, then these counts in comments can change
***************************************************************************************
//using this matching, 2 obs from the treatment group are dropped b/c they are off support
//18 are dropped b/c not matched (weight=.)
//_support ==1 if matched
tab _support, missing
tab _support if r_hs_12m==1, missing
tab _support if r_hs_12m==0, missing
tab _weight if r_hs_12m==1, missing
sum _weight if r_hs_12m==0

//rename ps variables and save dataset so can call them up later
rename _support support_1
rename _weight weight_1

save spouse_data_sample_v1_ps1.dta, replace

//drop observations that aren't matched using caliper match
drop if weight_1==.

*************************************************************************************
//now run doubly robust estimation using weighting , outcome = improved CESD score p1
//need to include the variables used in the propensity score

logit s_cesdbetter i.r_hs_12m `yearvars' $matchvars [iw=weight_1] , or 

est save logit_matched_1, replace

outreg using `logpath'\spouse_analysis, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score Decreased (by any amount) n1 to p1") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable

tab s_cesdbetter s_cesd_ge3better, missing

//Run logit with outcome=depressed n1, not depressed p1
logit s_cesd_ge3better i.r_hs_12m `yearvars' $matchvars [iw=weight_1] , or 

outreg using `logpath'\spouse_analysis, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score 3+ n1 to less than 3 p1") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable

*************************************************************************************
log close



H="Creates Table 1 & 2 - Decedent/Spouse Descr Char"
/*This section creates the publication tables and overall
sample summary stats used in the paper!!
*/

capture log close

clear all
set mem 500m
set more off
set scheme s1color

//Amy's PC
local logpath E:\data\spouse\logs
local datapath E:\data\spouse\final_data

//RG PC
//local logpath C:\data\Spouse\logs
//local datapath C:\data\Spouse

log using "`logpath'\5b-HRS_Spouse_analysis.txt", text replace

cd `datapath'

use spouse_data_sample_v2.dta

/*create quick table of overall sample characteristics*/
local varlist1 r_female r_white_e r_hseduc_n1_n3 

local varlist2 s_female s_white_e ///
s_hseduc_n1_n3 s_adl_independent_core_n1

mat quicktab=J(13,5,.)

sum r_age 
mat quicktab[1,1]=r(mean)

local j=2
foreach v in `varlist1'{
sum `v'
mat quicktab[`j',1]=r(mean)*100
local j=`j'+1 //rows 2-4
}

sum s_age 
mat quicktab[5,1]=r(mean)


local j=6
foreach v in `varlist2'{
sum `v'
mat quicktab[`j',1]=r(mean)*100
local j=`j'+1 //rows 6-9
}


local i=10
sum hs_los_12m if r_hs_12m==1, detail
mat quicktab[`i',1]=r(mean)
mat quicktab[`i',2]=r(sd)
mat quicktab[`i',3]=r(p50)
mat quicktab[`i',4]=r(min)
mat quicktab[`i',5]=r(max)

gen mo_p1_core_dead =days_p1_core_dead/30.5
gen mo_s_n1_core_dead = s_days_n1_core_dead/30.5

sum mo_p1_core_dead
mat quicktab[`i'+1,1]=r(mean)

sum mo_s_n1_core_dead 
mat quicktab[`i'+2,1]=r(mean)

gen mo_s_p1_n1 = (days_p1_core_dead+ s_days_n1_core_dead)/30.5
sum mo_s_p1_n1 , detail
mat quicktab[`i'+3,1]=r(mean)
mat quicktab[`i'+3,2]=r(sd)
mat quicktab[`i'+3,3]=r(p50)
mat quicktab[`i'+3,4]=r(min)
mat quicktab[`i'+3,5]=r(max)

mat list quicktab

mat rownames quicktab="R Age" "R Female" "R White" "R HS Degree" ///
"S Age" "S Female" "S White" "S HS Degree" "S ADL independent n1" ///
"Days hospice use" "S n1 ivw months before death" "S p1 ivw months after death" ///
"S n1 to p1 interview, months"

frmttable using `logpath'\spo_overall_sample_char, statmat(quicktab) ///
title("Overall sample descriptive characteristics, n=867") ///
ctitle("","Mean or Percent" "SD" "Median" "Min" "Max") ///
sdec(3,2,0,0,0) replace


*************************************************************************************
*************************************************************************************
//Create Table 1, Decedent Descriptive Statistics
//Col 1-3: Unweighted, unmatched sample
//Col 4-6: Weighted and matched sample
*************************************************************************************
*************************************************************************************
local t1vars r_medicaid_n1 r_nhres_n1 r_nhres_x r_advdir_y r_advdir_n ///
r_advdir_miss r_adl_stable_ind_n1n2 ///
r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 r_adl_change_i_m_n1n2 ///
r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss cc_3_alzhdmta_n12mn0 ///
cc_6_chrnkidn_n12mn0 cc_12_ischmcht_n12mn0 cc_8_chf_n12mn0 ///
cc_9_diabetes_n12mn0 cc_7_copd_n12mn0 cc_16_strketia_n12mn0 ///
cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 cc_11_hipfrac_n12mn0 ///
cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 cc_15_ra_oa_n12mn0 

sum r_age, detail

mat demo=J(36,6,.)

//first row, n of hospice users and non-users
tab r_hs_12m, missing matcell(d1)
mat demo[1,1]=d1[2,1] //non-hospice n
mat demo[1,2]=d1[1,1] //hospice users n

local j=1
foreach h in r_hs_12m non_hosp {
sum r_age if `h'==1, detail //age
mat demo[2,`j']=r(mean)
mat demo[3,`j']=r(sd)
sum r_female if `h'==1, detail //female
mat demo[4,`j']=r(mean)*100
sum r_white_e if `h'==1, detail //non-hispanic, white
mat demo[5,`j']=r(mean)*100
sum r_hseduc_n1_n3 if `h'==1, detail //hs education+
mat demo[6,`j']=r(mean)*100
sum r_networth_adj2010_n1 if `h'==1, detail //net worth
mat demo[7,`j']=r(mean)
mat demo[8,`j']=r(sd)
local i=9
foreach v in `t1vars' {
	sum `v' if `h'==1, detail 
	mat demo[`i',`j']=r(mean)*100
	local i=`i'+1 //populates rows 9-34
	}
sum cc_all_count_12m_2 if `h'==1, detail //count of chronic conditions
mat demo[35,`j']=r(mean)
mat demo[36,`j']=r(sd)
local j=`j'+1
}

//standardized difference for unmatched sample
//creates new matrix with means then puts the standardized difference into
//the main demo matrix

mat std_diff_b=J(36,4,.)

local r=2
sum r_age if r_hs_12m==1 //get mean,variance treated before matching
mat std_diff_b[`r',1]=r(mean)
mat std_diff_b[`r',2]=r(sd)

sum r_age if r_hs_12m==0 //get mean,variance contl before matching
mat std_diff_b[`r',3]=r(mean)
mat std_diff_b[`r',4]=r(sd)

mat demo[`r',3]=(std_diff_b[`r',1]-std_diff_b[`r',3])/sqrt((std_diff_b[`r',2]^2+std_diff_b[`r',4]^2)/2) 
	
local r = 4
foreach v in r_female r_white_e r_hseduc_n1_n3 {
	sum `v' if r_hs_12m==1 //get mean,variance treated before matching
	mat std_diff_b[`r',1]=r(mean)

	sum `v' if r_hs_12m==0 //get mean,variance contl before matching
	mat std_diff_b[`r',3]=r(mean)

	mat demo[`r',3]=(std_diff_b[`r',1]-std_diff_b[`r',3])/sqrt((std_diff_b[`r',1]*(1-std_diff_b[`r',1])+std_diff_b[`r',3]*(1-std_diff_b[`r',3]))/2)

	local r = `r'+1
}

sum r_networth_adj2010_n1 if r_hs_12m==1 //get mean,variance treated before matching
mat std_diff_b[`r',1]=r(mean)
mat std_diff_b[`r',2]=r(sd)

sum r_networth_adj2010_n1 if r_hs_12m==0 //get mean,variance contl before matching
mat std_diff_b[`r',3]=r(mean)
mat std_diff_b[`r',4]=r(sd)

mat demo[`r',3]=(std_diff_b[`r',1]-std_diff_b[`r',3])/sqrt((std_diff_b[`r',2]^2+std_diff_b[`r',4]^2)/2) 

local r = 9
foreach v in `t1vars' {
	sum `v' if r_hs_12m==1 //get mean,variance treated before matching
	mat std_diff_b[`r',1]=r(mean)

	sum `v' if r_hs_12m==0 //get mean,variance contl before matching
	mat std_diff_b[`r',3]=r(mean)

	mat demo[`r',3]=(std_diff_b[`r',1]-std_diff_b[`r',3])/sqrt((std_diff_b[`r',1]*(1-std_diff_b[`r',1])+std_diff_b[`r',3]*(1-std_diff_b[`r',3]))/2)

	local r = `r'+1
}

local r = 35
sum cc_all_count_12m_2 if r_hs_12m==1 //get mean,variance treated before matching
mat std_diff_b[`r',1]=r(mean)
mat std_diff_b[`r',2]=r(sd)

sum cc_all_count_12m_2 if r_hs_12m==0 //get mean,variance contl before matching
mat std_diff_b[`r',3]=r(mean)
mat std_diff_b[`r',4]=r(sd)

mat demo[`r',3]=(std_diff_b[`r',1]-std_diff_b[`r',3])/sqrt((std_diff_b[`r',2]^2+std_diff_b[`r',4]^2)/2) 


//just look at it to check means against the pstest output to make sure they are right
mat rownames std_diff_b= "R age" "" "Female" "White" "HS Degree" "Net worth" "" ///
"Medicaid" "Nursing home res before death" "Nursing home res at death" ///
"Advance directive Y" "Advance directive N" "Advance directive missing" ///
"ADL stable independent" "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" ///
"Alzheimers/Dementia" "Chronic kidney disease" "AMI / ISCH" ///
"CHF" "Diabetes" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis" "Count of comorbidities" ""

mat list std_diff_b

*************************************************************************************
//Table 1 - cols 4-6: Respondent characteristics, matched and weighted
*************************************************************************************
clear

use spouse_data_sample_v1_ps1.dta

//first row, n of hospice users and non-users
tab r_hs_12m if weight_1!=. , missing matcell(dm)
mat demo[1,5]=dm[1,1] //non-hospice n
mat demo[1,4]=dm[2,1] //hospice users n

local j=4
foreach h in r_hs_12m non_hosp {
sum r_age if `h'==1 [iweight=weight_1] //age
mat demo[2,`j']=r(mean)
mat demo[3,`j']=r(sd)
sum r_female if `h'==1 [iweight=weight_1] //female
mat demo[4,`j']=r(mean)*100
sum r_white_e if `h'==1 [iweight=weight_1] //non-hispanic, white
mat demo[5,`j']=r(mean)*100
sum r_hseduc_n1_n3 if `h'==1 [iweight=weight_1] //hs education+
mat demo[6,`j']=r(mean)*100
sum r_networth_adj2010_n1 if `h'==1 [iweight=weight_1] //net worth
mat demo[7,`j']=r(mean)
mat demo[8,`j']=r(sd)
local i=9
foreach v in `t1vars' {
	sum `v' if `h'==1 [iweight=weight_1] 
	mat demo[`i',`j']=r(mean)*100
	local i=`i'+1 //populates rows 9-34
	}
sum cc_all_count_12m_2 if `h'==1 [iweight=weight_1] //count of chronic conditions
mat demo[35,`j']=r(mean)
mat demo[36,`j']=r(sd)
local j=`j'+1
}

//standardized difference for matched sample
//creates new matrix with means then puts the standardized difference into
//the main demo matrix

mat std_diff_a=J(36,4,.)

local r=2
sum r_age if r_hs_12m==1 [iweight=weight_1] //get mean,variance treated after matching
mat std_diff_a[`r',1]=r(mean)
mat std_diff_a[`r',2]=r(sd)

sum r_age if r_hs_12m==0 [iweight=weight_1] //get mean,variance contl after matching
mat std_diff_a[`r',3]=r(mean)
mat std_diff_a[`r',4]=r(sd)

mat demo[`r',6]=(std_diff_a[`r',1]-std_diff_a[`r',3])/sqrt((std_diff_a[`r',2]^2+std_diff_a[`r',4]^2)/2) 
	
local r = 4
foreach v in r_female r_white_e r_hseduc_n1_n3 {
	sum `v' if r_hs_12m==1 [iweight=weight_1] //get mean,variance treated after matching
	mat std_diff_a[`r',1]=r(mean)

	sum `v' if r_hs_12m==0 [iweight=weight_1] //get mean,variance contl after matching
	mat std_diff_a[`r',3]=r(mean)

	mat demo[`r',6]=(std_diff_a[`r',1]-std_diff_a[`r',3])/sqrt((std_diff_a[`r',1]*(1-std_diff_a[`r',1])+std_diff_a[`r',3]*(1-std_diff_a[`r',3]))/2)

	local r = `r'+1
}

sum r_networth_adj2010_n1 if r_hs_12m==1 [iweight=weight_1] //get mean,variance treated after matching
mat std_diff_a[`r',1]=r(mean)
mat std_diff_a[`r',2]=r(sd)

sum r_networth_adj2010_n1 if r_hs_12m==0 [iweight=weight_1] //get mean,variance contl after matching
mat std_diff_a[`r',3]=r(mean)
mat std_diff_a[`r',4]=r(sd)

mat demo[`r',6]=(std_diff_a[`r',1]-std_diff_a[`r',3])/sqrt((std_diff_a[`r',2]^2+std_diff_a[`r',4]^2)/2) 

local r = 9
foreach v in `t1vars' {
	sum `v' if r_hs_12m==1 [iweight=weight_1] //get mean,variance treated after matching
	mat std_diff_a[`r',1]=r(mean)

	sum `v' if r_hs_12m==0 [iweight=weight_1] //get mean,variance contl after matching
	mat std_diff_a[`r',3]=r(mean)

	mat demo[`r',6]=(std_diff_a[`r',1]-std_diff_a[`r',3])/sqrt((std_diff_a[`r',1]*(1-std_diff_a[`r',1])+std_diff_a[`r',3]*(1-std_diff_a[`r',3]))/2)

	local r = `r'+1
}

local r = 35
sum cc_all_count_12m_2 if r_hs_12m==1 [iweight=weight_1] //get mean,variance treated after matching
mat std_diff_a[`r',1]=r(mean)
mat std_diff_a[`r',2]=r(sd)

sum cc_all_count_12m_2 if r_hs_12m==0 [iweight=weight_1] //get mean,variance contl after matching
mat std_diff_a[`r',3]=r(mean)
mat std_diff_a[`r',4]=r(sd)

mat demo[`r',6]=(std_diff_a[`r',1]-std_diff_a[`r',3])/sqrt((std_diff_a[`r',2]^2+std_diff_a[`r',4]^2)/2) 


//just look at it to check means against the pstest output to make sure they are right
mat rownames std_diff_a= "R age" "" "Female" "White" "HS Degree" "Net worth" "" ///
"Medicaid" "Nursing home res before death" "Nursing home res at death" ///
"Advance directive Y" "Advance directive N" "Advance directive missing" ///
"ADL stable independent" "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" ///
"Alzheimers/Dementia" "Chronic kidney disease" "AMI / ISCH" ///
"CHF" "Diabetes" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis" "Count of comorbidities" ""

mat list std_diff_a


mat rownames demo ="Sample n" "Age at death, years, mean" "SD" "Female, %" "Race, Non-Hispanic White, %" ///
"Education, High School Grad" "Net worth, 2010US$, mean" "SD" "Medicaid, %" ///
"Nursing home resident n1, %" "Nursing home resident exit" "Had advance directive" ///
"Did not have advance directive" "Advance directive status unknown" ///
"Stable, Indep in ADLs n2 to n1" ///
"Stable, Moderate 1-3 ADL" "Stable, Severe 4-6 ADL" ///
"Declined, Indep to Moderate" "Declined, Moderate to Severe" ///
"Declined, Independent to Severe" "Unknown" "Alzheimers/Dementia" "Chronic Kidney Disease" ///
"Ischemic Heart Disease" "Congestive Heart Failure" "Diabetes" "COPD" ///
"Stroke or TIA" "Cancer" "Atrial Fibrillation" "Hip Fracture" "Depression" "Osteoporosis" ///
"Arthritis" "Count of chronic conditions" "SD"

mat list demo

frmttable using `logpath'\spo_Table1_deced_char, statmat(demo) ///
title("Decedent descriptive characteristics, by any hospice use status") ///
ctitle("","Unmatched Sample","","","Matched Sample","","" \ "", "Hospice users","Non-hospice users","Std. Diff.", ///
  "Hospice users" ,"Non-hospice users" ,"Std. Diff.") ///
sdec(2,2,3,2,2,3) replace

******************************************************************
******************************************************************
//Table 2 spouse characteristics
//Col 1-3: unmatched, unweighted
//Col 4-6: matched and weighted
******************************************************************
******************************************************************
clear

use spouse_data_sample_v2.dta

local sdemovar1 s_female s_white_e s_hseduc_n1_n3 ///
s_medicaid_n1 s_srh_pf_n1 s_imprelig_vimp_n1 s_smoke_curr_n1 ///
s_vig_phy_act_n1 s_hrs_comorb_none_n1 s_hrs_comorb_mild_n1 ///
s_hrs_comorb_mod_n1 s_cancer_hrs_n1 ///
s_lung_hrs_n1 s_heart_hrs_n1 s_chf_hrs_n1 s_stroke_hrs_n1 ///
s_memory_hrs_n1 s_htn_hrs_n1 s_dm_hrs_n1 s_psych_hrs_n1 ///
days_p1_core_dod_lt6m days_p1_core_dod_6_12m days_p1_core_dod_12_18m ///
days_p1_core_dod_gt18mo

local sdemovar2 s_cesd_tot_ge3_n1 ///
s_cesd_tot_ge3_p1 s_cesdbetter s_cesdsame s_cesdworse 

mat sdemo=J(35,6,.)

//first row, n of hospice and non-hospice
tab r_hs_12m, missing matcell(sd1)
mat sdemo[1,1]=sd1[2,1] //non-hospice n
mat sdemo[1,2]=sd1[1,1] //hospice users n

local j=1
foreach h in r_hs_12m non_hosp {
sum s_age if `h'==1, detail //age
mat sdemo[2,`j']=r(mean)
mat sdemo[3,`j']=r(sd)
local i=4
foreach v in `sdemovar1' {
	sum `v' if `h'==1, detail 
	mat sdemo[`i',`j']=r(mean)*100
	local i=`i'+1 //populates rows 4-27
	}

sum s_cesd_tot_n1 if `h'==1, detail //cesd score n1
mat sdemo[28,`j']=r(mean)
sum s_cesd_tot_p1 if `h'==1, detail //cesd score p1
mat sdemo[29,`j']=r(mean)
sum s_cesdchange if `h'==1, detail //cesd score change n1 to p1
mat sdemo[30,`j']=r(mean)

local i=31
foreach v in `sdemovar2' {
	sum `v' if `h'==1, detail 
	mat sdemo[`i',`j']=r(mean)*100
	local i=`i'+1 //populates rows 31-35
	}
local j=`j'+1
}

//standardized difference for unmatched sample
//creates new matrix with means then puts the standardized difference into
//the main demo matrix

mat std_diff_b=J(35,4,.)

local r=2
sum s_age if r_hs_12m==1 //get mean,variance treated before matching
mat std_diff_b[`r',1]=r(mean)
mat std_diff_b[`r',2]=r(sd)

sum s_age if r_hs_12m==0 //get mean,variance contl before matching
mat std_diff_b[`r',3]=r(mean)
mat std_diff_b[`r',4]=r(sd)

mat sdemo[`r',3]=(std_diff_b[`r',1]-std_diff_b[`r',3])/sqrt((std_diff_b[`r',2]^2+std_diff_b[`r',4]^2)/2)

local r = 4
foreach v in `sdemovar1'  {
	sum `v' if r_hs_12m==1 //get mean,variance treated before matching
	mat std_diff_b[`r',1]=r(mean)

	sum `v' if r_hs_12m==0 //get mean,variance contl before matching
	mat std_diff_b[`r',3]=r(mean)

	mat sdemo[`r',3]=(std_diff_b[`r',1]-std_diff_b[`r',3])/sqrt((std_diff_b[`r',1]*(1-std_diff_b[`r',1])+std_diff_b[`r',3]*(1-std_diff_b[`r',3]))/2)

	local r = `r'+1
}

local r = 28
foreach v in s_cesd_tot_n1  s_cesd_tot_p1  s_cesdchange {
        sum `v' if r_hs_12m==1 //get mean,variance treated before matching
    mat std_diff_b[`r',1]=r(mean)
    mat std_diff_b[`r',2]=r(sd)

    sum `v' if r_hs_12m==0 //get mean,variance contl before matching
    mat std_diff_b[`r',3]=r(mean)
    mat std_diff_b[`r',4]=r(sd)

    mat sdemo[`r',3]=(std_diff_b[`r',1]-std_diff_b[`r',3])/sqrt((std_diff_b[`r',2]^2+std_diff_b[`r',4]^2)/2)

    local r = `r'+1
}

local r = 31
foreach v in `sdemovar2' {
	sum `v' if r_hs_12m==1 //get mean,variance treated before matching
	mat std_diff_b[`r',1]=r(mean)

	sum `v' if r_hs_12m==0 //get mean,variance contl before matching
	mat std_diff_b[`r',3]=r(mean)

	mat sdemo[`r',3]=(std_diff_b[`r',1]-std_diff_b[`r',3])/sqrt((std_diff_b[`r',1]*(1-std_diff_b[`r',1])+std_diff_b[`r',3]*(1-std_diff_b[`r',3]))/2)

	local r = `r'+1
}

//just look at it to check means against the pstest output to make sure they are right
mat rownames std_diff_b= "S age" "" "Female" "White" "HS Degree" ///
"Medicaid" "SRH poor/fair" "Religion very imp" "Smoker" "Vigorous phys act" ///
"Comorb - none" "Mild" "Moderate" "Cancer" "Lung disease" "Heart disease" "CHF" "Stroke" ///
"Memory disease" "Hypertension" "Diabetes" "Psych problems" "p1 ivw 0-6m" ///
"p1 ivw 6-12m" "p1 ivw 12-18m" "p1 > 18m" "CESD raw n1" "CESD raw p1" "CESD change" ///
"Clin depr n1" "Clin depr p1" "CESD improved" "CESD same" "CESD declined"

mat list std_diff_b


**********************************************************************
//Matched weighted columns 4-6
**********************************************************************
clear

use spouse_data_sample_v1_ps1.dta

//first row, n of hospice and non-hospice
tab r_hs_12m if weight_1!=., missing matcell(sd1)
mat sdemo[1,4]=sd1[2,1] //hospice n
mat sdemo[1,5]=sd1[1,1] //non-hospice users n

local j=4
foreach h in r_hs_12m non_hosp {
sum s_age if `h'==1 [iweight=weight_1] //age
mat sdemo[2,`j']=r(mean)
mat sdemo[3,`j']=r(sd)
local i=4
foreach v in `sdemovar1' {
	sum `v' if `h'==1 [iweight=weight_1] 
	mat sdemo[`i',`j']=r(mean)*100
	local i=`i'+1 //populates rows 4-27
	}
sum s_cesd_tot_n1 if `h'==1 [iweight=weight_1] //cesd score n1
mat sdemo[28,`j']=r(mean)
sum s_cesd_tot_p1 if `h'==1 [iweight=weight_1] //cesd score p1
mat sdemo[29,`j']=r(mean)
sum s_cesdchange if `h'==1 [iweight=weight_1] //cesd score change n1 to p1
mat sdemo[30,`j']=r(mean)
local i=31
foreach v in `sdemovar2' {
	sum `v' if `h'==1 [iweight=weight_1] 
	mat sdemo[`i',`j']=r(mean)*100
	local i=`i'+1 //populates rows 31-35
	}
local j=`j'+1
}

//standardized difference for matched sample
//creates new matrix with means then puts the standardized difference into
//the main demo matrix

mat std_diff_a=J(35,4,.)

local r=2
sum s_age if r_hs_12m==1 [iweight=weight_1] //get mean,variance treated after matching
mat std_diff_a[`r',1]=r(mean)
mat std_diff_a[`r',2]=r(sd)

sum s_age if r_hs_12m==0 [iweight=weight_1] //get mean,variance contl after matching
mat std_diff_a[`r',3]=r(mean)
mat std_diff_a[`r',4]=r(sd)

mat sdemo[`r',6]=(std_diff_a[`r',1]-std_diff_a[`r',3])/sqrt((std_diff_a[`r',2]^2+std_diff_a[`r',4]^2)/2)

local r = 4
foreach v in `sdemovar1' {
	sum `v' if r_hs_12m==1 [iweight=weight_1] //get mean,variance treated after matching
	mat std_diff_a[`r',1]=r(mean)

	sum `v' if r_hs_12m==0 [iweight=weight_1] //get mean,variance contl after matching
	mat std_diff_a[`r',3]=r(mean)

	mat sdemo[`r',6]=(std_diff_a[`r',1]-std_diff_a[`r',3])/sqrt((std_diff_a[`r',1]*(1-std_diff_a[`r',1])+std_diff_a[`r',3]*(1-std_diff_a[`r',3]))/2)

	local r = `r'+1
}

local r = 28
foreach v in s_cesd_tot_n1 s_cesd_tot_p1 s_cesdchange  {
        sum `v' if r_hs_12m==1 [iweight=weight_1] //get mean,variance treated after matching
        mat std_diff_a[`r',1]=r(mean)
        mat std_diff_a[`r',2]=r(sd)

        sum `v' if r_hs_12m==0 [iweight=weight_1] //get mean,variance contl after matching
        mat std_diff_a[`r',3]=r(mean)
        mat std_diff_a[`r',4]=r(sd)

        mat sdemo[`r',6]=(std_diff_a[`r',1]-std_diff_a[`r',3])/sqrt((std_diff_a[`r',2]^2+std_diff_a[`r',4]^2)/2)
   	local r = `r'+1
}

local r = 31
foreach v in `sdemovar2' {
	sum `v' if r_hs_12m==1 [iweight=weight_1] //get mean,variance treated after matching
	mat std_diff_a[`r',1]=r(mean)

	sum `v' if r_hs_12m==0 [iweight=weight_1] //get mean,variance contl after matching
	mat std_diff_a[`r',3]=r(mean)

	mat sdemo[`r',6]=(std_diff_a[`r',1]-std_diff_a[`r',3])/sqrt((std_diff_a[`r',1]*(1-std_diff_a[`r',1])+std_diff_a[`r',3]*(1-std_diff_a[`r',3]))/2)

	local r = `r'+1
}

//just look at it to check means against the pstest output to make sure they are right
mat rownames std_diff_a= "S age" "" "Female" "White" "HS Degree" ///
"Medicaid" "SRH poor/fair" "Religion very imp" "Smoker" "Vigorous phys act" ///
"Comorb - none" "Mild" "Moderate" "Cancer" "Lung disease" "Heart disease" "CHF" "Stroke" ///
"Memory disease" "Hypertension" "Diabetes" "Psych problems" "p1 ivw 0-6m" ///
"p1 ivw 6-12m" "p1 ivw 12-18m" "p1 > 18m" "CESD raw n1" "CESD raw p1" "CESD change" ///
"Clin depr n1" "Clin depr p1" "CESD improved" "CESD same" "CESD declined"

mat list std_diff_a

mat rownames sdemo ="Sample size n" "Age at r's death, mean" "SD" "Female %" "Non-Hispanic White %" ///
"Education, High school grad %" "Medicaid %" "SRH poor or fair %" ///
"Religion very important %" "Currently smoker %" "Vigorous physical activity %" ///
"Comorbidity index - none" "Mild (1-3)" "Moderate (4-6)" ///
"Cancer %" "Lung disease %" "Heart disease %" "CHF %" "Stroke %" "Memory disease %" ///
"Hypertension %" "Diabetes %" "Psychological problems %" ///
"P1 interview 0-6m from death" "P1 interview 6-12m" "P1 interview 12-18m" "P1 interview 18m+" ///
"CES-D raw score pre-death, mean" "CES-D raw score post-death, mean" "Change in raw CES-D" ///
"Clinical depression pre-death %" "Clinical depression post-death %" ///
 "CES-D Improved post death %" "Same CES-D post death %" "CES-D Declined post death %"

mat list sdemo

frmttable using `logpath'\spo_Table2_spouse_char, statmat(sdemo) ///
title("Spouse descriptive characteristics, by any hospice use status") ///
ctitle("","Unmatched Sample","","","Matched Sample","","" \ "", "Hospice users","Non-hospice users","Std. Diff.", ///
  "Hospice users" ,"Non-hospice users" ,"Std. Diff.") ///
  sdec(2,2,4,2,2,4) replace

log close


H="xxxxxxAnaylsis, part 2 - different match variables"
/*created this code to compare the samples bewtween
using the correlated variables in the propensity score generation which
is coded in the previous tab and excluding them (coded here*/

capture log close

clear all
set mem 500m
set more off
set scheme s1color

//Amy's PC
local logpath E:\data\spouse\logs
local datapath E:\data\spouse\final_data

//RG PC
//local logpath C:\data\Spouse\logs
//local datapath C:\data\Spouse

log using "`logpath'\5a-HRS_Spouse_analysis_excl_corr_vars.txt", text replace

cd `datapath'

use spouse_data_sample_v2.dta

global matchvars2 cc_all_count_12m_2 cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 r_age r_female r_white_e  r_hseduc_n1_n3 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 r_imprelig_vimp_n1 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y r_advdir_miss r_discuss_x r_srh_pf_n1 ///
hci_index hospital_beds specialists /*s_age s_white_e s_hseduc_n1_n3*/ s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1 

tab r_hs_12m, missing

//first sort data randomly
set seed 2000
gen x=uniform()
sort x


*****************************************************************************
*****************************************************************************
//Using Stata's pscore to generate px scores
*****************************************************************************
*****************************************************************************

//generate pscore variable hs_pscore
pscore r_hs_12m $matchvars2, pscore(hs_pscore) blockid(hs_block) logit detail
//one of the net worth categories is not balanced in one block, that is fine

//graph without dropping any observations in the matching process
psgraph, treated(r_hs_12m) pscore(hs_pscore)
//graph save `logpath'/psgraph_1 ,replace

//implement radius matching
gen logitpscore=ln(hs_pscore/(1-hs_pscore))
sum logitpscore

sca cal_ps1=r(sd)*0.02
sca list cal_ps1

//rule of thumb 0.2*sd
//psmatch2  r_hs_12m,outcome(s_cesdbetter) pscore(hs_pscore) caliper(.1809855) logit
//try 0.02* sd
psmatch2  r_hs_12m,outcome(s_cesdbetter) pscore(hs_pscore) radius caliper(.01809855) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(r_hs_12m) pscore(hs_pscore)
//graph save `logpath'/psgraph_2 ,replace

histogram hs_pscore if _support==1, by(r_hs_12m) 

//look at balance of matched vs unmatched samples
pstest $matchvars2 ,treated(r_hs_12m) both hist
//graph save `logpath'/psmatch_1 ,replace

//pstest $matchvars2 `xvars',treated(r_hs_12m) both graph
//graph save `logpath'/psmatch_2 ,replace

//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 r_age s_age hci_index hospital_beds specialists{
gen `v'_treated = `v' if r_hs_12m==1 & _support==1
gen `v'_comparison = `v' if r_hs_12m==0 & _support==1
qqplot `v'_treated `v'_comparison
//graph save `logpath'/qqplot_`v', replace
}


mat vr=J(46,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $matchvars2  {
sum `v' if r_hs_12m==1 //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if r_hs_12m==0 //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if r_hs_12m==1 & _support==1 //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if r_hs_12m==0 & _support==1 [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}


mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis" "R Age" "R Female" "R White" "R HS Deg" ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
"Religion very important" "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" "Advance directive Y" ///
"Advance directive missing" ///
"R Discuss EOL plans" "SRH Fair/Poor" "HCI Index" "Hospital beds" "Specialists" ///
/*"S age" "S White" "S HS Degree"*/ "S SRH Fair/Poor" "S HRS Comorb Mild 1-3" ///
"S HRS Comorb Mod 4-6" "S Psych Problem HRS n1"

mat list vr

//using this matching, 7 obs from the treatment group are dropped b/c they are off support
//20 are dropped b/c not matched (weight=.)
//_support ==1 if matched
tab _support, missing
tab _support if r_hs_12m==1, missing
tab _support if r_hs_12m==0, missing
tab _weight if r_hs_12m==1, missing
sum _weight if r_hs_12m==0

//rename ps variables and save dataset so can call them up later
//rename _support support_1
rename _weight weight_1

//save spouse_data_sample_v1_ps1.dta, replace

//drop observations that aren't matched using caliper match
drop if weight_1==.

//now run using weighting , outcome = improved CESD score p1
//need to include the variables used in the propensity score
//we probably can't keep both spouse and r gender variables in

//define xvars for the doubly robust estimation regression
global xvars_dr cc_all_count_12m_2 cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 r_age r_female r_white_e  r_hseduc_n1_n3 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 r_imprelig_vimp_n1 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_x r_discuss_x r_srh_pf_n1 ///
hci_index hospital_beds specialists s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1 

logit s_cesdbetter i.r_hs_12m `yearvars' $xvars_dr [iw=weight_1] , or 

//est save logit_matched_1, replace

outreg using `logpath'\spouse_analysis_excl_corr_vars, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score Decreased (by any amount) n1 to p1" \ ///
	"R+S correlated variables are excluded in p-score generation") ///
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions.") ///
	varlabels starlevels(10 5 1)  summstat( N) replace

tab s_cesdbetter s_cesd_ge3better, missing

//Run logit with outcome=depressed n1, not depressed p1
logit s_cesd_ge3better i.r_hs_12m `yearvars' $xvars_dr [iw=weight_1] , or 

outreg using `logpath'\spouse_analysis_excl_corr_vars, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score 3+ n1 to less than 3 p1" \ ///	
	"R+S correlated variables are excluded in p-score generation") ///
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable

log close


H="Sub-sample of spouse caregivers"
/*This Stata code runs following :
1. Drops observations where S is not primary ADL or IADL Hleper
2. Determines propensity scores
3. Px matched logit regression on reduced spouse depressive symptoms 
*/

capture log close

clear all
set mem 500m
set more off

//Amy's PC
local logpath E:\data\spouse\logs\helpers
local datapath E:\data\spouse\final_data

//RG PC
//local logpath C:\data\Spouse\logs
//local datapath C:\data\Spouse

log using "`logpath'\6-HRS_Spouse_analysis_helpers_only.txt", text replace

cd `datapath'

use spouse_data_sample_v2.dta if (r_adl_sp_helper_x==1 | r_iadl_sp_helper_x==1) 

tab r_hs_12m, missing

*****************************************************************************
*****************************************************************************
//Px score matching
*****************************************************************************
*****************************************************************************
//rg modified list
//uses net worth quartiles, high is omitted category

tab r_hs_12m, missing

//first sort data randomly
set seed 2000
gen x=uniform()
sort x

*****************************************************************************
*****************************************************************************
//Using Stata's pscore to generate px scores
*****************************************************************************
*****************************************************************************

//generate pscore variable hs_pscore
pscore r_hs_12m $matchvars , pscore(hs_pscore) blockid(hs_block) logit detail

//graph without dropping any observations in the matching process
psgraph, treated(r_hs_12m) pscore(hs_pscore)
graph save `logpath'/helper_psgraph_1 ,replace

//implement radius matching
gen logitpscore=ln(hs_pscore/(1-hs_pscore))
sum logitpscore

sca cal_ps1=r(sd)*0.02
sca list cal_ps1

***************************************************************************************
** User Note: If change variable or sample list, need to updated the caliper here
***************************************************************************************
//try 0.02* sd
psmatch2  r_hs_12m,outcome(s_cesdbetter) pscore(hs_pscore) radius caliper(.01802932) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(r_hs_12m) pscore(hs_pscore)
graph save `logpath'/helper_psgraph_2 ,replace

histogram hs_pscore if _support==1, by(r_hs_12m) 

//look at balance of matched vs unmatched samples
pstest $matchvars,treated(r_hs_12m) both hist
graph save `logpath'/helper_psmatch_1 ,replace

pstest $matchvars,treated(r_hs_12m) both graph
graph save `logpath'/helper_psmatch_2 ,replace

***************************************************************************************
** User Note: If change list of continuous variables, need to update the list here
** to create qqplots here
***************************************************************************************
//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age {
gen `v'_treated = `v' if r_hs_12m==1 & _support==1
gen `v'_comparison = `v' if r_hs_12m==0 & _support==1
qqplot `v'_treated `v'_comparison
graph save `logpath'/helper_qqplot_`v', replace
}

***************************************************************************************
** User Note: If change number of variables, matrix size needs to be adjusted
** number of rows = 40 in mat vr definition, this will change if number of variables changes
***************************************************************************************
mat vr=J(40,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $matchvars  {
sum `v' if r_hs_12m==1 //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if r_hs_12m==0 //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if r_hs_12m==1 & _support==1 //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if r_hs_12m==0 [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}

***************************************************************************************
** User Note: If change variable list, update rownames here to match
***************************************************************************************
mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1" 

mat list vr

***************************************************************************************
** User Note: If change variable list / caliper, then these counts in comments can change
***************************************************************************************
//using this matching, 10 obs from the treatment group are dropped b/c they are off common support
//4 dropped because not matched

//_support ==1 if matched
tab _support, missing
tab _support if r_hs_12m==1, missing
tab _support if r_hs_12m==0, missing
tab _weight if r_hs_12m==1, missing
sum _weight if r_hs_12m==0

//drop observations that aren't matched using caliper match
drop if _support!=1
drop if _weight==.

***********************************************************************
//now run logit model using weighting 
***********************************************************************
//need to include the variables used in the propensity score

local yearvars ib2000.r_death_year 

logit s_cesdbetter i.r_hs_12m `yearvars' $matchvars [iw=_weight] , or 

outreg using `logpath'\helpers_spouse_analysis, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///
	"Limited to spouses providing primary caregivers for ADL/IADL's" \ ///	
	"Outcome = CESD Score Decreased (by any amount) n1 to p1") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse no comorbidities.") ///
	varlabels starlevels(10 5 1)  summstat( N) replace

***************************************************************************************
** User Note: If change variable list, also need to update the variable list here to match
***************************************************************************************
//Run logit with outcome=depressed n1, not depressed p1
//Have to use an alternate variable list because missing category for
//advanced directive perfectly predicts failure
local new_varlist cc_all_count_12m_2 cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y /*r_advdir_miss*/ r_discuss_x r_srh_pf_n1 ///
s_age s_female s_white_e  s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1 	

logit s_cesd_ge3better i.r_hs_12m `yearvars' `new_varlist' [iw=_weight] , or 

outreg using `logpath'\helpers_spouse_analysis, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///
	"Limited to spouses providing primary caregivers for ADL/IADL's" \ ///	
	"Outcome = CESD Score 3+ n1 to less than 3 p1" ) ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse no comorbidities.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable

log close


H="xxxxxSubsamples based on p1 interview time"
/*This Stata code runs following analyses:
Runs the propensity score matching, doubly robust logit regression on 
subgroups based on interview time windows

Note, does not run, some windows are too small!!
*/

capture log close

clear all
set mem 500m
set more off

//Amy's PC
local logpath E:\data\spouse\logs
local datapath E:\data\spouse\final_data

//RG PC
//local logpath C:\data\Spouse\logs
//local datapath C:\data\Spouse

log using "`logpath'\6b-HRS_Spouse_analysis_group_by_p1_ivw.txt", text replace

cd `datapath'

use spouse_data_sample_v2.dta

tab r_hs_12m_gt3d, missing
drop if r_hs_12m_gt3d==.

tab r_hs_12m_gt3d s_1yr_p1_core_dead, missing

tab days_p1_core_dod_cat , missing

*****************************************************************************
*****************************************************************************
//Px score matching
*****************************************************************************
*****************************************************************************
//rg modified list
//uses net worth quartiles, high is omitted category

//first sort data randomly
set seed 2000
gen x=uniform()
sort x

preserve

*****************************************************************************
*****************************************************************************
//Using Stata's pscore to generate px scores, sample with interview 3-6m
*****************************************************************************
*****************************************************************************
//keep subsample of interviews where interview 3-6 months after death
keep if days_p1_core_dod_lt6m==1

//generate pscore variable hs_pscore
pscore r_hs_12m_gt3d $matchvars , pscore(hs_pscore) blockid(hs_block) logit detail

//graph without dropping any observations in the matching process
psgraph, treated(r_hs_12m_gt3d ) pscore(hs_pscore)
//graph save `logpath'/helper_psgraph_1 ,replace

//implement radius matching
gen logitpscore=ln(hs_pscore/(1-hs_pscore))
sum logitpscore

sca cal_ps1=r(sd)*0.02
sca list cal_ps1

psmatch2  r_hs_12m_gt3d ,outcome(s_cesdbetter) pscore(hs_pscore) radius caliper(.03511321) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(r_hs_12m_gt3d) pscore(hs_pscore)

histogram hs_pscore if _support==1, by(r_hs_12m_gt3d) 

//look at balance of matched vs unmatched samples
pstest $matchvars,treated(r_hs_12m_gt3d) both hist

pstest $matchvars,treated(r_hs_12m_gt3d) both graph

//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age {
gen `v'_treated = `v' if r_hs_12m_gt3d==1 & _support==1
gen `v'_comparison = `v' if r_hs_12m_gt3d==0 & _support==1
qqplot `v'_treated `v'_comparison
}

mat vr=J(43,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $matchvars  {
sum `v' if r_hs_12m_gt3d==1 //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if r_hs_12m_gt3d==0 //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if r_hs_12m_gt3d==1 & _support==1 //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if r_hs_12m_gt3d==0 [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}


mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1" 

mat list vr


//_support ==1 if matched
tab _support, missing
tab _support if r_hs_12m_gt3d==1, missing
tab _support if r_hs_12m_gt3d==0, missing
tab _weight if r_hs_12m_gt3d==1, missing
sum _weight if r_hs_12m_gt3d==0


//drop observations that aren't matched using caliper match
drop if _support!=1
drop if _weight==.

***********************************************************************
//now run logit model using weighting 
***********************************************************************

local yearvars ib2000.r_death_year 

logit s_cesdbetter r_hs_12m_gt3d `yearvars' $matchvars [iw=_weight] , or 

outreg using `logpath'\ivw_time_groups_spouse_analysis, ///
	stats(e_b e_ci p) nosubstat keep(r_hs_12m_gt3d) ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///
	"Limited to S p1 interview within 3-6m of R's death" \ ///	
	"Outcome = CESD Score Decreased (by any amount) n1 to p1") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse no comorbidities.") ///
	varlabels starlevels(10 5 1)  summstat( N) replace

*****************************************************************************

*****************************************************************************
*****************************************************************************
//Using Stata's pscore to generate px scores, sample with interview 6-12m
*****************************************************************************
*****************************************************************************

*****************************************************************************

restore

//keep subsample of interviews where interview 6-12 months after death
keep if days_p1_core_dod_6_12m==1

//generate pscore variable hs_pscore
pscore r_hs_12m_gt3d $matchvars , pscore(hs_pscore) blockid(hs_block) logit detail

//graph without dropping any observations in the matching process
psgraph, treated(r_hs_12m_gt3d) pscore(hs_pscore)

//implement radius matching
gen logitpscore=ln(hs_pscore/(1-hs_pscore))
sum logitpscore

sca cal_ps1=r(sd)*0.02
sca list cal_ps1

psmatch2  r_hs_12m_gt3d,outcome(s_cesdbetter) pscore(hs_pscore) radius caliper(.02223214) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(r_hs_12m_gt3d) pscore(hs_pscore)

histogram hs_pscore if _support==1, by(r_hs_12m_gt3d) 

//look at balance of matched vs unmatched samples
pstest $matchvars,treated(r_hs_12m_gt3d) both hist

pstest $matchvars,treated(r_hs_12m_gt3d) both graph

//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age {
gen `v'_treated = `v' if r_hs_12m_gt3d==1 & _support==1
gen `v'_comparison = `v' if r_hs_12m_gt3d==0 & _support==1
qqplot `v'_treated `v'_comparison
}


mat vr=J(43,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $matchvars  {
sum `v' if r_hs_12m_gt3d==1 //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if r_hs_12m_gt3d==0 //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if r_hs_12m_gt3d==1 & _support==1 //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if r_hs_12m_gt3d==0 [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}


mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1" "HCI Index" ///
"Hospital beds" "Specialists"

mat list vr


//_support ==1 if matched
tab _support, missing
tab _support if r_hs_12m_gt3d==1, missing
tab _support if r_hs_12m_gt3d==0, missing
tab _weight if r_hs_12m_gt3d==1, missing
sum _weight if r_hs_12m_gt3d==0

//drop observations that aren't matched using caliper match
drop if _support!=1
drop if _weight==.

***********************************************************************
//now run logit model using weighting 
***********************************************************************
//need to include the variables used in the propensity score
//we probably can't keep both spouse and r gender variables in


local yearvars ib2000.r_death_year 

logit s_cesdbetter r_hs_12m_gt3d `yearvars' $matchvars [iw=_weight] , or 

outreg using `logpath'\ivw_time_groups_spouse_analysis, ///
	stats(e_b e_ci p) nosubstat keep(r_hs_12m_gt3d ) ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///
	"Limited to S p1 interview 6-12m of R's death" \ ///	
	"Outcome = CESD Score Decreased (by any amount) n1 to p1") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse no comorbidities.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable


*****************************************************************************

*****************************************************************************
*****************************************************************************
//Using Stata's pscore to generate px scores, sample with interview 6-12m
*****************************************************************************
*****************************************************************************

*****************************************************************************

restore

//keep subsample of interviews where interview 12-18 months after death
keep if days_p1_core_dod_12_18m==1

//generate pscore variable hs_pscore
pscore r_hs_12m_gt3d $matchvars , pscore(hs_pscore) blockid(hs_block) logit detail

//graph without dropping any observations in the matching process
psgraph, treated(r_hs_12m_gt3d) pscore(hs_pscore)

//implement radius matching
gen logitpscore=ln(hs_pscore/(1-hs_pscore))
sum logitpscore

sca cal_ps1=r(sd)*0.02
sca list cal_ps1

psmatch2  r_hs_12m_gt3d,outcome(s_cesdbetter) pscore(hs_pscore) radius caliper(.02223214) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(r_hs_12m_gt3d) pscore(hs_pscore)

histogram hs_pscore if _support==1, by(r_hs_12m_gt3d) 

//look at balance of matched vs unmatched samples
pstest $matchvars,treated(r_hs_12m_gt3d) both hist

pstest $matchvars,treated(r_hs_12m_gt3d) both graph

//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age {
gen `v'_treated = `v' if r_hs_12m_gt3d==1 & _support==1
gen `v'_comparison = `v' if r_hs_12m_gt3d==0 & _support==1
qqplot `v'_treated `v'_comparison
}


mat vr=J(43,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $matchvars  {
sum `v' if r_hs_12m_gt3d==1 //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if r_hs_12m_gt3d==0 //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if r_hs_12m_gt3d==1 & _support==1 //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if r_hs_12m_gt3d==0 [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}


mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1" "HCI Index" ///
"Hospital beds" "Specialists"

mat list vr


//_support ==1 if matched
tab _support, missing
tab _support if r_hs_12m_gt3d==1, missing
tab _support if r_hs_12m_gt3d==0, missing
tab _weight if r_hs_12m_gt3d==1, missing
sum _weight if r_hs_12m_gt3d==0

//drop observations that aren't matched using caliper match
drop if _support!=1
drop if _weight==.

***********************************************************************
//now run logit model using weighting 
***********************************************************************
//need to include the variables used in the propensity score
//we probably can't keep both spouse and r gender variables in


local yearvars ib2000.r_death_year 

logit s_cesdbetter r_hs_12m_gt3d `yearvars' $matchvars [iw=_weight] , or 

outreg using `logpath'\ivw_time_groups_spouse_analysis, ///
	stats(e_b e_ci p) nosubstat keep(r_hs_12m_gt3d) ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///
	"Limited to S p1 interview 12-18m of R's death" \ ///	
	"Outcome = CESD Score Decreased (by any amount) n1 to p1") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse no comorbidities.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable

*****************************************************************************

*****************************************************************************
*****************************************************************************
//Using Stata's pscore to generate px scores, sample with interview 6-12m
*****************************************************************************
*****************************************************************************

*****************************************************************************

restore

//keep subsample of interviews where interview 18+ months after death
keep if days_p1_core_dod_gt18mo==1

//generate pscore variable hs_pscore
pscore r_hs_12m_gt3d $matchvars , pscore(hs_pscore) blockid(hs_block) logit detail

//graph without dropping any observations in the matching process
psgraph, treated(r_hs_12m_gt3d) pscore(hs_pscore)

//implement radius matching
gen logitpscore=ln(hs_pscore/(1-hs_pscore))
sum logitpscore

sca cal_ps1=r(sd)*0.02
sca list cal_ps1

psmatch2  r_hs_12m_gt3d,outcome(s_cesdbetter) pscore(hs_pscore) radius caliper(.02223214) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(r_hs_12m_gt3d) pscore(hs_pscore)

histogram hs_pscore if _support==1, by(r_hs_12m_gt3d) 

//look at balance of matched vs unmatched samples
pstest $matchvars,treated(r_hs_12m_gt3d) both hist

pstest $matchvars,treated(r_hs_12m_gt3d) both graph

//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age {
gen `v'_treated = `v' if r_hs_12m_gt3d==1 & _support==1
gen `v'_comparison = `v' if r_hs_12m_gt3d==0 & _support==1
qqplot `v'_treated `v'_comparison
}


mat vr=J(43,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $matchvars  {
sum `v' if r_hs_12m_gt3d==1 //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if r_hs_12m_gt3d==0 //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if r_hs_12m_gt3d==1 & _support==1 //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if r_hs_12m_gt3d==0 [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}


mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1" "HCI Index" ///
"Hospital beds" "Specialists"

mat list vr


//_support ==1 if matched
tab _support, missing
tab _support if r_hs_12m_gt3d==1, missing
tab _support if r_hs_12m_gt3d==0, missing
tab _weight if r_hs_12m_gt3d==1, missing
sum _weight if r_hs_12m_gt3d==0

//drop observations that aren't matched using caliper match
drop if _support!=1
drop if _weight==.

***********************************************************************
//now run logit model using weighting 
***********************************************************************
//need to include the variables used in the propensity score
//we probably can't keep both spouse and r gender variables in


local yearvars ib2000.r_death_year 

logit s_cesdbetter r_hs_12m_gt3d `yearvars' $matchvars [iw=_weight] , or 

outreg using `logpath'\ivw_time_groups_spouse_analysis, ///
	stats(e_b e_ci p) nosubstat keep(r_hs_12m_gt3d) ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///
	"Limited to S p1 interview after 18m of R's death" \ ///	
	"Outcome = CESD Score Decreased (by any amount) n1 to p1") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse no comorbidities.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable


log close


H="Run with subsample interview > 1 year"
capture log close

clear all
set mem 500m
set more off

//Amy's PC
local logpath E:\data\spouse\logs
local datapath E:\data\spouse\final_data

//RG PC
//local logpath C:\data\Spouse\logs
//local datapath C:\data\Spouse

log using "`logpath'\6c-HRS_Spouse_analysis_ivw_after_1yr.txt", text replace

cd `datapath'

use spouse_data_sample_v2.dta if (s_1yr_p1_core_dead==0)

tab r_hs_12m_gt3d, missing
drop if r_hs_12m_gt3d==.

tab r_hs_12m_gt3d s_1yr_p1_core_dead, missing
tab r_hs_12m_gt3d r_advdir_miss

tab days_p1_core_dod_cat , missing

***************************************************************************************
** User Note: If want to change the list of variables used in propensity score matching
** for this section, change it here
***************************************************************************************
//Have to use an alternate variable list because missing category for
//advanced directive is all 0 for this subsample
global matchvars2 cc_all_count_12m_2 cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y /*r_advdir_miss*/ r_discuss_x r_srh_pf_n1 ///
s_age s_female s_white_e  s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1 

//first sort data randomly
set seed 2000
gen x=uniform()
sort x

//generate pscore variable hs_pscore
pscore r_hs_12m_gt3d $matchvars2 , pscore(hs_pscore) blockid(hs_block) logit detail

//graph without dropping any observations in the matching process
psgraph, treated(r_hs_12m_gt3d) pscore(hs_pscore)

//implement radius matching
gen logitpscore=ln(hs_pscore/(1-hs_pscore))
sum logitpscore

sca cal_ps1=r(sd)*0.02
sca list cal_ps1

***************************************************************************************
** User Note: If change variable list or sample, need to updated the caliper here
***************************************************************************************
psmatch2  r_hs_12m_gt3d,outcome(s_cesdbetter) pscore(hs_pscore) radius caliper(.02279913) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(r_hs_12m_gt3d) pscore(hs_pscore)

histogram hs_pscore if _support==1, by(r_hs_12m_gt3d) 

//look at balance of matched vs unmatched samples
pstest $matchvars2,treated(r_hs_12m_gt3d) both hist

pstest $matchvars2,treated(r_hs_12m_gt3d) both graph

***************************************************************************************
** User Note: If change list of continuous variables, need to update the list here
** to create qqplots here
***************************************************************************************
//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age {
gen `v'_treated = `v' if r_hs_12m_gt3d==1 & _support==1
gen `v'_comparison = `v' if r_hs_12m_gt3d==0 & _support==1
qqplot `v'_treated `v'_comparison
}

***************************************************************************************
** User Note: If change number of variables in list in section "Sum stats, unmatched", 
** matrix size needs to be adjusted
** number of rows = 40 in mat vr definition, this will change if number of variables changes
***************************************************************************************
mat vr=J(40,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $matchvars  {
sum `v' if r_hs_12m_gt3d==1 //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if r_hs_12m_gt3d==0 //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if r_hs_12m_gt3d==1 & _support==1 //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if r_hs_12m_gt3d==0 [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}

***************************************************************************************
** User Note: If change variable list, update rownames here to match
***************************************************************************************
mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1" 

mat list vr

//_support ==1 if matched
tab _support, missing
tab _support if r_hs_12m_gt3d==1, missing
tab _support if r_hs_12m_gt3d==0, missing
tab _weight if r_hs_12m_gt3d==1, missing
sum _weight if r_hs_12m_gt3d==0

rename _weight weight_after1yr
save spouse_data_sample_v1_ps3_after.dta, replace

//drop observations that aren't matched using caliper match
drop if _support!=1
drop if weight_after1yr==.

***********************************************************************
//now run logit model using weighting 
***********************************************************************
//need to include the variables used in the propensity score
//we probably can't keep both spouse and r gender variables in
 
local yearvars ib2000.r_death_year 

logit s_cesdbetter i.r_hs_12m_gt3d `yearvars' $matchvars2 [iw=weight_after1yr] , or 

outreg using `logpath'\ivw_time_groups_spouse_analysis, ///
	stats(e_b e_ci p) nosubstat  ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///
	"Limited to S p1 interview after 1 year of R's death" \ ///	
	"Outcome = CESD Score Decreased (by any amount) n1 to p1") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse no comorbidities.") ///
	varlabels starlevels(10 5 1)  summstat( N) replace

//Run logit with outcome=depressed n1, not depressed p1
	

logit s_cesd_ge3better i.r_hs_12m_gt3d `yearvars' $matchvars2 [iw=weight_after1yr] , or 

outreg using `logpath'\ivw_time_groups_spouse_analysis, ///
	stats(e_b e_ci p) nosubstat  ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///
	"Limited to S p1 interview after 1 year of R's death" \ ///	
	"Outcome = CESD Score 3+ n1 to less than 3 p1" ) ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse no comorbidities.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable


log close


H="Helpers, run with subsample interview > 1 year"
capture log close

clear all
set mem 500m
set more off

//Amy's PC
local logpath E:\data\spouse\logs\helpers
local datapath E:\data\spouse\final_data

//RG PC
//local logpath C:\data\Spouse\logs\helpers
//local datapath C:\data\Spouse

log using "`logpath'\6c-HRS_Spouse_analysis_ivw_after_1yr.txt", text replace

cd `datapath'

use spouse_data_sample_v2.dta if (s_1yr_p1_core_dead==0 & (r_adl_sp_helper_x==1 | r_iadl_sp_helper_x==1))

tab r_hs_12m_gt3d, missing
drop if r_hs_12m_gt3d==.

tab r_hs_12m_gt3d s_1yr_p1_core_dead, missing

tab days_p1_core_dod_cat , missing

tab r_advdir_miss r_hs_12m_gt3d, missing

//first sort data randomly
set seed 2000
gen x=uniform()
sort x

***************************************************************************************
** User Note: If want to change the list of variables used in propensity score matching
** for this section, change it here
***************************************************************************************
//since advanced directive missing category obs all have no hospice, drop from
//list of match variables
global matchvars2 cc_all_count_12m_2 cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y /*r_advdir_miss*/ r_discuss_x r_srh_pf_n1 ///
s_age s_female s_white_e  s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1 	


//generate pscore variable hs_pscore
pscore r_hs_12m_gt3d $matchvars2 , pscore(hs_pscore) blockid(hs_block) logit detail

//graph without dropping any observations in the matching process
psgraph, treated(r_hs_12m_gt3d) pscore(hs_pscore)

//implement radius matching
gen logitpscore=ln(hs_pscore/(1-hs_pscore))
sum logitpscore

sca cal_ps1=r(sd)*0.02
sca list cal_ps1

***************************************************************************************
** User Note: If change variable list or sample, need to update the caliper here
***************************************************************************************
psmatch2  r_hs_12m_gt3d,outcome(s_cesdbetter) pscore(hs_pscore) radius caliper(.02237482) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(r_hs_12m_gt3d) pscore(hs_pscore)

histogram hs_pscore if _support==1, by(r_hs_12m_gt3d) 

//look at balance of matched vs unmatched samples
pstest $matchvars2,treated(r_hs_12m_gt3d) both hist

pstest $matchvars2,treated(r_hs_12m_gt3d) both graph

***************************************************************************************
** User Note: If change list of continuous variables, need to update the list here
** to create qqplots here
***************************************************************************************
//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age {
gen `v'_treated = `v' if r_hs_12m_gt3d==1 & _support==1
gen `v'_comparison = `v' if r_hs_12m_gt3d==0 & _support==1
qqplot `v'_treated `v'_comparison
}

***************************************************************************************
** User Note: If change number of in $matchvars2 global in this section, 
** matrix size needs to be adjusted
** number of rows = 39 in mat vr definition, this will change if number of variables changes
***************************************************************************************
mat vr=J(39,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $matchvars2  {
sum `v' if r_hs_12m_gt3d==1 //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if r_hs_12m_gt3d==0 //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if r_hs_12m_gt3d==1 & _support==1 //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if r_hs_12m_gt3d==0 [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}

***************************************************************************************
** User Note: If change variable list, update rownames here to match
***************************************************************************************
mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" /*"Advance directive missing"*/ "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1"

mat list vr

//_support ==1 if matched
tab _support, missing
tab _support if r_hs_12m_gt3d==1, missing
tab _support if r_hs_12m_gt3d==0, missing
tab _weight if r_hs_12m_gt3d==1, missing
sum _weight if r_hs_12m_gt3d==0

rename _weight weight_helpafter1yr
save spouse_data_sample_v1_ps3_after_helpers.dta, replace

//drop observations that aren't matched using caliper match
drop if _support!=1
drop if weight_helpafter1yr==.

***********************************************************************
//now run logit model using weighting 
***********************************************************************

local yearvars ib2000.r_death_year 

logit s_cesdbetter i.r_hs_12m_gt3d `yearvars' $matchvars2 [iw=weight_helpafter1yr] , or 

outreg using `logpath'\helper_ivw_time_groups_spouse_analysis, ///
	stats(e_b e_ci p) nosubstat  ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///
	"Limited to S Primary Caregivers, S p1 interview after 1 year of R's death" \ ///	
	"Outcome = CESD Score Decreased (by any amount) n1 to p1") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse no comorbidities.") ///
	varlabels starlevels(10 5 1)  summstat( N) replace

***************************************************************************************
** User Note: If change variable list, this list to match
***************************************************************************************
//Run logit with outcome=depressed n1, not depressed p1
//need alternate match variables since perfect prediction with r_adl_stable_partial_n1n2 variable
global matchvars3 cc_all_count_12m_2 cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 /*r_adl_stable_partial_n1n2*/ r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y /*r_advdir_miss*/ r_discuss_x r_srh_pf_n1 ///
s_age s_female s_white_e  s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1 	

logit s_cesd_ge3better i.r_hs_12m_gt3d `yearvars' $matchvars3 [iw=weight_helpafter1yr] , or 

outreg using `logpath'\helper_ivw_time_groups_spouse_analysis, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Limited to S Primary Caregivers, S p1 interview after 1 year of R's death" \ ///	
	"Outcome = CESD Score 3+ n1 to less than 3 p1" \ ///	
	"R Hospice enrollment 3 or more days") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable


log close


H="Analysis - Hospice use >=3d alternate definitions"
/*Outcome variable is: CESD improvement indicator, ie any improvement 
in CESD score from n1 to p1

Defines hospice use as 3 or more days in hospice in last year of life
(rather than any hospice use as done in earlier analyses)

This Stata code runs following analyses:
1. Unmatched logit regression on spouse depressive symptoms
2. Determines propensity scores for 3+ days hospice use = treat
3. Px matched logit regression on reduced spouse depressive symptoms 
4. Step 2 for 7+ days hospice use
5. Step 3 for 7+ days hospice use
*/

capture log close

clear all
set mem 500m
set more off

//Amy's PC
local logpath E:\data\spouse\logs
local datapath E:\data\spouse\final_data

//RG PC
//local logpath C:\data\Spouse\logs
//local datapath C:\data\Spouse

log using "`logpath'\7-HRS_Spouse_analysis_alt_hs_use_def.txt", text replace

cd `datapath'

//use dataset that has already dropped observation if missing any of the 
//analysis variables and has px weighting saved from the 1+ days hospice use definition
use spouse_data_sample_v2.dta

tab r_hs_12m_gt3d, missing
tab r_hs_12m_gt7d, missing

*****************************************************************************
*****************************************************************************
//Unmatched logit regression hospice use on reduced spousal depression
*****************************************************************************
*****************************************************************************
local xvars c.s_age i.s_female i.s_white_e i.s_hseduc_n1_n3 i.s_srh_pf_p1 ///
i.s_hrs_comorb_mild_n1 i.s_hrs_comorb_mod_n1 i.s_psych_overall_hrs_n1 

local yearvars ib2000.r_death_year 

logit s_cesdbetter i.r_hs_12m_gt3d `xvars' `yearvars', or

outreg using `logpath'\spouse_analysis_alt_hs_use_def, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment - Unmatched" \ ///
	"Outcome = CESD Score Decreased (by any amount) n1 to p1" \ ///
	"R Hospice use 3 days or more last year of life") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and no comorbidities.") ///
	varlabels starlevels(10 5 1)  summstat( N) replace

logit s_cesdbetter i.r_hs_12m_gt7d `xvars' `yearvars', or

outreg using `logpath'\spouse_analysis_alt_hs_use_def, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment - Unmatched" \ ///
	"Outcome = CESD Score Decreased (by any amount) n1 to p1" \ ///
	"R Hospice use 7 days or more last year of life") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and no comorbidities.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable 	
	
*****************************************************************************
*****************************************************************************
//Px score matching - 3 or more days of hospice use = treatment variable
*****************************************************************************
*****************************************************************************
tab r_hs_12m_gt3d, missing

*****************************************************************************
*****************************************************************************
//Using Stata's pscore to generate px scores
*****************************************************************************
*****************************************************************************
//first sort data randomly
set seed 2000
gen x=uniform()
sort x


drop if r_hs_12m_gt3d==.

*****************************************************************************
** User Note: Uses the matchvars global from section Sum stats, unmatched
** if need alternate variable list, update it there
*****************************************************************************
//generate pscore variable hs_pscore
pscore r_hs_12m_gt3d $matchvars, pscore(hs_pscore3) blockid(hs_block) logit detail

//graph without dropping any observations in the matching process
psgraph, treated(r_hs_12m_gt3d) pscore(hs_pscore3)
graph save `logpath'/psgraph_1_gt3d ,replace

//implement radius matching
gen logitpscore3=ln(hs_pscore3/(1-hs_pscore3))
sum logitpscore3

sca cal_ps3=r(sd)*0.02
sca list cal_ps3

***************************************************************************************
** User Note: If change variable or sample list, need to updated the caliper here
***************************************************************************************
//try 0.02* sd
psmatch2  r_hs_12m_gt3d,outcome(s_cesdbetter) pscore(hs_pscore3) radius caliper(.01805351) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(r_hs_12m_gt3d) pscore(hs_pscore3)
graph save `logpath'/psgraph_2_gt3d ,replace

histogram hs_pscore3 if _support==1, by(r_hs_12m_gt3d) 

//look at balance of matched vs unmatched samples
pstest $matchvars `xvars2',treated(r_hs_12m_gt3d) both hist
graph save `logpath'/psmatch_1_gt3d ,replace

***************************************************************************************
** User Note: If change list of continuous variables, need to update the list here
** to create qqplots here
***************************************************************************************
//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age{
gen `v'_treated_3 = `v' if r_hs_12m_gt3d==1 & _weight!=.
gen `v'_comparison_3 = `v' if r_hs_12m_gt3d==0 & _weight!=.
qqplot `v'_treated_3 `v'_comparison_3
graph save `logpath'/qqplot_`v'_gt3d, replace
}

***************************************************************************************
** User Note: If change number of variables, matrix size needs to be adjusted
** number of rows = 40 in mat vr definition, this will change if number of variables changes
***************************************************************************************
mat vr=J(40,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $matchvars  {
sum `v' if r_hs_12m==1 //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if r_hs_12m==0 //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if r_hs_12m==1 & _support==1 //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if r_hs_12m==0 [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}

***************************************************************************************
** User Note: If change variable list, update rownames here to match
***************************************************************************************
mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1" 

mat list vr

***************************************************************************************
** User Note: If change variable list / caliper, then these counts in comments can change
***************************************************************************************
//using this matching, 5 obs from the treatment group are dropped b/c they don't match
//_support ==1 if matched
//x not matched, weight=.
tab _support, missing
tab _support if r_hs_12m_gt3d==1, missing
tab _support if r_hs_12m_gt3d==0, missing
tab _weight if r_hs_12m_gt3d==1, missing
sum _weight if r_hs_12m_gt3d==0

//rename ps variables and save dataset so can call them up later
rename _support support_3
rename _weight weight_3
save spouse_data_sample_v1_ps3.dta, replace

//drop observations that aren't matched using caliper match
drop if weight_3==.

//now run using weighting , outcome = improved CESD score p1
//need to include the variables used in the propensity score
//we probably can't keep both spouse and r gender variables in
logit s_cesdbetter i.r_hs_12m_gt3d  `yearvars' $matchvars [iw=weight_3] , or 

est save logit_matched_3, replace

outreg using `logpath'\spouse_analysis_alt_hs_use_def, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score Decreased (by any amount) n1 to p1" \ ///
	"R Hospice enrollment 3 or more days") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable

tab s_cesdbetter s_cesd_ge3better, missing

//Run logit with outcome=depressed n1, not depressed p1
logit s_cesd_ge3better i.r_hs_12m_gt3d  `yearvars' $matchvars [iw=weight_3] , or 

outreg using `logpath'\spouse_analysis_alt_hs_use_def, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score 3+ n1 to less than 3 p1" \ ///	
	"R Hospice enrollment 3 or more days") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable

*****************************************************************************
*****************************************************************************
*****************************************************************************
*****************************************************************************
//Px score matching - 7 or more days of hospice use = treatment variable
*****************************************************************************
*****************************************************************************
*****************************************************************************
*****************************************************************************
clear all

use spouse_data_sample_v2.dta

tab r_hs_12m_gt7d, missing

drop if r_hs_12m_gt7d==.

*****************************************************************************
*****************************************************************************
//Using Stata's pscore to generate px scores
*****************************************************************************
*****************************************************************************

//generate pscore variable hs_pscore
pscore r_hs_12m_gt7d $matchvars, pscore(hs_pscore7) blockid(hs_block) logit detail

//graph without dropping any observations in the matching process
psgraph, treated(r_hs_12m_gt7d) pscore(hs_pscore7)
graph save `logpath'/psgraph_1_gt7d ,replace

//implement radius matching
gen logitpscore7=ln(hs_pscore7/(1-hs_pscore7))
sum logitpscore7

sca cal_ps1_7=r(sd)*0.02
sca list cal_ps1_7

***************************************************************************************
** User Note: If change variable or sample list, need to updated the caliper here
***************************************************************************************
//rule of thumb 0.2*sd, use 0.02*sd
psmatch2  r_hs_12m_gt7d,outcome(s_cesdbetter) pscore(hs_pscore7) radius caliper(.01928389) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(r_hs_12m_gt7d) pscore(hs_pscore7)
graph save `logpath'/psgraph_2_gt7d ,replace

histogram hs_pscore7 if _support==1, by(r_hs_12m_gt7d) 

//look at balance of matched vs unmatched samples
pstest $matchvars ,treated(r_hs_12m_gt7d) both hist
graph save `logpath'/psmatch_1_gt7d ,replace

***************************************************************************************
** User Note: If change list of continuous variables, need to update the list here
** to create qqplots here
***************************************************************************************
//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age {
gen `v'_treated_7 = `v' if r_hs_12m_gt7d==1 & _support==1
gen `v'_comparison_7 = `v' if r_hs_12m_gt7d==0 & _support==1
qqplot `v'_treated_7 `v'_comparison_7
graph save `logpath'/qqplot_`v'_gt7d, replace
}

***************************************************************************************
** User Note: If change number of variables, matrix size needs to be adjusted
** number of rows = 40 in mat vr definition, this will change if number of variables changes
***************************************************************************************
mat vr=J(40,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $matchvars  {
sum `v' if r_hs_12m==1 //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if r_hs_12m==0 //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if r_hs_12m==1 & _support==1 //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if r_hs_12m==0 [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}

***************************************************************************************
** User Note: If change variable list, update rownames here to match
***************************************************************************************
mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1"

mat list vr

***************************************************************************************
** User Note: If change variable list / caliper, then these counts in comments can change
***************************************************************************************
//using this matching, 6 obs from the treatment group are dropped off common support
//1 obs dropped because not matched
//_support ==1 if matched
tab _support, missing
tab _support if r_hs_12m_gt7d==1, missing
tab _support if r_hs_12m_gt7d==0, missing
tab _weight if r_hs_12m_gt7d==1, missing
sum _weight if r_hs_12m_gt7d==0, detail

//rename ps variables and save dataset so can call them up later
rename _support support_7
rename _weight weight_7
save spouse_data_sample_v1_ps7.dta, replace

//drop observations that aren't matched using caliper match
drop if weight_7==.

//now run using weighting , outcome = improved CESD score p1
//need to include the variables used in the propensity score
//we probably can't keep both spouse and r gender variables in
logit s_cesdbetter i.r_hs_12m_gt7d `yearvars' $matchvars [iw=weight_7] , or 

est save logit_matched_7, replace

outreg using `logpath'\spouse_analysis_alt_hs_use_def, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score Decreased (by any amount) n1 to p1" \ ///
	"R Hospice enrollment 7 or more days") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable

tab s_cesdbetter s_cesd_ge3better, missing

//Run logit with outcome=depressed n1, not depressed p1
logit s_cesd_ge3better i.r_hs_12m_gt7d `yearvars' $matchvars [iw=weight_7] , or 

outreg using `logpath'\spouse_analysis_alt_hs_use_def, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score 3+ n1 to less than 3 p1" \ ///	
	"R Hospice enrollment 7 or more days") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable

************************************************************************
log close


H="Analysis - Hospice use 3,7 days, Helpers"
/*Outcome variable is: CESD improvement indicator, ie any improvement 
in CESD score from n1 to p1

Defines hospice use as 3 or more days in hospice in last year of life
(rather than any hospice use as done in earlier analyses)

This Stata code runs following analyses on the caregivers only subsample:
1. Determines propensity scores for 3+ days hospice use = treat
2. Px matched logit regression on reduced spouse depressive symptoms 
3. Step 1 for 7+ days hospice use
4. Step 2 for 7+ days hospice use
*/

capture log close

clear all
set mem 500m
set more off

//Amy's PC
//note that I created a separate logpath for the helper sub-sample analysis!
local logpath E:\data\spouse\logs\helpers
local datapath E:\data\spouse\final_data

//RG PC
//local logpath C:\data\Spouse\logs
//local datapath C:\data\Spouse

log using "`logpath'\7-HRS_Spouse_analysis_alt_hs_use_def.txt", text replace

cd `datapath'

//use dataset that has already dropped observation if missing any of the 
//analysis variables 
use spouse_data_sample_v2.dta if (r_adl_sp_helper_x==1 | r_iadl_sp_helper_x==1)

tab r_hs_12m_gt3d, missing
tab r_hs_12m_gt7d, missing
	
*****************************************************************************
*****************************************************************************
//Px score matching - 3 or more days of hospice use = treatment variable
*****************************************************************************
*****************************************************************************
tab r_hs_12m_gt3d, missing

*****************************************************************************
*****************************************************************************
//Using Stata's pscore to generate px scores
*****************************************************************************
*****************************************************************************
drop if r_hs_12m_gt3d==.

*****************************************************************************
** User Note: Uses the matchvars global from section Sum stats, unmatched
** if need alternate variable list, update it there
*****************************************************************************
//generate pscore variable hs_pscore
pscore r_hs_12m_gt3d $matchvars, pscore(hs_pscore3) blockid(hs_block) logit detail

//graph without dropping any observations in the matching process
psgraph, treated(r_hs_12m_gt3d) pscore(hs_pscore3)
graph save `logpath'/psgraph_1_gt3d ,replace

//implement radius matching
gen logitpscore3=ln(hs_pscore3/(1-hs_pscore3))
sum logitpscore3

sca cal_ps3=r(sd)*0.02
sca list cal_ps3

***************************************************************************************
** User Note: If change variable or sample list, need to update the caliper here
***************************************************************************************
psmatch2  r_hs_12m_gt3d,outcome(s_cesdbetter) pscore(hs_pscore3) radius caliper(.01871471) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(r_hs_12m_gt3d) pscore(hs_pscore3)
graph save `logpath'/psgraph_2_gt3d ,replace

histogram hs_pscore3 if _support==1, by(r_hs_12m_gt3d) 

//look at balance of matched vs unmatched samples
pstest $matchvars `xvars2',treated(r_hs_12m_gt3d) both hist
graph save `logpath'/psmatch_1_gt3d ,replace

***************************************************************************************
** User Note: If change list of continuous variables, need to update the list here
** to create qqplots here
***************************************************************************************
//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age{
gen `v'_treated_3 = `v' if r_hs_12m_gt3d==1 & _weight!=.
gen `v'_comparison_3 = `v' if r_hs_12m_gt3d==0 & _weight!=.
qqplot `v'_treated_3 `v'_comparison_3
graph save `logpath'/qqplot_`v'_gt3d, replace
}

***************************************************************************************
** User Note: If change number of variables, matrix size needs to be adjusted
** number of rows = 40 in mat vr definition, this will change if number of variables changes
***************************************************************************************
mat vr=J(40,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $matchvars  {
sum `v' if r_hs_12m==1 //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if r_hs_12m==0 //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if r_hs_12m==1 & _support==1 //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if r_hs_12m==0 [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}

***************************************************************************************
** User Note: If change variable list, update rownames here to match
***************************************************************************************
mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1" 

mat list vr

***************************************************************************************
** User Note: If change variable list / caliper, then these counts in comments can change
***************************************************************************************
//using this matching, 11 obs from the treatment group are dropped b/c they don't match
//_support ==1 if matched
//10 not matched, weight=.
tab _support, missing
tab _support if r_hs_12m_gt3d==1, missing
tab _support if r_hs_12m_gt3d==0, missing
tab _weight if r_hs_12m_gt3d==1, missing
sum _weight if r_hs_12m_gt3d==0

//rename ps variables and save dataset so can call them up later
rename _support support_3helper
rename _weight weight_3helper
save spouse_data_sample_v1_ps3_helpers.dta, replace

//drop observations that aren't matched using caliper match
drop if weight_3helper==.

//now run using weighting , outcome = improved CESD score p1
//need to include the variables used in the propensity score
//we probably can't keep both spouse and r gender variables in
logit s_cesdbetter i.r_hs_12m_gt3d  `yearvars' $matchvars [iw=weight_3helper] , or 

est save logit_matched_3, replace

outreg using `logpath'\spouse_analysis_alt_hs_use_def, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score Decreased (by any amount) n1 to p1" \ ///
	"R Hospice enrollment 3 or more days") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions.") ///
	varlabels starlevels(10 5 1)  summstat( N) replace

tab s_cesdbetter s_cesd_ge3better, missing

***************************************************************************************
** User Note: If change variable list, this list to match
***************************************************************************************
//Run logit with outcome=depressed n1, not depressed p1
//Have to use an alternate variable list because missing category for
//advanced directive perfectly predicts failure
local new_varlist cc_all_count_12m_2 cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y /*r_advdir_miss*/ r_discuss_x r_srh_pf_n1 ///
s_age s_female s_white_e  s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1 	

logit s_cesd_ge3better i.r_hs_12m_gt3d  `yearvars' `new_varlist' [iw=weight_3helper] , or 

outreg using `logpath'\spouse_analysis_alt_hs_use_def, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score 3+ n1 to less than 3 p1" \ ///	
	"R Hospice enrollment 3 or more days") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable

*****************************************************************************
*****************************************************************************
*****************************************************************************
*****************************************************************************
//Px score matching - 7 or more days of hospice use = treatment variable
*****************************************************************************
*****************************************************************************
*****************************************************************************
*****************************************************************************
clear all

use spouse_data_sample_v2.dta if (r_adl_sp_helper_x==1 | r_iadl_sp_helper_x==1)

tab r_hs_12m_gt7d, missing

drop if r_hs_12m_gt7d==.

*****************************************************************************
*****************************************************************************
//Using Stata's pscore to generate px scores
*****************************************************************************
*****************************************************************************

//generate pscore variable hs_pscore
pscore r_hs_12m_gt7d $matchvars, pscore(hs_pscore7) blockid(hs_block) logit detail

//graph without dropping any observations in the matching process
psgraph, treated(r_hs_12m_gt7d) pscore(hs_pscore7)
graph save `logpath'/psgraph_1_gt7d ,replace

//implement radius matching
gen logitpscore7=ln(hs_pscore7/(1-hs_pscore7))
sum logitpscore7

sca cal_ps1_7=r(sd)*0.02
sca list cal_ps1_7

***************************************************************************************
** User Note: If change variable or sample list, need to updated the caliper here
***************************************************************************************
//try 0.02* sd
psmatch2  r_hs_12m_gt7d,outcome(s_cesdbetter) pscore(hs_pscore7) radius caliper(.02009195) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(r_hs_12m_gt7d) pscore(hs_pscore7)
graph save `logpath'/psgraph_2_gt7d ,replace

histogram hs_pscore7 if _support==1, by(r_hs_12m_gt7d) 

//look at balance of matched vs unmatched samples
pstest $matchvars ,treated(r_hs_12m_gt7d) both hist
graph save `logpath'/psmatch_1_gt7d ,replace

***************************************************************************************
** User Note: If change list of continuous variables, need to update the list here
** to create qqplots here
***************************************************************************************
//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age {
gen `v'_treated_7 = `v' if r_hs_12m_gt7d==1 & _support==1
gen `v'_comparison_7 = `v' if r_hs_12m_gt7d==0 & _support==1
qqplot `v'_treated_7 `v'_comparison_7
graph save `logpath'/qqplot_`v'_gt7d, replace
}

***************************************************************************************
** User Note: If change number of variables, matrix size needs to be adjusted
** number of rows = 40 in mat vr definition, this will change if number of variables changes
***************************************************************************************
mat vr=J(40,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $matchvars  {
sum `v' if r_hs_12m==1 //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if r_hs_12m==0 //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if r_hs_12m==1 & _support==1 //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if r_hs_12m==0 [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}

***************************************************************************************
** User Note: If change variable list, update rownames here to match
***************************************************************************************
mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1" 

mat list vr

***************************************************************************************
** User Note: If change variable list / caliper, then these counts in comments can change
***************************************************************************************
//using this matching, 12 obs from the treatment group are dropped off common support
//5 obs dropped because not matched
//_support ==1 if matched
tab _support, missing
tab _support if r_hs_12m_gt7d==1, missing
tab _support if r_hs_12m_gt7d==0, missing
tab _weight if r_hs_12m_gt7d==1, missing
sum _weight if r_hs_12m_gt7d==0, detail

//rename ps variables and save dataset so can call them up later
rename _support support_7
rename _weight weight_7
save spouse_data_sample_v1_ps7.dta, replace

//drop observations that aren't matched using caliper match
drop if weight_7==.

//now run using weighting , outcome = improved CESD score p1
//need to include the variables used in the propensity score
//we probably can't keep both spouse and r gender variables in
logit s_cesdbetter i.r_hs_12m_gt7d `yearvars' $matchvars [iw=weight_7] , or 

est save logit_matched_7, replace

outreg using `logpath'\spouse_analysis_alt_hs_use_def, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score Decreased (by any amount) n1 to p1" \ ///
	"R Hospice enrollment 7 or more days") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable

tab s_cesdbetter s_cesd_ge3better, missing

//Run logit with outcome=depressed n1, not depressed p1
//var list with missing advanced directive status omitted
logit s_cesd_ge3better i.r_hs_12m_gt7d `yearvars' `new_varlist' [iw=weight_7] , or 

outreg using `logpath'\spouse_analysis_alt_hs_use_def, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score 3+ n1 to less than 3 p1" \ ///	
	"R Hospice enrollment 7 or more days") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable

/*add matched tables here for 7+ day defintion*/

log close


H="Create bar graph"
/*Outcome variable is: CESD improvement indicator, ie any improvement 
in CESD score from n1 to p1

Defines hospice use as 1 +day in hospice in last year of life

Bar graph of mean change in CESD score hospice and non-hospice group*/

capture log close

clear all
set mem 500m
set more off
set scheme s1color

//Amy's PC
local logpath E:\data\spouse\logs
local datapath E:\data\spouse\final_data

//RG PC
//local logpath C:\data\Spouse\logs
//local datapath C:\data\Spouse

log using "`logpath'\9-HRS_Spouse_means_bar_graph.txt", text replace

cd `datapath'

//use dataset that has px weighting saved from the 1 hospice use definitions
use spouse_data_sample_v1_ps1.dta if s_1yr_p1_core_dead==0

gen byte non_hosp=.
replace non_hosp=1 if r_hs_12m==0
replace non_hosp=0 if r_hs_12m==1
tab non_hosp r_hs_12m, missing
label def non_hosp 0 "Hospice users" 1 "Non-hospice users"
label val non_hosp non_hosp

tab s_cesd_ge3_change 

gen byte s_cesd_ge3same = .
replace s_cesd_ge3same=1 if s_cesd_ge3_change ==0
replace s_cesd_ge3same=0 if inlist(s_cesd_ge3_change,1,-1)

gen byte s_cesd_ge3worse = .
replace s_cesd_ge3worse=1 if s_cesd_ge3_change ==1
replace s_cesd_ge3worse=0 if inlist(s_cesd_ge3_change,-1,0)

tab s_cesd_ge3worse s_cesd_ge3better

label var  s_cesdbetter "Any improvement"
label var  s_cesd_ge3better "Clinical improvement"

local outcomes  s_cesdbetter  s_cesd_ge3better //s_cesdsame  s_cesd_ge3same s_cesdworse  s_cesd_ge3worse
foreach var in `outcomes'{ 
tab `var' 
}

collapse (mean) `outcomes' [iw=weight_1] , by(non_hosp) 

foreach var in `outcomes' {
rename `var' y`var'

}
reshape long y, i(non_hosp) string

tab non_hosp

graph bar y, by(non_hosp/*, label(nolabel)*/, title("Comparison of spouse CESD score change, Interview after 1yr") ) ///
asyvar over(_j, label(labsize(small)))  ///
ytitle("Percent with improvement") ///
ylabel(0 "0" .1 "10" .2 "20" .3 "30" .4 "40")  ///


//legend(label(1 "Clinical improvement") (2 "Any improvement"))

graph save `logpath'/mean_CESD_change_bar_p1_iv_after_1yr,replace
graph export `logpath'/mean_CESD_change_bar_p1_iv_after_1yr.tif,replace

***************************************************************************
//Run for full sample
***************************************************************************

clear all

use spouse_data_sample_v1_ps1.dta

gen byte non_hosp=.
replace non_hosp=1 if r_hs_12m==0
replace non_hosp=0 if r_hs_12m==1
tab non_hosp r_hs_12m, missing
label def non_hosp 0 "Hospice users" 1 "Non-hospice users"
label val non_hosp non_hosp

tab s_cesd_ge3_change 

gen byte s_cesd_ge3same = .
replace s_cesd_ge3same=1 if s_cesd_ge3_change ==0
replace s_cesd_ge3same=0 if inlist(s_cesd_ge3_change,1,-1)

gen byte s_cesd_ge3worse = .
replace s_cesd_ge3worse=1 if s_cesd_ge3_change ==1
replace s_cesd_ge3worse=0 if inlist(s_cesd_ge3_change,-1,0)

tab s_cesd_ge3worse s_cesd_ge3better

label var  s_cesdbetter "Any improvement"
label var  s_cesd_ge3better "Clinical improvement"

local outcomes  s_cesdbetter  s_cesd_ge3better //s_cesdsame  s_cesd_ge3same s_cesdworse  s_cesd_ge3worse
foreach var in `outcomes'{ 
tab `var' 
}

collapse (mean) `outcomes' [iw=weight_1] , by(non_hosp) 

foreach var in `outcomes' {
rename `var' y`var'

}
reshape long y, i(non_hosp) string

tab non_hosp

graph bar y, by(non_hosp/*, label(nolabel)*/, title("Comparison of spouse CESD score change, Full, matched sample") ) ///
asyvar over(_j, label(labsize(small)))  ///
ytitle("Percent with improvement") ///
ylabel(0 "0" .1 "10" .2 "20" .3 "30" .4 "40")  ///


//legend(label(1 "Clinical improvement") (2 "Any improvement"))

graph save `logpath'/mean_CESD_change_bar_p1_full,replace
graph export `logpath'/mean_CESD_change_bar_p1_full.tif,replace

log close


H="xxxxxCreate results figure"
/*Outcome variable is: CESD improvement indicator, ie any improvement 
in CESD score from n1 to p1

Defines hospice use as 1 / 3 / 7 or more days in hospice in last year of life


Need to fix the dataset that this references, it is not right as of 4/7/14!
*/

capture log close

clear all
set mem 500m
set more off
set scheme s1color

//Amy's PC
local logpath E:\data\spouse\logs
local datapath E:\data\spouse\final_data

//RG PC
//local logpath C:\data\Spouse\logs
//local datapath C:\data\Spouse

log using "`logpath'\8-HRS_Spouse_analysis_create_figure.txt", text replace

cd `datapath'

//use dataset that has px weighting saved from the 3 hospice use definitions
use spouse_data_sample_v1_ps1.dta

//merge in weights from 3+ day hospice model
merge 1:1 r_id using spouse_data_sample_v1_ps3.dta, keepusing(weight_3 support_3) 
drop _merge

merge 1:1 r_id using spouse_data_sample_v1_ps7.dta, keepusing(weight_7 support_7) 


//comparison of hospice use definitions
tab r_hs_12m , missing
tab r_hs_12m_gt3d , missing
tab r_hs_12m_gt7d , missing

local yearvars ib2000.r_death_year 


//rename hs use indicator 1+ day to match format of others
rename r_hs_12m r_hs_12m_gt1d
**************************************************************************
//Run the 3 models, use estimates from regression run before, 0 iterations
//1+, 3+, 7+ days hospice use, outcome=any cesd change

foreach i in 1 3 7{

	logit s_cesdbetter r_hs_12m_gt`i'd `yearvars' $matchvars [iw=weight_`i'] , or 
	
	local n`i' = e(N)
	mat  b`i'=e(b)
	mat V`i'=vecdiag(e(V))

	mat b`i'_1 = b`i'[1,"s_cesdbetter:r_hs_12m_gt`i'd"]
	mat v`i'_1 = V`i'[1,"s_cesdbetter:r_hs_12m_gt`i'd"]
}

//merge the matrices for individual models into a single matrix
//note these are the coefficients, not the exponentiated coefficients - odds ratios
foreach x in b v{
	mat `x'_all_1=J(3,1,.)
	mat `x'_all_1[1,1] = `x'1_1[1,1]
	mat `x'_all_1[2,1] = `x'3_1[1,1]
	mat `x'_all_1[3,1] = `x'7_1[1,1]

	svmat `x'_all_1
}

gen int sitenum = 1 in 1/3
replace sitenum = 3 in 2
replace sitenum = 7 in 3

l sitenum b_all_1 v_all_1 in 1/3

gen se_all = sqrt(v_all_1)

gen ll_all=b_all_1 - 1.96*se_all
gen ul_all=b_all_1 + 1.96*se_all

//convert to odds ratios
gen b_e=exp(b_all_1)
gen ll_e=exp(ll_all)
gen ul_e=exp(ul_all)

l b_e ll_e ul_e in 1/3

twoway rcap ll_e ul_e sitenum, color(gs9) ///
	|| scatter b_e sitenum, color(midblue) ///
	yline(1) yscale(range(0 2)) ///
	xscale(range(0 8)) xlabel(1 "1+ days, N=`n1'" 3 "3+days, N=`n3'" 7 "7+days, N=`n7'") xtitle("Days hospice use") ///
	legend(order(2 1) symxsize(*.5) cols(2) ///
	label(1 95% confidence interval) label(2 OR) ) ///
	title("Odds ratios from logit regression") ///
	subtitle("Outcome=Any improvement in CESD score n1 to p1")
graph save `logpath'/hs_1_3_7_days_compar,replace
graph export `logpath'/hs_1_3_7_days_compar.eps,replace

log close


H="OR Plot, Clinical improv and any improv for helpers, timing"
/*weights saved

overall model: spouse_data_sample_v1_ps3.dta
helper: spouse_data_sample_v1_ps3_helpers.dta
interview after 1 year: spouse_data_sample_v1_ps3_after

*/

capture log close

clear all
set mem 500m
set more off
set scheme s1color

//Amy's PC
local logpath E:\data\spouse\logs
local datapath E:\data\spouse\final_data

//RG PC
//local logpath C:\data\Spouse\logs
//local datapath C:\data\Spouse

log using "`logpath'\10-HRS_Spouse_OR_plot.txt", text replace

cd `datapath'

use spouse_data_sample_v1_ps3.dta

***************************************************************************************
** User Note: If want to change the list of variables used in propensity score matching
** for this section, change it here
***************************************************************************************
global matchvars cc_all_count_12m_2 cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y r_advdir_miss r_discuss_x r_srh_pf_n1 ///
s_age s_female s_white_e  s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1 //hci_index hospital_beds specialists	


tab r_core_year_n1

merge 1:1 r_id using spouse_data_sample_v1_ps3_helpers.dta, keepusing(weight_3helper) 
drop _merge

merge 1:1 r_id using spouse_data_sample_v1_ps3_after.dta, keepusing(weight_after1yr) 
drop _merge

local yearvars ib2000.r_death_year 

**********************************************************************
//clinical improvement, full sample
logit s_cesd_ge3better r_hs_12m_gt3d `yearvars' $matchvars [iw=weight_3] , or 
	
	local n_oa_cl = e(N)
	mat  b_oa_cl=e(b)
	mat V_oa_cl=vecdiag(e(V))

	mat b_oa_cl_1 = b_oa_cl[1,"s_cesd_ge3better:r_hs_12m_gt3d"]
	mat v_oa_cl_1 = V_oa_cl[1,"s_cesd_ge3better:r_hs_12m_gt3d"]

**********************************************************************
//any improvement, full sample
logit s_cesdbetter r_hs_12m_gt3d `yearvars' $matchvars [iw=weight_3] , or 

	local n_oa_any = e(N)
	mat  b_oa_any=e(b)
	mat V_oa_any=vecdiag(e(V))

	mat b_oa_any_1 = b_oa_any[1,"s_cesdbetter:r_hs_12m_gt3d"]
	mat v_oa_any_1 = V_oa_any[1,"s_cesdbetter:r_hs_12m_gt3d"]

**********************************************************************
//clinical improvement, helpers

***************************************************************************************
** User Note: If want change the list of variables in the helper analysis section
** need to update it here to match
***************************************************************************************
//need alternate matchvariables definition b/c missing advanced directive
//is perfectly correlated with outcome
local matchvars2 cc_all_count_12m_2 cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y /*r_advdir_miss*/ r_discuss_x r_srh_pf_n1 ///
s_age s_female s_white_e  s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1 //hci_index hospital_beds specialists	

logit s_cesd_ge3better r_hs_12m_gt3d `yearvars' `matchvars2' [iw=weight_3helper] , or 
	
	local n_h_cl = e(N)
	mat  b_h_cl=e(b)
	mat V_h_cl=vecdiag(e(V))

	mat b_h_cl_1 = b_h_cl[1,"s_cesd_ge3better:r_hs_12m_gt3d"]
	mat v_h_cl_1 = V_h_cl[1,"s_cesd_ge3better:r_hs_12m_gt3d"]

**********************************************************************
//any improvement, helpers
logit s_cesdbetter r_hs_12m_gt3d `yearvars' $matchvars [iw=weight_3helper] , or 

	local n_h_any = e(N)
	mat  b_h_any=e(b)
	mat V_h_any=vecdiag(e(V))

	mat b_h_any_1 = b_h_any[1,"s_cesdbetter:r_hs_12m_gt3d"]
	mat v_h_any_1 = V_h_any[1,"s_cesdbetter:r_hs_12m_gt3d"]

/**********************************************************************
//clinical improvement, interview after 1 year
logit s_cesd_ge3better r_hs_12m_gt3d `yearvars' `matchvars2' [iw=weight_after1yr] , or 
	
	local n_a1_cl = e(N)
	mat  b_a1_cl=e(b)
	mat V_a1_cl=vecdiag(e(V))

	mat b_a1_cl_1 = b_a1_cl[1,"s_cesd_ge3better:r_hs_12m_gt3d"]
	mat v_a1_cl_1 = V_a1_cl[1,"s_cesd_ge3better:r_hs_12m_gt3d"]

**********************************************************************/
//any improvement, interview after 1 year
logit s_cesdbetter r_hs_12m_gt3d `yearvars' `matchvars2' [iw=weight_after1yr] , or 

	local n_a1_any = e(N)
	mat  b_a1_any=e(b)
	mat V_a1_any=vecdiag(e(V))

	mat b_a1_any_1 = b_a1_any[1,"s_cesdbetter:r_hs_12m_gt3d"]
	mat v_a1_any_1 = V_a1_any[1,"s_cesdbetter:r_hs_12m_gt3d"]

**********************************************************************
//merge the matrices together - clininical improvement stats
foreach x in b v{
	mat `x'_cl_all=J(6,1,.)
	mat `x'_cl_all[1,1]=`x'_oa_cl_1[1,1]
	mat `x'_cl_all[2,1]=`x'_h_cl_1[1,1]
	//mat `x'_cl_all[3,1]=`x'_a1_cl_1[1,1]
	
	svmat `x'_cl_all
	}

foreach x in b v{
	mat `x'_any_all=J(3,1,.)
	mat `x'_any_all[1,1]=`x'_oa_any_1[1,1]
	mat `x'_any_all[2,1]=`x'_h_any_1[1,1]
	mat `x'_any_all[3,1]=`x'_a1_any_1[1,1]
	
	svmat `x'_any_all
	}


gen int sitenum = 1 in 1/3
replace sitenum=2 in 2
replace sitenum=3 in 3

gen sitenum2 = .8 in 1/3
replace sitenum2 = 1.8 in 2
replace sitenum2 = 2.8 in 3

list sitenum sitenum2 b_cl_all b_any_all v_cl_all v_any_all in 1/3

foreach x in cl any{
gen se_`x'_all = sqrt(v_`x'_all)

gen ll_`x'_all=b_`x'_all - 1.96*se_`x'_all
gen ul_`x'_all=b_`x'_all + 1.96*se_`x'_all

//convert to odds ratios
gen b_`x'_e=exp(b_`x'_all)
gen ll_`x'_e=exp(ll_`x'_all)
gen ul_`x'_e=exp(ul_`x'_all)

}

list sitenum b_cl_e b_any_e in 1/3

twoway rcap ll_cl_e ul_cl_e sitenum2, color(gs9) ///
	|| scatter b_cl_e sitenum2, color(midblue) ///
	|| rcap ll_any_e ul_any_e sitenum, color(gs5) ///
	|| scatter b_any_e sitenum, color(orange) ///
	yline(1) yscale(range(0 2)) ///
	xscale(range(0 3.5)) xlabel(1 "Overall sample N=`n_oa_cl'" ///
	2 "Helpers, N=`n_h_cl'" 3 "Ivw gt 1yr, N=`n_a1_any'") xtitle("Sample") ///
	legend(order(4 3 2 1) symxsize(*.5) cols(2) ///
	label(1 95% confidence interval) label(2 OR Clinical improvement) ///
		label(3 95% confidence interval) label(4 OR Any improvement) )  ///
	title("Odds ratios from logit regression") ///
	subtitle("OR for overall sample, helpers, and interview after 1 year of R's death")
graph save `logpath'/or_compar,replace
graph export `logpath'/or_compar.eps,replace

log close


H="OR Plot, Rev 2 adding Helper > 1 year"
/*weights saved

overall model: spouse_data_sample_v1_ps3.dta
helper: spouse_data_sample_v1_ps3_helpers.dta
interview after 1 year: spouse_data_sample_v1_ps3_after

*/

capture log close

clear all
set mem 500m
set more off
set scheme s1color

//Amy's PC
local logpath E:\data\spouse\logs
local datapath E:\data\spouse\final_data

//RG PC
//local logpath C:\data\Spouse\logs
//local datapath C:\data\Spouse

log using "`logpath'\10-HRS_Spouse_OR_plot_v2.txt", text replace

cd `datapath'

use spouse_data_sample_v1_ps3.dta

tab r_core_year_n1

merge 1:1 r_id using spouse_data_sample_v1_ps3_helpers.dta, keepusing(weight_3helper) 
drop _merge

merge 1:1 r_id using spouse_data_sample_v1_ps3_after.dta, keepusing(weight_after1yr) 
drop _merge

merge 1:1 r_id using spouse_data_sample_v1_ps3_after_helpers.dta, keepusing(weight_helpafter1yr)
drop _merge

local yearvars ib2000.r_death_year 

**********************************************************************
//clinical improvement, full sample
logit s_cesd_ge3better r_hs_12m_gt3d `yearvars' $matchvars [iw=weight_3] , or 
	
	local n_oa_cl = e(N)
	mat  b_oa_cl=e(b)
	mat V_oa_cl=vecdiag(e(V))

	mat b_oa_cl_1 = b_oa_cl[1,"s_cesd_ge3better:r_hs_12m_gt3d"]
	mat v_oa_cl_1 = V_oa_cl[1,"s_cesd_ge3better:r_hs_12m_gt3d"]

**********************************************************************
//any improvement, full sample
logit s_cesdbetter r_hs_12m_gt3d `yearvars' $matchvars [iw=weight_3] , or 

	local n_oa_any = e(N)
	mat  b_oa_any=e(b)
	mat V_oa_any=vecdiag(e(V))

	mat b_oa_any_1 = b_oa_any[1,"s_cesdbetter:r_hs_12m_gt3d"]
	mat v_oa_any_1 = V_oa_any[1,"s_cesdbetter:r_hs_12m_gt3d"]

**********************************************************************
//clinical improvement, helpers

***************************************************************************************
** User Note: If want change the list of variables in the helper analysis section
** need to update it here to match
***************************************************************************************
//need alternate matchvariables definition b/c missing advanced directive
//is perfectly correlated with outcome
local matchvars2 cc_all_count_12m_2 cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y /*r_advdir_miss*/ r_discuss_x r_srh_pf_n1 ///
s_age s_female s_white_e  s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1 //hci_index hospital_beds specialists	

logit s_cesd_ge3better r_hs_12m_gt3d `yearvars' `matchvars2' [iw=weight_3helper] , or 
	
	local n_h_cl = e(N)
	mat  b_h_cl=e(b)
	mat V_h_cl=vecdiag(e(V))

	mat b_h_cl_1 = b_h_cl[1,"s_cesd_ge3better:r_hs_12m_gt3d"]
	mat v_h_cl_1 = V_h_cl[1,"s_cesd_ge3better:r_hs_12m_gt3d"]

**********************************************************************
//any improvement, helpers
logit s_cesdbetter r_hs_12m_gt3d `yearvars' $matchvars [iw=weight_3helper] , or 

	local n_h_any = e(N)
	mat  b_h_any=e(b)
	mat V_h_any=vecdiag(e(V))

	mat b_h_any_1 = b_h_any[1,"s_cesdbetter:r_hs_12m_gt3d"]
	mat v_h_any_1 = V_h_any[1,"s_cesdbetter:r_hs_12m_gt3d"]

/**********************************************************************
//clinical improvement, interview after 1 year
logit s_cesd_ge3better r_hs_12m_gt3d `yearvars' `matchvars2' [iw=weight_after1yr] , or 
	
	local n_a1_cl = e(N)
	mat  b_a1_cl=e(b)
	mat V_a1_cl=vecdiag(e(V))

	mat b_a1_cl_1 = b_a1_cl[1,"s_cesd_ge3better:r_hs_12m_gt3d"]
	mat v_a1_cl_1 = V_a1_cl[1,"s_cesd_ge3better:r_hs_12m_gt3d"]

**********************************************************************/
//any improvement, interview after 1 year
logit s_cesdbetter r_hs_12m_gt3d `yearvars' `matchvars2' [iw=weight_after1yr] , or 

	local n_a1_any = e(N)
	mat  b_a1_any=e(b)
	mat V_a1_any=vecdiag(e(V))

	mat b_a1_any_1 = b_a1_any[1,"s_cesdbetter:r_hs_12m_gt3d"]
	mat v_a1_any_1 = V_a1_any[1,"s_cesdbetter:r_hs_12m_gt3d"]

/**********************************************************************
//clinical improvement, helpers interview after 1 year
logit s_cesd_ge3better r_hs_12m_gt3d `yearvars' `matchvars2' [iw=weight_after1yr] , or 
	
	local n_ha1_cl = e(N)
	mat  b_ha1_cl=e(b)
	mat V_ha1_cl=vecdiag(e(V))

	mat b_ha1_cl_1 = b_ha1_cl[1,"s_cesd_ge3better:r_hs_12m_gt3d"]
	mat v_ha1_cl_1 = V_ha1_cl[1,"s_cesd_ge3better:r_hs_12m_gt3d"]

**********************************************************************/
//any improvement, helpers interview after 1 year
logit s_cesdbetter r_hs_12m_gt3d `yearvars' `matchvars2' [iw=weight_helpafter1yr] , or 

	local n_ha1_any = e(N)
	mat  b_ha1_any=e(b)
	mat V_ha1_any=vecdiag(e(V))

	mat b_ha1_any_1 = b_ha1_any[1,"s_cesdbetter:r_hs_12m_gt3d"]
	mat v_ha1_any_1 = V_ha1_any[1,"s_cesdbetter:r_hs_12m_gt3d"]




**********************************************************************
//merge the matrices together - clininical improvement stats
foreach x in b v{
	mat `x'_cl_all=J(6,1,.)
	mat `x'_cl_all[1,1]=`x'_oa_cl_1[1,1]
	mat `x'_cl_all[2,1]=`x'_h_cl_1[1,1]
	//mat `x'_cl_all[3,1]=`x'_a1_cl_1[1,1]
	
	svmat `x'_cl_all
	}

foreach x in b v{
	mat `x'_any_all=J(4,1,.)
	mat `x'_any_all[1,1]=`x'_oa_any_1[1,1]
	mat `x'_any_all[2,1]=`x'_h_any_1[1,1]
	mat `x'_any_all[3,1]=`x'_a1_any_1[1,1]
	mat `x'_any_all[4,1]=`x'_ha1_any_1[1,1]

	svmat `x'_any_all
	}


gen int sitenum = 1 in 1/4
replace sitenum=2 in 2
replace sitenum=3 in 3
replace sitenum=4 in 4

gen sitenum2 = .8 in 1/4
replace sitenum2 = 1.8 in 2
replace sitenum2 = 2.8 in 3
replace sitenum2 = 3.8 in 4

list sitenum sitenum2 b_cl_all b_any_all v_cl_all v_any_all in 1/4

foreach x in cl any{
gen se_`x'_all = sqrt(v_`x'_all)

gen ll_`x'_all=b_`x'_all - 1.96*se_`x'_all
gen ul_`x'_all=b_`x'_all + 1.96*se_`x'_all

//convert to odds ratios
gen b_`x'_e=exp(b_`x'_all)
gen ll_`x'_e=exp(ll_`x'_all)
gen ul_`x'_e=exp(ul_`x'_all)

}

list sitenum b_cl_e b_any_e in 1/4

twoway rcap ll_cl_e ul_cl_e sitenum2, color(gs9) ///
	|| scatter b_cl_e sitenum2, color(midblue) ///
	|| rcap ll_any_e ul_any_e sitenum, color(gs5) ///
	|| scatter b_any_e sitenum, color(orange) ///
	yline(1) yscale(range(0 2)) ///
	xscale(range(0 4.5)) xlabel(1 `" "Overall" "N=`n_oa_cl'" "' ///
	2 `""Helpers" "N=`n_h_cl'" "' 3 `" "Ivw>1yr" "N=`n_a1_any'" "' 4 `" "Helpers Ivw>1yr" "N=`n_ha1_any'" "') xtitle("Sample") ///
	legend(order(4 3 2 1) symxsize(*.5) cols(2) ///
	label(1 95% confidence interval) label(2 OR Clinical improvement) ///
		label(3 95% confidence interval) label(4 OR Any improvement) )  ///
	title("Odds ratios from logit regression") ///
	subtitle("OR for overall sample, helpers, and interview after 1 year of R's death")
graph save `logpath'/or_compar_v2,replace
graph export `logpath'/or_compar_v2.eps,replace

log close


H="xxxxxka stata"
/*This is copied from spouse_data_mar11_2013 and then
modified so it runs to try and figure out how Ling had it working
*/
capture log close 
clear all
//log using E:\data\spouse\logs\Ling_ps_match_code.txt, text replace
log using C:\data\spouse\logs\Ling_ps_match_code.txt, text replace

set more off

*choose dates 7-365. etc*/
global hs_days_low 1
global hs_days_high 365
//use "C:\projects\spouse_ip_admit_impact\final_data\spouse_data.dta",clear

use C:\data\spouse\spouse_data_sample_public.dta if (p1_wi_90d==0 & no_el_comorb_12m==0 & sudden_cause_death==0 & cesd_miss_n1_p1==0)


/*determine which surviving spouses have p1 and n1 interview*/
/*gen sp_miss_p1=0
replace sp_miss_p1=1 if s_c_ivw_date_p1==.


gen sp_miss_n1=0

replace sp_miss_n1=1 if s_c_ivw_date_n1==.
tab sp_miss_n1

keep if sp_miss_p1==0
keep if sp_miss_n1==0


/*remove those with no comorbidities year 1*/
keep if comorb_all_0d_n12m>0

/*remove those who died unexpectedly*/
*tab r_cause_death_12_e 
drop if ltrim(r_cause_death_12_e) =="Accidents, Suicide, Homicide"

/*diff in days betwen respondent death and last spouse interview-  create variable to see those more than 2 years*/
gen days_n1_core_dead=r_death_date_e-s_c_ivw_date_n1
*tab days_n1_core_dead

gen days_n1_core_dead2=0
replace days_n1_core_dead2=1 if days_n1_core_dead>730
*tab days_n1_core_dead2

/*diff in days betwen respondent death and  first spouse interview*/
gen days_p1_core_dead=s_c_ivw_date_p1-r_death_date_e

/*diff in days betwen spouse p1 and spouse n1*/
gen s_days_n1_p1=s_c_ivw_date_p1-s_c_ivw_date_n1
*tab s_days_n1_p1
*sum s_days_n1_p1

*remove people with core interview within 90 days of R's death date*
keep if days_p1_core_dead>90

* removes people with Core interview too close to R's death date (within study window)
*keep if days_n1_core_dead>$hs_days_high

* removes those enrolled in hospice prior to start of desired range
*drop if hs_los_12m>$hs_days_high


*remove missing spouse CESD scores*

gen sp_CESD_p1=0
replace sp_CESD_p1=1 if s_cesd_tot_p1==.

gen sp_CESD_n1=0
replace sp_CESD_n1=1 if s_cesd_tot_n1==.

*tab sp_CESD_p1 sp_CESD_n1

keep if sp_CESD_p1==0
keep if sp_CESD_n1==0
*/

gen hs_days_range_$hs_days_low$hs_days_high=0
replace hs_days_range_$hs_days_low$hs_days_high=1 if (hs_los_12m<=$hs_days_high  & hs_los_12m>=$hs_days_low & hs_los_12m<. & hs_los_12m!=0)

tab   hs_days_range_$hs_days_low$hs_days_high
*tab s_cesd_tot_ge3_p1
*tab s_cesd_tot_ge3_n1

*look at raw differences between 2 groups relative to outcomes
*tab s_cesd_tot_ge3_p1
*tab s_cesd_tot_ge3_p1 hs_days_range_$hs_days_low$hs_days_high, col chi

/*create other cesd outcome variable*/
/*gen s_cesdchange= s_cesd_tot_p1- s_cesd_tot_n1
*tab s_cesdchange

*histogram s_cesdchange


gen s_cesdbetter=0
replace s_cesdbetter= 1 if s_cesdchange <0
gen s_cesdworse=0
replace s_cesdworse= 1 if s_cesdchange >0
replace s_cesdworse= . if s_cesdchange ==.
replace s_cesdbetter= . if s_cesdchange ==.
*tab s_cesdbetter s_cesdworse
*tab s_cesdchange


gen s_cesdchange_3 =0
replace s_cesdchange_3 =1 if s_cesdchange >0
replace s_cesdchange_3 =-1 if s_cesdchange <0
replace s_cesdchange_3= . if s_cesdchange ==.
*tab s_cesdchange_3

*cesd improved from <3 to 3-  look at CESD 3 clin depression change (three options compared to improved or not*
gen s_cesd_ge3_change= s_cesd_tot_ge3_p1- s_cesd_tot_ge3_n1
gen  s_cesd_ge3better=0
replace s_cesd_ge3better= 1 if s_cesd_ge3_change<0
replace s_cesd_ge3better= . if s_cesd_tot_ge3_p1 ==.
replace s_cesd_ge3better= . if s_cesd_tot_ge3_n1 ==.

*tab s_cesd_ge3better s_cesd_ge3_change

gen  s_cesd_ge3betterorsame=0
replace s_cesd_ge3betterorsame= 1 if s_cesd_ge3_change<=0
replace s_cesd_ge3betterorsame= . if s_cesd_tot_ge3_p1 ==.
replace s_cesd_ge3betterorsame= . if s_cesd_tot_ge3_n1 ==.
*tab s_cesd_ge3betterorsame s_cesd_ge3better 
*tab s_cesd_ge3betterorsame hs_days_range_$hs_days_low$hs_days_high, col chi
*tab s_cesd_ge3better hs_days_range_$hs_days_low$hs_days_high, col chi
*/


*logit s_cesd_tot_ge3_p1  hs_days_range_$hs_days_low$hs_days_high,or

*tab  s_cesdbetter  hs_days_range_$hs_days_low$hs_days_high,col
*tab  s_cesdbetter  hs_days_range_$hs_days_low$hs_days_high,ch

*check missingness in explanatory variables
tab s_cesdbetter, missing
tab hs_days_range_$hs_days_low$hs_days_high , missing
tab comorb_all_0d_n12m, missing
sum r_age
tab r_female, missing
//tab r_white_e, missing
tab r_hseduc_n1_n3, missing
sum r_networth_n1
tab s_hseduc_n1_n3, missing
tab r_nhres_n1, missing
tab r_srh_pf_n1, missing
sum hci_index
sum hospital_beds 
sum specialists	

*controlling for other variables (unmatched logit model)
logit s_cesdbetter  hs_days_range_$hs_days_low$hs_days_high comorb_all_0d_n12m r_age r_female ///
	/*r_white_e*/ r_hseduc_n1_n3	r_networth_n1 s_hseduc_n1_n3 r_nhres_n1 r_srh_pf_n1 hci_index ///
	hospital_beds specialists	, or


*tab  s_cesdworse hs_days_range_$hs_days_low$hs_days_high,col
*tab  s_cesdworse  hs_days_range_$hs_days_low$hs_days_high,ch


/*prop score -revised from amy's variables prop score- remove catarcats, glaucoma, lives with,relatives*/
global indv  comorb_all_0d_n12m  cc_3_alzhdmta_n12mn0  cc_ami_isch_n12mn0 cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 ///
cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 cc_15_ra_oa_n12mn0 ///
r_age	r_female 	/*r_white_e*/ r_hseduc_n1_n3	 r_networth_n1 	r_nhres_n1 r_imprelig_vimp_n1	///
r_adl_stable_partial_n1n2  	r_adl_stable_severe_n1n2 r_adl_change_i_m_n1n2 	r_adl_change_m_s_n1n2 ///
r_adl_change_i_s_n1n2 r_medicaid_n1 	r_champus_n1 	r_medigap_n1 	r_advdir_x 	r_discuss_x ///
r_srh_pf_n1 hci_index hospital_beds specialists	
 


/*finding std for PS*/
gen x=uniform()
sort x
set seed 2000

set matsize 800


logit hs_days_range_$hs_days_low$hs_days_high  $indv
predict yhat
sum yhat if hs_days_range_$hs_days_low$hs_days_high==1

*.1619774 , = , the new std is  so the new radius ,
*0.01 *(0.162)=0.00162,.05*(0.168)

//plug in std for caliper PS matching
psmatch2 hs_days_range_$hs_days_low$hs_days_high  $indv, radius caliper(0.01698) logit

//how many does this drop???
*gen variable those dropped
gen ps_drop=0
replace ps_drop=1 if _weight==.

*compare those drop from ps and those not

*tab alzhdmta_n12mn0 ps_drop, chi


tab hs_days_range_$hs_days_low$hs_days_high ps_drop
drop if _weight==.



***compare variables included in PS to see how well they match up-- 
*tab alzhdmta_n12mn0 hs_days_range_$hs_days_low$hs_days_high [iweight=_weight]

*logit hs_days_range_$hs_days_low$hs_days_high  alzhdmta_n12mn0[iweight=_weight]

*logit hs_days_range_$hs_days_low$hs_days_high  chrnkidn_n12mn0 [iweight=_weight]
*logit hs_days_range_$hs_days_low$hs_days_high  ami_isch_n12mn0[iweight=_weight]
*logit hs_days_range_$hs_days_low$hs_days_high  chf_n12mn0[iweight=_weight]
*logit hs_days_range_$hs_days_low$hs_days_high  diabetes_n12mn0[iweight=_weight]
*logit hs_days_range_$hs_days_low$hs_days_high  copd_n12mn0[iweight=_weight]
*logit hs_days_range_$hs_days_low$hs_days_high  strketia_n12mn0[iweight=_weight]
*logit hs_days_range_$hs_days_low$hs_days_high  cncr_chronic_n12mn0 [iweight=_weight]

*logit hs_days_range_$hs_days_low$hs_days_high  atrialfb_n12mn0[iweight=_weight]
*logit hs_days_range_$hs_days_low$hs_days_high  hipfrac_n12mn0 [iweight=_weight]
*logit hs_days_range_$hs_days_low$hs_days_high  depressn_n12mn0 [iweight=_weight]
*logit hs_days_range_$hs_days_low$hs_days_high  osteoprs_n12mn0 [iweight=_weight]
*logit hs_days_range_$hs_days_low$hs_days_high  ra_oa_n12mn0[iweight=_weight]


*logit hs_days_range_$hs_days_low$hs_days_high  r_age[iweight=_weight]
*logit hs_days_range_$hs_days_low$hs_days_high  r_female[iweight=_weight]

*logit hs_days_range_$hs_days_low$hs_days_high  r_white_e[iweight=_weight]
*logit hs_days_range_$hs_days_low$hs_days_high  r_hseduc	[iweight=_weight]
*logit hs_days_range_$hs_days_low$hs_days_high  r_networth_n1[iweight=_weight]
*logit hs_days_range_$hs_days_low$hs_days_high  r_nhres_n1[iweight=_weight]
*logit hs_days_range_$hs_days_low$hs_days_high  r_imprelig_vimp_n1[iweight=_weight]
*logit hs_days_range_$hs_days_low$hs_days_high  r_adl_stable_partial_n1n2 [iweight=_weight]
*logit hs_days_range_$hs_days_low$hs_days_high  r_medicaid_n1 [iweight=_weight]
*logit hs_days_range_$hs_days_low$hs_days_high  hospital_beds [iweight=_weight]
*logit hs_days_range_$hs_days_low$hs_days_high  specialists	 [iweight=_weight]
*logit hs_days_range_$hs_days_low$hs_days_high  r_advdir_x [iweight=_weight]


*analysis with PS matching

//rg added to see what the _weight variable is, created by psmatch2 code above
sum _weight if hs_days_range_$hs_days_low$hs_days_high==1
sum _weight if hs_days_range_$hs_days_low$hs_days_high==0

logit s_cesdbetter hs_days_range_$hs_days_low$hs_days_high [iweight=_weight], or
logit s_cesdbetter hs_days_range_$hs_days_low$hs_days_high s_age s_female /*s_white_e*/ ///
	s_hseduc_n1_n3 s_srh_pf_p1[iweight=_weight], or


*comapre sample include in PS matching for Table 1*

tab cc_3_alzhdmta_n12mn0 hs_days_range_$hs_days_low$hs_days_high [iweight=_weight]

tab hs_days_range_$hs_days_low$hs_days_high  cc_3_alzhdmta_n12mn0, row chi

tab hs_days_range_$hs_days_low$hs_days_high  cc_6_chrnkidn_n12mn0, row chi
tab hs_days_range_$hs_days_low$hs_days_high  cc_ami_isch_n12mn0, row chi
tab hs_days_range_$hs_days_low$hs_days_high  cc_8_chf_n12mn0, row chi
tab hs_days_range_$hs_days_low$hs_days_high  cc_9_diabetes_n12mn0, row chi
tab  hs_days_range_$hs_days_low$hs_days_high  cc_7_copd_n12mn0 , row chi
tab hs_days_range_$hs_days_low$hs_days_high  cc_16_strketia_n12mn0, row chi
tab hs_days_range_$hs_days_low$hs_days_high  cc_cncr_chronic_n12mn0, row chi

tab hs_days_range_$hs_days_low$hs_days_high  cc_4_atrialfb_n12mn0, row chi
tab hs_days_range_$hs_days_low$hs_days_high  cc_11_hipfrac_n12mn0 , row chi
tab hs_days_range_$hs_days_low$hs_days_high  cc_13_depressn_n12mn0 , row chi
tab hs_days_range_$hs_days_low$hs_days_high  cc_14_osteoprs_n12mn0 , row chi
tab hs_days_range_$hs_days_low$hs_days_high  cc_15_ra_oa_n12mn0, row chi


tab hs_days_range_$hs_days_low$hs_days_high  r_female, row chi
//tab hs_days_range_$hs_days_low$hs_days_high  r_white_e, row chi
tab hs_days_range_$hs_days_low$hs_days_high  r_hseduc_n1_n3 , row chi
tab hs_days_range_$hs_days_low$hs_days_high  r_nhres_n1 , row chi
tab hs_days_range_$hs_days_low$hs_days_high  r_medicaid_n1 , row chi


tab hs_days_range_$hs_days_low$hs_days_high  r_advdir_ , row chi

tab hs_days_range_$hs_days_low$hs_days_high  r_adl_stable_partial_n1n2 , row chi
tab hs_days_range_$hs_days_low$hs_days_high  r_adl_stable_severe_n1n2, row chi
tab hs_days_range_$hs_days_low$hs_days_high  r_adl_change_i_m_n1n2, row chi
tab hs_days_range_$hs_days_low$hs_days_high  r_adl_change_m_s_n1n2 , row chi
tab hs_days_range_$hs_days_low$hs_days_high  r_adl_change_i_s_n1n2, row chi

tab hs_days_range_$hs_days_low$hs_days_high   r_adl_stable_ind_n1n2, row chi




****FINISH HERE--  now compare SPOUSE VARIABLES***  and regional variables  *hospital_beds
* specialists

/*

tab hs_days_range_$hs_days_low$hs_days_high  s_cesd_tot_p1, row chi


*death expected variable
*tab r_dexp_x hs_days_range_$hs_days_low$hs_days_high, row



//looking at helper
*keep if r_adl_sp_helper_x==1|r_iadl_sp_helper_x==1

tab hs_days_range_$hs_days_low$hs_days_high




*limiting sample to feamle respondents only*
keep if s_female==1

logit s_cesdbetter  hs_days_range_$hs_days_low$hs_days_high, or 


tab  s_cesd_ge3_change hs_days_range_$hs_days_low$hs_days_high,col
tab  s_cesd_ge3_change  hs_days_range_$hs_days_low$hs_days_high,ch

tab  s_cesd_ge3better hs_days_range_$hs_days_low$hs_days_high,col
tab  s_cesd_ge3better  hs_days_range_$hs_days_low$hs_days_high,ch

ologit s_cesd_ge3_change  hs_days_range_$hs_days_low$hs_days_high, or

regress s_cesdchange hs_days_range_$hs_days_low$hs_days_high



//look at hospice use
keep if hs_days_range_$hs_days_low$hs_days_high ==1
su hs_los_12
tab hs_los_12

*may 2013*
*examine location of death and cesd.  loc_hops = death in hopsital.  
*no difference in raw clinical depression (CESD and hopsital death)*
tab  r_location_x r_loc_hosp_x
tab s_cesd_tot_ge3_p1 r_loc_hosp_x, col chi
tab s_srh_p1 r_loc_hosp_x, col chi

tab s_cesdbetter r_loc_hosp_x, col chi

//tab s_srhbetter r_loc_hosp_x, col chi ****RG commented out

logit s_cesdbetter  r_loc_hosp_x, or
*multivariate-  spousal factors
logit s_cesdbetter  r_loc_hosp_x s_age s_female s_white_e s_hseduc  s_srh_pf_p1 , or


*multivariate-  all factors
logit s_cesdbetter  r_loc_hosp_x comorb_all_0d_n12m alzhdmta_n12mn0 depressn_n12mn0 r_age	r_female 	r_white_e r_hseduc	 r_networth_n1 	r_nhres_x r_imprelig_vimp_n1	r_adl_stable_partial_n1n2  	r_adl_stable_severe_n1n2 r_adl_change_i_m_n1n2 	r_adl_change_m_s_n1n2 	r_adl_change_i_s_n1n2 r_medicaid_n1 	r_champus_n1 	r_medigap_n1 	r_advdir_x 	r_discuss_x	r_srh_pf_n1 hci_index hospital_beds specialists s_age s_srh_pf_p1 , or	

tab   r_nhres_x 

drop  if r_nhres_x ==1
logit s_cesdbetter  r_loc_hosp_x comorb_all_0d_n12m alzhdmta_n12mn0 depressn_n12mn0 r_age	r_female 	r_white_e r_hseduc	 r_networth_n1 	r_imprelig_vimp_n1	r_adl_stable_partial_n1n2  	r_adl_stable_severe_n1n2 r_adl_change_i_m_n1n2 	r_adl_change_m_s_n1n2 	r_adl_change_i_s_n1n2 r_medicaid_n1 	r_champus_n1 	r_medigap_n1 	r_advdir_x 	r_discuss_x	r_srh_pf_n1 hci_index hospital_beds specialists s_age s_srh_pf_p1 , or	


tab r_nhres_n1 r_location_x , row chi

*prop score*
*revised prop score- remove catarcats, glaucoma, lives with,relatives*
global indv  comorb_all_0d_n12m alzhdmta_n12mn0 ami_isch_n12mn0 chf_n12mn0 diabetes_n12mn0 chrnkidn_n12mn0 copd_n12mn0 strketia_n12mn0 cncr_chronic_n12mn0 atrialfb_n12mn0 hipfrac_n12mn0 depressn_n12mn0 osteoprs_n12mn0 ra_oa_n12mn0 r_age	r_female 	r_white_e r_hseduc	 r_networth_n1 	r_nhres_n1 r_imprelig_vimp_n1	r_adl_stable_partial_n1n2  	r_adl_stable_severe_n1n2 r_adl_change_i_m_n1n2 	r_adl_change_m_s_n1n2 	r_adl_change_i_s_n1n2 r_medicaid_n1 	r_champus_n1 	r_medigap_n1 	r_advdir_x 	r_discuss_x	r_srh_pf_n1 hci_index hospital_beds specialists	
 *gen hs_days_range_$hs_days_low$hs_days_high=0
*replace hs_days_range_$hs_days_low$hs_days_high=1 if (hs_los_12m<=$hs_days_high  & hs_los_12m>=$hs_days_low & hs_los_12m<. & hs_los_12m!=0)

 //finding std for PS
  drop x yhat ps_drop// RG added
g x=uniform()
sort x
set seed 2000

set matsize 800


logit  r_loc_hosp_x $indv
predict yhat
sum yhat if r_loc_hosp_x==1

*.1721895 , = , the new std is  so the new radius ,
*0.01 *(0.172)=0.00172,.05*(0.172)=.0086

/*plug in std for caliper PS matching*/
psmatch2 r_loc_hosp_x   $indv, radius caliper(0.0172) logit

gen ps_drop=0
replace ps_drop=1 if _weight==.

tab r_white ps_drop, chi

drop if _weight==.
tab r_loc_hosp_x ps_drop


*drop  if r_nhres_x ==1
logit s_cesdbetter  r_loc_hosp_x [iweight=_weight],or
logit s_cesdbetter  r_loc_hosp_x s_age s_female s_white_e s_hseduc  s_srh_pf_p1 [iweight=_weight],or

 

logit s_srh_pf_p1 r_loc_hosp_x [iweight=_weight],or

*look at home vs other

 gen loc_home_x=0
replace loc_home_x = 1 if (r_location_x==3)
replace loc_home_x = 0 if ((r_location_x==1) | (r_location_x==2)| (r_location_x==4)|(r_location_x==5) | (r_location_x==6))

 *tab loc_home_x 
 
 drop x //RG added
 g x=uniform()
sort x
set seed 2000

set matsize 800


logit  loc_home_x $indv
predict yhat2
sum yhat2 if loc_home_x==1

*.15219  , = , the new std is  so the new radius ,
*0.01 *(0.172)=0.00152,.05*(0.172)=.0086

//plug in std for caliper PS matching
psmatch2 loc_home_x   $indv, radius caliper(0.0152) logit

gen ps_drop=0
replace ps_drop=1 if _weight==.
 
 logit s_cesdbetter loc_home_x [iweight=_weight],or
 tab s_cesdbetter loc_home_x, col chi

 
 *comparison hopsice and lcoation of death*
 tab r_loc_hosp_x hs_days_range_$hs_days_low$hs_days_high, col
 
 /*looking at helper*/
*keep if r_adl_sp_helper_x==1|r_iadl_sp_helper_x==1



*SRH*
*gen s_srhchange= s_srh_p1- s_srh_n1
*tab s_srhchange
*tab s_srhchange hs_days_range_$hs_days_low$hs_days_high, col
*gen s_srhchange_3 =0
*replace s_srhchange_3 =1 if s_srhchange >0
*replace s_srhchange_3 =-1 if s_srhchange <0
*replace s_srhchange_3= . if s_srhchange ==.
*tab s_srhchange_3


*gen s_srhbetter=0
*replace s_srhbetter= 1 if s_srhchange <0
*replace s_srhbetter= . if s_srhchange ==.
*tab s_srhbetter


*gen s_srhworse=0
*replace s_srhworse= 1 if s_srhchange >0
*replace s_srhworse= . if s_srhchange ==.
*tab s_srhworse

*gen s_srh5verypoor =0
*replace s_srh5verypoor= 1 if s_srh_p1 >4
*replace s_srh5verypoor= . if s_srh_p1==.
*tab s_srh5verypoor


*gen s_srh4verypoor =0
*replace s_srh4verypoor= 1 if s_srh_p1 >3
*replace s_srh4verypoor= . if s_srh_p1==.
*tab s_srh4verypoor

ologit s_srh_p1 s_srh_n1 hs_days_range_$hs_days_low$hs_days_high s_age s_female s_white_e s_hseduc [iweight=_weight], or
ologit s_srh_p1  hs_days_range_$hs_days_low$hs_days_high



logit  s_srh4verypoor hs_days_range_$hs_days_low$hs_days_high s_age s_female s_white_e s_hseduc [iweight=_weight], or


tab s_srh_p1

logit s_psych_treat_p1  hs_days_range_$hs_days_low$hs_days_high [iweight=_weight]
logit s_psych_med_p1  hs_days_range_$hs_days_low$hs_days_high [iweight=_weight]

reg s_n_drinks_3m_p1 hs_days_range_$hs_days_low$hs_days_high [iweight=_weight]

*logit s_alcohol_mis_p1  hs_days_range_$hs_days_low$hs_days_high [iweight=_weight]



tab1 s_psych_treat_p1 s_psych_med_p1 s_n_drinks_3m_p1 s_alcohol_mis_p1 
*ask ling why are these n's so low?
*/

log close


H="Overall, comp hospice use defs, w/o excluding 1-2, 1-6 day users"
/*Outcome variables are: CESD improvement indicator, ie any improvement 
in CESD score from n1 to p1
And CESD clinical improvement 3+ to <3 n1 to p1

This Stata code runs following analyses:
1. Determines propensity scores
2. Runs summary tables for r and s characteristics using px weighting
3. Px matched logit regression on reduced spouse depressive symptoms 

Runs 3 versions
1. Hospice users: 1+ days / non users: 0 days
2. Hospice users: 3+ days / non users: 0-2 days
3. Hospice users: 7+ days / non users: 0-6 days*/

capture log close

clear all
set mem 500m
set more off
set scheme s1color

//Amy's PC
local logpath E:\data\spouse\logs\july2014
local datapath E:\data\spouse\final_data

//RG PC
//local logpath C:\data\Spouse\logs
//local datapath C:\data\Spouse

log using "`logpath'\5-HRS_Spouse_analysis_july2014.txt", text replace

cd `datapath'

use spouse_data_sample_v2.dta
//use spouse_data_sample_public.dta if (p1_wi_90d==0 & no_cc_12m_excl_cataract==0 & sudden_cause_death==0 & cesd_miss_n1_p1==0)

tab s_comor_c_hrs_n1 s_cesdbetter, chi2
tab s_comor_c_hrs_n1 r_hs_12m, chi2
  
*****************************************************************************
*****************************************************************************
//Set up variables and dataset
*****************************************************************************
*****************************************************************************
//See tab Sum stats, unmatched for variable list used in matching

tab r_hs_12m, missing
rename r_hs_12m rhs12m
la var rhs12m "1+ day hospice use"

gen rhs3d = .
replace rhs3d=1 if hs_los_12m >= 3 & hs_los_12m != .
replace rhs3d=0 if hs_los_12m <3 & hs_los_12m != .
la var rhs3d "3+ day hospice use"
tab hs_los_12m rhs3d , missing
tab  rhs3d , missing

gen rhs7d = .
replace rhs7d=1 if hs_los_12m >= 7 & hs_los_12m != .
replace rhs7d=0 if hs_los_12m <7 & hs_los_12m != .
la var rhs7d "7+ day hospice use"
tab hs_los_12m rhs7d , missing
tab  rhs7d , missing

//first sort data randomly
set seed 2000
gen x=uniform()
sort x

*****************************************************************************
*****************************************************************************
//Using Stata's pscore to generate px scores - 1 day definition
*****************************************************************************
*****************************************************************************

*****************************************************************************
** User note: this variable list for matching is defined in previous sections
*****************************************************************************
//generate pscore variable hs_pscore
pscore rhs12m $matchvars, pscore(hs_pscore) blockid(hs_block) logit detail

//graph without dropping any observations in the matching process
psgraph, treated(rhs12m) pscore(hs_pscore)
graph save `logpath'/psgraph_1 ,replace

//implement radius matching
gen logitpscore=ln(hs_pscore/(1-hs_pscore))
sum logitpscore

sca cal_ps1=r(sd)*0.02
sca list cal_ps1

***************************************************************************************
** User Note: If change variable list or sample, need to update the caliper here
***************************************************************************************
//try 0.02* sd
psmatch2  rhs12m,outcome(s_cesdbetter) pscore(hs_pscore) radius caliper(.01713619) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(rhs12m) pscore(hs_pscore)
graph save `logpath'/psgraph_2 ,replace

histogram hs_pscore if _support==1, by(rhs12m) 

//look at balance of matched vs unmatched samples
pstest $matchvars ,treated(rhs12m) both hist
graph save `logpath'/psmatch_1 ,replace

***************************************************************************************
** User Note: If change list of continuous variables, need to update the list here
** to create qqplots here
***************************************************************************************
//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age{
gen `v'_treated = `v' if rhs12m==1 & _support==1
gen `v'_comparison = `v' if rhs12m==0 & _support==1
qqplot `v'_treated `v'_comparison
graph save `logpath'/qqplot_`v', replace
}

***************************************************************************************
** User Note: If change number of variables in list in section "Sum stats, unmatched", 
** matrix size needs to be adjusted
** number of rows = 40 in mat vr definition, this will change if number of variables changes
***************************************************************************************
mat vr=J(40,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $matchvars  {
sum `v' if rhs12m==1 //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if rhs12m==0 //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if rhs12m==1 & _support==1 //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if rhs12m==0 [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}

***************************************************************************************
** User Note: If change variable list, update rownames here to match
***************************************************************************************
mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1"

mat list vr

//look at standardized differences to assess balance
***************************************************************************************
** User Note: If change list of continuous variables, need to update the list here
** to manually check standardized difference
** Also if total count of variables changes (cont+binary) then need to update matrix # rows
***************************************************************************************
//continuous variables
mat std_diff=J(40,5,.)
local i=1
foreach v in cc_all_count_12m_2 s_age {
sum `v' if rhs12m==1 & _support==1 //get mean,variance treated after matching
mat std_diff[`i',1]=r(mean)
mat std_diff[`i',2]=r(sd)

sum `v' if rhs12m==0 [iweight=_weight] //get mean,variance contl after matching
mat std_diff[`i',3]=r(mean)
mat std_diff[`i',4]=r(sd)

mat std_diff[`i',5]=(std_diff[`i',1]-std_diff[`i',3])/sqrt((std_diff[`i',2]^2+std_diff[`i',4]^2)/2) 
	
local i = `i'+1	
}
//indicator variables
***************************************************************************************
** User Note: If change list of binary variables, need to update the list here
** to manually check standardized differences
***************************************************************************************
local indvars cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y r_advdir_miss r_discuss_x r_srh_pf_n1 ///
 s_female s_white_e  s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1 

foreach v in `indvars' {
sum `v' if rhs12m==1 & _support==1 //get mean treated after matching
mat std_diff[`i',1]=r(mean)

sum `v' if rhs12m==0 [iweight=_weight] //get mean contl after matching
mat std_diff[`i',3]=r(mean)

mat std_diff[`i',5]=(std_diff[`i',1]-std_diff[`i',3])/sqrt((std_diff[`i',1]*(1-std_diff[`i',1])+std_diff[`i',3]*(1-std_diff[`i',3]))/2)
	
local i = `i'+1	
}

***************************************************************************************
** User Note: If change variable list, update rownames here to match
***************************************************************************************
mat rownames std_diff="Count of comorbidities" "S age" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
 "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1" 

mat list std_diff
//standardized difference should be less than 10-25%

***************************************************************************************
** User Note: If change variable list / caliper, then these counts in comments can change
***************************************************************************************
//using this matching, 2 obs from the treatment group are dropped b/c they are off support
//18 are dropped b/c not matched (weight=.)
//_support ==1 if matched
tab _support, missing
tab _support if rhs12m==1, missing
tab _support if rhs12m==0, missing
tab _weight if rhs12m==1, missing
sum _weight if rhs12m==0

//rename ps variables and save dataset so can call them up later
rename _support support_1
rename _weight weight_1

*************************************************************************************
//now run using weighting , outcome = improved CESD score p1
//need to include the variables used in the propensity score

local yearvars ib2000.r_death_year 
 
logit s_cesdbetter rhs12m `yearvars' $matchvars [iw=weight_1] , or 

outreg using `logpath'\spouse_analysis_july2014, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score Decreased (by any amount) n1 to p1") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions.") ///
	varlabels starlevels(10 5 1)  summstat( N) replace

tab s_cesdbetter s_cesd_ge3better, missing

//Run logit with outcome=depressed n1, not depressed p1
logit s_cesd_ge3better rhs12m `yearvars' $matchvars [iw=weight_1] , or 

outreg using `logpath'\spouse_analysis_july2014, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score 3+ n1 to less than 3 p1") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable

*****************************************************************************

*****************************************************************************

//End of 1 day definition , start 3 day definition section

*****************************************************************************

*****************************************************************************
	
	
*****************************************************************************
*****************************************************************************
//Using Stata's pscore to generate px scores - 3 day definition
*****************************************************************************
*****************************************************************************
//first sort data randomly
set seed 2000
gen x3=uniform()
sort x3
//generate pscore variable hs_pscore
pscore rhs3d $matchvars, pscore(hs_pscore3) blockid(hs_block3) logit detail

//graph without dropping any observations in the matching process
psgraph, treated(rhs3d) pscore(hs_pscore3)
graph save `logpath'/psgraph_1_3 ,replace

//implement radius matching
gen logitpscore3=ln(hs_pscore3/(1-hs_pscore3))
sum logitpscore3

sca cal_ps3=r(sd)*0.02
sca list cal_ps3

***************************************************************************************
** User Note: If change variable or sample list, need to update the caliper here
***************************************************************************************
//try 0.02* sd
psmatch2  rhs3d,outcome(s_cesdbetter) pscore(hs_pscore3) radius caliper(.01723085) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(rhs3d) pscore(hs_pscore3)
graph save `logpath'/psgraph_2_3 ,replace

histogram hs_pscore3 if _support==1, by(rhs3d) 

//look at balance of matched vs unmatched samples
pstest $matchvars ,treated(rhs3d) both hist
graph save `logpath'/psmatch_1_3 ,replace

***************************************************************************************
** User Note: If change list of continuous variables, need to update the list here
** to create qqplots here
***************************************************************************************
//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age{
gen `v'_treated3 = `v' if rhs3d==1 & _support==1
gen `v'_comparison3 = `v' if rhs3d==0 & _support==1
qqplot `v'_treated3 `v'_comparison3
graph save `logpath'/qqplot_`v'_3, replace
}

***************************************************************************************
** User Note: If change number of variables, matrix size needs to be adjusted
** number of rows = 40 in mat vr definition, this will change if number of variables changes
***************************************************************************************
mat vr=J(40,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $matchvars  {
sum `v' if rhs3d==1 //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if rhs3d==0 //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if rhs3d==1 & _support==1 //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if rhs3d==0 [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}

mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1" 

mat list vr

//look at standardized differences to assess balance
***************************************************************************************
** User Note: If change list of continuous variables, need to update the list here
** to manually check standardized difference
** Also if total count of variables changes (cont+binary) then need to update matrix # rows
***************************************************************************************
//continuous variables
mat std_diff=J(40,5,.)
local i=1
foreach v in cc_all_count_12m_2 s_age {
sum `v' if rhs3d==1 & _support==1 //get mean,variance treated after matching
mat std_diff[`i',1]=r(mean)
mat std_diff[`i',2]=r(sd)

sum `v' if rhs3d==0 [iweight=_weight] //get mean,variance contl after matching
mat std_diff[`i',3]=r(mean)
mat std_diff[`i',4]=r(sd)

mat std_diff[`i',5]=(std_diff[`i',1]-std_diff[`i',3])/sqrt((std_diff[`i',2]^2+std_diff[`i',4]^2)/2) 
	
local i = `i'+1	
}
//indicator variables
***************************************************************************************
** User Note: If change list of binary variables, need to update the list here
** to manually check standardized differences
***************************************************************************************
local indvars cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y r_advdir_miss r_discuss_x r_srh_pf_n1 ///
 s_female s_white_e  s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1 

foreach v in `indvars' {
sum `v' if rhs3d==1 & _support==1 //get mean treated after matching
mat std_diff[`i',1]=r(mean)

sum `v' if rhs3d==0 [iweight=_weight] //get mean contl after matching
mat std_diff[`i',3]=r(mean)

mat std_diff[`i',5]=(std_diff[`i',1]-std_diff[`i',3])/sqrt((std_diff[`i',1]*(1-std_diff[`i',1])+std_diff[`i',3]*(1-std_diff[`i',3]))/2)
	
local i = `i'+1	
}

***************************************************************************************
** User Note: If change variable list, update rownames here to match
***************************************************************************************
mat rownames std_diff="Count of comorbidities" "S age" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
 "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1" 

mat list std_diff
//standardized difference should be less than 10-25%

***************************************************************************************
** User Note: If change variable list / caliper, then these counts in comments can change
***************************************************************************************
//using this matching, 3 obs from the treatment group are dropped b/c they are off support
//1 dropped b/c not matched (weight=.)
//_support ==1 if matched
tab _support, missing
tab _support if rhs3d==1, missing
tab _support if rhs3d==0, missing
tab _weight if rhs3d==1, missing
sum _weight if rhs3d==0

//rename ps variables and save dataset so can call them up later
rename _support support_3
rename _weight weight_3

//now run using weighting , outcome = improved CESD score p1
//need to include the variables used in the propensity score
 
logit s_cesdbetter rhs3d `yearvars' $matchvars [iw=weight_3] , or 

outreg using `logpath'\spouse_analysis_july2014, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score Decreased (by any amount) n1 to p1" \ ///
	"3+ days of hospice use = treatment, 0-2 days = control") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable


tab s_cesdbetter s_cesd_ge3better, missing

//Run logit with outcome=depressed n1, not depressed p1
logit s_cesd_ge3better rhs3d `yearvars' $matchvars [iw=weight_3] , or 

outreg using `logpath'\spouse_analysis_july2014, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score 3+ n1 to less than 3 p1" \ ///
	"3+ days of hospice use = treatment, 0-2 days = control")  ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable

*****************************************************************************

*****************************************************************************

//End of 3 day definition , start 7 day definition section

*****************************************************************************

*****************************************************************************
	
	
*****************************************************************************
*****************************************************************************
//Using Stata's pscore to generate px scores - 7 day definition
*****************************************************************************
*****************************************************************************
//first sort data randomly
set seed 2000
gen x7=uniform()
sort x7
//generate pscore variable hs_pscore
pscore rhs7d $matchvars, pscore(hs_pscore7) blockid(hs_block7) logit detail

//graph without dropping any observations in the matching process
psgraph, treated(rhs7d) pscore(hs_pscore7)
graph save `logpath'/psgraph_1_7 ,replace

//implement radius matching
gen logitpscore7=ln(hs_pscore7/(1-hs_pscore7))
sum logitpscore7

sca cal_ps7=r(sd)*0.02
sca list cal_ps7

***************************************************************************************
** User Note: If change variable list or sample, need to update the caliper here
***************************************************************************************
//try 0.02* sd
psmatch2  rhs7d,outcome(s_cesdbetter) pscore(hs_pscore7) radius caliper(.01773729) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(rhs7d) pscore(hs_pscore7)
graph save `logpath'/psgraph_2_7 ,replace

histogram hs_pscore7 if _support==1, by(rhs7d) 

//look at balance of matched vs unmatched samples
pstest $matchvars ,treated(rhs7d) both hist
graph save `logpath'/psmatch_1_7 ,replace


***************************************************************************************
** User Note: If change list of continuous variables, need to update the list here
** to create qqplots here
***************************************************************************************
//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age{
gen `v'_treated7 = `v' if rhs7d==1 & _support==1
gen `v'_comparison7 = `v' if rhs7d==0 & _support==1
qqplot `v'_treated7 `v'_comparison7
graph save `logpath'/qqplot_`v'_7, replace
}

***************************************************************************************
** User Note: If change number of variables in list in section "Sum stats, unmatched", 
** matrix size needs to be adjusted
** number of rows = 40 in mat vr definition, this will change if number of variables changes
***************************************************************************************
mat vr=J(40,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $matchvars  {
sum `v' if rhs7d==1 //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if rhs7d==0 //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if rhs7d==1 & _support==1 //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if rhs7d==0 [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}

***************************************************************************************
** User Note: If change variable list, update rownames here to match
***************************************************************************************
mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1"

mat list vr

//look at standardized differences to assess balance
***************************************************************************************
** User Note: If change list of continuous variables, need to update the list here
** to manually check standardized difference
** Also if total count of variables changes (cont+binary) then need to update matrix # rows
***************************************************************************************
//continuous variables
mat std_diff=J(40,5,.)
local i=1
foreach v in cc_all_count_12m_2 s_age {
sum `v' if rhs7d==1 & _support==1 //get mean,variance treated after matching
mat std_diff[`i',1]=r(mean)
mat std_diff[`i',2]=r(sd)

sum `v' if rhs7d==0 [iweight=_weight] //get mean,variance contl after matching
mat std_diff[`i',3]=r(mean)
mat std_diff[`i',4]=r(sd)

mat std_diff[`i',5]=(std_diff[`i',1]-std_diff[`i',3])/sqrt((std_diff[`i',2]^2+std_diff[`i',4]^2)/2) 
	
local i = `i'+1	
}
//indicator variables
***************************************************************************************
** User Note: If change list of binary variables, need to update the list here
** to manually check standardized differences
***************************************************************************************
local indvars cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y r_advdir_miss r_discuss_x r_srh_pf_n1 ///
 s_female s_white_e  s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1 

foreach v in `indvars' {
sum `v' if rhs7d==1 & _support==1 //get mean treated after matching
mat std_diff[`i',1]=r(mean)

sum `v' if rhs7d==0 [iweight=_weight] //get mean contl after matching
mat std_diff[`i',3]=r(mean)

mat std_diff[`i',5]=(std_diff[`i',1]-std_diff[`i',3])/sqrt((std_diff[`i',1]*(1-std_diff[`i',1])+std_diff[`i',3]*(1-std_diff[`i',3]))/2)
	
local i = `i'+1	
}

***************************************************************************************
** User Note: If change variable list, update rownames here to match
***************************************************************************************
mat rownames std_diff="Count of comorbidities" "S age" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
 "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1" 

mat list std_diff
//standardized difference should be less than 10-25%

***************************************************************************************
** User Note: If change variable list / caliper, then these counts in comments can change
***************************************************************************************
//using this matching, 9 obs from the treatment group are dropped b/c they are off support
//1 is dropped b/c not matched (weight=.)
//_support ==1 if matched
tab _support, missing
tab _support if rhs7d==1, missing
tab _support if rhs7d==0, missing
tab _weight if rhs7d==1, missing
sum _weight if rhs7d==0

//rename ps variables and save dataset so can call them up later
rename _support support_7
rename _weight weight_7

//save this dataset for making the tables in the next section
//this retains the weight variables
save `datapath'\spouse_data_sample_v2_july2014.dta, replace

//now run using weighting , outcome = improved CESD score p1
//need to include the variables used in the propensity score
 
logit s_cesdbetter rhs7d `yearvars' $matchvars [iw=weight_7] , or 

outreg using `logpath'\spouse_analysis_july2014, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score Decreased (by any amount) n1 to p1" \ ///
	"7+ days of hospice use = treatment, 0-6 days = control") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable


tab s_cesdbetter s_cesd_ge3better, missing

//Run logit with outcome=depressed n1, not depressed p1
logit s_cesd_ge3better rhs7d `yearvars' $matchvars [iw=weight_7] , or 

outreg using `logpath'\spouse_analysis_july2014, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score 3+ n1 to less than 3 p1" \ ///
	"7+ days of hospice use = treatment, 0-6 days = control")  ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable
****************************************************************
	
****************************************************************
//run each dr regression in a row to get a single table with all of the results
****************************************************************

****************************************************************

//1+day definition, any cesd improvement
qui logit s_cesdbetter rhs12m `yearvars' $matchvars [iw=weight_1] , or 
outreg , store(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs12m) ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = S Depressive symptom improvement n1 to p1") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	rtitles("Any improvement 1+day" ) ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions.") ///
	varlabels starlevels(10 5 1)  summstat(N)

//1+day definition, clinical cesd improvement
qui logit s_cesd_ge3better rhs12m `yearvars' $matchvars [iw=weight_1] , or 
outreg , append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs12m) ///
	rtitles("Clinical improvement 1+day") ///
	varlabels starlevels(10 5 1)  summstat(N) 
	
//3+day definition, any cesd improvement
qui logit s_cesdbetter rhs3d `yearvars' $matchvars [iw=weight_3] , or 
outreg , append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs3d) ///
	rtitles("Any improvement 3+days" ) ///
	varlabels starlevels(10 5 1)  summstat(N) 
	
//3+day definition, clinical cesd improvement
qui logit s_cesd_ge3better rhs3d `yearvars' $matchvars [iw=weight_3] , or 
outreg , append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs3d) ///
	rtitles("Clinical improvement 3+days" ) ///
	varlabels starlevels(10 5 1)  summstat(N) 

//7+day definition, any cesd improvement
qui logit s_cesdbetter rhs7d `yearvars' $matchvars [iw=weight_7] , or 
outreg , append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs7d) ///
	rtitles("Any improvement 7+days" ) ///
	varlabels starlevels(10 5 1)  summstat(N) 
	
//7+day definition, clinical cesd improvement
qui logit s_cesd_ge3better rhs7d `yearvars' $matchvars [iw=weight_7] , or 
outreg using `logpath'\spouse_analysis_july2014, append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs7d) ///
	rtitles("Clinical improvement 7+days" ) ///
	varlabels starlevels(10 5 1)  summstat(N) addtable	

****************************************************************
log close



H="Tables 1&2 - 3 day hospice use treatment"
/*Creates decedent and spouse characteristic tables

Hospice users definition: 3+ days / non users: 0-2 days

Runs in 2 sections, first are unmatched samples, then matched samples
*/

capture log close

clear all
set mem 500m
set more off
set scheme s1color

//Amy's PC
local logpath E:\data\spouse\logs\july2014
local datapath E:\data\spouse\final_data

log using "`logpath'\5a-HRS_Spouse_char_tables_july2014.txt", text replace

cd `datapath'

use spouse_data_sample_v2_july2014.dta

*******************************************************
tab rhs3d , missing

gen non_hosp3=1 if rhs3d==0
replace non_hosp3=0 if rhs3d==1
tab non_hosp3 rhs3d, missing
 
gen r_adl_improv_stab_i_n1n2 = 0
replace r_adl_improv_stab_i_n1n2  = 1 if r_adl_stable_ind_n1n2 ==1 | r_adl_improved_n1n2 
tab r_adl_improv_stab_i_n1n2 , missing

*************************************************************************************
*************************************************************************************
//Create Table 1, Decedent Descriptive Statistics
//Col 1-3: Unweighted, unmatched sample
//Col 4-6: Weighted and matched sample
*************************************************************************************
*************************************************************************************

*************************************************************************************
** User note: if want to change R variables for the table, change them here
*************************************************************************************
local t1vars r_medicaid_n1 r_nhres_n1 r_advdir_y r_advdir_n ///
r_advdir_miss r_adl_improv_stab_i_n1n2 ///
r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 r_adl_change_i_m_n1n2 ///
r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss cc_3_alzhdmta_n12mn0 ///
cc_6_chrnkidn_n12mn0 cc_12_ischmcht_n12mn0 cc_8_chf_n12mn0 ///
cc_9_diabetes_n12mn0 cc_7_copd_n12mn0 cc_16_strketia_n12mn0 ///
cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 cc_11_hipfrac_n12mn0 ///
cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 cc_15_ra_oa_n12mn0 

sum r_age, detail

*************************************************************************************
** User note: if change number of variables in the table, change the matrix size here
** also row references (local i) below will need to be updated
*************************************************************************************
mat demo=J(35,6,.)

//first row, n of hospice users and non-users
tab rhs3d , missing matcell(d1)
mat demo[1,1]=d1[2,1] //non-hospice n
mat demo[1,2]=d1[1,1] //hospice users n

local j=1
foreach h in rhs3d non_hosp3 {
sum r_age if `h'==1, detail //age
mat demo[2,`j']=r(mean)
mat demo[3,`j']=r(sd)
sum r_female if `h'==1, detail //female
mat demo[4,`j']=r(mean)*100
sum r_white_e if `h'==1, detail //non-hispanic, white
mat demo[5,`j']=r(mean)*100
sum r_hseduc_n1_n3 if `h'==1, detail //hs education+
mat demo[6,`j']=r(mean)*100
sum r_networth_adj2010_n1 if `h'==1, detail //net worth
mat demo[7,`j']=r(mean)
mat demo[8,`j']=r(sd)
local i=9
foreach v in `t1vars' {
	sum `v' if `h'==1, detail 
	mat demo[`i',`j']=r(mean)*100
	local i=`i'+1 //populates rows 9-33
	}
sum cc_all_count_12m_2 if `h'==1, detail //count of chronic conditions
mat demo[34,`j']=r(mean)
mat demo[35,`j']=r(sd)
local j=`j'+1
}

//standardized difference for unmatched sample
//creates new matrix with means then puts the standardized difference into
//the main demo matrix

*************************************************************************************
** User note: if change number of variables in the table, change the matrix size here
** also row references (local r) below will need to be updated
*************************************************************************************
mat std_diff_b=J(35,4,.)

local r=2
sum r_age if rhs3d==1 //get mean,variance treated before matching
mat std_diff_b[`r',1]=r(mean)
mat std_diff_b[`r',2]=r(sd)

sum r_age if rhs3d==0 //get mean,variance contl before matching
mat std_diff_b[`r',3]=r(mean)
mat std_diff_b[`r',4]=r(sd)

mat demo[`r',3]=(std_diff_b[`r',1]-std_diff_b[`r',3])/sqrt((std_diff_b[`r',2]^2+std_diff_b[`r',4]^2)/2) 
	
local r = 4
foreach v in r_female r_white_e r_hseduc_n1_n3 {
	sum `v' if rhs3d==1 //get mean,variance treated before matching
	mat std_diff_b[`r',1]=r(mean)

	sum `v' if rhs3d==0 //get mean,variance contl before matching
	mat std_diff_b[`r',3]=r(mean)

	mat demo[`r',3]=(std_diff_b[`r',1]-std_diff_b[`r',3])/sqrt((std_diff_b[`r',1]*(1-std_diff_b[`r',1])+std_diff_b[`r',3]*(1-std_diff_b[`r',3]))/2)

	local r = `r'+1
}

sum r_networth_adj2010_n1 if rhs3d==1 //get mean,variance treated before matching
mat std_diff_b[`r',1]=r(mean)
mat std_diff_b[`r',2]=r(sd)

sum r_networth_adj2010_n1 if rhs3d==0 //get mean,variance contl before matching
mat std_diff_b[`r',3]=r(mean)
mat std_diff_b[`r',4]=r(sd)

mat demo[`r',3]=(std_diff_b[`r',1]-std_diff_b[`r',3])/sqrt((std_diff_b[`r',2]^2+std_diff_b[`r',4]^2)/2) 

local r = 9
foreach v in `t1vars' {
	sum `v' if rhs3d==1 //get mean,variance treated before matching
	mat std_diff_b[`r',1]=r(mean)

	sum `v' if rhs3d==0 //get mean,variance contl before matching
	mat std_diff_b[`r',3]=r(mean)

	mat demo[`r',3]=(std_diff_b[`r',1]-std_diff_b[`r',3])/sqrt((std_diff_b[`r',1]*(1-std_diff_b[`r',1])+std_diff_b[`r',3]*(1-std_diff_b[`r',3]))/2)

	local r = `r'+1
}

local r = 34
sum cc_all_count_12m_2 if rhs3d==1 //get mean,variance treated before matching
mat std_diff_b[`r',1]=r(mean)
mat std_diff_b[`r',2]=r(sd)

sum cc_all_count_12m_2 if rhs3d==0 //get mean,variance contl before matching
mat std_diff_b[`r',3]=r(mean)
mat std_diff_b[`r',4]=r(sd)

mat demo[`r',3]=(std_diff_b[`r',1]-std_diff_b[`r',3])/sqrt((std_diff_b[`r',2]^2+std_diff_b[`r',4]^2)/2) 

*************************************************************************************
** User note: if change variables in the table, change the row names here to match
*************************************************************************************
//just look at it to check means against the pstest output to make sure they are right
mat rownames std_diff_b= "R age" "" "Female" "White" "HS Degree" "Net worth" "" ///
"Medicaid" "Nursing home res before death"  ///
"Advance directive Y" "Advance directive N" "Advance directive missing" ///
"ADL impr or stable ind" "ADL stable partial" "ADL stable severe"  ///
"ADL Ind to mod" "ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" ///
"Alzheimers/Dementia" "Chronic kidney disease" "AMI / ISCH" ///
"CHF" "Diabetes" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis" "Count of comorbidities" ""

mat list std_diff_b

*************************************************************************************
//Table 1 - cols 4-6: Respondent characteristics, matched and weighted
*************************************************************************************

//first row, n of hospice users and non-users
tab rhs3d if weight_3!=. , missing matcell(dm)
mat demo[1,5]=dm[1,1] //non-hospice n
mat demo[1,4]=dm[2,1] //hospice users n

local j=4
foreach h in rhs3d non_hosp3 {
sum r_age if `h'==1 [iweight=weight_3] //age
mat demo[2,`j']=r(mean)
mat demo[3,`j']=r(sd)
sum r_female if `h'==1 [iweight=weight_3] //female
mat demo[4,`j']=r(mean)*100
sum r_white_e if `h'==1 [iweight=weight_3] //non-hispanic, white
mat demo[5,`j']=r(mean)*100
sum r_hseduc_n1_n3 if `h'==1 [iweight=weight_3] //hs education+
mat demo[6,`j']=r(mean)*100
sum r_networth_adj2010_n1 if `h'==1 [iweight=weight_3] //net worth
mat demo[7,`j']=r(mean)
mat demo[8,`j']=r(sd)
local i=9
foreach v in `t1vars' {
	sum `v' if `h'==1 [iweight=weight_3] 
	mat demo[`i',`j']=r(mean)*100
	local i=`i'+1 //populates rows 9-33
	}
sum cc_all_count_12m_2 if `h'==1 [iweight=weight_3] //count of chronic conditions
mat demo[34,`j']=r(mean)
mat demo[35,`j']=r(sd)
local j=`j'+1
}

//standardized difference for matched sample
//creates new matrix with means then puts the standardized difference into
//the main demo matrix
*************************************************************************************
** User note: if change number of variables in the table, change the matrix size here
** also row references (local r) below will need to be updated
*************************************************************************************
mat std_diff_a=J(36,4,.)

local r=2
sum r_age if rhs3d==1 [iweight=weight_3] //get mean,variance treated after matching
mat std_diff_a[`r',1]=r(mean)
mat std_diff_a[`r',2]=r(sd)

sum r_age if rhs3d==0 [iweight=weight_3] //get mean,variance contl after matching
mat std_diff_a[`r',3]=r(mean)
mat std_diff_a[`r',4]=r(sd)

mat demo[`r',6]=(std_diff_a[`r',1]-std_diff_a[`r',3])/sqrt((std_diff_a[`r',2]^2+std_diff_a[`r',4]^2)/2) 
	
local r = 4
foreach v in r_female r_white_e r_hseduc_n1_n3 {
	sum `v' if rhs3d==1 [iweight=weight_3] //get mean,variance treated after matching
	mat std_diff_a[`r',1]=r(mean)

	sum `v' if rhs3d==0 [iweight=weight_3] //get mean,variance contl after matching
	mat std_diff_a[`r',3]=r(mean)

	mat demo[`r',6]=(std_diff_a[`r',1]-std_diff_a[`r',3])/sqrt((std_diff_a[`r',1]*(1-std_diff_a[`r',1])+std_diff_a[`r',3]*(1-std_diff_a[`r',3]))/2)

	local r = `r'+1
}

sum r_networth_adj2010_n1 if rhs3d==1 [iweight=weight_3] //get mean,variance treated after matching
mat std_diff_a[`r',1]=r(mean)
mat std_diff_a[`r',2]=r(sd)

sum r_networth_adj2010_n1 if rhs3d==0 [iweight=weight_3] //get mean,variance contl after matching
mat std_diff_a[`r',3]=r(mean)
mat std_diff_a[`r',4]=r(sd)

mat demo[`r',6]=(std_diff_a[`r',1]-std_diff_a[`r',3])/sqrt((std_diff_a[`r',2]^2+std_diff_a[`r',4]^2)/2) 

local r = 9
foreach v in `t1vars' {
	sum `v' if rhs3d==1 [iweight=weight_3] //get mean,variance treated after matching
	mat std_diff_a[`r',1]=r(mean)

	sum `v' if rhs3d==0 [iweight=weight_3] //get mean,variance contl after matching
	mat std_diff_a[`r',3]=r(mean)

	mat demo[`r',6]=(std_diff_a[`r',1]-std_diff_a[`r',3])/sqrt((std_diff_a[`r',1]*(1-std_diff_a[`r',1])+std_diff_a[`r',3]*(1-std_diff_a[`r',3]))/2)

	local r = `r'+1
}

local r = 34
sum cc_all_count_12m_2 if rhs3d==1 [iweight=weight_3] //get mean,variance treated after matching
mat std_diff_a[`r',1]=r(mean)
mat std_diff_a[`r',2]=r(sd)

sum cc_all_count_12m_2 if rhs3d==0 [iweight=weight_3] //get mean,variance contl after matching
mat std_diff_a[`r',3]=r(mean)
mat std_diff_a[`r',4]=r(sd)

mat demo[`r',6]=(std_diff_a[`r',1]-std_diff_a[`r',3])/sqrt((std_diff_a[`r',2]^2+std_diff_a[`r',4]^2)/2) 

*************************************************************************************
** User note: if change variables in the table, change the row names here to match
*************************************************************************************
//just look at it to check means against the pstest output to make sure they are right
mat rownames std_diff_a= "R age" "" "Female" "White" "HS Degree" "Net worth" "" ///
"Medicaid" "Nursing home res before death"  ///
"Advance directive Y" "Advance directive N" "Advance directive missing" ///
"ADL impr or stable ind" "ADL stable partial" "ADL stable severe"  ///
"ADL Ind to mod" "ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" ///
"Alzheimers/Dementia" "Chronic kidney disease" "AMI / ISCH" ///
"CHF" "Diabetes" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis" "Count of comorbidities" ""

mat list std_diff_a

*************************************************************************************
** User note: if change variables in the table, change the row names here to match
*************************************************************************************
mat rownames demo ="Sample n" "Age at death, years, mean" "SD" "Female, %" "Race, Non-Hispanic White, %" ///
"Education, High School Grad" "Net worth, 2010US$, mean" "SD" "Medicaid, %" ///
"Nursing home resident n1, %"  "Had advance directive" ///
"Did not have advance directive" "Advance directive status unknown" ///
"Impr or Indep in ADLs n2 to n1" ///
"Stable, Moderate 1-3 ADL" "Stable, Severe 4-6 ADL"  ///
"Declined, Indep to Moderate" "Declined, Moderate to Severe" ///
"Declined, Independent to Severe" "Unknown" "Alzheimers/Dementia" "Chronic Kidney Disease" ///
"Ischemic Heart Disease" "Congestive Heart Failure" "Diabetes" "COPD" ///
"Stroke or TIA" "Cancer" "Atrial Fibrillation" "Hip Fracture" "Depression" "Osteoporosis" ///
"Arthritis" "Count of chronic conditions" "SD"

mat list demo

frmttable using `logpath'\spo_Table1_deced_char, statmat(demo) ///
title("Decedent descriptive characteristics, 3+ hospice days") ///
ctitle("","Unmatched Sample","","","Matched Sample","","" \ "", "Hospice users","Non-hospice users","Std. Diff.", ///
  "Hospice users" ,"Non-hospice users" ,"Std. Diff.") ///
sdec(2,2,3,2,2,3) replace

******************************************************************
******************************************************************
//Table 2 spouse characteristics
//Col 1-3: unmatched, unweighted
//Col 4-6: matched and weighted
******************************************************************
******************************************************************
*************************************************************************************
** User note: if want to change S variables for the table, change them here
*************************************************************************************
local sdemovar1 s_female s_white_e s_hseduc_n1_n3 ///
s_medicaid_n1 s_srh_pf_n1 s_imprelig_vimp_n1 s_smoke_curr_n1 ///
s_vig_phy_act_n1 s_hrs_comorb_none_n1 s_hrs_comorb_mild_n1 ///
s_hrs_comorb_mod_n1 s_cancer_hrs_n1 ///
s_lung_hrs_n1 s_heart_hrs_n1 s_chf_hrs_n1 s_stroke_hrs_n1 ///
s_memory_hrs_n1 s_htn_hrs_n1 s_dm_hrs_n1 s_psych_hrs_n1 ///
days_p1_core_dod_lt6m days_p1_core_dod_6_12m days_p1_core_dod_12_18m ///
days_p1_core_dod_gt18mo

local sdemovar2 s_cesd_tot_ge3_n1 ///
s_cesd_tot_ge3_p1 s_cesdbetter s_cesdsame s_cesdworse 

*************************************************************************************
** User note: if change number of variables in the table, change the matrix size here
** also row references (local i) below will need to be updated
*************************************************************************************
mat sdemo=J(35,6,.)

//first row, n of hospice and non-hospice
tab rhs3d, missing matcell(sd1)
mat sdemo[1,1]=sd1[2,1] //non-hospice n
mat sdemo[1,2]=sd1[1,1] //hospice users n

local j=1
foreach h in rhs3d non_hosp3 {
sum s_age if `h'==1, detail //age
mat sdemo[2,`j']=r(mean)
mat sdemo[3,`j']=r(sd)
local i=4
foreach v in `sdemovar1' {
	sum `v' if `h'==1, detail 
	mat sdemo[`i',`j']=r(mean)*100
	local i=`i'+1 //populates rows 4-27
	}

sum s_cesd_tot_n1 if `h'==1, detail //cesd score n1
mat sdemo[28,`j']=r(mean)
sum s_cesd_tot_p1 if `h'==1, detail //cesd score p1
mat sdemo[29,`j']=r(mean)
sum s_cesdchange if `h'==1, detail //cesd score change n1 to p1
mat sdemo[30,`j']=r(mean)

local i=31
foreach v in `sdemovar2' {
	sum `v' if `h'==1, detail 
	mat sdemo[`i',`j']=r(mean)*100
	local i=`i'+1 //populates rows 31-35
	}
local j=`j'+1
}

//standardized difference for unmatched sample
//creates new matrix with means then puts the standardized difference into
//the main demo matrix
*************************************************************************************
** User note: if change number of variables in the table, change the matrix size here
** also row references (local r) below will need to be updated
*************************************************************************************
mat std_diff_b=J(35,4,.)

local r=2
sum s_age if rhs3d==1 //get mean,variance treated before matching
mat std_diff_b[`r',1]=r(mean)
mat std_diff_b[`r',2]=r(sd)

sum s_age if rhs3d==0 //get mean,variance contl before matching
mat std_diff_b[`r',3]=r(mean)
mat std_diff_b[`r',4]=r(sd)

mat sdemo[`r',3]=(std_diff_b[`r',1]-std_diff_b[`r',3])/sqrt((std_diff_b[`r',2]^2+std_diff_b[`r',4]^2)/2)

local r = 4
foreach v in `sdemovar1'  {
	sum `v' if rhs3d==1 //get mean,variance treated before matching
	mat std_diff_b[`r',1]=r(mean)

	sum `v' if rhs3d==0 //get mean,variance contl before matching
	mat std_diff_b[`r',3]=r(mean)

	mat sdemo[`r',3]=(std_diff_b[`r',1]-std_diff_b[`r',3])/sqrt((std_diff_b[`r',1]*(1-std_diff_b[`r',1])+std_diff_b[`r',3]*(1-std_diff_b[`r',3]))/2)

	local r = `r'+1
}

local r = 28
foreach v in s_cesd_tot_n1  s_cesd_tot_p1  s_cesdchange {
        sum `v' if rhs3d==1 //get mean,variance treated before matching
    mat std_diff_b[`r',1]=r(mean)
    mat std_diff_b[`r',2]=r(sd)

    sum `v' if rhs3d==0 //get mean,variance contl before matching
    mat std_diff_b[`r',3]=r(mean)
    mat std_diff_b[`r',4]=r(sd)

    mat sdemo[`r',3]=(std_diff_b[`r',1]-std_diff_b[`r',3])/sqrt((std_diff_b[`r',2]^2+std_diff_b[`r',4]^2)/2)

    local r = `r'+1
}

local r = 31
foreach v in `sdemovar2' {
	sum `v' if rhs3d==1 //get mean,variance treated before matching
	mat std_diff_b[`r',1]=r(mean)

	sum `v' if rhs3d==0 //get mean,variance contl before matching
	mat std_diff_b[`r',3]=r(mean)

	mat sdemo[`r',3]=(std_diff_b[`r',1]-std_diff_b[`r',3])/sqrt((std_diff_b[`r',1]*(1-std_diff_b[`r',1])+std_diff_b[`r',3]*(1-std_diff_b[`r',3]))/2)

	local r = `r'+1
}

*************************************************************************************
** User note: if change variables in the table, change the row names here to match
*************************************************************************************
//just look at it to check means against the pstest output to make sure they are right
mat rownames std_diff_b= "S age" "" "Female" "White" "HS Degree" ///
"Medicaid" "SRH poor/fair" "Religion very imp" "Smoker" "Vigorous phys act" ///
"Comorb - none" "Mild" "Moderate" "Cancer" "Lung disease" "Heart disease" "CHF" "Stroke" ///
"Memory disease" "Hypertension" "Diabetes" "Psych problems" "p1 ivw 0-6m" ///
"p1 ivw 6-12m" "p1 ivw 12-18m" "p1 > 18m" "CESD raw n1" "CESD raw p1" "CESD change" ///
"Clin depr n1" "Clin depr p1" "CESD improved" "CESD same" "CESD declined"

mat list std_diff_b


**********************************************************************
//Matched weighted columns 4-6
**********************************************************************

//first row, n of hospice and non-hospice
tab rhs3d if weight_3!=., missing matcell(sd1)
mat sdemo[1,4]=sd1[2,1] //hospice n
mat sdemo[1,5]=sd1[1,1] //non-hospice users n

local j=4
foreach h in rhs3d non_hosp3 {
sum s_age if `h'==1 [iweight=weight_3] //age
mat sdemo[2,`j']=r(mean)
mat sdemo[3,`j']=r(sd)
local i=4
foreach v in `sdemovar1' {
	sum `v' if `h'==1 [iweight=weight_3] 
	mat sdemo[`i',`j']=r(mean)*100
	local i=`i'+1 //populates rows 4-27
	}
sum s_cesd_tot_n1 if `h'==1 [iweight=weight_3] //cesd score n1
mat sdemo[28,`j']=r(mean)
sum s_cesd_tot_p1 if `h'==1 [iweight=weight_3] //cesd score p1
mat sdemo[29,`j']=r(mean)
sum s_cesdchange if `h'==1 [iweight=weight_3] //cesd score change n1 to p1
mat sdemo[30,`j']=r(mean)
local i=31
foreach v in `sdemovar2' {
	sum `v' if `h'==1 [iweight=weight_3] 
	mat sdemo[`i',`j']=r(mean)*100
	local i=`i'+1 //populates rows 31-35
	}
local j=`j'+1
}

//standardized difference for matched sample
//creates new matrix with means then puts the standardized difference into
//the main demo matrix
*************************************************************************************
** User note: if change number of variables in the table, change the matrix size here
** also row references (local r) below will need to be updated
*************************************************************************************
mat std_diff_a=J(35,4,.)

local r=2
sum s_age if rhs3d==1 [iweight=weight_3] //get mean,variance treated after matching
mat std_diff_a[`r',1]=r(mean)
mat std_diff_a[`r',2]=r(sd)

sum s_age if rhs3d==0 [iweight=weight_3] //get mean,variance contl after matching
mat std_diff_a[`r',3]=r(mean)
mat std_diff_a[`r',4]=r(sd)

mat sdemo[`r',6]=(std_diff_a[`r',1]-std_diff_a[`r',3])/sqrt((std_diff_a[`r',2]^2+std_diff_a[`r',4]^2)/2)

local r = 4
foreach v in `sdemovar1' {
	sum `v' if rhs3d==1 [iweight=weight_3] //get mean,variance treated after matching
	mat std_diff_a[`r',1]=r(mean)

	sum `v' if rhs3d==0 [iweight=weight_3] //get mean,variance contl after matching
	mat std_diff_a[`r',3]=r(mean)

	mat sdemo[`r',6]=(std_diff_a[`r',1]-std_diff_a[`r',3])/sqrt((std_diff_a[`r',1]*(1-std_diff_a[`r',1])+std_diff_a[`r',3]*(1-std_diff_a[`r',3]))/2)

	local r = `r'+1
}

local r = 28
foreach v in s_cesd_tot_n1 s_cesd_tot_p1 s_cesdchange  {
        sum `v' if rhs3d==1 [iweight=weight_3] //get mean,variance treated after matching
        mat std_diff_a[`r',1]=r(mean)
        mat std_diff_a[`r',2]=r(sd)

        sum `v' if rhs3d==0 [iweight=weight_3] //get mean,variance contl after matching
        mat std_diff_a[`r',3]=r(mean)
        mat std_diff_a[`r',4]=r(sd)

        mat sdemo[`r',6]=(std_diff_a[`r',1]-std_diff_a[`r',3])/sqrt((std_diff_a[`r',2]^2+std_diff_a[`r',4]^2)/2)
   	local r = `r'+1
}

local r = 31
foreach v in `sdemovar2' {
	sum `v' if rhs3d==1 [iweight=weight_3] //get mean,variance treated after matching
	mat std_diff_a[`r',1]=r(mean)

	sum `v' if rhs3d==0 [iweight=weight_3] //get mean,variance contl after matching
	mat std_diff_a[`r',3]=r(mean)

	mat sdemo[`r',6]=(std_diff_a[`r',1]-std_diff_a[`r',3])/sqrt((std_diff_a[`r',1]*(1-std_diff_a[`r',1])+std_diff_a[`r',3]*(1-std_diff_a[`r',3]))/2)

	local r = `r'+1
}

*************************************************************************************
** User note: if change variables in the table, change the row names here to match
*************************************************************************************
//just look at it to check means against the pstest output to make sure they are right
mat rownames std_diff_a= "S age" "" "Female" "White" "HS Degree" ///
"Medicaid" "SRH poor/fair" "Religion very imp" "Smoker" "Vigorous phys act" ///
"Comorb - none" "Mild" "Moderate" "Cancer" "Lung disease" "Heart disease" "CHF" "Stroke" ///
"Memory disease" "Hypertension" "Diabetes" "Psych problems" "p1 ivw 0-6m" ///
"p1 ivw 6-12m" "p1 ivw 12-18m" "p1 > 18m" "CESD raw n1" "CESD raw p1" "CESD change" ///
"Clin depr n1" "Clin depr p1" "CESD improved" "CESD same" "CESD declined"

mat list std_diff_a

*************************************************************************************
** User note: if change variables in the table, change the row names here to match
*************************************************************************************
mat rownames sdemo ="Sample size n" "Age at r's death, mean" "SD" "Female %" "Non-Hispanic White %" ///
"Education, High school grad %" "Medicaid %" "SRH poor or fair %" ///
"Religion very important %" "Currently smoker %" "Vigorous physical activity %" ///
"Comorbidity index - none" "Mild (1-3)" "Moderate (4-6)" ///
"Cancer %" "Lung disease %" "Heart disease %" "CHF %" "Stroke %" "Memory disease %" ///
"Hypertension %" "Diabetes %" "Psychological problems %" ///
"P1 interview 0-6m from death" "P1 interview 6-12m" "P1 interview 12-18m" "P1 interview 18m+" ///
"CES-D raw score pre-death, mean" "CES-D raw score post-death, mean" "Change in raw CES-D" ///
"Clinical depression pre-death %" "Clinical depression post-death %" ///
 "CES-D Improved post death %" "Same CES-D post death %" "CES-D Declined post death %"

mat list sdemo

frmttable using `logpath'\spo_Table2_spouse_char, statmat(sdemo) ///
title("Spouse descriptive characteristics,  3+ hospice days") ///
ctitle("","Unmatched Sample","","","Matched Sample","","" \ "", "Hospice users","Non-hospice users","Std. Diff.", ///
  "Hospice users" ,"Non-hospice users" ,"Std. Diff.") ///
  sdec(2,2,4,2,2,4) replace

***********************************************************************
//Table of overall sample characteristics
***********************************************************************
*************************************************************************************
** User note: if want to change variables for this overall sample table, change them here
*************************************************************************************
local varlist1 r_female r_white_e r_hseduc_n1_n3 

local varlist2 s_female s_white_e s_hseduc_n1_n3 s_adl_independent_core_n1

mat quicktab=J(13,5,.)

sum r_age //mean R age
mat quicktab[1,1]=r(mean)
local sample = r(N)

local j=2
foreach v in `varlist1'{
sum `v'
mat quicktab[`j',1]=r(mean)*100
local j=`j'+1 //rows 2-4
}

sum s_age //mean S age
mat quicktab[5,1]=r(mean)

local j=6
foreach v in `varlist2'{
sum `v'
mat quicktab[`j',1]=r(mean)*100
local j=`j'+1 //rows 6-9
}

local i=10
sum hs_los_12m if rhs3d==1, detail
mat quicktab[`i',1]=r(mean)
mat quicktab[`i',2]=r(sd)
mat quicktab[`i',3]=r(p50)
mat quicktab[`i',4]=r(min)
mat quicktab[`i',5]=r(max)

gen mo_p1_core_dead =days_p1_core_dead/30.5
gen mo_s_n1_core_dead = s_days_n1_core_dead/30.5

sum mo_p1_core_dead
mat quicktab[`i'+1,1]=r(mean)

sum mo_s_n1_core_dead 
mat quicktab[`i'+2,1]=r(mean)

gen mo_s_p1_n1 = (days_p1_core_dead+ s_days_n1_core_dead)/30.5
sum mo_s_p1_n1 , detail
mat quicktab[`i'+3,1]=r(mean)
mat quicktab[`i'+3,2]=r(sd)
mat quicktab[`i'+3,3]=r(p50)
mat quicktab[`i'+3,4]=r(min)
mat quicktab[`i'+3,5]=r(max)

mat list quicktab

mat rownames quicktab="R Age" "R Female" "R White" "R HS Degree" ///
"S Age" "S Female" "S White" "S HS Degree" "S ADL independent n1" ///
"Days hospice use" "S n1 ivw months before death" ///
"S p1 ivw months after death" ///
"S n1 to p1 interview, months"

frmttable using `logpath'\spo_overall_sample_char, statmat(quicktab) ///
title("Overall sample descriptive characteristics, n=`sample'") ///
ctitle("","Mean or Percent" "SD" "Median" "Min" "Max") ///
sdec(3,2,0,0,0) replace


***********************************************************************
log close


H="Now do for spouses that are caregivers"
/*
Runs the models for the helper subsample only

Outcome variables are: CESD improvement indicator, ie any improvement 
in CESD score from n1 to p1
And CESD clinical improvement 3+ to <3 n1 to p1

This Stata code runs following analyses:
1. Determines propensity scores
2. Runs summary tables for r and s characteristics using px weighting
3. Px matched logit regression on reduced spouse depressive symptoms 

Runs 3 versions
1. Hospice users: 1+ days / non users: 0 days
2. Hospice users: 3+ days / non users: 0-2 days
3. Hospice users: 7+ days / non users: 0-6 days*/

capture log close

clear all
set mem 500m
set more off
set scheme s1color

//Amy's PC
local logpath E:\data\spouse\logs\july2014\helper
local datapath E:\data\spouse\final_data

//RG PC
//local logpath C:\data\Spouse\logs
//local datapath C:\data\Spouse

log using "`logpath'\6-HRS_Spouse_analysis_helper_july2014.txt", text replace

cd `datapath'

use spouse_data_sample_v2.dta if (r_adl_sp_helper_x==1 | r_iadl_sp_helper_x==1) 
  
*****************************************************************************
*****************************************************************************
//Set up variables and dataset
*****************************************************************************
*****************************************************************************
//See tab Sum stats, unmatched for variable list used in matching

tab r_hs_12m, missing
rename r_hs_12m rhs12m
la var rhs12m "1+ day hospice use"

gen rhs3d = .
replace rhs3d=1 if hs_los_12m >= 3 & hs_los_12m != .
replace rhs3d=0 if hs_los_12m <3 & hs_los_12m != .
la var rhs3d "3+ days hospice use"
tab hs_los_12m rhs3d , missing
tab  rhs3d , missing

gen rhs7d = .
replace rhs7d=1 if hs_los_12m >= 7 & hs_los_12m != .
replace rhs7d=0 if hs_los_12m <7 & hs_los_12m != .
la var rhs7d "7+ days hospice use"
tab hs_los_12m rhs7d , missing
tab  rhs7d , missing

//first sort data randomly
set seed 2000
gen x=uniform()
sort x

*****************************************************************************
*****************************************************************************
//Using Stata's pscore to generate px scores - 1 day definition
*****************************************************************************
*****************************************************************************

*****************************************************************************
** User note: this variable list for matching is defined in previous sections
*****************************************************************************
//generate pscore variable hs_pscore
pscore rhs12m $matchvars, pscore(hs_pscore) blockid(hs_block) logit detail

//graph without dropping any observations in the matching process
psgraph, treated(rhs12m) pscore(hs_pscore)
graph save `logpath'/psgraph_1 ,replace

//implement radius matching
gen logitpscore=ln(hs_pscore/(1-hs_pscore))
sum logitpscore

sca cal_ps1=r(sd)*0.02
sca list cal_ps1

***************************************************************************************
** User Note: If change variable list or sample, need to updated the caliper here
***************************************************************************************
//try 0.02* sd
psmatch2  rhs12m,outcome(s_cesdbetter) pscore(hs_pscore) radius caliper(.01802932) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(rhs12m) pscore(hs_pscore)
graph save `logpath'/psgraph_2 ,replace

histogram hs_pscore if _support==1, by(rhs12m) 

//look at balance of matched vs unmatched samples
pstest $matchvars ,treated(rhs12m) both hist
graph save `logpath'/psmatch_1 ,replace

***************************************************************************************
** User Note: If change list of continuous variables, need to update the list here
** to create qqplots here
***************************************************************************************
//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age{
gen `v'_treated = `v' if rhs12m==1 & _support==1
gen `v'_comparison = `v' if rhs12m==0 & _support==1
qqplot `v'_treated `v'_comparison
graph save `logpath'/qqplot_`v', replace
}

***************************************************************************************
** User Note: If change number of variables in list in section "Sum stats, unmatched", 
** matrix size needs to be adjusted
** number of rows = 40 in mat vr definition, this will change if number of variables changes
***************************************************************************************
mat vr=J(40,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $matchvars  {
sum `v' if rhs12m==1 //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if rhs12m==0 //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if rhs12m==1 & _support==1 //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if rhs12m==0 [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}

***************************************************************************************
** User Note: If change variable list, update rownames here to match
***************************************************************************************
mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1"

mat list vr

//look at standardized differences to assess balance
***************************************************************************************
** User Note: If change list of continuous variables, need to update the list here
** to manually check standardized difference
** Also if total count of variables changes (cont+binary) then need to update matrix # rows
***************************************************************************************
//continuous variables
mat std_diff=J(40,5,.)
local i=1
foreach v in cc_all_count_12m_2 s_age {
sum `v' if rhs12m==1 & _support==1 //get mean,variance treated after matching
mat std_diff[`i',1]=r(mean)
mat std_diff[`i',2]=r(sd)

sum `v' if rhs12m==0 [iweight=_weight] //get mean,variance contl after matching
mat std_diff[`i',3]=r(mean)
mat std_diff[`i',4]=r(sd)

mat std_diff[`i',5]=(std_diff[`i',1]-std_diff[`i',3])/sqrt((std_diff[`i',2]^2+std_diff[`i',4]^2)/2) 
	
local i = `i'+1	
}
//indicator variables
***************************************************************************************
** User Note: If change list of binary variables, need to update the list here
** to manually check standardized differences
***************************************************************************************
local indvars cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y r_advdir_miss r_discuss_x r_srh_pf_n1 ///
 s_female s_white_e  s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1 

foreach v in `indvars' {
sum `v' if rhs12m==1 & _support==1 //get mean treated after matching
mat std_diff[`i',1]=r(mean)

sum `v' if rhs12m==0 [iweight=_weight] //get mean contl after matching
mat std_diff[`i',3]=r(mean)

mat std_diff[`i',5]=(std_diff[`i',1]-std_diff[`i',3])/sqrt((std_diff[`i',1]*(1-std_diff[`i',1])+std_diff[`i',3]*(1-std_diff[`i',3]))/2)
	
local i = `i'+1	
}

***************************************************************************************
** User Note: If change variable list, update rownames here to match
***************************************************************************************
mat rownames std_diff="Count of comorbidities" "S age" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
 "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1" 

mat list std_diff
//standardized difference should be less than 10-25%

***************************************************************************************
** User Note: If change variable list / caliper, then these counts in comments can change
***************************************************************************************
//using this matching, 10 obs from the treatment group are dropped b/c they are off support
//5 are dropped b/c not matched (weight=.)
//_support ==1 if matched
tab _support, missing
tab _support if rhs12m==1, missing
tab _support if rhs12m==0, missing
tab _weight if rhs12m==1, missing
sum _weight if rhs12m==0

//rename ps variables and save dataset so can call them up later
rename _support support_1
rename _weight weight_1

//now run using weighting , outcome = improved CESD score p1
//need to include the variables used in the propensity score

local yearvars ib2000.r_death_year 
 
logit s_cesdbetter rhs12m `yearvars' $matchvars [iw=weight_1] , or 

outreg using `logpath'\spouse_analysis_july2014, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score Decreased (by any amount) n1 to p1") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions.") ///
	varlabels starlevels(10 5 1)  summstat( N) replace


tab s_cesdbetter s_cesd_ge3better, missing

***************************************************************************************
** User Note: If change variable list, update here to match
***************************************************************************************
//Run logit with outcome=depressed n1, not depressed p1
//Need alternative variable list excluding advanced directive missing status b/c
//it predicts the outcome (failure)
local new_varlist cc_all_count_12m_2 cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y /*r_advdir_miss*/ r_discuss_x r_srh_pf_n1 ///
s_age s_female s_white_e  s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1 

logit s_cesd_ge3better rhs12m `yearvars' `new_varlist' [iw=weight_1] , or 

outreg using `logpath'\spouse_analysis_july2014, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score 3+ n1 to less than 3 p1") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable

*****************************************************************************

*****************************************************************************

//End of 1 day definition , start 3 day definition section

*****************************************************************************

*****************************************************************************
	
	
*****************************************************************************
*****************************************************************************
//Using Stata's pscore to generate px scores - 3 day definition
*****************************************************************************
*****************************************************************************

//generate pscore variable hs_pscore
pscore rhs3d $matchvars, pscore(hs_pscore3) blockid(hs_block3) logit detail

//graph without dropping any observations in the matching process
psgraph, treated(rhs3d) pscore(hs_pscore3)
graph save `logpath'/psgraph_1_3 ,replace

//implement radius matching
gen logitpscore3=ln(hs_pscore3/(1-hs_pscore3))
sum logitpscore3

sca cal_ps3=r(sd)*0.02
sca list cal_ps3

***************************************************************************************
** User Note: If change variable or sample list, need to update the caliper here
***************************************************************************************
//try 0.02* sd
psmatch2  rhs3d,outcome(s_cesdbetter) pscore(hs_pscore3) radius caliper(.01751388) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(rhs3d) pscore(hs_pscore3)
graph save `logpath'/psgraph_2_3 ,replace

histogram hs_pscore3 if _support==1, by(rhs3d) 

//look at balance of matched vs unmatched samples
pstest $matchvars ,treated(rhs3d) both hist
graph save `logpath'/psmatch_1_3 ,replace

***************************************************************************************
** User Note: If change list of continuous variables, need to update the list here
** to create qqplots here
***************************************************************************************
//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age{
gen `v'_treated3 = `v' if rhs3d==1 & _support==1
gen `v'_comparison3 = `v' if rhs3d==0 & _support==1
qqplot `v'_treated3 `v'_comparison3
graph save `logpath'/qqplot_`v'_3, replace
}

***************************************************************************************
** User Note: If change number of variables, matrix size needs to be adjusted
** number of rows = 40 in mat vr definition, this will change if number of variables changes
***************************************************************************************
mat vr=J(40,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $matchvars  {
sum `v' if rhs3d==1 //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if rhs3d==0 //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if rhs3d==1 & _support==1 //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if rhs3d==0 [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}

***************************************************************************************
** User Note: If change variable list, update row names here to match
***************************************************************************************
mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1"

mat list vr

//look at standardized differences to assess balance
***************************************************************************************
** User Note: If change list of continuous variables, need to update the list here
** to manually check standardized difference
** Also if total count of variables changes (cont+binary) then need to update matrix # rows
***************************************************************************************
//continuous variables
mat std_diff=J(40,5,.)
local i=1
foreach v in cc_all_count_12m_2 s_age {
sum `v' if rhs3d==1 & _support==1 //get mean,variance treated after matching
mat std_diff[`i',1]=r(mean)
mat std_diff[`i',2]=r(sd)

sum `v' if rhs3d==0 [iweight=_weight] //get mean,variance contl after matching
mat std_diff[`i',3]=r(mean)
mat std_diff[`i',4]=r(sd)

mat std_diff[`i',5]=(std_diff[`i',1]-std_diff[`i',3])/sqrt((std_diff[`i',2]^2+std_diff[`i',4]^2)/2) 
	
local i = `i'+1	
}
//indicator variables
***************************************************************************************
** User Note: If change list of binary variables, need to update the list here
** to manually check standardized differences
***************************************************************************************
local indvars cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y r_advdir_miss r_discuss_x r_srh_pf_n1 ///
 s_female s_white_e  s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1 

foreach v in `indvars' {
sum `v' if rhs3d==1 & _support==1 //get mean treated after matching
mat std_diff[`i',1]=r(mean)

sum `v' if rhs3d==0 [iweight=_weight] //get mean contl after matching
mat std_diff[`i',3]=r(mean)

mat std_diff[`i',5]=(std_diff[`i',1]-std_diff[`i',3])/sqrt((std_diff[`i',1]*(1-std_diff[`i',1])+std_diff[`i',3]*(1-std_diff[`i',3]))/2)
	
local i = `i'+1	
}

***************************************************************************************
** User Note: If change variable list, update rownames here to match
***************************************************************************************
mat rownames std_diff="Count of comorbidities" "S age" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
 "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1" 

mat list std_diff
//standardized difference should be less than 10-25%

***************************************************************************************
** User Note: If change variable list / caliper, then these counts in comments can change
***************************************************************************************
//using this matching, 6 obs from the treatment group are dropped b/c they are off support
//5 are dropped b/c not matched (weight=.)
//_support ==1 if matched
tab _support, missing
tab _support if rhs3d==1, missing
tab _support if rhs3d==0, missing
tab _weight if rhs3d==1, missing
sum _weight if rhs3d==0

//rename ps variables and save dataset so can call them up later
rename _support support_3
rename _weight weight_3

//now run using weighting , outcome = improved CESD score p1
//need to include the variables used in the propensity score
//we probably can't keep both spouse and r gender variables in
 
logit s_cesdbetter rhs3d `yearvars' $matchvars [iw=weight_3] , or 

outreg using `logpath'\spouse_analysis_july2014, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score Decreased (by any amount) n1 to p1" \ ///
	"3+ days of hospice use = treatment, 0-2 days = control") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable


tab s_cesdbetter s_cesd_ge3better, missing

//Run logit with outcome=depressed n1, not depressed p1
logit s_cesd_ge3better rhs3d `yearvars' `new_varlist' [iw=weight_3] , or 

outreg using `logpath'\spouse_analysis_july2014, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score 3+ n1 to less than 3 p1" \ ///
	"3+ days of hospice use = treatment, 0-2 days = control")  ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable

*****************************************************************************

*****************************************************************************

//End of 3 day definition , start 7 day definition section

*****************************************************************************

*****************************************************************************
	
	
*****************************************************************************
*****************************************************************************
//Using Stata's pscore to generate px scores - 7 day definition
*****************************************************************************
*****************************************************************************

//generate pscore variable hs_pscore
pscore rhs7d $matchvars, pscore(hs_pscore7) blockid(hs_block7) logit detail

//graph without dropping any observations in the matching process
psgraph, treated(rhs7d) pscore(hs_pscore7)
graph save `logpath'/psgraph_1_7 ,replace

//implement radius matching
gen logitpscore7=ln(hs_pscore7/(1-hs_pscore7))
sum logitpscore7

sca cal_ps7=r(sd)*0.02
sca list cal_ps7

***************************************************************************************
** User Note: If change variable list or sample, need to update the caliper here
***************************************************************************************
//try 0.02* sd
psmatch2  rhs7d,outcome(s_cesdbetter) pscore(hs_pscore7) radius caliper(.01824431) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(rhs7d) pscore(hs_pscore7)
graph save `logpath'/psgraph_2_7 ,replace

histogram hs_pscore7 if _support==1, by(rhs7d) 

//look at balance of matched vs unmatched samples
pstest $matchvars ,treated(rhs7d) both hist
graph save `logpath'/psmatch_1_7 ,replace

***************************************************************************************
** User Note: If change list of continuous variables, need to update the list here
** to create qqplots here
***************************************************************************************
//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age{
gen `v'_treated7 = `v' if rhs7d==1 & _support==1
gen `v'_comparison7 = `v' if rhs7d==0 & _support==1
qqplot `v'_treated7 `v'_comparison7
graph save `logpath'/qqplot_`v'_7, replace
}

***************************************************************************************
** User Note: If change number of variables in list in section "Sum stats, unmatched", 
** matrix size needs to be adjusted
** number of rows = 40 in mat vr definition, this will change if number of variables changes
***************************************************************************************
mat vr=J(40,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $matchvars  {
sum `v' if rhs7d==1 //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if rhs7d==0 //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if rhs7d==1 & _support==1 //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if rhs7d==0 [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}

***************************************************************************************
** User Note: If change variable list, update rownames here to match
***************************************************************************************
mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1"

mat list vr

//look at standardized differences to assess balance
***************************************************************************************
** User Note: If change list of continuous variables, need to update the list here
** to manually check standardized difference
** Also if total count of variables changes (cont+binary) then need to update matrix # rows
***************************************************************************************
//continuous variables
mat std_diff=J(40,5,.)
local i=1
foreach v in cc_all_count_12m_2 s_age {
sum `v' if rhs7d==1 & _support==1 //get mean,variance treated after matching
mat std_diff[`i',1]=r(mean)
mat std_diff[`i',2]=r(sd)

sum `v' if rhs7d==0 [iweight=_weight] //get mean,variance contl after matching
mat std_diff[`i',3]=r(mean)
mat std_diff[`i',4]=r(sd)

mat std_diff[`i',5]=(std_diff[`i',1]-std_diff[`i',3])/sqrt((std_diff[`i',2]^2+std_diff[`i',4]^2)/2) 
	
local i = `i'+1	
}
//indicator variables
***************************************************************************************
** User Note: If change list of binary variables, need to update the list here
** to manually check standardized differences
***************************************************************************************
local indvars cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y r_advdir_miss r_discuss_x r_srh_pf_n1 ///
 s_female s_white_e  s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1 

foreach v in `indvars' {
sum `v' if rhs7d==1 & _support==1 //get mean treated after matching
mat std_diff[`i',1]=r(mean)

sum `v' if rhs7d==0 [iweight=_weight] //get mean contl after matching
mat std_diff[`i',3]=r(mean)

mat std_diff[`i',5]=(std_diff[`i',1]-std_diff[`i',3])/sqrt((std_diff[`i',1]*(1-std_diff[`i',1])+std_diff[`i',3]*(1-std_diff[`i',3]))/2)
	
local i = `i'+1	
}

***************************************************************************************
** User Note: If change variable list, update rownames here to match
***************************************************************************************
mat rownames std_diff="Count of comorbidities" "S age" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
 "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1" 

mat list std_diff
//standardized difference should be less than 10-25%

***************************************************************************************
** User Note: If change variable list / caliper, then these counts in comments can change
***************************************************************************************
//using this matching, 14 obs from the treatment group are dropped b/c they are off support
//18 are dropped b/c not matched (weight=.)
//_support ==1 if matched
tab _support, missing
tab _support if rhs7d==1, missing
tab _support if rhs7d==0, missing
tab _weight if rhs7d==1, missing
sum _weight if rhs7d==0

//rename ps variables and save dataset so can call them up later
rename _support support_7
rename _weight weight_7

//now run using weighting , outcome = improved CESD score p1
//need to include the variables used in the propensity score
 
logit s_cesdbetter rhs7d `yearvars' $matchvars [iw=weight_7] , or 

outreg using `logpath'\spouse_analysis_july2014, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score Decreased (by any amount) n1 to p1" \ ///
	"7+ days of hospice use = treatment, 0-6 days = control") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable


tab s_cesdbetter s_cesd_ge3better, missing

//Run logit with outcome=depressed n1, not depressed p1
logit s_cesd_ge3better rhs7d `yearvars' `new_varlist' [iw=weight_7] , or 

outreg using `logpath'\spouse_analysis_july2014, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score 3+ n1 to less than 3 p1" \ ///
	"7+ days of hospice use = treatment, 0-6 days = control")  ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable
****************************************************************
	
****************************************************************
//run each dr regression in a row to get a single table with all of the results
****************************************************************

****************************************************************

//1+day definition, any cesd improvement
qui logit s_cesdbetter rhs12m `yearvars' $matchvars [iw=weight_1] , or 
outreg , store(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs12m) ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = S Depressive symptom improvement n1 to p1") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	rtitles("Any improvement 1+day" ) ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions.") ///
	varlabels starlevels(10 5 1)  summstat(N)

//1+day definition, clinical cesd improvement
qui logit s_cesd_ge3better rhs12m `yearvars' `new_varlist' [iw=weight_1] , or 
outreg , append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs12m) ///
	rtitles("Clinical improvement 1+day") ///
	varlabels starlevels(10 5 1)  summstat(N) 
	
//3+day definition, any cesd improvement
qui logit s_cesdbetter rhs3d `yearvars' $matchvars [iw=weight_3] , or 
outreg , append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs3d) ///
	rtitles("Any improvement 3+days" ) ///
	varlabels starlevels(10 5 1)  summstat(N) 
	
//3+day definition, clinical cesd improvement
qui logit s_cesd_ge3better rhs3d `yearvars' `new_varlist' [iw=weight_3] , or 
outreg , append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs3d) ///
	rtitles("Clinical improvement 3+days" ) ///
	varlabels starlevels(10 5 1)  summstat(N) 

//7+day definition, any cesd improvement
qui logit s_cesdbetter rhs7d `yearvars' $matchvars [iw=weight_7] , or 
outreg , append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs7d) ///
	rtitles("Any improvement 7+days" ) ///
	varlabels starlevels(10 5 1)  summstat(N) 
	
//7+day definition, clinical cesd improvement
qui logit s_cesd_ge3better rhs7d `yearvars' `new_varlist' [iw=weight_7] , or 
outreg using `logpath'\spouse_analysis_july2014, append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs7d) ///
	rtitles("Clinical improvement 7+days" ) ///
	varlabels starlevels(10 5 1)  summstat(N) addtable	

****************************************************************
log close



H="Now for interviews 12m after death, all and caregivers"
capture log close

clear all
set mem 500m
set more off

//Amy's PC
local logpath E:\data\spouse\logs\july2014
local datapath E:\data\spouse\final_data

//RG PC
//local logpath C:\data\Spouse\logs\july2014
//local datapath C:\data\Spouse

log using "`logpath'\6c-HRS_Spouse_analysis_ivw_after_1yr.txt", text replace

cd `datapath'

use spouse_data_sample_v2.dta if (s_1yr_p1_core_dead==0)

gen rhs3d = .
replace rhs3d=1 if hs_los_12m >= 3 & hs_los_12m != .
replace rhs3d=0 if hs_los_12m <3 & hs_los_12m != .
la var rhs3d "3+ days hospice use"
tab hs_los_12m rhs3d , missing
tab  rhs3d , missing

tab rhs3d s_1yr_p1_core_dead, missing
tab rhs3d r_advdir_miss

tab days_p1_core_dod_cat , missing

*****************************************************************************
** User note: To update variables used in matching for this section, update list here
*****************************************************************************
//Have to use an alternate variable list because missing category for
//advanced directive is all 0 for the treated group for this subsample
global matchvars2 cc_all_count_12m_2 cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y /*r_advdir_miss*/ r_discuss_x r_srh_pf_n1 ///
s_age s_female s_white_e  s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1 

//first sort data randomly
set seed 2000
gen x=uniform()
sort x

//generate pscore variable hs_pscore
pscore rhs3d $matchvars2 , pscore(hs_pscore) blockid(hs_block) logit detail

//graph without dropping any observations in the matching process
psgraph, treated(rhs3d) pscore(hs_pscore)

//implement radius matching
gen logitpscore=ln(hs_pscore/(1-hs_pscore))
sum logitpscore

sca cal_ps1=r(sd)*0.02
sca list cal_ps1

***************************************************************************************
** User Note: If change variable list or sample, need to update the caliper here
***************************************************************************************
psmatch2  rhs3d,outcome(s_cesdbetter) pscore(hs_pscore) radius caliper(.02194096) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(rhs3d) pscore(hs_pscore)

histogram hs_pscore if _support==1, by(rhs3d) 

//look at balance of matched vs unmatched samples
pstest $matchvars2,treated(rhs3d) both hist

pstest $matchvars2,treated(rhs3d) both graph

***************************************************************************************
** User Note: If change list of continuous variables, need to update the list here
** to create qqplots here
***************************************************************************************
//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age {
gen `v'_treated = `v' if rhs3d==1 & _support==1
gen `v'_comparison = `v' if rhs3d==0 & _support==1
qqplot `v'_treated `v'_comparison
}

***************************************************************************************
** User Note: If change number of variables in list above 
** matrix size needs to be adjusted
***************************************************************************************
mat vr=J(39,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $matchvars2  {
sum `v' if rhs3d==1 //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if rhs3d==0 //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if rhs3d==1 & _support==1 //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if rhs3d==0 [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}


***************************************************************************************
** User Note: If change variable list, update rownames here to match
***************************************************************************************
mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y"  "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1" 

mat list vr

***************************************************************************************
** User Note: If change variable list / caliper, then these counts in comments can change
***************************************************************************************
//6 from treated group are off common support, 4 control are not matched (weight==.)
//_support ==1 if matched
tab _support, missing
tab _support if rhs3d==1, missing
tab _support if rhs3d==0, missing
tab _weight if rhs3d==1, missing
sum _weight if rhs3d==0

rename _weight weight_after1yr

***********************************************************************
//now run logit model using weighting 
***********************************************************************
//need to include the variables used in the propensity score

***************************************************************************************
** User Note: If change variable list / sample, then recheck frequency of year indicators
***************************************************************************************
tab r_death_year, missing
//one obs in 2010 so switch to 2009 for year fixed effects purposes

replace r_death_year=2009 if r_death_year==2010 
local yearvars ib2000.r_death_year 

logit s_cesdbetter i.rhs3d `yearvars' $matchvars2 [iw=weight_after1yr] , or 

outreg using `logpath'\ivw_time_groups_spouse_analysis, ///
	stats(e_b e_ci p) nosubstat  ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///
	"Limited to S p1 interview after 1 year of R's death" \ ///	
	"Outcome = CESD Score Decreased (by any amount) n1 to p1") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse no comorbidities.") ///
	varlabels starlevels(10 5 1)  summstat( N) replace

//Run logit with outcome=depressed n1, not depressed p1
	

logit s_cesd_ge3better i.rhs3d `yearvars' $matchvars2 [iw=weight_after1yr] , or 

outreg using `logpath'\ivw_time_groups_spouse_analysis, ///
	stats(e_b e_ci p) nosubstat  ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///
	"Limited to S p1 interview after 1 year of R's death" \ ///	
	"Outcome = CESD Score 3+ n1 to less than 3 p1" ) ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse no comorbidities.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable
	
*****************************************************************************
//check xtabs of outcomes vs control variables to look for small categories
drop if (weight_after1yr==.)

//this has continuous variables commented out
global matchvars2 /*cc_all_count_12m_2*/ cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y /*r_advdir_miss*/ r_discuss_x r_srh_pf_n1 ///
/*s_age*/ s_female s_white_e s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1 

mat all_n=J( 38,4,.)
tab s_cesdbetter , missing matcell(r1)
mat all_n[1,1]=r1[1,1] //those without improvement
mat all_n[1,2]=r1[2,1] //those with improvement

tab s_cesd_ge3better , missing matcell(r1)
mat all_n[1,3]=r1[1,1] //those without improvement
mat all_n[1,4]=r1[2,1] //those with improvement

local r = 2
foreach v in $matchvars2{
tab `v' s_cesdbetter , missing matcell(v1)
mat all_n[`r',1]=v1[2,1] //those without improvement
mat all_n[`r',2]=v1[2,2] //those with improvement
tab `v' s_cesd_ge3better, missing matcell(v2)
mat all_n[`r',3]=v2[2,1] //those without improvement
mat all_n[`r',4]=v2[2,2] //those with improvement

local r = `r'+1
}
mat rownames all_n="N" "Alz,Dement" "AMI" "CHF" "Diabetes" "Kidney dis" "COPD" ///
"Stroke" "Cancer" "Atrial fibr" "Hip fracture" "Depression" "Osteoporosis" ///
"Arthritis" "Networth Lowest Q" "Networth Mid-low" "Networth Mid-high" ///
"NH Resident" "ADL Stable, part" "ADL Stable, severe" "ADL Ind to partial" ///
"ADL Mod to Severe" "ADL Ind to Severe" "ADL missing" "Medicaid" "Champus" ///
"Medigap" "Adv Directive" "Discuss EOL care" "Fair,Poor SRH" ///
"S Female" "S White" "S HS deg" "S Relig very imp" "S Fair,Poor SRH" ///
"S Mild comorb" "S Mod comorbidities" "S psych condition"

frmttable using `logpath'\check_covariate_n, statmat(all_n) ///
title("Frequencies - Ivw > 12m after R's death") ///
ctitle("","Any CESD Improv", "","Clinical Improvement","" \ ///
"" , "No", "Yes","No", "Yes") ///
sdec(0) replace

//table of n's for the adl change categories

local adl r_adl_stable_ind_n1n2 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 ///
r_adl_improved_n1n2 r_adl_change_n1n2_miss

mat adl_n=J(8,2,.)
local r=1
foreach v in `adl'{
tab `v' if s_cesdbetter==1, matcell(v1)
mat adl_n[`r',1]=v1[2,1]

tab `v' if s_cesd_ge3better==1, matcell(v2)
mat adl_n[`r',2]=v2[2,1]

local r = `r'+1
}
mat rownames adl_n="Stable Independ" "Stable Partial" "Stable Severe" ///
"Declined Ind to Partial" "Declined Partial to Severe" "Decl Ind to Severe" ///
"ADL improved" "Change missing"
mat colnames adl_n="Any improvement" "Clinical improvement"

mat list adl_n

frmttable using `logpath'\check_covariate_n, statmat(adl_n) ///
title("ADL frequencies - Ivw > 12m after R's death") ///
sdec(0) addtable

clear all
*****************************************************************************

//End of overall sample  , start caregivers only section

*****************************************************************************

*****************************************************************************

***********************************************************************
use spouse_data_sample_v2.dta if (s_1yr_p1_core_dead==0 & (r_adl_sp_helper_x==1 | r_iadl_sp_helper_x==1))

gen rhs3d = .
replace rhs3d=1 if hs_los_12m >= 3 & hs_los_12m != .
replace rhs3d=0 if hs_los_12m <3 & hs_los_12m != .
la var rhs3d "3+ days hospice use"
tab hs_los_12m rhs3d , missing
tab  rhs3d , missing

*****************************************************************************
** User note: To update variables used in matching for this section, update list here
*****************************************************************************
global matchvars2 cc_all_count_12m_2 cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y /*r_advdir_miss*/ r_discuss_x r_srh_pf_n1 ///
s_age s_female s_white_e s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1 

//first sort data randomly
set seed 2000
gen x=uniform()
sort x

//generate pscore variable hs_pscore
pscore rhs3d $matchvars2 , pscore(hs_pscore) blockid(hs_block) logit detail

//graph without dropping any observations in the matching process
psgraph, treated(rhs3d) pscore(hs_pscore)

//implement radius matching
gen logitpscore=ln(hs_pscore/(1-hs_pscore))
sum logitpscore

sca cal_ps1=r(sd)*0.02
sca list cal_ps1

***************************************************************************************
** User Note: If change variable list or sample, need to update the caliper here
***************************************************************************************
psmatch2  rhs3d,outcome(s_cesdbetter) pscore(hs_pscore) radius caliper(.02326545) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(rhs3d) pscore(hs_pscore)

histogram hs_pscore if _support==1, by(rhs3d) 

//look at balance of matched vs unmatched samples
pstest $matchvars2,treated(rhs3d) both hist

pstest $matchvars2,treated(rhs3d) both graph

***************************************************************************************
** User Note: If change list of continuous variables, need to update the list here
** to create qqplots here
***************************************************************************************
//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age {
gen `v'_treated = `v' if rhs3d==1 & _support==1
gen `v'_comparison = `v' if rhs3d==0 & _support==1
qqplot `v'_treated `v'_comparison
}

***************************************************************************************
** User Note: If change number of variables above, 
** matrix size needs to be adjusted
***************************************************************************************
mat vr=J(39,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $matchvars2  {
sum `v' if rhs3d==1 //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if rhs3d==0 //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if rhs3d==1 & _support==1 //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if rhs3d==0 [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}

***************************************************************************************
** User Note: If change variable list, update rownames here to match
***************************************************************************************
mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1" 

mat list vr

***************************************************************************************
** User Note: If change variable list / caliper, then these counts in comments can change
***************************************************************************************
//12 from treated group are off common support, 8 control are not matched (weight==.)
//_support ==1 if matched
tab _support, missing
tab _support if rhs3d==1, missing
tab _support if rhs3d==0, missing
tab _weight if rhs3d==1, missing
sum _weight if rhs3d==0

rename _weight weight_after1yr

***********************************************************************
//now run logit model using weighting 
***********************************************************************
//need to include the variables used in the propensity score

***************************************************************************************
** User Note: If change variable list / sample, then recheck frequency of year indicators
***************************************************************************************
tab r_death_year, missing
//one obs in 2010 so switch to 2009 for year fixed effects purposes

replace r_death_year=2009 if r_death_year==2010 
local yearvars ib2000.r_death_year 

logit s_cesdbetter i.rhs3d `yearvars' $matchvars2 [iw=weight_after1yr] , or 

outreg using `logpath'\ivw_time_groups_spouse_analysis, ///
	stats(e_b e_ci p) nosubstat  ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///
	"Limited to S p1 interview after 1 year of R's death" \ ///	
	"Limited to Primary Caregiver spouses" \ ///
	"Outcome = CESD Score Decreased (by any amount) n1 to p1") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse no comorbidities.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable

***************************************************************************************
** User Note: If change variable list, update this list to match
***************************************************************************************
//Run logit with outcome=depressed n1, not depressed p1
//need alternate match variables since perfect prediction with r_adl_stable_partial_n1n2 variable
global matchvars3 cc_all_count_12m_2 cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 /*r_adl_stable_partial_n1n2*/ r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y /*r_advdir_miss*/ r_discuss_x r_srh_pf_n1 ///
s_age s_female s_white_e  s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1 	

logit s_cesd_ge3better i.rhs3d `yearvars' $matchvars3 [iw=weight_after1yr] , or 

outreg using `logpath'\ivw_time_groups_spouse_analysis, ///
	stats(e_b e_ci p) nosubstat  ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///
	"Limited to S p1 interview after 1 year of R's death" \ ///	
	"Limited to Primary Caregiver spouses" \ ///
	"Outcome = CESD Score 3+ n1 to less than 3 p1" ) ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse no comorbidities.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable
	
	


***************************************
//check xtabs of outcomes vs control variables to look for small categories
drop if (weight_after1yr==.)

//this has continuous variables commented out
global matchvars2 /*cc_all_count_12m_2*/ cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y /*r_advdir_miss*/ r_discuss_x r_srh_pf_n1 ///
/*s_age*/ s_female s_white_e s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1 

mat all_n=J( 38,4,.)
tab s_cesdbetter , missing matcell(r1)
mat all_n[1,1]=r1[1,1] //those without improvement
mat all_n[1,2]=r1[2,1] //those with improvement

tab s_cesd_ge3better , missing matcell(r1)
mat all_n[1,3]=r1[1,1] //those without improvement
mat all_n[1,4]=r1[2,1] //those with improvement

local r = 2
foreach v in $matchvars2{
tab `v' s_cesdbetter , missing matcell(v1)
mat all_n[`r',1]=v1[2,1] //those without improvement
mat all_n[`r',2]=v1[2,2] //those with improvement
tab `v' s_cesd_ge3better, missing matcell(v2)
mat all_n[`r',3]=v2[2,1] //those without improvement
mat all_n[`r',4]=v2[2,2] //those with improvement

local r = `r'+1
}
mat rownames all_n="N" "Alz,Dement" "AMI" "CHF" "Diabetes" "Kidney dis" "COPD" ///
"Stroke" "Cancer" "Atrial fibr" "Hip fracture" "Depression" "Osteoporosis" ///
"Arthritis" "Networth Lowest Q" "Networth Mid-low" "Networth Mid-high" ///
"NH Resident" "ADL Stable, part" "ADL Stable, severe" "ADL Ind to partial" ///
"ADL Mod to Severe" "ADL Ind to Severe" "ADL missing" "Medicaid" "Champus" ///
"Medigap" "Adv Directive" "Discuss EOL care" "Fair,Poor SRH" ///
"S Female" "S White" "S HS deg" "S Relig very imp" "S Fair,Poor SRH" ///
"S Mild comorb" "S Mod comorbidities" "S psych condition"

frmttable using `logpath'\check_covariate_n, statmat(all_n) ///
title("Frequencies - limited to Primary Caregivers") ///
ctitle("","Any CESD Improv", "","Clinical Improvement","" \ ///
"" , "No", "Yes","No", "Yes") ///
sdec(0) addtable

//table of n's for the adl change categories

local adl r_adl_stable_ind_n1n2 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 ///
r_adl_improved_n1n2 r_adl_change_n1n2_miss

mat adl_n=J(8,2,.)
local r=1
foreach v in `adl'{
tab `v' if s_cesdbetter==1, matcell(v1)
mat adl_n[`r',1]=v1[2,1]

tab `v' if s_cesd_ge3better==1, matcell(v2)
mat adl_n[`r',2]=v2[2,1]

local r = `r'+1
}
mat rownames adl_n="Stable Independ" "Stable Partial" "Stable Severe" ///
"Declined Ind to Partial" "Declined Partial to Severe" "Decl Ind to Severe" ///
"ADL improved" "Change missing"
mat colnames adl_n="Any improvement" "Clinical improvement"

mat list adl_n

frmttable using `logpath'\check_covariate_n, statmat(adl_n) ///
title("ADL frequencies - limited to Primary Caregivers") ///
sdec(0) addtable
	
*********************************************
log close


H="Ivws between 3-12m after death, all and caregivers"
capture log close

clear all
set mem 500m
set more off

//Amy's PC
local logpath E:\data\spouse\logs\july2014
local datapath E:\data\spouse\final_data

//RG PC
//local logpath C:\data\Spouse\logs\july2014
//local datapath C:\data\Spouse

log using "`logpath'\6d-HRS_Spouse_analysis_ivw_before_1yr.txt", text replace

cd `datapath'

use spouse_data_sample_v2.dta if (s_1yr_p1_core_dead==1)

sum days_p1_core_dead , detail //should be between 90 and 365 

gen rhs3d = .
replace rhs3d=1 if hs_los_12m >= 3 & hs_los_12m != .
replace rhs3d=0 if hs_los_12m <3 & hs_los_12m != .
la var rhs3d "3+ days hospice use"
tab hs_los_12m rhs3d , missing
tab  rhs3d , missing

tab rhs3d s_1yr_p1_core_dead, missing
tab rhs3d r_advdir_miss

tab days_p1_core_dod_cat , missing

***************************************************
//first sort data randomly
set seed 2000
gen x=uniform()
sort x

*****************************************************************************
** User note: this variable list for matching is defined in previous sections
*****************************************************************************
//generate pscore variable hs_pscore
pscore rhs3d $matchvars , pscore(hs_pscore) blockid(hs_block) logit detail

//graph without dropping any observations in the matching process
psgraph, treated(rhs3d) pscore(hs_pscore)

//implement radius matching
gen logitpscore=ln(hs_pscore/(1-hs_pscore))
sum logitpscore

sca cal_ps1=r(sd)*0.02
sca list cal_ps1

***************************************************************************************
** User Note: If change variable list or sample, need to update the caliper here
***************************************************************************************
psmatch2  rhs3d,outcome(s_cesdbetter) pscore(hs_pscore) radius caliper(.01855018) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(rhs3d) pscore(hs_pscore)

histogram hs_pscore if _support==1, by(rhs3d) 

//look at balance of matched vs unmatched samples
pstest $matchvars,treated(rhs3d) both hist

pstest $matchvars,treated(rhs3d) both graph

***************************************************************************************
** User Note: If change list of continuous variables, need to update the list here
** to create qqplots here
***************************************************************************************
//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age {
gen `v'_treated = `v' if rhs3d==1 & _support==1
gen `v'_comparison = `v' if rhs3d==0 & _support==1
qqplot `v'_treated `v'_comparison
}

***************************************************************************************
** User Note: If change number of variables for the matching 
** matrix size needs to be adjusted
***************************************************************************************
mat vr=J(40,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $matchvars {
sum `v' if rhs3d==1 //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if rhs3d==0 //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if rhs3d==1 & _support==1 //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if rhs3d==0 [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}

***************************************************************************************
** User Note: If change variable list, update rownames here to match
***************************************************************************************
mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1" 

mat list vr

***************************************************************************************
** User Note: If change variable list / caliper, then these counts in comments can change
***************************************************************************************
//7 from treated group are off common support, all control are matched (weight==.)
//_support ==1 if matched
tab _support, missing
tab _support if rhs3d==1, missing
tab _support if rhs3d==0, missing
tab _weight if rhs3d==1, missing
sum _weight if rhs3d==0

rename _weight weight_before1yr

***********************************************************************
//now run logit model using weighting 
***********************************************************************

***************************************************************************************
** User Note: If change variable list / sample, then recheck frequency of year indicators
***************************************************************************************
tab r_death_year, missing
//no observations in 2000 are in this sample so start with 2001 as base year

local yearvars ib2001.r_death_year 

logit s_cesdbetter i.rhs3d `yearvars' $matchvars [iw=weight_before1yr] , or 

outreg using `logpath'\ivw_before_1yr_spouse_analysis, ///
	stats(e_b e_ci p) nosubstat  ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///
	"Limited to S p1 interview within 3-12m of R's death" \ ///	
	"Outcome = CESD Score Decreased (by any amount) n1 to p1") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse no comorbidities.") ///
	varlabels starlevels(10 5 1)  summstat( N) replace

//Run logit with outcome=depressed n1, not depressed p1
logit s_cesd_ge3better i.rhs3d `yearvars' $matchvars [iw=weight_before1yr] , or 

outreg using `logpath'\ivw_before_1yr_spouse_analysis, ///
	stats(e_b e_ci p) nosubstat  ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///
	"Limited to S p1 interview within 3-12m of R's death" \ ///	
	"Outcome = CESD Score 3+ n1 to less than 3 p1" ) ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse no comorbidities.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable

*****************************************************************************

*****************************************************************************

//End of overall sample  , start caregivers only section

*****************************************************************************

*****************************************************************************

***********************************************************************
clear all
use spouse_data_sample_v2.dta if (s_1yr_p1_core_dead==1 & (r_adl_sp_helper_x==1 | r_iadl_sp_helper_x==1))

gen rhs3d = .
replace rhs3d=1 if hs_los_12m >= 3 & hs_los_12m != .
replace rhs3d=0 if hs_los_12m <3 & hs_los_12m != .
la var rhs3d "3+ days hospice use"
tab hs_los_12m rhs3d , missing
tab  rhs3d , missing

tab r_advdir_miss rhs3d, missing

//first sort data randomly
set seed 2000
gen x=uniform()
sort x

//generate pscore variable hs_pscore
pscore rhs3d $matchvars , pscore(hs_pscore) blockid(hs_block) logit detail

//graph without dropping any observations in the matching process
psgraph, treated(rhs3d) pscore(hs_pscore)

//implement radius matching
gen logitpscore=ln(hs_pscore/(1-hs_pscore))
sum logitpscore

sca cal_ps1=r(sd)*0.02
sca list cal_ps1

***************************************************************************************
** User Note: If change variable list or sample, need to update the caliper here
***************************************************************************************
psmatch2  rhs3d,outcome(s_cesdbetter) pscore(hs_pscore) radius caliper(.0214597) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(rhs3d) pscore(hs_pscore)

histogram hs_pscore if _support==1, by(rhs3d) 

//look at balance of matched vs unmatched samples
pstest $matchvars,treated(rhs3d) both hist

pstest $matchvars,treated(rhs3d) both graph

***************************************************************************************
** User Note: If change list of continuous variables, need to update the list here
** to create qqplots here
***************************************************************************************
//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age {
gen `v'_treated = `v' if rhs3d==1 & _support==1
gen `v'_comparison = `v' if rhs3d==0 & _support==1
qqplot `v'_treated `v'_comparison
}

***************************************************************************************
** User Note: If change number of variables, matrix size needs to be adjusted
***************************************************************************************
mat vr=J(40,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $matchvars  {
sum `v' if rhs3d==1 //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if rhs3d==0 //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if rhs3d==1 & _support==1 //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if rhs3d==0 [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}

***************************************************************************************
** User Note: If change variable list, update rownames here to match
***************************************************************************************
mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Adv dir missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1" 

mat list vr

***************************************************************************************
** User Note: If change variable list / caliper, then these counts in comments can change
***************************************************************************************
//6 from treated group are off common support, 3 control are not matched (weight==.)
//_support ==1 if matched
tab _support, missing
tab _support if rhs3d==1, missing
tab _support if rhs3d==0, missing
tab _weight if rhs3d==1, missing
sum _weight if rhs3d==0

rename _weight weight_before1yr

***********************************************************************
//now run logit model using weighting 
***********************************************************************

***************************************************************************************
** User Note: If change variable list / sample, then recheck frequency of year indicators
***************************************************************************************
tab r_death_year, missing
//again no obs in 2000 so base=2001

local yearvars ib2001.r_death_year 

***************************************************************************************
** User Note: If change variable list, update this list to match
***************************************************************************************
global matchvars2 cc_all_count_12m_2 cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y /*r_advdir_miss*/ r_discuss_x r_srh_pf_n1 ///
s_age s_female s_white_e  s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1 	
 
logit s_cesdbetter i.rhs3d `yearvars' $matchvars2 [iw=weight_before1yr] , or 

outreg using `logpath'\ivw_before_1yr_spouse_analysis, ///
	stats(e_b e_ci p) nosubstat  ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///
	"Limited to S p1 interview within 3-12m of R's death" \ ///	
	"Limited to Primary Caregiver spouses" \ ///
	"Outcome = CESD Score Decreased (by any amount) n1 to p1") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse no comorbidities.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable

***************************************************************************************
** User Note: If change variable list, update this list to match
***************************************************************************************
//Run logit with outcome=depressed n1, not depressed p1
//need alternate match variables since perfect prediction with s_hrs_comorb_mod_n1 variable
global matchvars3 cc_all_count_12m_2 cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y /*r_advdir_miss*/ r_discuss_x r_srh_pf_n1 ///
s_age s_female s_white_e  s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 /*s_hrs_comorb_mod_n1*/ s_psych_overall_hrs_n1 	

logit s_cesd_ge3better i.rhs3d `yearvars' $matchvars3 [iw=weight_before1yr] , or 
//note these estimation results are strange, huge confidence intervals
//if decide to use them, then need to revisit this model!

outreg using `logpath'\ivw_before_1yr_spouse_analysis, ///
	stats(e_b e_ci p) nosubstat  ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///
	"Limited to S p1 interview within 3-12m of R's death" \ ///	
	"Limited to Primary Caregiver spouses" \ ///
	"Outcome = CESD Score 3+ n1 to less than 3 p1" ) ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse no comorbidities.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable
	
	
*********************************************
log close


H="xxxxxxxxxxxxxxxxxxxxxx"


H="Allow p1 ivws 0-3m after R's death"
/*
*******Run with new sample definition, allows for p1 interview *****
******* within 90 days of R's death                    *************

Outcome variables are: CESD improvement indicator, ie any improvement 
in CESD score from n1 to p1
And CESD clinical improvement 3+ to <3 n1 to p1

This Stata code runs following analyses:
1. Determines propensity scores
2. Runs summary tables for r and s characteristics using px weighting
3. Px matched logit regression on reduced spouse depressive symptoms 

Runs 3 versions
1. Hospice users: 1+ days / non users: 0 days
2. Hospice users: 3+ days / non users: 0-2 days
3. Hospice users: 7+ days / non users: 0-6 days*/

capture log close

clear all
set mem 500m
set more off
set scheme s1color

//Amy's PC
local logpath E:\data\spouse\logs\august2014
local datapath E:\data\spouse\final_data

//RG PC
//local logpath C:\data\Spouse\logs
//local datapath C:\data\Spouse

log using "`logpath'\5-HRS_Spouse_analysis_aug2014.txt", text replace

cd `datapath'

use spouse_data_sample_v1.dta if (/*p1_wi_90d==0 &*/ no_cc_12m_excl_cataract==0 & sudden_cause_death==0 & cesd_miss_n1_p1==0 )

*****************************************************************************
*****************************************************************************
//Set up variables and dataset
*****************************************************************************
*****************************************************************************

//n=1049, keep 1-2 day hospice use for tables (KO email 4/11)

*****************************************************************************
** User note: To update variables used in matching for this section, update list here
*****************************************************************************
//See tab "Sum stats, unmatched" for variable list used in matching
global matchvars cc_all_count_12m_2 cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y r_advdir_miss r_discuss_x r_srh_pf_n1 ///
s_age s_female s_white_e  s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1	

//drop observations with missing covariates (24 obs)
//n=1025
foreach v of varlist $matchvars {
tab `v', missing
drop if `v'==.
}

gen byte non_hosp=.
replace non_hosp=1 if r_hs_12m==0
replace non_hosp=0 if r_hs_12m==1
tab non_hosp r_hs_12m, missing

//create / check hospice time indicator variables
tab r_hs_12m, missing
rename r_hs_12m rhs12m
la var rhs12m "1+ day hospice use"

gen rhs3d = .
replace rhs3d=1 if hs_los_12m >= 3 & hs_los_12m != .
replace rhs3d=0 if hs_los_12m <3 & hs_los_12m != .
la var rhs3d "3+ day hospice use"
tab hs_los_12m rhs3d , missing
tab  rhs3d , missing

gen rhs7d = .
replace rhs7d=1 if hs_los_12m >= 7 & hs_los_12m != .
replace rhs7d=0 if hs_los_12m <7 & hs_los_12m != .
la var rhs7d "7+ day hospice use"
tab hs_los_12m rhs7d , missing
tab  rhs7d , missing

tab s_comor_c_hrs_n1 s_cesdbetter, chi2
tab s_comor_c_hrs_n1 rhs12m, chi2

//1 obs has s_comor_c_hrs_n1 = severe, set to moderate so controlled for
replace s_hrs_comorb_mod_n1=1 if s_comor_c_hrs_n1==3

********************************************************
//save this n=1025 dataset, this is the starting point the remainder analysis steps
save spouse_data_sample_v3.dta, replace
  
//first sort data randomly
set seed 2000
gen x=uniform()
sort x

*****************************************************************************
*****************************************************************************
//Using Stata's pscore to generate px scores - 1 day definition
*****************************************************************************
*****************************************************************************

//generate pscore variable hs_pscore
pscore rhs12m $matchvars, pscore(hs_pscore) blockid(hs_block) logit detail

//graph without dropping any observations in the matching process
psgraph, treated(rhs12m) pscore(hs_pscore)
graph save `logpath'/psgraph_1 ,replace

//implement radius matching
gen logitpscore=ln(hs_pscore/(1-hs_pscore))
sum logitpscore

sca cal_ps1=r(sd)*0.02
sca list cal_ps1

***************************************************************************************
** User Note: If change variable list or sample, need to update the caliper here
***************************************************************************************
//try 0.02* sd
psmatch2  rhs12m,outcome(s_cesdbetter) pscore(hs_pscore) radius caliper(.01596179) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(rhs12m) pscore(hs_pscore)
graph save `logpath'/psgraph_2 ,replace

histogram hs_pscore if _support==1, by(rhs12m) 

//look at balance of matched vs unmatched samples
pstest $matchvars ,treated(rhs12m) both hist
graph save `logpath'/psmatch_1 ,replace

***************************************************************************************
** User Note: If change list of continuous variables, need to update the list here
** to create qqplots here
***************************************************************************************
//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age{
gen `v'_treated = `v' if rhs12m==1 & _support==1
gen `v'_comparison = `v' if rhs12m==0 & _support==1
qqplot `v'_treated `v'_comparison
graph save `logpath'/qqplot_`v', replace
}

***************************************************************************************
** User Note: If change number of variables in list above 
** matrix size needs to be adjusted
***************************************************************************************
mat vr=J(40,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $matchvars  {
sum `v' if rhs12m==1 //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if rhs12m==0 //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if rhs12m==1 & _support==1 //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if rhs12m==0 [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}

***************************************************************************************
** User Note: If change variable list, update rownames here to match
***************************************************************************************
mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1"

mat list vr

//look at standardized differences to assess balance
***************************************************************************************
** User Note: If change list of continuous variables, need to update the list here
** to manually check standardized difference
** Also if total count of variables changes (cont+binary) then need to update matrix # rows
***************************************************************************************
//continuous variables
mat std_diff=J(40,5,.)
local i=1
foreach v in cc_all_count_12m_2 s_age {
sum `v' if rhs12m==1 & _support==1 //get mean,variance treated after matching
mat std_diff[`i',1]=r(mean)
mat std_diff[`i',2]=r(sd)

sum `v' if rhs12m==0 [iweight=_weight] //get mean,variance contl after matching
mat std_diff[`i',3]=r(mean)
mat std_diff[`i',4]=r(sd)

mat std_diff[`i',5]=(std_diff[`i',1]-std_diff[`i',3])/sqrt((std_diff[`i',2]^2+std_diff[`i',4]^2)/2) 
	
local i = `i'+1	
}
//indicator variables
***************************************************************************************
** User Note: If change list of binary variables, need to update the list here
** to manually check standardized differences
***************************************************************************************
local indvars cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y r_advdir_miss r_discuss_x r_srh_pf_n1 ///
 s_female s_white_e  s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1 

foreach v in `indvars' {
sum `v' if rhs12m==1 & _support==1 //get mean treated after matching
mat std_diff[`i',1]=r(mean)

sum `v' if rhs12m==0 [iweight=_weight] //get mean contl after matching
mat std_diff[`i',3]=r(mean)

mat std_diff[`i',5]=(std_diff[`i',1]-std_diff[`i',3])/sqrt((std_diff[`i',1]*(1-std_diff[`i',1])+std_diff[`i',3]*(1-std_diff[`i',3]))/2)
	
local i = `i'+1	
}

***************************************************************************************
** User Note: If change variable list, update rownames here to match
***************************************************************************************
mat rownames std_diff="Count of comorbidities" "S age" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
 "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1" 

mat list std_diff
//standardized difference should be less than 10-25%

***************************************************************************************
** User Note: If change variable list / caliper, then these counts in comments can change
***************************************************************************************
//using this matching, 4 obs from the treatment group are dropped b/c they are off support
//1 dropped b/c not matched (weight=.)
//_support ==1 if matched
tab _support, missing
tab _support if rhs12m==1, missing
tab _support if rhs12m==0, missing
tab _weight if rhs12m==1, missing
sum _weight if rhs12m==0

//rename ps variables and save dataset so can call them up later
rename _support support_1
rename _weight weight_1

*************************************************************************************
//now run using weighting , outcome = improved CESD score p1
//need to include the variables used in the propensity score

local yearvars ib2000.r_death_year 
 
logit s_cesdbetter rhs12m `yearvars' $matchvars [iw=weight_1] , or 

outreg using `logpath'\spouse_analysis_aug2014, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score Decreased (by any amount) n1 to p1") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat( N) replace

tab s_cesdbetter s_cesd_ge3better, missing

//Run logit with outcome=depressed n1, not depressed p1
logit s_cesd_ge3better rhs12m `yearvars' $matchvars [iw=weight_1] , or 

outreg using `logpath'\spouse_analysis_aug2014, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score 3+ n1 to less than 3 p1") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable

*****************************************************************************

*****************************************************************************

//End of 1 day definition , start 3 day definition section

*****************************************************************************

*****************************************************************************
	
	
*****************************************************************************
*****************************************************************************
//Using Stata's pscore to generate px scores - 3 day definition
*****************************************************************************
*****************************************************************************
//first sort data randomly
set seed 2000
gen x3=uniform()
sort x3
//generate pscore variable hs_pscore
pscore rhs3d $matchvars, pscore(hs_pscore3) blockid(hs_block3) logit detail

//graph without dropping any observations in the matching process
psgraph, treated(rhs3d) pscore(hs_pscore3)
graph save `logpath'/psgraph_1_3 ,replace

//implement radius matching
gen logitpscore3=ln(hs_pscore3/(1-hs_pscore3))
sum logitpscore3

sca cal_ps3=r(sd)*0.02
sca list cal_ps3

***************************************************************************************
** User Note: If change variable or sample list, need to update the caliper here
***************************************************************************************
//try 0.02* sd
psmatch2  rhs3d,outcome(s_cesdbetter) pscore(hs_pscore3) radius caliper(.01593829) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(rhs3d) pscore(hs_pscore3)
graph save `logpath'/psgraph_2_3 ,replace

histogram hs_pscore3 if _support==1, by(rhs3d) 

//look at balance of matched vs unmatched samples
pstest $matchvars ,treated(rhs3d) both hist
graph save `logpath'/psmatch_1_3 ,replace

***************************************************************************************
** User Note: If change list of continuous variables, need to update the list here
** to create qqplots here
***************************************************************************************
//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age{
gen `v'_treated3 = `v' if rhs3d==1 & _support==1
gen `v'_comparison3 = `v' if rhs3d==0 & _support==1
qqplot `v'_treated3 `v'_comparison3
graph save `logpath'/qqplot_`v'_3, replace
}

***************************************************************************************
** User Note: If change number of variables, matrix size needs to be adjusted
** number of rows = 40 in mat vr definition, this will change if number of variables changes
***************************************************************************************
mat vr=J(40,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $matchvars  {
sum `v' if rhs3d==1 //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if rhs3d==0 //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if rhs3d==1 & _support==1 //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if rhs3d==0 [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}

***************************************************************************************
** User Note: If change variable list, update these rownames to match
***************************************************************************************
mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1" 

mat list vr

//look at standardized differences to assess balance
***************************************************************************************
** User Note: If change list of continuous variables, need to update the list here
** to manually check standardized difference
** Also if total count of variables changes (cont+binary) then need to update matrix # rows
***************************************************************************************
//continuous variables
mat std_diff=J(40,5,.)
local i=1
foreach v in cc_all_count_12m_2 s_age {
sum `v' if rhs3d==1 & _support==1 //get mean,variance treated after matching
mat std_diff[`i',1]=r(mean)
mat std_diff[`i',2]=r(sd)

sum `v' if rhs3d==0 [iweight=_weight] //get mean,variance contl after matching
mat std_diff[`i',3]=r(mean)
mat std_diff[`i',4]=r(sd)

mat std_diff[`i',5]=(std_diff[`i',1]-std_diff[`i',3])/sqrt((std_diff[`i',2]^2+std_diff[`i',4]^2)/2) 
	
local i = `i'+1	
}
//indicator variables
***************************************************************************************
** User Note: If change list of binary variables, need to update the list here
** to manually check standardized differences
***************************************************************************************
local indvars cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y r_advdir_miss r_discuss_x r_srh_pf_n1 ///
 s_female s_white_e  s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1 

foreach v in `indvars' {
sum `v' if rhs3d==1 & _support==1 //get mean treated after matching
mat std_diff[`i',1]=r(mean)

sum `v' if rhs3d==0 [iweight=_weight] //get mean contl after matching
mat std_diff[`i',3]=r(mean)

mat std_diff[`i',5]=(std_diff[`i',1]-std_diff[`i',3])/sqrt((std_diff[`i',1]*(1-std_diff[`i',1])+std_diff[`i',3]*(1-std_diff[`i',3]))/2)
	
local i = `i'+1	
}

***************************************************************************************
** User Note: If change variable list, update rownames here to match
***************************************************************************************
mat rownames std_diff="Count of comorbidities" "S age" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
 "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1" 

mat list std_diff
//standardized difference should be less than 10-25%

***************************************************************************************
** User Note: If change variable list / caliper, then these counts in comments can change
***************************************************************************************
//using this matching, 7 obs from the treatment group are dropped b/c they are off support
//2 dropped b/c not matched (weight=.)
//_support ==1 if matched
tab _support, missing
tab _support if rhs3d==1, missing
tab _support if rhs3d==0, missing
tab _weight if rhs3d==1, missing
sum _weight if rhs3d==0

//rename ps variables and save dataset so can call them up later
rename _support support_3
rename _weight weight_3

//now run using weighting , outcome = improved CESD score p1
//need to include the variables used in the propensity score
 
logit s_cesdbetter rhs3d `yearvars' $matchvars [iw=weight_3] , or 

outreg using `logpath'\spouse_analysis_aug2014, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score Decreased (by any amount) n1 to p1" \ ///
	"3+ days of hospice use = treatment, 0-2 days = control") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable


tab s_cesdbetter s_cesd_ge3better, missing

//Run logit with outcome=depressed n1, not depressed p1
logit s_cesd_ge3better rhs3d `yearvars' $matchvars [iw=weight_3] , or 

outreg using `logpath'\spouse_analysis_aug2014, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score 3+ n1 to less than 3 p1" \ ///
	"3+ days of hospice use = treatment, 0-2 days = control")  ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable

*****************************************************************************

*****************************************************************************

//End of 3 day definition , start 7 day definition section

*****************************************************************************

*****************************************************************************
	
	
*****************************************************************************
*****************************************************************************
//Using Stata's pscore to generate px scores - 7 day definition
*****************************************************************************
*****************************************************************************
//first sort data randomly
set seed 2000
gen x7=uniform()
sort x7
//generate pscore variable hs_pscore
pscore rhs7d $matchvars, pscore(hs_pscore7) blockid(hs_block7) logit detail

//graph without dropping any observations in the matching process
psgraph, treated(rhs7d) pscore(hs_pscore7)
graph save `logpath'/psgraph_1_7 ,replace

//implement radius matching
gen logitpscore7=ln(hs_pscore7/(1-hs_pscore7))
sum logitpscore7

sca cal_ps7=r(sd)*0.02
sca list cal_ps7

***************************************************************************************
** User Note: If change variable list or sample, need to update the caliper here
***************************************************************************************
//try 0.02* sd
psmatch2  rhs7d,outcome(s_cesdbetter) pscore(hs_pscore7) radius caliper(.01605468) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(rhs7d) pscore(hs_pscore7)
graph save `logpath'/psgraph_2_7 ,replace

histogram hs_pscore7 if _support==1, by(rhs7d) 

//look at balance of matched vs unmatched samples
pstest $matchvars ,treated(rhs7d) both hist
graph save `logpath'/psmatch_1_7 ,replace

***************************************************************************************
** User Note: If change list of continuous variables, need to update the list here
** to create qqplots here
***************************************************************************************
//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age{
gen `v'_treated7 = `v' if rhs7d==1 & _support==1
gen `v'_comparison7 = `v' if rhs7d==0 & _support==1
qqplot `v'_treated7 `v'_comparison7
graph save `logpath'/qqplot_`v'_7, replace
}

***************************************************************************************
** User Note: If change number of variables in list, matrix size needs to be adjusted
***************************************************************************************
mat vr=J(40,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $matchvars  {
sum `v' if rhs7d==1 //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if rhs7d==0 //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if rhs7d==1 & _support==1 //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if rhs7d==0 [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}

***************************************************************************************
** User Note: If change variable list, update rownames here to match
***************************************************************************************
mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1"

mat list vr

//look at standardized differences to assess balance
***************************************************************************************
** User Note: If change list of continuous variables, need to update the list here
** to manually check standardized difference
** Also if total count of variables changes (cont+binary) then need to update matrix # rows
***************************************************************************************
//continuous variables
mat std_diff=J(40,5,.)
local i=1
foreach v in cc_all_count_12m_2 s_age {
sum `v' if rhs7d==1 & _support==1 //get mean,variance treated after matching
mat std_diff[`i',1]=r(mean)
mat std_diff[`i',2]=r(sd)

sum `v' if rhs7d==0 [iweight=_weight] //get mean,variance contl after matching
mat std_diff[`i',3]=r(mean)
mat std_diff[`i',4]=r(sd)

mat std_diff[`i',5]=(std_diff[`i',1]-std_diff[`i',3])/sqrt((std_diff[`i',2]^2+std_diff[`i',4]^2)/2) 
	
local i = `i'+1	
}
//indicator variables
***************************************************************************************
** User Note: If change list of binary variables, need to update the list here
** to manually check standardized differences
***************************************************************************************
local indvars cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y r_advdir_miss r_discuss_x r_srh_pf_n1 ///
 s_female s_white_e  s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1 

foreach v in `indvars' {
sum `v' if rhs7d==1 & _support==1 //get mean treated after matching
mat std_diff[`i',1]=r(mean)

sum `v' if rhs7d==0 [iweight=_weight] //get mean contl after matching
mat std_diff[`i',3]=r(mean)

mat std_diff[`i',5]=(std_diff[`i',1]-std_diff[`i',3])/sqrt((std_diff[`i',1]*(1-std_diff[`i',1])+std_diff[`i',3]*(1-std_diff[`i',3]))/2)
	
local i = `i'+1	
}

***************************************************************************************
** User Note: If change variable list, update rownames here to match
***************************************************************************************
mat rownames std_diff="Count of comorbidities" "S age" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
 "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1" 

mat list std_diff
//standardized difference should be less than 10-25%

***************************************************************************************
** User Note: If change variable list / caliper, then these counts in comments can change
***************************************************************************************
//using this matching, 13 obs from the treatment group are dropped b/c they are off support
//2 dropped b/c not matched (weight=.)
//_support ==1 if matched
tab _support, missing
tab _support if rhs7d==1, missing
tab _support if rhs7d==0, missing
tab _weight if rhs7d==1, missing
sum _weight if rhs7d==0

//rename ps variables and save dataset so can call them up later
rename _support support_7
rename _weight weight_7

//save this dataset for making the tables in the next section
//this retains the weight variables
save `datapath'\spouse_data_sample_v3_august2014.dta, replace

//now run using weighting , outcome = improved CESD score p1
//need to include the variables used in the propensity score
 
logit s_cesdbetter rhs7d `yearvars' $matchvars [iw=weight_7] , or 

outreg using `logpath'\spouse_analysis_aug2014, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score Decreased (by any amount) n1 to p1" \ ///
	"7+ days of hospice use = treatment, 0-6 days = control") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable


tab s_cesdbetter s_cesd_ge3better, missing

//Run logit with outcome=depressed n1, not depressed p1
logit s_cesd_ge3better rhs7d `yearvars' $matchvars [iw=weight_7] , or 

outreg using `logpath'\spouse_analysis_aug2014, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score 3+ n1 to less than 3 p1" \ ///
	"7+ days of hospice use = treatment, 0-6 days = control")  ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable
****************************************************************
	
****************************************************************
//run each dr regression in a row to get a single table with all of the results
****************************************************************

****************************************************************

//1+day definition, any cesd improvement
qui logit s_cesdbetter rhs12m `yearvars' $matchvars [iw=weight_1] , or 
outreg , store(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs12m) ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = S Depressive symptom improvement n1 to p1") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	rtitles("Any improvement 1+day" ) ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions.") ///
	varlabels starlevels(10 5 1)  summstat(N)

//1+day definition, clinical cesd improvement
qui logit s_cesd_ge3better rhs12m `yearvars' $matchvars [iw=weight_1] , or 
outreg , append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs12m) ///
	rtitles("Clinical improvement 1+day") ///
	varlabels starlevels(10 5 1)  summstat(N) 
	
//3+day definition, any cesd improvement
qui logit s_cesdbetter rhs3d `yearvars' $matchvars [iw=weight_3] , or 
outreg , append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs3d) ///
	rtitles("Any improvement 3+days" ) ///
	varlabels starlevels(10 5 1)  summstat(N) 
	
//3+day definition, clinical cesd improvement
qui logit s_cesd_ge3better rhs3d `yearvars' $matchvars [iw=weight_3] , or 
outreg , append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs3d) ///
	rtitles("Clinical improvement 3+days" ) ///
	varlabels starlevels(10 5 1)  summstat(N) 

//7+day definition, any cesd improvement
qui logit s_cesdbetter rhs7d `yearvars' $matchvars [iw=weight_7] , or 
outreg , append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs7d) ///
	rtitles("Any improvement 7+days" ) ///
	varlabels starlevels(10 5 1)  summstat(N) 
	
//7+day definition, clinical cesd improvement
qui logit s_cesd_ge3better rhs7d `yearvars' $matchvars [iw=weight_7] , or 
outreg using `logpath'\spouse_analysis_aug2014, append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs7d) ///
	rtitles("Clinical improvement 7+days" ) ///
	varlabels starlevels(10 5 1)  summstat(N) addtable	

****************************************************************
log close



H="Tables 1&2"
/* *******Run with new sample definition, allows for p1 interview *****
******* within 90 days of R's death                    *************

Creates decedent and spouse characteristic tables

Hospice users definition: 3+ days / non users: 0-2 days

Runs in 2 sections, first are unmatched samples, then matched samples
*/

capture log close

clear all
set mem 500m
set more off
set scheme s1color

//Amy's PC
local logpath E:\data\spouse\logs\august2014
local datapath E:\data\spouse\final_data

log using "`logpath'\5a-HRS_Spouse_char_tables_august2014.txt", text replace

cd `datapath'

use spouse_data_sample_v3_august2014.dta

*******************************************************
tab rhs3d , missing

gen non_hosp3=1 if rhs3d==0
replace non_hosp3=0 if rhs3d==1
tab non_hosp3 rhs3d, missing
 
*************************************************************************************
*************************************************************************************
//Create Table 1, Decedent Descriptive Statistics
//Col 1-3: Unweighted, unmatched sample
//Col 4-6: Weighted and matched sample
*************************************************************************************
*************************************************************************************
gen r_adl_improv_stab_i_n1n2 = 0
replace r_adl_improv_stab_i_n1n2  = 1 if r_adl_stable_ind_n1n2 ==1 | r_adl_improved_n1n2 
tab r_adl_improv_stab_i_n1n2 , missing

local t1vars r_medicaid_n1 r_nhres_n1 r_advdir_y r_advdir_n ///
r_advdir_miss r_adl_improv_stab_i_n1n2 ///
r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 r_adl_change_i_m_n1n2 ///
r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss cc_3_alzhdmta_n12mn0 ///
cc_6_chrnkidn_n12mn0 cc_12_ischmcht_n12mn0 cc_8_chf_n12mn0 ///
cc_9_diabetes_n12mn0 cc_7_copd_n12mn0 cc_16_strketia_n12mn0 ///
cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 cc_11_hipfrac_n12mn0 ///
cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 cc_15_ra_oa_n12mn0 

sum r_age, detail

mat demo=J(35,6,.)

//first row, n of hospice users and non-users
tab rhs3d , missing matcell(d1)
mat demo[1,1]=d1[2,1] //non-hospice n
mat demo[1,2]=d1[1,1] //hospice users n

local j=1
foreach h in rhs3d non_hosp3 {
sum r_age if `h'==1, detail //age
mat demo[2,`j']=r(mean)
mat demo[3,`j']=r(sd)
sum r_female if `h'==1, detail //female
mat demo[4,`j']=r(mean)*100
sum r_white_e if `h'==1, detail //non-hispanic, white
mat demo[5,`j']=r(mean)*100
sum r_hseduc_n1_n3 if `h'==1, detail //hs education+
mat demo[6,`j']=r(mean)*100
sum r_networth_adj2010_n1 if `h'==1, detail //net worth
mat demo[7,`j']=r(mean)
mat demo[8,`j']=r(sd)
local i=9
foreach v in `t1vars' {
	sum `v' if `h'==1, detail 
	mat demo[`i',`j']=r(mean)*100
	local i=`i'+1 //populates rows 9-34
	}
sum cc_all_count_12m_2 if `h'==1, detail //count of chronic conditions
mat demo[34,`j']=r(mean)
mat demo[35,`j']=r(sd)
local j=`j'+1
}

//standardized difference for unmatched sample
//creates new matrix with means then puts the standardized difference into
//the main demo matrix

mat std_diff_b=J(36,4,.)

local r=2
sum r_age if rhs3d==1 //get mean,variance treated before matching
mat std_diff_b[`r',1]=r(mean)
mat std_diff_b[`r',2]=r(sd)

sum r_age if rhs3d==0 //get mean,variance contl before matching
mat std_diff_b[`r',3]=r(mean)
mat std_diff_b[`r',4]=r(sd)

mat demo[`r',3]=(std_diff_b[`r',1]-std_diff_b[`r',3])/sqrt((std_diff_b[`r',2]^2+std_diff_b[`r',4]^2)/2) 
	
local r = 4
foreach v in r_female r_white_e r_hseduc_n1_n3 {
	sum `v' if rhs3d==1 //get mean,variance treated before matching
	mat std_diff_b[`r',1]=r(mean)

	sum `v' if rhs3d==0 //get mean,variance contl before matching
	mat std_diff_b[`r',3]=r(mean)

	mat demo[`r',3]=(std_diff_b[`r',1]-std_diff_b[`r',3])/sqrt((std_diff_b[`r',1]*(1-std_diff_b[`r',1])+std_diff_b[`r',3]*(1-std_diff_b[`r',3]))/2)

	local r = `r'+1
}

sum r_networth_adj2010_n1 if rhs3d==1 //get mean,variance treated before matching
mat std_diff_b[`r',1]=r(mean)
mat std_diff_b[`r',2]=r(sd)

sum r_networth_adj2010_n1 if rhs3d==0 //get mean,variance contl before matching
mat std_diff_b[`r',3]=r(mean)
mat std_diff_b[`r',4]=r(sd)

mat demo[`r',3]=(std_diff_b[`r',1]-std_diff_b[`r',3])/sqrt((std_diff_b[`r',2]^2+std_diff_b[`r',4]^2)/2) 

local r = 9
foreach v in `t1vars' {
	sum `v' if rhs3d==1 //get mean,variance treated before matching
	mat std_diff_b[`r',1]=r(mean)

	sum `v' if rhs3d==0 //get mean,variance contl before matching
	mat std_diff_b[`r',3]=r(mean)

	mat demo[`r',3]=(std_diff_b[`r',1]-std_diff_b[`r',3])/sqrt((std_diff_b[`r',1]*(1-std_diff_b[`r',1])+std_diff_b[`r',3]*(1-std_diff_b[`r',3]))/2)

	local r = `r'+1
}

local r = 34
sum cc_all_count_12m_2 if rhs3d==1 //get mean,variance treated before matching
mat std_diff_b[`r',1]=r(mean)
mat std_diff_b[`r',2]=r(sd)

sum cc_all_count_12m_2 if rhs3d==0 //get mean,variance contl before matching
mat std_diff_b[`r',3]=r(mean)
mat std_diff_b[`r',4]=r(sd)

mat demo[`r',3]=(std_diff_b[`r',1]-std_diff_b[`r',3])/sqrt((std_diff_b[`r',2]^2+std_diff_b[`r',4]^2)/2) 


//just look at it to check means against the pstest output to make sure they are right
mat rownames std_diff_b= "R age" "" "Female" "White" "HS Degree" "Net worth" "" ///
"Medicaid" "Nursing home res before death"  ///
"Advance directive Y" "Advance directive N" "Advance directive missing" ///
"ADL improved or stable ind" "ADL stable partial" "ADL stable severe" ///
"ADL Ind to mod" "ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" ///
"Alzheimers/Dementia" "Chronic kidney disease" "AMI / ISCH" ///
"CHF" "Diabetes" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis" "Count of comorbidities" ""

mat list std_diff_b

*************************************************************************************
//Table 1 - cols 4-6: Respondent characteristics, matched and weighted
*************************************************************************************

//first row, n of hospice users and non-users
tab rhs3d if weight_3!=. , missing matcell(dm)
mat demo[1,5]=dm[1,1] //non-hospice n
mat demo[1,4]=dm[2,1] //hospice users n

local j=4
foreach h in rhs3d non_hosp3 {
sum r_age if `h'==1 [iweight=weight_3] //age
mat demo[2,`j']=r(mean)
mat demo[3,`j']=r(sd)
sum r_female if `h'==1 [iweight=weight_3] //female
mat demo[4,`j']=r(mean)*100
sum r_white_e if `h'==1 [iweight=weight_3] //non-hispanic, white
mat demo[5,`j']=r(mean)*100
sum r_hseduc_n1_n3 if `h'==1 [iweight=weight_3] //hs education+
mat demo[6,`j']=r(mean)*100
sum r_networth_adj2010_n1 if `h'==1 [iweight=weight_3] //net worth
mat demo[7,`j']=r(mean)
mat demo[8,`j']=r(sd)
local i=9
foreach v in `t1vars' {
	sum `v' if `h'==1 [iweight=weight_3] 
	mat demo[`i',`j']=r(mean)*100
	local i=`i'+1 //populates rows 9-34
	}
sum cc_all_count_12m_2 if `h'==1 [iweight=weight_3] //count of chronic conditions
mat demo[34,`j']=r(mean)
mat demo[35,`j']=r(sd)
local j=`j'+1
}

//standardized difference for matched sample
//creates new matrix with means then puts the standardized difference into
//the main demo matrix

mat std_diff_a=J(35,4,.)

local r=2
sum r_age if rhs3d==1 [iweight=weight_3] //get mean,variance treated after matching
mat std_diff_a[`r',1]=r(mean)
mat std_diff_a[`r',2]=r(sd)

sum r_age if rhs3d==0 [iweight=weight_3] //get mean,variance contl after matching
mat std_diff_a[`r',3]=r(mean)
mat std_diff_a[`r',4]=r(sd)

mat demo[`r',6]=(std_diff_a[`r',1]-std_diff_a[`r',3])/sqrt((std_diff_a[`r',2]^2+std_diff_a[`r',4]^2)/2) 
	
local r = 4
foreach v in r_female r_white_e r_hseduc_n1_n3 {
	sum `v' if rhs3d==1 [iweight=weight_3] //get mean,variance treated after matching
	mat std_diff_a[`r',1]=r(mean)

	sum `v' if rhs3d==0 [iweight=weight_3] //get mean,variance contl after matching
	mat std_diff_a[`r',3]=r(mean)

	mat demo[`r',6]=(std_diff_a[`r',1]-std_diff_a[`r',3])/sqrt((std_diff_a[`r',1]*(1-std_diff_a[`r',1])+std_diff_a[`r',3]*(1-std_diff_a[`r',3]))/2)

	local r = `r'+1
}

sum r_networth_adj2010_n1 if rhs3d==1 [iweight=weight_3] //get mean,variance treated after matching
mat std_diff_a[`r',1]=r(mean)
mat std_diff_a[`r',2]=r(sd)

sum r_networth_adj2010_n1 if rhs3d==0 [iweight=weight_3] //get mean,variance contl after matching
mat std_diff_a[`r',3]=r(mean)
mat std_diff_a[`r',4]=r(sd)

mat demo[`r',6]=(std_diff_a[`r',1]-std_diff_a[`r',3])/sqrt((std_diff_a[`r',2]^2+std_diff_a[`r',4]^2)/2) 

local r = 9
foreach v in `t1vars' {
	sum `v' if rhs3d==1 [iweight=weight_3] //get mean,variance treated after matching
	mat std_diff_a[`r',1]=r(mean)

	sum `v' if rhs3d==0 [iweight=weight_3] //get mean,variance contl after matching
	mat std_diff_a[`r',3]=r(mean)

	mat demo[`r',6]=(std_diff_a[`r',1]-std_diff_a[`r',3])/sqrt((std_diff_a[`r',1]*(1-std_diff_a[`r',1])+std_diff_a[`r',3]*(1-std_diff_a[`r',3]))/2)

	local r = `r'+1
}

local r = 34
sum cc_all_count_12m_2 if rhs3d==1 [iweight=weight_3] //get mean,variance treated after matching
mat std_diff_a[`r',1]=r(mean)
mat std_diff_a[`r',2]=r(sd)

sum cc_all_count_12m_2 if rhs3d==0 [iweight=weight_3] //get mean,variance contl after matching
mat std_diff_a[`r',3]=r(mean)
mat std_diff_a[`r',4]=r(sd)

mat demo[`r',6]=(std_diff_a[`r',1]-std_diff_a[`r',3])/sqrt((std_diff_a[`r',2]^2+std_diff_a[`r',4]^2)/2) 


//just look at it to check means against the pstest output to make sure they are right
mat rownames std_diff_a= "R age" "" "Female" "White" "HS Degree" "Net worth" "" ///
"Medicaid" "Nursing home res before death"  ///
"Advance directive Y" "Advance directive N" "Advance directive missing" ///
"ADL improved or stable ind" "ADL stable partial" "ADL stable severe"  ///
"ADL Ind to mod" "ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" ///
"Alzheimers/Dementia" "Chronic kidney disease" "AMI / ISCH" ///
"CHF" "Diabetes" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis" "Count of comorbidities" ""

mat list std_diff_a


mat rownames demo ="Sample n" "Age at death, years, mean" "SD" "Female, %" "Race, Non-Hispanic White, %" ///
"Education, High School Grad" "Net worth, 2010US$, mean" "SD" "Medicaid, %" ///
"Nursing home resident n1, %" "Had advance directive" ///
"Did not have advance directive" "Advance directive status unknown" ///
"Impr or Indep in ADLs n2 to n1" ///
"Stable, Moderate 1-3 ADL" "Stable, Severe 4-6 ADL" ///
"Declined, Indep to Moderate" "Declined, Moderate to Severe" ///
"Declined, Independent to Severe" "Unknown" "Alzheimers/Dementia" "Chronic Kidney Disease" ///
"Ischemic Heart Disease" "Congestive Heart Failure" "Diabetes" "COPD" ///
"Stroke or TIA" "Cancer" "Atrial Fibrillation" "Hip Fracture" "Depression" "Osteoporosis" ///
"Arthritis" "Count of chronic conditions" "SD"

mat list demo

frmttable using `logpath'\spo_Table1_deced_char, statmat(demo) ///
title("Decedent descriptive characteristics, 3+ hospice days") ///
ctitle("","Unmatched Sample","","","Matched Sample","","" \ "", "Hospice users","Non-hospice users","Std. Diff.", ///
  "Hospice users" ,"Non-hospice users" ,"Std. Diff.") ///
sdec(2,2,3,2,2,3) replace

******************************************************************
******************************************************************
//Table 2 spouse characteristics
//Col 1-3: unmatched, unweighted
//Col 4-6: matched and weighted
******************************************************************
******************************************************************
local sdemovar1 s_female s_white_e s_hseduc_n1_n3 ///
s_medicaid_n1 s_srh_pf_n1 s_imprelig_vimp_n1 s_smoke_curr_n1 ///
s_vig_phy_act_n1 s_hrs_comorb_none_n1 s_hrs_comorb_mild_n1 ///
s_hrs_comorb_mod_n1 s_cancer_hrs_n1 ///
s_lung_hrs_n1 s_heart_hrs_n1 s_chf_hrs_n1 s_stroke_hrs_n1 ///
s_memory_hrs_n1 s_htn_hrs_n1 s_dm_hrs_n1 s_psych_hrs_n1 ///
days_p1_core_dod_lt6m days_p1_core_dod_6_12m days_p1_core_dod_12_18m ///
days_p1_core_dod_gt18mo

local sdemovar2 s_cesd_tot_ge3_n1 ///
s_cesd_tot_ge3_p1 s_cesdbetter s_cesdsame s_cesdworse 

mat sdemo=J(35,6,.)

//first row, n of hospice and non-hospice
tab rhs3d, missing matcell(sd1)
mat sdemo[1,1]=sd1[2,1] //non-hospice n
mat sdemo[1,2]=sd1[1,1] //hospice users n

local j=1
foreach h in rhs3d non_hosp3 {
sum s_age if `h'==1, detail //age
mat sdemo[2,`j']=r(mean)
mat sdemo[3,`j']=r(sd)
local i=4
foreach v in `sdemovar1' {
	sum `v' if `h'==1, detail 
	mat sdemo[`i',`j']=r(mean)*100
	local i=`i'+1 //populates rows 4-27
	}

sum s_cesd_tot_n1 if `h'==1, detail //cesd score n1
mat sdemo[28,`j']=r(mean)
sum s_cesd_tot_p1 if `h'==1, detail //cesd score p1
mat sdemo[29,`j']=r(mean)
sum s_cesdchange if `h'==1, detail //cesd score change n1 to p1
mat sdemo[30,`j']=r(mean)

local i=31
foreach v in `sdemovar2' {
	sum `v' if `h'==1, detail 
	mat sdemo[`i',`j']=r(mean)*100
	local i=`i'+1 //populates rows 31-35
	}
local j=`j'+1
}

//standardized difference for unmatched sample
//creates new matrix with means then puts the standardized difference into
//the main demo matrix

mat std_diff_b=J(35,4,.)

local r=2
sum s_age if rhs3d==1 //get mean,variance treated before matching
mat std_diff_b[`r',1]=r(mean)
mat std_diff_b[`r',2]=r(sd)

sum s_age if rhs3d==0 //get mean,variance contl before matching
mat std_diff_b[`r',3]=r(mean)
mat std_diff_b[`r',4]=r(sd)

mat sdemo[`r',3]=(std_diff_b[`r',1]-std_diff_b[`r',3])/sqrt((std_diff_b[`r',2]^2+std_diff_b[`r',4]^2)/2)

local r = 4
foreach v in `sdemovar1'  {
	sum `v' if rhs3d==1 //get mean,variance treated before matching
	mat std_diff_b[`r',1]=r(mean)

	sum `v' if rhs3d==0 //get mean,variance contl before matching
	mat std_diff_b[`r',3]=r(mean)

	mat sdemo[`r',3]=(std_diff_b[`r',1]-std_diff_b[`r',3])/sqrt((std_diff_b[`r',1]*(1-std_diff_b[`r',1])+std_diff_b[`r',3]*(1-std_diff_b[`r',3]))/2)

	local r = `r'+1
}

local r = 28
foreach v in s_cesd_tot_n1  s_cesd_tot_p1  s_cesdchange {
        sum `v' if rhs3d==1 //get mean,variance treated before matching
    mat std_diff_b[`r',1]=r(mean)
    mat std_diff_b[`r',2]=r(sd)

    sum `v' if rhs3d==0 //get mean,variance contl before matching
    mat std_diff_b[`r',3]=r(mean)
    mat std_diff_b[`r',4]=r(sd)

    mat sdemo[`r',3]=(std_diff_b[`r',1]-std_diff_b[`r',3])/sqrt((std_diff_b[`r',2]^2+std_diff_b[`r',4]^2)/2)

    local r = `r'+1
}

local r = 31
foreach v in `sdemovar2' {
	sum `v' if rhs3d==1 //get mean,variance treated before matching
	mat std_diff_b[`r',1]=r(mean)

	sum `v' if rhs3d==0 //get mean,variance contl before matching
	mat std_diff_b[`r',3]=r(mean)

	mat sdemo[`r',3]=(std_diff_b[`r',1]-std_diff_b[`r',3])/sqrt((std_diff_b[`r',1]*(1-std_diff_b[`r',1])+std_diff_b[`r',3]*(1-std_diff_b[`r',3]))/2)

	local r = `r'+1
}

//just look at it to check means against the pstest output to make sure they are right
mat rownames std_diff_b= "S age" "" "Female" "White" "HS Degree" ///
"Medicaid" "SRH poor/fair" "Religion very imp" "Smoker" "Vigorous phys act" ///
"Comorb - none" "Mild" "Moderate" "Cancer" "Lung disease" "Heart disease" "CHF" "Stroke" ///
"Memory disease" "Hypertension" "Diabetes" "Psych problems" "p1 ivw 0-6m" ///
"p1 ivw 6-12m" "p1 ivw 12-18m" "p1 > 18m" "CESD raw n1" "CESD raw p1" "CESD change" ///
"Clin depr n1" "Clin depr p1" "CESD improved" "CESD same" "CESD declined"

mat list std_diff_b


**********************************************************************
//Matched weighted columns 4-6
**********************************************************************

//first row, n of hospice and non-hospice
tab rhs3d if weight_3!=., missing matcell(sd1)
mat sdemo[1,4]=sd1[2,1] //hospice n
mat sdemo[1,5]=sd1[1,1] //non-hospice users n

local j=4
foreach h in rhs3d non_hosp3 {
sum s_age if `h'==1 [iweight=weight_3] //age
mat sdemo[2,`j']=r(mean)
mat sdemo[3,`j']=r(sd)
local i=4
foreach v in `sdemovar1' {
	sum `v' if `h'==1 [iweight=weight_3] 
	mat sdemo[`i',`j']=r(mean)*100
	local i=`i'+1 //populates rows 4-27
	}
sum s_cesd_tot_n1 if `h'==1 [iweight=weight_3] //cesd score n1
mat sdemo[28,`j']=r(mean)
sum s_cesd_tot_p1 if `h'==1 [iweight=weight_3] //cesd score p1
mat sdemo[29,`j']=r(mean)
sum s_cesdchange if `h'==1 [iweight=weight_3] //cesd score change n1 to p1
mat sdemo[30,`j']=r(mean)
local i=31
foreach v in `sdemovar2' {
	sum `v' if `h'==1 [iweight=weight_3] 
	mat sdemo[`i',`j']=r(mean)*100
	local i=`i'+1 //populates rows 31-35
	}
local j=`j'+1
}

//standardized difference for matched sample
//creates new matrix with means then puts the standardized difference into
//the main demo matrix

mat std_diff_a=J(35,4,.)

local r=2
sum s_age if rhs3d==1 [iweight=weight_3] //get mean,variance treated after matching
mat std_diff_a[`r',1]=r(mean)
mat std_diff_a[`r',2]=r(sd)

sum s_age if rhs3d==0 [iweight=weight_3] //get mean,variance contl after matching
mat std_diff_a[`r',3]=r(mean)
mat std_diff_a[`r',4]=r(sd)

mat sdemo[`r',6]=(std_diff_a[`r',1]-std_diff_a[`r',3])/sqrt((std_diff_a[`r',2]^2+std_diff_a[`r',4]^2)/2)

local r = 4
foreach v in `sdemovar1' {
	sum `v' if rhs3d==1 [iweight=weight_3] //get mean,variance treated after matching
	mat std_diff_a[`r',1]=r(mean)

	sum `v' if rhs3d==0 [iweight=weight_3] //get mean,variance contl after matching
	mat std_diff_a[`r',3]=r(mean)

	mat sdemo[`r',6]=(std_diff_a[`r',1]-std_diff_a[`r',3])/sqrt((std_diff_a[`r',1]*(1-std_diff_a[`r',1])+std_diff_a[`r',3]*(1-std_diff_a[`r',3]))/2)

	local r = `r'+1
}

local r = 28
foreach v in s_cesd_tot_n1 s_cesd_tot_p1 s_cesdchange  {
        sum `v' if rhs3d==1 [iweight=weight_3] //get mean,variance treated after matching
        mat std_diff_a[`r',1]=r(mean)
        mat std_diff_a[`r',2]=r(sd)

        sum `v' if rhs3d==0 [iweight=weight_3] //get mean,variance contl after matching
        mat std_diff_a[`r',3]=r(mean)
        mat std_diff_a[`r',4]=r(sd)

        mat sdemo[`r',6]=(std_diff_a[`r',1]-std_diff_a[`r',3])/sqrt((std_diff_a[`r',2]^2+std_diff_a[`r',4]^2)/2)
   	local r = `r'+1
}

local r = 31
foreach v in `sdemovar2' {
	sum `v' if rhs3d==1 [iweight=weight_3] //get mean,variance treated after matching
	mat std_diff_a[`r',1]=r(mean)

	sum `v' if rhs3d==0 [iweight=weight_3] //get mean,variance contl after matching
	mat std_diff_a[`r',3]=r(mean)

	mat sdemo[`r',6]=(std_diff_a[`r',1]-std_diff_a[`r',3])/sqrt((std_diff_a[`r',1]*(1-std_diff_a[`r',1])+std_diff_a[`r',3]*(1-std_diff_a[`r',3]))/2)

	local r = `r'+1
}

//just look at it to check means against the pstest output to make sure they are right
mat rownames std_diff_a= "S age" "" "Female" "White" "HS Degree" ///
"Medicaid" "SRH poor/fair" "Religion very imp" "Smoker" "Vigorous phys act" ///
"Comorb - none" "Mild" "Moderate" "Cancer" "Lung disease" "Heart disease" "CHF" "Stroke" ///
"Memory disease" "Hypertension" "Diabetes" "Psych problems" "p1 ivw 0-6m" ///
"p1 ivw 6-12m" "p1 ivw 12-18m" "p1 > 18m" "CESD raw n1" "CESD raw p1" "CESD change" ///
"Clin depr n1" "Clin depr p1" "CESD improved" "CESD same" "CESD declined"

mat list std_diff_a

mat rownames sdemo ="Sample size n" "Age at r's death, mean" "SD" "Female %" "Non-Hispanic White %" ///
"Education, High school grad %" "Medicaid %" "SRH poor or fair %" ///
"Religion very important %" "Currently smoker %" "Vigorous physical activity %" ///
"Comorbidity index - none" "Mild (1-3)" "Moderate (4-6)" ///
"Cancer %" "Lung disease %" "Heart disease %" "CHF %" "Stroke %" "Memory disease %" ///
"Hypertension %" "Diabetes %" "Psychological problems %" ///
"P1 interview 0-6m from death" "P1 interview 6-12m" "P1 interview 12-18m" "P1 interview 18m+" ///
"CES-D raw score pre-death, mean" "CES-D raw score post-death, mean" "Change in raw CES-D" ///
"Clinical depression pre-death %" "Clinical depression post-death %" ///
 "CES-D Improved post death %" "Same CES-D post death %" "CES-D Declined post death %"

mat list sdemo

frmttable using `logpath'\spo_Table2_spouse_char, statmat(sdemo) ///
title("Spouse descriptive characteristics,  3+ hospice days") ///
ctitle("","Unmatched Sample","","","Matched Sample","","" \ "", "Hospice users","Non-hospice users","Std. Diff.", ///
  "Hospice users" ,"Non-hospice users" ,"Std. Diff.") ///
  sdec(2,2,4,2,2,4) replace

***********************************************************************
//Table of overall sample characteristics, not matched
***********************************************************************
local varlist1 r_female r_white_e r_hseduc_n1_n3 

local varlist2 s_female s_white_e s_hseduc_n1_n3 s_adl_independent_core_n1

mat quicktab=J(13,5,.)

sum r_age //mean R age
mat quicktab[1,1]=r(mean)
local sample = r(N)

local j=2
foreach v in `varlist1'{
sum `v'
mat quicktab[`j',1]=r(mean)*100
local j=`j'+1 //rows 2-4
}

sum s_age //mean S age
mat quicktab[5,1]=r(mean)

local j=6
foreach v in `varlist2'{
sum `v'
mat quicktab[`j',1]=r(mean)*100
local j=`j'+1 //rows 6-9
}

local i=10
sum hs_los_12m if rhs3d==1, detail
mat quicktab[`i',1]=r(mean)
mat quicktab[`i',2]=r(sd)
mat quicktab[`i',3]=r(p50)
mat quicktab[`i',4]=r(min)
mat quicktab[`i',5]=r(max)

gen mo_p1_core_dead =days_p1_core_dead/30.5
gen mo_s_n1_core_dead = s_days_n1_core_dead/30.5

sum mo_p1_core_dead
mat quicktab[`i'+1,1]=r(mean)

sum mo_s_n1_core_dead 
mat quicktab[`i'+2,1]=r(mean)

gen mo_s_p1_n1 = (days_p1_core_dead+ s_days_n1_core_dead)/30.5
sum mo_s_p1_n1 , detail
mat quicktab[`i'+3,1]=r(mean)
mat quicktab[`i'+3,2]=r(sd)
mat quicktab[`i'+3,3]=r(p50)
mat quicktab[`i'+3,4]=r(min)
mat quicktab[`i'+3,5]=r(max)

mat list quicktab

mat rownames quicktab="R Age" "R Female" "R White" "R HS Degree" ///
"S Age" "S Female" "S White" "S HS Degree" "S ADL independent n1" ///
"Days hospice use" "S n1 ivw months before death" ///
"S p1 ivw months after death" ///
"S n1 to p1 interview, months"

frmttable using `logpath'\spo_overall_sample_char, statmat(quicktab) ///
title("Overall sample descriptive characteristics, n=`sample'") ///
ctitle("","Mean or Percent" "SD" "Median" "Min" "Max") ///
sdec(3,2,0,0,0) replace

//for matched sample, do overall cesd scores improve??
mat quicktab2=J(3,2,.)

local i = 1
foreach v in s_cesd_tot_n1 s_cesd_tot_p1{
	sum `v' [iweight=weight_3]
	mat quicktab2[`i',1]=r(mean)
	mat quicktab2[`i',2]=r(sd)
	local i = `i'+1
}

sum s_cesdbetter [iweight=weight_3]
mat quicktab2[`i',1]=r(mean)
local sample = r(N)

mat rownames quicktab2="Raw CES-D pre-death" "Raw CES-D post-death" "CES-D Improved?"

frmttable using `logpath'\spo_overall_sample_char, statmat(quicktab2) ///
title("Matched sample CES-D, n=`sample'") ///
ctitle("","Mean or Percent" "SD" ) ///
sdec(3,2,0) addtable

mat list quicktab2

***********************************************************************
log close


H="Revised Tables 1 & 2"
/* *******Run with new sample definition, allows for p1 interview *****
******* within 90 days of R's death                    *************

Creates Paper Tables 1 and 2 as well as tables of overall sample characteristics

Hospice users definition: 3+ days / non users: 0-2 days

See format changes in tables from KO received on 9/18/14

Revised 4/20/15 to include n's in table 1 & 2 per JAMA IM editorial comments*/

capture log close

clear all
set mem 500m
set more off
set scheme s1color

//Amy's PC
local logpath E:\data\spouse\logs\august2014
local datapath E:\data\spouse\final_data

log using "`logpath'\5b-new_Spouse_char_tables_august2014.txt", text replace

cd `datapath'

use spouse_data_sample_v3_august2014.dta

*******************************************************
tab rhs3d , missing

gen non_hosp3=1 if rhs3d==0
replace non_hosp3=0 if rhs3d==1
tab non_hosp3 rhs3d, missing

*************************************************************************************
*************************************************************************************
//create Table 1, overall sample characteristics, prior to matching
*************************************************************************************
*************************************************************************************

//Part 1 - Decedent char

gen r_adl_improv_stab_i_n1n2 = 0
replace r_adl_improv_stab_i_n1n2  = 1 if r_adl_stable_ind_n1n2==1 | r_adl_improved_n1n2==1 
tab r_adl_improv_stab_i_n1n2 , missing

local rvars r_female r_white_e r_hseduc_n1_n3 r_nw_lowest_n1 ///
r_nw_midlow_n1 r_nw_midhigh_n1 r_nw_highest_n1 r_medicaid_n1 r_champus_n1 r_medigap_n1 ///
r_nhres_n1 r_advdir_y ///
r_discuss_x  r_adl_independent_core_n1 r_adl_improv_stab_i_n1n2 ///
r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 r_adl_change_i_m_n1n2 ///
r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_srh_pf_n1 cc_3_alzhdmta_n12mn0 ///
cc_6_chrnkidn_n12mn0 cc_ami_isch_n12mn0 cc_8_chf_n12mn0 ///
cc_9_diabetes_n12mn0 cc_7_copd_n12mn0 cc_16_strketia_n12mn0 ///
cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 cc_11_hipfrac_n12mn0 ///
cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 cc_15_ra_oa_n12mn0 

la var r_age "Age at death, years, mean (SD)"
la var r_female "Female"
la var r_white_e "Race, Non-Hispanic, White"
la var r_hseduc_n1_n3 "Education, High School Grad"
la var r_nw_lowest_n1 "Net Worth, 1 (low) Quartile"
la var r_nw_midlow_n1  "Net Worth, 2 Quartile"
la var r_nw_midhigh_n1  "Net Worth, 3 Quartile"
la var r_nw_highest_n1  "Net Worth, 4 (high) Quartile"
la var r_medicaid_n1  "Medicaid"
la var r_champus_n1  "VA Insurance"
la var r_medigap_n1 "Medigap"
la var r_nhres_n1 "Nursing home resident pre-death"
la var r_advdir_y "Had advanced directive**"
la var r_discuss_x "Discussion of EOL care"

la var r_adl_independent_core_n1 "ADL Independent pre-death"
la var r_adl_improv_stab_i_n1n2 "Impr or Indep in ADLs n2 to n1"
la var r_adl_stable_partial_n1n2 "Stable Moderate 1-3 ADL" 
la var r_adl_stable_severe_n1n2 "Stable Severe 4-6 ADL" 
la var r_adl_change_i_m_n1n2 "Declined, Indep to Moderate"
la var r_adl_change_m_s_n1n2 "Declined Moderate to Severe" 
la var r_adl_change_i_s_n1n2 "Declined Independent to Severe n2-n1" 
la var r_srh_pf_n1 "SRH poor or fair"
la var cc_all_count_12m_2 "Number of chronic conditions, mean (SD)"

mat rchar_1=J(1,2,.)

sum r_age, detail //age
mat rchar_1[1,1]=r(mean)
mat rchar_1[1,2]=r(sd)
local samplen=r(N)

mat rownames rchar_1=r_age

//save the table in frmttable	
mat dmat=(0,1)
mat ann=J(1,1,1)

frmttable, statmat(rchar_1) varlabels ///
	sdec(2) doubles(dmat) ///
	dbldiv(" (") annotate(ann) asymbol(")") ///
	store(tab1_1) 	


mat rchar_2=J(34,2,.)
local r = 1
foreach v in `rvars'{
	sum `v'
	mat rchar_2[`r',1]=r(mean)*r(N) //n
	mat rchar_2[`r',2]=r(mean)*100 //percent
	local r = `r'+1
	}

mat rownames rchar_2 = `rvars'

mat dmat=(0,1)
mat ann=J(34,1,1)

frmttable, statmat(rchar_2) varlabels ///
	sdec(1) doubles(dmat) ///
	dbldiv(" (") annotate(ann) asymbol(")") ///
	store(tab1_2) 	  

mat rchar_3=J(1,2,.)

sum cc_all_count_12m_2, detail //cc's count
mat rchar_3[1,1]=r(mean)
mat rchar_3[1,2]=r(sd)

mat rownames rchar_3=cc_all_count_12m_2

//save the table in frmttable	
mat dmat=(0,1)
mat ann=J(1,1,1)

frmttable, statmat(rchar_3) varlabels ///
	sdec(2) doubles(dmat) ///
	dbldiv(" (") annotate(ann) asymbol(")") ///
	store(tab1_3) 	  

outreg, replay(tab1_1) append(tab1_2) store(tab1_a)

*** add the headings, notes, using file name etc. to this one
outreg using "`logpath'\spo_tab1and2_aug2014", ///
replay(tab1_a) append(tab1_3) ///
title("Table 1: Characteristics of Study sample (n=`samplen')") ///
ctitles("Decedent","") ///
note("Decedent chronic conditions from Medicare claims. Spouse chronic \ " ///
"conditions from self report in HRS interviews." ///
"N (%) reported for binary variables.") ///
landscape replace

//Part 2 - Spouse char

//just check no severe category
tab s_hrs_comorb_mod_n1 s_comor_c_hrs_n1, missing

local svars s_female s_white_e  s_hseduc_n1_n3 ///
s_medicaid_n1 s_imprelig_vimp_n1 ///
s_adl_independent_core_n1 s_srh_pf_n1  ///
s_cancer_hrs_n1 s_lung_hrs_n1 s_heart_hrs_n1 s_chf_hrs_n1 ///
s_stroke_hrs_n1 s_memory_hrs_n1 s_htn_hrs_n1 s_dm_hrs_n1 ///
s_hrs_comorb_none_n1 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 ///
s_psych_overall_hrs_n1 s_smoke_curr_n1 s_vig_phy_act_n1

la var s_age "Age at spouse's death, years, mean (SD)"
la var s_female "Female"
la var s_white_e "Race, Non-Hispanic, White"
la var s_hseduc_n1_n3 "Education, High School Grad"
la var s_medicaid_n1  "Medicaid"
la var s_adl_independent_core_n1 "ADL Independent pre-death"
la var s_srh_pf_n1 "SRH poor or fair"
la var s_imprelig_vimp_n1 "Religion very important"
la var s_cancer_hrs_n1 "Cancer"
la var s_lung_hrs_n1 "Lung disease"
la var s_heart_hrs_n1 "Heart disease"
la var s_chf_hrs_n1 "CHF"
la var s_stroke_hrs_n1 "Stroke"
la var s_memory_hrs_n1 "Memory disease"
la var s_htn_hrs_n1 "Hypertension"
la var s_dm_hrs_n1 "Diabetes"
la var s_hrs_comorb_none_n1 "Comorbidities, none"
la var s_hrs_comorb_mild_n1 "Mild (1-3)"
la var s_hrs_comorb_mod_n1 "Moderate (4-6)"
la var s_psych_overall_hrs_n1 "Psychological problems"
la var s_smoke_curr_n1 "Currently smoker"
la var s_vig_phy_act_n1 "Vigorous physical activity"
la var s_cesd_tot_n1 "CESD score pre-death, mean(SD)"
la var s_cesd_tot_p1 "CESD score post-death, mean(SD)"

mat schar_1=J(1,2,.)

sum s_age, detail //age
mat schar_1[1,1]=r(mean)
mat schar_1[1,2]=r(sd)

mat rownames schar_1=s_age

//save the table in frmttable	
mat dmat=(0,1)
mat ann=J(1,1,1)

frmttable, statmat(schar_1) varlabels ///
	sdec(2) doubles(dmat) ///
	dbldiv(" (") annotate(ann) asymbol(")") ///
	store(tab1_1) 	

mat schar_2=J(21,2,.)
local r = 1
foreach v in `svars'{
	sum `v'
	mat schar_2[`r',1]=r(mean)*r(N) //n
	mat schar_2[`r',2]=r(mean)*100 //percent
	local r = `r'+1
	}

mat rownames schar_2 = `svars'

mat dmat=(0,1)
mat ann=J(21,1,1)

frmttable, statmat(schar_2) varlabels ///
	sdec(1) doubles(dmat) ///
	dbldiv(" (") annotate(ann) asymbol(")") ///
	store(tab1_2) 	  

mat schar_3=J(2,2,.)

local r = 1
foreach v in s_cesd_tot_n1 s_cesd_tot_p1 {
	sum `v', detail //cc's count
	mat schar_3[`r',1]=r(mean)
	mat schar_3[`r',2]=r(sd)
	local r = `r'+1
	}

mat rownames schar_3=s_cesd_tot_n1 s_cesd_tot_p1

//save the table in frmttable	
mat dmat=(0,1)
mat ann=J(2,1,1)

frmttable, statmat(schar_3) varlabels ///
	sdec(2) doubles(dmat) ///
	dbldiv(" (") annotate(ann) asymbol(")") ///
	store(tab1_3) 	  

outreg, replay(tab1_1) append(tab1_2) store(tab1_a)

*** add the headings, notes, using file name etc. to this one
outreg using "`logpath'\spo_tab1and2_aug2014", ///
replay(tab1_a) append(tab1_3) ///
title("Table 1: Characteristics of Study sample (n=`samplen')") ///
ctitles("Spouse","") ///
note("Decedent chronic conditions from Medicare claims. Spouse chronic \ " ///
"conditions from self report in HRS interviews." ///
"N (%) reported for binary variables.") ///
landscape addtable

 
*************************************************************************************
*************************************************************************************
//Create Table 2, Decedent and Spouse PS Score Matching Variables
//Col 1-3: Unweighted, unmatched sample
//Col 4-6: Weighted and matched sample
*************************************************************************************
*************************************************************************************

local t2vars1 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 r_nw_highest_n1 ///
r_medicaid_n1 r_champus_n1 r_medigap_n1 r_nhres_n1 r_advdir_y r_advdir_n ///
r_discuss_x r_srh_pf_n1 ///
r_adl_improv_stab_i_n1n2 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 ///
cc_3_alzhdmta_n12mn0 ///
cc_6_chrnkidn_n12mn0 cc_ami_isch_n12mn0 cc_8_chf_n12mn0 ///
cc_9_diabetes_n12mn0 cc_7_copd_n12mn0 cc_16_strketia_n12mn0 ///
cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 cc_11_hipfrac_n12mn0 ///
cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 cc_15_ra_oa_n12mn0

local t2vars2 cc_all_count_12m_2 s_age 

local t2vars3 s_female s_white_e  s_hseduc_n1_n3 ///
s_srh_pf_n1 s_imprelig_vimp_n1 s_hrs_comorb_none_n1 ///
s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1	

la var r_advdir_n "Did not have advance directive, %**"

//part 1, n unmatched
mat t2_1=J(1,3,.)
tab rhs3d , missing matcell(d1)
mat t2_1[1,1]=d1[2,1] //non-hospice n
mat t2_1[1,2]=d1[1,1] //hospice users n
mat rownames t2_1="Sample n"

frmttable, statmat(t2_1) varlabels ///
	sdec(0) store(tab2_1) 	

//part 2, decedent char, % and std difference
mat t2_2=J(31,5,.)

local r = 1
foreach v in `t2vars1'{
	local c = 1
	foreach h in rhs3d non_hosp3 {
		sum `v' if `h'==1, detail
		mat t2_2[`r',`c']=r(mean)*r(N) //n
		mat t2_2[`r',`c'+1]=r(mean)*100 //percent
		local c = `c'+2		
	}
	mat t2_2[`r',5]=(t2_2[`r',2]/100-t2_2[`r',4]/100)/sqrt((t2_2[`r',2]/100* ///
		(1-t2_2[`r',2]/100)+t2_2[`r',4]/100*(1-t2_2[`r',4]/100))/2)
	local r = `r'+1
}
mat rownames t2_2=`t2vars1'

mat dmat=(0,1,0,1,0)
mat ann=J(31,2,1)

frmttable, statmat(t2_2) varlabels ///
	sdec(1,1,2) doubles(dmat) ///
	dbldiv(" (") annotate(ann) asymbol(")") ///
	store(tab2_2) 	

//part 3, cont vars r & s, mean and std diff
mat t2_3=J(2,5,.)

local r = 1
foreach v in `t2vars2'{
	local c = 1
	foreach h in rhs3d non_hosp3 {
		sum `v' if `h'==1, detail
		mat t2_3[`r',`c']=r(mean)
		mat t2_3[`r',`c'+1]=r(sd)
		local c = `c'+2		
	}
	mat t2_3[`r',5]=(t2_3[`r',1]-t2_3[`r',3])/sqrt((t2_3[`r',2]^2+t2_3[`r',4]^2)/2) 
	local r = `r'+1
}

mat rownames t2_3=`t2vars2'

mat dmat=(0,1,0,1,0)
mat ann=(1,1,0\1,1,0)
mat list dmat
mat list ann

mat list t2_3

frmttable, statmat(t2_3) varlabels ///
	sdec(2) doubles(dmat) ///
	dbldiv(" (") annotate(ann) asymbol(")") ///
	store(tab2_3) 

//part 4, spouse char, %
mat t2_4=J(9,5,.)

local r = 1
foreach v in `t2vars3'{
	local c = 1
	foreach h in rhs3d non_hosp3 {
		sum `v' if `h'==1, detail
		mat t2_4[`r',`c']=r(mean)*r(N)
		mat t2_4[`r',`c'+1]=r(mean)*100
		local c = `c'+2		
	}
	mat t2_4[`r',5]=(t2_4[`r',2]/100-t2_4[`r',4]/100)/sqrt((t2_4[`r',2]/100* ///
		(1-t2_4[`r',2]/100)+t2_4[`r',4]/100*(1-t2_4[`r',4]/100))/2)

	local r = `r'+1
}
mat rownames t2_4=`t2vars3'

mat dmat=(0,1,0,1,0)
mat ann=J(9,2,1)

frmttable, statmat(t2_4) varlabels ///
	sdec(1,1,2) doubles(dmat) ///
	dbldiv(" (") annotate(ann) asymbol(")") ///
	store(tab2_4) 	

outreg, replay(tab2_1) append(tab2_2) store(tab2_a)
outreg, replay(tab2_a) append(tab2_3) store(tab2_b)
outreg, replay(tab2_b) append(tab2_4) store(tab2_c) //complete unmatched table w/ std diff

***************************************************************
//end of unmatched sample, start matched sample
***************************************************************
//part 1, n matched
mat t2_1m=J(1,3,.)
tab rhs3d if weight_3!=., missing matcell(d1)
mat t2_1m[1,1]=d1[2,1] //non-hospice n
mat t2_1m[1,2]=d1[1,1] //hospice users n
mat rownames t2_1m="Sample n"

frmttable, statmat(t2_1m) varlabels ///
	sdec(0) store(tab2_1m) 	

//part 2, decedent char, % and std difference
mat t2_2m=J(31,3,.)

local r = 1
foreach v in `t2vars1'{
	local c = 1
	foreach h in rhs3d non_hosp3 {
		sum `v' if `h'==1 [iweight=weight_3]
		mat t2_2m[`r',`c']=r(mean)*100
		local c = `c'+1		
	}
	mat t2_2m[`r',3]=(t2_2m[`r',1]/100-t2_2m[`r',2]/100)/sqrt((t2_2m[`r',1]/100* ///
		(1-t2_2m[`r',1]/100)+t2_2m[`r',2]/100*(1-t2_2m[`r',2]/100))/2)
	local r = `r'+1
}
mat rownames t2_2m=`t2vars1'
frmttable, statmat(t2_2m) varlabels ///
	sdec(2) store(tab2_2m) 	

//part 3, cont vars r & s, mean and std diff
mat t2_3m=J(2,5,.)

local r = 1
foreach v in `t2vars2'{
	local c = 1
	foreach h in rhs3d non_hosp3 {
		sum `v' if `h'==1 [iweight=weight_3]
		mat t2_3m[`r',`c']=r(mean)
		mat t2_3m[`r',`c'+1]=r(sd)
		local c = `c'+2		
	}
	mat t2_3m[`r',5]=(t2_3m[`r',1]-t2_3m[`r',3])/sqrt((t2_3m[`r',2]^2+t2_3m[`r',4]^2)/2) 
	local r = `r'+1
}

mat rownames t2_3m=`t2vars2'

mat dmat=(0,1,0,1,0)
mat ann=(1,1,0\1,1,0)
mat list dmat
mat list ann

mat list t2_3

frmttable, statmat(t2_3m) varlabels ///
	sdec(2) doubles(dmat) ///
	dbldiv(" (") annotate(ann) asymbol(")") ///
	store(tab2_3m) 

//part 4, spouse char, %
mat t2_4m=J(9,3,.)

local r = 1
foreach v in `t2vars3'{
	local c = 1
	foreach h in rhs3d non_hosp3 {
		sum `v' if `h'==1 [iweight=weight_3]
		mat t2_4m[`r',`c']=r(mean)*100
		local c = `c'+1		
	}
	mat t2_4m[`r',3]=(t2_4m[`r',1]/100-t2_4m[`r',2]/100)/sqrt((t2_4m[`r',1]/100* ///
		(1-t2_4m[`r',1]/100)+t2_4m[`r',2]/100*(1-t2_4m[`r',2]/100))/2)

	local r = `r'+1
}

mat rownames t2_4m=`t2vars3'
frmttable, statmat(t2_4m) varlabels ///
	sdec(2) store(tab2_4m) 	

outreg, replay(tab2_1m) append(tab2_2m) store(tab2_am)
outreg, replay(tab2_am) append(tab2_3m) store(tab2_bm)
outreg, replay(tab2_bm) append(tab2_4m) store(tab2_cm) //complete matched table w/ std diff

//combine unmatched and match tables
outreg using "`logpath'\spo_tab1and2_aug2014", ///
 replay(tab2_c) merge(tab2_cm) ///
 title("Table 2: Decedent and spouse characteristics used in propensity score matching, by hospice use status") ///
 ctitles("","Unmatched sample","","","Matched sample","","" \ ///
    "","Hospice users","No hospice use","Standardized Difference(%)", ///
    "Hospice users","No hospice use","Standardized Difference(%)") ///
 note("** Not all categories add up to 100% due to rounding and missing data.") ///
 landscape addtable

***********************************************************************
//Comparing decedent age, race between hospice users /non-users, not matched
***********************************************************************

//part 1, n unmatched
mat t3_1=J(1,3,.)
tab rhs3d , missing matcell(d1)
mat t3_1[1,1]=d1[2,1] //non-hospice n
mat t3_1[1,2]=d1[1,1] //hospice users n
mat rownames t3_1="Sample n"

frmttable, statmat(t3_1) varlabels ///
	sdec(0) store(tab3_1) 	

//part 2, age - continuous
mat t3_2=J(1,5,.)
local c=1
	foreach h in rhs3d non_hosp3 {
		sum r_age if `h'==1, detail
		mat t3_2[1,`c']=r(mean)
		mat t3_2[1,`c'+1]=r(sd)
		local c = `c'+2		
	}
mat t3_2[1,5]=(t3_2[1,1]-t3_2[1,3])/sqrt((t3_2[1,2]^2+t3_2[1,4]^2)/2) 

mat rownames t3_2=r_age

mat dmat=(0,1,0,1,0)
mat ann=(1,1,0\1,1,0)
mat list dmat
mat list ann

mat list t3_2

frmttable, statmat(t3_2) varlabels ///
	sdec(2) doubles(dmat) ///
	dbldiv(" (") annotate(ann) asymbol(")") ///
	store(tab3_2) 

//part 3, race - indicator
mat t3_3=J(1,3,.)
local c = 1
foreach h in rhs3d non_hosp3 {
	sum r_white_e if `h'==1, detail
	mat t3_3[1,`c']=r(mean)*100
	local c = `c'+1		
}
mat t3_3[1,3]=(t3_3[1,1]/100-t3_3[1,2]/100)/sqrt((t3_3[1,1]/100* ///
	(1-t3_3[1,1]/100)+t3_3[1,2]/100*(1-t3_3[1,2]/100))/2)
mat rownames t3_3=r_white_e

frmttable, statmat(t3_3) varlabels ///
	sdec(2) store(tab3_3) 

outreg, replay(tab3_1) append(tab3_2) store(tab3_a)

outreg  using "`logpath'\spo_tab1and2_aug2014", ///
 replay(tab3_a) append(tab3_3) ///
 title("Additional R char, hospice vs no hospice, unmatched") ///
 ctitles("","Hospice users","No hospice use","Standardized Difference(%)") ///
 addtable

***********************************************************************
//Table of overall sample characteristics, not matched
***********************************************************************
local varlist1 r_female r_white_e r_hseduc_n1_n3 

local varlist2 s_female s_white_e s_hseduc_n1_n3 s_adl_independent_core_n1

mat quicktab=J(13,5,.)

sum r_age //mean R age
mat quicktab[1,1]=r(mean)
local sample = r(N)

local j=2
foreach v in `varlist1'{
sum `v'
mat quicktab[`j',1]=r(mean)*100
local j=`j'+1 //rows 2-4
}

sum s_age //mean S age
mat quicktab[5,1]=r(mean)

local j=6
foreach v in `varlist2'{
sum `v'
mat quicktab[`j',1]=r(mean)*100
local j=`j'+1 //rows 6-9
}

local i=10
sum hs_los_12m if rhs3d==1, detail
mat quicktab[`i',1]=r(mean)
mat quicktab[`i',2]=r(sd)
mat quicktab[`i',3]=r(p50)
mat quicktab[`i',4]=r(min)
mat quicktab[`i',5]=r(max)

gen mo_p1_core_dead =days_p1_core_dead/30.5
gen mo_s_n1_core_dead = s_days_n1_core_dead/30.5

sum mo_p1_core_dead
mat quicktab[`i'+1,1]=r(mean)

sum mo_s_n1_core_dead 
mat quicktab[`i'+2,1]=r(mean)

gen mo_s_p1_n1 = (days_p1_core_dead+ s_days_n1_core_dead)/30.5
sum mo_s_p1_n1 , detail
mat quicktab[`i'+3,1]=r(mean)
mat quicktab[`i'+3,2]=r(sd)
mat quicktab[`i'+3,3]=r(p50)
mat quicktab[`i'+3,4]=r(min)
mat quicktab[`i'+3,5]=r(max)

mat list quicktab

mat rownames quicktab="R Age" "R Female" "R White" "R HS Degree" ///
"S Age" "S Female" "S White" "S HS Degree" "S ADL independent n1" ///
"Days hospice use" "S n1 ivw months before death" ///
"S p1 ivw months after death" ///
"S n1 to p1 interview, months"

frmttable using `logpath'\spo_tab1and2_aug2014, statmat(quicktab) ///
title("Overall sample descriptive characteristics, n=`sample'") ///
ctitle("","Mean or Percent" "SD" "Median" "Min" "Max") ///
sdec(3,2,0,0,0) addtable

//for matched sample, do overall cesd scores improve??
mat quicktab2=J(3,2,.)

local i = 1
foreach v in s_cesd_tot_n1 s_cesd_tot_p1{
	sum `v' [iweight=weight_3]
	mat quicktab2[`i',1]=r(mean)
	mat quicktab2[`i',2]=r(sd)
	local i = `i'+1
}

sum s_cesdbetter [iweight=weight_3]
mat quicktab2[`i',1]=r(mean)
local sample = r(N)

mat rownames quicktab2="Raw CES-D pre-death" "Raw CES-D post-death" "CES-D Improved?"

frmttable using `logpath'\spo_tab1and2_aug2014, statmat(quicktab2) ///
title("Matched sample CES-D, n=`sample'") ///
ctitle("","Mean or Percent" "SD" ) ///
sdec(3,2,0) addtable

mat list quicktab2
***********************************************************************
//test of cesd improved hospice vs non hospice in the matched sample

mat quicktab3=J(2,3,.)
tab rhs3d if weight_3!=., matcell(r1)
mat quicktab3[1,2]=r1[1,1]
mat quicktab3[1,1]=r1[2,1]

sum s_cesdbetter if rhs3d==1 [iweight=weight_3]
mat quicktab3[2,1]=r(mean)*100
sum s_cesdbetter if rhs3d==0 [iweight=weight_3]
mat quicktab3[2,2]=r(mean)*100

logit rhs3d s_cesdbetter [iweight=weight_3]
test s_cesdbetter 
mat quicktab3[2,3]=r(p) //p value from chisq test

frmttable using `logpath'\spo_tab1and2_aug2014, statmat(quicktab3) ///
title("Matched sample CES-D Improvement, n=`sample'") ///
ctitle("","Hospice, %", "No hospice, %" "P-value" ) ///
rtitle("n"\"CES-D Improved") sdec(2) addtable

***********************************************************************
log close


H="Caregivers"
/*
Runs the models for the helper subsample only

Outcome variables are: CESD improvement indicator, ie any improvement 
in CESD score from n1 to p1
And CESD clinical improvement 3+ to <3 n1 to p1

This Stata code runs following analyses:
1. Determines propensity scores
2. Runs summary tables for r and s characteristics using px weighting
3. Px matched logit regression on reduced spouse depressive symptoms 

Runs 3 versions
1. Hospice users: 1+ days / non users: 0 days
2. Hospice users: 3+ days / non users: 0-2 days
3. Hospice users: 7+ days / non users: 0-6 days*/

capture log close

clear all
set mem 500m
set more off
set scheme s1color

//Amy's PC
local logpath E:\data\spouse\logs\august2014\helper
local datapath E:\data\spouse\final_data

//RG PC
//local logpath C:\data\Spouse\logs
//local datapath C:\data\Spouse

log using "`logpath'\6-HRS_Spouse_analysis_helper_aug2014.txt", text replace

cd `datapath'

use spouse_data_sample_v3.dta if (r_adl_sp_helper_x==1 | r_iadl_sp_helper_x==1) 
  
*****************************************************************************
*****************************************************************************
//Set up variables and dataset
*****************************************************************************
*****************************************************************************

//first sort data randomly
set seed 2000
gen x=uniform()
sort x

*****************************************************************************
*****************************************************************************
//Using Stata's pscore to generate px scores - 1 day definition
*****************************************************************************
*****************************************************************************

//generate pscore variable hs_pscore
pscore rhs12m $matchvars, pscore(hs_pscore) blockid(hs_block) logit detail

//graph without dropping any observations in the matching process
psgraph, treated(rhs12m) pscore(hs_pscore)
graph save `logpath'/psgraph_1 ,replace

//implement radius matching
gen logitpscore=ln(hs_pscore/(1-hs_pscore))
sum logitpscore

sca cal_ps1=r(sd)*0.02
sca list cal_ps1

//try 0.02* sd
psmatch2  rhs12m,outcome(s_cesdbetter) pscore(hs_pscore) radius caliper(.01628742) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(rhs12m) pscore(hs_pscore)
graph save `logpath'/psgraph_2 ,replace

histogram hs_pscore if _support==1, by(rhs12m) 

//look at balance of matched vs unmatched samples
pstest $matchvars ,treated(rhs12m) both hist
graph save `logpath'/psmatch_1 ,replace

//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age{
gen `v'_treated = `v' if rhs12m==1 & _support==1
gen `v'_comparison = `v' if rhs12m==0 & _support==1
qqplot `v'_treated `v'_comparison
graph save `logpath'/qqplot_`v', replace
}

mat vr=J(40,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $matchvars  {
sum `v' if rhs12m==1 //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if rhs12m==0 //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if rhs12m==1 & _support==1 //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if rhs12m==0 [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}

mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1"

mat list vr

//look at standardized differences to assess balance
//continuous variables
mat std_diff=J(40,5,.)
local i=1
foreach v in cc_all_count_12m_2 s_age {
sum `v' if rhs12m==1 & _support==1 //get mean,variance treated after matching
mat std_diff[`i',1]=r(mean)
mat std_diff[`i',2]=r(sd)

sum `v' if rhs12m==0 [iweight=_weight] //get mean,variance contl after matching
mat std_diff[`i',3]=r(mean)
mat std_diff[`i',4]=r(sd)

mat std_diff[`i',5]=(std_diff[`i',1]-std_diff[`i',3])/sqrt((std_diff[`i',2]^2+std_diff[`i',4]^2)/2) 
	
local i = `i'+1	
}
//indicator variables
local indvars cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y r_advdir_miss r_discuss_x r_srh_pf_n1 ///
 s_female s_white_e  s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1 

foreach v in `indvars' {
sum `v' if rhs12m==1 & _support==1 //get mean treated after matching
mat std_diff[`i',1]=r(mean)

sum `v' if rhs12m==0 [iweight=_weight] //get mean contl after matching
mat std_diff[`i',3]=r(mean)

mat std_diff[`i',5]=(std_diff[`i',1]-std_diff[`i',3])/sqrt((std_diff[`i',1]*(1-std_diff[`i',1])+std_diff[`i',3]*(1-std_diff[`i',3]))/2)
	
local i = `i'+1	
}

mat rownames std_diff="Count of comorbidities" "S age" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
 "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1" 

mat list std_diff
//standardized difference should be less than 10-25%

//using this matching, 10 obs from the treatment group are dropped b/c they are off support
//3 are dropped b/c not matched (weight=.)
//_support ==1 if matched
tab _support, missing
tab _support if rhs12m==1, missing
tab _support if rhs12m==0, missing
tab _weight if rhs12m==1, missing
sum _weight if rhs12m==0

//rename ps variables and save dataset so can call them up later
rename _support support_1
rename _weight weight_1

//now run using weighting , outcome = improved CESD score p1
//need to include the variables used in the propensity score

local yearvars ib2000.r_death_year 
 
logit s_cesdbetter rhs12m `yearvars' $matchvars [iw=weight_1] , or 

outreg using `logpath'\spouse_analysis_aug2014, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score Decreased (by any amount) n1 to p1") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat( N) replace


tab s_cesdbetter s_cesd_ge3better, missing

//Run logit with outcome=depressed n1, not depressed p1
//Need alternative variable list excluding advanced directive missing status b/c
//it predicts the outcome (failure)
tab s_cesd_ge3better r_advdir_miss if weight_1!=., missing

local new_varlist cc_all_count_12m_2 cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y /*r_advdir_miss*/ r_discuss_x r_srh_pf_n1 ///
s_age s_female s_white_e  s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1 

logit s_cesd_ge3better rhs12m `yearvars' `new_varlist' [iw=weight_1] , or 

outreg using `logpath'\spouse_analysis_aug2014, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score 3+ n1 to less than 3 p1") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable

*****************************************************************************

*****************************************************************************

//End of 1 day definition , start 3 day definition section

*****************************************************************************

*****************************************************************************
	
	
*****************************************************************************
*****************************************************************************
//Using Stata's pscore to generate px scores - 3 day definition
*****************************************************************************
*****************************************************************************

//generate pscore variable hs_pscore
pscore rhs3d $matchvars, pscore(hs_pscore3) blockid(hs_block3) logit detail

//graph without dropping any observations in the matching process
psgraph, treated(rhs3d) pscore(hs_pscore3)
graph save `logpath'/psgraph_1_3 ,replace

//implement radius matching
gen logitpscore3=ln(hs_pscore3/(1-hs_pscore3))
sum logitpscore3

sca cal_ps3=r(sd)*0.02
sca list cal_ps3

//try 0.02* sd
psmatch2  rhs3d,outcome(s_cesdbetter) pscore(hs_pscore3) radius caliper(.01552033) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(rhs3d) pscore(hs_pscore3)
graph save `logpath'/psgraph_2_3 ,replace

histogram hs_pscore3 if _support==1, by(rhs3d) 

//look at balance of matched vs unmatched samples
pstest $matchvars ,treated(rhs3d) both hist
graph save `logpath'/psmatch_1_3 ,replace

//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age{
gen `v'_treated3 = `v' if rhs3d==1 & _support==1
gen `v'_comparison3 = `v' if rhs3d==0 & _support==1
qqplot `v'_treated3 `v'_comparison3
graph save `logpath'/qqplot_`v'_3, replace
}

mat vr=J(40,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $matchvars  {
sum `v' if rhs3d==1 //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if rhs3d==0 //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if rhs3d==1 & _support==1 //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if rhs3d==0 [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}

mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1"

mat list vr

//look at standardized differences to assess balance
//continuous variables
mat std_diff=J(40,5,.)
local i=1
foreach v in cc_all_count_12m_2 s_age {
sum `v' if rhs3d==1 & _support==1 //get mean,variance treated after matching
mat std_diff[`i',1]=r(mean)
mat std_diff[`i',2]=r(sd)

sum `v' if rhs3d==0 [iweight=_weight] //get mean,variance contl after matching
mat std_diff[`i',3]=r(mean)
mat std_diff[`i',4]=r(sd)

mat std_diff[`i',5]=(std_diff[`i',1]-std_diff[`i',3])/sqrt((std_diff[`i',2]^2+std_diff[`i',4]^2)/2) 
	
local i = `i'+1	
}
//indicator variables
local indvars cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y r_advdir_miss r_discuss_x r_srh_pf_n1 ///
 s_female s_white_e  s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1 

foreach v in `indvars' {
sum `v' if rhs3d==1 & _support==1 //get mean treated after matching
mat std_diff[`i',1]=r(mean)

sum `v' if rhs3d==0 [iweight=_weight] //get mean contl after matching
mat std_diff[`i',3]=r(mean)

mat std_diff[`i',5]=(std_diff[`i',1]-std_diff[`i',3])/sqrt((std_diff[`i',1]*(1-std_diff[`i',1])+std_diff[`i',3]*(1-std_diff[`i',3]))/2)
	
local i = `i'+1	
}

mat rownames std_diff="Count of comorbidities" "S age" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
 "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1" 

mat list std_diff
//standardized difference should be less than 10-25%


//using this matching, 7 obs from the treatment group are dropped b/c they are off support
//3 are dropped b/c not matched (weight=.)
//_support ==1 if matched
tab _support, missing
tab _support if rhs3d==1, missing
tab _support if rhs3d==0, missing
tab _weight if rhs3d==1, missing
sum _weight if rhs3d==0

//rename ps variables and save dataset so can call them up later
rename _support support_3
rename _weight weight_3

//now run using weighting , outcome = improved CESD score p1
//need to include the variables used in the propensity score
//we probably can't keep both spouse and r gender variables in
 
logit s_cesdbetter rhs3d `yearvars' $matchvars [iw=weight_3] , or 

outreg using `logpath'\spouse_analysis_aug2014, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score Decreased (by any amount) n1 to p1" \ ///
	"3+ days of hospice use = treatment, 0-2 days = control") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable


tab s_cesdbetter s_cesd_ge3better, missing

//Run logit with outcome=depressed n1, not depressed p1
logit s_cesd_ge3better rhs3d `yearvars' `new_varlist' [iw=weight_3] , or 

outreg using `logpath'\spouse_analysis_aug2014, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score 3+ n1 to less than 3 p1" \ ///
	"3+ days of hospice use = treatment, 0-2 days = control")  ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable

*****************************************************************************

*****************************************************************************

//End of 3 day definition , start 7 day definition section

*****************************************************************************

*****************************************************************************
	
	
*****************************************************************************
*****************************************************************************
//Using Stata's pscore to generate px scores - 7 day definition
*****************************************************************************
*****************************************************************************

//generate pscore variable hs_pscore
pscore rhs7d $matchvars, pscore(hs_pscore7) blockid(hs_block7) logit detail

//graph without dropping any observations in the matching process
psgraph, treated(rhs7d) pscore(hs_pscore7)
graph save `logpath'/psgraph_1_7 ,replace

//implement radius matching
gen logitpscore7=ln(hs_pscore7/(1-hs_pscore7))
sum logitpscore7

sca cal_ps7=r(sd)*0.02
sca list cal_ps7

//try 0.02* sd
psmatch2  rhs7d,outcome(s_cesdbetter) pscore(hs_pscore7) radius caliper(.01548533) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(rhs7d) pscore(hs_pscore7)
graph save `logpath'/psgraph_2_7 ,replace

histogram hs_pscore7 if _support==1, by(rhs7d) 

//look at balance of matched vs unmatched samples
pstest $matchvars ,treated(rhs7d) both hist
graph save `logpath'/psmatch_1_7 ,replace

//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age{
gen `v'_treated7 = `v' if rhs7d==1 & _support==1
gen `v'_comparison7 = `v' if rhs7d==0 & _support==1
qqplot `v'_treated7 `v'_comparison7
graph save `logpath'/qqplot_`v'_7, replace
}

mat vr=J(40,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $matchvars  {
sum `v' if rhs7d==1 //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if rhs7d==0 //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if rhs7d==1 & _support==1 //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if rhs7d==0 [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}

mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1"

mat list vr

//look at standardized differences to assess balance
//continuous variables
mat std_diff=J(40,5,.)
local i=1
foreach v in cc_all_count_12m_2 s_age {
sum `v' if rhs7d==1 & _support==1 //get mean,variance treated after matching
mat std_diff[`i',1]=r(mean)
mat std_diff[`i',2]=r(sd)

sum `v' if rhs7d==0 [iweight=_weight] //get mean,variance contl after matching
mat std_diff[`i',3]=r(mean)
mat std_diff[`i',4]=r(sd)

mat std_diff[`i',5]=(std_diff[`i',1]-std_diff[`i',3])/sqrt((std_diff[`i',2]^2+std_diff[`i',4]^2)/2) 
	
local i = `i'+1	
}
//indicator variables
local indvars cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y r_advdir_miss r_discuss_x r_srh_pf_n1 ///
 s_female s_white_e  s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1 

foreach v in `indvars' {
sum `v' if rhs7d==1 & _support==1 //get mean treated after matching
mat std_diff[`i',1]=r(mean)

sum `v' if rhs7d==0 [iweight=_weight] //get mean contl after matching
mat std_diff[`i',3]=r(mean)

mat std_diff[`i',5]=(std_diff[`i',1]-std_diff[`i',3])/sqrt((std_diff[`i',1]*(1-std_diff[`i',1])+std_diff[`i',3]*(1-std_diff[`i',3]))/2)
	
local i = `i'+1	
}

mat rownames std_diff="Count of comorbidities" "S age" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
 "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1" 

mat list std_diff
//standardized difference should be less than 10-25%


//using this matching, 14 obs from the treatment group are dropped b/c they are off support
//3 are dropped b/c not matched (weight=.)
//_support ==1 if matched
tab _support, missing
tab _support if rhs7d==1, missing
tab _support if rhs7d==0, missing
tab _weight if rhs7d==1, missing
sum _weight if rhs7d==0

//rename ps variables and save dataset so can call them up later
rename _support support_7
rename _weight weight_7

//now run using weighting , outcome = improved CESD score p1
//need to include the variables used in the propensity score
 
logit s_cesdbetter rhs7d `yearvars' $matchvars [iw=weight_7] , or 

outreg using `logpath'\spouse_analysis_aug2014, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score Decreased (by any amount) n1 to p1" \ ///
	"7+ days of hospice use = treatment, 0-6 days = control") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable


tab s_cesdbetter s_cesd_ge3better, missing

//Run logit with outcome=depressed n1, not depressed p1
logit s_cesd_ge3better rhs7d `yearvars' `new_varlist' [iw=weight_7] , or 

outreg using `logpath'\spouse_analysis_aug2014, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score 3+ n1 to less than 3 p1" \ ///
	"7+ days of hospice use = treatment, 0-6 days = control")  ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable
****************************************************************
	
****************************************************************
//run each dr regression in a row to get a single table with all of the results
****************************************************************

****************************************************************

//1+day definition, any cesd improvement
qui logit s_cesdbetter rhs12m `yearvars' $matchvars [iw=weight_1] , or 
outreg , store(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs12m) ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = S Depressive symptom improvement n1 to p1") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	rtitles("Any improvement 1+day" ) ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat(N)

//1+day definition, clinical cesd improvement
qui logit s_cesd_ge3better rhs12m `yearvars' `new_varlist' [iw=weight_1] , or 
outreg , append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs12m) ///
	rtitles("Clinical improvement 1+day") ///
	varlabels starlevels(10 5 1)  summstat(N) 
	
//3+day definition, any cesd improvement
qui logit s_cesdbetter rhs3d `yearvars' $matchvars [iw=weight_3] , or 
outreg , append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs3d) ///
	rtitles("Any improvement 3+days" ) ///
	varlabels starlevels(10 5 1)  summstat(N) 
	
//3+day definition, clinical cesd improvement
qui logit s_cesd_ge3better rhs3d `yearvars' `new_varlist' [iw=weight_3] , or 
outreg , append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs3d) ///
	rtitles("Clinical improvement 3+days" ) ///
	varlabels starlevels(10 5 1)  summstat(N) 

//7+day definition, any cesd improvement
qui logit s_cesdbetter rhs7d `yearvars' $matchvars [iw=weight_7] , or 
outreg , append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs7d) ///
	rtitles("Any improvement 7+days" ) ///
	varlabels starlevels(10 5 1)  summstat(N) 
	
//7+day definition, clinical cesd improvement
qui logit s_cesd_ge3better rhs7d `yearvars' `new_varlist' [iw=weight_7] , or 
outreg using `logpath'\spouse_analysis_aug2014, append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs7d) ///
	rtitles("Clinical improvement 7+days" ) ///
	varlabels starlevels(10 5 1)  summstat(N) addtable	

****************************************************************
//test of cesd improved hospice vs non hospice in the caregivers only matched sample

mat quicktab3=J(2,3,.)
tab rhs3d if weight_3!=., matcell(r1)
mat quicktab3[1,2]=r1[1,1]
mat quicktab3[1,1]=r1[2,1]
local sample=r(N)

sum s_cesdbetter if rhs3d==1 [iweight=weight_3]
mat quicktab3[2,1]=r(mean)*100
sum s_cesdbetter if rhs3d==0 [iweight=weight_3]
mat quicktab3[2,2]=r(mean)*100

logit rhs3d s_cesdbetter [iweight=weight_3]
test s_cesdbetter 
mat quicktab3[2,3]=r(p) //p value from chisq test

frmttable using `logpath'\spouse_analysis_aug2014, statmat(quicktab3) ///
title("Matched sample CES-D Improvement, n=`sample', Caregivers only sample") ///
ctitle("","Hospice, %", "No hospice, %" "P-value" ) ///
rtitle("n"\"CES-D Improved") sdec(2) addtable



log close



H="Ivws before / after 12m"
capture log close

clear all
set mem 500m
set more off

//Amy's PC
local logpath E:\data\spouse\logs\august2014
local datapath E:\data\spouse\final_data

log using "`logpath'\6c-HRS_Spouse_analysis_ivw_after_1yr.txt", text replace

cd `datapath'

use spouse_data_sample_v3.dta //if (s_1yr_p1_core_dead==0)

tab rhs3d r_advdir_miss if s_1yr_p1_core_dead==1, missing
tab rhs3d r_advdir_miss if s_1yr_p1_core_dead==0, missing

tab days_p1_core_dod_cat , missing

//Have to use an alternate variable list because missing category for
//advanced directive is all 0 for the treated group for where ivw 12+m after death
global matchvars2 cc_all_count_12m_2 cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y /*r_advdir_miss*/ r_discuss_x r_srh_pf_n1 ///
s_age s_female s_white_e  s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1 

//first sort data randomly
set seed 2000
gen x=uniform()
sort x

********************************************************************
********************************************************************
//Sample where ivw is 12+m after R's death
********************************************************************
********************************************************************
//generate pscore variable hs_pscore
pscore rhs3d $matchvars2 if s_1yr_p1_core_dead==0, pscore(hs_pscore) blockid(hs_block) logit detail

//graph without dropping any observations in the matching process
psgraph, treated(rhs3d) pscore(hs_pscore)

//implement radius matching
gen logitpscore=ln(hs_pscore/(1-hs_pscore)) if s_1yr_p1_core_dead==0
sum logitpscore

sca cal_ps1=r(sd)*0.02
sca list cal_ps1

psmatch2  rhs3d if s_1yr_p1_core_dead==0,outcome(s_cesdbetter) pscore(hs_pscore) radius caliper(.02195066) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(rhs3d) pscore(hs_pscore)

histogram hs_pscore if _support==1, by(rhs3d) 

//look at balance of matched vs unmatched samples
pstest $matchvars2 if s_1yr_p1_core_dead==0,treated(rhs3d) both hist

pstest $matchvars2 if s_1yr_p1_core_dead==0,treated(rhs3d) both graph

//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age {
gen `v'_treated = `v' if rhs3d==1 & _support==1 & s_1yr_p1_core_dead==0
gen `v'_comparison = `v' if rhs3d==0 & _support==1 & s_1yr_p1_core_dead==0
qqplot `v'_treated `v'_comparison
}


mat vr=J(39,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $matchvars2  {
sum `v' if rhs3d==1 & s_1yr_p1_core_dead==0 //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if rhs3d==0 & s_1yr_p1_core_dead==0 //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if rhs3d==1 & _support==1 & s_1yr_p1_core_dead==0 //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if rhs3d==0 & s_1yr_p1_core_dead==0 [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}


mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y"  "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1" 

mat list vr

//6 from treated group are off common support, 4 control are not matched (weight==.)
//_support ==1 if matched
tab _support, missing
tab _support if rhs3d==1, missing
tab _support if rhs3d==0, missing
tab _weight if rhs3d==1, missing
sum _weight if rhs3d==0

rename _weight weight_after1yr

***********************************************************************
//now run logit model using weighting 
***********************************************************************
//need to include the variables used in the propensity score

tab r_death_year if s_1yr_p1_core_dead==0, missing
//one obs in 2010 so switch to 2009 for year fixed effects purposes

replace r_death_year=2009 if r_death_year==2010 & s_1yr_p1_core_dead==0
local yearvars ib2000.r_death_year 

logit s_cesdbetter i.rhs3d `yearvars' $matchvars2 [iw=weight_after1yr] if s_1yr_p1_core_dead==0, or 

outreg using `logpath'\ivw_time_groups_spouse_analysis, ///
	stats(e_b e_ci p) nosubstat  ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///
	"Limited to S p1 interview after 1 year of R's death" \ ///	
	"Outcome = CESD Score Decreased (by any amount) n1 to p1") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse no comorbidities.") ///
	varlabels starlevels(10 5 1)  summstat( N) replace

//Run logit with outcome=depressed n1, not depressed p1
	

logit s_cesd_ge3better i.rhs3d `yearvars' $matchvars2 [iw=weight_after1yr] if s_1yr_p1_core_dead==0 , or 

outreg using `logpath'\ivw_time_groups_spouse_analysis, ///
	stats(e_b e_ci p) nosubstat  ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///
	"Limited to S p1 interview after 1 year of R's death" \ ///	
	"Outcome = CESD Score 3+ n1 to less than 3 p1" ) ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse no comorbidities.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable

//for paper text, added with JAMAIM edit comments April 2015
sum s_cesdbetter if rhs3d==1 [iweight=weight_after1yr]
sum s_cesdbetter if rhs3d==0 [iweight=weight_after1yr]


********************************************************************
********************************************************************
//Sample where ivw is 0-12m after R's death
********************************************************************
********************************************************************

//first sort data randomly
sort x

//generate pscore variable hs_pscore
pscore rhs3d $matchvars if s_1yr_p1_core_dead==1, pscore(hs_pscore) blockid(hs_block) logit detail

//graph without dropping any observations in the matching process
//psgraph, treated(rhs3d) pscore(hs_pscore)

//implement radius matching
gen logitpscore_b=ln(hs_pscore/(1-hs_pscore)) if s_1yr_p1_core_dead==1
sum logitpscore_b

sca cal_ps_b=r(sd)*0.02
sca list cal_ps_b

psmatch2 rhs3d if s_1yr_p1_core_dead==1,outcome(s_cesdbetter) pscore(hs_pscore) radius caliper(.01650071) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(rhs3d) pscore(hs_pscore)

histogram hs_pscore if _support==1, by(rhs3d) 

//look at balance of matched vs unmatched samples
pstest $matchvars if s_1yr_p1_core_dead==1,treated(rhs3d) both hist

pstest $matchvars if s_1yr_p1_core_dead==1,treated(rhs3d) both graph

//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age {
gen `v'_treated_b = `v' if rhs3d==1 & _support==1 & s_1yr_p1_core_dead==1
gen `v'_comparison_b = `v' if rhs3d==0 & _support==1 & s_1yr_p1_core_dead==1
qqplot `v'_treated_b `v'_comparison_b
}


mat vr=J(40,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $matchvars  {
sum `v' if rhs3d==1 & s_1yr_p1_core_dead==1 //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if rhs3d==0 & s_1yr_p1_core_dead==1 //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if rhs3d==1 & _support==1 & s_1yr_p1_core_dead==1 //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if rhs3d==0 & s_1yr_p1_core_dead==1 [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}


mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Adv dir missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1" 

mat list vr

//2 from treated group are off common support, 0 control are not matched (weight==.)
//_support ==1 if matched
tab _support, missing
tab _support if rhs3d==1, missing
tab _support if rhs3d==0, missing
tab _weight if rhs3d==1, missing
sum _weight if rhs3d==0

rename _weight weight_bef1yr

***********************************************************************
//now run logit model using weighting 
***********************************************************************
//need to include the variables used in the propensity score

tab r_death_year if s_1yr_p1_core_dead==1, missing
//no observations in 2000 in this subsample so base = 2001 for these models

local yearvars ib2001.r_death_year 

logit s_cesdbetter i.rhs3d `yearvars' $matchvars [iw=weight_bef1yr] if s_1yr_p1_core_dead==1, or 

outreg using `logpath'\ivw_time_groups_spouse_analysis, ///
	stats(e_b e_ci p) nosubstat  ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///
	"Limited to S p1 interview within 1 year of R's death" \ ///	
	"Outcome = CESD Score Decreased (by any amount) n1 to p1") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse no comorbidities." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable

//Run logit with outcome=depressed n1, not depressed p1
	
logit s_cesd_ge3better i.rhs3d `yearvars' $matchvars [iw=weight_bef1yr] if s_1yr_p1_core_dead==1 , or 

outreg using `logpath'\ivw_time_groups_spouse_analysis, ///
	stats(e_b e_ci p) nosubstat  ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///
	"Limited to S p1 interview within 1 year of R's death" \ ///	
	"Outcome = CESD Score 3+ n1 to less than 3 p1" ) ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse no comorbidities." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable

	
*****************************************************************************

*****************************************************************************

//End of overall sample  , start caregivers only section

*****************************************************************************

*****************************************************************************

***********************************************************************

//first sort data randomly
sort x

local cgafter (s_1yr_p1_core_dead==0 & (r_adl_sp_helper_x==1 | r_iadl_sp_helper_x==1))

//generate pscore variable hs_pscore
pscore rhs3d $matchvars2 if `cgafter' , pscore(hs_pscore) blockid(hs_block) logit detail

//graph without dropping any observations in the matching process
//psgraph, treated(rhs3d) pscore(hs_pscore)

//implement radius matching
gen logitpscore_cga=ln(hs_pscore/(1-hs_pscore)) if `cgafter'
sum logitpscore_cga

sca cal_ps_cga=r(sd)*0.02
sca list cal_ps_cga

psmatch2  rhs3d  if `cgafter',outcome(s_cesdbetter) pscore(hs_pscore) radius caliper(.02336107) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(rhs3d) pscore(hs_pscore)

histogram hs_pscore if _support==1, by(rhs3d) 

//look at balance of matched vs unmatched samples
pstest $matchvars2  if `cgafter',treated(rhs3d) both hist

pstest $matchvars2  if `cgafter',treated(rhs3d) both graph

//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age {
gen `v'_treated_cga = `v' if rhs3d==1 & _support==1 & `cgafter'
gen `v'_compar_cga = `v' if rhs3d==0 & _support==1 & `cgafter'
qqplot `v'_treated_cga `v'_compar_cga
}


mat vr=J(39,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $matchvars2  {
sum `v' if rhs3d==1 & `cgafter' //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if rhs3d==0 & `cgafter' //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if rhs3d==1 & _support==1 & `cgafter' //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if rhs3d==0 & `cgafter' [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}

mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1" 

mat list vr

//13 from treated group are off common support, 7 control are not matched (weight==.)
//_support ==1 if matched
tab _support, missing
tab _support if rhs3d==1, missing
tab _support if rhs3d==0, missing
tab _weight if rhs3d==1, missing
sum _weight if rhs3d==0

rename _weight weight_cgafter1yr

***********************************************************************
//now run logit model using weighting 
***********************************************************************
//need to include the variables used in the propensity score
//we probably can't keep both spouse and r gender variables in

tab r_death_year  if `cgafter', missing

local yearvars ib2000.r_death_year 

logit s_cesdbetter i.rhs3d `yearvars' $matchvars2 [iw=weight_cgafter1yr] if `cgafter'  , or 

outreg using `logpath'\ivw_time_groups_spouse_analysis, ///
	stats(e_b e_ci p) nosubstat  ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///
	"Limited to S p1 interview after 1 year of R's death" \ ///	
	"Limited to Primary Caregiver spouses" \ ///
	"Outcome = CESD Score Decreased (by any amount) n1 to p1") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse no comorbidities.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable

//Run logit with outcome=depressed n1, not depressed p1
//need alternate match variables since perfect prediction with r_adl_stable_partial_n1n2 variable
tab s_cesd_ge3better r_adl_stable_partial_n1n2 if `cgafter' & rhs3d==1
tab s_cesd_ge3better r_adl_stable_partial_n1n2 if `cgafter' & rhs3d==0

global matchvars3 cc_all_count_12m_2 cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 /*r_adl_stable_partial_n1n2*/ r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y /*r_advdir_miss*/ r_discuss_x r_srh_pf_n1 ///
s_age s_female s_white_e  s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1 	

logit s_cesd_ge3better i.rhs3d `yearvars' $matchvars3 [iw=weight_cgafter1yr] if `cgafter' , or 

outreg using `logpath'\ivw_time_groups_spouse_analysis, ///
	stats(e_b e_ci p) nosubstat  ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///
	"Limited to S p1 interview after 1 year of R's death" \ ///	
	"Limited to Primary Caregiver spouses" \ ///
	"Outcome = CESD Score 3+ n1 to less than 3 p1" ) ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse no comorbidities.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable
	
	
***********************************************************************
***********************************************************************
//Now caregivers with interview within 12m of r's death
***********************************************************************
***********************************************************************
//first sort data randomly
sort x

local cgbefore (s_1yr_p1_core_dead==1 & (r_adl_sp_helper_x==1 | r_iadl_sp_helper_x==1))

//generate pscore variable hs_pscore
pscore rhs3d $matchvars if `cgbefore' , pscore(hs_pscore) blockid(hs_block) logit detail

//graph without dropping any observations in the matching process
//psgraph, treated(rhs3d) pscore(hs_pscore)

//implement radius matching
gen logitpscore_cgb=ln(hs_pscore/(1-hs_pscore)) if `cgbefore'
sum logitpscore_cgb

sca cal_ps_cgb=r(sd)*0.02
sca list cal_ps_cgb

psmatch2  rhs3d  if `cgbefore',outcome(s_cesdbetter) pscore(hs_pscore) radius caliper(.01692516) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(rhs3d) pscore(hs_pscore)

histogram hs_pscore if _support==1, by(rhs3d) 

//look at balance of matched vs unmatched samples
pstest $matchvars  if `cgbefore',treated(rhs3d) both hist

pstest $matchvars  if `cgbefore',treated(rhs3d) both graph

//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age {
gen `v'_treated_cgb = `v' if rhs3d==1 & _support==1 & `cgbefore'
gen `v'_compar_cgb = `v' if rhs3d==0 & _support==1 & `cgbefore'
qqplot `v'_treated_cgb `v'_compar_cgb
}


mat vr=J(40,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $matchvars  {
sum `v' if rhs3d==1 & `cgbefore' //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if rhs3d==0 & `cgbefore' //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if rhs3d==1 & _support==1 & `cgbefore' //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if rhs3d==0 & `cgbefore' [iweight=_weight]  //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}


mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Adv dir missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1" 

mat list vr

//7 from treated group are off common support, 0 control are not matched (weight==.)
//_support ==1 if matched
tab _support, missing
tab _support if rhs3d==1, missing
tab _support if rhs3d==0, missing
tab _weight if rhs3d==1, missing
sum _weight if rhs3d==0

rename _weight weight_cgbef1yr

***********************************************************************
//now run logit model using weighting 
***********************************************************************
//need to include the variables used in the propensity score
//we probably can't keep both spouse and r gender variables in

tab r_death_year if `cgbefore', missing
//no obs in 2000, base set to 2001

local yearvars ib2001.r_death_year 

logit s_cesdbetter i.rhs3d `yearvars' $matchvars [iw=weight_cgbef1yr] if `cgbefore', or 

outreg using `logpath'\ivw_time_groups_spouse_analysis, ///
	stats(e_b e_ci p) nosubstat  ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///
	"Limited to S p1 interview within 1 year of R's death" \ ///	
	"Limited to Primary Caregiver spouses" \ ///
	"Outcome = CESD Score Decreased (by any amount) n1 to p1") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse no comorbidities." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable

//Run logit with outcome=depressed n1, not depressed p1
//omit missing adv directive and s moderate comorb variables
global matchvars4 cc_all_count_12m_2 cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y /*r_advdir_miss*/ r_discuss_x r_srh_pf_n1 ///
s_age s_female s_white_e  s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
s_hrs_comorb_mild_n1 /*s_hrs_comorb_mod_n1*/ s_psych_overall_hrs_n1 

logit s_cesd_ge3better i.rhs3d `yearvars' $matchvars4 [iw=weight_cgbef1yr] if `cgbefore', or 

outreg using `logpath'\ivw_time_groups_spouse_analysis, ///
	stats(e_b e_ci p) nosubstat  ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///
	"Limited to S p1 interview within 1 year of R's death" \ ///	
	"Limited to Primary Caregiver spouses" \ ///
	"Outcome = CESD Score 3+ n1 to less than 3 p1" ) ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse no comorbidities." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable

****************************************************************
	
****************************************************************
//run each dr regression in a row to get a single table with all of the results
****************************************************************

****************************************************************

//all spouses with p1 ivws 12+m, any cesd improvement
qui logit s_cesdbetter rhs3d ib2000.r_death_year $matchvars2 [iw=weight_after1yr] if s_1yr_p1_core_dead==0, or 
outreg , store(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs3d) ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = S Depressive symptom improvement n1 to p1" \ ///
	"Sample split by p1 ivw timing 0-12m / 12m+ after R's death") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	rtitles("Any improvement, 12+m ivw" ) ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat(N)

//all spouses with p1 ivws 12+m, clinical cesd improvement
qui logit s_cesd_ge3better rhs3d ib2000.r_death_year $matchvars2 [iw=weight_after1yr] if s_1yr_p1_core_dead==0 , or 
outreg , append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs3d) ///
	rtitles("Clinical improvement, 12+m ivw") ///
	varlabels starlevels(10 5 1)  summstat(N) 
	
//all spouses with p1 ivws 0-12m, any cesd improvement
qui logit s_cesdbetter rhs3d ib2001.r_death_year $matchvars [iw=weight_bef1yr] if s_1yr_p1_core_dead==1, or 
outreg , append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs3d) ///
	rtitles("Any improvement, 0-12m ivw" ) ///
	varlabels starlevels(10 5 1)  summstat(N) 
	
//all spouses with p1 ivws 0-12m, clinical cesd improvement
qui logit s_cesd_ge3better rhs3d ib2001.r_death_year $matchvars [iw=weight_bef1yr] if s_1yr_p1_core_dead==1 , or 
outreg , append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs3d) ///
	rtitles("Clinical improvement, 0-12m ivw" ) ///
	varlabels starlevels(10 5 1)  summstat(N) 

//caregivers 12+m, any cesd improvement
qui logit s_cesdbetter rhs3d ib2000.r_death_year $matchvars2 [iw=weight_cgafter1yr] if `cgafter'  , or 
outreg , append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs3d) ///
	rtitles("Caregivers, Any improvement, 12+m" ) ///
	varlabels starlevels(10 5 1)  summstat(N) 
	
//caregivers 12+m, clinical cesd improvement
qui logit s_cesd_ge3better rhs3d ib2000.r_death_year $matchvars3 [iw=weight_cgafter1yr] if `cgafter' , or 
outreg , append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs3d) ///
	rtitles("Caregivers, Clinical improvement, 12+m" ) ///
	varlabels starlevels(10 5 1)  summstat(N) 

//caregivers 0-12m, any cesd improvement
qui logit s_cesdbetter rhs3d ib2001.r_death_year $matchvars [iw=weight_cgbef1yr] if `cgbefore', or 
outreg , append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs3d) ///
	rtitles("Caregivers, Any improvement, 0-12m" ) ///
	varlabels starlevels(10 5 1)  summstat(N) 

//0-12m ivw, caregivers, clinical cesd improvement
qui logit s_cesd_ge3better rhs3d ib2001.r_death_year $matchvars4 [iw=weight_cgbef1yr] if `cgbefore', or 
outreg using `logpath'\ivw_time_groups_spouse_analysis, append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs3d) ///
	rtitles("Caregivers, clinical improvement, 0-12m" ) ///
	varlabels starlevels(10 5 1)  summstat(N) addtable	

****************************************************************

	
*********************************************
log close


H="xxxxxxxxxxxxxxxxxxxxx"


H="Exclude 1-2 days hospice use, included 0-3m ivws"
/*
*******Run with new sample definition, allows for p1 interview *****
******* within 90 days of R's death                    *************
******* and hospice use 1-2 days excluded from control group *******

Outcome variables are: CESD improvement indicator, ie any improvement 
in CESD score from n1 to p1
And CESD clinical improvement 3+ to <3 n1 to p1

This Stata code runs following analyses:
1. Determines propensity scores
2. Runs summary tables for r and s characteristics using px weighting
3. Px matched logit regression on reduced spouse depressive symptoms 

Runs 3 versions
1. Hospice users: 1+ days / non users: 0 days
2. Hospice users: 3+ days / non users: 0 days
3. Hospice users: 7+ days / non users: 0 days*/

capture log close

clear all
set mem 500m
set more off
set scheme s1color

//Amy's PC
local logpath E:\data\spouse\logs\sept2014
local datapath E:\data\spouse\final_data

//RG PC
//local logpath C:\data\Spouse\logs
//local datapath C:\data\Spouse

log using "`logpath'\5-HRS_Spouse_analysis_sept2014.txt", text replace

cd `datapath'

use spouse_data_sample_v1.dta if (/*p1_wi_90d==0 &*/ no_cc_12m_excl_cataract==0 & sudden_cause_death==0 & cesd_miss_n1_p1==0 )

*****************************************************************************
*****************************************************************************
//Set up variables and dataset
*****************************************************************************
*****************************************************************************

//See tab "Sum stats, unmatched" for variable list used in matching
global matchvars cc_all_count_12m_2 cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y r_advdir_miss r_discuss_x r_srh_pf_n1 ///
s_age s_female s_white_e  s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1	

//drop observations with missing covariates (original n=1049, drop n=24)
//n=1025
foreach v of varlist $matchvars {
tab `v', missing
drop if `v'==.
}

tab hs_los_12m r_hs_12m , missing
tab hs_los_12m r_hs_12m_gt3d, missing
tab hs_los_12m r_hs_12m_gt7d, missing

la var r_hs_12m "1+ day hospice use, vs 0 days" 
la var r_hs_12m_gt3d "3+ days hospice use, vs 0 days"
la var r_hs_12m_gt7d "7+ days hospice use, vs 0 days"

//rename the hospice use variables so can use them in outreg later
rename r_hs_12m rhs12m
rename r_hs_12m_gt3d rhs3d 
rename r_hs_12m_gt7d rhs7d 

tab s_comor_c_hrs_n1 s_cesdbetter, chi2
tab s_comor_c_hrs_n1 rhs12m, chi2

//1 obs has s_comor_c_hrs_n1 = severe, set to moderate so controlled for
replace s_hrs_comorb_mod_n1=1 if s_comor_c_hrs_n1==3

********************************************************
//save this n=1025 dataset, this is the starting point the remainder analysis steps
save spouse_data_sample_v4.dta, replace
  
//first sort data randomly
set seed 2000
gen x=uniform()
sort x

*****************************************************************************
*****************************************************************************
//Using Stata's pscore to generate px scores - 1 day definition
*****************************************************************************
*****************************************************************************

//generate pscore variable hs_pscore
pscore rhs12m $matchvars, pscore(hs_pscore) blockid(hs_block) logit detail

//graph without dropping any observations in the matching process
psgraph, treated(rhs12m) pscore(hs_pscore)
graph save `logpath'/psgraph_1 ,replace

//implement radius matching
gen logitpscore=ln(hs_pscore/(1-hs_pscore))
sum logitpscore

sca cal_ps1=r(sd)*0.02
sca list cal_ps1

//rule of thumb 0.2*sd
//psmatch2  rhs12m,outcome(s_cesdbetter) pscore(hs_pscore) caliper(.1596179) logit
//try 0.02* sd
psmatch2  rhs12m,outcome(s_cesdbetter) pscore(hs_pscore) radius caliper(.01596179) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(rhs12m) pscore(hs_pscore)
graph save `logpath'/psgraph_2 ,replace

histogram hs_pscore if _support==1, by(rhs12m) 

//look at balance of matched vs unmatched samples
pstest $matchvars ,treated(rhs12m) both hist
graph save `logpath'/psmatch_1 ,replace

//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age{
gen `v'_treated = `v' if rhs12m==1 & _support==1
gen `v'_comparison = `v' if rhs12m==0 & _support==1
qqplot `v'_treated `v'_comparison
graph save `logpath'/qqplot_`v', replace
}

mat vr=J(40,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $matchvars  {
sum `v' if rhs12m==1 //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if rhs12m==0 //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if rhs12m==1 & _support==1 //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if rhs12m==0 [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}

mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1"

mat list vr

//look at standardized differences to assess balance
//continuous variables
mat std_diff=J(40,5,.)
local i=1
foreach v in cc_all_count_12m_2 s_age {
sum `v' if rhs12m==1 & _support==1 //get mean,variance treated after matching
mat std_diff[`i',1]=r(mean)
mat std_diff[`i',2]=r(sd)

sum `v' if rhs12m==0 [iweight=_weight] //get mean,variance contl after matching
mat std_diff[`i',3]=r(mean)
mat std_diff[`i',4]=r(sd)

mat std_diff[`i',5]=(std_diff[`i',1]-std_diff[`i',3])/sqrt((std_diff[`i',2]^2+std_diff[`i',4]^2)/2) 
	
local i = `i'+1	
}
//indicator variables
local indvars cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y r_advdir_miss r_discuss_x r_srh_pf_n1 ///
 s_female s_white_e  s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1 

foreach v in `indvars' {
sum `v' if rhs12m==1 & _support==1 //get mean treated after matching
mat std_diff[`i',1]=r(mean)

sum `v' if rhs12m==0 [iweight=_weight] //get mean contl after matching
mat std_diff[`i',3]=r(mean)

mat std_diff[`i',5]=(std_diff[`i',1]-std_diff[`i',3])/sqrt((std_diff[`i',1]*(1-std_diff[`i',1])+std_diff[`i',3]*(1-std_diff[`i',3]))/2)
	
local i = `i'+1	
}

mat rownames std_diff="Count of comorbidities" "S age" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
 "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1" 

mat list std_diff
//standardized difference should be less than 10-25%

//using this matching, 4 obs from the treatment group are dropped b/c they are off support
//1 dropped b/c not matched (weight=.)
//_support ==1 if matched
tab _support, missing
tab _support if rhs12m==1, missing
tab _support if rhs12m==0, missing
tab _weight if rhs12m==1, missing
sum _weight if rhs12m==0

//rename ps variables and save dataset so can call them up later
rename _support support_1
rename _weight weight_1

*************************************************************************************
//now run using weighting , outcome = improved CESD score p1
//need to include the variables used in the propensity score

local yearvars ib2000.r_death_year 
 
logit s_cesdbetter rhs12m `yearvars' $matchvars [iw=weight_1] , or 

outreg using `logpath'\spouse_analysis_sept2014, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score Decreased (by any amount) n1 to p1") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat( N) replace

tab s_cesdbetter s_cesd_ge3better, missing

//Run logit with outcome=depressed n1, not depressed p1
logit s_cesd_ge3better rhs12m `yearvars' $matchvars [iw=weight_1] , or 

outreg using `logpath'\spouse_analysis_sept2014, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score 3+ n1 to less than 3 p1") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable

*****************************************************************************

*****************************************************************************

//End of 1 day definition , start 3 day definition section

*****************************************************************************

*****************************************************************************
	
	
*****************************************************************************
*****************************************************************************
//Using Stata's pscore to generate px scores - 3 day definition
*****************************************************************************
*****************************************************************************
//first sort data randomly
set seed 2000
gen x3=uniform()
sort x3
//generate pscore variable hs_pscore
pscore rhs3d $matchvars if rhs3d!=., pscore(hs_pscore3) blockid(hs_block3) logit detail

//graph without dropping any observations in the matching process
psgraph, treated(rhs3d) pscore(hs_pscore3)
graph save `logpath'/psgraph_1_3 ,replace

//implement radius matching
gen logitpscore3=ln(hs_pscore3/(1-hs_pscore3))
sum logitpscore3

sca cal_ps3=r(sd)*0.02
sca list cal_ps3

//try 0.02* sd
psmatch2  rhs3d,outcome(s_cesdbetter) pscore(hs_pscore3) radius caliper(.01680763) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(rhs3d) pscore(hs_pscore3)
graph save `logpath'/psgraph_2_3 ,replace

histogram hs_pscore3 if _support==1, by(rhs3d) 

//look at balance of matched vs unmatched samples
pstest $matchvars ,treated(rhs3d) both hist
graph save `logpath'/psmatch_1_3 ,replace

//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age{
gen `v'_treated3 = `v' if rhs3d==1 & _support==1
gen `v'_comparison3 = `v' if rhs3d==0 & _support==1
qqplot `v'_treated3 `v'_comparison3
graph save `logpath'/qqplot_`v'_3, replace
}

mat vr=J(40,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $matchvars  {
sum `v' if rhs3d==1 //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if rhs3d==0 //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if rhs3d==1 & _support==1 //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if rhs3d==0 [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}

mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1" 

mat list vr

//look at standardized differences to assess balance
//continuous variables
mat std_diff=J(40,5,.)
local i=1
foreach v in cc_all_count_12m_2 s_age {
sum `v' if rhs3d==1 & _support==1 //get mean,variance treated after matching
mat std_diff[`i',1]=r(mean)
mat std_diff[`i',2]=r(sd)

sum `v' if rhs3d==0 [iweight=_weight] //get mean,variance contl after matching
mat std_diff[`i',3]=r(mean)
mat std_diff[`i',4]=r(sd)

mat std_diff[`i',5]=(std_diff[`i',1]-std_diff[`i',3])/sqrt((std_diff[`i',2]^2+std_diff[`i',4]^2)/2) 
	
local i = `i'+1	
}
//indicator variables
local indvars cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y r_advdir_miss r_discuss_x r_srh_pf_n1 ///
 s_female s_white_e  s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1 

foreach v in `indvars' {
sum `v' if rhs3d==1 & _support==1 //get mean treated after matching
mat std_diff[`i',1]=r(mean)

sum `v' if rhs3d==0 [iweight=_weight] //get mean contl after matching
mat std_diff[`i',3]=r(mean)

mat std_diff[`i',5]=(std_diff[`i',1]-std_diff[`i',3])/sqrt((std_diff[`i',1]*(1-std_diff[`i',1])+std_diff[`i',3]*(1-std_diff[`i',3]))/2)
	
local i = `i'+1	
}

mat rownames std_diff="Count of comorbidities" "S age" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
 "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1" 

mat list std_diff
//standardized difference should be less than 10-25%


//using this matching, 8 obs from the treatment group are dropped b/c they are off support
//1 dropped b/c not matched (weight=.)
//_support ==1 if matched
tab _support, missing
tab _support if rhs3d==1, missing
tab _support if rhs3d==0, missing
tab _weight if rhs3d==1, missing
sum _weight if rhs3d==0

//rename ps variables and save dataset so can call them up later
rename _support support_3
rename _weight weight_3

//now run using weighting , outcome = improved CESD score p1
//need to include the variables used in the propensity score
//we probably can't keep both spouse and r gender variables in
 
logit s_cesdbetter rhs3d `yearvars' $matchvars [iw=weight_3] , or 

outreg using `logpath'\spouse_analysis_sept2014, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score Decreased (by any amount) n1 to p1" \ ///
	"3+ days of hospice use = treatment, 0 days = control") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable


tab s_cesdbetter s_cesd_ge3better, missing

//Run logit with outcome=depressed n1, not depressed p1
logit s_cesd_ge3better rhs3d `yearvars' $matchvars [iw=weight_3] , or 

outreg using `logpath'\spouse_analysis_sept2014, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score 3+ n1 to less than 3 p1" \ ///
	"3+ days of hospice use = treatment, 0 days = control")  ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable

*****************************************************************************

*****************************************************************************

//End of 3 day definition , start 7 day definition section

*****************************************************************************

*****************************************************************************
	
	
*****************************************************************************
*****************************************************************************
//Using Stata's pscore to generate px scores - 7 day definition
*****************************************************************************
*****************************************************************************
//first sort data randomly
set seed 2000
gen x7=uniform()
sort x7
//generate pscore variable hs_pscore
pscore rhs7d $matchvars if rhs7d!=., pscore(hs_pscore7) blockid(hs_block7) logit detail

//graph without dropping any observations in the matching process
psgraph, treated(rhs7d) pscore(hs_pscore7)
graph save `logpath'/psgraph_1_7 ,replace

//implement radius matching
gen logitpscore7=ln(hs_pscore7/(1-hs_pscore7))
sum logitpscore7

sca cal_ps7=r(sd)*0.02
sca list cal_ps7

//try 0.02* sd
psmatch2  rhs7d,outcome(s_cesdbetter) pscore(hs_pscore7) radius caliper(.01762185) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(rhs7d) pscore(hs_pscore7)
graph save `logpath'/psgraph_2_7 ,replace

histogram hs_pscore7 if _support==1, by(rhs7d) 

//look at balance of matched vs unmatched samples
pstest $matchvars ,treated(rhs7d) both hist
graph save `logpath'/psmatch_1_7 ,replace

//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age{
gen `v'_treated7 = `v' if rhs7d==1 & _support==1
gen `v'_comparison7 = `v' if rhs7d==0 & _support==1
qqplot `v'_treated7 `v'_comparison7
graph save `logpath'/qqplot_`v'_7, replace
}

mat vr=J(40,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $matchvars  {
sum `v' if rhs7d==1 //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if rhs7d==0 //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if rhs7d==1 & _support==1 //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if rhs7d==0 [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}

mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1"

mat list vr

//look at standardized differences to assess balance
//continuous variables
mat std_diff=J(40,5,.)
local i=1
foreach v in cc_all_count_12m_2 s_age {
sum `v' if rhs7d==1 & _support==1 //get mean,variance treated after matching
mat std_diff[`i',1]=r(mean)
mat std_diff[`i',2]=r(sd)

sum `v' if rhs7d==0 [iweight=_weight] //get mean,variance contl after matching
mat std_diff[`i',3]=r(mean)
mat std_diff[`i',4]=r(sd)

mat std_diff[`i',5]=(std_diff[`i',1]-std_diff[`i',3])/sqrt((std_diff[`i',2]^2+std_diff[`i',4]^2)/2) 
	
local i = `i'+1	
}
//indicator variables
local indvars cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y r_advdir_miss r_discuss_x r_srh_pf_n1 ///
 s_female s_white_e  s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1 

foreach v in `indvars' {
sum `v' if rhs7d==1 & _support==1 //get mean treated after matching
mat std_diff[`i',1]=r(mean)

sum `v' if rhs7d==0 [iweight=_weight] //get mean contl after matching
mat std_diff[`i',3]=r(mean)

mat std_diff[`i',5]=(std_diff[`i',1]-std_diff[`i',3])/sqrt((std_diff[`i',1]*(1-std_diff[`i',1])+std_diff[`i',3]*(1-std_diff[`i',3]))/2)
	
local i = `i'+1	
}

mat rownames std_diff="Count of comorbidities" "S age" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
 "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1" 

mat list std_diff
//standardized difference should be less than 10-25%


//using this matching, 7 obs from the treatment group are dropped b/c they are off support
//1 dropped b/c not matched (weight=.)
//_support ==1 if matched
tab _support, missing
tab _support if rhs7d==1, missing
tab _support if rhs7d==0, missing
tab _weight if rhs7d==1, missing
sum _weight if rhs7d==0

//rename ps variables 
rename _support support_7
rename _weight weight_7

//save this dataset for making the tables in the next section
//this retains the weight variables
save `datapath'\spouse_data_sample_v4_sept2014.dta, replace

//now run using weighting , outcome = improved CESD score p1
//need to include the variables used in the propensity score
//we probably can't keep both spouse and r gender variables in
 
logit s_cesdbetter rhs7d `yearvars' $matchvars [iw=weight_7] , or 

outreg using `logpath'\spouse_analysis_sept2014, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score Decreased (by any amount) n1 to p1" \ ///
	"7+ days of hospice use = treatment, 0 days = control") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable


tab s_cesdbetter s_cesd_ge3better, missing

//Run logit with outcome=depressed n1, not depressed p1
logit s_cesd_ge3better rhs7d `yearvars' $matchvars [iw=weight_7] , or 

outreg using `logpath'\spouse_analysis_sept2014, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score 3+ n1 to less than 3 p1" \ ///
	"7+ days of hospice use = treatment, 0 days = control")  ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable
****************************************************************
	
****************************************************************
//run each dr regression in a row to get a single table with all of the results
****************************************************************

****************************************************************

//1+day definition, any cesd improvement
qui logit s_cesdbetter rhs12m `yearvars' $matchvars [iw=weight_1] , or 
outreg , store(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs12m) ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = S Depressive symptom improvement n1 to p1" \ ///
	"Control group = 0 days hospice use.") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	rtitles("Any improvement 1+day" ) ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions.") ///
	varlabels starlevels(10 5 1)  summstat(N)

//1+day definition, clinical cesd improvement
qui logit s_cesd_ge3better rhs12m `yearvars' $matchvars [iw=weight_1] , or 
outreg , append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs12m) ///
	rtitles("Clinical improvement 1+day") ///
	varlabels starlevels(10 5 1)  summstat(N) 
	
//3+day definition, any cesd improvement
qui logit s_cesdbetter rhs3d `yearvars' $matchvars [iw=weight_3] , or 
outreg , append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs3d) ///
	rtitles("Any improvement 3+days" ) ///
	varlabels starlevels(10 5 1)  summstat(N) 
	
//3+day definition, clinical cesd improvement
qui logit s_cesd_ge3better rhs3d `yearvars' $matchvars [iw=weight_3] , or 
outreg , append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs3d) ///
	rtitles("Clinical improvement 3+days" ) ///
	varlabels starlevels(10 5 1)  summstat(N) 

//7+day definition, any cesd improvement
qui logit s_cesdbetter rhs7d `yearvars' $matchvars [iw=weight_7] , or 
outreg , append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs7d) ///
	rtitles("Any improvement 7+days" ) ///
	varlabels starlevels(10 5 1)  summstat(N) 
	
//7+day definition, clinical cesd improvement
qui logit s_cesd_ge3better rhs7d `yearvars' $matchvars [iw=weight_7] , or 
outreg using `logpath'\spouse_analysis_sept2014, append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs7d) ///
	rtitles("Clinical improvement 7+days" ) ///
	varlabels starlevels(10 5 1)  summstat(N) addtable	

****************************************************************
log close



H="Tables 1 & 2"
/* *******Run with new sample definition, allows for p1 interview *****
******* within 90 days of R's death                    *************
******* and hospice use 1-2 days excluded from control group *******

Creates decedent and spouse characteristic tables

Hospice users definition: 3+ days / non users: 0 days

Runs in 2 sections, first are unmatched samples, then matched samples
*/

capture log close

clear all
set mem 500m
set more off
set scheme s1color

//Amy's PC
local logpath E:\data\spouse\logs\sept2014
local datapath E:\data\spouse\final_data

log using "`logpath'\5a-HRS_Spouse_char_tables_sept2014.txt", text replace

cd `datapath'

use spouse_data_sample_v4_sept2014.dta

*******************************************************
tab rhs3d , missing

gen non_hosp3=1 if rhs3d==0
replace non_hosp3=0 if rhs3d==1
tab non_hosp3 rhs3d, missing
 
*************************************************************************************
*************************************************************************************
//Create Table 1, Decedent Descriptive Statistics
//Col 1-3: Unweighted, unmatched sample
//Col 4-6: Weighted and matched sample
*************************************************************************************
*************************************************************************************
gen r_adl_improv_stab_i_n1n2 = 0
replace r_adl_improv_stab_i_n1n2  = 1 if r_adl_stable_ind_n1n2 ==1 | r_adl_improved_n1n2 
tab r_adl_improv_stab_i_n1n2 , missing

local t1vars r_medicaid_n1 r_nhres_n1 r_advdir_y r_advdir_n ///
r_advdir_miss r_adl_improv_stab_i_n1n2 ///
r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 r_adl_change_i_m_n1n2 ///
r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss cc_3_alzhdmta_n12mn0 ///
cc_6_chrnkidn_n12mn0 cc_12_ischmcht_n12mn0 cc_8_chf_n12mn0 ///
cc_9_diabetes_n12mn0 cc_7_copd_n12mn0 cc_16_strketia_n12mn0 ///
cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 cc_11_hipfrac_n12mn0 ///
cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 cc_15_ra_oa_n12mn0 

sum r_age, detail

mat demo=J(35,6,.)

//first row, n of hospice users and non-users
tab rhs3d , missing matcell(d1)
mat demo[1,1]=d1[2,1] //non-hospice n
mat demo[1,2]=d1[1,1] //hospice users n

local j=1
foreach h in rhs3d non_hosp3 {
sum r_age if `h'==1, detail //age
mat demo[2,`j']=r(mean)
mat demo[3,`j']=r(sd)
sum r_female if `h'==1, detail //female
mat demo[4,`j']=r(mean)*100
sum r_white_e if `h'==1, detail //non-hispanic, white
mat demo[5,`j']=r(mean)*100
sum r_hseduc_n1_n3 if `h'==1, detail //hs education+
mat demo[6,`j']=r(mean)*100
sum r_networth_adj2010_n1 if `h'==1, detail //net worth
mat demo[7,`j']=r(mean)
mat demo[8,`j']=r(sd)
local i=9
foreach v in `t1vars' {
	sum `v' if `h'==1, detail 
	mat demo[`i',`j']=r(mean)*100
	local i=`i'+1 //populates rows 9-34
	}
sum cc_all_count_12m_2 if `h'==1, detail //count of chronic conditions
mat demo[34,`j']=r(mean)
mat demo[35,`j']=r(sd)
local j=`j'+1
}

//standardized difference for unmatched sample
//creates new matrix with means then puts the standardized difference into
//the main demo matrix

mat std_diff_b=J(36,4,.)

local r=2
sum r_age if rhs3d==1 //get mean,variance treated before matching
mat std_diff_b[`r',1]=r(mean)
mat std_diff_b[`r',2]=r(sd)

sum r_age if rhs3d==0 //get mean,variance contl before matching
mat std_diff_b[`r',3]=r(mean)
mat std_diff_b[`r',4]=r(sd)

mat demo[`r',3]=(std_diff_b[`r',1]-std_diff_b[`r',3])/sqrt((std_diff_b[`r',2]^2+std_diff_b[`r',4]^2)/2) 
	
local r = 4
foreach v in r_female r_white_e r_hseduc_n1_n3 {
	sum `v' if rhs3d==1 //get mean,variance treated before matching
	mat std_diff_b[`r',1]=r(mean)

	sum `v' if rhs3d==0 //get mean,variance contl before matching
	mat std_diff_b[`r',3]=r(mean)

	mat demo[`r',3]=(std_diff_b[`r',1]-std_diff_b[`r',3])/sqrt((std_diff_b[`r',1]*(1-std_diff_b[`r',1])+std_diff_b[`r',3]*(1-std_diff_b[`r',3]))/2)

	local r = `r'+1
}

sum r_networth_adj2010_n1 if rhs3d==1 //get mean,variance treated before matching
mat std_diff_b[`r',1]=r(mean)
mat std_diff_b[`r',2]=r(sd)

sum r_networth_adj2010_n1 if rhs3d==0 //get mean,variance contl before matching
mat std_diff_b[`r',3]=r(mean)
mat std_diff_b[`r',4]=r(sd)

mat demo[`r',3]=(std_diff_b[`r',1]-std_diff_b[`r',3])/sqrt((std_diff_b[`r',2]^2+std_diff_b[`r',4]^2)/2) 

local r = 9
foreach v in `t1vars' {
	sum `v' if rhs3d==1 //get mean,variance treated before matching
	mat std_diff_b[`r',1]=r(mean)

	sum `v' if rhs3d==0 //get mean,variance contl before matching
	mat std_diff_b[`r',3]=r(mean)

	mat demo[`r',3]=(std_diff_b[`r',1]-std_diff_b[`r',3])/sqrt((std_diff_b[`r',1]*(1-std_diff_b[`r',1])+std_diff_b[`r',3]*(1-std_diff_b[`r',3]))/2)

	local r = `r'+1
}

local r = 34
sum cc_all_count_12m_2 if rhs3d==1 //get mean,variance treated before matching
mat std_diff_b[`r',1]=r(mean)
mat std_diff_b[`r',2]=r(sd)

sum cc_all_count_12m_2 if rhs3d==0 //get mean,variance contl before matching
mat std_diff_b[`r',3]=r(mean)
mat std_diff_b[`r',4]=r(sd)

mat demo[`r',3]=(std_diff_b[`r',1]-std_diff_b[`r',3])/sqrt((std_diff_b[`r',2]^2+std_diff_b[`r',4]^2)/2) 


//just look at it to check means against the pstest output to make sure they are right
mat rownames std_diff_b= "R age" "" "Female" "White" "HS Degree" "Net worth" "" ///
"Medicaid" "Nursing home res before death"  ///
"Advance directive Y" "Advance directive N" "Advance directive missing" ///
"ADL improved or stable ind" "ADL stable partial" "ADL stable severe" ///
"ADL Ind to mod" "ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" ///
"Alzheimers/Dementia" "Chronic kidney disease" "AMI / ISCH" ///
"CHF" "Diabetes" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis" "Count of comorbidities" ""

mat list std_diff_b

*************************************************************************************
//Table 1 - cols 4-6: Respondent characteristics, matched and weighted
*************************************************************************************

//first row, n of hospice users and non-users
tab rhs3d if weight_3!=. , missing matcell(dm)
mat demo[1,5]=dm[1,1] //non-hospice n
mat demo[1,4]=dm[2,1] //hospice users n

local j=4
foreach h in rhs3d non_hosp3 {
sum r_age if `h'==1 [iweight=weight_3] //age
mat demo[2,`j']=r(mean)
mat demo[3,`j']=r(sd)
sum r_female if `h'==1 [iweight=weight_3] //female
mat demo[4,`j']=r(mean)*100
sum r_white_e if `h'==1 [iweight=weight_3] //non-hispanic, white
mat demo[5,`j']=r(mean)*100
sum r_hseduc_n1_n3 if `h'==1 [iweight=weight_3] //hs education+
mat demo[6,`j']=r(mean)*100
sum r_networth_adj2010_n1 if `h'==1 [iweight=weight_3] //net worth
mat demo[7,`j']=r(mean)
mat demo[8,`j']=r(sd)
local i=9
foreach v in `t1vars' {
	sum `v' if `h'==1 [iweight=weight_3] 
	mat demo[`i',`j']=r(mean)*100
	local i=`i'+1 //populates rows 9-34
	}
sum cc_all_count_12m_2 if `h'==1 [iweight=weight_3] //count of chronic conditions
mat demo[34,`j']=r(mean)
mat demo[35,`j']=r(sd)
local j=`j'+1
}

//standardized difference for matched sample
//creates new matrix with means then puts the standardized difference into
//the main demo matrix

mat std_diff_a=J(35,4,.)

local r=2
sum r_age if rhs3d==1 [iweight=weight_3] //get mean,variance treated after matching
mat std_diff_a[`r',1]=r(mean)
mat std_diff_a[`r',2]=r(sd)

sum r_age if rhs3d==0 [iweight=weight_3] //get mean,variance contl after matching
mat std_diff_a[`r',3]=r(mean)
mat std_diff_a[`r',4]=r(sd)

mat demo[`r',6]=(std_diff_a[`r',1]-std_diff_a[`r',3])/sqrt((std_diff_a[`r',2]^2+std_diff_a[`r',4]^2)/2) 
	
local r = 4
foreach v in r_female r_white_e r_hseduc_n1_n3 {
	sum `v' if rhs3d==1 [iweight=weight_3] //get mean,variance treated after matching
	mat std_diff_a[`r',1]=r(mean)

	sum `v' if rhs3d==0 [iweight=weight_3] //get mean,variance contl after matching
	mat std_diff_a[`r',3]=r(mean)

	mat demo[`r',6]=(std_diff_a[`r',1]-std_diff_a[`r',3])/sqrt((std_diff_a[`r',1]*(1-std_diff_a[`r',1])+std_diff_a[`r',3]*(1-std_diff_a[`r',3]))/2)

	local r = `r'+1
}

sum r_networth_adj2010_n1 if rhs3d==1 [iweight=weight_3] //get mean,variance treated after matching
mat std_diff_a[`r',1]=r(mean)
mat std_diff_a[`r',2]=r(sd)

sum r_networth_adj2010_n1 if rhs3d==0 [iweight=weight_3] //get mean,variance contl after matching
mat std_diff_a[`r',3]=r(mean)
mat std_diff_a[`r',4]=r(sd)

mat demo[`r',6]=(std_diff_a[`r',1]-std_diff_a[`r',3])/sqrt((std_diff_a[`r',2]^2+std_diff_a[`r',4]^2)/2) 

local r = 9
foreach v in `t1vars' {
	sum `v' if rhs3d==1 [iweight=weight_3] //get mean,variance treated after matching
	mat std_diff_a[`r',1]=r(mean)

	sum `v' if rhs3d==0 [iweight=weight_3] //get mean,variance contl after matching
	mat std_diff_a[`r',3]=r(mean)

	mat demo[`r',6]=(std_diff_a[`r',1]-std_diff_a[`r',3])/sqrt((std_diff_a[`r',1]*(1-std_diff_a[`r',1])+std_diff_a[`r',3]*(1-std_diff_a[`r',3]))/2)

	local r = `r'+1
}

local r = 34
sum cc_all_count_12m_2 if rhs3d==1 [iweight=weight_3] //get mean,variance treated after matching
mat std_diff_a[`r',1]=r(mean)
mat std_diff_a[`r',2]=r(sd)

sum cc_all_count_12m_2 if rhs3d==0 [iweight=weight_3] //get mean,variance contl after matching
mat std_diff_a[`r',3]=r(mean)
mat std_diff_a[`r',4]=r(sd)

mat demo[`r',6]=(std_diff_a[`r',1]-std_diff_a[`r',3])/sqrt((std_diff_a[`r',2]^2+std_diff_a[`r',4]^2)/2) 


//just look at it to check means against the pstest output to make sure they are right
mat rownames std_diff_a= "R age" "" "Female" "White" "HS Degree" "Net worth" "" ///
"Medicaid" "Nursing home res before death"  ///
"Advance directive Y" "Advance directive N" "Advance directive missing" ///
"ADL improved or stable ind" "ADL stable partial" "ADL stable severe"  ///
"ADL Ind to mod" "ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" ///
"Alzheimers/Dementia" "Chronic kidney disease" "AMI / ISCH" ///
"CHF" "Diabetes" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis" "Count of comorbidities" ""

mat list std_diff_a


mat rownames demo ="Sample n" "Age at death, years, mean" "SD" "Female, %" "Race, Non-Hispanic White, %" ///
"Education, High School Grad" "Net worth, 2010US$, mean" "SD" "Medicaid, %" ///
"Nursing home resident n1, %" "Had advance directive" ///
"Did not have advance directive" "Advance directive status unknown" ///
"Impr or Indep in ADLs n2 to n1" ///
"Stable, Moderate 1-3 ADL" "Stable, Severe 4-6 ADL" ///
"Declined, Indep to Moderate" "Declined, Moderate to Severe" ///
"Declined, Independent to Severe" "Unknown" "Alzheimers/Dementia" "Chronic Kidney Disease" ///
"Ischemic Heart Disease" "Congestive Heart Failure" "Diabetes" "COPD" ///
"Stroke or TIA" "Cancer" "Atrial Fibrillation" "Hip Fracture" "Depression" "Osteoporosis" ///
"Arthritis" "Count of chronic conditions" "SD"

mat list demo

frmttable using `logpath'\spo_Table1_deced_char, statmat(demo) ///
title("Decedent descriptive characteristics, 3+ hospice days") ///
ctitle("","Unmatched Sample","","","Matched Sample","","" \ "", "Hospice users","Non-hospice users","Std. Diff.", ///
  "Hospice users" ,"Non-hospice users" ,"Std. Diff.") ///
sdec(2,2,3,2,2,3) replace

******************************************************************
******************************************************************
//Table 2 spouse characteristics (2nd table with CESD variables)
//Col 1-3: unmatched, unweighted
//Col 4-6: matched and weighted
******************************************************************
******************************************************************
local sdemovar1 s_female s_white_e s_hseduc_n1_n3 ///
s_medicaid_n1 s_srh_pf_n1 s_imprelig_vimp_n1 s_smoke_curr_n1 ///
s_vig_phy_act_n1 s_hrs_comorb_none_n1 s_hrs_comorb_mild_n1 ///
s_hrs_comorb_mod_n1 s_cancer_hrs_n1 ///
s_lung_hrs_n1 s_heart_hrs_n1 s_chf_hrs_n1 s_stroke_hrs_n1 ///
s_memory_hrs_n1 s_htn_hrs_n1 s_dm_hrs_n1 s_psych_hrs_n1 

local sdemovar2 s_cesd_tot_ge3_n1 ///
s_cesd_tot_ge3_p1 s_cesdbetter s_cesdsame s_cesdworse 

mat sdemo=J(23,6,.)
mat sdemo2=J(9,6,.)

//first row, n of hospice and non-hospice
tab rhs3d, missing matcell(sd1)
mat sdemo[1,1]=sd1[2,1] //non-hospice n
mat sdemo[1,2]=sd1[1,1] //hospice users n
mat sdemo2[1,1]=sd1[2,1] //non-hospice n
mat sdemo2[1,2]=sd1[1,1] //hospice users n

local j=1
foreach h in rhs3d non_hosp3 {
sum s_age if `h'==1, detail //age
mat sdemo[2,`j']=r(mean)
mat sdemo[3,`j']=r(sd)
local i=4
foreach v in `sdemovar1' {
	sum `v' if `h'==1, detail 
	mat sdemo[`i',`j']=r(mean)*100
	local i=`i'+1 //populates rows 4-23
	}

sum s_cesd_tot_n1 if `h'==1, detail //cesd score n1
mat sdemo2[2,`j']=r(mean)
sum s_cesd_tot_p1 if `h'==1, detail //cesd score p1
mat sdemo2[3,`j']=r(mean)
sum s_cesdchange if `h'==1, detail //cesd score change n1 to p1
mat sdemo2[4,`j']=r(mean)

local i=5
foreach v in `sdemovar2' {
	sum `v' if `h'==1, detail 
	mat sdemo2[`i',`j']=r(mean)*100
	local i=`i'+1 //populates rows 5-9
	}
local j=`j'+1
}

//standardized difference for unmatched sample
//creates new matrix with means then puts the standardized difference into
//the main demo matrix

mat std_diff_b=J(23,4,.)
mat std_diff_b2=J(9,4,.)

local r=2
sum s_age if rhs3d==1 //get mean,variance treated before matching
mat std_diff_b[`r',1]=r(mean)
mat std_diff_b[`r',2]=r(sd)

sum s_age if rhs3d==0 //get mean,variance contl before matching
mat std_diff_b[`r',3]=r(mean)
mat std_diff_b[`r',4]=r(sd)

mat sdemo[`r',3]=(std_diff_b[`r',1]-std_diff_b[`r',3])/sqrt((std_diff_b[`r',2]^2+std_diff_b[`r',4]^2)/2)

local r = 4
foreach v in `sdemovar1'  {
	sum `v' if rhs3d==1 //get mean,variance treated before matching
	mat std_diff_b[`r',1]=r(mean)

	sum `v' if rhs3d==0 //get mean,variance contl before matching
	mat std_diff_b[`r',3]=r(mean)

	mat sdemo[`r',3]=(std_diff_b[`r',1]-std_diff_b[`r',3])/sqrt((std_diff_b[`r',1]*(1-std_diff_b[`r',1])+std_diff_b[`r',3]*(1-std_diff_b[`r',3]))/2)

	local r = `r'+1
}

local r = 2
foreach v in s_cesd_tot_n1  s_cesd_tot_p1  s_cesdchange {
        sum `v' if rhs3d==1 //get mean,variance treated before matching
    mat std_diff_b2[`r',1]=r(mean)
    mat std_diff_b2[`r',2]=r(sd)

    sum `v' if rhs3d==0 //get mean,variance contl before matching
    mat std_diff_b2[`r',3]=r(mean)
    mat std_diff_b2[`r',4]=r(sd)

    mat sdemo2[`r',3]=(std_diff_b2[`r',1]-std_diff_b2[`r',3])/sqrt((std_diff_b2[`r',2]^2+std_diff_b2[`r',4]^2)/2)

    local r = `r'+1
}

local r = 5
foreach v in `sdemovar2' {
	sum `v' if rhs3d==1 //get mean,variance treated before matching
	mat std_diff_b2[`r',1]=r(mean)

	sum `v' if rhs3d==0 //get mean,variance contl before matching
	mat std_diff_b2[`r',3]=r(mean)

	mat sdemo2[`r',3]=(std_diff_b2[`r',1]-std_diff_b2[`r',3])/sqrt((std_diff_b2[`r',1]*(1-std_diff_b2[`r',1])+std_diff_b2[`r',3]*(1-std_diff_b2[`r',3]))/2)

	local r = `r'+1
}

//just look at it to check means against the pstest output to make sure they are right
mat rownames std_diff_b= "n" "S age" "" "Female" "White" "HS Degree" ///
"Medicaid" "SRH poor/fair" "Religion very imp" "Smoker" "Vigorous phys act" ///
"Comorb - none" "Mild" "Moderate" "Cancer" "Lung disease" "Heart disease" "CHF" "Stroke" ///
"Memory disease" "Hypertension" "Diabetes" "Psych problems" 

mat rownames std_diff_b2="n" "CESD raw n1" "CESD raw p1" "CESD change" ///
"Clin depr n1" "Clin depr p1" "CESD improved" "CESD same" "CESD declined"

mat list sdemo
mat list sdemo2
mat list std_diff_b
mat list std_diff_b2

**********************************************************************
//Matched weighted columns 4-6
**********************************************************************

//first row, n of hospice and non-hospice
tab rhs3d if weight_3!=., missing matcell(sd1)
mat sdemo[1,4]=sd1[2,1] //hospice n
mat sdemo[1,5]=sd1[1,1] //non-hospice users n
mat sdemo2[1,4]=sd1[2,1] //hospice n
mat sdemo2[1,5]=sd1[1,1] //non-hospice users n

local j=4
foreach h in rhs3d non_hosp3 {
sum s_age if `h'==1 [iweight=weight_3] //age
mat sdemo[2,`j']=r(mean)
mat sdemo[3,`j']=r(sd)
local i=4
foreach v in `sdemovar1' {
	sum `v' if `h'==1 [iweight=weight_3] 
	mat sdemo[`i',`j']=r(mean)*100
	local i=`i'+1 //populates rows 4-23
	}

sum s_cesd_tot_n1 if `h'==1 [iweight=weight_3] //cesd score n1
mat sdemo2[2,`j']=r(mean)
sum s_cesd_tot_p1 if `h'==1 [iweight=weight_3] //cesd score p1
mat sdemo2[3,`j']=r(mean)
sum s_cesdchange if `h'==1 [iweight=weight_3] //cesd score change n1 to p1
mat sdemo2[4,`j']=r(mean)
local i=5
foreach v in `sdemovar2' {
	sum `v' if `h'==1 [iweight=weight_3] 
	mat sdemo2[`i',`j']=r(mean)*100
	local i=`i'+1 //populates rows 5-8
	}
local j=`j'+1
}

//standardized difference for matched sample
//creates new matrix with means then puts the standardized difference into
//the main demo matrix

mat std_diff_a=J(23,4,.)
mat std_diff_a2=J(9,4,.)

local r=2
sum s_age if rhs3d==1 [iweight=weight_3] //get mean,variance treated after matching
mat std_diff_a[`r',1]=r(mean)
mat std_diff_a[`r',2]=r(sd)

sum s_age if rhs3d==0 [iweight=weight_3] //get mean,variance contl after matching
mat std_diff_a[`r',3]=r(mean)
mat std_diff_a[`r',4]=r(sd)

mat sdemo[`r',6]=(std_diff_a[`r',1]-std_diff_a[`r',3])/sqrt((std_diff_a[`r',2]^2+std_diff_a[`r',4]^2)/2)

local r = 4
foreach v in `sdemovar1' {
	sum `v' if rhs3d==1 [iweight=weight_3] //get mean,variance treated after matching
	mat std_diff_a[`r',1]=r(mean)

	sum `v' if rhs3d==0 [iweight=weight_3] //get mean,variance contl after matching
	mat std_diff_a[`r',3]=r(mean)

	mat sdemo[`r',6]=(std_diff_a[`r',1]-std_diff_a[`r',3])/sqrt((std_diff_a[`r',1]*(1-std_diff_a[`r',1])+std_diff_a[`r',3]*(1-std_diff_a[`r',3]))/2)

	local r = `r'+1
}

local r = 2
foreach v in s_cesd_tot_n1 s_cesd_tot_p1 s_cesdchange  {
        sum `v' if rhs3d==1 [iweight=weight_3] //get mean,variance treated after matching
        mat std_diff_a2[`r',1]=r(mean)
        mat std_diff_a2[`r',2]=r(sd)

        sum `v' if rhs3d==0 [iweight=weight_3] //get mean,variance contl after matching
        mat std_diff_a2[`r',3]=r(mean)
        mat std_diff_a2[`r',4]=r(sd)

        mat sdemo2[`r',6]=(std_diff_a2[`r',1]-std_diff_a2[`r',3])/sqrt((std_diff_a2[`r',2]^2+std_diff_a2[`r',4]^2)/2)
   	local r = `r'+1
}

local r = 5
foreach v in `sdemovar2' {
	sum `v' if rhs3d==1 [iweight=weight_3] //get mean,variance treated after matching
	mat std_diff_a2[`r',1]=r(mean)

	sum `v' if rhs3d==0 [iweight=weight_3] //get mean,variance contl after matching
	mat std_diff_a2[`r',3]=r(mean)

	mat sdemo2[`r',6]=(std_diff_a2[`r',1]-std_diff_a2[`r',3])/sqrt((std_diff_a2[`r',1]*(1-std_diff_a2[`r',1])+std_diff_a2[`r',3]*(1-std_diff_a2[`r',3]))/2)

	local r = `r'+1
}

//just look at it to check means against the pstest output to make sure they are right
mat rownames std_diff_a= "n" "S age" "" "Female" "White" "HS Degree" ///
"Medicaid" "SRH poor/fair" "Religion very imp" "Smoker" "Vigorous phys act" ///
"Comorb - none" "Mild" "Moderate" "Cancer" "Lung disease" "Heart disease" "CHF" "Stroke" ///
"Memory disease" "Hypertension" "Diabetes" "Psych problems"

mat rownames std_diff_a2="n" "CESD raw n1" "CESD raw p1" "CESD change" ///
"Clin depr n1" "Clin depr p1" "CESD improved" "CESD same" "CESD declined"

mat list std_diff_a
mat list std_diff_a2

mat rownames sdemo ="Sample size n" "Age at r's death, mean" "SD" "Female %" "Non-Hispanic White %" ///
"Education, High school grad %" "Medicaid %" "SRH poor or fair %" ///
"Religion very important %" "Currently smoker %" "Vigorous physical activity %" ///
"Comorbidity index - none" "Mild (1-3)" "Moderate (4-6)" ///
"Cancer %" "Lung disease %" "Heart disease %" "CHF %" "Stroke %" "Memory disease %" ///
"Hypertension %" "Diabetes %" "Psychological problems %" ///

mat rownames sdemo2 ="CES-D raw score pre-death, mean" ///
"CES-D raw score post-death, mean" "Change in raw CES-D" ///
"Clinical depression pre-death %" "Clinical depression post-death %" ///
 "CES-D Improved post death %" "Same CES-D post death %" "CES-D Declined post death %"

mat list sdemo

frmttable using `logpath'\spo_Table2_spouse_char, statmat(sdemo) ///
title("Spouse descriptive characteristics,  3+ hospice days") ///
ctitle("","Unmatched Sample","","","Matched Sample","","" \ "", "Hospice users","Non-hospice users","Std. Diff.", ///
  "Hospice users" ,"Non-hospice users" ,"Std. Diff.") ///
  sdec(2,2,4,2,2,4) replace

frmttable using `logpath'\spo_Table2_spouse_char, statmat(sdemo2) ///
title("Spouse CES-D depression outcomes,  3+ hospice days") ///
ctitle("","Unmatched Sample","","","Matched Sample","","" \ "", "Hospice users","Non-hospice users","Std. Diff.", ///
  "Hospice users" ,"Non-hospice users" ,"Std. Diff.") ///
  sdec(2,2,4,2,2,4) addtable

***********************************************************************
//Table of overall sample characteristics
***********************************************************************
local varlist1 r_female r_white_e r_hseduc_n1_n3 

local varlist2 s_female s_white_e s_hseduc_n1_n3 s_adl_independent_core_n1

mat quicktab=J(13,5,.)

sum r_age if rhs3d!=. //mean R age
mat quicktab[1,1]=r(mean)
local sample = r(N)

local j=2
foreach v in `varlist1'{
sum `v' if rhs3d!=. 
mat quicktab[`j',1]=r(mean)*100
local j=`j'+1 //rows 2-4
}

sum s_age if rhs3d!=.  //mean S age
mat quicktab[5,1]=r(mean)

local j=6
foreach v in `varlist2'{
sum `v' if rhs3d!=. 
mat quicktab[`j',1]=r(mean)*100
local j=`j'+1 //rows 6-9
}

local i=10
sum hs_los_12m if rhs3d==1, detail
mat quicktab[`i',1]=r(mean)
mat quicktab[`i',2]=r(sd)
mat quicktab[`i',3]=r(p50)
mat quicktab[`i',4]=r(min)
mat quicktab[`i',5]=r(max)

gen mo_p1_core_dead =days_p1_core_dead/30.5
gen mo_s_n1_core_dead = s_days_n1_core_dead/30.5

sum mo_p1_core_dead if rhs3d!=. 
mat quicktab[`i'+1,1]=r(mean)

sum mo_s_n1_core_dead if rhs3d!=. 
mat quicktab[`i'+2,1]=r(mean)

gen mo_s_p1_n1 = (days_p1_core_dead+ s_days_n1_core_dead)/30.5
sum mo_s_p1_n1 if rhs3d!=. , detail
mat quicktab[`i'+3,1]=r(mean)
mat quicktab[`i'+3,2]=r(sd)
mat quicktab[`i'+3,3]=r(p50)
mat quicktab[`i'+3,4]=r(min)
mat quicktab[`i'+3,5]=r(max)

mat list quicktab

mat rownames quicktab="R Age" "R Female" "R White" "R HS Degree" ///
"S Age" "S Female" "S White" "S HS Degree" "S ADL independent n1" ///
"Days hospice use" "S n1 ivw months before death" ///
"S p1 ivw months after death" ///
"S n1 to p1 interview, months"

frmttable using `logpath'\spo_overall_sample_char, statmat(quicktab) ///
title("Overall sample descriptive characteristics, n=`sample'") ///
ctitle("","Mean or Percent" "SD" "Median" "Min" "Max") ///
note("Sample limited to those with 0 or 3+ days hospice use (1-2 day exposure excluded)") ///
sdec(3,2,0,0,0) replace


***********************************************************************
log close


H="Caregivers"
/*
Runs the models for the helper subsample only

Outcome variables are: CESD improvement indicator, ie any improvement 
in CESD score from n1 to p1
And CESD clinical improvement 3+ to <3 n1 to p1

This Stata code runs following analyses:
1. Determines propensity scores
2. Runs summary tables for r and s characteristics using px weighting
3. Px matched logit regression on reduced spouse depressive symptoms 

Runs 3 versions
1. Hospice users: 1+ days / non users: 0 days
2. Hospice users: 3+ days / non users: 0 days
3. Hospice users: 7+ days / non users: 0 days*/

capture log close

clear all
set mem 500m
set more off
set scheme s1color

//Amy's PC
local logpath E:\data\spouse\logs\sept2014\helper
local datapath E:\data\spouse\final_data

//RG PC
//local logpath C:\data\Spouse\logs
//local datapath C:\data\Spouse

log using "`logpath'\6-HRS_Spouse_analysis_helper_sept2014.txt", text replace

cd `datapath'

use spouse_data_sample_v4.dta if (r_adl_sp_helper_x==1 | r_iadl_sp_helper_x==1) 
  
*****************************************************************************
*****************************************************************************
//Set up variables and dataset
*****************************************************************************
*****************************************************************************

//first sort data randomly
set seed 2000
gen x=uniform()
sort x

*****************************************************************************
*****************************************************************************
//Using Stata's pscore to generate px scores - 1 day definition
*****************************************************************************
*****************************************************************************

//generate pscore variable hs_pscore
pscore rhs12m $matchvars, pscore(hs_pscore) blockid(hs_block) logit detail

//graph without dropping any observations in the matching process
psgraph, treated(rhs12m) pscore(hs_pscore)
graph save `logpath'/psgraph_1 ,replace

//implement radius matching
gen logitpscore=ln(hs_pscore/(1-hs_pscore))
sum logitpscore

sca cal_ps1=r(sd)*0.02
sca list cal_ps1

//try 0.02* sd
psmatch2  rhs12m,outcome(s_cesdbetter) pscore(hs_pscore) radius caliper(.01628742) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(rhs12m) pscore(hs_pscore)
graph save `logpath'/psgraph_2 ,replace

histogram hs_pscore if _support==1, by(rhs12m) 

//look at balance of matched vs unmatched samples
pstest $matchvars ,treated(rhs12m) both hist
graph save `logpath'/psmatch_1 ,replace

//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age{
gen `v'_treated = `v' if rhs12m==1 & _support==1
gen `v'_comparison = `v' if rhs12m==0 & _support==1
qqplot `v'_treated `v'_comparison
graph save `logpath'/qqplot_`v', replace
}

mat vr=J(40,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $matchvars  {
sum `v' if rhs12m==1 //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if rhs12m==0 //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if rhs12m==1 & _support==1 //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if rhs12m==0 [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}

mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1"

mat list vr

//look at standardized differences to assess balance
//continuous variables
mat std_diff=J(40,5,.)
local i=1
foreach v in cc_all_count_12m_2 s_age {
sum `v' if rhs12m==1 & _support==1 //get mean,variance treated after matching
mat std_diff[`i',1]=r(mean)
mat std_diff[`i',2]=r(sd)

sum `v' if rhs12m==0 [iweight=_weight] //get mean,variance contl after matching
mat std_diff[`i',3]=r(mean)
mat std_diff[`i',4]=r(sd)

mat std_diff[`i',5]=(std_diff[`i',1]-std_diff[`i',3])/sqrt((std_diff[`i',2]^2+std_diff[`i',4]^2)/2) 
	
local i = `i'+1	
}
//indicator variables
local indvars cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y r_advdir_miss r_discuss_x r_srh_pf_n1 ///
 s_female s_white_e  s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1 

foreach v in `indvars' {
sum `v' if rhs12m==1 & _support==1 //get mean treated after matching
mat std_diff[`i',1]=r(mean)

sum `v' if rhs12m==0 [iweight=_weight] //get mean contl after matching
mat std_diff[`i',3]=r(mean)

mat std_diff[`i',5]=(std_diff[`i',1]-std_diff[`i',3])/sqrt((std_diff[`i',1]*(1-std_diff[`i',1])+std_diff[`i',3]*(1-std_diff[`i',3]))/2)
	
local i = `i'+1	
}

mat rownames std_diff="Count of comorbidities" "S age" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
 "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1" 

mat list std_diff
//standardized difference should be less than 10-25%

//using this matching, 10 obs from the treatment group are dropped b/c they are off support
//3 are dropped b/c not matched (weight=.)
//_support ==1 if matched
tab _support, missing
tab _support if rhs12m==1, missing
tab _support if rhs12m==0, missing
tab _weight if rhs12m==1, missing
sum _weight if rhs12m==0

//rename ps variables so can call them up later
rename _support support_1
rename _weight weight_1

//now run using weighting , outcome = improved CESD score p1
//need to include the variables used in the propensity score

local yearvars ib2000.r_death_year 
 
logit s_cesdbetter rhs12m `yearvars' $matchvars [iw=weight_1] , or 

outreg using `logpath'\spouse_analysis_sept2014, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score Decreased (by any amount) n1 to p1") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat( N) replace


tab s_cesdbetter s_cesd_ge3better, missing

//Run logit with outcome=depressed n1, not depressed p1
//Need alternative variable list excluding advanced directive missing status b/c
//it predicts the outcome (failure)
tab s_cesd_ge3better r_advdir_miss if weight_1!=., missing

local new_varlist cc_all_count_12m_2 cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y /*r_advdir_miss*/ r_discuss_x r_srh_pf_n1 ///
s_age s_female s_white_e  s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1 

logit s_cesd_ge3better rhs12m `yearvars' `new_varlist' [iw=weight_1] , or 

outreg using `logpath'\spouse_analysis_sept2014, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score 3+ n1 to less than 3 p1") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable

*****************************************************************************

*****************************************************************************

//End of 1 day definition , start 3 day definition section

*****************************************************************************

*****************************************************************************
	
	
*****************************************************************************
*****************************************************************************
//Using Stata's pscore to generate px scores - 3 day definition
*****************************************************************************
*****************************************************************************

//generate pscore variable hs_pscore
pscore rhs3d $matchvars if rhs3d!=., pscore(hs_pscore3) blockid(hs_block3) logit detail

//graph without dropping any observations in the matching process
psgraph, treated(rhs3d) pscore(hs_pscore3)
graph save `logpath'/psgraph_1_3 ,replace

//implement radius matching
gen logitpscore3=ln(hs_pscore3/(1-hs_pscore3))
sum logitpscore3

sca cal_ps3=r(sd)*0.02
sca list cal_ps3

//try 0.02* sd
psmatch2  rhs3d,outcome(s_cesdbetter) pscore(hs_pscore3) radius caliper(.01664182) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(rhs3d) pscore(hs_pscore3)
graph save `logpath'/psgraph_2_3 ,replace

histogram hs_pscore3 if _support==1, by(rhs3d) 

//look at balance of matched vs unmatched samples
pstest $matchvars ,treated(rhs3d) both hist
graph save `logpath'/psmatch_1_3 ,replace

//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age{
gen `v'_treated3 = `v' if rhs3d==1 & _support==1
gen `v'_comparison3 = `v' if rhs3d==0 & _support==1
qqplot `v'_treated3 `v'_comparison3
graph save `logpath'/qqplot_`v'_3, replace
}

mat vr=J(40,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $matchvars  {
sum `v' if rhs3d==1 //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if rhs3d==0 //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if rhs3d==1 & _support==1 //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if rhs3d==0 [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}

mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1"

mat list vr

//look at standardized differences to assess balance
//continuous variables
mat std_diff=J(40,5,.)
local i=1
foreach v in cc_all_count_12m_2 s_age {
sum `v' if rhs3d==1 & _support==1 //get mean,variance treated after matching
mat std_diff[`i',1]=r(mean)
mat std_diff[`i',2]=r(sd)

sum `v' if rhs3d==0 [iweight=_weight] //get mean,variance contl after matching
mat std_diff[`i',3]=r(mean)
mat std_diff[`i',4]=r(sd)

mat std_diff[`i',5]=(std_diff[`i',1]-std_diff[`i',3])/sqrt((std_diff[`i',2]^2+std_diff[`i',4]^2)/2) 
	
local i = `i'+1	
}
//indicator variables
local indvars cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y r_advdir_miss r_discuss_x r_srh_pf_n1 ///
 s_female s_white_e  s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1 

foreach v in `indvars' {
sum `v' if rhs3d==1 & _support==1 //get mean treated after matching
mat std_diff[`i',1]=r(mean)

sum `v' if rhs3d==0 [iweight=_weight] //get mean contl after matching
mat std_diff[`i',3]=r(mean)

mat std_diff[`i',5]=(std_diff[`i',1]-std_diff[`i',3])/sqrt((std_diff[`i',1]*(1-std_diff[`i',1])+std_diff[`i',3]*(1-std_diff[`i',3]))/2)
	
local i = `i'+1	
}

mat rownames std_diff="Count of comorbidities" "S age" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
 "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1" 

mat list std_diff
//standardized difference should be less than 10-25%


//using this matching, 9 obs from the treatment group are dropped b/c they are off support
//3 are dropped b/c not matched (weight=.)
//_support ==1 if matched
tab _support, missing
tab _support if rhs3d==1, missing
tab _support if rhs3d==0, missing
tab _weight if rhs3d==1, missing
sum _weight if rhs3d==0

//rename ps variables and save dataset so can call them up later
rename _support support_3
rename _weight weight_3

//now run using weighting , outcome = improved CESD score p1
//need to include the variables used in the propensity score
//we probably can't keep both spouse and r gender variables in
 
logit s_cesdbetter rhs3d `yearvars' $matchvars [iw=weight_3] , or 

outreg using `logpath'\spouse_analysis_sept2014, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score Decreased (by any amount) n1 to p1" \ ///
	"3+ days of hospice use = treatment, 0 days = control") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable


tab s_cesdbetter s_cesd_ge3better, missing

//Run logit with outcome=depressed n1, not depressed p1
logit s_cesd_ge3better rhs3d `yearvars' `new_varlist' [iw=weight_3] , or 

outreg using `logpath'\spouse_analysis_sept2014, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score 3+ n1 to less than 3 p1" \ ///
	"3+ days of hospice use = treatment, 0 days = control")  ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable

*****************************************************************************

*****************************************************************************

//End of 3 day definition , start 7 day definition section

*****************************************************************************

*****************************************************************************
	
	
*****************************************************************************
*****************************************************************************
//Using Stata's pscore to generate px scores - 7 day definition
*****************************************************************************
*****************************************************************************

//generate pscore variable hs_pscore
pscore rhs7d $matchvars  if rhs7d!=., pscore(hs_pscore7) blockid(hs_block7) logit detail

//graph without dropping any observations in the matching process
psgraph, treated(rhs7d) pscore(hs_pscore7)
graph save `logpath'/psgraph_1_7 ,replace

//implement radius matching
gen logitpscore7=ln(hs_pscore7/(1-hs_pscore7))
sum logitpscore7

sca cal_ps7=r(sd)*0.02
sca list cal_ps7

//try 0.02* sd
psmatch2  rhs7d,outcome(s_cesdbetter) pscore(hs_pscore7) radius caliper(.01738725) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(rhs7d) pscore(hs_pscore7)
graph save `logpath'/psgraph_2_7 ,replace

histogram hs_pscore7 if _support==1, by(rhs7d) 

//look at balance of matched vs unmatched samples
pstest $matchvars ,treated(rhs7d) both hist
graph save `logpath'/psmatch_1_7 ,replace

//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age{
gen `v'_treated7 = `v' if rhs7d==1 & _support==1
gen `v'_comparison7 = `v' if rhs7d==0 & _support==1
qqplot `v'_treated7 `v'_comparison7
graph save `logpath'/qqplot_`v'_7, replace
}

mat vr=J(40,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $matchvars  {
sum `v' if rhs7d==1 //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if rhs7d==0 //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if rhs7d==1 & _support==1 //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if rhs7d==0 [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}

mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1"

mat list vr

//look at standardized differences to assess balance
//continuous variables
mat std_diff=J(40,5,.)
local i=1
foreach v in cc_all_count_12m_2 s_age {
sum `v' if rhs7d==1 & _support==1 //get mean,variance treated after matching
mat std_diff[`i',1]=r(mean)
mat std_diff[`i',2]=r(sd)

sum `v' if rhs7d==0 [iweight=_weight] //get mean,variance contl after matching
mat std_diff[`i',3]=r(mean)
mat std_diff[`i',4]=r(sd)

mat std_diff[`i',5]=(std_diff[`i',1]-std_diff[`i',3])/sqrt((std_diff[`i',2]^2+std_diff[`i',4]^2)/2) 
	
local i = `i'+1	
}
//indicator variables
local indvars cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y r_advdir_miss r_discuss_x r_srh_pf_n1 ///
 s_female s_white_e  s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1 

foreach v in `indvars' {
sum `v' if rhs7d==1 & _support==1 //get mean treated after matching
mat std_diff[`i',1]=r(mean)

sum `v' if rhs7d==0 [iweight=_weight] //get mean contl after matching
mat std_diff[`i',3]=r(mean)

mat std_diff[`i',5]=(std_diff[`i',1]-std_diff[`i',3])/sqrt((std_diff[`i',1]*(1-std_diff[`i',1])+std_diff[`i',3]*(1-std_diff[`i',3]))/2)
	
local i = `i'+1	
}

mat rownames std_diff="Count of comorbidities" "S age" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
 "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1" 

mat list std_diff
//standardized difference should be less than 10-25%


//using this matching, 17 obs from the treatment group are dropped b/c they are off support
//1 is dropped b/c not matched (weight=.)
//_support ==1 if matched
tab _support, missing
tab _support if rhs7d==1, missing
tab _support if rhs7d==0, missing
tab _weight if rhs7d==1, missing
sum _weight if rhs7d==0

//rename ps variables so can call them up later
rename _support support_7
rename _weight weight_7

//now run using weighting , outcome = improved CESD score p1
//need to include the variables used in the propensity score
 
logit s_cesdbetter rhs7d `yearvars' $matchvars [iw=weight_7] , or 

outreg using `logpath'\spouse_analysis_sept2014, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score Decreased (by any amount) n1 to p1" \ ///
	"7+ days of hospice use = treatment, 0 days = control") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable


tab s_cesdbetter s_cesd_ge3better, missing

//Run logit with outcome=depressed n1, not depressed p1
logit s_cesd_ge3better rhs7d `yearvars' `new_varlist' [iw=weight_7] , or 

outreg using `logpath'\spouse_analysis_sept2014, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score 3+ n1 to less than 3 p1" \ ///
	"7+ days of hospice use = treatment, 0 days = control")  ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable
****************************************************************
	
****************************************************************
//run each dr regression in a row to get a single table with all of the results
****************************************************************

****************************************************************

//1+day definition, any cesd improvement
qui logit s_cesdbetter rhs12m `yearvars' $matchvars [iw=weight_1] , or 
outreg , store(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs12m) ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = S Depressive symptom improvement n1 to p1" \ ///
	"Control group = 0 days hospice use.") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	rtitles("Any improvement 1+day" ) ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat(N)

//1+day definition, clinical cesd improvement
qui logit s_cesd_ge3better rhs12m `yearvars' `new_varlist' [iw=weight_1] , or 
outreg , append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs12m) ///
	rtitles("Clinical improvement 1+day") ///
	varlabels starlevels(10 5 1)  summstat(N) 
	
//3+day definition, any cesd improvement
qui logit s_cesdbetter rhs3d `yearvars' $matchvars [iw=weight_3] , or 
outreg , append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs3d) ///
	rtitles("Any improvement 3+days" ) ///
	varlabels starlevels(10 5 1)  summstat(N) 
	
//3+day definition, clinical cesd improvement
qui logit s_cesd_ge3better rhs3d `yearvars' `new_varlist' [iw=weight_3] , or 
outreg , append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs3d) ///
	rtitles("Clinical improvement 3+days" ) ///
	varlabels starlevels(10 5 1)  summstat(N) 

//7+day definition, any cesd improvement
qui logit s_cesdbetter rhs7d `yearvars' $matchvars [iw=weight_7] , or 
outreg , append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs7d) ///
	rtitles("Any improvement 7+days" ) ///
	varlabels starlevels(10 5 1)  summstat(N) 
	
//7+day definition, clinical cesd improvement
qui logit s_cesd_ge3better rhs7d `yearvars' `new_varlist' [iw=weight_7] , or 
outreg using `logpath'\spouse_analysis_sept2014, append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs7d) ///
	rtitles("Clinical improvement 7+days" ) ///
	varlabels starlevels(10 5 1)  summstat(N) addtable	

****************************************************************
log close



H="Ivws before / after 12m"
capture log close

clear all
set mem 500m
set more off

//Amy's PC
local logpath E:\data\spouse\logs\sept2014
local datapath E:\data\spouse\final_data

log using "`logpath'\6c-HRS_Spouse_analysis_ivw_after_1yr.txt", text replace

cd `datapath'

use spouse_data_sample_v4.dta //if (s_1yr_p1_core_dead==0)

tab rhs3d r_advdir_miss if s_1yr_p1_core_dead==1, missing
tab rhs3d r_advdir_miss if s_1yr_p1_core_dead==0, missing

tab days_p1_core_dod_cat , missing

//Have to use an alternate variable list because missing category for
//advanced directive is all 0 for the treated group for where ivw 12+m after death
global matchvars2 cc_all_count_12m_2 cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y /*r_advdir_miss*/ r_discuss_x r_srh_pf_n1 ///
s_age s_female s_white_e  s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1 

//first sort data randomly
set seed 2000
gen x=uniform()
sort x

********************************************************************
********************************************************************
//Sample where ivw is 12+m after R's death
********************************************************************
********************************************************************
//generate pscore variable hs_pscore
pscore rhs3d $matchvars2 if s_1yr_p1_core_dead==0 & rhs3d!=., pscore(hs_pscore) blockid(hs_block) logit detail

//graph without dropping any observations in the matching process
psgraph, treated(rhs3d) pscore(hs_pscore)

//implement radius matching
gen logitpscore=ln(hs_pscore/(1-hs_pscore)) if s_1yr_p1_core_dead==0
sum logitpscore

sca cal_ps1=r(sd)*0.02
sca list cal_ps1

psmatch2  rhs3d if s_1yr_p1_core_dead==0,outcome(s_cesdbetter) pscore(hs_pscore) radius caliper(.02284198) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(rhs3d) pscore(hs_pscore)

histogram hs_pscore if _support==1, by(rhs3d) 

//look at balance of matched vs unmatched samples
pstest $matchvars2 if s_1yr_p1_core_dead==0,treated(rhs3d) both hist

pstest $matchvars2 if s_1yr_p1_core_dead==0,treated(rhs3d) both graph

//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age {
gen `v'_treated = `v' if rhs3d==1 & _support==1 & s_1yr_p1_core_dead==0
gen `v'_comparison = `v' if rhs3d==0 & _support==1 & s_1yr_p1_core_dead==0
qqplot `v'_treated `v'_comparison
}


mat vr=J(39,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $matchvars2  {
sum `v' if rhs3d==1 & s_1yr_p1_core_dead==0 //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if rhs3d==0 & s_1yr_p1_core_dead==0 //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if rhs3d==1 & _support==1 & s_1yr_p1_core_dead==0 //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if rhs3d==0 & s_1yr_p1_core_dead==0 [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}


mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y"  "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1" 

mat list vr

//6 from treated group are off common support, 6 control are not matched (weight==.)
//_support ==1 if matched
tab _support, missing
tab _support if rhs3d==1, missing
tab _support if rhs3d==0, missing
tab _weight if rhs3d==1, missing
sum _weight if rhs3d==0

rename _weight weight_after1yr

***********************************************************************
//now run logit model using weighting 
***********************************************************************
//need to include the variables used in the propensity score

tab r_death_year if s_1yr_p1_core_dead==0, missing
//one obs in 2010 so switch to 2009 for year fixed effects purposes

replace r_death_year=2009 if r_death_year==2010 & s_1yr_p1_core_dead==0
local yearvars ib2000.r_death_year 

logit s_cesdbetter i.rhs3d `yearvars' $matchvars2 [iw=weight_after1yr] if s_1yr_p1_core_dead==0, or 

outreg using `logpath'\ivw_time_groups_spouse_analysis, ///
	stats(e_b e_ci p) nosubstat  ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///
	"Limited to S p1 interview after 1 year of R's death" \ ///	
	"Outcome = CESD Score Decreased (by any amount) n1 to p1" \ ///
	"Hospice use = 3+ days, control=0 days") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse no comorbidities.") ///
	varlabels starlevels(10 5 1)  summstat( N) replace

//Run logit with outcome=depressed n1, not depressed p1
	

logit s_cesd_ge3better i.rhs3d `yearvars' $matchvars2 [iw=weight_after1yr] if s_1yr_p1_core_dead==0 , or 

outreg using `logpath'\ivw_time_groups_spouse_analysis, ///
	stats(e_b e_ci p) nosubstat  ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///
	"Limited to S p1 interview after 1 year of R's death" \ ///	
	"Outcome = CESD Score 3+ n1 to less than 3 p1" \ ///	
	"Hospice use = 3+ days, control=0 days") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse no comorbidities.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable


********************************************************************
********************************************************************
//Sample where ivw is 0-12m after R's death
********************************************************************
********************************************************************

//first sort data randomly
sort x

//generate pscore variable hs_pscore
pscore rhs3d $matchvars if s_1yr_p1_core_dead==1 & rhs3d!=., pscore(hs_pscore) blockid(hs_block) logit detail

//graph without dropping any observations in the matching process
//psgraph, treated(rhs3d) pscore(hs_pscore)

//implement radius matching
gen logitpscore_b=ln(hs_pscore/(1-hs_pscore)) if s_1yr_p1_core_dead==1
sum logitpscore_b

sca cal_ps_b=r(sd)*0.02
sca list cal_ps_b

psmatch2 rhs3d if s_1yr_p1_core_dead==1,outcome(s_cesdbetter) pscore(hs_pscore) radius caliper(.01693545) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(rhs3d) pscore(hs_pscore)

histogram hs_pscore if _support==1, by(rhs3d) 

//look at balance of matched vs unmatched samples
pstest $matchvars if s_1yr_p1_core_dead==1,treated(rhs3d) both hist

pstest $matchvars if s_1yr_p1_core_dead==1,treated(rhs3d) both graph

//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age {
gen `v'_treated_b = `v' if rhs3d==1 & _support==1 & s_1yr_p1_core_dead==1
gen `v'_comparison_b = `v' if rhs3d==0 & _support==1 & s_1yr_p1_core_dead==1
qqplot `v'_treated_b `v'_comparison_b
}


mat vr=J(40,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $matchvars  {
sum `v' if rhs3d==1 & s_1yr_p1_core_dead==1 //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if rhs3d==0 & s_1yr_p1_core_dead==1 //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if rhs3d==1 & _support==1 & s_1yr_p1_core_dead==1 //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if rhs3d==0 & s_1yr_p1_core_dead==1 [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}


mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Adv dir missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1" 

mat list vr

//3 from treated group are off common support, 2 control are not matched (weight==.)
//_support ==1 if matched
tab _support, missing
tab _support if rhs3d==1, missing
tab _support if rhs3d==0, missing
tab _weight if rhs3d==1, missing
sum _weight if rhs3d==0

rename _weight weight_bef1yr

***********************************************************************
//now run logit model using weighting 
***********************************************************************
//need to include the variables used in the propensity score

tab r_death_year if s_1yr_p1_core_dead==1, missing
//no observations in 2000 in this subsample so base = 2001 for these models

local yearvars ib2001.r_death_year 

logit s_cesdbetter i.rhs3d `yearvars' $matchvars [iw=weight_bef1yr] if s_1yr_p1_core_dead==1, or 

outreg using `logpath'\ivw_time_groups_spouse_analysis, ///
	stats(e_b e_ci p) nosubstat  ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///
	"Limited to S p1 interview within 1 year of R's death" \ ///	
	"Outcome = CESD Score Decreased (by any amount) n1 to p1" \ ///	
	"Hospice use = 3+ days, control=0 days") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse no comorbidities." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable

//Run logit with outcome=depressed n1, not depressed p1
	
logit s_cesd_ge3better i.rhs3d `yearvars' $matchvars [iw=weight_bef1yr] if s_1yr_p1_core_dead==1 , or 

outreg using `logpath'\ivw_time_groups_spouse_analysis, ///
	stats(e_b e_ci p) nosubstat  ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///
	"Limited to S p1 interview within 1 year of R's death" \ ///	
	"Outcome = CESD Score 3+ n1 to less than 3 p1" \ ///	
	"Hospice use = 3+ days, control=0 days") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse no comorbidities." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable

	
*****************************************************************************

*****************************************************************************

//End of overall sample  , start caregivers only section

*****************************************************************************

*****************************************************************************

***********************************************************************

//first sort data randomly
sort x

local cgafter (s_1yr_p1_core_dead==0 & (r_adl_sp_helper_x==1 | r_iadl_sp_helper_x==1))

//generate pscore variable hs_pscore
pscore rhs3d $matchvars2 if `cgafter' & rhs3d!=. , pscore(hs_pscore) blockid(hs_block) logit detail

//graph without dropping any observations in the matching process
//psgraph, treated(rhs3d) pscore(hs_pscore)

//implement radius matching
gen logitpscore_cga=ln(hs_pscore/(1-hs_pscore)) if `cgafter'
sum logitpscore_cga

sca cal_ps_cga=r(sd)*0.02
sca list cal_ps_cga

psmatch2  rhs3d  if `cgafter',outcome(s_cesdbetter) pscore(hs_pscore) radius caliper(.02405791) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(rhs3d) pscore(hs_pscore)

histogram hs_pscore if _support==1, by(rhs3d) 

//look at balance of matched vs unmatched samples
pstest $matchvars2  if `cgafter',treated(rhs3d) both hist

pstest $matchvars2  if `cgafter',treated(rhs3d) both graph

//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age {
gen `v'_treated_cga = `v' if rhs3d==1 & _support==1 & `cgafter'
gen `v'_compar_cga = `v' if rhs3d==0 & _support==1 & `cgafter'
qqplot `v'_treated_cga `v'_compar_cga
}


mat vr=J(39,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $matchvars2  {
sum `v' if rhs3d==1 & `cgafter' //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if rhs3d==0 & `cgafter' //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if rhs3d==1 & _support==1 & `cgafter' //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if rhs3d==0 & `cgafter' [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}

mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1" 

mat list vr

//13 from treated group are off common support, 5 control are not matched (weight==.)
//_support ==1 if matched
tab _support, missing
tab _support if rhs3d==1, missing
tab _support if rhs3d==0, missing
tab _weight if rhs3d==1, missing
sum _weight if rhs3d==0

rename _weight weight_cgafter1yr

***********************************************************************
//now run logit model using weighting 
***********************************************************************
//need to include the variables used in the propensity score
//we probably can't keep both spouse and r gender variables in

tab r_death_year  if `cgafter', missing

local yearvars ib2000.r_death_year 

logit s_cesdbetter i.rhs3d `yearvars' $matchvars2 [iw=weight_cgafter1yr] if `cgafter'  , or 

outreg using `logpath'\ivw_time_groups_spouse_analysis, ///
	stats(e_b e_ci p) nosubstat  ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///
	"Limited to S p1 interview after 1 year of R's death" \ ///	
	"Limited to Primary Caregiver spouses" \ ///
	"Outcome = CESD Score Decreased (by any amount) n1 to p1" \ ///
	"Hospice use = 3+ days, control=0 days") ///		
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse no comorbidities.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable

//Run logit with outcome=depressed n1, not depressed p1
//need alternate match variables since perfect prediction with r_adl_stable_partial_n1n2 variable
tab s_cesd_ge3better r_adl_stable_partial_n1n2 if `cgafter' & rhs3d==1
tab s_cesd_ge3better r_adl_stable_partial_n1n2 if `cgafter' & rhs3d==0

global matchvars3 cc_all_count_12m_2 cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 /*r_adl_stable_partial_n1n2*/ r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y /*r_advdir_miss*/ r_discuss_x r_srh_pf_n1 ///
s_age s_female s_white_e  s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1 	

logit s_cesd_ge3better i.rhs3d `yearvars' $matchvars3 [iw=weight_cgafter1yr] if `cgafter' , or 

outreg using `logpath'\ivw_time_groups_spouse_analysis, ///
	stats(e_b e_ci p) nosubstat  ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///
	"Limited to S p1 interview after 1 year of R's death" \ ///	
	"Limited to Primary Caregiver spouses" \ ///
	"Outcome = CESD Score 3+ n1 to less than 3 p1" \ ///	
	"Hospice use = 3+ days, control=0 days") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse no comorbidities.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable
	
	
***********************************************************************
***********************************************************************
//Now caregivers with interview within 12m of r's death
***********************************************************************
***********************************************************************
//first sort data randomly
sort x

local cgbefore (s_1yr_p1_core_dead==1 & (r_adl_sp_helper_x==1 | r_iadl_sp_helper_x==1))

//generate pscore variable hs_pscore
pscore rhs3d $matchvars if `cgbefore' & rhs3d!=. , pscore(hs_pscore) blockid(hs_block) logit detail

//graph without dropping any observations in the matching process
//psgraph, treated(rhs3d) pscore(hs_pscore)

//implement radius matching
gen logitpscore_cgb=ln(hs_pscore/(1-hs_pscore)) if `cgbefore'
sum logitpscore_cgb

sca cal_ps_cgb=r(sd)*0.02
sca list cal_ps_cgb

psmatch2  rhs3d  if `cgbefore',outcome(s_cesdbetter) pscore(hs_pscore) radius caliper(.018002) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(rhs3d) pscore(hs_pscore)

histogram hs_pscore if _support==1, by(rhs3d) 

//look at balance of matched vs unmatched samples
pstest $matchvars  if `cgbefore',treated(rhs3d) both hist

pstest $matchvars  if `cgbefore',treated(rhs3d) both graph

//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age {
gen `v'_treated_cgb = `v' if rhs3d==1 & _support==1 & `cgbefore'
gen `v'_compar_cgb = `v' if rhs3d==0 & _support==1 & `cgbefore'
qqplot `v'_treated_cgb `v'_compar_cgb
}


mat vr=J(40,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $matchvars  {
sum `v' if rhs3d==1 & `cgbefore' //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if rhs3d==0 & `cgbefore' //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if rhs3d==1 & _support==1 & `cgbefore' //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if rhs3d==0 & `cgbefore' [iweight=_weight]  //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}


mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Adv dir missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1" 

mat list vr

//5 from treated group are off common support, 0 control are not matched (weight==.)
//_support ==1 if matched
tab _support, missing
tab _support if rhs3d==1, missing
tab _support if rhs3d==0, missing
tab _weight if rhs3d==1, missing
sum _weight if rhs3d==0

rename _weight weight_cgbef1yr

***********************************************************************
//now run logit model using weighting 
***********************************************************************
//need to include the variables used in the propensity score
//we probably can't keep both spouse and r gender variables in

tab r_death_year if `cgbefore', missing
//no obs in 2000, base set to 2001

local yearvars ib2001.r_death_year 

logit s_cesdbetter i.rhs3d `yearvars' $matchvars [iw=weight_cgbef1yr] if `cgbefore', or 

outreg using `logpath'\ivw_time_groups_spouse_analysis, ///
	stats(e_b e_ci p) nosubstat  ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///
	"Limited to S p1 interview within 1 year of R's death" \ ///	
	"Limited to Primary Caregiver spouses" \ ///
	"Outcome = CESD Score Decreased (by any amount) n1 to p1" \ ///
	"Hospice use = 3+ days, control=0 days") ///		
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse no comorbidities." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable

//Run logit with outcome=depressed n1, not depressed p1
local cgbefore (s_1yr_p1_core_dead==1 & (r_adl_sp_helper_x==1 | r_iadl_sp_helper_x==1))

tab s_cesd_ge3better s_hrs_comorb_mod_n1 if `cgbefore', missing
tab s_cesd_ge3better r_advdir_miss if `cgbefore', missing

//omit missing adv directive and s moderate comorb variables
global matchvars4 cc_all_count_12m_2 cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y /*r_advdir_miss*/ r_discuss_x r_srh_pf_n1 ///
s_age s_female s_white_e  s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
s_hrs_comorb_mild_n1 /*s_hrs_comorb_mod_n1*/ s_psych_overall_hrs_n1 
/* ***This model doesn't run, get "Backed up" in log likelihood iterations after about 10 ****
logit s_cesd_ge3better i.rhs3d `yearvars' $matchvars4 [iw=weight_cgbef1yr] if `cgbefore', or 

outreg using `logpath'\ivw_time_groups_spouse_analysis, ///
	stats(e_b e_ci p) nosubstat  ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///
	"Limited to S p1 interview within 1 year of R's death" \ ///	
	"Limited to Primary Caregiver spouses" \ ///
	"Outcome = CESD Score 3+ n1 to less than 3 p1" \ ///
	"Hospice use = 3+ days, control=0 days") ///		
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse no comorbidities." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable
*/
****************************************************************
	
****************************************************************
//run each dr regression in a row to get a single table with all of the results
****************************************************************

****************************************************************

//all spouses with p1 ivws 12+m, any cesd improvement
qui logit s_cesdbetter rhs3d ib2000.r_death_year $matchvars2 [iw=weight_after1yr] if s_1yr_p1_core_dead==0, or 
outreg , store(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs3d) ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = S Depressive symptom improvement n1 to p1" \ ///
	"Sample split by p1 ivw timing 0-12m / 12m+ after R's death") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	rtitles("Any improvement, 12+m ivw" ) ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions." \ ///
	"P1 interviews 0-3m after r's death are included." \ ///
	"Hospice use = 3+ days, control=0 days") ///	
	varlabels starlevels(10 5 1)  summstat(N)

//all spouses with p1 ivws 12+m, clinical cesd improvement
qui logit s_cesd_ge3better rhs3d ib2000.r_death_year $matchvars2 [iw=weight_after1yr] if s_1yr_p1_core_dead==0 , or 
outreg , append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs3d) ///
	rtitles("Clinical improvement, 12+m ivw") ///
	varlabels starlevels(10 5 1)  summstat(N) 
	
//all spouses with p1 ivws 0-12m, any cesd improvement
qui logit s_cesdbetter rhs3d ib2001.r_death_year $matchvars [iw=weight_bef1yr] if s_1yr_p1_core_dead==1, or 
outreg , append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs3d) ///
	rtitles("Any improvement, 0-12m ivw" ) ///
	varlabels starlevels(10 5 1)  summstat(N) 
	
//all spouses with p1 ivws 0-12m, clinical cesd improvement
qui logit s_cesd_ge3better rhs3d ib2001.r_death_year $matchvars [iw=weight_bef1yr] if s_1yr_p1_core_dead==1 , or 
outreg , append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs3d) ///
	rtitles("Clinical improvement, 0-12m ivw" ) ///
	varlabels starlevels(10 5 1)  summstat(N) 

//caregivers 12+m, any cesd improvement
qui logit s_cesdbetter rhs3d ib2000.r_death_year $matchvars2 [iw=weight_cgafter1yr] if `cgafter'  , or 
outreg , append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs3d) ///
	rtitles("Caregivers, Any improvement, 12+m" ) ///
	varlabels starlevels(10 5 1)  summstat(N) 
	
//caregivers 12+m, clinical cesd improvement
qui logit s_cesd_ge3better rhs3d ib2000.r_death_year $matchvars3 [iw=weight_cgafter1yr] if `cgafter' , or 
outreg , append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs3d) ///
	rtitles("Caregivers, Clinical improvement, 12+m" ) ///
	varlabels starlevels(10 5 1)  summstat(N) 

//caregivers 0-12m, any cesd improvement
qui logit s_cesdbetter rhs3d ib2001.r_death_year $matchvars [iw=weight_cgbef1yr] if `cgbefore', or 
outreg , append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs3d) ///
	rtitles("Caregivers, Any improvement, 0-12m" ) ///
	varlabels starlevels(10 5 1)  summstat(N) 

//0-12m ivw, caregivers, clinical cesd improvement
/*qui logit s_cesd_ge3better rhs3d ib2001.r_death_year $matchvars4 [iw=weight_cgbef1yr] if `cgbefore', or 
outreg using `logpath'\ivw_time_groups_spouse_analysis, append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs3d) ///
	rtitles("Caregivers, clinical improvement, 0-12m" ) ///
	varlabels starlevels(10 5 1)  summstat(N) addtable	
*/
****************************************************************

	
*********************************************
log close


H="xxxxxxxxxxxxxxxxxxxxxxxxx"


H="Revision Dec 2014 JAMA Review Comments"
/*The following section use the propensity scores , sample in the section
"Allow p1 ivws 0-3m after R's death"

*/

capture log close

clear all
set mem 500m
set more off
set scheme s1color

local logpath E:\data\spouse\logs\dec2014
log using "`logpath'\10-HRS_Spouse_analysis_JAMA_comments_RG.txt", text replace

local datapath E:\data\spouse\final_data
cd `datapath'

//this dataset has weights from propensity scores previously generated
use spouse_data_sample_v3_august2014.dta
****************************************************************
tab rhs3d , missing
tab support_3 rhs3d, missing

***********************************************************************
***********************************************************************
//Table 3 - CESD score pre-post for matched sample
***********************************************************************
***********************************************************************
//new table to show mean ces-d scores
//create time variables for n2 cesd change score
gen s_days_n2_core_dead = r_death_date_e - s_c_ivw_date_n2 

//local timevars days_p1_core_dod_lt6m days_p1_core_dod_6_12m days_p1_core_dod_12_18m ///
//days_p1_core_dod_gt18mo

local cesdcont s_days_n2_core_dead s_days_n1_core_dead days_p1_core_dead ///
s_cesd_tot_n2 s_cesd_tot_n1 s_cesd_tot_p1 s_cesdchange

local scesdind s_cesd_tot_ge3_n2 s_cesd_tot_ge3_n1 ///
s_cesd_tot_ge3_p1 s_cesdbetter /*s_cesdsame s_cesdworse */  

la var s_days_n2_core_dead "Days S pre-death n2 interview to R death, mean"
la var s_days_n1_core_dead "Days S pre-death interview to R death, mean"
la var days_p1_core_dead "Days R death to S post-death interview, mean"
la var s_cesd_tot_n2 "CESD score n2 pre-death, mean"
la var s_cesd_tot_n1 "CESD score pre-death, mean"
la var s_cesd_tot_p1 "CESD score post-death, mean"
la var s_cesdchange "CESD score change, pre to post death, mean"

la var s_cesd_tot_ge3_n1 "Clinical depression n2, %"
la var s_cesd_tot_ge3_n1 "Clinical depression pre-death, %"
la var s_cesd_tot_ge3_p1 "Clinical depression post-death, %"

la var s_cesdbetter "% Improved CES-D symptoms"

//get n's
mat t3n=J(1,2,.)
tab rhs3d if support_3==1 & weight_3~=., missing matcell(n1)
mat t3n[1,1]=n1[2,1] //hospice users
mat t3n[1,2]=n1[1,1] //non-hospice users

mat rownames t3n="N"

frmttable, statmat(t3n) sdec(0) store(t3n)

foreach v in `cesdcont'{
	mat t3=J(1,3,.)
	sum `v' if rhs3d==1 [iweight=weight_3]
	mat t3[1,1]=r(mean)
	sum `v' if rhs3d==0 [iweight=weight_3]
	mat t3[1,2]=r(mean)
	logit rhs3d `v' [iweight=weight_3]
	test `v'
	mat t3[1,3]=r(p)

	mat rownames t3=`v'
	frmttable, statmat(t3) sdec(2,2,3) store(t3_1) varlabels

	outreg, replay(table3_1) append(t3_1) store(table3_1)
	}

outreg, replay(t3n) append(table3_1) store(table3_2)

foreach v in `scesdind'{
	mat t3=J(1,3,.)
	sum `v' if rhs3d==1 [iweight=weight_3]
	mat t3[1,1]=r(mean)*100
	sum `v' if rhs3d==0 [iweight=weight_3]
	mat t3[1,2]=r(mean)*100
	logit rhs3d `v' [iweight=weight_3]
	test `v'
	mat t3[1,3]=r(p)

	mat rownames t3=`v'
	frmttable, statmat(t3) sdec(2,2,3) store(t3_1) varlabels

	outreg, replay(table3_3) append(t3_1) store(table3_3)
}	


outreg using `logpath'\10_table3_JAMA_response, ///
replay(table3_2) append(table3_3) replace ///
title("Table 3 Mean CES-D Scores, Matched Sample") ///
ctitles("","Hopsice users","No hospice use","P-value") ///
note("Hospice use defined as 3+ days in last year of life" \ ///
"P-value for continuous variables from t-test, for binary variables from chi-sq")

//change for those with reduced symptoms
sum s_cesdchange if rhs3d==1 & s_cesdbetter==1 [iweight=weight_3]
sum s_cesdchange if rhs3d==0 & s_cesdbetter==1 [iweight=weight_3]
//test
logit rhs3d s_cesdchange if s_cesdbetter==1 [iweight=weight_3]
test s_cesdchange

****************************************************************
****************************************************************
//quick figure for %improved ces-d score hospice vs non-hospice
preserve
collapse (mean) s_cesdbetter (sd) sd_better=s_cesdbetter (count) n=s_cesdbetter [iweight=weight_3], by(rhs3d)
//get confidence intervals
gen hibetter=s_cesdbetter + invttail(n-1,0.025)*(sd_better/sqrt(n))
gen lobetter=s_cesdbetter - invttail(n-1,0.025)*(sd_better/sqrt(n))

la def hospice 0 "No hospice use" 1 "Hospice use"
la val rhs3d hospice 

//version without ci's 
graph bar s_cesdbetter , over(rhs3d) ///
ytitle("Percent with Improved CES-D Score") ///
ylabel(.1 "10%" .2 "20%" .3 "30%") ///
subtitle("Improved spousal depressive symptoms by hospice use") 
graph save `logpath'\10_JAMA_small_image.gph, replace
graph export `logpath'\10_JAMA_small_image.eps, replace
graph export `logpath'\10_JAMA_small_image.tif, replace

//adding ci's using twoway
twoway (bar s_cesdbetter rhs3d) (rcap hibetter lobetter rhs3d)
restore
****************************************************************
****************************************************************
//check gender same sex couples
 tab  r_female  s_female, missing

//check time from interview date to death (by hospice status or not)
bys rhs3d: sum s_days_n1_core_dead  [iweight=weight_3]

tab days_p1_core_dead [iweight=weight_3]
****************************************************************
****************************************************************
//Check difference in pre-matching sample size if use alternative
//variable construction for the married at death sample selection criteria
clear all

//need to recreate sample with new definition based on raw responses in exit interview
//dataset is full spouse decedent dataset with sample criteria variables added
//created in section "Define Sample"
use spouse_data_full_v1.dta if n1core_ind==1 & r_xwalk_yes==1 & ins_ind==1 & ///
 /*r_married_or_part_v2_x==1 &*/ sp1core_ind==1 & sn1core_ind==1 & ///
 no_cc_12m_excl_cataract==0 & sudden_cause_death==0 & proxy_n1_or_p1==0 & cesd_miss_n1_p1==0

tab r_married_x r_married_or_part_v2_x, missing

//do variable cleaning necessary to recreate ds dropping obs with missingness in covariates
//fill in missing gender for spouse gender variable
tab s_female, missing
//use spouse p1 interview to fill in missing gender
replace s_female=s_female_p1 if s_female==.
la var s_female "S Female"
la def fem 0 "Male" 1 "Female"
la val s_female r_female fem
tab s_female, missing

//s education
gen s_educ = s_educ_n1
replace s_educ = s_educ_n2 if (s_educ_n1==.)
replace s_educ = s_educ_n3 if (s_educ_n1==. & s_educ_n2==.)
label variable s_educ "S's Eduction, Highest Level, imputed from all interviews"
label define s_educ 0 "No Formal Education" 1 "Grades 1-11" 2 "High School" 3 "Some College" 4 "College" ///
      5 "Post College", modify
label values s_educ s_educ 
tab s_educ, missing

//create s hs degree variable
gen byte s_hseduc_n1_n3 = .
replace s_hseduc_n1_n3=0 if inlist(s_educ,0,1)
replace s_hseduc_n1_n3=1 if inlist(s_educ,2,3,4,5)
la var s_hseduc_n1_n3 "S HS Degree using n1-n3 core, 1=yes"
la def hs 0 "No HS degree" 1 "HS Degree"
la val s_hseduc_n1_n3  hs
tab s_hseduc_n1_n3, missing

tab r_advdir_x , missing
gen r_advdir_y = 0
replace r_advdir_y = 1 if r_advdir_x ==1
gen r_advdir_n = 0
replace r_advdir_n = 1 if r_advdir_x ==0
gen r_advdir_miss = 0
replace r_advdir_miss = 1 if r_advdir_x ==2

replace r_discuss_x=. if r_discuss_x==9
tab r_discuss_x, missing

//create dichotomous vars for comorbidity index categories
gen byte s_hrs_comorb_none_n1 = .
replace s_hrs_comorb_none_n1=1 if s_comor_c_hrs_n1==0
replace s_hrs_comorb_none_n1=0 if s_comor_c_hrs_n1!=0 & s_comor_c_hrs_n1!=.
la var s_hrs_comorb_none_n1 "Comorbidity index ind - none"

gen byte s_hrs_comorb_mild_n1 = .
replace s_hrs_comorb_mild_n1 =1 if s_comor_c_hrs_n1==1
replace s_hrs_comorb_mild_n1 =0 if s_comor_c_hrs_n1!=1 & s_comor_c_hrs_n1!=.
la var s_hrs_comorb_mild_n1 "Comorbidity index ind - mild 1-3"

gen byte s_hrs_comorb_mod_n1 = .
replace s_hrs_comorb_mod_n1=1 if s_comor_c_hrs_n1==2
replace s_hrs_comorb_mod_n1=0 if s_comor_c_hrs_n1!=2 & s_comor_c_hrs_n1!=.
la var s_hrs_comorb_mod_n1 "Comorbidity index ind - moderate 4-6"

gen byte s_hrs_comorb_sev_n1 = .
replace s_hrs_comorb_sev_n1=1 if s_comor_c_hrs_n1==3
replace s_hrs_comorb_sev_n1=0 if s_comor_c_hrs_n1!=3 & s_comor_c_hrs_n1!=.
la var s_hrs_comorb_sev_n1 "Comorbidity index ind - severe 7+"


global matchvars cc_all_count_12m_2 cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y r_advdir_miss r_discuss_x r_srh_pf_n1 ///
s_age s_female s_white_e  s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1	

//drop observations with missing covariates (24 obs)
//n=1025
foreach v of varlist $matchvars {
tab `v', missing
drop if `v'==.
}

sum s_core_year_n1
tab r_married_x r_married_or_part_v2_x, missing

gen orig_sample=0
replace orig_sample=1 if r_married_x==1
gen alt_sample=0
replace alt_sample=1 if r_married_or_part_v2_x==1 
tab orig_sample alt_sample

//look at gender for these additional observations
tab r_female_x s_female if (orig_sample==0 & alt_sample==1) , missing

****************************************************************
log close


H="Try ps match with helper variables"
/*runs 2 versions of propensity score matching on the sample used for the paper
sent to JAMA
1. adds indicators for the following 4 categories related to helper burden:
no helper exit interview
at least 1 helper exit interview ,not in n1 interivew
at least 1 helper exit + n1 interview, not in n2 interview
at least 1 helper exit + n1 + n2
Runs this for 1d, 3d and 7d hospice definitions, this version is used for following
sections running new versions of all of the tables for the paper in case they are needed
2. Adds helper categories in 1. above and indicator for death expected from exit interview
note this starting sample is smaller  b/c of missingness in death expected variable
*/
capture log close

clear all
set mem 500m
set more off
set scheme s1color

local logpath E:\data\spouse\logs\dec2014
log using "`logpath'\11-HRS_Spouse_analysis_helper_cntl.txt", text replace

local datapath E:\data\spouse\final_data
cd `datapath'

//ds  saved in Allow p1 ivws 0-3m after R's death section
use spouse_data_sample_v3.dta, replace

*************************************************************************
tab rhs3d , missing

//create indicator for any adl or iadl helper
foreach w in x n1 n2{
tab r_adl_helper_count_`w', missing
tab r_iadl_helper_count_`w', missing
gen byte r_any_helper_`w'=0 if r_adl_helper_count_`w'==0 & r_iadl_helper_count_`w'==0
replace r_any_helper_`w'=1 if (r_adl_helper_count_`w'>0 & r_adl_helper_count_`w'!=.) ///
	| (r_iadl_helper_count_`w'>0 & r_iadl_helper_count_`w'!=.)
label var r_any_helper_`w' "Any helper with ADL/IADL's wave `w' 1=yes"
tab r_any_helper_`w', missing
}

//look at who has helpers different waves
gen r_any_help_cat = 0 if r_any_helper_x==0
replace r_any_help_cat = 1 if r_any_helper_x==1 & r_any_helper_n1==0
replace r_any_help_cat = 2 if r_any_helper_x==1 & r_any_helper_n1==1 & (r_any_helper_n2==0|r_any_helper_n2==.)
replace r_any_help_cat = 3 if r_any_helper_x==1 & r_any_helper_n1==1 & r_any_helper_n2==1
tab r_any_help_cat, gen(r_any_help_ind) missing

la var r_any_help_ind1 "No helper exit"
la var r_any_help_ind2 "Helper exit only"
la var r_any_help_ind3 "Helper exit and n1"
la var r_any_help_ind4 "Helper exit, n1 and n2"

gen r_any_help_not_exit=0
replace r_any_help_not_exit=1 if r_any_helper_x==0 & (r_any_helper_n1==1 | r_any_helper_n2==1)
tab r_any_help_not_exit, missing

gen r_n2_not_n1=0
replace r_n2_not_n1=1 if r_any_helper_n2==1 & r_any_helper_n1==0
tab r_n2_not_n1 r_any_helper_x, missing

pwcorr r_any_help_ind1 r_any_help_ind2 r_any_help_ind3 r_any_help_ind4 ///
r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss
*************************************************************************
//sort and generate the propensity score
//version with helper variables added
*************************************************************************
//first sort data randomly
set seed 2000
gen x=uniform()
sort x

*****************************************************************************
** User note: To update variables used in matching for this section, update list here
*****************************************************************************
global match_w_helper cc_all_count_12m_2 cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y r_advdir_miss r_discuss_x r_srh_pf_n1 ///
r_any_help_ind2 r_any_help_ind3 r_any_help_ind4 s_age s_female s_white_e  s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1	

//generate pscore variable hs_pscore
pscore rhs3d $match_w_helper, pscore(hs_pscore) blockid(hs_block) logit detail

//implement radius matching
gen logitpscore=ln(hs_pscore/(1-hs_pscore))
sum logitpscore

sca cal_ps1=r(sd)*0.02
sca list cal_ps1

***************************************************************************************
** User Note: If change variable list or sample, need to update the caliper here
***************************************************************************************
//try 0.02* sd
psmatch2  rhs3d,outcome(s_cesdbetter) pscore(hs_pscore) radius caliper(.0199049) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(rhs3d) pscore(hs_pscore)
graph save `logpath'/psgraph_2 ,replace

//look at balance of matched vs unmatched samples
pstest $match_w_helper ,treated(rhs3d) both hist

***************************************************************************************
** User Note: If change list of continuous variables, need to update the list here
** to create qqplots here
***************************************************************************************
//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age{
gen `v'_treated = `v' if rhs3d==1 & _support==1
gen `v'_comparison = `v' if rhs3d==0 & _support==1
qqplot `v'_treated `v'_comparison
graph save `logpath'/qqplot_`v', replace
}

***************************************************************************************
** User Note: If change number of variables in list above 
** matrix size needs to be adjusted
***************************************************************************************
mat vr=J(43,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $match_w_helper  {
sum `v' if rhs3d==1 //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if rhs3d==0 //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if rhs3d==1 & _support==1 //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if rhs3d==0 [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}

***************************************************************************************
** User Note: If change variable list, update rownames here to match
***************************************************************************************
mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"R Helper exit only" "R Helper Exit+n1" "R Helper exit+n1+n2" ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1"

mat list vr

***************************************************************************************
** User Note: If change variable list / caliper, then these counts in comments can change
***************************************************************************************
//using this matching, 4 obs from the treatment group are dropped b/c they are off support
//1 dropped b/c not matched (weight=.)
//_support ==1 if matched
tab _support, missing
tab _support if rhs3d==1, missing
tab _support if rhs3d==0, missing
tab _weight if rhs3d==1, missing
sum _weight if rhs3d==0

rename _support support_3
rename _weight weight_3

***************************************************************************************
//now run using weighting , outcome = improved CESD score p1
//need to include the variables used in the propensity score

local yearvars ib2000.r_death_year 
 
logit s_cesdbetter rhs3d `yearvars' $match_w_helper [iw=weight_3] , or 

outreg using `logpath'\spouse_analysis_dec2014, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score Decreased (by any amount) n1 to p1") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat( N) replace

tab s_cesdbetter s_cesd_ge3better, missing

//Run logit with outcome=depressed n1, not depressed p1
logit s_cesd_ge3better rhs3d `yearvars' $match_w_helper [iw=weight_3] , or 

outreg using `logpath'\spouse_analysis_dec2014, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score 3+ n1 to less than 3 p1") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable

*************************************************************************
*************************************************************************
//1+ day hospice use definition
*************************************************************************
*************************************************************************
tab rhs12m, missing

sort x

//generate pscore variable hs_pscore
pscore rhs12m $match_w_helper, pscore(hs_pscore1) blockid(hs_block1) logit detail

//implement radius matching
gen logitpscore1=ln(hs_pscore1/(1-hs_pscore1))
sum logitpscore1

sca cal_ps1=r(sd)*0.02
sca list cal_ps1

***************************************************************************************
** User Note: If change variable list or sample, need to update the caliper here
***************************************************************************************
//try 0.02* sd
psmatch2 rhs12m ,outcome(s_cesdbetter) pscore(hs_pscore1) radius caliper(.02001881) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(rhs12m) pscore(hs_pscore1)
graph save `logpath'/psgraph_2_1d ,replace

//look at balance of matched vs unmatched samples
pstest $match_w_helper ,treated(rhs12m) both hist

***************************************************************************************
** User Note: If change list of continuous variables, need to update the list here
** to create qqplots here
***************************************************************************************
//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age{
gen `v'_treated1 = `v' if rhs12m==1 & _support==1
gen `v'_comparison1 = `v' if rhs12m==0 & _support==1
qqplot `v'_treated1 `v'_comparison1
graph save `logpath'/qqplot_`v'_1d, replace
}

***************************************************************************************
** User Note: If change number of variables in list above 
** matrix size needs to be adjusted
***************************************************************************************
mat vr=J(43,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $match_w_helper  {
sum `v' if rhs12m==1 //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if rhs12m==0 //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if rhs12m==1 & _support==1 //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if rhs12m==0 [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}

***************************************************************************************
** User Note: If change variable list, update rownames here to match
***************************************************************************************
mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"R Helper exit only" "R Helper Exit+n1" "R Helper exit+n1+n2" ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1"

mat list vr

***************************************************************************************
** User Note: If change variable list / caliper, then these counts in comments can change
***************************************************************************************
//using this matching, 4 obs from the treatment group are dropped b/c they are off support
//1 dropped b/c not matched (weight=.)
//_support ==1 if matched
tab _support, missing
tab _support if rhs12m==1, missing
tab _support if rhs12m==0, missing
tab _weight if rhs12m==1, missing
sum _weight if rhs12m==0

rename _support support_1
rename _weight weight_1

***************************************************************************************
//now run using weighting , outcome = improved CESD score p1
//need to include the variables used in the propensity score

local yearvars ib2000.r_death_year 
 
logit s_cesdbetter rhs12m `yearvars' $match_w_helper [iw=weight_1] , or 

outreg using `logpath'\spouse_analysis_dec2014, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score Decreased (by any amount) n1 to p1") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable

tab s_cesdbetter s_cesd_ge3better, missing

//Run logit with outcome=depressed n1, not depressed p1
logit s_cesd_ge3better rhs12m `yearvars' $match_w_helper [iw=weight_1] , or 

outreg using `logpath'\spouse_analysis_dec2014, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score 3+ n1 to less than 3 p1") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable

*************************************************************************
*************************************************************************
//7+ day hospice use definition
*************************************************************************
*************************************************************************
tab rhs7d, missing

sort x

//generate pscore variable hs_pscore
pscore rhs7d $match_w_helper, pscore(hs_pscore7) blockid(hs_block7) logit detail

//implement radius matching
gen logitpscore7=ln(hs_pscore7/(1-hs_pscore7))
sum logitpscore7

sca cal_ps7=r(sd)*0.02
sca list cal_ps7

***************************************************************************************
** User Note: If change variable list or sample, need to update the caliper here
***************************************************************************************
//try 0.02* sd
psmatch2 rhs7d ,outcome(s_cesdbetter) pscore(hs_pscore7) radius caliper(.02402862) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(rhs7d) pscore(hs_pscore7)
graph save `logpath'/psgraph_2_7d ,replace

//look at balance of matched vs unmatched samples
pstest $match_w_helper ,treated(rhs7d) both hist

***************************************************************************************
** User Note: If change list of continuous variables, need to update the list here
** to create qqplots here
***************************************************************************************
//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age{
gen `v'_treated7 = `v' if rhs7d==1 & _support==1
gen `v'_comparison7 = `v' if rhs7d==0 & _support==1
qqplot `v'_treated7 `v'_comparison7
graph save `logpath'/qqplot_`v'_7d, replace
}

***************************************************************************************
** User Note: If change number of variables in list above 
** matrix size needs to be adjusted
***************************************************************************************
mat vr=J(43,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $match_w_helper  {
sum `v' if rhs7d==1 //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if rhs7d==0 //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if rhs7d==1 & _support==1 //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if rhs7d==0 [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}

***************************************************************************************
** User Note: If change variable list, update rownames here to match
***************************************************************************************
mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"R Helper exit only" "R Helper Exit+n1" "R Helper exit+n1+n2" ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1"

mat list vr

***************************************************************************************
** User Note: If change variable list / caliper, then these counts in comments can change
***************************************************************************************
//using this matching, 8 obs from the treatment group are dropped b/c they are off support
//0 dropped b/c not matched (weight=.)
//_support ==1 if matched
tab _support, missing
tab _support if rhs7d==1, missing
tab _support if rhs7d==0, missing
tab _weight if rhs7d==1, missing
sum _weight if rhs7d==0

rename _support support_7
rename _weight weight_7

***************************************************************************************
//now run using weighting , outcome = improved CESD score p1
//need to include the variables used in the propensity score

local yearvars ib2000.r_death_year 
 
logit s_cesdbetter rhs7d `yearvars' $match_w_helper [iw=weight_7] , or 

outreg using `logpath'\spouse_analysis_dec2014, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score Decreased (by any amount) n1 to p1") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable

tab s_cesdbetter s_cesd_ge3better, missing

//Run logit with outcome=depressed n1, not depressed p1
logit s_cesd_ge3better rhs7d `yearvars' $match_w_helper [iw=weight_7] , or 

outreg using `logpath'\spouse_analysis_dec2014, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score 3+ n1 to less than 3 p1") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable

****************************************************************
	
****************************************************************
//run each dr regression in a row to get a single table with all of the results
****************************************************************

****************************************************************

//1+day definition, any cesd improvement
qui logit s_cesdbetter rhs12m `yearvars' $match_w_helper [iw=weight_1] , or 
outreg , store(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs12m) ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = S Depressive symptom improvement n1 to p1" \ ///
	"Control group = 0 days hospice use.") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	rtitles("Any improvement 1+day" ) ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions.") ///
	varlabels starlevels(10 5 1)  summstat(N)

//1+day definition, clinical cesd improvement
qui logit s_cesd_ge3better rhs12m `yearvars' $match_w_helper [iw=weight_1] , or 
outreg , append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs12m) ///
	rtitles("Clinical improvement 1+day") ///
	varlabels starlevels(10 5 1)  summstat(N) 
	
//3+day definition, any cesd improvement
qui logit s_cesdbetter rhs3d `yearvars' $match_w_helper [iw=weight_3] , or 
outreg , append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs3d) ///
	rtitles("Any improvement 3+days" ) ///
	varlabels starlevels(10 5 1)  summstat(N) 
	
//3+day definition, clinical cesd improvement
qui logit s_cesd_ge3better rhs3d `yearvars' $match_w_helper [iw=weight_3] , or 
outreg , append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs3d) ///
	rtitles("Clinical improvement 3+days" ) ///
	varlabels starlevels(10 5 1)  summstat(N) 

//7+day definition, any cesd improvement
qui logit s_cesdbetter rhs7d `yearvars' $match_w_helper [iw=weight_7] , or 
outreg , append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs7d) ///
	rtitles("Any improvement 7+days" ) ///
	varlabels starlevels(10 5 1)  summstat(N) 
	
//7+day definition, clinical cesd improvement
qui logit s_cesd_ge3better rhs7d `yearvars' $match_w_helper [iw=weight_7] , or 
outreg using `logpath'\spouse_analysis_dec2014, append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs7d) ///
	rtitles("Clinical improvement 7+days" ) ///
	varlabels starlevels(10 5 1)  summstat(N) addtable	

****************************************************************
//save ds with the propensity scores/weights
save spouse_data_sample_v3_psdec2014.dta, replace

*************************************************************************
*************************************************************************
//sort and generate the propensity score
//version with helper + death expected variables added
*************************************************************************
*************************************************************************
tab r_dexp_x, missing
drop if r_dexp_x==.
//first sort data randomly
drop x
set seed 2000
gen x=uniform()
sort x

drop hs_pscore hs_block logitpscore

//generate pscore variable hs_pscore
pscore rhs3d $match_w_helper r_dexp_x, pscore(hs_pscore) blockid(hs_block) logit detail

//implement radius matching
gen logitpscore=ln(hs_pscore/(1-hs_pscore))
sum logitpscore

sca cal_ps1=r(sd)*0.02
sca list cal_ps1

***************************************************************************************
** User Note: If change variable list or sample, need to update the caliper here
***************************************************************************************
//try 0.02* sd
psmatch2  rhs3d,outcome(s_cesdbetter) pscore(hs_pscore) radius caliper(.02788316) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(rhs3d) pscore(hs_pscore)
graph save `logpath'/psgraph_dexp_2 ,replace

//look at balance of matched vs unmatched samples
pstest $match_w_helper r_dexp_x ,treated(rhs3d) both hist

***************************************************************************************
** User Note: If change list of continuous variables, need to update the list here
** to create qqplots here
***************************************************************************************
//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age{
drop `v'_treated `v'_comparison
gen `v'_treated = `v' if rhs3d==1 & _support==1
gen `v'_comparison = `v' if rhs3d==0 & _support==1
qqplot `v'_treated `v'_comparison
//graph save `logpath'/qqplot_`v', replace
}

***************************************************************************************
** User Note: If change number of variables in list above 
** matrix size needs to be adjusted
***************************************************************************************
mat vr=J(44,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $match_w_helper r_dexp_x {
sum `v' if rhs3d==1 //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if rhs3d==0 //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if rhs3d==1 & _support==1 //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if rhs3d==0 [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}

***************************************************************************************
** User Note: If change variable list, update rownames here to match
***************************************************************************************
mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"R Helper exit only" "R Helper Exit+n1" "R Helper exit+n1+n2" ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1" "R Death Expected"

mat list vr

***************************************************************************************
** User Note: If change variable list / caliper, then these counts in comments can change
***************************************************************************************
//using this matching, 4 obs from the treatment group are dropped b/c they are off support
//1 dropped b/c not matched (weight=.)
//_support ==1 if matched
tab _support, missing
tab _support if rhs3d==1, missing
tab _support if rhs3d==0, missing
tab _weight if rhs3d==1, missing
sum _weight if rhs3d==0

***************************************************************************************
//now run using weighting , outcome = improved CESD score p1
//need to include the variables used in the propensity score

local yearvars ib2000.r_death_year 
 
logit s_cesdbetter rhs3d `yearvars' $match_w_helper r_dexp_x [iw=_weight] , or 

outreg using `logpath'\spouse_analysis_dec2014, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score Decreased (by any amount) n1 to p1" \ ///
	"R's death expected variable added") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable

tab s_cesdbetter s_cesd_ge3better, missing

//Run logit with outcome=depressed n1, not depressed p1
logit s_cesd_ge3better rhs3d `yearvars' $match_w_helper r_dexp_x [iw=_weight] , or 

outreg using `logpath'\spouse_analysis_dec2014, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score 3+ n1 to less than 3 p1" \ ///
	"R's death expected variable added") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable

tab s_female r_dexp_x, chi2 
pwcorr s_female r_dexp_x
tab s_female s_cesdbetter [iw=_weight]
pwcorr s_female r_any_help_cat 
pwcorr s_female r_any_help_ind1  r_any_help_ind2 r_any_help_ind3 r_any_help_ind4

tab s_female r_any_help_cat , chi2
*************************************************************************
log close


H="Table 2 - including helper timing var, excl death expected"
/* *******Run with new sample definition, allows for p1 interview *****
******* within 90 days of R's death                    *************

Creates Paper Table 2 
Refer to Section "Allow p1 ivws 0-3m after R's death" and "Revised tables 1 & 2" for 
other tables in paper

Hospice users definition: 3+ days / non users: 0-2 days

See format changes in tables from KO received on 9/18/14*/

capture log close

clear all
set mem 500m
set more off
set scheme s1color

//Amy's PC
local logpath E:\data\spouse\logs\dec2014
local datapath E:\data\spouse\final_data

log using "`logpath'\11b-HRS_Spouse_analysis_helper_cntl-tables.txt", text replace

cd `datapath'

use spouse_data_sample_v3_psdec2014.dta

*******************************************************
tab rhs3d , missing

gen non_hosp3=1 if rhs3d==0
replace non_hosp3=0 if rhs3d==1
tab non_hosp3 rhs3d, missing

gen r_adl_improv_stab_i_n1n2 = 0
replace r_adl_improv_stab_i_n1n2  = 1 if r_adl_stable_ind_n1n2==1 | r_adl_improved_n1n2==1 
tab r_adl_improv_stab_i_n1n2 , missing

*************************************************************************************
*************************************************************************************
//Create Table 2, Decedent and Spouse PS Score Matching Variables
//Col 1-3: Unweighted, unmatched sample
//Col 4-6: Weighted and matched sample
*************************************************************************************
*************************************************************************************

local t2vars1 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 r_nw_highest_n1 ///
r_medicaid_n1 r_champus_n1 r_medigap_n1 r_nhres_n1 r_advdir_y r_advdir_n ///
r_discuss_x r_srh_pf_n1 ///
r_adl_improv_stab_i_n1n2 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 ///
r_any_help_ind1 r_any_help_ind2 r_any_help_ind3 r_any_help_ind4 ///
cc_3_alzhdmta_n12mn0 ///
cc_6_chrnkidn_n12mn0 cc_ami_isch_n12mn0 cc_8_chf_n12mn0 ///
cc_9_diabetes_n12mn0 cc_7_copd_n12mn0 cc_16_strketia_n12mn0 ///
cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 cc_11_hipfrac_n12mn0 ///
cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 cc_15_ra_oa_n12mn0

local t2vars2 cc_all_count_12m_2 s_age 

local t2vars3 s_female s_white_e  s_hseduc_n1_n3 ///
s_srh_pf_n1 s_imprelig_vimp_n1 s_hrs_comorb_none_n1 ///
s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1	

la var r_nw_lowest_n1 "Net Worth, 1 (low) Quartile, %"
la var r_nw_midlow_n1  "Net Worth, 2 Quartile, %"
la var r_nw_midhigh_n1  "Net Worth, 3 Quartile, %"
la var r_nw_highest_n1  "Net Worth, 4 (high) Quartile, %"
la var r_medicaid_n1  "Medicaid, %"
la var r_champus_n1  "VA Insurance, %"
la var r_medigap_n1 "Medigap, %"
la var r_nhres_n1 "Nursing home resident pre-death, %"
la var r_advdir_y "Had advanced directive, %**"
la var r_advdir_n "Did not have advance directive, %**"
la var r_discuss_x "Discussion of EOL care, %"
la var r_srh_pf_n1 "SRH poor or fair, %"
la var r_adl_independent_core_n1 "ADL Independent pre-death, %"
la var r_adl_improv_stab_i_n1n2 "Impr or Indep in ADLs n2 to n1, %"
la var r_adl_stable_partial_n1n2 "Stable Moderate 1-3 ADL, %" 
la var r_adl_stable_severe_n1n2 "Stable Severe 4-6 ADL, %" 
la var r_adl_change_i_m_n1n2 "Declined, Indep to Moderate, %"
la var r_adl_change_m_s_n1n2 "Declined Moderate to Severe, %" 
la var r_adl_change_i_s_n1n2 "Declined Independent to Severe n2-n1, %" 

la var r_any_help_ind1 "No helper exit, %"
la var r_any_help_ind2 "Helper exit only, %"
la var r_any_help_ind3 "Helper exit and n1, %"
la var r_any_help_ind4 "Helper exit, n1 and n2, %"

la var cc_all_count_12m_2 "Number of chronic conditions, mean (SD)"

la var s_age "Age at spouse's death, years, mean (SD)"
la var s_female "Female, %"
la var s_white_e "Race, Non-Hispanic, White, %"
la var s_hseduc_n1_n3 "Education, High School Grad, %"
la var s_srh_pf_n1 "SRH poor or fair, %"
la var s_imprelig_vimp_n1 "Religion very important, %"

la var s_hrs_comorb_none_n1 "Comorbidities, none, %"
la var s_hrs_comorb_mild_n1 "Mild (1-3), %"
la var s_hrs_comorb_mod_n1 "Moderate (4-6), %"
la var s_psych_overall_hrs_n1 "Psychological problems, %"

//part 1, n unmatched
mat t2_1=J(1,3,.)
tab rhs3d , missing matcell(d1)
mat t2_1[1,1]=d1[2,1] //non-hospice n
mat t2_1[1,2]=d1[1,1] //hospice users n
mat rownames t2_1="Sample n"

frmttable, statmat(t2_1) varlabels ///
	sdec(0) store(tab2_1) 	

//part 2, decedent char, % and std difference
mat t2_2=J(35,3,.)

local r = 1
foreach v in `t2vars1'{
	local c = 1
	foreach h in rhs3d non_hosp3 {
		sum `v' if `h'==1, detail
		mat t2_2[`r',`c']=r(mean)*100
		local c = `c'+1		
	}
	mat t2_2[`r',3]=(t2_2[`r',1]/100-t2_2[`r',2]/100)/sqrt((t2_2[`r',1]/100* ///
		(1-t2_2[`r',1]/100)+t2_2[`r',2]/100*(1-t2_2[`r',2]/100))/2)
	local r = `r'+1
}
mat rownames t2_2=`t2vars1'
frmttable, statmat(t2_2) varlabels ///
	sdec(2) store(tab2_2) 	

//part 3, cont vars r & s, mean and std diff
mat t2_3=J(2,5,.)

local r = 1
foreach v in `t2vars2'{
	local c = 1
	foreach h in rhs3d non_hosp3 {
		sum `v' if `h'==1, detail
		mat t2_3[`r',`c']=r(mean)
		mat t2_3[`r',`c'+1]=r(sd)
		local c = `c'+2		
	}
	mat t2_3[`r',5]=(t2_3[`r',1]-t2_3[`r',3])/sqrt((t2_3[`r',2]^2+t2_3[`r',4]^2)/2) 
	local r = `r'+1
}

mat rownames t2_3=`t2vars2'

mat dmat=(0,1,0,1,0)
mat ann=(1,1,0\1,1,0)
mat list dmat
mat list ann

mat list t2_3

frmttable, statmat(t2_3) varlabels ///
	sdec(2) doubles(dmat) ///
	dbldiv(" (") annotate(ann) asymbol(")") ///
	store(tab2_3) 

//part 4, spouse char, %
mat t2_4=J(9,3,.)

local r = 1
foreach v in `t2vars3'{
	local c = 1
	foreach h in rhs3d non_hosp3 {
		sum `v' if `h'==1, detail
		mat t2_4[`r',`c']=r(mean)*100
		local c = `c'+1		
	}
	mat t2_4[`r',3]=(t2_4[`r',1]/100-t2_4[`r',2]/100)/sqrt((t2_4[`r',1]/100* ///
		(1-t2_4[`r',1]/100)+t2_4[`r',2]/100*(1-t2_4[`r',2]/100))/2)

	local r = `r'+1
}

mat rownames t2_4=`t2vars3'
frmttable, statmat(t2_4) varlabels ///
	sdec(2) store(tab2_4) 	

outreg, replay(tab2_1) append(tab2_2) store(tab2_a)
outreg, replay(tab2_a) append(tab2_3) store(tab2_b)
outreg, replay(tab2_b) append(tab2_4) store(tab2_c) //complete unmatched table w/ std diff

***************************************************************
//end of unmatched sample, start matched sample
***************************************************************
//part 1, n matched
mat t2_1m=J(1,3,.)
tab rhs3d if weight_3!=., missing matcell(d1)
mat t2_1m[1,1]=d1[2,1] //non-hospice n
mat t2_1m[1,2]=d1[1,1] //hospice users n
mat rownames t2_1m="Sample n"

frmttable, statmat(t2_1m) varlabels ///
	sdec(0) store(tab2_1m) 	

//part 2, decedent char, % and std difference
mat t2_2m=J(35,3,.)

local r = 1
foreach v in `t2vars1'{
	local c = 1
	foreach h in rhs3d non_hosp3 {
		sum `v' if `h'==1 [iweight=weight_3]
		mat t2_2m[`r',`c']=r(mean)*100
		local c = `c'+1		
	}
	mat t2_2m[`r',3]=(t2_2m[`r',1]/100-t2_2m[`r',2]/100)/sqrt((t2_2m[`r',1]/100* ///
		(1-t2_2m[`r',1]/100)+t2_2m[`r',2]/100*(1-t2_2m[`r',2]/100))/2)
	local r = `r'+1
}
mat rownames t2_2m=`t2vars1'
frmttable, statmat(t2_2m) varlabels ///
	sdec(2) store(tab2_2m) 	

//part 3, cont vars r & s, mean and std diff
mat t2_3m=J(2,5,.)

local r = 1
foreach v in `t2vars2'{
	local c = 1
	foreach h in rhs3d non_hosp3 {
		sum `v' if `h'==1 [iweight=weight_3]
		mat t2_3m[`r',`c']=r(mean)
		mat t2_3m[`r',`c'+1]=r(sd)
		local c = `c'+2		
	}
	mat t2_3m[`r',5]=(t2_3m[`r',1]-t2_3m[`r',3])/sqrt((t2_3m[`r',2]^2+t2_3m[`r',4]^2)/2) 
	local r = `r'+1
}

mat rownames t2_3m=`t2vars2'

mat dmat=(0,1,0,1,0)
mat ann=(1,1,0\1,1,0)
mat list dmat
mat list ann

mat list t2_3

frmttable, statmat(t2_3m) varlabels ///
	sdec(2) doubles(dmat) ///
	dbldiv(" (") annotate(ann) asymbol(")") ///
	store(tab2_3m) 

//part 4, spouse char, %
mat t2_4m=J(9,3,.)

local r = 1
foreach v in `t2vars3'{
	local c = 1
	foreach h in rhs3d non_hosp3 {
		sum `v' if `h'==1 [iweight=weight_3]
		mat t2_4m[`r',`c']=r(mean)*100
		local c = `c'+1		
	}
	mat t2_4m[`r',3]=(t2_4m[`r',1]/100-t2_4m[`r',2]/100)/sqrt((t2_4m[`r',1]/100* ///
		(1-t2_4m[`r',1]/100)+t2_4m[`r',2]/100*(1-t2_4m[`r',2]/100))/2)

	local r = `r'+1
}

mat rownames t2_4m=`t2vars3'
frmttable, statmat(t2_4m) varlabels ///
	sdec(2) store(tab2_4m) 	

outreg, replay(tab2_1m) append(tab2_2m) store(tab2_am)
outreg, replay(tab2_am) append(tab2_3m) store(tab2_bm)
outreg, replay(tab2_bm) append(tab2_4m) store(tab2_cm) //complete matched table w/ std diff

//combine unmatched and match tables
outreg using "`logpath'\spo_tab1and2_dec2014", ///
 replay(tab2_c) merge(tab2_cm) ///
 title("Table 2: Decedent and spouse characteristics used in propensity score matching, by hospice use status") ///
 ctitles("","Unmatched sample","","","Matched sample","","" \ ///
    "","Hospice users","No hospice use","Standardized Difference(%)", ///
    "Hospice users","No hospice use","Standardized Difference(%)") ///
 note("** Not all categories add up to 100% due to rounding and missing data.") ///
 landscape replace


***********************************************************************
//for matched sample, do overall cesd scores improve??
***********************************************************************
mat quicktab2=J(3,2,.)

local i = 1
foreach v in s_cesd_tot_n1 s_cesd_tot_p1{
	sum `v' [iweight=weight_3]
	mat quicktab2[`i',1]=r(mean)
	mat quicktab2[`i',2]=r(sd)
	local i = `i'+1
}

sum s_cesdbetter [iweight=weight_3]
mat quicktab2[`i',1]=r(mean)
local sample = r(N)

mat rownames quicktab2="Raw CES-D pre-death" "Raw CES-D post-death" "CES-D Improved?"

frmttable using `logpath'\spo_tab1and2_dec2014, statmat(quicktab2) ///
title("Matched sample CES-D, n=`sample'") ///
ctitle("","Mean or Percent" "SD" ) ///
sdec(3,2,0) addtable

mat list quicktab2
***********************************************************************
//test of cesd improved hospice vs non hospice in the matched sample

mat quicktab3=J(2,3,.)
tab rhs3d if weight_3!=., matcell(r1)
mat quicktab3[1,2]=r1[1,1]
mat quicktab3[1,1]=r1[2,1]

sum s_cesdbetter if rhs3d==1 [iweight=weight_3]
mat quicktab3[2,1]=r(mean)*100
sum s_cesdbetter if rhs3d==0 [iweight=weight_3]
mat quicktab3[2,2]=r(mean)*100

logit rhs3d s_cesdbetter [iweight=weight_3]
test s_cesdbetter 
mat quicktab3[2,3]=r(p) //p value from chisq test

frmttable using `logpath'\spo_tab1and2_dec2014, statmat(quicktab3) ///
title("Matched sample CES-D Improvement, n=`sample'") ///
ctitle("","Hospice, %", "No hospice, %" "P-value" ) ///
rtitle("n"\"CES-D Improved") sdec(0\2) addtable

***********************************************************************
log close


H="Table 2 - includes helper timing and death expected"


H="Caregivers"
/*
Runs the models for the helper subsample only

Outcome variables are: CESD improvement indicator, ie any improvement 
in CESD score from n1 to p1
And CESD clinical improvement 3+ to <3 n1 to p1

This Stata code runs following analyses:
1. Determines propensity scores
2. Runs summary tables for r and s characteristics using px weighting
3. Px matched logit regression on reduced spouse depressive symptoms 

Runs 3 versions
1. Hospice users: 1+ days / non users: 0 days
2. Hospice users: 3+ days / non users: 0-2 days
3. Hospice users: 7+ days / non users: 0-6 days*/

capture log close

clear all
set mem 500m
set more off
set scheme s1color

//Amy's PC
local logpath E:\data\spouse\logs\dec2014\helper
local datapath E:\data\spouse\final_data

//RG PC
//local logpath C:\data\Spouse\logs
//local datapath C:\data\Spouse

log using "`logpath'\6-HRS_Spouse_analysis_helper_dec2014.txt", text replace

cd `datapath'

use spouse_data_sample_v3.dta if (r_adl_sp_helper_x==1 | r_iadl_sp_helper_x==1) 

*****************************************************************************
*****************************************************************************
//Set up variables and dataset
*****************************************************************************
*****************************************************************************
tab rhs3d , missing

//create indicator for any adl or iadl helper
foreach w in x n1 n2{
tab r_adl_helper_count_`w', missing
tab r_iadl_helper_count_`w', missing
gen byte r_any_helper_`w'=0 if r_adl_helper_count_`w'==0 & r_iadl_helper_count_`w'==0
replace r_any_helper_`w'=1 if (r_adl_helper_count_`w'>0 & r_adl_helper_count_`w'!=.) ///
	| (r_iadl_helper_count_`w'>0 & r_iadl_helper_count_`w'!=.)
label var r_any_helper_`w' "Any helper with ADL/IADL's wave `w' 1=yes"
tab r_any_helper_`w', missing
}

//look at who has helpers different waves
gen r_any_help_cat = 0 if r_any_helper_x==0 //no observations meet this criteria in this sub-set of the data
replace r_any_help_cat = 1 if r_any_helper_x==1 & r_any_helper_n1==0
replace r_any_help_cat = 2 if r_any_helper_x==1 & r_any_helper_n1==1 & (r_any_helper_n2==0|r_any_helper_n2==.)
replace r_any_help_cat = 3 if r_any_helper_x==1 & r_any_helper_n1==1 & r_any_helper_n2==1
tab r_any_help_cat, gen(r_any_help_ind) missing

la var r_any_help_ind1 "Helper exit only"
la var r_any_help_ind2 "Helper exit and n1"
la var r_any_help_ind3 "Helper exit, n1 and n2"

//this list is different from previous section because no one in the
//caregiver sample had no helper in the exit wave, so catogory omitted
global match_w_helper cc_all_count_12m_2 cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y r_advdir_miss r_discuss_x r_srh_pf_n1 ///
r_any_help_ind2 r_any_help_ind3 s_age s_female s_white_e  s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1	

//first sort data randomly
set seed 2000
gen x=uniform()
sort x

*****************************************************************************
*****************************************************************************
//Using Stata's pscore to generate px scores - 1 day definition
*****************************************************************************
*****************************************************************************

//generate pscore variable hs_pscore
pscore rhs12m $match_w_helper, pscore(hs_pscore) blockid(hs_block) logit detail

//graph without dropping any observations in the matching process
psgraph, treated(rhs12m) pscore(hs_pscore)
graph save `logpath'/psgraph_1 ,replace

//implement radius matching
gen logitpscore=ln(hs_pscore/(1-hs_pscore))
sum logitpscore

sca cal_ps1=r(sd)*0.02
sca list cal_ps1

//try 0.02* sd
psmatch2  rhs12m,outcome(s_cesdbetter) pscore(hs_pscore) radius caliper(.0164166) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(rhs12m) pscore(hs_pscore)
graph save `logpath'/psgraph_2 ,replace

histogram hs_pscore if _support==1, by(rhs12m) 

//look at balance of matched vs unmatched samples
pstest $match_w_helper ,treated(rhs12m) both hist
graph save `logpath'/psmatch_1 ,replace

//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age{
gen `v'_treated = `v' if rhs12m==1 & _support==1
gen `v'_comparison = `v' if rhs12m==0 & _support==1
qqplot `v'_treated `v'_comparison
graph save `logpath'/qqplot_`v', replace
}

mat vr=J(42,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $match_w_helper  {
sum `v' if rhs12m==1 //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if rhs12m==0 //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if rhs12m==1 & _support==1 //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if rhs12m==0 [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}

mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"R Helper Exit+n1" "R Helper exit+n1+n2" ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1"

mat list vr

//using this matching, 9 obs from the treatment group are dropped b/c they are off support
//2 are dropped b/c not matched (weight=.)
//_support ==1 if matched
tab _support, missing
tab _support if rhs12m==1, missing
tab _support if rhs12m==0, missing
tab _weight if rhs12m==1, missing
sum _weight if rhs12m==0

//rename ps variables and save dataset so can call them up later
rename _support support_1
rename _weight weight_1

//now run using weighting , outcome = improved CESD score p1
//need to include the variables used in the propensity score

local yearvars ib2000.r_death_year 
 
logit s_cesdbetter rhs12m `yearvars' $match_w_helper [iw=weight_1] , or 

outreg using `logpath'\spouse_analysis_dec2014, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score Decreased (by any amount) n1 to p1") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat( N) replace


tab s_cesdbetter s_cesd_ge3better, missing

//Run logit with outcome=depressed n1, not depressed p1
//Need alternative variable list excluding advanced directive missing status b/c
//it predicts the outcome (failure)
tab s_cesd_ge3better r_advdir_miss if weight_1!=., missing

local new_varlist cc_all_count_12m_2 cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y /*r_advdir_miss*/ r_discuss_x r_srh_pf_n1 ///
 r_any_help_ind2 r_any_help_ind3 ///
s_age s_female s_white_e  s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1 

logit s_cesd_ge3better rhs12m `yearvars' `new_varlist' [iw=weight_1] , or 

outreg using `logpath'\spouse_analysis_dec2014, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score 3+ n1 to less than 3 p1") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable

*****************************************************************************

*****************************************************************************

//End of 1 day definition , start 3 day definition section

*****************************************************************************

*****************************************************************************
	
	
*****************************************************************************
*****************************************************************************
//Using Stata's pscore to generate px scores - 3 day definition
*****************************************************************************
*****************************************************************************

//generate pscore variable hs_pscore
pscore rhs3d $match_w_helper, pscore(hs_pscore3) blockid(hs_block3) logit detail

//graph without dropping any observations in the matching process
psgraph, treated(rhs3d) pscore(hs_pscore3)
graph save `logpath'/psgraph_1_3 ,replace

//implement radius matching
gen logitpscore3=ln(hs_pscore3/(1-hs_pscore3))
sum logitpscore3

sca cal_ps3=r(sd)*0.02
sca list cal_ps3

//try 0.02* sd
psmatch2  rhs3d,outcome(s_cesdbetter) pscore(hs_pscore3) radius caliper(.01554243) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(rhs3d) pscore(hs_pscore3)
graph save `logpath'/psgraph_2_3 ,replace

histogram hs_pscore3 if _support==1, by(rhs3d) 

//look at balance of matched vs unmatched samples
pstest $match_w_helper ,treated(rhs3d) both hist
graph save `logpath'/psmatch_1_3 ,replace

//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age{
gen `v'_treated3 = `v' if rhs3d==1 & _support==1
gen `v'_comparison3 = `v' if rhs3d==0 & _support==1
qqplot `v'_treated3 `v'_comparison3
graph save `logpath'/qqplot_`v'_3, replace
}

mat vr=J(42,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $match_w_helper  {
sum `v' if rhs3d==1 //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if rhs3d==0 //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if rhs3d==1 & _support==1 //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if rhs3d==0 [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}

mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"R Helper Exit+n1" "R Helper exit+n1+n2" ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1"

mat list vr

//using this matching, 8 obs from the treatment group are dropped b/c they are off support
//6 are dropped b/c not matched (weight=.)
//_support ==1 if matched
tab _support, missing
tab _support if rhs3d==1, missing
tab _support if rhs3d==0, missing
tab _weight if rhs3d==1, missing
sum _weight if rhs3d==0

//rename ps variables and save dataset so can call them up later
rename _support support_3
rename _weight weight_3

//now run using weighting , outcome = improved CESD score p1
//need to include the variables used in the propensity score
//we probably can't keep both spouse and r gender variables in
 
logit s_cesdbetter rhs3d `yearvars' $match_w_helper [iw=weight_3] , or 

outreg using `logpath'\spouse_analysis_dec2014, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score Decreased (by any amount) n1 to p1" \ ///
	"3+ days of hospice use = treatment, 0-2 days = control") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable


tab s_cesdbetter s_cesd_ge3better, missing

//Run logit with outcome=depressed n1, not depressed p1
logit s_cesd_ge3better rhs3d `yearvars' `new_varlist' [iw=weight_3] , or 

outreg using `logpath'\spouse_analysis_dec2014, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score 3+ n1 to less than 3 p1" \ ///
	"3+ days of hospice use = treatment, 0-2 days = control")  ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable

*****************************************************************************

*****************************************************************************

//End of 3 day definition , start 7 day definition section

*****************************************************************************

*****************************************************************************
	
	
*****************************************************************************
*****************************************************************************
//Using Stata's pscore to generate px scores - 7 day definition
*****************************************************************************
*****************************************************************************

//generate pscore variable hs_pscore
pscore rhs7d $match_w_helper, pscore(hs_pscore7) blockid(hs_block7) logit detail

//graph without dropping any observations in the matching process
psgraph, treated(rhs7d) pscore(hs_pscore7)
graph save `logpath'/psgraph_1_7 ,replace

//implement radius matching
gen logitpscore7=ln(hs_pscore7/(1-hs_pscore7))
sum logitpscore7

sca cal_ps7=r(sd)*0.02
sca list cal_ps7

//try 0.02* sd
psmatch2  rhs7d,outcome(s_cesdbetter) pscore(hs_pscore7) radius caliper(.01575732) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(rhs7d) pscore(hs_pscore7)
graph save `logpath'/psgraph_2_7 ,replace

histogram hs_pscore7 if _support==1, by(rhs7d) 

//look at balance of matched vs unmatched samples
pstest $match_w_helper ,treated(rhs7d) both hist
graph save `logpath'/psmatch_1_7 ,replace

//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age{
gen `v'_treated7 = `v' if rhs7d==1 & _support==1
gen `v'_comparison7 = `v' if rhs7d==0 & _support==1
qqplot `v'_treated7 `v'_comparison7
graph save `logpath'/qqplot_`v'_7, replace
}

mat vr=J(42,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $match_w_helper  {
sum `v' if rhs7d==1 //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if rhs7d==0 //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if rhs7d==1 & _support==1 //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if rhs7d==0 [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}

mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Advance directive missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"R Helper Exit+n1" "R Helper exit+n1+n2" ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1"

mat list vr

//using this matching, 14 obs from the treatment group are dropped b/c they are off support
//1 is dropped b/c not matched (weight=.)
//_support ==1 if matched
tab _support, missing
tab _support if rhs7d==1, missing
tab _support if rhs7d==0, missing
tab _weight if rhs7d==1, missing
sum _weight if rhs7d==0

//rename ps variables and save dataset so can call them up later
rename _support support_7
rename _weight weight_7

//now run using weighting , outcome = improved CESD score p1
//need to include the variables used in the propensity score
 
logit s_cesdbetter rhs7d `yearvars' $match_w_helper [iw=weight_7] , or 

outreg using `logpath'\spouse_analysis_dec2014, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score Decreased (by any amount) n1 to p1" \ ///
	"7+ days of hospice use = treatment, 0-6 days = control") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable


tab s_cesdbetter s_cesd_ge3better, missing

//Run logit with outcome=depressed n1, not depressed p1
logit s_cesd_ge3better rhs7d `yearvars' `new_varlist' [iw=weight_7] , or 

outreg using `logpath'\spouse_analysis_dec2014, ///
	stats(e_b e_ci p) nosubstat ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = CESD Score 3+ n1 to less than 3 p1" \ ///
	"7+ days of hospice use = treatment, 0-6 days = control")  ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable
****************************************************************
	
****************************************************************
//run each dr regression in a row to get a single table with all of the results
****************************************************************

****************************************************************

//1+day definition, any cesd improvement
qui logit s_cesdbetter rhs12m `yearvars' $match_w_helper [iw=weight_1] , or 
outreg , store(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs12m) ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = S Depressive symptom improvement n1 to p1") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	rtitles("Any improvement 1+day" ) ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat(N)

//1+day definition, clinical cesd improvement
qui logit s_cesd_ge3better rhs12m `yearvars' `new_varlist' [iw=weight_1] , or 
outreg , append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs12m) ///
	rtitles("Clinical improvement 1+day") ///
	varlabels starlevels(10 5 1)  summstat(N) 
	
//3+day definition, any cesd improvement
qui logit s_cesdbetter rhs3d `yearvars' $match_w_helper [iw=weight_3] , or 
outreg , append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs3d) ///
	rtitles("Any improvement 3+days" ) ///
	varlabels starlevels(10 5 1)  summstat(N) 
	
//3+day definition, clinical cesd improvement
qui logit s_cesd_ge3better rhs3d `yearvars' `new_varlist' [iw=weight_3] , or 
outreg , append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs3d) ///
	rtitles("Clinical improvement 3+days" ) ///
	varlabels starlevels(10 5 1)  summstat(N) 

//7+day definition, any cesd improvement
qui logit s_cesdbetter rhs7d `yearvars' $match_w_helper [iw=weight_7] , or 
outreg , append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs7d) ///
	rtitles("Any improvement 7+days" ) ///
	varlabels starlevels(10 5 1)  summstat(N) 
	
//7+day definition, clinical cesd improvement
qui logit s_cesd_ge3better rhs7d `yearvars' `new_varlist' [iw=weight_7] , or 
outreg using `logpath'\spouse_analysis_dec2014, append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs7d) ///
	rtitles("Clinical improvement 7+days" ) ///
	varlabels starlevels(10 5 1)  summstat(N) addtable	

****************************************************************
log close



H="Ivws before / after 12m"
capture log close

clear all
set mem 500m
set more off

//Amy's PC
local logpath E:\data\spouse\logs\dec2014
local datapath E:\data\spouse\final_data

log using "`logpath'\11c-HRS_Spouse_analysis_ivw_after_1yr.txt", text replace

cd `datapath'

use spouse_data_sample_v3.dta //if (s_1yr_p1_core_dead==0)

tab rhs3d r_advdir_miss if s_1yr_p1_core_dead==1, missing
tab rhs3d r_advdir_miss if s_1yr_p1_core_dead==0, missing

tab days_p1_core_dod_cat , missing

//create indicator for any adl or iadl helper
foreach w in x n1 n2{
tab r_adl_helper_count_`w', missing
tab r_iadl_helper_count_`w', missing
gen byte r_any_helper_`w'=0 if r_adl_helper_count_`w'==0 & r_iadl_helper_count_`w'==0
replace r_any_helper_`w'=1 if (r_adl_helper_count_`w'>0 & r_adl_helper_count_`w'!=.) ///
	| (r_iadl_helper_count_`w'>0 & r_iadl_helper_count_`w'!=.)
label var r_any_helper_`w' "Any helper with ADL/IADL's wave `w' 1=yes"
tab r_any_helper_`w', missing
}

//look at who has helpers different waves
gen r_any_help_cat = 0 if r_any_helper_x==0 
replace r_any_help_cat = 1 if r_any_helper_x==1 & r_any_helper_n1==0
replace r_any_help_cat = 2 if r_any_helper_x==1 & r_any_helper_n1==1 & (r_any_helper_n2==0|r_any_helper_n2==.)
replace r_any_help_cat = 3 if r_any_helper_x==1 & r_any_helper_n1==1 & r_any_helper_n2==1
tab r_any_help_cat, gen(r_any_help_ind) missing

la var r_any_help_ind1 "No helper exit"
la var r_any_help_ind2 "Helper exit only"
la var r_any_help_ind3 "Helper exit and n1"
la var r_any_help_ind4 "Helper exit, n1 and n2"


//Have to use an alternate variable list because missing category for
global match_w_helper cc_all_count_12m_2 cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y r_advdir_miss r_discuss_x r_srh_pf_n1 ///
r_any_help_ind2 r_any_help_ind3 r_any_help_ind4 s_age s_female s_white_e  s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1
 
//advanced directive is all 0 for the treated group for where ivw 12+m after death
global match_w_helper2 cc_all_count_12m_2 cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y /*r_advdir_miss*/ r_discuss_x r_srh_pf_n1 ///
r_any_help_ind2 r_any_help_ind3 r_any_help_ind4 s_age s_female s_white_e  s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1	

//first sort data randomly
set seed 2000
gen x=uniform()
sort x

********************************************************************
********************************************************************
//Sample where ivw is 12+m after R's death
********************************************************************
********************************************************************
//generate pscore variable hs_pscore
pscore rhs3d $match_w_helper2 if s_1yr_p1_core_dead==0, pscore(hs_pscore) blockid(hs_block) logit detail

//graph without dropping any observations in the matching process
psgraph, treated(rhs3d) pscore(hs_pscore)

//implement radius matching
gen logitpscore=ln(hs_pscore/(1-hs_pscore)) if s_1yr_p1_core_dead==0
sum logitpscore

sca cal_ps1=r(sd)*0.02
sca list cal_ps1

psmatch2  rhs3d if s_1yr_p1_core_dead==0,outcome(s_cesdbetter) pscore(hs_pscore) radius caliper(.02386483) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(rhs3d) pscore(hs_pscore)

histogram hs_pscore if _support==1, by(rhs3d) 

//look at balance of matched vs unmatched samples
pstest $match_w_helper2 if s_1yr_p1_core_dead==0,treated(rhs3d) both hist

//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age {
gen `v'_treated = `v' if rhs3d==1 & _support==1 & s_1yr_p1_core_dead==0
gen `v'_comparison = `v' if rhs3d==0 & _support==1 & s_1yr_p1_core_dead==0
qqplot `v'_treated `v'_comparison
}


mat vr=J(42,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $match_w_helper2  {
sum `v' if rhs3d==1 & s_1yr_p1_core_dead==0 //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if rhs3d==0 & s_1yr_p1_core_dead==0 //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if rhs3d==1 & _support==1 & s_1yr_p1_core_dead==0 //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if rhs3d==0 & s_1yr_p1_core_dead==0 [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}


mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y"  "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"R Helper exit only" "R Helper Exit+n1" "R Helper exit+n1+n2" ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1" 

mat list vr

//10 from treated group are off common support, 2 control are not matched (weight==.)
//_support ==1 if matched
tab _support, missing
tab _support if rhs3d==1, missing
tab _support if rhs3d==0, missing
tab _weight if rhs3d==1, missing
sum _weight if rhs3d==0

rename _weight weight_after1yr

***********************************************************************
//now run logit model using weighting 
***********************************************************************
//need to include the variables used in the propensity score

tab r_death_year if s_1yr_p1_core_dead==0, missing
//one obs in 2010 so switch to 2009 for year fixed effects purposes

replace r_death_year=2009 if r_death_year==2010 & s_1yr_p1_core_dead==0
local yearvars ib2000.r_death_year 

logit s_cesdbetter i.rhs3d `yearvars' $match_w_helper2 [iw=weight_after1yr] if s_1yr_p1_core_dead==0, or 

outreg using `logpath'\ivw_time_groups_spouse_analysis, ///
	stats(e_b e_ci p) nosubstat  ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///
	"Limited to S p1 interview after 1 year of R's death" \ ///	
	"Outcome = CESD Score Decreased (by any amount) n1 to p1") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse no comorbidities.") ///
	varlabels starlevels(10 5 1)  summstat( N) replace

//Run logit with outcome=depressed n1, not depressed p1
logit s_cesd_ge3better i.rhs3d `yearvars' $match_w_helper2 [iw=weight_after1yr] if s_1yr_p1_core_dead==0 , or 

outreg using `logpath'\ivw_time_groups_spouse_analysis, ///
	stats(e_b e_ci p) nosubstat  ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///
	"Limited to S p1 interview after 1 year of R's death" \ ///	
	"Outcome = CESD Score 3+ n1 to less than 3 p1" ) ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse no comorbidities.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable


********************************************************************
********************************************************************
//Sample where ivw is 0-12m after R's death
********************************************************************
********************************************************************
drop hs_pscore hs_block
//first sort data randomly
sort x

//generate pscore variable hs_pscore
pscore rhs3d $match_w_helper if s_1yr_p1_core_dead==1, pscore(hs_pscore) blockid(hs_block) logit detail

//graph without dropping any observations in the matching process
//psgraph, treated(rhs3d) pscore(hs_pscore)

//implement radius matching
gen logitpscore_b=ln(hs_pscore/(1-hs_pscore)) if s_1yr_p1_core_dead==1
sum logitpscore_b

sca cal_ps_b=r(sd)*0.02
sca list cal_ps_b

psmatch2 rhs3d if s_1yr_p1_core_dead==1,outcome(s_cesdbetter) pscore(hs_pscore) radius caliper(.02276316) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(rhs3d) pscore(hs_pscore)

histogram hs_pscore if _support==1, by(rhs3d) 

//look at balance of matched vs unmatched samples
pstest $match_w_helper if s_1yr_p1_core_dead==1,treated(rhs3d) both hist

//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age {
gen `v'_treated_b = `v' if rhs3d==1 & _support==1 & s_1yr_p1_core_dead==1
gen `v'_comparison_b = `v' if rhs3d==0 & _support==1 & s_1yr_p1_core_dead==1
qqplot `v'_treated_b `v'_comparison_b
}


mat vr=J(43,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $match_w_helper  {
sum `v' if rhs3d==1 & s_1yr_p1_core_dead==1 //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if rhs3d==0 & s_1yr_p1_core_dead==1 //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if rhs3d==1 & _support==1 & s_1yr_p1_core_dead==1 //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if rhs3d==0 & s_1yr_p1_core_dead==1 [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}


mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Adv dir missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"R Helper exit only" "R Helper Exit+n1" "R Helper exit+n1+n2" ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1" 

mat list vr

//1 from treated group are off common support, 2 control are not matched (weight==.)
//_support ==1 if matched
tab _support, missing
tab _support if rhs3d==1, missing
tab _support if rhs3d==0, missing
tab _weight if rhs3d==1, missing
sum _weight if rhs3d==0

rename _weight weight_bef1yr

***********************************************************************
//now run logit model using weighting 
***********************************************************************
//need to include the variables used in the propensity score

tab r_death_year if s_1yr_p1_core_dead==1, missing
//no observations in 2000 in this subsample so base = 2001 for these models

local yearvars ib2001.r_death_year 

logit s_cesdbetter i.rhs3d `yearvars' $match_w_helper [iw=weight_bef1yr] if s_1yr_p1_core_dead==1, or 

outreg using `logpath'\ivw_time_groups_spouse_analysis, ///
	stats(e_b e_ci p) nosubstat  ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///
	"Limited to S p1 interview within 1 year of R's death" \ ///	
	"Outcome = CESD Score Decreased (by any amount) n1 to p1") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse no comorbidities." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable

//Run logit with outcome=depressed n1, not depressed p1
	
logit s_cesd_ge3better i.rhs3d `yearvars' $match_w_helper [iw=weight_bef1yr] if s_1yr_p1_core_dead==1 , or 

outreg using `logpath'\ivw_time_groups_spouse_analysis, ///
	stats(e_b e_ci p) nosubstat  ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///
	"Limited to S p1 interview within 1 year of R's death" \ ///	
	"Outcome = CESD Score 3+ n1 to less than 3 p1" ) ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse no comorbidities." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable

	/*
*****************************************************************************

*****************************************************************************

//End of overall sample  , start caregivers only section

*****************************************************************************

*****************************************************************************

***********************************************************************

//first sort data randomly
drop hs_pscore hs_block
sort x

local cgafter (s_1yr_p1_core_dead==0 & (r_adl_sp_helper_x==1 | r_iadl_sp_helper_x==1))

//generate pscore variable hs_pscore
pscore rhs3d $match_w_helper2 if `cgafter' , pscore(hs_pscore) blockid(hs_block) logit detail

//graph without dropping any observations in the matching process
//psgraph, treated(rhs3d) pscore(hs_pscore)

//implement radius matching
gen logitpscore_cga=ln(hs_pscore/(1-hs_pscore)) if `cgafter'
sum logitpscore_cga

sca cal_ps_cga=r(sd)*0.02
sca list cal_ps_cga

psmatch2  rhs3d  if `cgafter',outcome(s_cesdbetter) pscore(hs_pscore) radius caliper(.02336107) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(rhs3d) pscore(hs_pscore)

histogram hs_pscore if _support==1, by(rhs3d) 

//look at balance of matched vs unmatched samples
pstest $match_w_helper2  if `cgafter',treated(rhs3d) both hist

//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age {
gen `v'_treated_cga = `v' if rhs3d==1 & _support==1 & `cgafter'
gen `v'_compar_cga = `v' if rhs3d==0 & _support==1 & `cgafter'
qqplot `v'_treated_cga `v'_compar_cga
}


mat vr=J(41,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $match_w_helper2  {
sum `v' if rhs3d==1 & `cgafter' //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if rhs3d==0 & `cgafter' //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if rhs3d==1 & _support==1 & `cgafter' //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if rhs3d==0 & `cgafter' [iweight=_weight] //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}

mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1" 

mat list vr

//13 from treated group are off common support, 7 control are not matched (weight==.)
//_support ==1 if matched
tab _support, missing
tab _support if rhs3d==1, missing
tab _support if rhs3d==0, missing
tab _weight if rhs3d==1, missing
sum _weight if rhs3d==0

rename _weight weight_cgafter1yr

***********************************************************************
//now run logit model using weighting 
***********************************************************************
//need to include the variables used in the propensity score
//we probably can't keep both spouse and r gender variables in

tab r_death_year  if `cgafter', missing

local yearvars ib2000.r_death_year 

logit s_cesdbetter i.rhs3d `yearvars' $matchvars2 [iw=weight_cgafter1yr] if `cgafter'  , or 

outreg using `logpath'\ivw_time_groups_spouse_analysis, ///
	stats(e_b e_ci p) nosubstat  ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///
	"Limited to S p1 interview after 1 year of R's death" \ ///	
	"Limited to Primary Caregiver spouses" \ ///
	"Outcome = CESD Score Decreased (by any amount) n1 to p1") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse no comorbidities.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable

//Run logit with outcome=depressed n1, not depressed p1
//need alternate match variables since perfect prediction with r_adl_stable_partial_n1n2 variable
tab s_cesd_ge3better r_adl_stable_partial_n1n2 if `cgafter' & rhs3d==1
tab s_cesd_ge3better r_adl_stable_partial_n1n2 if `cgafter' & rhs3d==0

global matchvars3 cc_all_count_12m_2 cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
 r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 /*r_adl_stable_partial_n1n2*/ r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
 r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y /*r_advdir_miss*/ r_discuss_x r_srh_pf_n1 ///
s_age s_female s_white_e  s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
 s_hrs_comorb_mild_n1 s_hrs_comorb_mod_n1 s_psych_overall_hrs_n1 	

logit s_cesd_ge3better i.rhs3d `yearvars' $matchvars3 [iw=weight_cgafter1yr] if `cgafter' , or 

outreg using `logpath'\ivw_time_groups_spouse_analysis, ///
	stats(e_b e_ci p) nosubstat  ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///
	"Limited to S p1 interview after 1 year of R's death" \ ///	
	"Limited to Primary Caregiver spouses" \ ///
	"Outcome = CESD Score 3+ n1 to less than 3 p1" ) ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse no comorbidities.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable
	
	
***********************************************************************
***********************************************************************
//Now caregivers with interview within 12m of r's death
***********************************************************************
***********************************************************************
//first sort data randomly
sort x

local cgbefore (s_1yr_p1_core_dead==1 & (r_adl_sp_helper_x==1 | r_iadl_sp_helper_x==1))

//generate pscore variable hs_pscore
pscore rhs3d $matchvars if `cgbefore' , pscore(hs_pscore) blockid(hs_block) logit detail

//graph without dropping any observations in the matching process
//psgraph, treated(rhs3d) pscore(hs_pscore)

//implement radius matching
gen logitpscore_cgb=ln(hs_pscore/(1-hs_pscore)) if `cgbefore'
sum logitpscore_cgb

sca cal_ps_cgb=r(sd)*0.02
sca list cal_ps_cgb

psmatch2  rhs3d  if `cgbefore',outcome(s_cesdbetter) pscore(hs_pscore) radius caliper(.01692516) logit
//note this creates varaible _weight

//graph including off common support information
psgraph, treated(rhs3d) pscore(hs_pscore)

histogram hs_pscore if _support==1, by(rhs3d) 

//look at balance of matched vs unmatched samples
pstest $matchvars  if `cgbefore',treated(rhs3d) both hist

pstest $matchvars  if `cgbefore',treated(rhs3d) both graph

//look at quantile-quantile plots for continuous variables
foreach v in cc_all_count_12m_2 s_age {
gen `v'_treated_cgb = `v' if rhs3d==1 & _support==1 & `cgbefore'
gen `v'_compar_cgb = `v' if rhs3d==0 & _support==1 & `cgbefore'
qqplot `v'_treated_cgb `v'_compar_cgb
}


mat vr=J(40,6,.)
//compare variance of covariates before and after matching
local i=1
foreach v in $matchvars  {
sum `v' if rhs3d==1 & `cgbefore' //get variance treated before matching
mat vr[`i',1]=r(Var)
sum `v' if rhs3d==0 & `cgbefore' //get variance comparison before matching
mat vr[`i',2]=r(Var)
mat vr[`i',3]= vr[`i',1]/vr[`i',2] //ratio
sum `v' if rhs3d==1 & _support==1 & `cgbefore' //get variance treated after matching
mat vr[`i',4]=r(Var)
sum `v' if rhs3d==0 & `cgbefore' [iweight=_weight]  //get variance comparison after matching
mat vr[`i',5]=r(Var)
mat vr[`i',6]= (vr[`i',4]) / (vr[`i',5]) //ratio
local i=`i'+1
}


mat rownames vr="Count of comorbidities" "Alzheimers/Dementia" "AMI / ISCH" ///
"CHF" "Diabetes" "Chronic kidney disease" "COPD" "Stroke/TIA" "Cancer" "Atrial fibrilation" ///
"Hip fracture" "Depression" "Osteoporosis" "Arthritis"  ///
"R Net worth - lowest quart" "NW - med-low quart" "NW - med-high quart" "Nursing home res" ///
 "ADL stable partial" "ADL stable severe" "ADL Ind to mod" ///
"ADL mod to severe" "ADL ind to severe" "ADL n2 to n1 missing" "Medicaid" "Champus" "Medigap" ///
"Advance directive Y" "Adv dir missing" "R Discuss EOL plans" "R SRH Fair/Poor"  ///
"S age" "S Female" "S White" "S HS Degree" "S Religion very important" "S SRH Fair/Poor" ///
"S HRS Comorb Mild 1-3" "S HRS Comorb Mod 4-6" "S Psych Problem HRS n1" 

mat list vr

//7 from treated group are off common support, 0 control are not matched (weight==.)
//_support ==1 if matched
tab _support, missing
tab _support if rhs3d==1, missing
tab _support if rhs3d==0, missing
tab _weight if rhs3d==1, missing
sum _weight if rhs3d==0

rename _weight weight_cgbef1yr

***********************************************************************
//now run logit model using weighting 
***********************************************************************
//need to include the variables used in the propensity score
//we probably can't keep both spouse and r gender variables in

tab r_death_year if `cgbefore', missing
//no obs in 2000, base set to 2001

local yearvars ib2001.r_death_year 

logit s_cesdbetter i.rhs3d `yearvars' $matchvars [iw=weight_cgbef1yr] if `cgbefore', or 

outreg using `logpath'\ivw_time_groups_spouse_analysis, ///
	stats(e_b e_ci p) nosubstat  ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///
	"Limited to S p1 interview within 1 year of R's death" \ ///	
	"Limited to Primary Caregiver spouses" \ ///
	"Outcome = CESD Score Decreased (by any amount) n1 to p1") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse no comorbidities." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable

//Run logit with outcome=depressed n1, not depressed p1
//omit missing adv directive and s moderate comorb variables
global matchvars4 cc_all_count_12m_2 cc_3_alzhdmta_n12mn0 cc_ami_isch_n12mn0 ///
cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_6_chrnkidn_n12mn0 cc_7_copd_n12mn0 ///
cc_16_strketia_n12mn0 cc_cncr_chronic_n12mn0 cc_4_atrialfb_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_13_depressn_n12mn0 cc_14_osteoprs_n12mn0 ///
cc_15_ra_oa_n12mn0 ///
r_nw_lowest_n1 r_nw_midlow_n1 r_nw_midhigh_n1 ///
r_nhres_n1 r_adl_stable_partial_n1n2 r_adl_stable_severe_n1n2 ///
r_adl_change_i_m_n1n2 r_adl_change_m_s_n1n2 r_adl_change_i_s_n1n2 r_adl_change_n1n2_miss ///
r_medicaid_n1 r_champus_n1 r_medigap_n1 r_advdir_y /*r_advdir_miss*/ r_discuss_x r_srh_pf_n1 ///
s_age s_female s_white_e  s_hseduc_n1_n3 ///
s_imprelig_vimp_n1 s_srh_pf_p1 ///
s_hrs_comorb_mild_n1 /*s_hrs_comorb_mod_n1*/ s_psych_overall_hrs_n1 

logit s_cesd_ge3better i.rhs3d `yearvars' $matchvars4 [iw=weight_cgbef1yr] if `cgbefore', or 

outreg using `logpath'\ivw_time_groups_spouse_analysis, ///
	stats(e_b e_ci p) nosubstat  ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///
	"Limited to S p1 interview within 1 year of R's death" \ ///	
	"Limited to Primary Caregiver spouses" \ ///
	"Outcome = CESD Score 3+ n1 to less than 3 p1" ) ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	note("Base categories are year=2000 and spouse no comorbidities." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat( N) addtable

****************************************************************
	
****************************************************************
//run each dr regression in a row to get a single table with all of the results
****************************************************************

****************************************************************

//all spouses with p1 ivws 12+m, any cesd improvement
qui logit s_cesdbetter rhs3d ib2000.r_death_year $matchvars2 [iw=weight_after1yr] if s_1yr_p1_core_dead==0, or 
outreg , store(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs3d) ///
	title("Reduced spousal depressive symptoms and hospice enrollment" \ ///
	"Propensity Score Matched, Frequency Weighted Sample" \ ///	
	"Outcome = S Depressive symptom improvement n1 to p1" \ ///
	"Sample split by p1 ivw timing 0-12m / 12m+ after R's death") ///	
	ctitles("" "OR" "95% CI" "P-value") ///
	rtitles("Any improvement, 12+m ivw" ) ///
	note("Base categories are year=2000 and spouse has" \ ///
	"no comorbidities per HRS survey questions." \ ///
	"P1 interviews 0-3m after r's death are included.") ///
	varlabels starlevels(10 5 1)  summstat(N)

//all spouses with p1 ivws 12+m, clinical cesd improvement
qui logit s_cesd_ge3better rhs3d ib2000.r_death_year $matchvars2 [iw=weight_after1yr] if s_1yr_p1_core_dead==0 , or 
outreg , append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs3d) ///
	rtitles("Clinical improvement, 12+m ivw") ///
	varlabels starlevels(10 5 1)  summstat(N) 
	
//all spouses with p1 ivws 0-12m, any cesd improvement
qui logit s_cesdbetter rhs3d ib2001.r_death_year $matchvars [iw=weight_bef1yr] if s_1yr_p1_core_dead==1, or 
outreg , append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs3d) ///
	rtitles("Any improvement, 0-12m ivw" ) ///
	varlabels starlevels(10 5 1)  summstat(N) 
	
//all spouses with p1 ivws 0-12m, clinical cesd improvement
qui logit s_cesd_ge3better rhs3d ib2001.r_death_year $matchvars [iw=weight_bef1yr] if s_1yr_p1_core_dead==1 , or 
outreg , append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs3d) ///
	rtitles("Clinical improvement, 0-12m ivw" ) ///
	varlabels starlevels(10 5 1)  summstat(N) 

//caregivers 12+m, any cesd improvement
qui logit s_cesdbetter rhs3d ib2000.r_death_year $matchvars2 [iw=weight_cgafter1yr] if `cgafter'  , or 
outreg , append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs3d) ///
	rtitles("Caregivers, Any improvement, 12+m" ) ///
	varlabels starlevels(10 5 1)  summstat(N) 
	
//caregivers 12+m, clinical cesd improvement
qui logit s_cesd_ge3better rhs3d ib2000.r_death_year $matchvars3 [iw=weight_cgafter1yr] if `cgafter' , or 
outreg , append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs3d) ///
	rtitles("Caregivers, Clinical improvement, 12+m" ) ///
	varlabels starlevels(10 5 1)  summstat(N) 

//caregivers 0-12m, any cesd improvement
qui logit s_cesdbetter rhs3d ib2001.r_death_year $matchvars [iw=weight_cgbef1yr] if `cgbefore', or 
outreg , append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs3d) ///
	rtitles("Caregivers, Any improvement, 0-12m" ) ///
	varlabels starlevels(10 5 1)  summstat(N) 

//0-12m ivw, caregivers, clinical cesd improvement
qui logit s_cesd_ge3better rhs3d ib2001.r_death_year $matchvars4 [iw=weight_cgbef1yr] if `cgbefore', or 
outreg using `logpath'\ivw_time_groups_spouse_analysis, append(tableall) ///
	stats(e_b e_ci p) nosubstat keep(rhs3d) ///
	rtitles("Caregivers, clinical improvement, 0-12m" ) ///
	varlabels starlevels(10 5 1)  summstat(N) addtable	

****************************************************************

	
*********************************************
log close


H="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"


H="JAMAIM Edit comments April 2015"

capture log close

clear all
set mem 500m
set more off
set scheme s1color

local logpath E:\data\spouse\logs\dec2014
log using "`logpath'\12-HRS_Spouse_analysis_JAMA_comments_Apr2015.txt", text replace

local datapath E:\data\spouse\final_data
cd `datapath'

//this dataset has weights from propensity scores previously generated
use spouse_data_sample_v3_august2014.dta
******************************************************************

//get interview dates
format r_e_ivw_date_x %td
sum r_e_ivw_date_x,  format

//get cesd better, same, worse with additional decimal
sum s_cesdbetter if rhs3d==1 [iweight=weight_3]
sum s_cesdbetter if rhs3d==0 [iweight=weight_3]

sum s_cesdbetter [iweight=weight_3]

sum s_cesdworse if rhs3d==1 [iweight=weight_3]
sum s_cesdworse if rhs3d==0 [iweight=weight_3]

sum s_cesdworse [iweight=weight_3]

//mean age of the decedents, unmatched sample, hospice vs not
sum r_age if rhs3d==1
sum r_age if rhs3d==0

//percent used hospice 3+ days
tab rhs3d, missing

gen hs_gt_30d=1 if hs_los_12m>29
replace hs_gt_30d=0 if hs_los_12m<29 & hs_los_12m>2
tab hs_gt_30d, missing
tab hs_gt_30d

tab hs_los_12m if rhs3d==1, missing 

//time from n1 interiew to death, in days
sum s_days_n1_core_dead [iweight=weight_3]
sum s_days_n1_core_dead if rhs3d==1 [iweight=weight_3]

sum s_days_n1_core_dead if rhs3d==0 [iweight=weight_3]

//for interview > 12m after death subgroup
//get cesd better, same, worse with additional decimal
sum s_cesdbetter if rhs3d==1 [iweight=weight_3]
sum s_cesdbetter if rhs3d==0 [iweight=weight_3]

******************************************************************
//get date range for exit interviews, full decedent dataset
local datapath E:\data\hrs_cleaned\working
cd `datapath'

use exit_02_10_clean4.dta

gen exit_year_d=.
foreach v in s t u v w{
replace exit_year_d=`v'a501 if `v'a501~=.
}
tab exit_year_d exit_year,missing

foreach v in v w{
replace exit_month=`v'a500 if `v'a500~=.
}
tab exit_month exit_year,missing

gen day=1
generate ivw_date_my=mdy(exit_month,day,exit_year_d)
format ivw_date_my %d
sum ivw_date_my, format

******************************************************************
log close
