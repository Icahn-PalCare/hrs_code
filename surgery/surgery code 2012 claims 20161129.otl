= V4 Outline MultiLine NoSorting TabWidth=30

H="Surgery project outline document"
/*
NOTE 12/11/13: THIS FILE PROCESSES 2000-2010 CLAIMS

Used file C:\code\Surgery Code 07102013.txt as a starting point for this outline document

Outline is as follows:
1. Identify index surgeries that meet selection criteria
2. Check IP claims for claims that span continuous hospital stays 
	and save a list of all hospital stays for beneficiaries
	that have an index surgery
3. Identify index surgery information
	a. Presence of complications
	b. Index surgery hospital stay LOS
	c. Index surgery hospital stay discharge status / destination codes
4. Check insurance status 6m and 12m pre-surgery to determine
	sample selection (Medicare parts a and b and no hmo coverage required)
5. Identify number of hospital admissions in the 6 months pre-surgery
6. Identify post-surgery hospital and snf use in the 12 months post-surgery
	a. Days from surgery to next IP admission
	b. Total number of days spent in a hospital
	c. Count of hospital admissions
	d. Total number of days in a SNF
7. Identify Elixhauser comorbidities 6 and 12 months pre surgery
8. Identify chronic conditions 6 and 12 months pre surgery

UPDATE 3/24/2014: 
Revised per comments received from Zara on 3/14/14
Updates to the analysis and summary tables
Also updated coding for complications indicator variables
*/

/*Set up project libraries in SAS
Note created separate folders for the 2010 claims data files*/

/*********************************************************/
/*Unique to Amy's computer - 2010 Claims*/
/*********************************************************/
/*Medicare claims files - 2010*/
libname medi 'E:\data\cms_DUA_24548_2012';

/*Surgery project data files*/
libname sur_fin "E:\data\surgery\2012_update\final_2012clms";

/*Surgery project temporary data files*/
libname sur_int "E:\data\surgery\2012_update\int_2012clms";

/*Procedures project raw data files
Reference files like list of chronic conditions ICD-9 codes*/
libname ref_data "E:\data\surgery\2012_update\ref_data";

/*Cleaned HRS 2000-2012 dataset*/
libname hrs_cln 'E:\data\hrs_cleaned';




H="Identify surgeries from mc claims files"
/*Identify claims with particular procedure codes present from the
ip claims file

****Note: Procedure dates in 2009 and 2010 medpar claims files
seemed improperly formatted, truncated to only 6 digits with a leading
space, so sent question to Resdac and using IP claims in the meantime
Used medpar claims when processed 2008 claims *****

Final file created: sur_int.last_surgery_date
List of index surgery  by beneficiary id

Keep additional information needed about this claim / surgery:
1. Complications
2. LOS
3. Discharge status (to home, SNF, etc)
4. Admission type (to track if ER admission or not)

List of complications: 
UTI
PE
Infection
Resp failure
MI
Delirium

This additional information is processed in the next tab 
"Index surgery information defined"


NOTE 12/11/13: THIS FILE PROCESSES 2000-2010 CLAIMS
*/

%let source0=mp;



/*Create claim id for full set of ip claims 2000-2010*/
/*sequential, unique ID for each claim in this file*/
data sur_int.&source0._2000_2012_claim_id;
set medi.&source0._2000_2012;
	clm_id=_N_;
run;
proc sort data=sur_int.&source0._2000_2012_claim_id ;
by bid_hrs_21;
run;



/*Create mp_meet dataset of claims that are not SNF claims
34246 ip claims identified

Note: variable SSLSSNF from mp claims is N=Skilled nursing facility

Just pulls variables to identify procedures
PRCDR_CD = procedure codes
PRCDR_DT = procedure dates
TYPE_ADM = admission type code
AD_DGNS = admitting diagnosis code
DGNS_CD01-DGNS_CD10 = Additional dx codes
DSCHRGCD = discharge status code
LOSCNT = length of stay day count
DSTNTNCD = discharge destination code
clm_id = new claim id created above
admit_date = admission date for claim
disch_date = discharge date for the claim
 Leave in case go back to using medpar claims
*/
proc sql;
create table ip_meet as select bid_hrs_21,
PRCDR_CD01,PRCDR_CD02,PRCDR_CD03,PRCDR_CD04,
PRCDR_CD05,PRCDR_CD06,PRCDR_CD07,PRCDR_CD08,
PRCDR_CD09,PRCDR_CD10,PRCDR_CD11,PRCDR_CD12,
PRCDR_CD13,PRCDR_CD14,PRCDR_CD15,PRCDR_CD16,
PRCDR_CD17,PRCDR_CD18,PRCDR_CD19,PRCDR_CD20,
PRCDR_CD21,PRCDR_CD22,PRCDR_CD23,PRCDR_CD24,
PRCDR_CD25,
TYPE_ADM,PRCDR_DT01,PRCDR_DT02,PRCDR_DT03,
PRCDR_DT04,PRCDR_DT05,PRCDR_DT06,PRCDR_DT07,
PRCDR_DT08,PRCDR_DT09,PRCDR_DT10,PRCDR_DT11,
PRCDR_DT12,PRCDR_DT13,PRCDR_DT14,PRCDR_DT15,
PRCDR_DT16,PRCDR_DT17,PRCDR_DT18,PRCDR_DT19,
PRCDR_DT20,PRCDR_DT21,PRCDR_DT22,PRCDR_DT23,
PRCDR_DT24,PRCDR_DT25,
AD_DGNS ,
DGNS_CD01,DGNS_CD02,DGNS_CD03,DGNS_CD04,DGNS_CD05,
DGNS_CD06,DGNS_CD07,DGNS_CD08,DGNS_CD09,DGNS_CD10,
DGNS_CD11,DGNS_CD12,DGNS_CD13,DGNS_CD14,DGNS_CD15,
DGNS_CD16,DGNS_CD17,DGNS_CD18,DGNS_CD19,DGNS_CD20,
DGNS_CD21,DGNS_CD22,DGNS_CD23,DGNS_CD24,DGNS_CD25,
DSCHRGCD,
LOSCNT,
DSTNTNCD,
clm_id,
admit_date,
disch_date
from sur_int.&source0._2000_2012_claim_id(where=(trim(left(SSLSSNF))~="N")) ;
quit;

/*
proc sql;
create table &source0._meet as select bid_hrs_21,
PRCDR_CD1,PRCDR_CD2,PRCDR_CD3,PRCDR_CD4,
PRCDR_CD5,PRCDR_CD6,PRCDR_CD7,PRCDR_CD8,
PRCDR_CD9,PRCDR_CD10,PRCDR_CD11,PRCDR_CD12,
PRCDR_CD13,PRCDR_CD14,PRCDR_CD15,PRCDR_CD16,
PRCDR_CD17,PRCDR_CD18,PRCDR_CD19,PRCDR_CD20,
PRCDR_CD21,PRCDR_CD22,PRCDR_CD23,PRCDR_CD24,
PRCDR_CD25,
TYPE_ADM,
PRCDR_DT1,PRCDR_DT2,PRCDR_DT3,
PRCDR_DT4,PRCDR_DT5,PRCDR_DT6,PRCDR_DT7,
PRCDR_DT8,PRCDR_DT9,PRCDR_DT10,PRCDR_DT11,
PRCDR_DT12,PRCDR_DT13,PRCDR_DT14,PRCDR_DT15,
PRCDR_DT16,PRCDR_DT17,PRCDR_DT18,PRCDR_DT19,
PRCDR_DT20,PRCDR_DT21,PRCDR_DT22,PRCDR_DT23,
PRCDR_DT24,PRCDR_DT25,
AD_DGNS ,
DGNS_CD01,DGNS_CD02,DGNS_CD03,DGNS_CD04,DGNS_CD05,
DGNS_CD06,DGNS_CD07,DGNS_CD08,DGNS_CD09,DGNS_CD10,
DGNS_CD11,DGNS_CD12,DGNS_CD13,DGNS_CD14,DGNS_CD15,
DGNS_CD16,DGNS_CD17,DGNS_CD18,DGNS_CD19,DGNS_CD20,
DGNS_CD21,DGNS_CD22,DGNS_CD23,DGNS_CD24,DGNS_CD25,
STUS_CD,
clm_id,
admit_date,
disch_date
from sur_int.&source0._2000_2012_claim_id ;
quit;
*/

proc contents data=ip_meet; run;
/*creates table with each procedure as a separate row
So multiple rows per person
 63956 (old from 2008 64356) surgeries from ip file*/
data proc_long(keep=bid_hrs_21 TYPE_ADM procedure pdate AD_DGNS DGNS_CD01-DGNS_CD25
	clm_id admit_date disch_date);
set ip_meet;
array list PRCDR_CD01-PRCDR_CD25;
array date PRCDR_DT01-PRCDR_DT25;
do over list;
if list~="" then do;
procedure=list;
pdate=date;
output;
end;
end;
run;

data proc_long2(drop=pdate);
set proc_long;
if procedure~='';
procedure_date=mdy(substr(trim(left(pdate)),5,2),substr(trim(left(pdate)),7,2),substr(trim(left(pdate)),1,4));
format procedure_date date10.;
run;

proc contents data=proc_long; run;
/*rename admit date and discharge date to be is_ for index surgery
This way can use this index surgery information to check against
claims lists pre- and post-surgery*/
data proc_long2(rename=(admit_date=is_admit_date) rename=(disch_date=is_disch_date));
set proc_long2;
format admit_date date10.;
format disch_date date10.;
run;
*/

/* Identify surgeries that meet the criteria
Indicator variable surgery_meet = 1 if yes, include in sample 
1700 surgeries meet the criteria*/;
data surgery_meet;
set proc_long2;
if length(compress(procedure))>3 then do;

if compress(procedure)+0 in (4342, 4381, 4391, 4399, 4439, 4440, 4441, 4442, 4461, 4492, 4500, 4502, 4503, 4515, 4522, 4526, 4527, 4550, 4551, 4561, 4562, 4563, 4571, 4572, 4573, 4574, 4575, 4576, 4582, 4590, 4591, 4592, 4593, 4594, 4595, 4601, 4603, 4610, 4611, 4613, 4614, 4620, 4621, 4622, 4623, 4631, 4639, 4660, 4661, 4662, 4671, 4672, 4673, 4674, 4676, 4679, 4700, 4709, 4680, 4681, 4682, 4693, 4699, 4791, 5120, 5121, 5122, 5209, 5222, 5299, 5351, 5359, 5361, 5369, 5411, 5412, 5459, 5474, 5495, 5783) then surgery_meet=1;

if substr(compress(procedure),1,3)+0 in (436, 437, 445, 576) then surgery_meet=1;

end;
/*only keep observations in work.surgery_meet that meet criteria*/
if surgery_meet then output;

run;
proc contents data=ip_meet;
run;
/*****************************************************************************/
/*Look at number of qualifying procedures per bid*/
/*****************************************************************************/
/*Identify the most recent surgery from the list that meet the criteria for each 
beneficiary id*/
proc sort data=surgery_meet;
by bid_hrs_21 procedure_date;
run;

/*get count of qualifying procedures per beneficary, regardless of surgery dates
so a beneficiary can have more than 1 surgery on the same date*/
data surg_meet_count1;
set surgery_meet;
by bid_hrs_21;
	if first.bid_hrs_21 then pro_count=1;
	else pro_count+1;
run;

data surg_meet_count2(rename=pro_count=pro_cnt_all);
set surg_meet_count1(keep=bid_hrs_21 pro_count);
by bid_hrs_21;
if last.bid_hrs_21;
label pro_count="Procedure count, all qualifying procedures";
run;

/*now get list of surgeries on seperate dates*/
proc sort data=surgery_meet out=surg_meet_count3 nodupkey;
by bid_hrs_21 procedure_date;
run;

data surg_meet_count4;
set surg_meet_count3;
by bid_hrs_21;
	if first.bid_hrs_21 then pro_count=1;
	else pro_count+1;
run;

data surg_meet_count5(rename=pro_count=pro_cnt_date);
set surg_meet_count4(keep=bid_hrs_21 pro_count);
by bid_hrs_21;
if last.bid_hrs_21;
label pro_count="Procedure count, only count 1 per procedure date";
run;

/*finally with separate medicare claims*/
proc sort data=surgery_meet out=surg_meet_count6 nodupkey;
by bid_hrs_21 clm_id;
run;

data surg_meet_count7;
set surg_meet_count6;
by bid_hrs_21;
	if first.bid_hrs_21 then pro_count=1;
	else pro_count+1;
run;

data surg_meet_count8(rename=pro_count=pro_cnt_clm);
set surg_meet_count7(keep=bid_hrs_21 pro_count);
by bid_hrs_21;
if last.bid_hrs_21;
label pro_count="Procedure count, only count 1 per claim";
run;


ods rtf body='E:\data\surgery\2012_update\logs\Procedure_counts.rtf';

title "Count of qualifying procedures, including multiple surgeries on the same date";
proc freq data=surg_meet_count2; table pro_cnt_all; run;

title "Count of qualifying procedures with separate procedure dates";
proc freq data=surg_meet_count5; table pro_cnt_date; run;

title "Count of qualifying procedures with separate Medicare claims";
proc freq data=surg_meet_count8; table pro_cnt_clm; run;

ods rtf close;

/*final file list of index surgery by bid
955 beneficiaries have index surgery identified*/
data last_surgery_date_1;
set surgery_meet ;
by bid_hrs_21 procedure_date ;
if last.bid_hrs_21;
run;

/*now merge in procedure counts so can carry through dataset*/
data counts;
merge surg_meet_count2 surg_meet_count5 surg_meet_count8;
by bid_hrs_21;
run;

proc freq; table pro_cnt_all pro_cnt_date pro_cnt_clm; run;

proc sql;
create table sur_int.last_surgery_date as select a.*,b.pro_cnt_all,b.pro_cnt_date,b.pro_cnt_clm from
last_surgery_date_1 a left join
counts b
on a.bid_hrs_21=b.bid_hrs_21;
quit;

H="Identify surgeries from mc claims files using ip"
/*Identify claims with particular procedure codes present from the
ip claims file

****Note: Procedure dates in 2009 and 2010 medpar claims files
seemed improperly formatted, truncated to only 6 digits with a leading
space, so sent question to Resdac and using IP claims in the meantime
Used medpar claims when processed 2008 claims *****

Final file created: sur_int.last_surgery_date
List of index surgery  by beneficiary id

Keep additional information needed about this claim / surgery:
1. Complications
2. LOS
3. Discharge status (to home, SNF, etc)
4. Admission type (to track if ER admission or not)

List of complications: 
UTI
PE
Infection
Resp failure
MI
Delirium

This additional information is processed in the next tab 
"Index surgery information defined"


NOTE 12/11/13: THIS FILE PROCESSES 2000-2010 CLAIMS
*/

%let source0=ip;

proc sort data=medi.&source0._2000_2012 ;
by bid_hrs_21;
run;

/*Create claim id for full set of ip claims 2000-2010*/
/*sequential, unique ID for each claim in this file*/
data sur_int.&source0._2000_2012_claim_id;
set medi.&source0._2000_2012;
	clm_id=_N_;
run;

/*check no duplicates of new claim id*/
proc sort data=sur_int.&source0._2000_2012_claim_id nodupkey ;
by clm_id;
run;

proc contents order=casecollate data=sur_int.&source0._2000_2012_claim_id;
run;



/*Create mp_meet dataset of claims that are not SNF claims
34246 ip claims identified

Note: variable SSLSSNF from mp claims is N=Skilled nursing facility

Just pulls variables to identify procedures
PRCDR_CD = procedure codes
PRCDR_DT = procedure dates
TYPE_ADM = admission type code
AD_DGNS = admitting diagnosis code
DGNS_CD01-DGNS_CD10 = Additional dx codes
DSCHRGCD = discharge status code
LOSCNT = length of stay day count
DSTNTNCD = discharge destination code
clm_id = new claim id created above
admit_date = admission date for claim
disch_date = discharge date for the claim
*/
/* Leave in case go back to using medpar claims
proc sql;
create table &source0._meet as select bid_hrs_21,
PRCDR_CD01,PRCDR_CD02,PRCDR_CD03,PRCDR_CD04,
PRCDR_CD05,PRCDR_CD06,PRCDR_CD07,PRCDR_CD08,
PRCDR_CD09,PRCDR_CD10,PRCDR_CD11,PRCDR_CD12,
PRCDR_CD13,PRCDR_CD14,PRCDR_CD15,PRCDR_CD16,
PRCDR_CD17,PRCDR_CD18,PRCDR_CD19,PRCDR_CD20,
PRCDR_CD21,PRCDR_CD22,PRCDR_CD23,PRCDR_CD24,
PRCDR_CD25,
TYPE_ADM,PRCDR_DT01,PRCDR_DT02,PRCDR_DT03,
PRCDR_DT04,PRCDR_DT05,PRCDR_DT06,PRCDR_DT07,
PRCDR_DT08,PRCDR_DT09,PRCDR_DT10,PRCDR_DT11,
PRCDR_DT12,PRCDR_DT13,PRCDR_DT14,PRCDR_DT15,
PRCDR_DT16,PRCDR_DT17,PRCDR_DT18,PRCDR_DT19,
PRCDR_DT20,PRCDR_DT21,PRCDR_DT22,PRCDR_DT23,
PRCDR_DT24,PRCDR_DT25,
AD_DGNS ,
DGNS_CD01,DGNS_CD02,DGNS_CD03,DGNS_CD04,DGNS_CD05,
DGNS_CD06,DGNS_CD07,DGNS_CD08,DGNS_CD09,DGNS_CD10,
DGNS_CD11,DGNS_CD12,DGNS_CD13,DGNS_CD14,DGNS_CD15,
DGNS_CD16,DGNS_CD17,DGNS_CD18,DGNS_CD19,DGNS_CD20,
DGNS_CD21,DGNS_CD22,DGNS_CD23,DGNS_CD24,DGNS_CD25,
DSCHRGCD,
LOSCNT,
DSTNTNCD,
clm_id,
admit_date,
disch_date
from sur_int.&source0._2000_2012_claim_id(where=(trim(left(SSLSSNF))~="N")) ;
quit;
*/
proc contents data=medi.ip_2000_2012; run;
proc sql;
create table &source0._meet as select bid_hrs_21,
PRCDRCD01,PRCDRCD02,PRCDRCD03,PRCDRCD04,
PRCDRCD05,PRCDRCD06,PRCDRCD07,PRCDRCD08,
PRCDRCD09,PRCDRCD10,PRCDRCD11,PRCDRCD12,
PRCDRCD13,PRCDRCD14,PRCDRCD15,PRCDRCD16,
PRCDRCD17,PRCDRCD18,PRCDRCD19,PRCDRCD20,
PRCDRCD21,PRCDRCD22,PRCDRCD23,PRCDRCD24,
PRCDRCD25,
TYPE_ADM,
PRCDRDT01,PRCDRDT02,PRCDRDT03,
PRCDRDT04,PRCDRDT05,PRCDRDT06,PRCDRDT07,
PRCDRDT08,PRCDRDT09,PRCDRDT10,PRCDRDT11,
PRCDRDT12,PRCDRDT13,PRCDRDT14,PRCDRDT15,
PRCDRDT16,PRCDRDT17,PRCDRDT18,PRCDRDT19,
PRCDRDT20,PRCDRDT21,PRCDRDT22,PRCDRDT23,
PRCDRDT24,PRCDRDT25,
AD_DGNS ,
DGNSCD01,DGNSCD02,DGNSCD03,DGNSCD04,DGNSCD05,
DGNSCD06,DGNSCD07,DGNSCD08,DGNSCD09,DGNSCD10,
DGNSCD11,DGNSCD12,DGNSCD13,DGNSCD14,DGNSCD15,
DGNSCD16,DGNSCD17,DGNSCD18,DGNSCD19,DGNSCD20,
DGNSCD21,DGNSCD22,DGNSCD23,DGNSCD24,DGNSCD25,
STUS_CD,
clm_id,
admit_date,
disch_date
from sur_int.&source0._2000_2012_claim_id ;
quit;


/*view procedure variables from original claims dataset*/
proc contents data=sur_int.&source0._2000_2012_claim_id(keep=PRCDR:);
run;
proc sql outobs=2;
select PRCDRCD01,PRCDRDT01 from sur_int.&source0._2000_2012_claim_id;
quit;


/*creates table with each procedure as a separate row
So multiple rows per person
 63956 (old from 2008 64356) surgeries from ip file*/
data proc_long(keep=bid_hrs_21 TYPE_ADM procedure procedure_date AD_DGNS DGNSCD01-DGNSCD25
	STUS_CD clm_id admit_date disch_date);
set ip_meet;
array list PRCDRCD01-PRCDRCD25;
array date PRCDRDT01-PRCDRDT25;
do over list;
if list~="" then do;
procedure=list;
procedure_date=mdy(substr(trim(left(date)),5,2),substr(trim(left(date)),7,2),substr(trim(left(date)),1,4));
output;
end;
end;
format procedure_date date10.;
run;

/*rename admit date and discharge date to be is_ for index surgery
This way can use this index surgery information to check against
claims lists pre- and post-surgery*/
data proc_long2(rename=(admit_date=is_admit_date) rename=(disch_date=is_disch_date));
set proc_long;
format admit_date date10.;
format disch_date date10.;
run;


/* Identify surgeries that meet the criteria
Indicator variable surgery_meet = 1 if yes, include in sample 
1700 surgeries meet the criteria*/
data surgery_meet;
set proc_long2;
if length(compress(procedure))>3 then do;

if compress(procedure)+0 in (4342, 4381, 4391, 4399, 4439, 4440, 4441, 4442, 4461, 4492, 4500, 4502, 4503, 4515, 4522, 4526, 4527, 4550, 4551, 4561, 4562, 4563, 4571, 4572, 4573, 4574, 4575, 4576, 4582, 4590, 4591, 4592, 4593, 4594, 4595, 4601, 4603, 4610, 4611, 4613, 4614, 4620, 4621, 4622, 4623, 4631, 4639, 4660, 4661, 4662, 4671, 4672, 4673, 4674, 4676, 4679, 4700, 4709, 4680, 4681, 4682, 4693, 4699, 4791, 5120, 5121, 5122, 5209, 5222, 5299, 5351, 5359, 5361, 5369, 5411, 5412, 5459, 5474, 5495, 5783) then surgery_meet=1;

if substr(compress(procedure),1,3)+0 in (436, 437, 445, 576) then surgery_meet=1;

end;
/*only keep observations in work.surgery_meet that meet criteria*/
if surgery_meet then output;

run;

/*****************************************************************************/
/*Look at number of qualifying procedures per bid*/
/*****************************************************************************/
/*Identify the most recent surgery from the list that meet the criteria for each 
beneficiary id*/
proc sort data=surgery_meet;
by bid_hrs_21 procedure_date;
run;

/*get count of qualifying procedures per beneficary, regardless of surgery dates
so a beneficiary can have more than 1 surgery on the same date*/
data surg_meet_count1;
set surgery_meet;
by bid_hrs_21;
	if first.bid_hrs_21 then pro_count=1;
	else pro_count+1;
run;

data surg_meet_count2(rename=pro_count=pro_cnt_all);
set surg_meet_count1(keep=bid_hrs_21 pro_count);
by bid_hrs_21;
if last.bid_hrs_21;
label pro_count="Procedure count, all qualifying procedures";
run;

/*now get list of surgeries on seperate dates*/
proc sort data=surgery_meet out=surg_meet_count3 nodupkey;
by bid_hrs_21 procedure_date;
run;

data surg_meet_count4;
set surg_meet_count3;
by bid_hrs_21;
	if first.bid_hrs_21 then pro_count=1;
	else pro_count+1;
run;

data surg_meet_count5(rename=pro_count=pro_cnt_date);
set surg_meet_count4(keep=bid_hrs_21 pro_count);
by bid_hrs_21;
if last.bid_hrs_21;
label pro_count="Procedure count, only count 1 per procedure date";
run;

/*finally with separate medicare claims*/
proc sort data=surgery_meet out=surg_meet_count6 nodupkey;
by bid_hrs_21 clm_id;
run;

data surg_meet_count7;
set surg_meet_count6;
by bid_hrs_21;
	if first.bid_hrs_21 then pro_count=1;
	else pro_count+1;
run;

data surg_meet_count8(rename=pro_count=pro_cnt_clm);
set surg_meet_count7(keep=bid_hrs_21 pro_count);
by bid_hrs_21;
if last.bid_hrs_21;
label pro_count="Procedure count, only count 1 per claim";
run;


ods rtf body='E:\data\surgery\logs\Procedure_counts.rtf';

title "Count of qualifying procedures, including multiple surgeries on the same date";
proc freq data=surg_meet_count2; table pro_cnt_all; run;

title "Count of qualifying procedures with separate procedure dates";
proc freq data=surg_meet_count5; table pro_cnt_date; run;

title "Count of qualifying procedures with separate Medicare claims";
proc freq data=surg_meet_count8; table pro_cnt_clm; run;

ods rtf close;

/*final file list of index surgery by bid
955 beneficiaries have index surgery identified*/
data last_surgery_date_1;
set surgery_meet ;
by bid_hrs_21 procedure_date ;
if last.bid_hrs_21;
run;

/*now merge in procedure counts so can carry through dataset*/
data counts;
merge surg_meet_count2 surg_meet_count5 surg_meet_count8;
by bid_hrs_21;
run;

proc freq; table pro_cnt_all pro_cnt_date pro_cnt_clm; run;

proc sql;
create table sur_int.last_surgery_date as select a.*,b.pro_cnt_all,b.pro_cnt_date,b.pro_cnt_clm from
last_surgery_date_1 a left join
counts b
on a.bid_hrs_21=b.bid_hrs_21;
quit;

proc export data=sur_int.last_surgery_date outfile="E:\data\surgery\2012_update\last_surg_ip.dta" replace; run;


H="Check for continous hospital stays in the overall list of ip claims"
/*
Check list of IP claims for cases where multiple claims are present
for a single hospital stay

This is identified where 
1. start day of claim is within 1 day of end
date of the claim before AND
2. discharge code = 2 or 5 for transfer for inpatient care

Need to check index surgery to determine if more than one claim
is associated with that hospital stay in order to calculate LOS, etc.

If discharge destination code = 02 (transferred to short term general hospital
for inpatient care) or = 05 (transferred to anoter type of institution for inpatient care)
and the discharge date of 1st claim is the the same or one day before the admit
date for the next claim, then the claims are part of the same inpatient stay.

List of claims with new start/ end dates that span overall stay
is saved as sur_int.ip_cont_stay_clms_merged
If multiple claims were merged into single stay observation, ind_clm_merge=1

*/

/*Step 1: get dataset of ip claims only from the medpar file
Use medpar file with the unique claim id assigned*/
data sur_int.ip_2000_2012;
set sur_int.ip_2000_2012_claim_id/*(where=(trim(left(SSLSSNF))~="N"))*/;
run;

/*step 2: only keep claims where the bid had an index surgery
5283 claims identified
This list of claims includes the index surgery claim*/
proc sql;
create table mp_cont_stay_1 as select a.*,b.procedure_date,b.is_admit_date,b.is_disch_date
from sur_int.ip_2000_2012 a inner join
sur_int.last_surgery_date b
on trim(left(a.bid_hrs_21))=trim(left(b.bid_hrs_21)) ;
quit;

proc sort data=mp_cont_stay_1 ;
by bid_hrs_21 admit_date;
run;

/*change formats of dates*/
data mp_cont_stay_2 ;
set mp_cont_stay_1 ;
format admit_date date10.;
format disch_date date10.;
run;

/***********************************************************************/
/*         Determine days from current obs. claim admit date
	   to previous claim discharge date                   */
/***********************************************************************/

/*sort ascending to calculate days from previous claim to current claim*/
proc sort data=mp_cont_stay_2 ;
by bid_hrs_21 admit_date disch_date;
run;

/*new variable
daydiff_prev = days from previous claim end date to current claim start date
If claim is the first claim for that BID, then set daydiff_prev = null */
data mp_cont_stay_3 ;
set mp_cont_stay_2 ;
by bid_hrs_21;
daydiff_prev = admit_date - LAG(disch_date) ;
if first.bid_hrs_21 then daydiff_prev = . ;
run;

proc freq data=mp_cont_stay_3 ;
table daydiff_prev;
run;

/***********************************************************************/
/*         Identify claims that, just using start/end dates
	   appear to be for continuous hospital stays                  */
/***********************************************************************/

proc sort data=mp_cont_stay_3 ;
by bid_hrs_21 admit_date disch_date;
run;

/*keep a list of just claims where next claim starts on the same
day or day after discharge from index surgery claim
There are 444 such claims*/
data mp_cont_stay_4 ;
set mp_cont_stay_3(where=(daydiff_prev<2));
run;
data mp_cont_stay_5 ;
set mp_cont_stay_4(where=(daydiff_prev~=.)) ;
run;
proc freq data=mp_cont_stay_5;
table daydiff_prev;
run;

/***********************************************************************/
/*         Add indicator for claims with discharge codes
           indicating patient transferred for further
           inpatient care                                    */
/***********************************************************************/

/*check discharge destination code for surgeries where the next claim
starts either the same day as discharge from surgery claim or day after
add indicator to dataset that claim has the discharge code*/
proc freq data=mp_cont_stay_3;
table stus_cd;
run;

data mp_cont_stay_6;
set mp_cont_stay_3;
dstn_cd_cont=0;
if STUS_CD in(02,05) then dstn_cd_cont=1;
run;

proc freq data=mp_cont_stay_6;
table dstn_cd_cont;
run;

proc freq data=mp_cont_stay_6(where=(dstn_cd_cont=1)) ;
table STUS_CD ;
run;

/********************************************************************/
/* Merge claim start and end dates if they have the required
discharge destination codes and claim dates are within one day */
/********************************************************************/

proc sort data=mp_cont_stay_6 out=mp_cont_stay_7;
     by bid_hrs_21 admit_date disch_date;
run;

data mp_cont_stay_8;
set mp_cont_stay_7;
retain stay_start stay_end;
       by bid_hrs_21 admit_date;
          /* Handle claims that are for distinct stay
             Distinct stay if more than 1 day between claim dates or
             claim dates overlap but discharge destination code does not
             indicate transferred for inpatient care  */
	ind_clm_merge=.; /*initialize the indicator variable for merged claims*/
if (daydiff_prev > 1 or daydiff_prev=.) or
              (daydiff_prev <2 and daydiff_prev~=. and lag(dstn_cd_cont)=0) then do;
             stay_start = admit_date;
             stay_end = disch_date;
			 ind_clm_merge=0;
             end;
          /* Handle claims that are for continous stays */
          if (daydiff_prev <2 and daydiff_prev~=. and lag(dstn_cd_cont)=1) then do;
             stay_end = disch_date;
			 ind_clm_merge=1;
             end;
          format stay_start date10. stay_end date10.;
run;

/*189 cases where claims dates are merged*/
proc freq;
table ind_clm_merge /missprint;
run;

/********************************************************************/
/* Drop claims so there is only one claim per stay with the overall
stay start and end dates */
/********************************************************************/

data mp_cont_stay_9;
set mp_cont_stay_8;
by bid_hrs_21 stay_start;
   j = 0;
   if last.stay_start then j=j+1;
run;

proc freq;
table j;
run;
/*3.63% of claims (192) are merged with an additional claim, 2 stays have 3 claims
merged into a single stay (explains ind_clm_merge count=189 while j=0 count=192,
results in 5091 unique stays out of the 5283 claims*/

/*save the new ip stay dataset sur_int.ip_cont_stay_clms_merged*/
data sur_int.ip_cont_stay_clms_merged;
set mp_cont_stay_9;
if j=1;
drop j;
label ind_clm_merge="Indicator for stay dates merged over multiple claims";
run;

/*174 (3.42%) of the 5091 stays have multiple claims dates merged
to get stay start / end dates*/
proc freq data=sur_int.ip_cont_stay_clms_merged;
table ind_clm_merge /missprint;
run;



H="xxxxxxx"
/*

NEED TO DELETE THIS CODE - CHECK FIRST - DON'T THINK 
ANYTHING IN THIS HEADING IS NEEDED...

This is in contrast to individual claims with the index surgery
Now check overall stay start/end dates vs procedure date to 
identify stays with individual surgery, get 
Index surgery list with this information changed is saved as
sur_int.index_surg_w_clms */
*************************************
*************************************
*************************************
proc sql;
create table mp_cont_stay_9 as select 
* from sur_int.last_surgery_date
where bid_hrs in (select bid_hrs from mp_cont_stay_8) ;
run;

proc freq data=mp_cont_stay_9 ;
table DSTNTNCD ;
run;

/*Discharge status code 2 and 5 indicate transfer for inpatient care, so
surgery claims with this discharge destination and a claim starting 
immediately after discharge are treated as continuous stays and merged
for the purposes of calculating index surgery los and discharge destination*/

/*add indicator variable to identify index surgeries where additional
claim information is to be merged in
12 claims*/
data mp_cont_stay_10;
set mp_cont_stay_9;
if(DSTNTNCD=2 | DSTNTNCD=5) then merge_clm_next=1 ;
run;
proc freq;
table merge_clm_next;
run;

/*bring indicator into main list of index surgeries*/
proc sql;
create table mp_cont_stay_11 as select 
a.*,b.merge_clm_next
from sur_int.last_surgery_date a left join
mp_cont_stay_10 b
on (a.BID_HRS=b.BID_HRS);
quit;
proc freq;
table merge_clm_next;
run;

/*get list of index surgery claims that need merge*/
data surg_need_merge;
set mp_cont_stay_10(where=(merge_clm_next=1));
run;


/*create a table of just the post-surgery claims to merge into surgery claim info*/
proc sql;
create table sur_int.surg_next_to_merge as select 
* from mp_cont_stay_8 
where bid_hrs in (select bid_hrs from surg_need_merge);
quit;


/*create table of index surgeries with additional claim information added*/
proc sql;
create table sur_int.index_surgery_next as select
a.*,b.DGNS_CD01 as nc_DGNS_CD_01, b.DGNS_CD02 as nc_DGNS_CD_02,b.DGNS_CD03 as nc_DGNS_CD_03,b.DGNS_CD04 as nc_DGNS_CD_04,b.DGNS_CD05 as nc_DGNS_CD_05,b.DGNS_CD06 as nc_DGNS_CD_06,b.DGNS_CD07 as nc_DGNS_CD_07,b.DGNS_CD08 as nc_DGNS_CD_08,b.DGNS_CD09 as nc_DGNS_CD_09,b.DGNS_CD10 as nc_DGNS_CD_10,b.disch_date as nc_disch_date, b.DSCHRGCD as nc_DSCHRGCD, b.DSTNTNCD as nc_DSTNTNCD
from  mp_cont_stay_11 a left join
sur_int.surg_next_to_merge b
on a.bid_hrs=b.bid_hrs
;
quit;

/*check the merge - should be 12 claims with this info added*/
proc freq;table
nc_DGNS_CD_01;
run;

/*replace index surgery information with that of the next claim
where applicable*/
data sur_int.index_surgery_next_merge ;
set sur_int.index_surgery_next ;
if merge_clm_next=1 then do;
	is_disch_date = nc_disch_date;
	DSCHRGCD = nc_DSCHRGCD;
	DSTNTNCD = nc_DSTNTNCD;
	LOSCNT = is_disch_date-is_admit_date;
	end;
run;

/***********************************************************************/
/*         Check claim immediately before surgery claim                */
/***********************************************************************/

proc sort data=mp_cont_stay_5 ;
by bid_hrs descending admit_date;
run;

/*assign indicator for claim prior to the index surgery*/
data mp_cont_stay_12 ;
set mp_cont_stay_5 ;
if (LAG(surgery_meet)=1 & bid_hrs=LAG(bid_hrs)) then prev_clm=1;
run;

/*get dataset of just the prior claims pre-surgery claim*/
data mp_cont_stay_13 ;
set mp_cont_stay_12(where=(prev_clm=1));
run;

proc freq data=mp_cont_stay_13;
table daydiff_next;
run;

/*keep a list of just claims where prior claim ends on the same
day or day before start of index surgery claim
There are 31 such claims*/
data mp_cont_stay_14 ;
set mp_cont_stay_13(where=(daydiff_next<2));
run;
proc freq data=mp_cont_stay_14;
table daydiff_next;
run;

proc freq data=mp_cont_stay_14;
table DSTNTNCD ;
run;

*******************************************************
/*Discharge status code 2 and 5 indicate transfer for inpatient care, so
claims immediately prior to surgery with this discharge destination 
and discharge date immediately preceeding admission to surgery claim
are treated as continuous stays and merged
for the purposes of calculating index surgery los and discharge destination*/

/*add indicator variable to identify index surgeries where additional
claim information is to be merged in
25 claims*/
data mp_cont_stay_15;
set mp_cont_stay_14;
if(DSTNTNCD=2 | DSTNTNCD=5) then merge_clm_prev=1 ;
run;
proc freq;
table merge_clm_prev;
run;

/*bring indicator into main list of index surgeries
use index surgery list that already has next claims merged in*/
proc sql;
create table mp_cont_stay_16 as select 
a.*,b.merge_clm_prev
from sur_int.index_surgery_next_merge a left join
mp_cont_stay_15 b
on (a.BID_HRS=b.BID_HRS);
quit;
proc freq;
table merge_clm_prev;
run;

/*get list of index surgery claims that need merge*/
data surg_need_merge_p;
set mp_cont_stay_16(where=(merge_clm_prev=1));
run;

/*create a table of just the pre-surgery claims to merge into surgery claim info*/
proc sql;
create table sur_int.surg_prev_to_merge as select 
* from mp_cont_stay_14 
where bid_hrs in (select bid_hrs from surg_need_merge_p);
quit;


/*create table of index surgeries with additional claim information added*/
proc sql;
create table sur_int.index_surgery_prev as select
a.*,b.DGNS_CD01 as pc_DGNS_CD_01, b.DGNS_CD02 as pc_DGNS_CD_02,b.DGNS_CD03 as pc_DGNS_CD_03,b.DGNS_CD04 as pc_DGNS_CD_04,b.DGNS_CD05 as pc_DGNS_CD_05,b.DGNS_CD06 as pc_DGNS_CD_06,b.DGNS_CD07 as pc_DGNS_CD_07,b.DGNS_CD08 as pc_DGNS_CD_08,b.DGNS_CD09 as pc_DGNS_CD_09,b.DGNS_CD10 as pc_DGNS_CD_10,b.admit_date as pc_admit_date, b.DSCHRGCD as pc_DSCHRGCD, b.DSTNTNCD as pc_DSTNTNCD
from  mp_cont_stay_16 a left join
sur_int.surg_prev_to_merge b
on a.bid_hrs=b.bid_hrs
;
quit;

/*check the merge - should be 25 claims with this info added*/
proc freq;table
pc_DGNS_CD_01;
run;

/*replace index surgery information with that of the previous claim
where applicable*/
data sur_int.index_surgery_prev_merge ;
set sur_int.index_surgery_prev ;
if merge_clm_prev=1 then do;
	is_admit_date = pc_admit_date;
	LOSCNT = is_disch_date-is_admit_date;
	end;
run;

/*check los calculation*/
proc freq data=sur_int.index_surgery_prev_merge(where=(merge_clm_prev=1));
table LOSCNT ;
run;

/*rename dataset with index surgery information containing additional claims info*/
data sur_int.index_surg_w_clms;
set sur_int.index_surgery_prev_merge;
run;


H="Index surgery information defined"
/*Add information about index surgery claim

Information needed is:
From index surgery claim
1. Complications 
From index surgery hospital overall stay
2. LOS 
3. Discharge destination code

Resulting dataset is saved as:
sur_int.index_sur_stay

Also save intermediate dataset sur_int.hospital_stays
Use list of all hospital stays to determine number of 
hospitalizations pre-surgery and details re. post-surgery
hospitalizations later in the code

*/

/*************************************************************************/
/*Identify complications from dx codes for index surgery
Dataset created: sur_int.compl*/
/*************************************************************************/

data sur_int.compl;
set sur_int.last_surgery_date;

dx_1=trim(left(DGNSCD01));
if dx_1~="" then do;
	
/*initialize complications variables*/
comp_uti=0;
comp_pe=0;
comp_pne=0;
comp_inf=0;
comp_rf=0;
comp_kid=0;
comp_mi=0;
comp_del=0;
comp_any=0;
end;

array dx DGNSCD01-DGNSCD25 ;
do over dx;
/*UTI*/
if substr(dx,1,4)='5990' and comp_uti=0 
	then comp_uti=1;

/*PE*/
if substr(dx,1,4)='4151' and comp_pe=0 
	then comp_pe=1;

/*Pneumonia*/
if (substr(dx,1,3)='480'
	or substr(dx,1,3)='481'
	or substr(dx,1,3)='482'
	or substr(dx,1,3)='483'
	or substr(dx,1,3)='484'
	or substr(dx,1,3)='485'
	or substr(dx,1,3)='486')
	 and comp_pne=0 
	then comp_pne=1;


/*Surgical Site Infection*/
if substr(dx,1,5)='99859'
	 and comp_inf=0 
	then comp_inf=1;

/*Acute Resp Failure*/
if substr(dx,1,5)='51881' and comp_rf=0
	then comp_rf=1;

/*Acute kidney failure*/
if (substr(dx,1,4)='5845'
	or substr(dx,1,4)='5846'
	or substr(dx,1,4)='5847'
	or substr(dx,1,4)='5848'
	or substr(dx,1,4)='5849')
	and comp_kid=0 
	then comp_kid=1;

/*MI*/
if substr(dx,1,3)='410'	and comp_mi=0 
	then comp_mi=1;

/*Delirium*/
if (substr(dx,1,4)='2930'
	or substr(dx,1,4)='2931')
	 and comp_del=0 
	then comp_del=1;

if (comp_uti=1  
	or comp_pe=1
	or comp_pne=1
	or comp_inf=1
	or comp_rf=1	
	or comp_kid=1
	or comp_mi=1
	or comp_del=1)
	and comp_any=0
	then comp_any=1; 

end;
run;

proc freq;
table comp_uti comp_pe comp_pne comp_inf comp_rf comp_kid comp_mi comp_del;
run;

proc freq;
table comp_any;
run;


/*************************************************************************/
/*Check for presence of complications dx codes in admitting dx field
Decision made not to include admitting dx in the dx codes used to determine
if complications were present during the index surgery stay*/
/*************************************************************************/

/*************************************************************************/
/*************************************************************************/
/*************************************************************************/

/*************************************************************************/
/*Identify hospital stay that contain the index surgery                  */
/*************************************************************************/

/*Step 1 - Check index surgery / claim list to see if all claims
have the surgery procedure date within the admit date and discharge
date time window*/
/*check procedure dates in list of index surgeries*/
data index_surg_stay_test;
set sur_int.compl;
index_stay_test=0;
if (is_admit_date<= procedure_date <= is_disch_date) then index_stay_test=1;
run;
/*6 index surgeries are not within their original claim dates*/
proc freq;
table index_stay_test;
run;
data index_surg_stay_test2;
set index_surg_stay_test(where=(index_stay_test=0));
run;
/*these surgeries are all 1 day prior to the claim start date
so recode stay start date as day of the surgery*/

/*Step 2 - For the 6 observations where the procedure date
is coded as 1 day before admission, re-code admission
start date as the procedure date */
proc sql;
create table index_surg_stay_2 as select * from sur_int.ip_cont_stay_clms_merged
where bid_hrs_21 in (select bid_hrs_21 from index_surg_stay_test2);
quit;

data index_surg_stay_3;
set index_surg_stay_2 ;
st_proc=stay_start - procedure_date;
if (st_proc = 1) then do;
	mod_stay_start=1;
	stay_start=procedure_date;
	end;
label mod_stay_start="Indicator for start day modified to include procedure date in stay";
drop st_proc;
run;

proc freq;
table mod_stay_start;
run;

/*Step 3 - Bring in the modified stay_start date to the overall list of hopsital stays*/
/*first check list of surgeries stays for duplicates*/
proc sort data=sur_int.ip_cont_stay_clms_merged out=test2 nodupkey;
by bid_hrs_21 stay_end;
run;

proc sql;
create table index_surg_stay_4 as select
a.*,b.mod_stay_start,b.stay_start as new_stay_start from
sur_int.ip_cont_stay_clms_merged a left join
index_surg_stay_3 b
on (a.bid_hrs_21=b.bid_hrs_21 and a.stay_end=b.stay_end);
quit;

proc freq;
table mod_stay_start;
run;

data index_surg_stay_5 ;
set index_surg_stay_4 ;
if mod_stay_start=1 then stay_start=new_stay_start;
drop daydiff_prev dstn_cd_cont new_stay_start;
if mod_stay_start=. then mod_stay_start=0;
run;

proc freq;
table mod_stay_start ind_clm_merge /missprint;
run;

/*Step 4 - assign indicator to index surgery hospital stays*/
/*save this list of hospital stays with the indicator to use
to look at pre and post surgery hospitalizations
This is list of all ip stays for the cohort that had an
index surgery indentified
5091 unique hospital stays*/
data sur_int.hospital_stays;
set index_surg_stay_5;
index_stay=0;
if (stay_start<= procedure_date <= stay_end) then index_stay=1;
run;

/*995 index surgeries identified, this matches the index surgery claim list*/
proc freq;
table index_stay;
run;

/*************************************************************************/
/*Need to merge in index surgery stay start/end dates  
Replacing is_admit_date and is_disch_date from claims with dates
from overall stay (in cases where stay info is merged from mult claims   */
/*************************************************************************/
data index_surg_1;
set sur_int.hospital_stays (keep=bid_hrs_21 procedure_date is_admit_date is_disch_date stay_start stay_end index_stay);
if index_stay=1;
run;

data index_surg_2;
set index_surg_1;
is_admit_date=stay_start;
is_disch_date=stay_end;
run;

/*merge in index surgery start end dates to overall hospital stay
dataset*/
proc sql;
create table hospital_stays_r2 as select a.*,b.is_admit_date as
	is_admit_date_new, b.is_disch_date as is_disch_date_new from
sur_int.hospital_stays a
left join index_surg_2 b
on (a.bid_hrs_21=b.bid_hrs_21);
quit;

data sur_int.hospital_stays_2;
set hospital_stays_r2;
drop is_admit_date is_disch_date;
rename is_admit_date_new=is_admit_date;
rename is_disch_date_new=is_disch_date;
run;

/*************************************************************************/
/*Merge in stay start date / end date to index
surgery claim information with complications indicators                  */
/*************************************************************************/

/*drop is_admit and is_disch dates from complications dataset
so can add in updated dates from surgery stay (not individ claims*/
data compl_1;
set sur_int.compl;
drop is_admit_date is_disch_date;
run;

/*list of surgery claims to merge the start / end day information in to*/
proc sort data=compl_1;
by bid_hrs_21 procedure_date;
run;

/*get list of just index surgery stay information to merge*/
data index_surg_stay_7;
set sur_int.hospital_stays_2(where=(index_stay=1));
run;

proc sort data=index_surg_stay_7;
by bid_hrs_21 procedure_date;
run;

proc sql;
create table index_sur_stay_8 as select 
	a.*, b.stay_start, b.stay_end,b.stus_cd as stay_dstn_cd, 
	b. mod_stay_start, b.ind_clm_merge, b.is_admit_date, b.is_disch_date
from compl_1 a left join
index_surg_stay_7 b
on (a.bid_hrs_21=b.bid_hrs_21 and a.procedure_date=b.procedure_date);
quit;

proc freq;
table stay_dstn_cd mod_stay_start ind_clm_merge;
run;

/*check of days from stay start to surgery
most should be within a day or two and they are*/
data index_sur_stay_9;
set index_sur_stay_8 ;
days_to_surg = procedure_date-stay_start;
run;

proc freq;
table days_to_surg;
run;

/*Calculate length of stay for index surgery
This is last calculation so save this version of the data to the int_data folder*/
data sur_int.index_sur_stay;
set index_sur_stay_9;
index_LOS=stay_end - stay_start;
if index_LOS=0 then index_LOS=1;
run;

proc freq;
table index_LOS /missprint;
run;

/*************************************************************************/
/*View Discharge status - Do not have this var in ip claims*/
/*************************************************************************/
/*A = discharged alive, B = discharged dead 
proc freq data=sur_int.index_sur_stay;
table DSCHRGCD /missprint;
run;
*/
/*************************************************************************/
/*View Discharge destination status*/
/*************************************************************************/
/* See medpar appendix for additional codes
01 = discharged to home / self care (routine charge)
02 = Discharged/transferred to other short term general hospital for inpatient care.
03 = Discharged/transferred to skilled nursing facility (SNF)
04 = Discharged/transferred to intermediate care facility (ICF).
05 = Discharged/transferred to another type of institution for inpatient care.
06 = Discharged/transferred to home health service organization.
20 = Expired (did not recover - Christian Science patient).
50 = Hospice - home 
51 = Hospice - medical facility 
61 = Discharged/transferred within this institution to a hospital-based Medicare
approved swing bed
62 = Discharged/transferred to an inpatient rehab. facility including distinct
parts units of a hospital.
63 = Discharged/transferred to a long term care hospitals.
*/

proc freq data=sur_int.index_sur_stay;
table stay_dstn_cd /missprint;
run;




H="Check for medicare parts a and b or hmo coverage"
/*
last_surgery_date
to have part a part b in the last 6m, and no hmo
Use mc denominator file to determine insurance status*/


/*sort denominator file, remove duplicate entries on id and year*/
proc sort data=medi.dn_2000_2012 out=dn_2000_20122  nodupkey;
by bid_hrs_21 year;
run;

/*latest surgery year variable defined*/
data r_sp;
set sur_int.index_sur_stay;
r_year=year(procedure_date);
run;

/*pull medicare ab status and hmo status variables from dn file
for latest surgery year from above*/
proc sql;
create table dn_surg_y as select
a.*,b.buyin12,b.year,b.HMOIND12
from r_sp a inner join
dn_2000_20122 b
on trim(left(a.bid_hrs_21))=trim(left(b.bid_hrs_21))
and a.r_year=b.year;
quit;

/*check frequency for surgery years*/
proc freq data=dn_surg_y;
table r_year;
run;
/*955 surgeries that meet criteria with denominator data*/
proc sql;
select count(distinct bid_hrs_21) from dn_surg_y;
quit;

/* Trim buyin and hmo variables to only reflect time before the surgery */
data dn_surg_y2;
set dn_surg_y;
surg_month=month(procedure_date);
if length(trim(left(buyin12)))=12 and surg_month>0 then do;
buyin_sy=substr(trim(left(buyin12)),1,surg_month);
hmo_sy=substr(trim(left(HMOIND12)),1,surg_month);
end;
else do;
buyin_sy=trim(left(buyin12));
hmo_sy=trim(left(HMOIND12));
end;
run;
proc means n;
var  surg_month;
run;

/*Look at year prior to surgery to get records of complete 12 months prior to surgery
only have the -1 year dn file
If surgery was within 1 year or 6 months of Jan 2000, then get null for buyin_ vars*/
proc sql;
create table dn_surg_y_bef as select
a.bid_hrs_21,a.year as surg_year,b.year as surg_year_bef,b.year,b.buyin12,b.HMOIND12
from dn_surg_y a inner join
dn_2000_20122 b
on trim(left(a.bid_hrs_21))=trim(left(b.bid_hrs_21))
and 0<a.year-b.year<=1 order by bid_hrs_21,year;
quit;

proc sql;
create table all_insurance as select a.*,b.buyin12 as buyin_bef,b.HMOIND12 as hmo_bef from
dn_surg_y2 a
left join
dn_surg_y_bef b
on trim(left(a.bid_hrs_21))=trim(left(b.bid_hrs_21));
quit;

/*merge surgery year and year before surgery buy-in and hmo variables
Trim so the final variable _1y shows 12 months pre-surgery
Variable _6m is 6 months pre-surgery
Note: indicator variables for parts a and b and hmo are null if don't
have information for full 12 or 6 months pre-surgery*/
data all_insurance2;
set all_insurance;
buyin_2y=trim(left(buyin_bef))||trim(left(buyin_sy));
hmo_2y=trim(left(hmo_bef))||trim(left(hmo_sy));

/*create 12 month variables*/
buyin_2y_r=reverse(trim(buyin_2y));
hmo_2y_r=reverse(trim(hmo_2y));

if length(buyin_2y_r)>11 then buyin_1y_r=substr(trim(left(buyin_2y_r)),1,12);
if length(hmo_2y_r)>11 then hmo_1y_r=substr(trim(left(hmo_2y_r)),1,12);

if length(buyin_2y_r)<12 then buyin_1y_r="";
if length(hmo_2y_r)<12 then hmo_1y_r="";

buyin_1y=reverse(trim(buyin_1y_r));
hmo_1y=reverse(trim(hmo_1y_r));

/*create indicator variable for mc coverage 0=no, 1=yes*/
if length(buyin_1y)=12 then do;
if indexc(buyin_1y,"0","1","2","A","B") then part_ab_1y=0;
if indexc(buyin_1y,"0","1","2","A","B")=0 then part_ab_1y=1;
end;
/*create indicator variable for hmo coverage 0=no, 1=yes*/
if length(hmo_1y)=12 then do;
if index(hmo_1y,"00000000000") then hmo_d_1y=0;
if index(hmo_1y,"00000000000")=0 then hmo_d_1y=1;
end;

/*create 6 month variable*/
if length(buyin_2y_r)>5 then buyin_6m_r=substr(trim(left(buyin_2y_r)),1,6);
if length(hmo_2y_r)>5 then hmo_6m_r=substr(trim(left(hmo_2y_r)),1,6);

if length(buyin_2y_r)<6 then buyin_6m_r="";
if length(hmo_2y_r)<6 then hmo_6m_r="";

buyin_6m=reverse(trim(buyin_6m_r));
hmo_6m=reverse(trim(hmo_6m_r));

/*create indicator variable for mc coverage 6 mo. 0=no, 1=yes*/
if length(buyin_6m)=6 then do;
if indexc(buyin_6m,"0","1","2","A","B") then part_ab_6m=0;
if indexc(buyin_6m,"0","1","2","A","B")=0 then part_ab_6m=1;
end;
if length(hmo_6m)=6 then do;
if index(hmo_6m,"00000") then hmo_d_6m=0;
if index(hmo_6m,"00000")=0 then hmo_d_6m=1;
end;

run;

/*42 observations were within 6months of Jan. 2000 so don't have 6 months pre-surgery data*/
proc freq;
table part_ab_6m*hmo_d_6m;
run;

/*91 observations were within 12months of Jan. 2000 so don't have 12 months pre-surgery data*/
proc freq;
table part_ab_1y*hmo_d_1y;
run;

/*bring in gender, reason for entitlement, dob, esrd indicator
 from claims denominator file*/
proc sql;
create table all_ins_gender as select a.*,b.sex,b.CREC,b.BENE_DOB,b.esrd_ind, b.DEATH_DT from
all_insurance2 a
left join dn_2000_20122 b
on trim(left(a.bid_hrs_21))=trim(left(b.bid_hrs_21))
and a.year=b.year;
quit;

proc freq data=all_ins_gender;
table sex CREC esrd_ind CREC*esrd_ind /missprint;
run;

proc contents order=casecollate data=all_ins_gender;
run;

data surgery_ids_last_1(drop=dgnscd01-dgnscd25 ad_dgns BUYIN12 HMOIND12 
surg_month year buyin_1y_r buyin_2y buyin_2y_r r_year buyin_6m_r 
buyin_bef buyin_sy dx_1 hmo_1y_r hmo_2y hmo_2y_r hmo_6m_r hmo_bef hmo_sy);
set all_ins_gender;
rename sex=claims_sex;
rename bene_dob=claims_dob;
rename esrd_ind=claims_esrd_ind;
rename DEATH_DT=claims_dod;
run;

proc freq data=surgery_ids_last_1;
table claims_dod /missprint;
run;

/*deal with claims dod missing values that are coded as "00000000"
and change format for dob and dod to dates*/
data surgery_ids_last_2;
set surgery_ids_last_1;
if claims_dod=00000000 then claims_dod=.;
claims_dob2=input(claims_dob,yymmdd8.);
claims_dod2=input(claims_dod,yymmdd8.);
run;

proc freq;
table claims_dod2 /missprint;
run;

data sur_fin.surgery_ids_last;
set surgery_ids_last_2;
drop claims_dob claims_dod;
format claims_dob2 date10. claims_dod2 date10.;
label claims_dob2="Beneficiary dob from claims" claims_dod2="Beneficiary dod from claims";
run;

proc freq data=sur_fin.surgery_ids_last;
table TYPE_ADM surgery_meet part_ab_6m hmo_d_6m /missprint;
run;



H="Identify number of hospital admissions 6 months before surgery"
/*Start with list of all hospital stays for bid's with an index surgery:
sur_int.hospital_stays_2

Identify number of hospital admissions in the 6 months prior to
the index surgery procedure date

Merge count of pre-hospital stays into dataset: sur_fin.surgery_ids_last

Final dataset created: sur_fin.surgery_ids_6m_pre_adm 
*/

/*Identify all stays 6 months pre-surgery*/

/*start with list of all hospital stays*/
proc sort data=sur_int.hospital_stays_2;
by bid_hrs_21;
run;

/*drop stays that are the index stay*/
data pre_surg_hosp_1;
set sur_int.hospital_stays_2(where=(index_stay=0));
run;

/*identify stays that are 6 months pre-surgery date*/
data pre_surg_hosp_2 ;
set pre_surg_hosp_1 ;
if 0 <= procedure_date-stay_start<=183;
run;


/*Identify stays that are partially within the time from procedure date*/
data pre_surg_hosp_3 ;
set pre_surg_hosp_1 ;
if (procedure_date-stay_start>183 and procedure_date-stay_end<=183);
run;

/*merge the two lists*/
data pre_surg_hosp_4;
set pre_surg_hosp_2 pre_surg_hosp_3 ;
run;

proc sort data=pre_surg_hosp_4;
by bid_hrs_21 stay_start;
run;

/*Assign count variable to count claims in 6 months pre-surgery for each bid*/
data pre_surg_adm_count;
set pre_surg_hosp_4;
admit_6m_pre +1;
by bid_hrs_21;
if first.bid_hrs_21 then admit_6m_pre =1;
run;

proc freq;
table admit_6m_pre;
run;

/*keep only the  final count of pre-surgery admissions*/
proc sort data=pre_surg_adm_count;
by bid_hrs_21 stay_start;
run;

data pre_surg_adm_count_1;
set pre_surg_adm_count;
by bid_hrs_21;
if last.bid_hrs_21;
run;
/*319 patients had an ip admission within the 6 months pre-surgery*/
proc freq;
table admit_6m_pre;
run;

/**************************************************************************************/
/*Bring count of pre-surgery claims in to main dataset*/
/**************************************************************************************/

/*Merge count of hospital admissions pre-surgery into dataset*/
proc sql;
create table surgery_ids_6m_pre_adm_1 as select
a.*, b.admit_6m_pre
from sur_fin.surgery_ids_last a left join
pre_surg_adm_count_1 b
on trim(left(a.bid_hrs_21))=trim(left(b.bid_hrs_21));
quit;

proc freq;
table admit_6m_pre;
run;

/*create indicator variable for pre-surgery hospital admission
= 0 - no pre surgery admissions
= 1 - one or more pre surgery admissions
if no pre-surgery admission, set number admissions to zero */
data sur_fin.surgery_ids_6m_pre_adm;
set surgery_ids_6m_pre_adm_1;
if admit_6m_pre=. then admit_6m_pre=0;
admit_ind_6m_pre=0;
if admit_6m_pre>0 then admit_ind_6m_pre=1;
run;


/*************************************************************************/
/*View Number of Admissions 6 months pre-surgery
saves freq tables to file in C:\data\surgery\2012_update\logs*/
/*************************************************************************/

ods rtf file='E:\data\surgery\2012_update\logs\pre-surg.rtf';
proc freq;
table admit_6m_pre admit_ind_6m_pre /missprint;
run;
ods rtf close;

proc sort data=sur_fin.surgery_ids_6m_pre_adm ;
by admit_6m_pre;
run;


/*************************************************************************/
/*Check high number of admissions beneficiaries
The table generated shows the claim prior to the index surgery claim*/
/*************************************************************************/
proc sql;
create table high_pre_surg_cl as select *
from sur_fin.surgery_ids_6m_pre_adm
where admit_6m_pre>5;
quit;

/*all claims for those high admissions beneficiaries*/
proc sql;
create table high_pre_surg_cl_2 as select *
from pre_surg_adm_count
where bid_hrs_21 in
(select bid_hrs_21 from high_pre_surg_cl);
quit;


H="Identify post-surgery hospitalizations"
/*
/*Start with list of all hospital stays for bid's with an index surgery:
sur_int.hospital_stays

Merge into dataset with 6 month pre-surg. admission count
sur_fin.surgery_ids_6m_pre_adm

Information needed:
1. # hospital admissions
2. # days to first hospital admission post surgery
3. # days in hospital, inpatient setting
4. Indicator for hospital death per claims discharge code??

Resulting dataset is:
sur_fin.surgery_ids_post_adm
*/

/****************************************************************/
/*Determine number of admissions in 12 months post surgery*/
/****************************************************************/

/****************************************************************/
/*Identify IP hospital stays 12 months post surgery*/
/****************************************************************/

proc sort data=sur_int.hospital_stays_2;
by bid_hrs_21;
run;

/*drop stays that are the index stay*/
data post_surg_hosp_1;
set sur_int.hospital_stays_2(where=(index_stay=0));
run;

/*identify stays that are 12 months post-surgery date*/
data post_surg_hosp_2 ;
set post_surg_hosp_1 ;
if 0 <= stay_end - procedure_date <= 365;
run;


/*Identify stays that are partially within the time from procedure date*/
data post_surg_hosp_3 ;
set post_surg_hosp_1 ;
if (stay_end - procedure_date >365 and stay_start-procedure_date<=365);
run;

/*merge the two lists*/
data post_surg_hosp_4;
set post_surg_hosp_2 post_surg_hosp_3 ;
run;

/*740 hospital stays identified*/
proc sort data=post_surg_hosp_4;
by bid_hrs_21 stay_start;
run;

/****************************************************************/
/*Assign count for stays 12 months post surgery*/
/****************************************************************/

/*Assign count variable to count claims in 12 months post-surgery for each bid*/
data post_surg_adm_count;
set post_surg_hosp_4;
admit_12m_post +1;
by bid_hrs_21;
if first.bid_hrs_21 then admit_12m_post =1;
run;

proc freq;
table admit_12m_post ;
run;

/*keep only the final count of post-surgery admissions*/
proc sort data=post_surg_adm_count;
by bid_hrs_21 stay_start;
run;

data post_surg_adm_count_1;
set post_surg_adm_count;
by bid_hrs_21;
if last.bid_hrs_21;
label admit_12m_post ="Hospital IP Admissions 12 months post-surgery";
run;
/*365 patients had an ip admission within the 12 months post-surgery*/
proc freq;
table admit_12m_post;
run;

/****************************************************************/
/*Determine date from surgery to 1st admission post-surgery */
/****************************************************************/

/*create table with the first post-surgery claim only
use that admission date to determine days from surgery to admission
variables are blank if no post-surgery admission*/
data adm_post_date;
set post_surg_adm_count(where=(admit_12m_post=1));
frst_post_admt_dt=stay_start;
label frst_post_admt_dt ="Date of first post-surgery hospital admission";
days_post_surg_to_adm=frst_post_admt_dt - procedure_date;
label days_post_surg_to_adm ="Days from surgery to first post-surgery admission";
run;

proc sort data=adm_post_date;
by days_post_surg_to_adm;
run;

proc freq data=adm_post_date;
table days_post_surg_to_adm;
run;



/*look at bid=H100014421 to see this person's claims,
he was admitted the day after the procedure date*/
data check2;
set post_surg_hosp_4(rename=(clm_id=post_clm)) sur_int.hospital_stays(rename=(clm_id=surg_clm));
where bid_hrs_21='H100014421';
run;
/*checks out - transferred to long term care hospital after index surgery*/

/****************************************************************/
/*Determine total days spent in the hospital 1 year post-surgery */
/****************************************************************/
data post_hosp_days_1;
set post_surg_adm_count;
calc_stay_LOS=stay_end-stay_start;
if calc_stay_LOS=0 then calc_stay_LOS=1 ;
run;

proc sort data=post_hosp_days_1;
by bid_hrs_21 stay_start;
run;

proc sql;
create table adm_tot_hosp_days_post as select distinct bid_hrs_21,sum(calc_stay_LOS)
	as hosp_days_post_12m
	from post_hosp_days_1 group by bid_hrs_21;
quit;

proc freq;
table hosp_days_post_12m;
run;

/****************************************************************/
/*Merge new variables into index hosp dataset */
/****************************************************************/
/*Merge count of hospital admissions post-surgery into dataset
This is the dataset that already includes the pre-surgery admissions count*/

proc sql;
create table surgery_ids_post_adm_1 as select
a.*, b.admit_12m_post 
from sur_fin.surgery_ids_6m_pre_adm a left join
post_surg_adm_count_1 b
on trim(left(a.bid_hrs_21))=trim(left(b.bid_hrs_21));
quit;

/*create indicator variable for post-surgery hospital admission
= 0 - no post surgery admissions
= 1 - one or more post surgery admissions
if no post-surgery admission, set number admissions to zero */
data surgery_ids_post_adm_2 ;
set surgery_ids_post_adm_1 ;
if admit_12m_post=. then admit_12m_post=0;
admit_ind_12m_post=0;
if admit_12m_post>0 then admit_ind_12m_post=1;
run;

/*Merge date to first admission post surgery into dataset*/

proc sql;
create table surgery_ids_post_adm_3 as select
a.*, b.frst_post_admt_dt, b.days_post_surg_to_adm
from surgery_ids_post_adm_2 a left join
adm_post_date b
on trim(left(a.bid_hrs_21))=trim(left(b.bid_hrs_21));
quit;

/*Merge in number hospital days 12 months post surgery*/

proc sql;
create table 
sur_fin.surgery_ids_post_adm_a as select
a.*,coalesce(b.hosp_days_post_12m,0) as hosp_days_post_12m
from surgery_ids_post_adm_3 a
left join
adm_tot_hosp_days_post b
on trim(left(a.bid_hrs_21))=trim(left(b.bid_hrs_21));
quit;

/*************************************************************************/
/*View Number of Admissions 12 months post-surgery*/
/*************************************************************************/
proc freq;
table admit_12m_post admit_ind_12m_post days_post_surg_to_adm 
	hosp_days_post_12m /missprint;
run;

/*************************************************************************/
/*Look for indicator of hospital death 12 months post-surgery*/
/*************************************************************************/

/*46 obs have death indicated from IP claims in the 12m post-surgery*/
proc freq data=post_surg_hosp_4;
table STUS_CD;
run;

data hosp_death_1;
set post_surg_hosp_4;
if  STUS_CD=20;
run;

proc sort data=hosp_death_1 nodupkey;
by bid_hrs_21;
run;

data hosp_death_2(keep=bid_hrs_21 mp_dod mp_dod_ind);
set hosp_death_1;
mp_dod = disch_date;
mp_dod_ind = 1;
label mp_dod="Death date from IP/SNF claims"
mp_dod_ind="Indicator for DOD from IP/SNF claims";
run;

/*bring in IP death date to dataset*/
proc sql;
create table 
sur_fin.surgery_ids_post_adm as select
a.*,b.mp_dod,b.mp_dod_ind
from sur_fin.surgery_ids_post_adm_a a
left join
hosp_death_2 b
on trim(left(a.bid_hrs_21))=trim(left(b.bid_hrs_21));
quit;

proc freq;
table mp_dod_ind /missprint;
run;

/*final dataset is sur_fin.surgery_ids_post_adm*/


H="Identify SNF days 12 months post surgery"
/*Identify SNF claims 12 months after index surgery

Start with file with pre- and post- surgery ip admissions information:
sur_fin.surgery_ids_post_adm

Get 1 year post-surgery SNF information:
1. SNF indicator
2. SNF days
3. SNF death from discharge destination code?

Dataset saved is: sur_fin.surgery_ids_post_adm_snf2*/

/*Identify snf claims from the medpar file*/
data sur_int.snf_2000_2012;
set medi.mp_2000_2012(where=(trim(left(SSLSSNF))="N"));
run;

/*Identify claims within 1 year from procedure date
Use dataset which includes the claim id
Creates 1 file sur_int.snf_meet_post_365*/

/*Filter claims list by date range post-surgery
Note this contains the surgery admission
Do in multiple steps to check that it works*/

/*step 1: only keep claims where the bid had an index surgery
895 claims identified*/
proc sql;
create table snf_meet1_post_365_step1 as select a.*,b.procedure_date
from sur_int.snf_2000_2012 a inner join
sur_fin.surgery_ids_last b
on trim(left(a.bid_hrs_21))=trim(left(b.bid_hrs_21)) ;
quit;

/*step 2: drop claims where admission date is pre-surgery date
620 claims identified (895 - 620 = 275 clams were pre-surgery)*/
proc sql;
create table snf_meet1_post_365_step2 as select *
from snf_meet1_post_365_step1 
where 0<=(admit_date - procedure_date); 
quit;

/*step 3: drop claims where admit date is more than 1 year from surgery date
Left with 301 claims where admit date is within 1 year of surgery*/
proc sql;
create table snf_meet1_post_365_step3 as select *
from snf_meet1_post_365_step2 
where (admit_date - procedure_date)<365; 
quit;

/*Identify claims entirely within 1 year post surgery
Step 4: drop claims that aren't entirely within 1 year from surgery date
298 claims left, so 3 claims start within 1 year but patient isn't
discharged until after 1 year, need to count these patients seperately
to calculate the number of days spent in the SNF in the year post-surgery*/
proc sql;
create table snf_meet1_post_365 as select *
from snf_meet1_post_365_step3 
where (disch_date - procedure_date)<365; 
quit;


/*Identify claims that are partially within the time from procedure date*/
proc sql;
create table snf_meet2_post_365 as select *
from snf_meet1_post_365_step3 
where (disch_date - procedure_date)>=365; 
quit;

/*For claims partially in 1 year of surgery, truncate end date to just get 
days w/i 1 year
create indicator variable that claim end date is truncated*/
data snf_meet2_post_365_1;
set snf_meet2_post_365;
disch_date = procedure_date+365;
snf_disch_date_mod = 1;
label snf_disch_date_mod = "Disch date mod; at 12 mo from proced date";
format disch_date date10.;
run;

proc freq;
table snf_disch_date_mod ;
run;

data snf_meet_post_365;
set snf_meet1_post_365 snf_meet2_post_365_1;
run;

proc freq;
table snf_disch_date_mod ;
run;


/*save final files to project int_data directory*/
data sur_int.snf_meet_post_365 ;
set  snf_meet_post_365;
run;

/*check claims dates are actually either including the surgery procedure date
or after procedure date*/
data snf_test;
set sur_int.snf_meet_post_365;
pro_to_snf_admit=admit_date - procedure_date;
run;

proc freq; 
table pro_to_snf_admit;
run;

/*************************************************************/
/*calculate total number of days spent in SNF by BID*/
/*************************************************************/

data post_snf_days_1;
set sur_int.snf_meet_post_365;
calc_snf_LOS=disch_date-admit_date;
run;

proc sort data=post_snf_days_1;
by bid_hrs_21 admit_date;
run;

proc sql;
create table adm_tot_snf_days_post as select distinct bid_hrs_21,sum(calc_snf_LOS)
	as snf_days_post_12m
	from post_snf_days_1 group by bid_hrs_21;
quit;

proc freq;
table snf_days_post_12m;
run;

data zzztest_snf1;
set adm_tot_snf_days_post(where=(snf_days_post_12m>100));
run;

proc sql;
create table zzztest_snf2 
as select calc_snf_LOS,procedure_date,admit_date,disch_date,bid_hrs_21
from post_snf_days_1 where bid_hrs_21 in (select bid_hrs_21 from zzztest_snf1);
quit;

data zzztest_snf3;
set zzztest_snf2;
format disch_date date10. admit_date date10.;
pro_to_disch = disch_date - procedure_date;
run;

 

/*calculate snf utilization days total for bid
This is a check because snf days should be capped at 100
6 observations have >100 snf utilization days*/
proc sql;
create table util_days as select distinct
bid_hrs_21,sum(util_day) as snf_util_post_12m
from post_snf_days_1 group by bid_hrs_21;
quit;

proc freq;
table snf_util_post_12m;
run;



/*************************************************************/
/*Merge into main dataset that already contains the hospital
stay information post and pre surgery
resulting dataset name is sur_fin.surgery_ids_post_adm_snf2*/
/*************************************************************/
proc sql;
create table 
sur_fin.surgery_ids_post_adm_snf as select
a.*,coalesce(b.snf_days_post_12m,0) as snf_days_post_12m
from sur_fin.surgery_ids_post_adm a
left join
adm_tot_snf_days_post b
on trim(left(a.bid_hrs_21))=trim(left(b.bid_hrs_21));
quit;


proc sql;
create table 
sur_fin.surgery_ids_post_adm_snf2a as select
a.*,coalesce(b.snf_util_post_12m,0) as snf_util_days_post_12m
from sur_fin.surgery_ids_post_adm_snf a
left join
util_days b
on trim(left(a.bid_hrs_21))=trim(left(b.bid_hrs_21));
quit;


ods rtf file='E:\data\surgery\2012_update\logs\post-surg.rtf';
proc freq data=sur_fin.surgery_ids_post_adm_snf2a;
table admit_12m_post admit_ind_12m_post days_post_surg_to_adm 
	hosp_days_post_12m snf_days_post_12m snf_util_days_post_12m /missprint ;
run;
ods rtf close;

/*************************************************************/
/*Check individuals with more than 100 days SNF*/
/*************************************************************/
data table test_snf_1; 
set sur_fin.surgery_ids_post_adm_snf2a;
if snf_days_post_12m>100;
run;

proc sql;
create table test_snf_2
as select * from sur_int.snf_meet_post_365  
where bid_hrs_21 in (select bid_hrs_21 from test_snf_1);
quit;

proc freq data=sur_int.snf_meet_post_365;
table PRVNUM3;
run;

proc freq data=test_snf_2;
table PRVNUM3;
run;

data test_snf_3(keep=bid_hrs_21 admit_date disch_date procedure_date exhst_dt los_snf qlfyfrom qlfythru cvrlvldt loscnt util_day wrngcd);
set test_snf_2;
bene_exh_date=exhst_dt;
if exhst_dt=0000000 then exhst_dt=.;
if exhst_dt=0 then  exhst_dt=.;
bene_exh_date = datejul(exhst_dt);
format admit_date date10.;
format disch_date date10.;
*format bene_exh_date date10.;
los_snf = disch_date-admit_date;
run; 

/*
data test_snf_3;
set test_snf_2;
keep bid_hrs admit_date disch_date procedure_date bene_exh_date los_snf qlfyfrom_n qlfythru_n adm_qual dis_qual;
if exhst_dt=0000000 then bene_exh_date=.;
bene_exh_date = datejul(exhst_dt);
qlfyfrom_n = datejul(qlfyfrom);
qlfythru_n = datejul(qlfythru);
format admit_date date10.;
format disch_date date10.;
format bene_exh_date date10.;
los_snf = disch_date-admit_date;
adm_qual = admit_date - qlfyfrom;
dis_qual = disch_date - qlfythru;
run; 
*/

proc sort data=test_snf_3;
by bid_hrs_21 admit_date disch_date;
run;

/*no claims overlap to cause the > 100 days
all admit dates within 1 year of procedure date (so no cases of long
stays that started more than 1 year before procedure date causing us to
count days that weren't within 1 year of surgery*/
data test_snf_4;
set test_snf_3;
day_diff_pro = procedure_date - admit_date;
by bid_hrs_21;
	day_diff_clm = admit_date - lag(disch_date);
	if first.bid_hrs_21 then day_diff_clm=.;
run;

proc freq;
table day_diff_clm day_diff_pro ;
run;


/*************************************************************************/
/*Look for indicator of hospital death 12 months post-surgery*/
/*************************************************************************/

/*17 obs have death indicated from IP claims in the 12m post-surgery*/
proc freq data=snf_meet1_post_365_step3;
table  DSCHRGCD*DSTNTNCD;
run;

data snf_death_1;
set snf_meet1_post_365_step3;
if DSTNTNCD=20;
run;

proc sort data=snf_death_1 nodupkey;
by bid_hrs_21;
run;

data snf_death_2(keep=bid_hrs_21 snf_dod snf_dod_ind);
set snf_death_1;
snf_dod = disch_date;
snf_dod_ind = 1;
run;

/*bring in SNF death date to dataset*/
proc sql;
create table 
surgery_ids_post_adm_snf2b as select
a.*,b.snf_dod,b.snf_dod_ind
from sur_fin.surgery_ids_post_adm_snf2a a
left join
snf_death_2 b
on trim(left(a.bid_hrs_21))=trim(left(b.bid_hrs_21));
quit;

/*1 obs has death from IP and SNF claim
Checked and the IP death date is later than the SNF date so use IP*/
proc freq;
table mp_dod_ind*snf_dod_ind /missprint;
run;

data zztest;
set surgery_ids_post_adm_snf2b ;
if mp_dod_ind=1 & snf_dod_ind=1;
run;

/*if no IP death date, use SNF death date*/
data sur_fin.surgery_ids_post_adm_snf2(drop=snf_dod snf_dod_ind);
set surgery_ids_post_adm_snf2b;
if mp_dod = . then mp_dod=snf_dod;
if mp_dod_ind = . then mp_dod_ind=snf_dod_ind;
run;

proc freq;
table mp_dod_ind /missprint;
run;
/*final dataset is sur_fin.surgery_ids_post_adm_snf2*/


H="Identify claims within 6 mo's and 12 mo's of surgery"
/*Identify claims of all types 6 months and 12 months before surgery
Use these claims lists to identify Elixhauser comorbidities and
chronic conditions*/

/*start of MACRO */

/*Macro for all claims files except for medpar
Run this twice to get two sets of files: xx_meet_###
xx = claim type
### days before surgery (183=6 months, 365=12 months*/
%macro other(days_start=,days_bef_surg=,source=);

/*Identify claims within certain time from procedure date defined when run macro*/
proc sql;
create table &source._meet_&days_bef_surg. as select a.*,b.procedure_date
from medi.&source._2000_2012 a inner join
sur_fin.surgery_ids_last b
on trim(left(a.bid_hrs_21))=trim(left(b.bid_hrs_21))
and &days_start<=b.procedure_date-a.admit_date<=&days_bef_surg;
quit;
run;

%mend;

/*Macro for medpar claims
Creates file mp_meet3_###
where ### = 183 or 365 - days before surgery*/
%macro mp(days_start=,days_bef_surg=,source=);
%let source0=mp;

/*Identify claims within certain time from procedure date*/
proc sql;
create table &source._meet_&days_bef_surg. as select a.*,b.procedure_date
from medi.&source0._2000_2012 a inner join
sur_fin.surgery_ids_last b
on trim(left(a.bid_hrs_21))=trim(left(b.bid_hrs_21)) 
and &days_start<=b.procedure_date-a.admit_date<=&days_bef_surg ;
quit;

/*Identify claims that are partially within the time from procedure date*/
proc sql;
create table &source._meet2_&days_bef_surg. as select a.*,b.procedure_date
from medi.&source0._2000_2012 a inner join
sur_fin.surgery_ids_last b
on trim(left(a.bid_hrs_21))=trim(left(b.bid_hrs_21))
and b.procedure_date-a.admit_date>&days_bef_surg and b.procedure_date-a.disch_date<=&days_bef_surg;
quit;

data &source._meet3_&days_bef_surg.;
set &source._meet_&days_bef_surg &source._meet2_&days_bef_surg;
run;

run;

%mend;

/*Run macros to identify claims that are within 6 months of the surgery date*/
%mp(days_start=0,days_bef_surg=183,source=mp );
%other(days_start=0,days_bef_surg=183,source=hh );
%other(days_start=0,days_bef_surg=183,source=hs );
%other(days_start=0,days_bef_surg=183,source=dm );
%other(days_start=0,days_bef_surg=183,source=op );
%other(days_start=0,days_bef_surg=183,source=pb );

/*Run macros to identify claims that are within 1 year of the surgery date*/
%mp(days_start=0,days_bef_surg=365,source=mp );
%other(days_start=0,days_bef_surg=365,source=hh );
%other(days_start=0,days_bef_surg=365,source=hs );
%other(days_start=0,days_bef_surg=365,source=dm );
%other(days_start=0,days_bef_surg=365,source=op );
%other(days_start=0,days_bef_surg=365,source=pb );


H="Identify all dx codes within 6 and 12 months"

/* Two files created:
1. dx_0_n6m: dx 6 months from surgery date
2. dx_0_n12m: dx 12 months from surgery date

Saved in E:\data\surgery\2012_update\int_data

One macro runs through all claim types to determine dx codes present

range1 = 0 - name for final output file
range2 = n6m or n12m - name for final output file
days_bef_surg = 183 or 365 - identifies claims dataset to start with*/

%macro dx_time_range(range1=, range2=, days_bef_surg=);

/*Process carrier medicare claims to pull out dx codes
Starts with pb_meet which is list of claims 6 / 12 months pre-surgery
List of all diagnosis codes in 6 / 12 months pre-surgery
Multiple lines per each BID*/
data pb_last_&range2._dx(keep=bid_hrs_21 diag);
set pb_meet_&days_bef_surg.(keep=bid_hrs_21 PDGNS_CD DGNSCD01-DGNSCD12 );
array dx PDGNS_CD DGNSCD01-DGNSCD12;
do over dx;
diag=dx ;
output;
end;
run;
/*check for and remove duplicates, note this doesn't remove blanks*/
proc sort data=pb_last_&range2._dx out=pb_last_&range2._dx2 nodupkey;
by bid_hrs_21 diag;
run;


/*Process outpatient medicare claims to pull out dx codes
Dataset being created: op_last_&range2._dx2*/
data op_last_&range2._dx(keep=bid_hrs_21 diag);
set op_meet_&days_bef_surg.(keep=bid_hrs_21 PDGNS_CD DGNSCD01-DGNSCD25  );
array dx PDGNS_CD DGNSCD01-DGNSCD25 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=op_last_&range2._dx out=op_last_&range2._dx2 nodupkey;
by bid_hrs_21 diag;
run;

/*Process medpar medicare claims to pull out dx codes
Dataset being created: mp_last_&range2._dx2*/
data mp_last_&range2._dx(keep=bid_hrs_21 diag);
set mp_meet3_&days_bef_surg.(keep=bid_hrs_21 AD_DGNS DGNS_CD01-DGNS_CD25 );
array dx AD_DGNS DGNS_CD01-DGNS_CD25 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=mp_last_&range2._dx out=mp_last_&range2._dx2 nodupkey;
by bid_hrs_21 diag;
run;

/*Process dme medicare claims to pull out dx codes
Dataset being created: dm_last_&range2._dx2*/
data dm_last_&range2._dx(keep=bid_hrs_21 diag);
set dm_meet_&days_bef_surg.(keep=bid_hrs_21 PDGNS_CD DGNSCD01-DGNSCD12 );
array dx PDGNS_CD DGNSCD01-DGNSCD12 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=dm_last_&range2._dx out=dm_last_&range2._dx2 nodupkey;
by bid_hrs_21 diag;
run;

/*Process hh medicare claims to pull out dx codes
Dataset being created: dm_last_&range2._dx2*/
data hh_last_&range2._dx(keep=bid_hrs_21 diag);
set hh_meet_&days_bef_surg.(keep=bid_hrs_21 PDGNS_CD DGNSCD01-DGNSCD25 );
array dx PDGNS_CD DGNSCD01-DGNSCD25 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=hh_last_&range2._dx out=hh_last_&range2._dx2 nodupkey;
by bid_hrs_21 diag;
run;

/*Process hs medicare claims to pull out dx codes
Dataset being created: dm_last_&range2._dx2*/
data hs_last_&range2._dx(keep=bid_hrs_21 diag);
set hs_meet_&days_bef_surg.(keep=bid_hrs_21 PDGNS_CD DGNSCD01-DGNSCD25 );
array dx PDGNS_CD DGNSCD01-DGNSCD25 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=hs_last_&range2._dx out=hs_last_&range2._dx2 nodupkey;
by bid_hrs_21 diag;
run;


/*set diag variable length = 7 chars since that's the max length from the mc claims
Need to do this because length varies across the different mc claim types*/
data hs_last_&range2._dx3;
length diag $7;
set hs_last_&range2._dx2;
run;
data hh_last_&range2._dx3;
length diag $7;
set hh_last_&range2._dx2;
run;
data mp_last_&range2._dx3;
length diag $7;
set mp_last_&range2._dx2;
run;
data dm_last_&range2._dx3;
length diag $7;
set dm_last_&range2._dx2;
run;
data op_last_&range2._dx3;
length diag $7;
set op_last_&range2._dx2;
run;
data pb_last_&range2._dx3;
length diag $7;
set pb_last_&range2._dx2;
run;


/*merge diagnoses from each claim type into single dataset*/
data dx_all_last_&range2.;
set hs_last_&range2._dx3
hh_last_&range2._dx3
mp_last_&range2._dx3
dm_last_&range2._dx3
op_last_&range2._dx3
pb_last_&range2._dx3;
run;
proc sort data=dx_all_last_&range2.(where=(diag~="")) out=sur_int.dx_&range1._&range2 nodupkey;
by bid_hrs_21 diag;
run;

%mend;


/*run the macro - 6 months pre-surgery - get sas dataset sur_int.dx_0_n6m*/
%dx_time_range(range1=0, range2=n6m, days_bef_surg=183);
/*run the macro - 12 months pre-surgery - get sas dataset sur_int.dx_0_n12m*/
%dx_time_range(range1=0, range2=n12m, days_bef_surg=365);


H="Add Elixhauser index"
/*Elixhauser index created in two files

sur_fin.surgery_ids_last_n6m
sur_fin.surgery_ids_last_n12m

One for 6 months pre-surgery and one for 12 months pre-surgery
Merged with index surgery, pre- and post-surgery hospitalization and 
insurance information collected in the previous sections of this
outline code

CAD defined with ICD-9 codes as defined by CMS here:
http://www.mdinteractive.com/files/uploaded/file/cms2013group/CAD_2013_CMS.pdf
*/

/*    Macro rename 
lib=library
dsn=dataset name
pre=suffix to be added to all of the variable names
*/

%macro rename(lib,dsn,pre);
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "Before Renaming All Variables";
run;

proc sql noprint;
select nvar into :num_vars
from dictionary.tables
where libname="&LIB" and
memname="&DSN";
select distinct(name) into :var1-
:var%TRIM(%LEFT(&num_vars))
from dictionary.columns
where libname="&LIB" and
memname="&DSN";
quit;
run;

proc datasets library=&LIB;
modify &DSN;
rename
%do i=1 %to &num_vars;
&&var&i=&&var&i.._&pre 
%end;
;
quit;
run;
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "After Renaming All Variables";
run;
%mend rename;





/*Elixhauser index macro
Note includes additional 2 comorbidities: Dementia and Coronary Artery Disease*/

%macro elixhauser(range1=, range2=);

data dx_31_comor_&range2;
set sur_int.dx_&range1._&range2(rename=(diag=dx_0));
dx=trim(left(dx_0));

if dx~="" then do;

comorbi_1=0;
comorbi_2=0;
comorbi_3=0;
comorbi_4=0;
comorbi_5=0;
comorbi_6=0;
comorbi_7=0;
comorbi_8=0;
comorbi_9=0;
comorbi_10=0;
comorbi_11=0;
comorbi_12=0;
comorbi_13=0;
comorbi_14=0;
comorbi_15=0;
comorbi_16=0;
comorbi_17=0;
comorbi_18=0;
comorbi_19=0;
comorbi_20=0;
comorbi_21=0;
comorbi_22=0;
comorbi_23=0;
comorbi_24=0;
comorbi_25=0;
comorbi_26=0;
comorbi_27=0;
comorbi_28=0;
comorbi_29=0;
comorbi_30=0;
*end of intialize of 30 binary variables;
*add dementia and CAD;
dementia=0;
cad=0;

*do over dx;
	*Congestive Heart Failure;
	if (substr(dx,1,5)='39891' or
		substr(dx,1,5)='40211' or
		substr(dx,1,5)='40291' or
		substr(dx,1,5)='40411' or
		substr(dx,1,5)='40413' or
		substr(dx,1,5)='40491' or
		substr(dx,1,5)='40493' or
		substr(dx,1,3)='428') 
		and comorbi_1=0 
		then comorbi_1=1;*add one binary variables here.;
	*Cardiac Arrhythmias;
	if (substr(dx,1,5)='42610' or
		substr(dx,1,5)='42611' or
		substr(dx,1,5)='42613' or
		substr(dx,1,4)='4262' or
		substr(dx,1,4)='4263' or
		substr(dx,1,4)='4264' or
		substr(dx,1,5)='42650' or
		substr(dx,1,5)='42651' or
		substr(dx,1,5)='42652' or
		substr(dx,1,5)='42653' or
		substr(dx,1,4)='4266' or
		substr(dx,1,4)='4267' or
		substr(dx,1,4)='4268' or
		substr(dx,1,4)='4270' or
		substr(dx,1,4)='4272' or
		substr(dx,1,5)='42731' or
		substr(dx,1,5)='42760' or
		substr(dx,1,4)='4279' or
		substr(dx,1,4)='7850' or
		substr(dx,1,4)='V450' or
		substr(dx,1,4)='V533')
			and comorbi_2=0 
		then comorbi_2=1;
	* Valvular Disease ;
	if (substr(dx,1,5)='09320' or
		substr(dx,1,5)='09321' or
		substr(dx,1,5)='09322' or
		substr(dx,1,5)='09323' or
		substr(dx,1,5)='09324' or
		substr(dx,1,3)='394' or
		substr(dx,1,3)='395' or
		substr(dx,1,3)='396' or
		substr(dx,1,4)='3970' or
		substr(dx,1,4)='3971' or
		substr(dx,1,4)='4240' or
		substr(dx,1,4)='4241' or
		substr(dx,1,4)='4242' or
		substr(dx,1,4)='4243' or
		substr(dx,1,4)='4244' or
		substr(dx,1,4)='4245' or
		substr(dx,1,4)='4246' or
		substr(dx,1,4)='4247' or
		substr(dx,1,4)='4248' or
		substr(dx,1,5)='42490' or
		substr(dx,1,5)='42491' or
		substr(dx,1,4)='7463' or
		substr(dx,1,4)='7464' or
		substr(dx,1,4)='7465' or
		substr(dx,1,4)='7466' or
		substr(dx,1,4)='V422' or
		substr(dx,1,5)='V433')
			and comorbi_3=0 
		then comorbi_3=1;
	*Pulmonary Circulation Disorders;
	if (substr(dx,1,3)='416' or
		substr(dx,1,4)='4179')
			and comorbi_4=0 
		then comorbi_4=1;
	*Peripheral Vascular Disorders;
	if (substr(dx,1,3)='440' or
		substr(dx,1,4)='4412' or
		substr(dx,1,4)='4414' or
		substr(dx,1,4)='4417' or
		substr(dx,1,4)='4419' or
		substr(dx,1,4)='4431' or
		substr(dx,1,4)='4432' or
		substr(dx,1,4)='4438' or
		substr(dx,1,4)='4439' or
		substr(dx,1,4)='4471' or
		substr(dx,1,4)='5571' or
		substr(dx,1,4)='5579' or
		substr(dx,1,4)='V434')
			and comorbi_5=0 
		then comorbi_5=1;
	*Hypertension;
	if ((substr(dx,1,4)='4011' or
		substr(dx,1,4)='4019')) or
	   ((substr(dx,1,5)='40210' or
		substr(dx,1,5)='40290' or
		substr(dx,1,5)='40410' or
		substr(dx,1,5)='40490' or
		substr(dx,1,5)='40511' or
		substr(dx,1,5)='40519' or
		substr(dx,1,5)='40591' or
		substr(dx,1,5)='40599')) 
			and comorbi_6=0 
		then comorbi_6=1;
	*Paralysis;	
	if (substr(dx,1,4)='3420' or
		substr(dx,1,5)='34210' or
		substr(dx,1,5)='34211' or
		substr(dx,1,5)='34212' or
		substr(dx,1,4)='3429' or
		substr(dx,1,3)='343' or
		substr(dx,1,3)='344')
			and comorbi_7=0 
		then comorbi_7=1;
	*Other Neurological Disorders;
	if (substr(dx,1,4)='3319' or
		substr(dx,1,4)='3320' or
		substr(dx,1,4)='3334' or
		substr(dx,1,4)='3335' or
		substr(dx,1,3)='334' or
		substr(dx,1,3)='335' or
		substr(dx,1,3)='340' or
		substr(dx,1,4)='3411' or
		substr(dx,1,4)='3418' or
		substr(dx,1,4)='3419' or
		substr(dx,1,5)='34500' or
		substr(dx,1,5)='34501' or
		substr(dx,1,5)='34510' or
		substr(dx,1,5)='34511' or
		substr(dx,1,4)='3454' or
		substr(dx,1,5)='34550' or
		substr(dx,1,5)='34551' or
		substr(dx,1,4)='3458' or
		substr(dx,1,5)='34590' or
		substr(dx,1,5)='34591' or
		substr(dx,1,4)='3481' or
		substr(dx,1,4)='3483' or
		substr(dx,1,4)='7803' or
		substr(dx,1,4)='7843') 
			and comorbi_8=0 
		then comorbi_8=1;	
	*Chronic Pulmonary Disease;
	if (substr(dx,1,3)='490' or
		substr(dx,1,3)='491' or
		substr(dx,1,3)='492' or
		substr(dx,1,4)='4930' or
		substr(dx,1,4)='4931' or
		substr(dx,1,4)='4932' or
		substr(dx,1,4)='4938' or
		substr(dx,1,5)='49390' or
		substr(dx,1,5)='49391' or
		substr(dx,1,3)='494' or
		substr(dx,1,3)='495' or
		substr(dx,1,3)='496' or
		substr(dx,1,3)='497' or
		substr(dx,1,3)='498' or
		substr(dx,1,3)='499' or
		substr(dx,1,3)='500' or
		substr(dx,1,3)='501' or
		substr(dx,1,3)='502' or
		substr(dx,1,3)='503' or
		substr(dx,1,3)='504' or
		substr(dx,1,3)='505' or
		substr(dx,1,4)='5064') 
			and comorbi_9=0 
		then comorbi_9=1;	
	*Diabetes, uncomplicated;
	if (substr(dx,1,4)='2500' or
		substr(dx,1,4)='2501' or
		substr(dx,1,4)='2502' or
		substr(dx,1,4)='2503') 
			and comorbi_10=0 
		then comorbi_10=1;
	*Diabetes, complicated;
	if (substr(dx,1,4)='2504' or
		substr(dx,1,4)='2505' or
		substr(dx,1,4)='2506' or
		substr(dx,1,4)='2507' or
		substr(dx,1,4)='2509') 
			and comorbi_11=0 
		then comorbi_11=1;
	*Hypothyroidism;
	if (substr(dx,1,3)='243' or
		substr(dx,1,4)='2440' or
		substr(dx,1,4)='2441' or
		substr(dx,1,4)='2442' or
		substr(dx,1,4)='2448' or
		substr(dx,1,4)='2449') 	
			and comorbi_12=0 
		then comorbi_12=1;
	*Renal Failure;
	if (substr(dx,1,5)='40311' or
		substr(dx,1,5)='40391' or
		substr(dx,1,5)='40412' or
		substr(dx,1,5)='40492' or
		substr(dx,1,3)='585' or
		substr(dx,1,3)='586' or
		substr(dx,1,4)='V420' or
		substr(dx,1,4)='V451' or
		substr(dx,1,4)='V560' or
		substr(dx,1,4)='V568') 
			and comorbi_13=0 
		then comorbi_13=1;
	*Liver Disease;
	if (substr(dx,1,5)='07032' or
		substr(dx,1,5)='07033' or
		substr(dx,1,5)='07054' or
		substr(dx,1,4)='4560' or
		substr(dx,1,4)='4561' or
		substr(dx,1,5)='45620' or
		substr(dx,1,5)='45621' or
		substr(dx,1,4)='5710' or
		substr(dx,1,4)='5712' or
		substr(dx,1,4)='5713' or
		substr(dx,1,4)='5714' or
		substr(dx,1,4)='5715' or
		substr(dx,1,4)='5716' or
		substr(dx,1,4)='5718' or
		substr(dx,1,4)='5719' or
		substr(dx,1,4)='5723' or
		substr(dx,1,4)='5728' or
		substr(dx,1,4)='V427') 
			and comorbi_14=0 
		then comorbi_14=1;
	*Peptic Ulcer Disease excluding bleeding;
	if (substr(dx,1,5)='53170' or
		substr(dx,1,5)='53190' or
		substr(dx,1,5)='53270' or
		substr(dx,1,5)='53290' or
		substr(dx,1,5)='53370' or
		substr(dx,1,5)='53390' or
		substr(dx,1,5)='53470' or
		substr(dx,1,5)='53490' or
		substr(dx,1,5)='V1271') 
			and comorbi_15=0 
		then comorbi_15=1;
	*AIDS;
	if (substr(dx,1,3)='042' or
		substr(dx,1,3)='043' or
		substr(dx,1,3)='044') 
			and comorbi_16=0 
		then comorbi_16=1;
	*Lymphoma;
	if (substr(dx,1,3)='200' or
		substr(dx,1,4)='201' or
		substr(dx,1,4)='2020' or
		substr(dx,1,4)='2021' or
		substr(dx,1,4)='2022' or
		substr(dx,1,4)='2023' or
		substr(dx,1,4)='2025' or
		substr(dx,1,4)='2026' or
		substr(dx,1,4)='2027' or
		substr(dx,1,4)='2028' or
		substr(dx,1,4)='2029' or
		substr(dx,1,4)='2030' or
		substr(dx,1,4)='2038' or
		substr(dx,1,4)='2386' or
		substr(dx,1,4)='2733' or
		substr(dx,1,4)='V1071' or
		substr(dx,1,4)='V1072' or
		substr(dx,1,4)='V1079')
			and comorbi_17=0 
		then comorbi_17=1;
	*Metastatic Cancer;
	if (substr(dx,1,3)='196' or
		substr(dx,1,3)='197' or
		substr(dx,1,3)='198' or
		substr(dx,1,4)='199') 
			and comorbi_18=0 
		then comorbi_18=1;	
	*Solid Tumor without Metastisis;
	if (substr(dx,1,2)='14' or
		substr(dx,1,2)='15' or
		substr(dx,1,2)='16' or
		substr(dx,1,3)='170' or
		substr(dx,1,3)='171' or
		substr(dx,1,3)='172' or
		substr(dx,1,3)='174' or
		substr(dx,1,3)='175' or
		substr(dx,1,3)='179' or
		substr(dx,1,2)='18' or
		substr(dx,1,3)='190' or
		substr(dx,1,3)='191' or
		substr(dx,1,3)='192' or
		substr(dx,1,3)='193' or
		substr(dx,1,3)='194' or
		substr(dx,1,3)='195' or
		substr(dx,1,3)='V10')
			and comorbi_19=0 
		then comorbi_19=1;
	*Rheumatoid Arthritis/Collagen Vascular Diseases;
	if (substr(dx,1,4)='7010' or
		substr(dx,1,3)='710' or
		substr(dx,1,3)='714' or
		substr(dx,1,3)='720' or
		substr(dx,1,3)='725') 
			and comorbi_20=0 
		then comorbi_20=1;
	*Coagulopathy;
	if (substr(dx,1,3)='286' or
		substr(dx,1,4)='2871' or
		substr(dx,1,4)='2873' or
		substr(dx,1,4)='2874' or
		substr(dx,1,4)='2875') 
			and comorbi_21=0 
		then comorbi_21=1;
	*Obesity;
	if (substr(dx,1,4)='2780')  
			and comorbi_22=0 
		then comorbi_22=1;
	*Weight Loss;
	if (substr(dx,1,3)='260' or
		substr(dx,1,3)='261' or
		substr(dx,1,3)='262' or
		substr(dx,1,3)='263') 
			and comorbi_23=0 
		then comorbi_23=1;	
	*Fluid and Electrolyte Disorders;
	if (substr(dx,1,3)='276') 
			and comorbi_24=0 
		then comorbi_24=1;
	*Blood Loss Anemia;
	if (substr(dx,1,4)='2800') 
			and comorbi_25=0 
		then comorbi_25=1;
	*Deficiency Anemias;
	if (substr(dx,1,4)='2801' or
		substr(dx,1,4)='2808' or
		substr(dx,1,4)='2809' or
		substr(dx,1,4)='2859') 
			and comorbi_26=0 
		then comorbi_26=1;
	*Alcohol Abuse;
	if (substr(dx,1,4)='2911' or
		substr(dx,1,4)='2912' or
		substr(dx,1,4)='2915' or
		substr(dx,1,4)='2918' or
		substr(dx,1,4)='2919' or
		substr(dx,1,4)='3039' or
		substr(dx,1,4)='3050' or
		substr(dx,1,4)='V113') 
			and comorbi_27=0 
		then comorbi_27=1;
	*Drug Abuse;
	if (substr(dx,1,4)='2920' or
		substr(dx,1,5)='29282' or
		substr(dx,1,5)='29283' or
		substr(dx,1,5)='29284' or
		substr(dx,1,5)='29289' or
		substr(dx,1,4)='2929' or
		substr(dx,1,3)='304' or
		substr(dx,1,4)='3052' or
		substr(dx,1,4)='3053' or
		substr(dx,1,4)='3054' or
		substr(dx,1,4)='3055' or
		substr(dx,1,4)='3056' or
		substr(dx,1,4)='3057' or
		substr(dx,1,4)='3058' or
		substr(dx,1,4)='3059')
			and comorbi_28=0 
		then comorbi_28=1;	
	*Psychoses;
	if (substr(dx,1,3)='295' or
		substr(dx,1,3)='296' or
		substr(dx,1,3)='297' or
		substr(dx,1,3)='298' or
		substr(dx,1,4)='2991') 
			and comorbi_29=0 
		then comorbi_29=1;
	*Depression;
	if (substr(dx,1,4)='3004' or
		substr(dx,1,5)='30112' or
		substr(dx,1,4)='3090' or
		substr(dx,1,4)='3091' or
		substr(dx,1,3)='311')
			and comorbi_30=0 
		then comorbi_30=1;


	*Dementia;
	if (substr(dx,1,4) in ('3310','3311','3312','2900','2901',
             '2902','2903','2912','2948','2949') or
		substr(dx,1,5) in ('29410','29411','29040','29041','29042','29043')) 
		and dementia=0 
          then dementia=1;

	*CAD coronary artery disease;
	if (substr(dx,1,4) in ('4140','4142','4143','4148','4149') or 
		substr(dx,1,3) in ('410','411','412','413') or
		substr(dx,1,5) in ('V4581','V4582'))
		and cad=0 
          then cad=1;

/* CAD list
410.00-410.92
411.0-411.89
412
413.0-413.9
414.00-414.07
414.2
414.3
414.8
414.9
V45.81
V45.82 */

end;
run;


/*check sums of each comorbidity for each ID*/
proc sql;
create table com_test1_&range2 as
select distinct bid_hrs_21,
sum(comorbi_1) as com_1,
sum(comorbi_2) as com_2,
sum(comorbi_3) as com_3,
sum(comorbi_4) as com_4,
sum(comorbi_5) as com_5,
sum(comorbi_6) as com_6,
sum(comorbi_7) as com_7,
sum(comorbi_8) as com_8,
sum(comorbi_9) as com_9,
sum(comorbi_10) as com_10,
sum(comorbi_11) as com_11,
sum(comorbi_12) as com_12,
sum(comorbi_13) as com_13,
sum(comorbi_14) as com_14,
sum(comorbi_15) as com_15,
sum(comorbi_16) as com_16,
sum(comorbi_17) as com_17,
sum(comorbi_18) as com_18,
sum(comorbi_19) as com_19,
sum(comorbi_20) as com_20,
sum(comorbi_21) as com_21,
sum(comorbi_22) as com_22,
sum(comorbi_23) as com_23,
sum(comorbi_24) as com_24,
sum(comorbi_25) as com_25,
sum(comorbi_26) as com_26,
sum(comorbi_27) as com_27,
sum(comorbi_28) as com_28,
sum(comorbi_29) as com_29,
sum(comorbi_30) as com_30,
sum(dementia) as com_31,
sum(cad) as com_32
from dx_31_comor_&range2
group by bid_hrs_21;
quit;

/*define comorbidities as binary indicators*/
data comorbidity_&range2.(keep=bid_hrs_21 comorb_1-comorb_32 comorb_all);
set com_test1_&range2;
array list_com com_1-com_30 com_31 com_32;
array list_com_bin comorb_1-comorb_30 comorb_31 comorb_32;

/*note this defines comorbidity 31 = dementia & 32 = cad*/
do over list_com;
  list_com_bin=0;

  if list_com>0 then do;
    list_com_bin=1;
   end;

end;

/*define aggregate comorbidity as sum of 30 individual indicator vars.
note: CAD not included in this aggregate score*/
comorb_all=comorb_1+comorb_2+comorb_3+comorb_4+comorb_5+comorb_6+comorb_7+
comorb_8+comorb_9+comorb_10+comorb_11+comorb_12+comorb_13+comorb_14+
comorb_15+comorb_16+comorb_17+comorb_18+comorb_19+comorb_20+comorb_21+
comorb_22+comorb_23+comorb_24+comorb_25+comorb_26+comorb_27+comorb_28+
comorb_29+comorb_30+comorb_31;
run;


proc sort data=comorbidity_&range2. nodupkey;
by bid_hrs_21;
run;

/*merges with table of most recent surgeries by id*/
proc sql;
create table ids_meet_criteria_&range2.13 as
select a.*,b.*
from sur_fin.surgery_ids_6m_pre_adm
a left join
comorbidity_&range2. b
on trim(left(a.bid_hrs_21))=trim(left(b.bid_hrs_21));
quit;

/*if comorbidity=null, set to zero*/
data sur_int.elix_&range1._&range2;
set ids_meet_criteria_&range2.13;
array list comorb_1-comorb_31 comorb_all;
do over list;
if list=. then list=0;
end;

label comorb_1 ="Congestive Heart Failure";
label comorb_2 ="Cardiac Arrhythmias";
label comorb_3 ="Valvular Disease";
label comorb_4 ="Pulmonary Circulation Disorders";
label comorb_5 ="Peripheral Vascular Disorders";
label comorb_6 ="Hypertension";
label comorb_7 ="Paralysis";
label comorb_8 ="Other Neurological Disorders";
label comorb_9 ="Chronic Pulmonary Disease";
label comorb_10 ="Diabetes, uncomplicated";
label comorb_11 ="Diabetes, complicated";
label comorb_12 ="Hypothyroidism";
label comorb_13 ="Renal Failure";
label comorb_14 ="Liver Disease";
label comorb_15 ="Peptic Ulcer Disease excluding bleeding";
label comorb_16 ="AIDS";
label comorb_17 ="Lymphoma";
label comorb_18 ="Metastatic Cancer";
label comorb_19 ="Solid Tumor without Metastisis";
label comorb_20 ="Rheumatoid Arthritis/Collagen Vascular Diseases";
label comorb_21 ="Coagulopathy";
label comorb_22 ="Obesity";
label comorb_23 ="Weight Loss";
label comorb_24 ="Fluid and Electrolyte Disorders";
label comorb_25 ="Blood Loss Anemia";
label comorb_26 ="Deficiency Anemias";
label comorb_27 ="Alcohol Abuse";
label comorb_28 ="Drug Abuse";
label comorb_29 ="Psychoses";
label comorb_30 ="Depression";
label comorb_31 ="Dementia";
label comorb_32 ="Coronary Artery Disease";
run;


data test;
set sur_int.elix_&range1._&range2;
run;

/*calls rename macro*/
%rename(WORK,TEST,&range1._&range2);

/*rename bid_hrs_&range1._&range2=bid_hrs*/
data sur_int.elix_&range1._&range2._2(rename =(bid_hrs_21_&range1._&range2=bid_hrs_21));
set test;
keep bid_hrs_21_&range1._&range2 comorb:;
run;
proc sort data=sur_int.elix_&range1._&range2._2;
by bid_hrs_21;
run;

%mend;


/*run macro to get elixhauser comorbidities 6 and 12 months pre-surgery*/
%elixhauser(range1=0, range2=n6m);
%elixhauser(range1=0, range2=n12m);


proc freq;
table comorb:;
run;
proc contents data=sur_int.elix_0_n6m_2;
run;
proc contents data=sur_int.elix_0_n12m_2;
run;


/* merge surgery information and elixhauser comorbidities 
Resulting 2 files are:
sur_fin.surgery_ids_last_n6m
sur_fin.surgery_ids_last_n12m
With elixhauser comorbidities for 6 months and 12 months pre-surgery*/ 

%macro mergeel(range2=);
proc sql;
create table sur_fin.surgery_ids_last_&range2(drop=BID_hrs2) as select a.*,
b.*
from 
sur_fin.surgery_ids_post_adm_snf2 a left join
sur_int.elix_0_&range2._2(rename=(bid_hrs_21=BID_hrs2)) b
on trim(left(a.bid_hrs_21))=trim(left(b.BID_hrs2));
quit;
%mend;

%mergeel(range2=n6m);
%mergeel(range2=n12m);

proc freq data=sur_fin.surgery_ids_last_n6m;
table comorb:;
run;

proc freq data=sur_fin.surgery_ids_last_n12m;
table comorb:;
run;


H="Add chronic conditions"
/*begin of chronic 21 conditions.
Need to do two times, one for 6 month pre-surgery, one for 12 months pre-surgery

Note this pulls from a list of icd-9 codes associated with each of the chronic
conditions. The file path may need to be updated depending on the PC the
code is run from
*/

/*export list of diagnosis codes to stata*/
proc export data=sur_int.dx_0_n6m
outfile="E:\data\surgery\2012_update\int_data\dx_0_n6m.dta" replace;
run;

proc export data=sur_int.dx_0_n12m
outfile="E:\data\surgery\2012_update\int_data\dx_0_n12m.dta" replace;
run;

/*******************************************************************/
/*put the sas data to stata in to dot format
This is STATA code*/
/*
/*******************************************************************/

clear
set memory 500m

//process diagnosis codes 6 months pre-surgery
use "E:\data\surgery\2012_update\int_data\dx_0_n6m.dta",clear

// convert diagnosis codes to string variables, tostring diag,gen(icd9_c)
gen new=ltrim(diag)
icd9 check new,gen(icd9_c)
replace new="" if icd9_c>0 
// convert into dot format (ex 12.1 instead of 121)
icd9 clean new,dots 

replace diag=new
drop icd9_c new

saveold "E:\data\surgery\2012_update\int_data\dx_0_n6m_2.dta",replace

//process diagnosis codes 12 months pre-surgery
clear
use "E:\data\surgery\2012_update\int_data\dx_0_n12m.dta",clear

// convert diagnosis codes to string variables, tostring diag,gen(icd9_c)
gen new=ltrim(diag)
icd9 check new,gen(icd9_c)
replace new="" if icd9_c>0 
// convert into dot format (ex 12.1 instead of 121)
icd9 clean new,dots 

replace diag=new
drop icd9_c new

saveold "E:\data\surgery\2012_update\int_data\dx_0_n12m_2.dta",replace

/*******************************************************************/
//Convert back to SAS
//This is SAS Code
/* to the cms 21 chronic comorbidity*/ /*******************************************************************/

/*bring in formatted Stata dataset of dx codes*/
proc import 
datafile="E:\data\surgery\2012_update\int_data\dx_0_n6m_2.dta" 
out=dx_0_n6m_2 replace;
run;

proc import 
datafile="E:\data\surgery\2012_update\int_data\dx_0_n12m_2.dta" 
out=dx_0_n12m_2 replace;
run;


/*bring in excel list of dx codes associated with each chronic condition*/
proc import /*datafile="C:\projects\Hospice_impact_on_utilization\raw_data\chronic_21_condition_icd9.xls" */
datafile='E:\data\surgery\2012_update\ref_data\chronic_21_condition_icd9.xls'
out=icd9_21_chronic dbms=xls replace;
run;
data icd9_21_chronic2;
set icd9_21_chronic;
/*create new variable of icd 9 code list NOT in dot format
Don't actually use this variable in the following code*/
icd9_wo_dot=compress(icd_9,".");
run;
proc contents data=icd9_21_chronic;
run;

/*creates macro variables of each of the chronic conditions listing of dx codes*/
proc sql;
select icd_9 into :chronic_desc1-:chronic_desc21 from icd9_21_chronic;
quit;
%put &chronic_desc10;
%put &chronic_desc5;

/*******************************************************************/
/*Generate chronic conditions indicator variables using dx
codes 6 months and 12 months pre-surgery */
/*******************************************************************/

/*macro to create indicator variables for 21 chronic conditions
results are two files, one with chronic conditions using dx codes 6 
months pre-surgery, one with dx codes 12 months pre-surgery
presurg = n6m or n12m */

%macro cc(presurg=);

/*initialize the chronic conditions variables*/
data list_&presurg._dx;
set dx_0_&presurg._2;
array list CC_1_AMI
CC_2_ALZH
CC_3_ALZHDMTA
CC_4_ATRIALFB
CC_5_CATARACT
CC_6_CHRNKIDN
CC_7_COPD
CC_8_CHF
CC_9_DIABETES
CC_10_GLAUCOMA
CC_11_HIPFRAC
CC_12_ISCHMCHT
CC_13_DEPRESSN
CC_14_OSTEOPRS
CC_15_RA_OA
CC_16_STRKETIA
CC_17_CNCRBRST
CC_18_CNCRCLRC
CC_19_CNCRPRST
CC_20_CNCRLUNG
CC_21_CNCREndM
;
do over list ;
list=0;
end;

diag_string=diag;

/* for dx codes that begin with numbers, process chronic cond variables*/
if anydigit(substr(trim(left(diag_string)),1,1))=1 then do;
diag=diag_string+0;

if diag in (&chronic_desc1) then CC_1_AMI=1;
if diag in (&chronic_desc2)  then CC_2_ALZH=1;
if diag in (&chronic_desc3)  then CC_3_ALZHDMTA=1;
if diag in (&chronic_desc4) then CC_4_ATRIALFB=1;
if diag in (&chronic_desc5) then CC_5_CATARACT=1;
if diag in (&chronic_desc6) then CC_6_CHRNKIDN=1;
if diag in (&chronic_desc7) then CC_7_COPD=1;
if diag in (&chronic_desc8) then CC_8_CHF=1;
if diag in (&chronic_desc9) then CC_9_DIABETES=1;
if diag in (&chronic_desc10) then CC_10_GLAUCOMA=1;
if diag in (&chronic_desc11) then CC_11_HIPFRAC=1;
if diag in (&chronic_desc12) then CC_12_ISCHMCHT=1;
if diag in (&chronic_desc13) then CC_13_DEPRESSN=1;
if diag in (&chronic_desc14) then CC_14_OSTEOPRS=1;
if diag in (&chronic_desc15) then CC_15_RA_OA=1;
if diag in (&chronic_desc16) then CC_16_STRKETIA=1;
if diag in (&chronic_desc17) then CC_17_CNCRBRST=1;
if diag in (&chronic_desc18) then CC_18_CNCRCLRC=1;
if diag in (&chronic_desc19) then CC_19_CNCRPRST=1;
if diag in (&chronic_desc20) then CC_20_CNCRLUNG=1;
if diag in (&chronic_desc21) then CC_21_CNCREndM=1;
end;

/*deal with dx codes that start with letters
Only two of them in the list we have to worry about*/
if anydigit(substr(trim(left(diag_string)),1,1))=0 then do;
if trim(left(diag_string)) in ("V431") then CC_5_CATARACT=1;
if trim(left(diag_string)) in ("V801") then CC_10_GLAUCOMA=1;
end;

run;

/*aggregate all chronic condition variables by bid*/
proc sql;
create table bid_dx_0_&presurg.(rename=(bid_hrs_21=bid)) as
select distinct bid_hrs_21,
sum(CC_1_AMI) as CC_1_AMI,
sum(CC_2_ALZH) as CC_2_ALZH,
sum(CC_3_ALZHDMTA) as CC_3_ALZHDMTA,
sum(CC_4_ATRIALFB) as CC_4_ATRIALFB,
sum(CC_5_CATARACT) as CC_5_CATARACT,
sum(CC_6_CHRNKIDN) as CC_6_CHRNKIDN,
sum(CC_7_COPD) as CC_7_COPD,
sum(CC_8_CHF) as CC_8_CHF,
sum(CC_9_DIABETES) as CC_9_DIABETES,
sum(CC_10_GLAUCOMA) as CC_10_GLAUCOMA,
sum(CC_11_HIPFRAC) as CC_11_HIPFRAC,
sum(CC_12_ISCHMCHT) as CC_12_ISCHMCHT,
sum(CC_13_DEPRESSN) as CC_13_DEPRESSN,
sum(CC_14_OSTEOPRS) as CC_14_OSTEOPRS,
sum(CC_15_RA_OA) as CC_15_RA_OA,
sum(CC_16_STRKETIA) as CC_16_STRKETIA,
sum(CC_17_CNCRBRST) as CC_17_CNCRBRST,
sum(CC_18_CNCRCLRC) as CC_18_CNCRCLRC,
sum(CC_19_CNCRPRST) as CC_19_CNCRPRST,
sum(CC_20_CNCRLUNG) as CC_20_CNCRLUNG,
sum(CC_21_CNCREndM) as CC_21_CNCREndM

from list_&presurg._dx group by bid_hrs_21;
quit;

/*merge chronic conditions into index surgery list of bid's by bid*/
 proc sql;
 create table bid_dx_0_&presurg.2(drop=bid) as select a.bid_hrs_21,b.*
 from sur_fin.surgery_ids_6m_pre_adm a
 left join
  bid_dx_0_&presurg. b 
 on trim(left(a.bid_hrs_21))=trim(left(b.bid));
 quit;

/*convert to chronic condition vars. to binary variables*/
 data bid_dx_0_&presurg.3;
 set bid_dx_0_&presurg.2;
 array list CC_1_AMI
CC_2_ALZH
CC_3_ALZHDMTA
CC_4_ATRIALFB
CC_5_CATARACT
CC_6_CHRNKIDN
CC_7_COPD
CC_8_CHF
CC_9_DIABETES
CC_10_GLAUCOMA
CC_11_HIPFRAC
CC_12_ISCHMCHT
CC_13_DEPRESSN
CC_14_OSTEOPRS
CC_15_RA_OA
CC_16_STRKETIA
CC_17_CNCRBRST
CC_18_CNCRCLRC
CC_19_CNCRPRST
CC_20_CNCRLUNG
CC_21_CNCREndM
;
do over list ;
if list>0 then list=1;
if list<=0 then list=0;
end;

/*create aggregated indicators*/
CC_AMI_isch=CC_1_AMI|CC_12_ISCHMCHT;
CC_alzheim=CC_2_ALZH|CC_3_ALZHDMTA;
CC_cncr_chronic=CC_17_CNCRBRST | CC_18_CNCRCLRC | CC_19_CNCRPRST | CC_20_CNCRLUNG | 
	CC_21_CNCREndM ;
run;


proc means;
var CC_1_AMI
CC_2_ALZH
CC_3_ALZHDMTA
CC_4_ATRIALFB
CC_5_CATARACT
CC_6_CHRNKIDN
CC_7_COPD
CC_8_CHF
CC_9_DIABETES
CC_10_GLAUCOMA
CC_11_HIPFRAC
CC_12_ISCHMCHT
CC_13_DEPRESSN
CC_14_OSTEOPRS
CC_15_RA_OA
CC_16_STRKETIA
CC_17_CNCRBRST
CC_18_CNCRCLRC
CC_19_CNCRPRST
CC_20_CNCRLUNG
CC_21_CNCREndM;
run;

%mend;

%cc(presurg=n6m);
%cc(presurg=n12m);

/*so resulting 2 datastets are bid_dx_0_n6m3 and bid_dx_0_n12m3*/

/************************************************************/
/*rename the 6 month pre-surgery chronic condition vars*/
/************************************************************/
/*creates dataset to use in the rename macro below*/
data test;
set bid_dx_0_n6m3;
run;

/*rename macro to add _n6mn0 suffix to the chronic conditions variable names
Data file is still work.test but variables renamed after running this macro*/
%rename(WORK,TEST,n6mn0);

/*Changes name of bid_hrs variable so no _n6mn0*/
data sur_int.chronic_21_n6m_n0_0;
set test;
bid_hrs_21=bid_hrs_21_n6mn0;
drop bid_hrs_21_n6mn0;
run;

proc freq data=sur_int.chronic_21_n6m_n0_0;
table cc_alzheim_n6mn0 cc_cncr_chronic_n6mn0;
run;
proc contents;
run;

/************************************************************/
/*rename the 12 month pre-surgery chronic condition vars*/
/************************************************************/

/*creates dataset to use in the rename macro below*/
data test;
set bid_dx_0_n12m3;
run;

/*rename macro to add _n12mn0 suffix to the chronic conditions variable names
Data file is still work.test but variables renamed after running this macro*/
%rename(WORK,TEST,n12mn0);

/*Changes name of bid_hrs variable so no _n12mn0*/
data sur_int.chronic_21_n12m_n0_0;
set test;
bid_hrs_21=bid_hrs_21_n12mn0;
drop bid_hrs_21_n12mn0;
run;

proc freq data=sur_int.chronic_21_n12m_n0_0;
table cc_alzheim_n12mn0 cc_cncr_chronic_n12mn0;
run;
proc contents;
run;

/***************************************************************************/
/* merging chronic conditions variables with the index surgery data file
that also contains the Elixhauser comorbidities */
/***************************************************************************/

%macro mergecc(presurg=);

proc sql;
create table sur_fin.surgery_ids_last_&presurg.3(drop=bid_hrs2)
as select * from
sur_fin.surgery_ids_last_&presurg. a
left join
sur_int.chronic_21_&presurg._n0_0(rename=(bid_hrs_21=bid_hrs2)) b 
on (a.bid_hrs_21)=(b.bid_hrs2);
quit;

data sur_fin.surgery_ids_last_comor_&presurg.;
set sur_fin.surgery_ids_last_&presurg.3;
run;

%mend;

%mergecc(presurg=n6m);
%mergecc(presurg=n12m);

/* the above file contains just people who have had surgery, surgery data,
pre and post surgery hospital and snf data,  
elixhauser and chronic conditions and insurance data 

File names are:
sur_fin.surgery_ids_last_comor_n6m
sur_fin.surgery_ids_last_comor_n12m
*/

proc contents data=sur_fin.surgery_ids_last_comor_n6m;
run;

proc contents data=sur_fin.surgery_ids_last_comor_n12m;
run;


proc freq data=sur_fin.surgery_ids_last_comor_n6m;
table cc_:;
run;

proc freq data=sur_fin.surgery_ids_last_comor_n12m;
table cc_:;
run;



H="Identify first claim after 1 year post-surgery"
/*Survival analysis requires an end date to be coded
For observations where the core interiew is within 1 year
of the surgery date, can we use a claim date to identify that the
beneficiary is alive at 1 year? */

/*start of MACRO */

/*Macro for all claims files except for medpar
Creates file source_meet_after_1yr_2 which has the first claim after
1 year of surgery
*/
%macro other_post(days_start=,source=);

/*Identify claims within certain time from procedure date defined when run macro*/
proc sql;
create table &source._meet_after_1yr as select a.*,b.procedure_date
from medi.&source._2000_2012 a inner join
sur_fin.surgery_ids_last b
on trim(left(a.bid_hrs_21))=trim(left(b.bid_hrs_21))
and &days_start<=a.admit_date-b.procedure_date;
quit;
run;

data &source._meet_after_1yr_1a;
set &source._meet_after_1yr;
format admit_date date9. disch_date date9.;
run;

proc sort data=&source._meet_after_1yr_1a;
by bid_hrs_21 admit_date;
run;

data &source._meet_after_1yr_2;
set &source._meet_after_1yr_1a(keep=bid_hrs_21 admit_date);
by bid_hrs_21;
if first.bid_hrs_21;
rename admit_date = follow_up_dt_1yr_ps;
run;
%mend;

/*Macro for medpar claims*/
%macro mp_post(days_start=,source=);
%let source0=mp;

/*Identify claims within certain time from procedure date*/
proc sql;
create table &source._meet_after_1yr as select a.*,b.procedure_date
from medi.&source0._2000_2012 a inner join
sur_fin.surgery_ids_last b
on trim(left(a.bid_hrs_21))=trim(left(b.bid_hrs_21)) 
and &days_start<=a.admit_date-b.procedure_date;
quit;
run;

data &source._meet_after_1yr_1a;
set &source._meet_after_1yr;
format admit_date date9. disch_date date9.;
run;

proc sort data=&source._meet_after_1yr_1a;
by bid_hrs_21 admit_date;
run;

data &source._meet_after_1yr_2;
set &source._meet_after_1yr_1a(keep=bid_hrs_21 admit_date disch_date dschrgcd dstntncd);
by bid_hrs_21;
if first.bid_hrs_21;
run;

%mend;

/*Run macros to identify claims that are after 1 year from surgery date*/
%mp_post(days_start=366,source=mp );
%other_post(days_start=366,source=hh );
%other_post(days_start=366,source=hs );
%other_post(days_start=366,source=dm );
%other_post(days_start=366,source=op );
%other_post(days_start=366,source=pb );

/*combine to get follow up date at least 1 year post surgery to use in
survival analysis */

/*for medpar claims, create indicator for cases where discharge code indicates died*/
proc freq data=mp_meet_after_1yr_2;
table dschrgcd*dstntncd /missprint;
run;

data mp_after_1yr_3(keep=bid_hrs_21 follow_up_dt_1yr_ps died_post_1yr);
set mp_meet_after_1yr_2;
if dschrgcd='B' then died_post_1yr=1;
follow_up_dt_1yr_ps = disch_date;
run;

data all_after_1yr;
set mp_after_1yr_3 hh_meet_after_1yr_2  hs_meet_after_1yr_2  dm_meet_after_1yr_2 
 op_meet_after_1yr_2  pb_meet_after_1yr_2;
run;

proc sort data=all_after_1yr;
by bid_hrs_21 follow_up_dt_1yr_ps ;
run;

data sur_int.all_after_1yr_1;
set all_after_1yr;
by bid_hrs_21 ;
if first.bid_hrs_21 ;
run;

/*none of the medpar claims where the beneficiary died
got used in the final dataset with the claim right after 1 year post surgery*/
proc freq;
table died_post_1yr /missprint;
run;

/*merge in the follow up dates to the overall dataset*/
%macro mergefu(presurg=);

proc sql;
create table sur_fin.surgery_ids_last_comor_&presurg.2(drop=bid_hrs2 died_post_1yr )
as select * from
sur_fin.surgery_ids_last_comor_&presurg. a
left join
sur_int.all_after_1yr_1(rename=(bid_hrs_21=bid_hrs2)) b 
on (a.bid_hrs_21)=(b.bid_hrs2);
quit;

%mend;

%mergefu(presurg=n6m);
%mergefu(presurg=n12m);


H="Bring in HRS data set - n1 core (pre-surgery interview)"
/*
Core HRS requires additional variables to be pulled in from raw data files
Therefore, use code in HRS_Processing.txt code file

Bringing in HRS data starts with the following 3 files:
hrs_cln.core_00_to_12.sas7bdat - core, with observation for each core interview, includes
net worth data, TICS score and interview date from restricted dataset

exit_02_10_clean.dta - exit dataset

restricted_v2010.sas7bdat - restricted dataset

11/20/2013 - Restricted dataset received for 2010 is not
complete so just use 2008 version
Update when final 2010 information received
**Need to code up cause of death into the 12 cagegories**

12/3/2013 Update
Complete restricted dataset recieved and merged
Cause of death categories coded into 12 categories
Crosswalk files used are still 2008 xwalk since we don't have 2010 xwalk
Because using 2008xwalk, need to use 2008 claims
Switch to 2010 claims when receive xwalk files

1/8/14 update
Switched to 2010 claims
Switched to central hrs directory for hrs files (rather than old references
to the surgery project files for the cleaned hrs dataset

*/


/****************************************************************/
/*Add HRS xwalk ID to the claims datasets
Creates 2 datasets, one with the 6 month cc and elix 
and one with 12 month cc and elix */
/****************************************************************/

/*HRS - CMS crosswalk initial processing*/
data crosswalk_1;
set medi.cmsxref2012;
keep bid_hrs_21 hhid pn hhidpn hhidnew pnnew;
/*create id variable as concat of hhid and pn*/
length hhidpn $9 hhidnew $6 pnnew $3;
hhidnew=trim(hhid);
pnnew=trim(pn);
hhidpn=hhidnew||pnnew;
run;

data crosswalk_1a;
set crosswalk_1(keep=bid_hrs_21 hhidpn);
run;

data crosswalk_2;
set crosswalk_1a;
bid_hrs=bid_hrs_21;
id=hhidpn;
drop hhidpn;
drop bid_hrs_21;
run;

proc sort data= crosswalk_2;
by bid_hrs;
run;

/*sort surgery information claims dataset so can merge in hrs xwalk id*/
proc sort data=sur_fin.surgery_ids_last_comor_n12m2;
by bid_hrs_21;
run;

proc sort data=sur_fin.surgery_ids_last_comor_n6m2;
by bid_hrs_21;
run;


/*bring in xwalk data - 12 month look back*/
proc sql;
create table surg_ids_xwalk_n12m as select
a.*,b.id from
sur_fin.surgery_ids_last_comor_n12m2 a
left join
crosswalk_2 b
on a.bid_hrs_21=b.bid_hrs;
quit;

/*check for missing xwalk ids*/
data check1;
set surg_ids_xwalk_n12m ;
if id='';
run;

/*bring in xwalk data - 6 month look back*/
proc sql;
create table surg_ids_xwalk_n6m as select
a.*,b.id from
sur_fin.surgery_ids_last_comor_n6m2 a
left join
crosswalk_2 b
on a.bid_hrs_21=b.bid_hrs;
quit;

/*check for missing xwalk ids*/
data check1;
set surg_ids_xwalk_n6m ;
if id='';
run;

/****************************************************************/
/*get the n1 (core interview before surgery) core*/
/****************************************************************/

/*get table of all core interviews for bids with surgery
where core interview done prior to the surgery date
2590 interviews*/
proc sql;
create table r_n1_core_before_surg(drop=id)
as select b.*,b.id as r_id label="respondent's id"
 from surg_ids_xwalk_n12m a inner join
hrs_cln.core_00_to_12 b
  on a.id=b.id and a.procedure_date>b.c_ivw_date;
  quit;


proc sort data=r_n1_core_before_surg ;
by r_id c_ivw_date;
run;

data sur_int.r_n1_core_before_surg_1(compress=yes);
set  r_n1_core_before_surg;
run;

/*Dataset with just the core interview prior to surgery date
875 first core interviews identified*/
data resp_core_n1;
set r_n1_core_before_surg;
by r_id c_ivw_date;
if last.r_id;
run;

proc freq;
table core_year;
run;

/*re name the n1 core variables*/

*options macrogen mprint mlogic;
%macro rename2(lib,dsn,pre,first);
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "Before Renaming All Variables";
run;
proc sql noprint;
select nvar into :num_vars
from dictionary.tables
where libname="&LIB" and
memname="&DSN";
select distinct(name) into :var1-
:var%TRIM(%LEFT(&num_vars))
from dictionary.columns
where libname="&LIB" and
memname="&DSN" ;
quit;
run;
proc datasets library=&LIB;
modify &DSN;
rename
%do i=1 %to &num_vars;

&&var&i=&first.&&var&i.&&pre.
%end;
;
quit;
run;
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "After Renaming All Variables";
run;
%mend ;


/*creates dataset work.resp_core_n1 that just contains 
_n1 core interview (pre-surgery) with variables all renamed
with _n1 suffix
875 core interviews */
%rename2(WORK,RESP_CORE_N1,_n1,);


proc sql outobs=10;
select r_id_n1,c_ivw_date_n1 from RESP_CORE_N1;
quit;

/*rename id variable so can use to merge later*/
data RESP_CORE_N1;
set RESP_CORE_N1;
id=r_id_n1;
run;


/*check dataset, need all ids in resp_core_n1 to be in surgery xwalk id list
all 875 core interviews are in the surgery xwalk list*/
proc sql;
create table test1 as select *
from RESP_CORE_N1 where id in (select id from surg_ids_xwalk_n12m);
quit;


H="Bring in HRS data - n2 core"
/*bring in n2 core interview
n1 = core interview immediately before surgery
n2 = core interview before the n1 interview
*/

/*get all core interviews that are earlier than the n1 core interview
for those bids with a n1 core interview identified
*1715 interviews*/
proc sql;
create table r_n2_core_before_surg(drop=id)
as select b.*,b.id as r_id label="respondent's id"
 from RESP_CORE_N1 a inner join
hrs_cln.core_00_to_12 b
  on a.id=b.id and a.c_ivw_date_n1>b.c_ivw_date;
  quit;

proc sort data=r_n2_core_before_surg ;
by r_id c_ivw_date;
run;

data sur_int.r_n2_core_before_surg_2(compress=yes);
set  r_n2_core_before_surg;
run;

/*Dataset with just the core interview prior to the n1 interview date
682 first core interviews identified*/
data resp_core_n2;
set r_n2_core_before_surg;
by r_id c_ivw_date;
if last.r_id;
run;

proc freq;
table core_year;
run;

/*re name the n2 core variables*/

/*creates dataset work.resp_core_n2 that just contains 
_n2 core interview (pre-surgery) with variables all renamed
with _n2 suffix
*** core interviews */
%rename2(WORK,RESP_CORE_N2,_n2,);


proc sql outobs=10;
select r_id_n2,c_ivw_date_n2 from RESP_CORE_N2;
quit;

/*rename id variable so can use to merge later*/
data RESP_CORE_N2;
set RESP_CORE_N2;
id=r_id_n2;
run;


/*check dataset, need all ids in resp_core_n1 to be in surgery xwalk id list
all 682 core interviews are in the surgery xwalk list*/
proc sql;
create table testn2 as select *
from RESP_CORE_N2 where id in (select id from surg_ids_xwalk_n12m);
quit;

H="Bring in HRS data - p1 core (post-surgery core interview)"

/*get the positive one core (core interview after surgery*/

/*gets all core interviews post surgery
1443 interviews*/
proc sql;
create table p1_core_after_surg(drop=id)
as select a.id as r_id,b.*
 from surg_ids_xwalk_n12m a inner join
hrs_cln.core_00_to_12 b
  on a.id=b.id and a.procedure_date<b.c_ivw_date;
  quit;

proc sort data=p1_core_after_surg ;
by r_id c_ivw_date;
run;

/*just keep core interview immediately after surgery date
635 interviews*/
data core_p1;
set p1_core_after_surg;
by r_id c_ivw_date;
if first.r_id;
run;

/*creates file work.core_p1 of post-surgery core interviews
635 core interviews*/
%rename2(WORK,CORE_P1,_p1,);

/*rename id variable so can use it to merge later*/
data CORE_P1;
set CORE_P1;
id=r_id_p1;
run;

/*get interview date for p2 interview also to check
for end date for survival analysis*/

proc sql;
create table p2_core_after_surg
as select a.id,a.c_ivw_date_p1,b.c_ivw_date
 from CORE_P1 a inner join
hrs_cln.core_00_to_12 b
  on a.id=b.id and a.c_ivw_date_p1<b.c_ivw_date;
  quit;

proc sort data=p2_core_after_surg;
by id c_ivw_date;
run;

data core_p2(drop=c_ivw_date_p1);
set p2_core_after_surg;
by id;
if first.id;
rename c_ivw_date=c_ivw_date_p2;
run;




H="Bring in HRS data - exit and restricted data"
/*merged with the exit data and restricted data

Results in final dataset to be analyzed:

C:\data\surgery\2012_update\final_data\surgery_final.dta*/

/*put the exit_restricted file also have the r_id*/

/*get exit dataset with interview date added*/
data exit_1;
set hrs_cln.exit_02_to_12_dt;
run;

/*pull restricted dataset 2010 version*/
data restricted;
set hrs_cln.restricted_v2010;
run;

/*Rename restricted variables with _e suffix*/
%rename2(WORK,RESTRICTED,_E,);

data RESTRICTED;
set RESTRICTED;
id=id_e;
run;

/*just keep cleaned variables from exit interview*/
data exit;
set exit_1(keep=ID EXIT_YEAR PROXY_EXIT FEMALE MARITAL MARRIED MARITAL_SEP MARITAL_DIV MARITAL_WID MARITAL_NEV
MARITAL_SD MARITAL_MISSING MEDICARE MEDICAREB MEDICAID CHAMPUS HMO MEDIGAP CATINSUR NHRES
HOSPICE FREQRELG CHILD GCHIL ALLCHIL RESCHIL RESCHIL_D RESSPOUSE HHM LIVEALONE LOCATION LOC_HOSP
ICU VENT DIALYSIS DEC_ALL DEC_LIM DEC_WHLD DEC_COMF DEC_CAT DEXP EOLDEC CAPACITY DURATION ADAPP
ADPROB DECMAKER LWILL LW_ALL LW_LIM LW_WHLD LW_COMF LW_CAT HCP DISCUSS ADVDIR EOLPLAN
ADL_BEDBOUND ADL_DR ADL_WK ADL_BH ADL_E ADL_TX ADL_T ADL_INDEX ADL_CAT ADL_INDEPENDENT
ADL_PARTIAL ADL_SEVERE IADL_MP IADL_GR IADL_PH IADL_RX IADL_M IADL_IND IADL_CAT IADL_INDEPENDENT
IADL_PARTIAL IADL_SEVERE CANCER_HRS LUNG_HRS HEART_HRS CHF_HRS STROKE_HRS MEMORY_HRS FALLS_HRS
INCONT_HRS PAIN_HRS HTN_HRS DM_HRS PSYCH_HRS ARTH_HRS COMOR_IN_HRS COMOR_C_HRS 
nhres_2yr_exit nh_stays_exit nh_nights_exit nh_ins_exit e_ivw_day e_ivw_month e_ivw_year 
e_ivw_date e_ivw_day_imp) ;
run;

/*add _x suffix to variable names in exit dataset*/
%rename2(WORK,EXIT,_x,);
data exit;
set exit;
id=id_x;
run;



H="Merge HRS survey data with surgery data from claims"
/*sort the individual hrs datasets pre-merge*/
proc sort data=restricted ;
by id;
run;

proc sort data=exit ;
by id;
run;

proc sort data=resp_core_n1 ;
by id;
run;

proc sort data=resp_core_n2 ;
by id;
run;

proc sort data=core_p1 ;
by id;
run;

proc sort data=core_p2 ;
by id;
run;


/*sort surgery information w/ xwalk id datasets by id*/
proc sort data=surg_ids_xwalk_n12m;
by id;
run;

proc sort data=surg_ids_xwalk_n6m;
by id;
run;


/*use macro to merge core n1, n2, p1 and exit hrs interviews to
surgery files
run 2x to get one for 12 m and 6 m comorbidity datasets
datasets are final_0_n12m and final_0_n6m*/
%macro add_hrs(nm);
/*bring in core n1 interview to surgery data*/
proc sql;
create table mg_&nm._core_n1 as select * from
surg_ids_xwalk_&nm. a left join
resp_core_n1 b
on a.id=b.id;
quit;

/*bring in core n2 interview to surgery data*/
proc sql;
create table mg_&nm._core_n2 as select * from
mg_&nm._core_n1 a left join
resp_core_n2 b
on a.id=b.id;
quit;


/*bring in core p1 interview to surgery data*/
proc sql;
create table mg_&nm._core_p1 as select * from
mg_&nm._core_n2 a left join
core_p1 b
on a.id=b.id;
quit;

/*bring in core p2 interview dates*/
proc sql;
create table mg_&nm._core_p2 as select * from
mg_&nm._core_p1 a left join
core_p2 b
on a.id=b.id;
quit;


/*bring in exit interview to surgery data*/
proc sql;
create table mg_&nm._exit as select * from
mg_&nm._core_p2 a left join
exit b
on a.id=b.id;
quit;

proc sort data=mg_&nm._exit out=final_0_&nm. nodupkey;
by id;
run;

%mend;

%add_hrs(nm=n12m);
%add_hrs(nm=n6m);


/*replace id with character id*/
data restricted_2;
set restricted;
length id_new $9 hhid_e $6 pn_e $3;
id_new=hhid_e||pn_e;
drop id;
rename id_new=id;
run;

/*bring in restricted HRS data */
proc sort data=restricted_2 nodupkey;
by id;
run;

%macro add_res(nm);
proc sql;
create table final_&nm. as select a.*,b.*
from final_0_&nm. a left join
restricted_2 b
on a.id=b.id;
quit;
%mend;

%add_res(nm=n12m);
%add_res(nm=n6m);

/*add additional variables and save final datasets*/

%macro add_vars(nm);
data final2_&nm.;
set final_&nm.;
days_surg_n1core=procedure_date-c_ivw_date_n1;
days_surg_n2core=procedure_date-c_ivw_date_n2;
days_surg_p1core=c_ivw_date_p1-procedure_date;
days_surg_p2core=c_ivw_date_p2-procedure_date;
days_surg_x=e_ivw_date_x-procedure_date;

ind_n1core=0;
if CORE_YEAR_n1 ~=. then ind_n1core=1;
ind_n2core=0;
if CORE_YEAR_n2 ~=. then ind_n2core=1;
ind_p1core=0;
if CORE_YEAR_p1 ~=. then ind_p1core=1;
ind_p2core=0;
if c_ivw_date_p2 ~=. then ind_p2core=1;
ind_exit=0;
if EXIT_YEAR_x ~=. then ind_exit=1;

em_urgent_admit=0;
if type_adm in (1,2) then em_urgent_admit=1;
label days_surg_n1core="days between surgery date and n1 core"
days_surg_n2core="days between surgery date and n2 core"
days_surg_p1core="days between surgery date and p1 core"
days_surg_p2core="days between surgery date and p2 core"
days_surg_x="days between surgery date and exit ivw"
ind_n1core="Indicator for core n1 interview"
ind_n2core="Indicator for core n2 interview"
ind_p1core="Indicator for core p1 interview"
ind_p2core="Indicator for core p2 interview"
ind_exit="Indicator for exit interview"
em_urgent_admit="ip admit=emergency or urgent"
procedure="surgery procedure code,in icd9 procedure"
procedure_date="surgery date"
surgery_meet="Laparotomy|gastric_ulcer|gas_volvulus|intest_resection|Colostomy|
abdom_hernia"
;
run;

proc freq;
table type_adm ind_n1core ind_n2core ind_p1core ind_p2core ind_exit;
run;

proc means;
var days_surg_n1core days_surg_n2core days_surg_p1core days_surg_p2core days_surg_x;
run;

/* final dataset*/
data sur_fin.surgery_&nm.;
set final2_&nm.;
run;
%mend;

%add_vars(nm=n12m);
%add_vars(nm=n6m);

/*save as stata datasets for analysis and summary statistics*/
proc export data=sur_fin.surgery_n12m
outfile="E:\data\surgery\2012_update\final_2012clms\surgery_final_n12m.dta"
replace;
run;

proc export data=sur_fin.surgery_n6m
outfile="E:\data\surgery\2012_update\final_2012clms\surgery_final_n6m.dta"
replace;
run;






H="xxxxx"
End of code - remaining tabs are notes regarding variables

See STATA .DO files in code directory for analysis

H="Stata - define sample"
/*surgery project summary statistics

Updated original for use with 2010 claims

Drops observations based on sample criteria:
Start with 2000-2010 claims, 1998-2010 core interviews, 2002-2010 exit interviews
1. Age at surgery >=65
2. Parts a+b Medicare FFS coverage for 6 months prior to surgery
3. Has pre-surgery core interview
4. Urgent/emergent surgery per admission type code

Creates cleaned variables and new variables needed
for analysis
*/

capture log close

clear all
set mem 500m
set matsize 800
set more off

local logpath E:\data\surgery\2012_update\logs
local datapath E:\data\surgery\2012_update\final_2012clms

log using "`logpath'\7_Surgery_code_sum_stats_2012_claims.txt", text replace

cd "`datapath'"

//2 datasets, one with 12 month pre surgery comorbidities, one with 6 month
//pre surg comorbidities
use surgery_final_n12m.dta
//use surgery_final_n6m.dta

describe

gen surg_year = year(procedure_date)

la var surg_year "Surgery year"
tab core_year_n1 surg_year, missing
drop if surg_year==2012
**********************************************************
**********************************************************
//create age at surgery variables
**********************************************************
**********************************************************

//check dob from restricted files vs dob from claims
/*restricted file has quite a few instances of missing dob
but claims does not so maybe use claims dob*/

format birth_date_e %td
//2 observations have missing birth date from restricted file
tab birth_date_e,missing

//rename dob variable from claims
rename claims_dob2 claims_dob

//check to see if there's a difference between claims dob and rest dob
//there is so don't just replace restricted dob with claims dob
gen dob_clm_rest = claims_dob - birth_date_e
tab dob_clm_rest, missing

//check claims dob for cases where restricted birth date is missing
//seem to check out, one was imputed, year is same for both
tab claims_dob if birth_date_e==.,missing
tab birthmo_e dob_imp if birth_date_e==.,missing
tab birthyr_e dob_imp if birth_date_e==.,missing
tab birthday_e  dob_imp  if birth_date_e==.,missing

//for 2 obs with missing dob, use claims dob
replace birth_date_e=claims_dob if birth_date_e==.

//create age at surgery variable
gen age_at_surg=.
replace age_at_surg  = (procedure_date-birth_date_e) / 365.25
la var age_at_surg "Age at time of index surgery"
sum age_at_surg, detail

//create category indicator age variables
gen age_at_surg_lt65=.
replace age_at_surg_lt65=1 if (age_at_surg<65 & age_at_surg~=.)
replace age_at_surg_lt65=0 if (age_at_surg>=65 & age_at_surg~=.)
la var age_at_surg_lt65 "Age at time of index surgery less than 65"

gen age_at_surg_65_74=.
replace age_at_surg_65_74=1 if (age_at_surg>=65 & age_at_surg<75)
replace age_at_surg_65_74=0 if (age_at_surg<65 | age_at_surg>=75)
la var age_at_surg_65_74 "Age at time of index surgery 65-74"

gen age_at_surg_75_79=.
replace age_at_surg_75_79=1 if (age_at_surg>=75 & age_at_surg<80)
replace age_at_surg_75_79=0 if (age_at_surg<75 | age_at_surg>=80)
la var age_at_surg_75_79 "Age at time of index surgery 75-79"

gen age_at_surg_80_84=.
replace age_at_surg_80_84=1 if (age_at_surg>=80 & age_at_surg<85)
replace age_at_surg_80_84=0 if (age_at_surg<80 | age_at_surg>=85)
la var age_at_surg_80_84 "Age at time of index surgery 80-84"

gen age_at_surg_gt84=.
replace age_at_surg_gt84=1 if (age_at_surg>=85 & age_at_surg~=.)
replace age_at_surg_gt84=0 if (age_at_surg<85 & age_at_surg~=.)
la var age_at_surg_gt84 "Age at time of index surgery 85+"

tab age_at_surg_lt65,missing
tab age_at_surg_65_74,missing
tab age_at_surg_75_79,missing
tab age_at_surg_80_84,missing
tab age_at_surg_gt84,missing

//create categorical age variable
//category 1 65-74 includes those that were less than 65 at surgery
//drop them from analysis later
gen age_cat=.
replace age_cat=1 if age_at_surg_65_74==1 | age_at_surg_lt==1
replace age_cat=2 if age_at_surg_75_79==1
replace age_cat=3 if age_at_surg_80_84==1
replace age_cat=4 if age_at_surg_gt84==1
la var age_cat "Age at Surgery"
la def age 1 "65-74" 2 "75-79" 3 "80-84" 4 "85+"
la val age_cat age
tab age_cat, missing

//check current reason for entitlement for those age<65
destring crec, replace
la var crec "current reason for mc entitlement"
la def crec 0 "age 65 and older" 1 "disability insurance benefits" ///
	2 "ESRD" 3 "DIB and ESRD"
la values crec crec	
tab crec if age_at_surg_lt65==1, missing

// percent of surgeries that were emergent/urgent
tab em_urgent_admit, missing

//quick table to get sample size
mat sample=J(5,1,.)
sum age_cat //number of surgeries
mat sample[1,1]=r(N)
sum age_cat if age_at_surg_lt==0 //age > 65
mat sample[2,1]=r(N)
sum age_cat if (age_at_surg_lt==0 & part_ab_6m==1 & hmo_d_6m ==0) //mc status
mat sample[3,1]=r(N)
sum age_cat if (age_at_surg_lt==0 & part_ab_6m==1 & hmo_d_6m ==0 & ind_n1core==1) //core ivw
mat sample[4,1]=r(N)
sum age_cat if (age_at_surg_lt==0 & part_ab_6m==1 & hmo_d_6m ==0 & ind_n1core==1 ///
	& em_urgent_admit==1) //urgent/emerg
mat sample[5,1]=r(N)

mat rownames sample="N Surgeries" "Age > 65" "With MC A+B FFS 6mos" ///
 "With pre-surg core ivw" "Urgent/emergent admission"

mat list sample

//save a version prior to dropping those obs that don't meet sample criteria
save surgery_final_n12m_v2.dta, replace

// drop observations to get to final sample
drop if age_at_surg_lt65==1 //drop if age less than 65
drop if part_ab_6m==. //surgery within 6 months of Jan. 2000
drop if part_ab_6m==0 //no mc a+b coverage 6 months prior to surgery
drop if hmo_d_6m==1 //HMO coverage 6 months prior to surgery
drop if ind_n1core==0 //no core interview pre-surgery

tab surg_year, missing

tab em_urgent_admit, missing
drop if em_urgent_admit==0 | em_urgent_admit==.

/**************************************************************/
/**************************************************************/
// Now have final sample of 428 beneficiaries with urgent
// or emergent surgery, age 65 and over at surgery and
// fee for service medicare in the 6 months prior to surgery
/**************************************************************/
/**************************************************************/


save surgery_final_n12m_sample.dta, replace

log close


H="Stata - clean, create new variables"
/*starts with sample defined
Creates clean variables, saves dataset for tables and analysis*/

capture log close

clear all
set mem 500m
set matsize 800
set more off

local logpath E:\data\surgery\2012_update\logs
local datapath E:\data\surgery\2012_update\final_2012clms

log using "`logpath'\8_Surgery_code_var_cleaning_2012_claims.txt", text replace

cd "`datapath'"

//Use sample from 12 month before surgery comorbidities
use surgery_final_n12m_sample.dta

// list of surgeries
tab procedure, missing

***************************************************************************
***************************************************************************
//Clean demo variables
***************************************************************************
***************************************************************************

//age at time of surgery
sum age_at_surg, detail
tab age_cat, missing

//define alternative age categorical variable with fewer categories
gen age_cat_2 = .
replace age_cat_2=1 if age_cat==1
replace age_cat_2=2 if age_cat==2 | age_cat==3
replace age_cat_2=3 if age_cat==4
la var age_cat_2 "Age, categorical"
la def age_cat_2 1 "Age: 65-74" 2 "Age: 75-84" 3 "Age: 85+"
la val age_cat_2 age_cat_2
tab age_cat_2 age_cat, missing


//gender - from HRS
gen byte female = .
replace female=1 if (female_n1==1 | female_p1==1 | female_x==1)
replace female=0 if (female_n1==0 | female_p1==0 | female_x==0)
tab female, missing

//gender - from claims
tab claims_sex, missing
gen byte female_claims = .
replace female_claims = 1 if (claims_sex=="2")
replace female_claims = 0 if (claims_sex=="1")

// compare HRS and claims gender values
tab female female_claims, missing
//no conflicts and the 4 missing observations in HRS have gender
//assigned in the claims so use the claims gender variable

replace female=female_claims
la def fem 0 "Male" 1 "Female"
la values female fem
tab female, missing

//race & ethnicity
tab white_e, missing
tab black_e, missing
tab hisp_eth_e, missing
tab native_amer_e, missing
tab asian_pi_e, missing
tab other_race_e, missing
tab other_na_api_race_e, missing

//create race and ethnicity categorical variable
gen re_cat = .
replace re_cat = 1 if black_e==1
replace re_cat = 3 if white_e==1
replace re_cat = 2 if hisp_eth_e==1
replace re_cat = 4 if native_amer_e==1 | asian_pi_e==1 | other_race_e==1
la var re_cat "race & ethnicity"
la def re_cat 1 "African American" 3 "White" 2 "Hispanic" 4 "Other"
la val re_cat re_cat
tab re_cat, missing

***************************************************************************
***************************************************************************
//Clean health status variables
***************************************************************************
***************************************************************************

//nursing home resident - using n1 core interview, add labels
la def nhres_n1 1 "Yes" 0 "No"
la val nhres_n1 nhres_n1
tab nhres_n1, missing

****************************************************
// Self reported health status
****************************************************
//create collapsed self reported health, pre-surgery core categorical variable
//one obs is missing n1 srh but has n2 srh so use n2 srh for categorical variable
la var srh_n2 "SRH Core n2"
tab srh_n1 srh_n2, missing

gen byte srh_n1_imp_n2=0
replace srh_n1_imp_n2=1 if (srh_n1==. & srh_n2!=.)
tab srh_n1_imp_n2, missing

gen srh_cat_core=.
replace srh_cat_core=1 if  srh_ve_n1==1 //very good and excellent
replace srh_cat_core=2 if  srh_g_n1==1 //good
replace srh_cat_core=3 if  srh_pf_n1==1 //fair and poor

//for the obs where n1 core is missing but n2 core reported, use n2 core value
replace srh_cat_core=1 if (srh_ve_n2==1 & srh_n1==.) //very good and excellent
replace srh_cat_core=2 if (srh_g_n2==1 & srh_n1==.) //good
replace srh_cat_core=3 if (srh_pf_n2==1 & srh_n1==.) //fair and poor

la var srh_cat_core "Self reported health"
la def srh_cat_core 1 "Very Good / Excellent" 2 "Good" 3 "Fair / Poor"
la val srh_cat_core srh_cat_core
tab srh_cat_core,missing

//indicator variables for srh categories
gen byte srh_ve_ncore=0
replace srh_ve_ncore=1 if srh_cat_core==1
gen byte srh_g_ncore=0
replace srh_g_ncore=1 if srh_cat_core==2
gen byte srh_fp_ncore=0
replace srh_fp_ncore=1 if srh_cat_core==3
la var srh_ve_ncore "SRH Excel / VG pre-surgery core"
la var srh_g_ncore "SRH Good pre-surgery core"
la var srh_fp_ncore "SRH Fair / Poor pre-surgery core"
tab srh_ve_ncore,missing
tab srh_g_ncore,missing
tab srh_fp_ncore,missing

****************************************************
// ADL Difficulty Status
****************************************************
//adl categories - add labels, use n2 core adl for obs where n1 is missing
label define adl_cat_core_n1 0 "Independent" 1 "Partial Dependence" 2 "Severe Dependence", modify
label values adl_cat_core_n1 adl_cat_core_n1 
label var adl_cat_core_n2 "ADL Categ n2 core"
tab adl_cat_core_n1 adl_cat_core_n2, missing

gen byte adl_cat_n1_imp_n2=0
replace adl_cat_n1_imp_n2=1 if (adl_cat_core_n1==. & adl_cat_core_n2 !=.)
tab adl_cat_n1_imp_n2, missing

gen adl_cat_core=adl_cat_core_n1
replace adl_cat_core=adl_cat_core_n2 if (adl_cat_core_n1==. & adl_cat_core_n2 !=.)
la var adl_cat_core "ADL categorical from pre-surg core int"
la val adl_cat_core adl_cat_core_n2 adl_cat_core_n1
tab adl_cat_core, missing

//indicator variables for adl categories
gen byte adl_ind_ncore=0
replace adl_ind_ncore=1 if adl_cat_core==0
gen byte adl_pd_ncore=0
replace adl_pd_ncore=1 if adl_cat_core==1
gen byte adl_sd_ncore=0
replace adl_sd_ncore=1 if adl_cat_core==2
la var adl_ind_ncore "ADL Independent pre-surgery core"
la var adl_pd_ncore "ADL Partial Depend. pre-surgery core"
la var adl_sd_ncore "ADL Severe Depend. pre-surgery core"
tab adl_ind_ncore,missing
tab adl_pd_ncore,missing
tab adl_sd_ncore,missing

//set up variable for ADL partial+severe as single category
gen adl_cat_ps = .
replace adl_cat_ps = 1 if inlist(adl_cat_core,1,2)
replace adl_cat_ps = 0 if adl_cat_core==0
la var adl_cat_ps "ADL - Any Dependence"
tab adl_cat_ps adl_cat_core, missing


****************************************************
// Elixhauser comorbidities
****************************************************

//create diabetes variable to cover both comorb variables
gen el_diab=.
replace el_diab=1 if comorb_10_0_n12m==1 | comorb_11_0_n12m==1 //diabetes, uncompl.+compl.
replace el_diab=0 if comorb_10_0_n12m==0 & comorb_11_0_n12m==0
tab el_diab, missing
la var el_diab "Diabetes"

//create cancer variable to cover different el comorb variables
gen el_cancer=.
replace el_cancer=1 if comorb_17_0_n12m==1 | comorb_18_0_n12m==1 | comorb_19_0_n12m==1
replace el_cancer=0 if comorb_17_0_n12m==0 & comorb_18_0_n12m==0 & comorb_19_0_n12m==0
la var el_cancer "Cancer"
tab el_cancer, missing 

local comorb el_cancer comorb_1_0_n12m comorb_32_0_n12m comorb_31_0_n12m comorb_13_0_n12m el_diab
la def el_ind  0 "No" 1 "Yes"
lab val `comorb' el_ind  

****************************************************
// TICS score
****************************************************
//tics score n1 - categorical
gen tics_cat = .
replace tics_cat = 1 if (tics_tot_n1 > 8 & tics_tot_n1~=.)
replace tics_cat = 2 if (tics_tot_n1 >= 5 & tics_tot_n1 <= 8)
replace tics_cat = 3 if (tics_tot_n1 <= 4 & tics_tot_n1~=.)
la var tics_cat "TICS - categorical"
la def tics_cat 1 "9-35 Normal" 2 "5-8 MCI" 3 "0-4 Demented"
la val tics_cat tics_cat
tab tics_cat, missing

tab tics_cat comorb_31_0_n12m, missing

//tics score n2 - categorical
gen tics_cat_n2 = .
replace tics_cat_n2 = 1 if (tics_tot_n2 > 8 & tics_tot_n2~=.)
replace tics_cat_n2 = 2 if (tics_tot_n2 >= 5 & tics_tot_n2 <= 8)
replace tics_cat_n2 = 3 if (tics_tot_n2 <= 4 & tics_tot_n2~=.)
la var tics_cat_n2 "TICS - categorical n2 int"
la def tics_cat_n2 1 "9-35 Normal" 2 "5-8 MCI" 3 "0-4 Demented"
la val tics_cat_n2 tics_cat_n2
tab tics_cat_n2, missing

tab tics_cat_n2 comorb_31_0_n12m, missing

tab tics_cat tics_cat_n2, missing
//There are 18 obs where n1 tics is missing but n2 tics is not
//Create indicator for ticsn2 used and recode tics_cat variable
//to use n2 tics so we can keep those obs in the cohort
gen byte tics_n1_imp_n2=0
replace tics_n1_imp_n2=1 if tics_cat==. & tics_cat_n2!=.
tab tics_n1_imp_n2, missing

replace tics_cat = 1 if (tics_tot_n2 > 8 & tics_tot_n2~=. & tics_tot_n1==.)
replace tics_cat = 2 if (tics_tot_n2 >= 5 & tics_tot_n2 <= 8 & tics_tot_n1==.)
replace tics_cat = 3 if (tics_tot_n2 <= 4 & tics_tot_n2~=. & tics_tot_n1==.)

tab tics_cat, missing
//look at why tics is missing for 38 observations
//age at n1 core interview
//create age at surgery variable
gen age_at_n1=.
replace age_at_n1  = ( c_ivw_date_n1-birth_date_e) / 365.25
la var age_at_n1 "Age at time of core n1 interview"
sum age_at_n1, detail

//they are either <65 at the n1 core interview or the n1 core was by proxy
tab age_at_n1  proxy_core_n1 if tics_cat==.

//create tics category variable, including missing
gen tics_cat_miss = tics_cat
replace tics_cat_miss = 4 if tics_cat==.
la var tics_cat_miss "TICS categorical"
la def tics_cat_miss 1 "Normal >8" 2 "MCI 5-8" 3"Demented 0-4" 4"Unknown"
la val tics_cat_miss tics_cat_miss
tab tics_cat_miss

//create tics category variable v2, combining MCI and demented into single category
gen tics_cat_miss2 = tics_cat
replace tics_cat_miss2 = 2 if tics_cat==3
replace tics_cat_miss2 = 3 if tics_cat==.
la var tics_cat_miss2 "TICS categorical, v2, 3 categories"
la def tics_cat_miss2 1 "Normal >8" 2 "MCI or Demented 0-8" 3"Unknown"
la val tics_cat_miss2 tics_cat_miss2
tab tics_cat_miss2

//create tics indicator variables for the 4 categories
gen byte tics_ind_normal=0
replace tics_ind_normal=1 if tics_cat_miss==1
gen byte tics_ind_mci=0
replace tics_ind_mci=1 if tics_cat_miss==2
gen byte tics_ind_dem=0
replace tics_ind_dem=1 if tics_cat_miss==3
gen byte tics_ind_unk=0
replace tics_ind_unk=1 if tics_cat_miss==4
tab tics_ind_normal, missing
tab tics_ind_mci, missing
tab tics_ind_dem, missing
tab tics_ind_unk, missing

gen byte tics_ind_mci_dem = 0
replace tics_ind_mci_dem = 1 if tics_cat_miss2==2
tab tics_ind_mci_dem, missing

***************************************************************************
***************************************************************************
//Clean surgery episode / MC use variables
***************************************************************************
***************************************************************************
tab index_los,missing

local compl comp_any comp_uti comp_pe comp_inf comp_rf comp_mi comp_del
la var comp_any "Any complication"
la var comp_uti "UTI"
la var comp_pe "PE"
la var comp_pne "Pneumonia"
la var comp_inf "Surgical site infection"
la var comp_rf "Respiratory failure"
la var comp_kid "Acute kidney failure"
la var comp_mi "MI"
la var comp_del "Delirium"
la def comp_ind 0 "No" 1 "Yes"
la val `compl' comp_ind

la var admit_ind_6m_pre "Indicator for Hospital admission 6 months pre-surgery"
la def admit_ind_6m_pre 0 "No" 1 "Yes"
la val  admit_ind_6m_pre admit_ind_6m_pre
tab admit_ind_6m_pre, missing

*************************************************************************
*************************************************************************
//Death date variable cleaning
*************************************************************************
*************************************************************************
//compare death date from restricted hrs dataset vs claims
//claims dod comes from the denominator file
//especially interested in dates for discharge dstn code = expired
format death_date_e %d
sum death_date_e, detail
sum claims_dod2, detail

//7 obs have death date from claims but not in restricted dataset
//use their death date...
tab claims_dod2 if death_date_e==.

sum claims_dod2 if(stay_dstn_cd=="20"), detail
gen dod_dif = death_date_e - claims_dod2
tab dod_dif, missing
//of 69 claims with dstn code = expired, 54 have matching dod from claims and restr file
//so 15 have conflicts
//4 are ~1 year different, 9 are within 1 month
//2 have either missing dod in restricted file or missing in claims
tab dod_dif if(stay_dstn_cd=="20"), missing
tab dod_dif stay_dstn_cd, missing
tab death_date_e claims_dod2 if(stay_dstn_cd=="20" & dod_dif!=0), missing
tab death_date_e claims_dod2 if(stay_dstn_cd=="20" & dod_dif==.), missing

//need to deal with the 15 with conflicts
// 1 observation - has restricted death date, no date from claims
// procedure date = 03Aug2010, disch date = 12Aug2010, disch code = expired
// death date = 15Nov2011
// has additional ip claims after discharge date, so expired code is incorrect
// recode discharge code for this observation as "99" for unknown
// indicator for discharge code is modified created
gen disch_cd_mod = 0
tab stay_dstn_cd if(stay_dstn_cd=="20" & dod_dif==. & death_date_e!=.), missing
replace disch_cd_mod = 1 if(stay_dstn_cd=="20" & dod_dif==. & death_date_e!=.)
replace stay_dstn_cd="99" if(stay_dstn_cd=="20" & dod_dif==. & death_date_e!=.)
la var disch_cd_mod "Discharge code modified indicator"
tab disch_cd_mod, missing

// 1 observation with death date in claims, no date in restricted file
// has no post surgery ip stays or snf days recorded
// claims death date = discharge date which supports disch code = expired
// so use the claims death date
gen death_date_from_clms = 0
replace death_date_from_clms = 1  if(stay_dstn_cd=="20" & dod_dif==. & claims_dod2!=.)
replace death_date_e=claims_dod2  if(stay_dstn_cd=="20" & dod_dif==. & claims_dod2!=.)
la var death_date_from_clms "Death date from claims (not restricted hrs)"
tab death_date_from_clms, missing

// replace with karen's death date
merge 1:1 id using "E:\data\hrs_cleaned\death_date_2012.dta", keep(match master) keepusing(death_all)
rename death_all death_date


//look at 4 with difference of ~1 year
tab stay_end death_date if(dod_dif>100 &dod_dif!=.& stay_dstn_cd=="20"), missing
tab location_x claims_dod2 if(dod_dif>100 &dod_dif!=.& stay_dstn_cd=="20"), missing
//all report died in hospital from exit interview but have no ip claims post-surgery
//hospital stay which supports disch code = 20 Expired
//so replace death date with claims death date
replace death_date_from_clms = 1 if(dod_dif>100 &dod_dif!=.& stay_dstn_cd=="20" & location_x==1)
replace death_date=claims_dod2 if(dod_dif>100 &dod_dif!=.& stay_dstn_cd=="20" & location_x==1)
tab death_date_from_clms, missing

gen dod_dif_2 = death_date - claims_dod2
tab dod_dif_2, missing
tab dod_dif_2 if stay_dstn_cd=="20" , missing


*************************************************************************
*************************************************************************
//look at surgery to death date timeline
gen surg_to_death_dt = death_date - procedure_date
tab surg_to_death_dt, missing

//9 observations have dod <= procedure date
//need to address these so don't lose them in the Cox analysis
gen byte death_date_mod = 0
replace death_date_mod = 1 if (surg_to_death_dt<1)
tab index_los stay_dstn_cd if (surg_to_death_dt<1)
//7 obs indicate died during hospital stay, so reset dod to discharge date
tab is_disch_date death_date if (surg_to_death_dt<1 & stay_dstn_cd=="20")
tab is_disch_date procedure_date if (surg_to_death_dt<1 & stay_dstn_cd=="20")
replace death_date = is_disch_date if (surg_to_death_dt<1 & stay_dstn_cd=="20")
//5 of these obs procedure date=discharge date, to keep them in analysis, need to add
//a day to death date
replace death_date = is_disch_date +1 if (procedure_date==is_disch_date & stay_dstn_cd=="20")
//for remaining 2, disch to home and disch to snf
//check claims dod vs restricted dod
//no claims dod
tab death_date claims_dod2 if (surg_to_death_dt<1 & stay_dstn_cd!="20"), missing
tab id if (surg_to_death_dt<1 & stay_dstn_cd!="20"), missing
//check interview timeline dates - no p1 core
tab death_date c_ivw_date_p1 if (surg_to_death_dt<1 & stay_dstn_cd!="20"), missing
tab death_date e_ivw_date_x if (surg_to_death_dt<1 & stay_dstn_cd!="20"), missing
tab death_date admit_12m_post if (surg_to_death_dt<1 & stay_dstn_cd!="20"), missing
tab death_date snf_days_post_12m if (surg_to_death_dt<1 & stay_dstn_cd!="20"), missing
//2 observations, still need to figure out what to do with them!!
//one has an ip admit after surgery stay, other has a snf stay post-surgery stay
//so cannot just say they died... drop them from the analysis

//replace surgery to death date variable with updated death dates
replace surg_to_death_dt = death_date - procedure_date
la var surg_to_death_dt "Days from surgery to death"
tab surg_to_death_dt, missing

****************************************************
// Discharge Destination code
****************************************************
//discharge location code from surgery hospital stay
gen stay_dstn_cd_n=real(stay_dstn_cd)
la def stay_dstn_cd_n 1 "Home" 2 "Short term general hosp for inpatient care" 3 "SNF" ///
  4 "Intermediate care facility" 5 "Another type of inst" 6"Home care hhs org." ///
  20"Expired" 30"Still patient" 50"Hospice - home" 51"Hospice - medical facility" ///
  61"Within same inst to hospital based swing bed" 62"Inpatient rehab facility" ///
  63"Long term care hosp" 99 "Missing"
la val  stay_dstn_cd_n stay_dstn_cd_n 
tab stay_dstn_cd_n, missing

//discharge location coded into groups
gen stay_dstn_cat=.
replace stay_dstn_cat=1 if inlist(stay_dstn_cd_n,1,6) //home
replace stay_dstn_cat=2 if inlist(stay_dstn_cd_n,3,4,63) //long term care
replace stay_dstn_cat=3 if inlist(stay_dstn_cd_n,62) //rehab
replace stay_dstn_cat=4 if inlist(stay_dstn_cd_n,50,51) //hospice
replace stay_dstn_cat=5 if inlist(stay_dstn_cd_n,2,5,61,99,30) //other (includes still patient and unknown)
replace stay_dstn_cat=6 if inlist(stay_dstn_cd_n,20) //expired
la var stay_dstn_cat "Discharge location categorical"
la def stay_dstn_cat 1 "Home incl hha" 2"long term care incl snf" 3"IP rehab" ///
	4"Hospice" 5"Other location or missing" 6"Expired"
la var stay_dstn_cat stay_dstn_cat
tab stay_dstn_cat stay_dstn_cd, missing

//discharge location coded into groups - version 2 with more long term care categories
gen stay_dstn_cat2=.
replace stay_dstn_cat2=1 if inlist(stay_dstn_cd_n,1,6) //home
replace stay_dstn_cat2=2 if inlist(stay_dstn_cd_n,3) //long term care - SNF
replace stay_dstn_cat2=3 if inlist(stay_dstn_cd_n,4) //long term care - ICF
replace stay_dstn_cat2=4 if inlist(stay_dstn_cd_n,63) //long term care - Hospital
replace stay_dstn_cat2=5 if inlist(stay_dstn_cd_n,62) //rehab
replace stay_dstn_cat2=6 if inlist(stay_dstn_cd_n,50,51) //hospice
replace stay_dstn_cat2=7 if inlist(stay_dstn_cd_n,2,5,61,99,30) //other (includes still patient and unknown)
replace stay_dstn_cat2=8 if inlist(stay_dstn_cd_n,20) //expired
la var stay_dstn_cat2 "Discharge location categorical v2"
la def stay_dstn_cat2 1 "Home incl hha" 2"snf" 3"intermediate care facility" ///
	4"ltc hospital" 5"IP rehab" 6"Hospice" 7"Other location or missing" 8"Expired"
la var stay_dstn_cat2 stay_dstn_cat2
tab stay_dstn_cat2 stay_dstn_cd, missing

//discharge location coded into groups - version 3 with collapsed categories
//and reordered so better for output tables
gen stay_dstn_cat3=.
replace stay_dstn_cat3=1 if stay_dstn_cd_n==20 //expired
replace stay_dstn_cat3=2 if inlist(stay_dstn_cd_n,1,6) //home
replace stay_dstn_cat3=3 if inlist(stay_dstn_cd_n,3) //long term care - SNF
replace stay_dstn_cat3=4 if inlist(stay_dstn_cat2,3,4,5,6,7) //other and unknown
la var stay_dstn_cat3 "Discharge location categorical v3"
la def stay_dstn_cat3 1 "Expired" 2 "Home incl hha" 3 "snf" 4 "Other location or missing"
la var stay_dstn_cat3 stay_dstn_cat3
tab stay_dstn_cat3 stay_dstn_cd, missing

gen dis_home=0 if stay_dstn_cat!=1 & stay_dstn_cat!=.
replace dis_home=1 if stay_dstn_cat==1
gen dis_ltc=0 if stay_dstn_cat!=2 & stay_dstn_cat!=.
replace dis_ltc=1 if stay_dstn_cat==2
gen dis_rehab=0 if stay_dstn_cat!=3 & stay_dstn_cat!=.
replace dis_rehab=1 if stay_dstn_cat==3
gen dis_hs=0 if stay_dstn_cat!=4 & stay_dstn_cat!=.
replace dis_hs=1 if stay_dstn_cat==4
gen dis_oth=0 if stay_dstn_cat!=5 & stay_dstn_cat!=.
replace dis_oth=1 if stay_dstn_cat==5
gen dis_died=0 if stay_dstn_cat!=6 & stay_dstn_cat!=.
replace dis_died=1 if stay_dstn_cat==6

la var dis_home "Discharged to home"
la var dis_ltc "Discharged to long term care facility"
la var dis_rehab "Discharged to rehab facility"
la var dis_hs "Discharged to hospice"
la var dis_oth "Other / Unknown Discharged Location"
la var dis_died "Expired"

//additional long term care sub-categories
gen dis_snf=0 if stay_dstn_cat2!=2 & stay_dstn_cat2!=.
replace dis_snf=1 if stay_dstn_cat2==2
gen dis_icf=0 if stay_dstn_cat2!=3 & stay_dstn_cat2!=.
replace dis_icf=1 if stay_dstn_cat2==3
gen dis_ltch=0 if stay_dstn_cat2!=4 & stay_dstn_cat2!=.
replace dis_ltch=1 if stay_dstn_cat2==4

la var dis_snf "Discharged to snf"
la var dis_icf "Discharged to interm care facility"
la var dis_ltch "Discharged to ltc hospital"

//alternative other category matching stay_dstn_cat3
gen dis_oth3=0 if stay_dstn_cat3!=4 & stay_dstn_cat3!=.
replace dis_oth3=1 if stay_dstn_cat3==4

la var dis_oth3 "Other / Unknown Discharge loc., collapsed"

*************************************************************************
*************************************************************************
//Mortality timeline indicator variables
*************************************************************************
*************************************************************************
//inclusive mortality window variables (so 180 days includes those that
//died in first 30 days
//0 = died outside of window or did not die at all within the study time period

//create variables for died at 30 days, 180 days, 1 year
gen byte died_ind=.
replace died_ind=1 if death_date~=.
replace died_ind=0 if death_date==.
la var died_ind "indicator for death date present in HRS"

//died within 30 days of surgery (null if did not die)
gen byte died_30d = .
replace died_30d = 1 if (surg_to_death_dt<31)
replace died_30d = 0 if (surg_to_death_dt>30 & surg_to_death_dt~=.) | death_date==.
la var died_30d "died within 30 days post surgery"

//died within 180 days of surgery (null if did not die)
gen byte died_180d = .
replace died_180d = 1 if (surg_to_death_dt<181)
replace died_180d = 0 if (surg_to_death_dt>180 & surg_to_death_dt~=.) | death_date==.
la var died_180d "died within 180 days post surgery"

//died within 365 days of surgery (null if did not die)
gen byte died_365d = .
replace died_365d = 1 if (surg_to_death_dt<366)
replace died_365d = 0 if (surg_to_death_dt>365 & surg_to_death_dt~=.) | death_date==.
la var died_365d "died within 1 year post surgery"

//indicator for alive at 365 days
gen byte alive_365d_full =0
replace alive_365d_full = 1 if died_365d!=1
la var alive_365d_full "Did not die within 1 year post surgery"

la var died_365d "Died within 1 year"
la def ny 0 "No" 1 "Yes", modify
la val died_365d ny

tab died_ind, missing
tab died_30d, missing
tab died_180d, missing
tab died_365d, missing
tab died_365d alive_365d_full, missing

tab dis_died stay_dstn_cd_n, missing
tab died_30d if (stay_dstn_cd_n==20)
tab died_30d if (dis_died==1)
tab died_180d if (stay_dstn_cd_n==20)
tab died_180d if (dis_died==1)
tab died_180d if stay_dstn_cat==6

//create categorical variable for mortality timeline
gen mort_cat=.
replace mort_cat=3 if died_365d==1
replace mort_cat=2 if died_180d==1
replace mort_cat=1 if died_30d==1
replace mort_cat=4 if died_365d==0
la var mort_cat "Mortality - 30 day, 180 day and 1 year"
la def mort_cat 1 "30 day mortality" 2 "180 day mortality" 3 "365 day mortality" ///
	4 "Subject alive at 365 days", modify
la val mort_cat mort_cat
tab mort_cat, missing

//mutually exclusive indicator variables
//0-30 days, 31-180 days and 181-365 days
gen byte died_30d_me1=died_30d //no change for this variable
gen byte died_180d_me1=died_180d
replace died_180d_me1 = 0 if died_30d==1 //exclude those who died 30 days
gen byte died_365d_me1=died_365d
replace died_365d_me1 = 0 if died_180d==1 //exclude those who died 180 days
tab died_30d_me1, missing
tab died_180d_me1, missing
tab died_365d_me1, missing

gen died_me1_cat = 4
replace died_me1_cat = 1 if died_30d_me1==1
replace  died_me1_cat = 2 if died_180d_me1==1
replace died_me1_cat =3 if died_365d_me1==1
la var died_me1_cat "Mortality time categorical variable, mutually exclusive cats"
la def mort1 1 "0-30 days" 2 "31-180 days" 3 "181-365 days" 4 "Alive at 1 year"
la val died_me1_cat mort1
tab died_me1_cat , missing 

//Another set combining the 180 and 365 categories mortality windows
gen byte died_0_30=died_30d_me1
gen byte died_31_180=died_180d_me1
gen byte died_31_365 = 0
replace died_31_365 = 1 if died_180d_me1==1 | died_365d_me1==1
la var died_0_30 "Died 0-30 days post-surgery"
la var died_31_180 "Died 31-180 days post-surgery"
la var died_31_365 "Died 31-365 days post-surgery"
tab died_0_30, missing
tab died_31_180, missing
tab died_31_365, missing

tab died_0_30 died_me1_cat , missing
tab died_31_180 died_me1_cat , missing
tab died_31_365 died_me1_cat , missing


*************************************************************************
*************************************************************************
//Interview timeline variables
*************************************************************************
*************************************************************************
//Indicaors for n1 and p1 core interviews
tab ind_n1core, missing
tab ind_p1core, missing

//Exit interview
la var days_surg_x "Days from surgery to exit int"
sum days_surg_x
tab ind_exit,missing

tab core_year_n1 exit_year_x, missing

//completed follow up core interview within 1 year
gen byte core_1yr_ps=.
replace core_1yr_ps=1 if  (days_surg_p1core<366 & ind_p1core==1)
replace core_1yr_ps=0 if (days_surg_p1core>365 | ind_p1core==0)
la var core_1yr_ps "core interview within 1 year after surgery"

//look at outcomes at 1 year version 1, for timeline frequency table
//5 paths 
// 1. died and exit interview w/i 1 year
// 2. died w/i 1 year but exit interview later than 1 yr
// 3. died but no recorded exit interview (1 observation)
// 3. core / survived
// 4. no core / survived
gen outcome_1yr=.
//died 1 year and exit int 1 yr
replace outcome_1yr=1 if died_365d==1 & ( e_ivw_date_x - procedure_date <=365 )
//died 1 year and exit int later than 1 yr
replace outcome_1yr=2 if died_365d==1 & ( (e_ivw_date_x - procedure_date > 365) & ind_exit==1)
//died 1 year, no exit int
replace outcome_1yr=3 if died_365d==1 & ( (e_ivw_date_x - procedure_date > 365) & ind_exit==0)
//survived and core
replace outcome_1yr=4 if core_1yr_ps==1 & (died_365d==0|died_365d==.)
//survived and no core
replace outcome_1yr=5 if core_1yr_ps==0 & (died_365d==0|died_365d==.)
la var outcome_1yr "Outcome category 1 yr post surgery"
la def outcome_1yr 1 "Died and exit interview" 2 "Died, exit later than 1 yr" ///
	3 "Died and no exit" 4 "Survived, completed core interview" ///
	5 "Survived, no core interview", replace
la val outcome_1yr outcome_1yr
tab outcome_1yr died_365d, missing

//look at outcomes at 1 year, version 2
//8 paths 
// 1. Core w/i 1 year, no exit
// 2. Core after 1 year, no exit
// 3. Exit w/i 1 year, no core
// 4. Exit after 1 year, no core
// 5. Core and exit w/i 1 year (no observations)
// 6. Core w/i 1 year, exit after 1 year
// 7. Core and exit after 1 year
// 8. No post surgery interview

gen days_x_int_ps = .
replace days_x_int_ps = ( e_ivw_date_x - procedure_date )
tab days_x_int_ps died_ind, missing

gen exit_1yr_ps=0
replace exit_1yr_ps=1 if (days_x_int_ps<=365 & days_x_int_ps!=.)
tab exit_1yr_ps

gen exit_2yr_ps=0
replace exit_2yr_ps=1 if (days_x_int_ps<=(2*365) & days_x_int_ps!=.)
tab exit_2yr_ps

tab core_1yr_ps	died_365d, missing 
tab exit_1yr_ps died_365d, missing 
tab exit_2yr_ps died_365d, missing 

gen outcome_12m_v2=.
replace outcome_12m_v2=1 if (core_1yr_ps==1 & ind_exit==0) //core w/i 1 year, no exit
replace outcome_12m_v2=2 if (core_1yr_ps==0 & ind_p1core==1 & ind_exit==0) //core after 1 yr, no exit
replace outcome_12m_v2=3 if (exit_1yr_ps==1 & ind_p1core==0 ) //exit w/i 1 year, no core
replace outcome_12m_v2=4 if (exit_1yr_ps==0 & ind_exit==1 & ind_p1core==0 ) // exit after 1 yr, no core
replace outcome_12m_v2=5 if (core_1yr_ps==1 & exit_1yr_ps==1) //core and exit w/i 12 m
replace outcome_12m_v2=6 if (core_1yr_ps==1 & ind_p1core==1 & exit_1yr_ps==0 & ind_exit==1) //core w/i 12 m, exit after 12m
replace outcome_12m_v2=7 if (core_1yr_ps==0 & ind_p1core==1 & exit_1yr_ps==0 & ind_exit==1) //core and exit after 12m
replace outcome_12m_v2=8 if (ind_p1core==0 & ind_exit==0) // no core or exit interview
la def outcome_12m_v2 1 "Core interview within 1 year, no exit int."  ///
	2 "Core after 1 year, no exit int." 3 "Exit interview within 1 year, no core" ///
	4 "Exit interview after 1 year, no core" ///
	6 "Core within 1 year, exit after 1 year" ///
	7 "Core and exit after 1 year" 8 "No post surgery interview", modify
la val outcome_12m_v2 outcome_12m_v2
la var outcome_12m_v2 "Interview timeline categories"

tab outcome_12m_v2 mort_cat, missing

//Variable for no post surgery interview
gen byte post_surg_ivw=1
replace post_surg_ivw=0 if outcome_12m_v2==8
la var post_surg_ivw "Post surgery interview, exit or core"

*************************************************************************
*************************************************************************
//Look at p1 variables for obs who had a post surgery core interview
*************************************************************************
*************************************************************************
//independent functional status using adls
tab adl_independent_core_p1 if(core_1yr_ps==1), missing
//nursing home residence
tab nhres_p1 if(core_1yr_ps==1), missing
//surgery discharge destination codes - create new indicator variable
//62, 63, 3 code up to discharge to snf
tab stay_dstn_cd

//experienced functional decline post surgery
gen fx_diff_1 =  adl_index_core_p1 -  adl_index_core_n1
tab fx_diff_1 if(core_1yr_ps==1), missing

gen byte fx_decline=.
replace fx_decline=1 if fx_diff_1>0 & fx_diff_1~=.
replace fx_decline=0 if fx_diff_1<=0 & fx_diff_1~=.
tab fx_decline if(core_1yr_ps==1), missing

save surgery_final_n12m_sample_clean.dta, replace

log close


H="Stata - create prelim tables"
/*surgery project summary statistics
For tables from Zara Cooper requested 10/11/2013

Note, this does not drop observatons that are dropped from the following
survival analysis, run version in 'Stata - run tables with final sample' heading section
for final versions of unadjusted results, means tables
*/

capture log close

clear all
set mem 500m
set matsize 800
set more off

local texpath E:\data\surgery\2012_update\logs\tex\
local logpath E:\data\surgery\2012_update\logs\
local datapath E:\data\surgery\2012_update\final_2012clms\


log using `logpath'9_Surgery_code_tables.txt, text replace

cd "`datapath'"

use surgery_final_n12m_sample_clean.dta

***************************************************
// Hospital episode characteristics variables 
// from surgery claims
***************************************************
/*
****COMMENTED OUT - ZARA WILL POPULATE THIS PART OF THE TABLE HERSELF******
//categories of procedures
gen proc_cat=.
replace proc_cat=1 if inlist(procedure,5411,5412,5419,5459,5495)
replace proc_cat=2 if inlist(procedure,5209,5222,5299)
replace proc_cat=3 if inlist(procedure,4401,4441,4442,4492,4381,4391,4399,436,437,445)
replace proc_cat=4 if inlist(procedure,4502,4515,4551,1732,4572,4561,4562,4563,4601)
replace proc_cat=5 if inlist(procedure,4503,4522,4526,4570,4571,4572,4573,4574,4575,4576, ///
	4580,4581,4582,4583,4603)
replace proc_cat=6 if inlist(procedure,534,5351,5359,5361,5369)
replace proc_cat=7 if inlist(procedure,4700,4709)
replace proc_cat=8 if inlist(procedure,5120,5121,5122)
replace proc_cat=9 if proc_cat==.
lab var proc_cat "Procedure by Category"
la def proc_cat 1 "Laparotonomy, lysis of peritoneal adhesions, or incision peritoneum" ///
 2 "Pancreatic surgery" 3 "Gastric surgery" 4 "Small intestine" ///
 5 "Large Intestine" 6 "Hernia" 7 "Appendectomy" 8 "Open Cholecystectomy" ///
 9 "Other Surgery"
la val proc_cat proc_cat
tab proc_cat,missing
*/


***************************************************
***************************************************
// Table 1 - Cohort characteristics
***************************************************
***************************************************
local comorb el_cancer comorb_1_0_n12m comorb_32_0_n12m comorb_31_0_n12m comorb_13_0_n12m el_diab

//First part - Patient Factors
tabout age_cat_2 female re_cat tics_cat_miss `comorb' srh_fp_ncore adl_cat_ps nhres_n1 ///
	admit_ind_6m_pre using `logpath'table1a.txt, ///
c(freq col) oneway replace ///
style(tab) /*ptotal(none)*/ format(0c 2p)
//Note: this uses tabout, paste tab delimited file from text file into
//an excel spreadsheet for easy importing into a table

//Second part - hospital episode

local compl comp_any comp_uti comp_pe comp_pne comp_inf comp_rf comp_mi comp_kid comp_del

//Table 1b Hospital Episode:
//tabout /*proc_cat*/ index_los `compl' using `logpath'table1b.txt, ///
//c(freq col) oneway replace ///
//style(tab) /*ptotal(none)*/ format(0c 1p)
mat tab_1b=J(17,2,.)
sum index_los, detail
mat tab_1b[1,1]=r(mean)
mat tab_1b[1,2]=r(p50)
mat list tab_1b

local j=2
foreach v in `compl' {
	tab `v' , missing  matcell(m_`v')
	sca s_`v'_n=r(N)
	mat m_`v'_p=m_`v'/s_`v'_n
	mat tab_1b[`j',1] = m_`v'[2,1]
	mat tab_1b[`j',2] = m_`v'_p[2,1]*100 //in percent
	local j=`j'+1
}

local disch dis_home dis_ltc dis_rehab dis_hs dis_oth dis_died

local j=11
foreach v in `disch' {
	tab `v' , missing  matcell(m_`v')
	sca s_`v'_n=r(N)
	mat m_`v'_p=m_`v'/s_`v'_n
	mat tab_1b[`j',1] = m_`v'[2,1]
	mat tab_1b[`j',2] = m_`v'_p[2,1]*100 //in percent
	local j=`j'+1
}
mat list tab_1b 

frmttable using `logpath'table1b , statmat(tab_1b) ///
	title("Table 1b - Hospital episode") ///
	ctitle("","n", "%") ///
	rtitle("LOS - mean, median" \ "Any complication"\"UTI" \ "PE" \ "Pneumonia" \ ///
	 "Surgical site infection" \ "Respiratory failure" \ "MI" \ "Acute kidney failure" \ /// 
	"Delirium" \"Home"\"Long term care facility"\"Rehab"\ ///
		"Hospice"\"Other or Unknown"\"Expired") ///
	sdec(1,0 \ 0 , 2) replace

*******************************************************
*******************************************************
//Table 1c - timeline by 1 year outcome
*******************************************************
*******************************************************
//create matrix for output
mat tab_1c=J(21,4,.)
local timevars days_surg_n1core days_surg_p1core surg_to_death_dt days_surg_x

//N for each category of outcome at 1 year
tab outcome_1yr, missing matcell(samples)
mat list samples
sca sample_n4 = samples[4,1]
sca sample_n5 = samples[5,1]
sca sample_n1 = samples[1,1]
sca sample_n2 = (samples[2,1]+samples[3,1]) //died and either exit after 1 year or no exit
//sca sample_n3 = samples[3,1]

mat tab_1c[1,1] =  sample_n4
mat tab_1c[6,1] =  sample_n5
mat tab_1c[11,1] =  sample_n1
mat tab_1c[16,1] =  sample_n2

local j=2	
foreach v in `timevars' {
	sum `v' if outcome_1yr==4, detail //alive and completed core w/i 1 year
	mat tab_1c[`j',1]=r(N)
	mat tab_1c[`j',2]=sample_n4 - r(N)
	mat tab_1c[`j',3]=r(p50) //median
	mat tab_1c[`j',4]=r(sd) //standard deviation
	local j=`j'+1
}
mat list tab_1c
local j=7	
foreach v in `timevars' {
	sum `v' if outcome_1yr==5, detail //alive but no core w/i 1 year
	mat tab_1c[`j',1]=r(N)
	mat tab_1c[`j',2]=sample_n5 - r(N)
	mat tab_1c[`j',3]=r(p50) //median
	mat tab_1c[`j',4]=r(sd) //standard deviation
	local j=`j'+1
}
mat list tab_1c
local j=12	
foreach v in `timevars' {
	sum `v' if outcome_1yr==1, detail //died, exit w/i 1 year
	mat tab_1c[`j',1]=r(N)
	mat tab_1c[`j',2]=sample_n1 - r(N)
	mat tab_1c[`j',3]=r(p50) //median
	mat tab_1c[`j',4]=r(sd) //standard deviation
	local j=`j'+1
}
mat list tab_1c
local j=17	
foreach v in `timevars' {
	sum `v' if (outcome_1yr==2 | outcome_1yr==3) , detail //died, exit after 1 year or no exit
	mat tab_1c[`j',1]=r(N)
	mat tab_1c[`j',2]=sample_n2 - r(N)
	mat tab_1c[`j',3]=r(p50) //median
	mat tab_1c[`j',4]=r(sd) //standard deviation
	local j=`j'+1
}
mat list tab_1c

local 1clabel "Days from Baseline interview to surgery" \ "Days from Surgery to next core interview" \ ///
	"Days from Surgery to death" \ "Days from Surgery to exit interview"

frmttable using `logpath'table1b , statmat(tab_1c) ///
	title("Table 1c - Interview/Procedure Timeline") ///
	ctitle("Status at 1 year post surgery","N","N - missing", "Median", "SD") ///
	rtitle("Alive & completed next core" \ "Days from Baseline interview to surgery" \ ///
	"Days from Surgery to next core interview" \ "Days from Surgery to death" \ ///
	"Days from Surgery to exit interview" \ ///
	"Alive, no next core" \ "Days from Baseline interview to surgery" \ ///
	"Days from Surgery to next core interview" \ "Days from Surgery to death" \ ///
	"Days from Surgery to exit interview" \ ///
	"Died, exit complete" \ "Days from Baseline interview to surgery" \ ///
	"Days from Surgery to next core interview" \ "Days from Surgery to death" \ ///
	"Days from Surgery to exit interview" \ ///
	"Died, no exit" \ "Days from Baseline interview to surgery" \ ///
	"Days from Surgery to next core interview" \ "Days from Surgery to death" \ ///
	"Days from Surgery to exit interview") ///
	sdec(0,0,1,1) addtable

*******************************************************
*******************************************************
//Frequency table for possible outcomes 12 mos
*******************************************************
*******************************************************	



//output to txt file
tabout outcome_12m_v2 mort_cat using `logpath'table1c_2.txt, ///
/*c(freq col freq col )*/ replace ///
style(tab) ptotal(none) format(0c)
//Note: this uses tabout, paste tab delimited file from text file into
//an excel spreadsheet for easy importing into a table
//Totals across mortality columns need to be manually added since
//mortality variable used is mutually exclusive
//should fix this eventually!

*******************************************************
*******************************************************
//Table 1e - Sensitivity analysis, obs with no post
//surgery interview
*******************************************************
*******************************************************

local sensvars age_at_surg_65_74 age_at_surg_75_79 age_at_surg_80_84 ///
age_at_surg_gt84 female black_e hisp_eth_e white_e other_na_api_race_e ///
tics_ind_normal tics_ind_mci tics_ind_dem tics_ind_unk ///
el_cancer comorb_1_0_n12m comorb_32_0_n12m comorb_31_0_n12m ///
comorb_13_0_n12m el_diab srh_ve_ncore srh_g_ncore srh_fp_ncore ///
adl_ind_ncore adl_pd_ncore adl_sd_ncore nhres_n1 admit_ind_6m_pre

mat tab_1e=J(28,3,.)

//first row - just N's of the two groups
tab post_surg_ivw, matcell(row1)
mat tab_1e[1,1]=row1[1,1]
mat tab_1e[1,2]=row1[2,1]

local i=2
foreach var in `sensvars'{
	sum `var' if post_surg_ivw==0
	mat tab_1e[`i',1]=r(mean)
	sum `var' if post_surg_ivw==1
	mat tab_1e[`i',2]=r(mean)	
	tabulate `var' post_surg_ivw, exact
	mat tab_1e[`i',3]=r(p_exact)
	local i = `i'+1
}

mat list tab_1e

frmttable using `logpath'table1b , statmat(tab_1e) ///
	title("Table 1e - Sensitivity analysis, obs with no post-surgery interview" \ ///
	"P-values calculated from Fisher's exact test" ) ///
	ctitle("","Mean obs no interview","Mean obs with interview","p-value") ///
	rtitle("N" \ "Age: 65-74" \ "75-80" \ "80-84" \ "85+" \ ///
	"Female" \ "AA" \ "Hispanic" \ "White" \"Other" \ ///
	"TICS >8 Normal" \"5-8 MCI" \"<5 Demented"\ "TICS Unknown" \"Cancer" \"CHF" \ ///
	"CAD"\"Dementia"\"ESRD"\"Diabetes"\"Self reported health: Exc / VG" \ ///
	"Good" \ "Fair/Poor" \ "Baseline ADL: Independent" \ "Partial" \ "Severe" \  ///
	"Nursing home resident - Yes"  \ "Hospital admit in prior 6 mos: Yes" ) ///
	sdec(3,3,3) addtable

	
*******************************************************
*******************************************************
//Table 2 - unadjusted mortality rates - 
//Have to manually input 100% mortality rates for
//those with discharge code = expired
//Categories for mortality - 0-30d, 31-181d, 31-365d

*******************************************************
*******************************************************

mat tab_2=J(36,10,.)
//first column = N
//then percent, n and p value for each of 30 day mort, 180 mort and 365 mort

//first column - n for each subgroup
//first row is overall sample
sum died_30d //overall sample
mat tab_2[1,1]=r(N)
sum died_30d if age_cat_2==1 //age 65-74
mat tab_2[2,1]=r(N)
sum died_30d if age_cat_2==2 //age 75-84
mat tab_2[3,1]=r(N)
sum died_30d if age_cat_2==3 //age 85+
mat tab_2[4,1]=r(N)
/*sum died_30d if age_cat==4 //age 85+ **Only 3 categories now, don't need this row
mat tab_2[5,1]=r(N)*/
sum died_30d if female==1 //female
mat tab_2[5,1]=r(N)
sum died_30d if female==0 //male
mat tab_2[6,1]=r(N)
sum died_30d if re_cat==1 //aa
mat tab_2[7,1]=r(N)
sum died_30d if re_cat==2 //hispanic
mat tab_2[8,1]=r(N)
sum died_30d if re_cat==3 //white
mat tab_2[9,1]=r(N)
sum died_30d if re_cat==4 //other
mat tab_2[10,1]=r(N)
sum died_30d if tics_cat_miss==1 //tics normal
mat tab_2[11,1]=r(N)
sum died_30d if tics_cat_miss==2 //tics mci
mat tab_2[12,1]=r(N)
sum died_30d if tics_cat_miss==3 //tics demented
mat tab_2[13,1]=r(N)
sum died_30d if tics_cat_miss==4 //tics missing
mat tab_2[14,1]=r(N)	
local k=15
	foreach w in `comorb' {  //comorbidities: cancer, chf, cad, dementia, esrd, dm
		sum died_30d if `w'==1
		mat tab_2[`k',1]=r(N)
		local k = `k' + 1  //populates rows 15 through 20
	}
sum died_30d if srh_fp_ncore==0  //srhs excel/vg/good
mat tab_2[21,1]=r(N)
sum died_30d if srh_fp_ncore==1 //srhs f/p
mat tab_2[22,1]=r(N)
sum died_30d if adl_cat_ps==0 //adl ind
mat tab_2[23,1]=r(N)
sum died_30d if adl_cat_ps==1 //adl partial dep
mat tab_2[24,1]=r(N)
sum died_30d if nhres_n1==1 //nh resident - yes
mat tab_2[25,1]=r(N)
sum died_30d if nhres_n1==0 //nh resident - no
mat tab_2[26,1]=r(N)
sum died_30d if admit_ind_6m_pre==1 //pre surg admit - yes
mat tab_2[27,1]=r(N)
sum died_30d if admit_ind_6m_pre==0 //pre surg admit - no
mat tab_2[28,1]=r(N)
	local k=29
	forvalues i=1/6 {					//discharge locations:
		sum died_30d if stay_dstn_cat==`i'	//home, ltc, rehab
			//hospice, other, expired
		mat tab_2[`k',1]=r(N)
		local k = `k'+1 //rows 29-34
	}
sum died_30d if comp_any==1 // any complication - yes
mat tab_2[35,1]=r(N)
sum died_30d if comp_any==0 // any complication - no
mat tab_2[36,1]=r(N)


//next columns (keeps p columns blank)
local j=2
foreach v in died_30d died_180d died_365d {
tab `v', matcell(`v'_`j') //overall sample
mat tab_2[1,`j']=`v'_`j'[2,1]/r(N)*100 //percent
mat tab_2[1,`j'+1]=`v'_`j'[2,1] //n
tab `v' if age_cat_2==1, matcell(`v'_`j') //age 65-74
mat tab_2[2,`j']=`v'_`j'[2,1]/r(N)*100 //percent
mat tab_2[2,`j'+1]=`v'_`j'[2,1] //n
tab `v' if age_cat_2==2, matcell(`v'_`j') //age 75-84
mat tab_2[3,`j']=`v'_`j'[2,1]/r(N)*100
mat tab_2[3,`j'+1]=`v'_`j'[2,1]
tab `v' if age_cat_2==3, matcell(`v'_`j') //age 85+
mat tab_2[4,`j']=`v'_`j'[2,1]/r(N)*100
mat tab_2[4,`j'+1]=`v'_`j'[2,1]
tab `v' if female==1, matcell(`v'_`j') //female
mat tab_2[5,`j']=`v'_`j'[2,1]/r(N)*100
mat tab_2[5,`j'+1]=`v'_`j'[2,1]
tab `v' if female==0, matcell(`v'_`j') //male
mat tab_2[6,`j']=`v'_`j'[2,1]/r(N)*100
mat tab_2[6,`j'+1]=`v'_`j'[2,1]
tab `v' if re_cat==1, matcell(`v'_`j') //aa
mat tab_2[7,`j']=`v'_`j'[2,1]/r(N)*100
mat tab_2[7,`j'+1]=`v'_`j'[2,1]
tab `v' if re_cat==2, matcell(`v'_`j') //hispanic
mat tab_2[8,`j']=`v'_`j'[2,1]/r(N)*100
mat tab_2[8,`j'+1]=`v'_`j'[2,1]
tab `v' if re_cat==3, matcell(`v'_`j') //white
mat tab_2[9,`j']=`v'_`j'[2,1]/r(N)*100
mat tab_2[9,`j'+1]=`v'_`j'[2,1]
tab `v' if re_cat==4, matcell(`v'_`j') //other
mat tab_2[10,`j']=`v'_`j'[2,1]/r(N)*100
mat tab_2[10,`j'+1]=`v'_`j'[2,1]
tab `v' if tics_cat_miss==1, matcell(`v'_`j') //tics normal
mat tab_2[11,`j']=`v'_`j'[2,1]/r(N)*100
mat tab_2[11,`j'+1]=`v'_`j'[2,1]
tab `v' if tics_cat_miss==2, matcell(`v'_`j') //tics mci
mat tab_2[12,`j']=`v'_`j'[2,1]/r(N)*100
mat tab_2[12,`j'+1]=`v'_`j'[2,1]
tab `v' if tics_cat_miss==3, matcell(`v'_`j') //tics demented
mat tab_2[13,`j']=`v'_`j'[2,1]/r(N)*100
mat tab_2[13,`j'+1]=`v'_`j'[2,1]
tab `v' if tics_cat_miss==4, matcell(`v'_`j') //tics missing
mat tab_2[14,`j']=`v'_`j'[2,1]/r(N)*100
mat tab_2[14,`j'+1]=`v'_`j'[2,1]	
local k=15
	foreach w in `comorb' {  //comorbidities: cancer, chf, cad, dementia, esrd, dm
		tab `v' if `w'==1, matcell(`v'_`j')
		mat tab_2[`k',`j']=`v'_`j'[2,1]/r(N)*100
		mat tab_2[`k',`j'+1]=`v'_`j'[2,1]
		local k = `k' + 1  //populates rows 15 through 20
	}
tab `v' if srh_fp_ncore==0 , matcell(`v'_`j') //srhs excel/vg/g
mat tab_2[21,`j']=`v'_`j'[2,1]/r(N)*100
mat tab_2[21,`j'+1]=`v'_`j'[2,1]
tab `v' if srh_fp_ncore==1, matcell(`v'_`j') //srhs f/p
mat tab_2[22,`j']=`v'_`j'[2,1]/r(N)*100
mat tab_2[22,`j'+1]=`v'_`j'[2,1]
tab `v' if adl_cat_ps==0, matcell(`v'_`j') //adl ind
mat tab_2[23,`j']=`v'_`j'[2,1]/r(N)*100
mat tab_2[23,`j'+1]=`v'_`j'[2,1]
tab `v' if adl_cat_ps==1 , matcell(`v'_`j') //adl partial, sev dep
mat tab_2[24,`j']=`v'_`j'[2,1]/r(N)*100
mat tab_2[24,`j'+1]=`v'_`j'[2,1]
tab `v' if nhres_n1==1, matcell(`v'_`j') //nh resident - yes
mat tab_2[25,`j']=`v'_`j'[2,1]/r(N)*100
mat tab_2[25,`j'+1]=`v'_`j'[2,1]
tab `v' if nhres_n1==0, matcell(`v'_`j') //nh resident - no
mat tab_2[26,`j']=`v'_`j'[2,1]/r(N)*100
mat tab_2[26,`j'+1]=`v'_`j'[2,1]
tab `v' if admit_ind_6m_pre==1, matcell(`v'_`j') //pre surg admit - yes
mat tab_2[27,`j']=`v'_`j'[2,1]/r(N)*100
mat tab_2[27,`j'+1]=`v'_`j'[2,1]
tab `v' if admit_ind_6m_pre==0, matcell(`v'_`j') //pre surg admit - no
mat tab_2[28,`j']=`v'_`j'[2,1]/r(N)*100
mat tab_2[28,`j'+1]=`v'_`j'[2,1]
	local k=29
	forvalues i=1/6 {					//discharge locations:
		tab `v' if stay_dstn_cat==`i', matcell(`v'_`j')	//home, ltc, rehab
		mat tab_2[`k',`j']=`v'_`j'[2,1]/r(N)*100			//hospice, other, expired
		mat tab_2[`k',`j'+1]=`v'_`j'[2,1]
		local k = `k'+1
	}
tab `v' if comp_any==1, matcell(`v'_`j') // any complication - yes
mat tab_2[35,`j']=`v'_`j'[2,1]/r(N)*100
mat tab_2[35,`j'+1]=`v'_`j'[2,1]
tab `v' if comp_any==0, matcell(`v'_`j') // any complication - no
mat tab_2[36,`j']=`v'_`j'[2,1]/r(N)*100
mat tab_2[36,`j'+1]=`v'_`j'[2,1]
local j = `j' + 3
}
mat list tab_2

//p value columns - using Fisher's exact test

local j=4
foreach v in died_30d died_180d died_365d {
tab age_cat_2 `v', exact  //age
mat tab_2[2,`j']=r(p_exact) //pvalue
tab female  `v', exact  //gender
mat tab_2[5,`j']=r(p_exact) 
tab re_cat  `v', exact  //race
mat tab_2[7,`j']=r(p_exact) 
tab tics_cat_miss  `v', exact  //tics
mat tab_2[11,`j']=r(p_exact) 
	local k=15
	foreach w in `comorb' {  //comorbidities: cancer, chf, cad, dementia, esrd, dm
		tab `w' `v', exact
		mat tab_2[`k',`j']=r(p_exact)
		local k = `k' + 1  //populates rows 15 through 20
	}
tab srh_fp_ncore `v', exact  //self reported health
mat tab_2[21,`j']=r(p_exact) 
tab adl_cat_ps `v', exact  //adl
mat tab_2[23,`j']=r(p_exact) 
tab nhres_n1  `v', exact  //nursing home res
mat tab_2[25,`j']=r(p_exact) 
tab admit_ind_6m_pre  `v', exact  //admit 6 mos
mat tab_2[27,`j']=r(p_exact) 
tab stay_dstn_cat  `v', exact  //discharge loc
mat tab_2[29,`j']=r(p_exact) 
tab comp_any  `v', exact  //any complication
mat tab_2[35,`j']=r(p_exact) 
local j = `j' + 3
}

frmttable using `logpath'table1b , statmat(tab_2) ///
	title("Table 2 - Unadjusted 30-, 180- and 365-Day Mortality") ///
	ctitle("","N all","0-30-Day %","n","p-val","0-180-Day %","n","p-val", "0-365-Day %","n","p-val") ///
	rtitle("Overall sample" \ "Age: 65-74" \ "75-84" \ "85+" \ ///
	"Female" \ "Male"\ "AA" \ "Hispanic" \ "White" \"Other" \ ///
	"TICS >8 Normal" \"5-8 MCI" \"<5 Demented"\ "TICS Unknown" \"Cancer" \"CHF" \ ///
	"CAD"\"Dementia"\"ESRD"\"Diabetes"\"Self reported health: Exc / VG / Good" \ ///
	"Fair/Poor" \ "Baseline ADL: Independent" \ "ADL: Any Dependence" \  ///
	"Nursing home resident - Yes" \ "No" \ "Hospital admit in prior 6 mos: Yes" \ "No" \ ///
	"Discharge location: Home" \ "Long term care" \ "Inpatient rehab" \"Hospice" \  ///
	"Other or Unknown" \ "Expired" \ "Any complication: Yes" \ "No") ///
	note("P-values are calculating using Fisher's exact test.") ///
	sdec(0,2,0,3,2,0,3,2,0,3) addtable


******************************************************************
******************************************************************
// Tables to compare comorbidity / chronic conditions measures
******************************************************************
******************************************************************
local hcc cc_1_ami_n12mn0 cc_2_alzh_n12mn0 cc_3_alzhdmta_n12mn0 ///
cc_4_atrialfb_n12mn0 cc_5_cataract_n12mn0 cc_6_chrnkidn_n12mn0 ///
cc_7_copd_n12mn0 cc_8_chf_n12mn0 cc_9_diabetes_n12mn0 cc_10_glaucoma_n12mn0 ///
cc_11_hipfrac_n12mn0 cc_12_ischmcht_n12mn0 cc_13_depressn_n12mn0 ///
cc_14_osteoprs_n12mn0 cc_15_ra_oa_n12mn0 cc_16_strketia_n12mn0 ///
cc_17_cncrbrst_n12mn0 cc_18_cncrclrc_n12mn0 cc_19_cncrprst_n12mn0 ///
cc_20_cncrlung_n12mn0 cc_21_cncrendm_n12mn0 cc_ami_isch_n12mn0 ///
cc_alzheim_n12mn0 cc_cncr_chronic_n12mn0


local elix comorb_1_0_n12m comorb_2_0_n12m comorb_3_0_n12m comorb_4_0_n12m ///
comorb_5_0_n12m comorb_6_0_n12m comorb_7_0_n12m comorb_8_0_n12m ///
comorb_9_0_n12m comorb_10_0_n12m comorb_11_0_n12m comorb_12_0_n12m ///
comorb_13_0_n12m comorb_14_0_n12m comorb_15_0_n12m comorb_16_0_n12m ///
comorb_17_0_n12m comorb_18_0_n12m comorb_19_0_n12m comorb_20_0_n12m ///
comorb_21_0_n12m comorb_22_0_n12m comorb_23_0_n12m comorb_24_0_n12m ///
comorb_25_0_n12m comorb_26_0_n12m comorb_27_0_n12m comorb_28_0_n12m ///
comorb_29_0_n12m comorb_30_0_n12m

mat hcc_mean=J(24,2,.)
local i=1
foreach v in `hcc'{
sum `v'
mat hcc_mean[`i',1]=r(mean)
mat hcc_mean[`i',2]=r(N)
local i=`i'+1
}

mat rownames hcc_mean ="AMI" "Alzheimer's" "Alzheimer's or Dementia" "Atrial Fibrillation" ///
"Cataract" "Chronic Kidney Disease" ///
"COPD" "CHF" "Diabetes" "Glaucoma" "Hip fracture" "Ischemic Heart Disease" "Depression" ///
"Osteoporosis" "Rheumatoid Arthritis" "Stroke" "Cancer - Breast" "Cancer - Colorectal" "Cancer - Prostate" ///
"Cancer - Lung" "Cancer - Endometrial" "AMI+ISCH" "Alzh + Dementia" "Cancer - any"


mat el_mean=J(30,2,.)
local i=1
foreach v in `elix'{
sum `v'
mat el_mean[`i',1]=r(mean)
mat el_mean[`i',2]=r(N)
local i=`i'+1
}

mat rownames el_mean = "Congestive Heart Failure" "Cariac Arrhythmias" "Valvular Disease" ///
"Pulmonary Circulation Disorders" "Peripheral Vascular Disorders" "Hypertension" ///
 "Paralysis" "Other Neurological Disorders" "Chronic Pulmonary Disease" "Diabetes, uncomplicated" ///
 "Diabetes, complicated" "Hypothyroidism" "Renal Failure" "Liver Disease" ///
 "Peptic Ulcer Disease" "AIDS" "Lymphoma" "Metastatic Cancer" ///
 "Solid Tumor without Metastisis" "Rheumatoid Arthritis" ///
 "Coagulopathy" "Obesity" "Weight Loss" "Fluid and Electrolyte Disorders" ///
 "Blood Loss Anemia" "Deficiency Anemias" "Alcohol Abuse" "Drug Abuse" "Psychoses" "Depression"

mat list hcc_mean
mat list el_mean

	
frmttable using `logpath'cc_elix, statmat(hcc_mean) ///
title("Chronic conditions") ctitle("","Mean","N") ///
sdec(2,0) replace
 
frmttable using `logpath'cc_elix, statmat(hcc_mean) ///
title("Elixhauser comorbidities") ctitle("","Mean","N") ///
sdec(2,0) addtable 
 
tab claims_esrd_ind comorb_13_0_n12m, missing

log close
/*
//looking at date of death

//11 obs have exit interview but missing date of death
 tab died_ind ind_exit, missing
 
 gen dod_to_exit = (  e_ivw_date_x - death_date_e)
 tab dod_to_exit if(died_ind==1), missing //all exit interviews are at least after date of death
 //there are a few though with exit interviews more than 1000 days after death


H="Stata - Run survival analysis "
/*surgery project analysis

Created 1/15/2014 to run preliminary logit regressions of age on mortality

Have to manually add in variable labels to word document, varlabels
not working with categorical variables for some reason

This version runs with the mortality outcome time windows of:
0-30 days
31-180 days
31-365 days

Does stset on the dataset and saves it for other analyses that follow so always run this code 
if dataset is changed*/

capture log close

clear all
set mem 500m
set matsize 800
set more off

local texpath E:\data\surgery\2012_update\logs\tex\
local logpath E:\data\surgery\2012_update\logs
local datapath E:\data\surgery\2012_update\final_2012clms\

log using `logpath'\10_Surgery_code_analysis1.txt, text replace

use `datapath'surgery_final_n12m_sample_clean.dta

numlabel, add

tab died_0_30 died_31_180, missing
tab died_0_30 died_31_365, missing

***********************************************************************
***********************************************************************
//Survival analysis
***********************************************************************
***********************************************************************

//first assign a new date, end_date
//This is either the death date or the follow up date
//Follow up date is set to actual follow up date (from p1 core or claims) or 
//Dec 31,2011 since DOD file from HRS/NDI should be complete thru 2011
format death_date %td
//tab death_date, missing
gen end_date=.
format end_date %td
replace end_date=death_date if died_ind==1 //use DOD if present
replace end_date=c_ivw_date_p1 if end_date==. & (c_ivw_date_p1-procedure_date >= 365) //p1 ivw date if +1yr ps
replace end_date=follow_up_dt_1yr_ps if end_date==. //use claims follow up date
replace end_date= mdy(12,31,2011) if end_date==. & ind_exit==0
tab end_date, missing
//lose the one obs has an exit interview but no death date

//indicator for missing information within 1 year of death
gen proced_to_end_dt = end_date - procedure_date
tab proced_to_end_dt core_year_p1 if died_ind==0
gen censor_1y_ind = .
replace censor_1y_ind = 1 if proced_to_end_dt<365 & died_ind==0
replace censor_1y_ind = 0 if proced_to_end_dt>=365 | (proced_to_end_dt<365 & died_ind==1)
replace censor_1y_ind = . if end_date==.
tab censor_1y_ind, missing
//no censored observations!
//the observaton with an exit ivw and no dod will be dropped from the data for the km curve

//2 observations die on date of surgery
tab stay_dstn_cd index_los if(death_date<=procedure_date )
tab procedure_date death_date if(death_date<procedure_date)
tab procedure_date end_date if(death_date<procedure_date)
tab id if(death_date<procedure_date)

//save dataset with end date assigned
save `datapath'surgery_final_n12m_sample_clean_end_date.dta, replace

//set for 1 year outcomes only by specifying exit time
stset end_date, failure(died_365d) origin(procedure_date) exit(time procedure_date + 365)

//set with no end date, looks at outcomes > 1 year where present
//stset end_date, failure(died_ind) origin(procedure_date)

stdes

//save dataset with stset assigned
saveold `datapath'surgery_final_n12m_sample_clean_stset.dta, replace version(11)


tab censor_1y_ind if _st==1
tab procedure_date if censor_1y_ind==1 & _st==1, missing
tab  c_ivw_date_p1 if censor_1y_ind==1 & _st==1, missing

tab procedure_date admit_12m_post if censor_1y_ind==1 & _st==1, missing
tab procedure_date snf_days_post_12m if censor_1y_ind==1 & _st==1, missing

tab adl_cat_core_n1 if procedure_date==d(20mar2002) & censor_1y_ind==1 & _st==1

******************************************************************
******************************************************************
//Run regression - effect of age on mortality
//Exclude the discharge location variables, include diabetes
******************************************************************
******************************************************************
//base categories are age=65-73, srh=very good/excellent 
//adl = independent, disch destination = home
//no disch destination rehab (b/c no obs)
local xvars_no_disch ib1.age_cat i.comorb_1_0_n12m i.comorb_32_0_n12m ///
	i.comorb_31_0_n12m i.comorb_13_0_n12m i.el_diab ///
	ib1.srh_cat_core ib0.adl_cat_core i.nhres_n1 i.admit_ind_6m_pre ///
	/*ib1.stay_dstn_cat i2.stay_dstn_cat i4.stay_dstn_cat ///
	i5.stay_dstn_cat i6.stay_dstn_cat*/ i.comp_any

logit died_0_30 `xvars_no_disch' if _st==1, /*vce(r)*/ or
estat ic
outreg, ///
	stats(e_b e_ci) ctitles("","0-30-Day") ///
	title("Effect of age on mortality") ///
	note("Odds ratios, 95% confidence intervals reported" \ ///
	"Base categories are Age: 65-74, Self-reported health: Excellent or very good," \ ///
	"and ADL: Independent.") ///
	varlabels store(table4) starlevels(10 5 1)

logit died_31_180 `xvars_no_disch' if died_0_30==0 & _st==1, /*vce(r)*/ or
estat ic
outreg, ///
	stats(e_b e_ci)  ctitles("","31-180-Day") ///
	varlabels merge(table4) starlevels(10 5 1)

logit died_31_365 `xvars_no_disch' if died_0_30==0 & _st==1, /*vce(r)*/ or
estat ic
outreg using `logpath'\logit_age, ///
	stats(e_b e_ci)  ctitles("","31-365-Day") ///
	varlabels merge(table4) starlevels(10 5 1) replace		

	
	
******************************************************************
******************************************************************
//Run regression - effect of age on mortality
//All controls
******************************************************************
******************************************************************
//base categories are age=65-73, race=white, tics=normal srh=very good/excellent 
//adl = independent, disch destination = home
//variables omitted b/c no obs: race=other, tics=demented, disch=rehab
local xvars_30d_all ib1.age_cat i.female i1.re_cat i2.re_cat ib3.re_cat ///
	i1b.tics_cat_miss i2.tics_cat_miss i4.tics_cat_miss ///
	i.el_cancer i.comorb_1_0_n12m i.comorb_32_0_n12m i.comorb_31_0_n12m ///
	i.comorb_13_0_n12m i.el_diab ib1.srh_cat_core ib0.adl_cat_core ///
	i.nhres_n1 i.admit_ind_6m_pre ///
	ib1.stay_dstn_cat i2.stay_dstn_cat i4.stay_dstn_cat ///
	i5.stay_dstn_cat i6.stay_dstn_cat i.comp_any

//For 180 day mortality regression
//variables omitted b/c no obs: tics=demented, disch=expired 
local xvars_180d_all ib1.age_cat i.female ib3.re_cat ///
	i1b.tics_cat_miss i2.tics_cat_miss i4.tics_cat_miss ///
	i.el_cancer i.comorb_1_0_n12m i.comorb_32_0_n12m i.comorb_31_0_n12m ///
	i.comorb_13_0_n12m i.el_diab ib1.srh_cat_core ib0.adl_cat_core ///
	i.nhres_n1 i.admit_ind_6m_pre ///
	ib1.stay_dstn_cat i2.stay_dstn_cat i3.stay_dstn_cat ///
	i4.stay_dstn_cat i5.stay_dstn_cat i.comp_any	

//For 365 day mortality regression
//variables omitted b/c no obs: tics=demented, disch=expired 
local xvars_180d_all ib1.age_cat i.female ib3.re_cat ///
	i1b.tics_cat_miss i2.tics_cat_miss i3.tics_cat_miss i4.tics_cat_miss ///
	i.el_cancer i.comorb_1_0_n12m i.comorb_32_0_n12m i.comorb_31_0_n12m ///
	i.comorb_13_0_n12m i.el_diab ib1.srh_cat_core ib0.adl_cat_core ///
	i.nhres_n1 i.admit_ind_6m_pre ///
	ib1.stay_dstn_cat i2.stay_dstn_cat i3.stay_dstn_cat ///
	i4.stay_dstn_cat i5.stay_dstn_cat i.comp_any	

logit died_0_30 `xvars_30d_all'  if _st==1, /*vce(r)*/ or
outreg, ///
	stats(e_b e_ci) ctitles("","30-Day") ///
	title("Effect of age on mortality - All covariates") ///
	note("Odds ratios, 95% confidence intervals reported" \ ///
	"Base categories are Age: 65-74, Race: White, TICS: Normal," \ ///
	"Self-reported health: Excellent or very good," \ ///
	"ADL: Independent, and Discharged to Home.") ///
	varlabels store(table5) starlevels(10 5 1)

logit died_31_180 `xvars_180d_all' if died_0_30==0 & _st==1, /*vce(r)*/ or
outreg, ///
	stats(e_b e_ci)  ctitles("","180-Day") ///
	varlabels merge(table5) starlevels(10 5 1)

logit died_31_365 `xvars_180d_all' if died_0_30==0 & _st==1, /*vce(r)*/ or
outreg using `logpath'\logit_age, ///
	stats(e_b e_ci)  ctitles("","365-Day") ///
	varlabels merge(table5) starlevels(10 5 1) addtable		



***********************************************************************************
***********************************************************************************
//KM Curve
***********************************************************************************
***********************************************************************************
sts list
sts graph
sts graph, by(age_cat_2) /*tmax(400)*/ ///
legend(label(1 "Age: 65-74") label(2 "75-84") label(3 "85 and older"))
graph export `logpath'\KMCurve.png, replace

local allxvars age_cat female re_cat tics_cat_miss ///
	el_cancer comorb_1_0_n12m comorb_32_0_n12m comorb_31_0_n12m ///
	comorb_13_0_n12m el_diab srh_cat_core adl_cat_core ///
	nhres_n1 admit_ind_6m_pre ///
	stay_dstn_cat comp_any

foreach v in `allxvars'{
sts test `v', logrank
}

***********************************************************************************
***********************************************************************************
//Run complementary log log model
***********************************************************************************
***********************************************************************************
cloglog died_0_30 `xvars_no_disch' if _st==1, eform
outreg, ///
 	stats(e_b e_ci) ctitles("","0-30-Day") ///
	title("Effect of age on mortality - Complementary log log model") ///
	note("Hazard ratios, 95% confidence intervals reported" \ ///
	"Base categories are Age: 65-74, Self-reported health: Excellent or very good," \ ///
	"and ADL: Independent.") ///
	varlabels store(table6) starlevels(10 5 1)

cloglog died_31_180 `xvars_no_disch' if died_0_30==0 & _st==1, eform
outreg, ///
 	stats(e_b e_ci) ctitles("","31-180-Day") ///
	varlabels merge(table6) starlevels(10 5 1)

cloglog died_31_365 `xvars_no_disch' if died_0_30==0 & _st==1, eform
outreg using `logpath'\logit_age, ///
	stats(e_b e_ci) ctitles("","31-365-Day") ///
	varlabels merge(table6) starlevels(10 5 1) addtable

	
log close


H="Stata - run survival analysis, version 2"
/*surgery project analysis - version 2

This version runs with the mortality outcome time windows of:
0-30 days
0-180 days
0-365 days 

Changes per comments are:
1. dichotomize variables for ADL and SRH
2. Run 2 versions, one with complications and one without
3. Combine age categories to <75, 75-84 and 85+
4. Add cancer as comorbidity to be consistent
5. Drop nursing home residence status

These results are what is discussed in the draft of the paper from 
Zara on 7-14-2014
*/

capture log close

clear all
set mem 500m
set matsize 800
set more off

local texpath E:\data\surgery\2012_update\logs\tex\
local logpath E:\data\surgery\2012_update\logs
local datapath E:\data\surgery\2012_update\final_2012clms\

log using `logpath'\10_Surgery_code_analysis_v2.txt, text replace

use `datapath'surgery_final_n12m_sample_clean_stset.dta

tab died_30d died_180d, missing
tab died_30d died_365d, missing

stdes

tab censor_1y_ind if _st==1
tab procedure_date if censor_1y_ind==1 & _st==1, missing
tab  c_ivw_date_p1 if censor_1y_ind==1 & _st==1, missing

tab procedure_date admit_12m_post if censor_1y_ind==1 & _st==1, missing
tab procedure_date snf_days_post_12m if censor_1y_ind==1 & _st==1, missing

tab adl_cat_core_n1 if procedure_date==d(20mar2002) & censor_1y_ind==1 & _st==1


******************************************************************
******************************************************************
//Run regression - effect of age on mortality
//Exclude the discharge location variables, include diabetes
//outcomes are died 0-30d, 0-180d, and 0-365d
******************************************************************
******************************************************************
//base categories are age=65-74, srh=very good/excellent/good 
//adl = independent
local xvars_no_disch ib1.age_cat_2 el_cancer i.comorb_1_0_n12m i.comorb_32_0_n12m ///
	i.comorb_31_0_n12m i.comorb_13_0_n12m i.el_diab ///
	i.srh_fp_ncore i.adl_cat_ps /*i.nhres_n1*/ i.admit_ind_6m_pre ///
	/*ib1.stay_dstn_cat i2.stay_dstn_cat i4.stay_dstn_cat ///
	i5.stay_dstn_cat i6.stay_dstn_cat i.comp_any*/

logit died_30d `xvars_no_disch' if _st==1, /*vce(r)*/ or
estat ic
outreg, ///
	stats(e_b e_ci) ctitles("","0-30-Day") ///
	title("Effect of age on mortality - v2") ///
	note("Odds ratios, 95% confidence intervals reported" \ ///
	"Base categories are Age: 65-74, Self-reported health: Excellent, very good or good," \ ///
	"and ADL: Independent.") ///
	varlabels store(table4) starlevels(10 5 1)

logit died_180d `xvars_no_disch' if _st==1, /*vce(r)*/ or
estat ic
outreg, ///
	stats(e_b e_ci)  ctitles("","0-180-Day") ///
	varlabels merge(table4) starlevels(10 5 1)

logit died_365d `xvars_no_disch' if _st==1, /*vce(r)*/ or
estat ic
outreg using `logpath'\logit_age_v2, ///
	stats(e_b e_ci)  ctitles("","0-365-Day") ///
	varlabels merge(table4) starlevels(10 5 1) replace		

	
***********************************************************************************
***********************************************************************************
//Run complementary log log model, excluding complications
***********************************************************************************
***********************************************************************************
cloglog died_30d `xvars_no_disch' if _st==1, eform
outreg, ///
 	stats(e_b e_ci) ctitles("","0-30-Day") ///
	title("Table 3: Effect of age on mortality - Complementary log log model, v2") ///
	note("Hazard ratios, 95% confidence intervals reported" \ ///
	"Base categories are Age: 65-74, Self-reported health: Excellent, very good or good," \ ///
	"and ADL: Independent.") ///
	varlabels store(table6) starlevels(10 5 1)

cloglog died_180d `xvars_no_disch' if _st==1, eform
outreg, ///
 	stats(e_b e_ci) ctitles("","0-180-Day") ///
	varlabels merge(table6) starlevels(10 5 1)

cloglog died_365d `xvars_no_disch' if _st==1, eform
outreg using `logpath'\logit_age_v2, ///
	stats(e_b e_ci) ctitles("","0-365-Day") ///
	varlabels merge(table6) starlevels(10 5 1) addtable
	
	***********************************************************************************
***********************************************************************************
//Run complementary log log model, including complications
***********************************************************************************
***********************************************************************************
//base categories are age=65-74, srh=very good/excellent/good 
//adl = independent
local xvars_no_disch2 ib1.age_cat_2 el_cancer i.comorb_1_0_n12m i.comorb_32_0_n12m ///
	i.comorb_31_0_n12m i.comorb_13_0_n12m i.el_diab ///
	i.srh_fp_ncore i.adl_cat_ps /*i.nhres_n1*/ i.admit_ind_6m_pre ///
	/*ib1.stay_dstn_cat i2.stay_dstn_cat i4.stay_dstn_cat ///
	i5.stay_dstn_cat i6.stay_dstn_cat*/ i.comp_any

cloglog died_30d `xvars_no_disch2' if _st==1, eform
outreg, ///
 	stats(e_b e_ci) ctitles("","0-30-Day") ///
	title("Table 4: Effect of age on mortality - Complementary log log model" \ ///
	"Including complications during surgery as covariate") ///
	note("Hazard ratios, 95% confidence intervals reported" \ ///
	"Base categories are Age: 65-74, Self-reported health: Excellent, very good or good," \ ///
	"and ADL: Independent.") ///
	varlabels store(table6) starlevels(10 5 1)

cloglog died_180d `xvars_no_disch2' if _st==1, eform
outreg, ///
 	stats(e_b e_ci) ctitles("","0-180-Day") ///
	varlabels merge(table6) starlevels(10 5 1)

cloglog died_365d `xvars_no_disch2' if _st==1, eform
outreg using `logpath'\logit_age_v2, ///
	stats(e_b e_ci) ctitles("","0-365-Day") ///
	varlabels merge(table6) starlevels(10 5 1) addtable


	
log close


H="Stata - run survival analysis, version 3"
/*surgery project analysis - version 3

This version runs with the mortality outcome time windows of:
0-30 days
0-180 days
0-365 days 

Changes from version 2 per comments are:
1. Add control for days from n1 core to index surgery

Updates from comments / questions from Zara and Amy 
after she sent draft of the paper on 7-14-2014
*/

capture log close

clear all
set mem 500m
set matsize 800
set more off

local texpath E:\data\surgery\2012_update\logs\tex\
local logpath E:\data\surgery\2012_update\logs
local datapath E:\data\surgery\2012_update\final_2012clms\

log using `logpath'\10_Surgery_code_analysis_v3.txt, text replace

use `datapath'surgery_final_n12m_sample_clean_stset.dta

tab died_30d died_180d, missing
tab died_30d died_365d, missing

stdes

tab censor_1y_ind if _st==1
tab procedure_date if censor_1y_ind==1 & _st==1, missing
tab  c_ivw_date_p1 if censor_1y_ind==1 & _st==1, missing

tab procedure_date admit_12m_post if censor_1y_ind==1 & _st==1, missing
tab procedure_date snf_days_post_12m if censor_1y_ind==1 & _st==1, missing

tab adl_cat_core_n1 if procedure_date==d(20mar2002) & censor_1y_ind==1 & _st==1

sum days_surg_n1core, detail

******************************************************************
******************************************************************
//Run regression - effect of age on mortality
//Exclude complications
//outcomes are died 0-30d, 0-180d, and 0-365d
******************************************************************
******************************************************************
//base categories are age=65-74, srh=very good/excellent/good 
//adl = independent
local xvars_no_disch ib1.age_cat_2 i.comorb_32_0_n12m el_cancer i.comorb_1_0_n12m ///
	i.el_diab i.comorb_13_0_n12m i.comorb_31_0_n12m ///
	i.admit_ind_6m_pre i.adl_cat_ps i.srh_fp_ncore days_surg_n1core 

logit died_30d `xvars_no_disch' if _st==1, /*vce(r)*/ or
estat ic
outreg, ///
	stats(e_b e_ci) ctitles("","0-30-Day") ///
	title("Effect of age on mortality - v3") ///
	note("Odds ratios, 95% confidence intervals reported" \ ///
	"Base categories are Age: 65-74, Self-reported health: Excellent, very good or good," \ ///
	"and ADL: Independent.") ///
	varlabels store(table4) starlevels(10 5 1) bdec(2)

logit died_180d `xvars_no_disch' if _st==1, /*vce(r)*/ or
estat ic
outreg, ///
	stats(e_b e_ci)  ctitles("","0-180-Day") ///
	varlabels merge(table4) starlevels(10 5 1) bdec(2)

logit died_365d `xvars_no_disch' if _st==1, /*vce(r)*/ or
estat ic
outreg using `logpath'\logit_age_v3, ///
	stats(e_b e_ci)  ctitles("","0-365-Day") ///
	varlabels merge(table4) starlevels(10 5 1) bdec(2) replace		

	
***********************************************************************************
***********************************************************************************
//Run complementary log log model, excluding complications
***********************************************************************************
***********************************************************************************
cloglog died_30d `xvars_no_disch' if _st==1, eform
outreg, ///
 	stats(e_b e_ci) ctitles("","0-30-Day") ///
	title("Table 3: Effect of age on mortality - Complementary log log model, v3") ///
	note("Hazard ratios, 95% confidence intervals reported" \ ///
	"Base categories are Age: 65-74, Self-reported health: Excellent, very good or good," \ ///
	"and ADL: Independent.") ///
	varlabels store(table6) starlevels(10 5 1) bdec(2)

cloglog died_180d `xvars_no_disch' if _st==1, eform
outreg, ///
 	stats(e_b e_ci) ctitles("","0-180-Day") ///
	varlabels merge(table6) starlevels(10 5 1) bdec(2)

cloglog died_365d `xvars_no_disch' if _st==1, eform
outreg using `logpath'\logit_age_v3, ///
	stats(e_b e_ci) ctitles("","0-365-Day") ///
	varlabels merge(table6) starlevels(10 5 1) bdec(2) addtable
	
***********************************************************************************
***********************************************************************************
//Run complementary log log model, including complications
***********************************************************************************
***********************************************************************************

cloglog died_30d `xvars_no_disch' i.comp_any if _st==1, eform
outreg, ///
 	stats(e_b e_ci) ctitles("","0-30-Day") ///
	title("Table 4: Effect of age on mortality - Complementary log log model" \ ///
	"Including complications during surgery as covariate") ///
	note("Hazard ratios, 95% confidence intervals reported" \ ///
	"Base categories are Age: 65-74, Self-reported health: Excellent, very good or good," \ ///
	"and ADL: Independent.") ///
	varlabels store(table6) starlevels(10 5 1) bdec(2)

cloglog died_180d `xvars_no_disch' i.comp_any if _st==1, eform
outreg, ///
 	stats(e_b e_ci) ctitles("","0-180-Day") ///
	varlabels merge(table6) starlevels(10 5 1) bdec(2) 

cloglog died_365d `xvars_no_disch' i.comp_any if _st==1, eform
outreg using `logpath'\logit_age_v3, ///
	stats(e_b e_ci) ctitles("","0-365-Day") ///
	varlabels merge(table6) starlevels(10 5 1) bdec(2) addtable

********************************************************************************
log close


H="Stata - run tables with final sample"
/*surgery project analysis

Created 3/13/2014 to run unadjusted means tables for the final sample
that was used for the survival analysis

Have to manually add in variable labels to word document, varlabels
not working with categorical variables for some reason

This version runs with the mortality outcome time windows of:
0-30 days
0-180 days
0-365 days*/

capture log close

clear all
set mem 500m
set matsize 800
set more off

local logpath E:\data\surgery\2012_update\logs\
local datapath E:\data\surgery\2012_update\final_2012clms\

log using `logpath'11_Surgery_code_finaltables.txt, text replace

use `datapath'surgery_final_n12m_sample_clean_stset.dta if _st==1

stdes

//numlabel, add

tab died_0_30 died_31_180, missing
tab died_0_30 died_31_365, missing

stdes

tab _st, missing

//Run tables where _st==1

***************************************************
***************************************************
// Table 1 - Cohort characteristics
***************************************************
***************************************************
local comorb el_cancer comorb_1_0_n12m comorb_32_0_n12m comorb_31_0_n12m comorb_13_0_n12m el_diab

//First part - Patient Factors
tabout age_cat_2 female re_cat tics_cat_miss `comorb' srh_fp_ncore adl_cat_ps nhres_n1 ///
	admit_ind_6m_pre using `logpath'table1a_final.txt, ///
	c(freq col) oneway replace ///
	style(tab) /*ptotal(none)*/ format(0c 2p)
//Note: this uses tabout, paste tab delimited file from text file into
//an excel spreadsheet for easy importing into a table

//Second part - hospital episode

local compl comp_any comp_uti comp_pe comp_pne comp_inf comp_rf comp_mi comp_kid comp_del

//Table 1b Hospital Episode:
mat tab_1b=J(17,2,.)
sum index_los , detail
mat tab_1b[1,1]=r(mean)
mat tab_1b[1,2]=r(p50)
mat list tab_1b

local j=2
foreach v in `compl' {
	tab `v' , missing  matcell(m_`v')
	sca s_`v'_n=r(N)
	mat m_`v'_p=m_`v'/s_`v'_n
	mat tab_1b[`j',1] = m_`v'[2,1]
	mat tab_1b[`j',2] = m_`v'_p[2,1]*100 //in percent
	local j=`j'+1
}

local disch dis_home dis_ltc dis_rehab dis_hs dis_oth dis_died

local j=11
foreach v in `disch' {
	tab `v' , missing  matcell(m_`v')
	sca s_`v'_n=r(N)
	mat m_`v'_p=m_`v'/s_`v'_n
	mat tab_1b[`j',1] = m_`v'[2,1]
	mat tab_1b[`j',2] = m_`v'_p[2,1]*100 //in percent
	local j=`j'+1
}
mat list tab_1b 

frmttable using `logpath'table1b_final , statmat(tab_1b) ///
	title("Table 1b - Hospital episode") ///
	ctitle("","n", "%") ///
	rtitle("LOS - mean, median" \ "Any complication"\"UTI" \ "PE" \ "Pneumonia" \ ///
	 "Surgical site infection" \ "Respiratory failure" \ "MI" \ "Acute kidney failure" \ /// 
	"Delirium" \"Home"\"Long term care facility"\"Rehab"\ ///
		"Hospice"\"Other or Unknown"\"Expired") ///
	sdec(1,0 \ 0 , 2) replace

*******************************************************
*******************************************************
//Table 1c - timeline by 1 year outcome
*******************************************************
*******************************************************
//get days from core to surgery for overall sample to send to Zara
sum days_surg_n1core , detail


//create matrix for output
mat tab_1c=J(21,4,.)
local timevars days_surg_n1core days_surg_p1core surg_to_death_dt days_surg_x

//N for each category of outcome at 1 year
tab outcome_1yr , missing matcell(samples)
mat list samples
sca sample_n4 = samples[4,1]
sca sample_n5 = samples[5,1]
sca sample_n1 = samples[1,1]
sca sample_n2 = (samples[2,1]+samples[3,1]) //died and either exit after 1 year or no exit
//sca sample_n3 = samples[3,1]

mat tab_1c[1,1] =  sample_n4
mat tab_1c[6,1] =  sample_n5
mat tab_1c[11,1] =  sample_n1
mat tab_1c[16,1] =  sample_n2

local j=2	
foreach v in `timevars' {
	sum `v' if outcome_1yr==4 , detail //alive and completed core w/i 1 year
	mat tab_1c[`j',1]=r(N)
	mat tab_1c[`j',2]=sample_n4 - r(N)
	mat tab_1c[`j',3]=r(p50) //median
	mat tab_1c[`j',4]=r(sd) //standard deviation
	local j=`j'+1
}
mat list tab_1c
local j=7	
foreach v in `timevars' {
	sum `v' if outcome_1yr==5 , detail //alive but no core w/i 1 year
	mat tab_1c[`j',1]=r(N)
	mat tab_1c[`j',2]=sample_n5 - r(N)
	mat tab_1c[`j',3]=r(p50) //median
	mat tab_1c[`j',4]=r(sd) //standard deviation
	local j=`j'+1
}
mat list tab_1c
local j=12	
foreach v in `timevars' {
	sum `v' if outcome_1yr==1 , detail //died, exit w/i 1 year
	mat tab_1c[`j',1]=r(N)
	mat tab_1c[`j',2]=sample_n1 - r(N)
	mat tab_1c[`j',3]=r(p50) //median
	mat tab_1c[`j',4]=r(sd) //standard deviation
	local j=`j'+1
}
mat list tab_1c
local j=17	
foreach v in `timevars' {
	sum `v' if (outcome_1yr==2 | outcome_1yr==3) , detail //died, exit after 1 year or no exit
	mat tab_1c[`j',1]=r(N)
	mat tab_1c[`j',2]=sample_n2 - r(N)
	mat tab_1c[`j',3]=r(p50) //median
	mat tab_1c[`j',4]=r(sd) //standard deviation
	local j=`j'+1
}
mat list tab_1c

local 1clabel "Days from Baseline interview to surgery" \ "Days from Surgery to next core interview" \ ///
	"Days from Surgery to death" \ "Days from Surgery to exit interview"

frmttable using `logpath'table1b_final , statmat(tab_1c) ///
	title("Table 1c - Interview/Procedure Timeline") ///
	ctitle("Status at 1 year post surgery","N","N - missing", "Median", "SD") ///
	rtitle("Alive & completed next core" \ "Days from Baseline interview to surgery" \ ///
	"Days from Surgery to next core interview" \ "Days from Surgery to death" \ ///
	"Days from Surgery to exit interview" \ ///
	"Alive, no next core" \ "Days from Baseline interview to surgery" \ ///
	"Days from Surgery to next core interview" \ "Days from Surgery to death" \ ///
	"Days from Surgery to exit interview" \ ///
	"Died, exit complete" \ "Days from Baseline interview to surgery" \ ///
	"Days from Surgery to next core interview" \ "Days from Surgery to death" \ ///
	"Days from Surgery to exit interview" \ ///
	"Died, no exit" \ "Days from Baseline interview to surgery" \ ///
	"Days from Surgery to next core interview" \ "Days from Surgery to death" \ ///
	"Days from Surgery to exit interview") ///
	sdec(0,0,1,1) addtable

*******************************************************
*******************************************************
//Table 2 - unadjusted mortality rates - 
//Have to manually input 100% mortality rates for
//those with discharge code = expired
//Categories for mortality - 0-30d, 0-180d, 0-365d

*******************************************************
*******************************************************

mat tab_2=J(36,10,.)
//first column = N
//then percent, n and p value for each of 30 day mort, 180 mort and 365 mort


//first column - n for each subgroup
//first row is overall sample
sum died_30d //overall sample
mat tab_2[1,1]=r(N)
sum died_30d if age_cat_2==1 //age 65-74
mat tab_2[2,1]=r(N)
sum died_30d if age_cat_2==2 //age 75-84
mat tab_2[3,1]=r(N)
sum died_30d if age_cat_2==3 //age 85+
mat tab_2[4,1]=r(N)
/*sum died_30d if age_cat==4 //age 85+ **Only 3 categories now, don't need this row
mat tab_2[5,1]=r(N)*/
sum died_30d if female==1 //female
mat tab_2[5,1]=r(N)
sum died_30d if female==0 //male
mat tab_2[6,1]=r(N)
sum died_30d if re_cat==1 //aa
mat tab_2[7,1]=r(N)
sum died_30d if re_cat==2 //hispanic
mat tab_2[8,1]=r(N)
sum died_30d if re_cat==3 //white
mat tab_2[9,1]=r(N)
sum died_30d if re_cat==4 //other
mat tab_2[10,1]=r(N)
sum died_30d if tics_cat_miss==1 //tics normal
mat tab_2[11,1]=r(N)
sum died_30d if tics_cat_miss==2 //tics mci
mat tab_2[12,1]=r(N)
sum died_30d if tics_cat_miss==3 //tics demented
mat tab_2[13,1]=r(N)
sum died_30d if tics_cat_miss==4 //tics missing
mat tab_2[14,1]=r(N)	
local k=15
	foreach w in `comorb' {  //comorbidities: cancer, chf, cad, dementia, esrd, dm
		sum died_30d if `w'==1
		mat tab_2[`k',1]=r(N)
		local k = `k' + 1  //populates rows 15 through 20
	}
sum died_30d if srh_fp_ncore==0  //srhs excel/vg/good
mat tab_2[21,1]=r(N)
sum died_30d if srh_fp_ncore==1 //srhs f/p
mat tab_2[22,1]=r(N)
sum died_30d if adl_cat_ps==0 //adl ind
mat tab_2[23,1]=r(N)
sum died_30d if adl_cat_ps==1 //adl partial dep
mat tab_2[24,1]=r(N)
sum died_30d if nhres_n1==1 //nh resident - yes
mat tab_2[25,1]=r(N)
sum died_30d if nhres_n1==0 //nh resident - no
mat tab_2[26,1]=r(N)
sum died_30d if admit_ind_6m_pre==1 //pre surg admit - yes
mat tab_2[27,1]=r(N)
sum died_30d if admit_ind_6m_pre==0 //pre surg admit - no
mat tab_2[28,1]=r(N)
	local k=29
	forvalues i=1/6 {					//discharge locations:
		sum died_30d if stay_dstn_cat==`i'	//home, ltc, rehab
			//hospice, other, expired
		mat tab_2[`k',1]=r(N)
		local k = `k'+1 //rows 29-34
	}
sum died_30d if comp_any==1 // any complication - yes
mat tab_2[35,1]=r(N)
sum died_30d if comp_any==0 // any complication - no
mat tab_2[36,1]=r(N)


//next columns (keeps p columns blank)
local j=2
foreach v in died_30d died_180d died_365d {
tab `v', matcell(`v'_`j') //overall sample
mat tab_2[1,`j']=`v'_`j'[2,1]/r(N)*100 //percent
mat tab_2[1,`j'+1]=`v'_`j'[2,1] //n
tab `v' if age_cat_2==1, matcell(`v'_`j') //age 65-74
mat tab_2[2,`j']=`v'_`j'[2,1]/r(N)*100 //percent
mat tab_2[2,`j'+1]=`v'_`j'[2,1] //n
tab `v' if age_cat_2==2, matcell(`v'_`j') //age 75-84
mat tab_2[3,`j']=`v'_`j'[2,1]/r(N)*100
mat tab_2[3,`j'+1]=`v'_`j'[2,1]
tab `v' if age_cat_2==3, matcell(`v'_`j') //age 85+
mat tab_2[4,`j']=`v'_`j'[2,1]/r(N)*100
mat tab_2[4,`j'+1]=`v'_`j'[2,1]
tab `v' if female==1, matcell(`v'_`j') //female
mat tab_2[5,`j']=`v'_`j'[2,1]/r(N)*100
mat tab_2[5,`j'+1]=`v'_`j'[2,1]
tab `v' if female==0, matcell(`v'_`j') //male
mat tab_2[6,`j']=`v'_`j'[2,1]/r(N)*100
mat tab_2[6,`j'+1]=`v'_`j'[2,1]
tab `v' if re_cat==1, matcell(`v'_`j') //aa
mat tab_2[7,`j']=`v'_`j'[2,1]/r(N)*100
mat tab_2[7,`j'+1]=`v'_`j'[2,1]
tab `v' if re_cat==2, matcell(`v'_`j') //hispanic
mat tab_2[8,`j']=`v'_`j'[2,1]/r(N)*100
mat tab_2[8,`j'+1]=`v'_`j'[2,1]
tab `v' if re_cat==3, matcell(`v'_`j') //white
mat tab_2[9,`j']=`v'_`j'[2,1]/r(N)*100
mat tab_2[9,`j'+1]=`v'_`j'[2,1]
tab `v' if re_cat==4, matcell(`v'_`j') //other
mat tab_2[10,`j']=`v'_`j'[2,1]/r(N)*100
mat tab_2[10,`j'+1]=`v'_`j'[2,1]
tab `v' if tics_cat_miss==1, matcell(`v'_`j') //tics normal
mat tab_2[11,`j']=`v'_`j'[2,1]/r(N)*100
mat tab_2[11,`j'+1]=`v'_`j'[2,1]
tab `v' if tics_cat_miss==2, matcell(`v'_`j') //tics mci
mat tab_2[12,`j']=`v'_`j'[2,1]/r(N)*100
mat tab_2[12,`j'+1]=`v'_`j'[2,1]
tab `v' if tics_cat_miss==3, matcell(`v'_`j') //tics demented
mat tab_2[13,`j']=`v'_`j'[2,1]/r(N)*100
mat tab_2[13,`j'+1]=`v'_`j'[2,1]
tab `v' if tics_cat_miss==4, matcell(`v'_`j') //tics missing
mat tab_2[14,`j']=`v'_`j'[2,1]/r(N)*100
mat tab_2[14,`j'+1]=`v'_`j'[2,1]	
local k=15
	foreach w in `comorb' {  //comorbidities: cancer, chf, cad, dementia, esrd, dm
		tab `v' if `w'==1, matcell(`v'_`j')
		mat tab_2[`k',`j']=`v'_`j'[2,1]/r(N)*100
		mat tab_2[`k',`j'+1]=`v'_`j'[2,1]
		local k = `k' + 1  //populates rows 15 through 20
	}
tab `v' if srh_fp_ncore==0 , matcell(`v'_`j') //srhs excel/vg/g
mat tab_2[21,`j']=`v'_`j'[2,1]/r(N)*100
mat tab_2[21,`j'+1]=`v'_`j'[2,1]
tab `v' if srh_fp_ncore==1, matcell(`v'_`j') //srhs f/p
mat tab_2[22,`j']=`v'_`j'[2,1]/r(N)*100
mat tab_2[22,`j'+1]=`v'_`j'[2,1]
tab `v' if adl_cat_ps==0, matcell(`v'_`j') //adl ind
mat tab_2[23,`j']=`v'_`j'[2,1]/r(N)*100
mat tab_2[23,`j'+1]=`v'_`j'[2,1]
tab `v' if adl_cat_ps==1 , matcell(`v'_`j') //adl partial, sev dep
mat tab_2[24,`j']=`v'_`j'[2,1]/r(N)*100
mat tab_2[24,`j'+1]=`v'_`j'[2,1]
tab `v' if nhres_n1==1, matcell(`v'_`j') //nh resident - yes
mat tab_2[25,`j']=`v'_`j'[2,1]/r(N)*100
mat tab_2[25,`j'+1]=`v'_`j'[2,1]
tab `v' if nhres_n1==0, matcell(`v'_`j') //nh resident - no
mat tab_2[26,`j']=`v'_`j'[2,1]/r(N)*100
mat tab_2[26,`j'+1]=`v'_`j'[2,1]
tab `v' if admit_ind_6m_pre==1, matcell(`v'_`j') //pre surg admit - yes
mat tab_2[27,`j']=`v'_`j'[2,1]/r(N)*100
mat tab_2[27,`j'+1]=`v'_`j'[2,1]
tab `v' if admit_ind_6m_pre==0, matcell(`v'_`j') //pre surg admit - no
mat tab_2[28,`j']=`v'_`j'[2,1]/r(N)*100
mat tab_2[28,`j'+1]=`v'_`j'[2,1]
	local k=29
	forvalues i=1/6 {					//discharge locations:
		tab `v' if stay_dstn_cat==`i', matcell(`v'_`j')	//home, ltc, rehab
		mat tab_2[`k',`j']=`v'_`j'[2,1]/r(N)*100			//hospice, other, expired
		mat tab_2[`k',`j'+1]=`v'_`j'[2,1]
		local k = `k'+1
	}
tab `v' if comp_any==1, matcell(`v'_`j') // any complication - yes
mat tab_2[35,`j']=`v'_`j'[2,1]/r(N)*100
mat tab_2[35,`j'+1]=`v'_`j'[2,1]
tab `v' if comp_any==0, matcell(`v'_`j') // any complication - no
mat tab_2[36,`j']=`v'_`j'[2,1]/r(N)*100
mat tab_2[36,`j'+1]=`v'_`j'[2,1]
local j = `j' + 3
}
mat list tab_2

//p value columns - using Fisher's exact test

local j=4
foreach v in died_30d died_180d died_365d {
tab age_cat_2 `v', exact  //age
mat tab_2[2,`j']=r(p_exact) //pvalue
tab female  `v', exact  //gender
mat tab_2[5,`j']=r(p_exact) 
tab re_cat  `v', exact  //race
mat tab_2[7,`j']=r(p_exact) 
tab tics_cat_miss  `v', exact  //tics
mat tab_2[11,`j']=r(p_exact) 
	local k=15
	foreach w in `comorb' {  //comorbidities: cancer, chf, cad, dementia, esrd, dm
		tab `w' `v', exact
		mat tab_2[`k',`j']=r(p_exact)
		local k = `k' + 1  //populates rows 15 through 20
	}
tab srh_fp_ncore `v', exact  //self reported health
mat tab_2[21,`j']=r(p_exact) 
tab adl_cat_ps `v', exact  //adl
mat tab_2[23,`j']=r(p_exact) 
tab nhres_n1  `v', exact  //nursing home res
mat tab_2[25,`j']=r(p_exact) 
tab admit_ind_6m_pre  `v', exact  //admit 6 mos
mat tab_2[27,`j']=r(p_exact) 
tab stay_dstn_cat  `v', exact  //discharge loc
mat tab_2[29,`j']=r(p_exact) 
tab comp_any  `v', exact  //any complication
mat tab_2[35,`j']=r(p_exact) 
local j = `j' + 3
}

frmttable using `logpath'table1b_final , statmat(tab_2) ///
	title("Table 2 - Unadjusted 30-, 180- and 365-Day Mortality") ///
	ctitle("","N all","0-30-Day %","n","p-val","0-180-Day %","n","p-val", "0-365-Day %","n","p-val") ///
	rtitle("Overall sample" \ "Age: 65-74" \ "75-84" \ "85+" \ ///
	"Female" \ "Male"\ "AA" \ "Hispanic" \ "White" \"Other" \ ///
	"TICS >8 Normal" \"5-8 MCI" \"<5 Demented"\ "TICS Unknown" \"Cancer" \"CHF" \ ///
	"CAD"\"Dementia"\"ESRD"\"Diabetes"\"Self reported health: Exc / VG / Good" \ ///
	"Fair/Poor" \ "Baseline ADL: Independent" \ "ADL: Any Dependence" \  ///
	"Nursing home resident - Yes" \ "No" \ "Hospital admit in prior 6 mos: Yes" \ "No" \ ///
	"Discharge location: Home" \ "Long term care" \ "Inpatient rehab" \"Hospice" \  ///
	"Other or Unknown" \ "Expired" \ "Any complication: Yes" \ "No") ///
	note("P-values are calculating using Fisher's exact test.") ///
	sdec(0,2,0,3,2,0,3,2,0,3) addtable

	
	
log close


H="Stata - tables, v2"
/*surgery project analysis

Created 7/23/2014 to run unadjusted means tables for the final sample
that was used for the survival analysis

Some variable changes from email discussions with Zara 7/14/14-7/22/14
1. Table 1a: Combined tics mci + demented
2. Table 1b: 
	2a. Added row for time from n1 core interview to index surgery
	2b. Split up ltc category into snf, etc
3. Table 2, Univariate analysis:
	3a. Included time from n1 core interview to index surgery in table 1
	3b. Combined tics mci + demented in Table 1
	3c. Split up ltc category into snf, etc in Table 2
	3d. Changed 1st column to be % instead of n and removed n columns for 
	    individual mortality categories to match Zara's tables 1,2 in the draft
4. Added new, short table comparing mean days from interview to surgery
	for the 3 mortality groups. Wasn't sure how to add it to Table 2 since
	its a continuous variable. Could split into categories??

More updates per emails on 7/28/14
1. Combine discharge categories so only expired,home,snf and other/unknown
2. Updated cells to missing where n<5

Have to manually add in variable labels to word document, varlabels
not working with categorical variables for some reason

Need to manually fill in NR (not reported) for fields where n<5

This version runs with the mortality outcome time windows of:
0-30 days
0-180 days
0-365 days*/

capture log close

clear all
set mem 800m
set matsize 800
set more off

local logpath E:\data\surgery\2012_update\logs\
local datapath E:\data\surgery\2012_update\final_2012clms\

log using `logpath'11_Surgery_code_finaltables_v2.txt, text replace

use `datapath'surgery_final_n12m_sample_clean_stset.dta if _st==1

stdes

//numlabel, add

tab died_0_30 died_31_180, missing
tab died_0_30 died_31_365, missing

stdes

tab _st, missing

***************************************************
***************************************************
// Table 1 - Cohort characteristics
***************************************************
***************************************************
//changed tics to 3 category (normal, mci+demented, missing)
//added variable for days from n1 core to index surgery
local comorb comorb_32_0_n12m el_cancer comorb_1_0_n12m el_diab comorb_13_0_n12m comorb_31_0_n12m 

//First part - Patient Factors
tabout age_cat_2 female re_cat tics_cat_miss2 `comorb' srh_fp_ncore adl_cat_ps nhres_n1 ///
	admit_ind_6m_pre using `logpath'table1a_final_v2.txt, ///
	c(freq col) oneway replace ///
	style(tab) /*ptotal(none)*/ format(0c 2p)
//Note: this uses tabout, paste tab delimited file from text file into
//an excel spreadsheet for easy importing into a table

//Second part - hospital episode

local compl comp_any comp_uti comp_pe comp_pne comp_inf comp_rf comp_mi comp_kid comp_del

//Table 1b Hospital Episode:
//added row for time of interview/surgery
//changed discharge codes to break out long term care into more categories
mat tab_1b=J(15,2,.)
sum index_los , detail
mat tab_1b[1,1]=r(mean)
mat tab_1b[1,2]=r(p50)

sum days_surg_n1core , detail
mat tab_1b[2,1]=r(mean)
mat tab_1b[2,2]=r(p50)
mat list tab_1b

local j=3
foreach v in `compl' {
	tab `v' , missing  matcell(m_`v')
	sca s_`v'_n=r(N)
	mat m_`v'_p=m_`v'/s_`v'_n
	mat tab_1b[`j',1] = m_`v'[2,1]
	mat tab_1b[`j',2] = m_`v'_p[2,1]*100 //in percent
	local j=`j'+1
}

local disch dis_died dis_home dis_snf dis_oth3

local j=12
foreach v in `disch' {
	tab `v' , missing  matcell(m_`v')
	sca s_`v'_n=r(N)
	mat m_`v'_p=m_`v'/s_`v'_n
	mat tab_1b[`j',1] = m_`v'[2,1]
	mat tab_1b[`j',2] = m_`v'_p[2,1]*100 //in percent
	local j=`j'+1
}
mat list tab_1b 

frmttable using `logpath'table1b_final_v2 , statmat(tab_1b) ///
	title("Table 1b - Hospital episode") ///
	ctitle("","n", "%") ///
	rtitle("LOS - mean, median" \ "Days core pre- to surgery - mean, median" ///
	\ "Any complication"\"UTI" \ "PE" \ "Pneumonia" \ ///
	 "Surgical site infection" \ "Respiratory failure" \ "MI" \ "Acute kidney failure" \ /// 
	"Delirium" \"Expired"\"Home"\"SNF"\"Other or Unknown") ///
	sdec(1,0 \ 0 , 2) replace

*******************************************************
*******************************************************
//Table 1c - timeline by 1 year outcome
*******************************************************
*******************************************************
//get days from core to surgery for overall sample to send to Zara
sum days_surg_n1core , detail

tab core_year_n1 surg_year , missing

gen n1_to_surg_yrs = floor(days_surg_n1core/365.25)
tab n1_to_surg_yrs, missing

//create matrix for output
mat tab_1c=J(21,4,.)
local timevars days_surg_n1core days_surg_p1core surg_to_death_dt days_surg_x

//N for each category of outcome at 1 year
tab outcome_1yr , missing matcell(samples)
mat list samples
sca sample_n4 = samples[4,1]
sca sample_n5 = samples[5,1]
sca sample_n1 = samples[1,1]
sca sample_n2 = (samples[2,1]+samples[3,1]) //died and either exit after 1 year or no exit
//sca sample_n3 = samples[3,1]

mat tab_1c[1,1] =  sample_n4
mat tab_1c[6,1] =  sample_n5
mat tab_1c[11,1] =  sample_n1
mat tab_1c[16,1] =  sample_n2

local j=2	
foreach v in `timevars' {
	sum `v' if outcome_1yr==4 , detail //alive and completed core w/i 1 year
	mat tab_1c[`j',1]=r(N)
	mat tab_1c[`j',2]=sample_n4 - r(N)
	mat tab_1c[`j',3]=r(p50) //median
	mat tab_1c[`j',4]=r(sd) //standard deviation
	local j=`j'+1
}
mat list tab_1c
local j=7	
foreach v in `timevars' {
	sum `v' if outcome_1yr==5 , detail //alive but no core w/i 1 year
	mat tab_1c[`j',1]=r(N)
	mat tab_1c[`j',2]=sample_n5 - r(N)
	mat tab_1c[`j',3]=r(p50) //median
	mat tab_1c[`j',4]=r(sd) //standard deviation
	local j=`j'+1
}
mat list tab_1c
local j=12	
foreach v in `timevars' {
	sum `v' if outcome_1yr==1 , detail //died, exit w/i 1 year
	mat tab_1c[`j',1]=r(N)
	mat tab_1c[`j',2]=sample_n1 - r(N)
	mat tab_1c[`j',3]=r(p50) //median
	mat tab_1c[`j',4]=r(sd) //standard deviation
	local j=`j'+1
}
mat list tab_1c
local j=17	
foreach v in `timevars' {
	sum `v' if (outcome_1yr==2 | outcome_1yr==3) , detail //died, exit after 1 year or no exit
	mat tab_1c[`j',1]=r(N)
	mat tab_1c[`j',2]=sample_n2 - r(N)
	mat tab_1c[`j',3]=r(p50) //median
	mat tab_1c[`j',4]=r(sd) //standard deviation
	local j=`j'+1
}
mat list tab_1c

local 1clabel "Days from Baseline interview to surgery" \ "Days from Surgery to next core interview" \ ///
	"Days from Surgery to death" \ "Days from Surgery to exit interview"

frmttable using `logpath'table1b_final_v2 , statmat(tab_1c) ///
	title("Table 1c - Interview/Procedure Timeline") ///
	ctitle("Status at 1 year post surgery","N","N - missing", "Median", "SD") ///
	rtitle("Alive & completed next core" \ "Days from Baseline interview to surgery" \ ///
	"Days from Surgery to next core interview" \ "Days from Surgery to death" \ ///
	"Days from Surgery to exit interview" \ ///
	"Alive, no next core" \ "Days from Baseline interview to surgery" \ ///
	"Days from Surgery to next core interview" \ "Days from Surgery to death" \ ///
	"Days from Surgery to exit interview" \ ///
	"Died, exit complete" \ "Days from Baseline interview to surgery" \ ///
	"Days from Surgery to next core interview" \ "Days from Surgery to death" \ ///
	"Days from Surgery to exit interview" \ ///
	"Died, no exit" \ "Days from Baseline interview to surgery" \ ///
	"Days from Surgery to next core interview" \ "Days from Surgery to death" \ ///
	"Days from Surgery to exit interview") ///
	sdec(0,0,1,1) addtable

*******************************************************
*******************************************************
//Table 2 - unadjusted mortality rates - 
//Have to manually input 100% mortality rates for
//those with discharge code = expired
//Categories for mortality - 0-30d, 0-180d, 0-365d

//Creates 2 tables -  Table 2= patient characteristics
//Table 3= Hospital episode characteristics
*******************************************************
*******************************************************
//creates two matrices
//1 has n's that are then used to calculate the %'s which are presented 
//in Tables 1 and 2 of the draft

//matrix for n's, patient char's
//first column = n for each category
//cols 2,4,6 are n's for each mortality group
//cols 3,5,7 are blank
mat n_tab2=J(27,7,.)

//matrix for percents, patient char's
//first column = percent
//then percent and p value for each of 30 day mort, 180 mort and 365 mort
mat tab_2=J(27,7,.)

//first column - n for each subgroup
//first row is overall sample
sum died_30d //overall sample
local oa_n=r(N)
mat n_tab2[1,1]=r(N)

local c = 2
foreach v in died_30d died_180d died_365d{
tab `v', matcell(n`c')
mat tab_2[1,`c']=n`c'[2,1]/`oa_n'*100
local c = `c' + 2
}

//now rest of first columns
local r = 2
forvalues i=1/3{
	sum died_30d if age_cat_2==`i' 
	mat n_tab2[`r',1]=r(N)
	mat tab_2[`r',1]=r(N)/`oa_n'*100
	local r = `r'+1
}

local r=5
foreach i in 1 0 {
	sum died_30d if female==`i'
	mat n_tab2[`r',1]=r(N)
	mat tab_2[`r',1]=r(N)/`oa_n'*100
	local r = `r'+1
}

local r=7
forvalues i=1/4{
	sum died_30d if re_cat==`i' //race,ethnicity categories
	mat n_tab2[`r',1]=r(N)
	mat tab_2[`r',1]=r(N)/`oa_n'*100
	local r = `r'+1
}

local k=11
	foreach w in `comorb' {  //comorbidities: cancer, chf, cad, dementia, esrd, dm
		sum died_30d if `w'==1
		mat n_tab2[`k',1]=r(N)
		mat tab_2[`k',1]=r(N)/`oa_n'*100
		local k = `k' + 1  //populates rows 11 through 16
	}
	
local r=17
foreach i in 1 0 {
	sum died_30d if admit_ind_6m_pre==`i' //pre surg admit
	mat n_tab2[`r',1]=r(N)
	mat tab_2[`r',1]=r(N)/`oa_n'*100
	sum died_30d if nhres_n1==`i' //nh resident
	mat n_tab2[`r'+2,1]=r(N)
	mat tab_2[`r'+2,1]=r(N)/`oa_n'*100
	local r = `r'+1
}

local r=21
foreach i in 0 1 {
	sum died_30d if adl_cat_ps==`i' //adl
	mat n_tab2[`r',1]=r(N)
	mat tab_2[`r',1]=r(N)/`oa_n'*100
	local r = `r'+1
}

local r=23
forvalues i=1/3{
	sum died_30d if tics_cat_miss2==`i' //tics normal
	mat n_tab2[`r',1]=r(N)
	mat tab_2[`r',1]=r(N)/`oa_n'*100
	local r = `r'+1
}

local r=26
foreach i in 0 1 {
	sum died_30d if srh_fp_ncore==`i'  //srhs
	mat n_tab2[`r',1]=r(N)
	mat tab_2[`r',1]=r(N)/`oa_n'*100
	local r = `r'+1
}

//next columns (keeps p columns blank)
//percents are percent of R's with that characteristic
local j=2
foreach v in died_30d died_180d died_365d {
	local r = 2
	forvalues i=1/3{
		tab `v' if age_cat_2==`i', matcell(`v'_`j') //age
		mat tab_2[`r',`j']=`v'_`j'[2,1]/r(N)*100 //percent
		mat n_tab2[`r',`j']=`v'_`j'[2,1] //n
		local r = `r'+1
	}
	
	local r = 5
	foreach i in 1 0{
		tab `v' if female==`i', matcell(`v'_`j') //female
		mat tab_2[`r',`j']=`v'_`j'[2,1]/r(N)*100
		mat n_tab2[`r',`j']=`v'_`j'[2,1]
		local r = `r'+1
	}

	local r = 7
	forvalues i=1/4{
		tab `v' if re_cat==`i', matcell(`v'_`j') //race,ethnicity
		mat tab_2[`r',`j']=`v'_`j'[2,1]/r(N)*100
		mat n_tab2[`r',`j']=`v'_`j'[2,1]
		local r = `r'+1
	}

	local k=11
	foreach w in `comorb' {  //comorbidities: cancer, chf, cad, dementia, esrd, dm
		tab `v' if `w'==1, matcell(`v'_`j')
		mat tab_2[`k',`j']=`v'_`j'[2,1]/r(N)*100
		mat n_tab2[`k',`j']=`v'_`j'[2,1]
		local k = `k' + 1  //populates rows 11 through 16
	}	
	
	local r = 17
	foreach i in 1 0{
		tab `v' if admit_ind_6m_pre==`i', matcell(`v'_`j') //pre surg admit
		mat tab_2[`r',`j']=`v'_`j'[2,1]/r(N)*100
		mat n_tab2[`r',`j']=`v'_`j'[2,1]	
		tab `v' if nhres_n1==`i', matcell(`v'_`j') //nh resident
		mat tab_2[`r'+2,`j']=`v'_`j'[2,1]/r(N)*100
		mat n_tab2[`r'+2,`j']=`v'_`j'[2,1]			
		local r = `r' + 1
	}

	local r = 21
	foreach i in 0 1{
		tab `v' if adl_cat_ps==`i', matcell(`v'_`j') //adl status
		mat tab_2[`r',`j']=`v'_`j'[2,1]/r(N)*100
		mat n_tab2[`r',`j']=`v'_`j'[2,1]	
		local r = `r' + 1
	}
	
	local r = 23
	forvalues i=1/3{
		tab `v' if tics_cat_miss2==`i', matcell(`v'_`j') //tics
		mat tab_2[`r',`j']=`v'_`j'[2,1]/r(N)*100
		mat n_tab2[`r',`j']=`v'_`j'[2,1]	
		local r = `r' + 1
	}
	
	local r = 26
	foreach i in 0 1{
		tab `v' if srh_fp_ncore==`i', matcell(`v'_`j') //srhs
		mat tab_2[`r',`j']=`v'_`j'[2,1]/r(N)*100
		mat n_tab2[`r',`j']=`v'_`j'[2,1]	
		local r = `r' + 1
	}
	
local j = `j' + 2
}

mat list tab_2

//p value columns - using Fisher's exact test

local j=3
foreach v in died_30d died_180d died_365d {
tab age_cat_2 `v', exact  //age
mat tab_2[2,`j']=r(p_exact) //pvalue
tab female  `v', exact  //gender
mat tab_2[5,`j']=r(p_exact) 
tab re_cat  `v', exact  //race
mat tab_2[7,`j']=r(p_exact) 
	local k=11
	foreach w in `comorb' {  //comorbidities: cancer, chf, cad, dementia, esrd, dm
		tab `w' `v', exact
		mat tab_2[`k',`j']=r(p_exact)
		local k = `k' + 1  //populates rows 11 through 16
	}
tab admit_ind_6m_pre  `v', exact  //admit 6 mos
mat tab_2[17,`j']=r(p_exact)	
tab nhres_n1  `v', exact  //nursing home res
mat tab_2[19,`j']=r(p_exact)
tab adl_cat_ps `v', exact  //adl
mat tab_2[21,`j']=r(p_exact) 
tab tics_cat_miss2  `v', exact  //tics
mat tab_2[23,`j']=r(p_exact)	
tab srh_fp_ncore `v', exact  //self reported health
mat tab_2[26,`j']=r(p_exact) 

local j = `j' + 2
}

mat list n_tab2
mat list tab_2

frmttable using `logpath'table1b_final_v2 , statmat(tab_2) ///
	title("Table 2 - Patient Characteristics and mortality over 1 year"\ ///
	"Univariate analysis")  ///
	ctitle("","%","0-30-Day %","p-val","0-180-Day %","p-val", "0-365-Day %","p-val") ///
	rtitle("Overall sample (N=`oa_n')" \ "Age: 65-74" \ "75-84" \ "85+" \ ///
	"Female" \ "Male"\ "African American" \ "Hispanic" \ "White" \"Other" \ ///
	"CAD"\"Cancer" \"CHF" \"Diabetes"\"Renal failure"\"Dementia"\ ///
	"Hospital admit in prior 6 mos: Yes" \ "No" \ "Nursing home resident - Yes" \ "No" \ ///
	"Baseline ADL: Independent" \ "ADL: Any Dependence" \ ///
	"TICS >8 Normal" \"0-8 MCI or Demented" \ "TICS Unknown" ///
	\"Self reported health: Exc / VG / Good" \ "Fair/Poor") ///
	note("P-values are calculating using Fisher's exact test." \ ///
	"NR=Not reported. HRS guidelines do not permit reporting categories with < 5 respondents.") ///
	sdec(1,1,3,1,3,1,3) addtable

**************************************************************
//Table 3: Hospital episode

//matrix for n's, hospital episode
mat n_tab3=J(6,7,.)

//matrix for %'s, hospital episode
mat tab_3=J(6,7,.)

//column 1
local r=1
foreach i in 1 0 {
	sum died_30d if comp_any==`i' // any complication 
	mat n_tab3[`r',1]=r(N)
	mat tab_3[`r',1]=r(N)/`oa_n'*100
	local r = `r'+1
	}
local r=3
	forvalues i=1/4 {					//discharge locations:
		sum died_30d if stay_dstn_cat3==`i'	//died, home, snf, other
			//hospice, other, expired
		mat n_tab3[`r',1]=r(N)
		mat tab_3[`r',1]=r(N)/`oa_n'*100
		local r = `r'+1 //rows 3-10
	}

//columns 2,4,6	
local j=2
foreach v in died_30d died_180d died_365d {	
	local r = 1
	foreach i in 1 0{	
		tab `v' if comp_any==`i', matcell(`v'_`j') // any complication - yes
		mat tab_3[`r',`j']=`v'_`j'[2,1]/r(N)*100
		mat n_tab3[`r',`j']=`v'_`j'[2,1]
		local r = `r'+1
		}	
local k=3
	forvalues i=1/4 {					//discharge locations:
		tab `v' if stay_dstn_cat3==`i', matcell(`v'_`j')	//died, home, snf, other
		mat tab_3[`k',`j']=`v'_`j'[2,1]/r(N)*100			
		mat n_tab3[`k',`j']=`v'_`j'[2,1]
		local k = `k'+1
	}
	
	local j = `j' + 2
}

//pvalues

local j=3
foreach v in died_30d died_180d died_365d {
	tab comp_any `v', exact  //any complication
	mat tab_3[1,`j']=r(p_exact) 
	tab dis_died `v', exact  //died
	mat tab_3[3,`j']=r(p_exact) 
	tab stay_dstn_cat3  `v' if inlist(stay_dstn_cat3,2,3,4), exact(4)  //discharge loc
	mat tab_3[4,`j']=r(p_exact) 
	local j = `j' + 2
}

mat list tab_3
mat list n_tab3


frmttable using `logpath'table1b_final_v2 , statmat(tab_3) ///
	title("Table 3 - Hospital episode and mortality over 1 year"\ ///
	"Univariate analysis")  ///
	ctitle("","%","0-30-Day %","p-val","0-180-Day %","p-val", "0-365-Day %","p-val") ///
	rtitle("Any complication: Yes" \ "No"\ "Expired during index hospital stay" \ ///
	"Discharge location: Home"\ "SNF" \"Other or Unknown" ) ///
	note("P-values are calculating using Fisher's exact test." / ///
	"NR=Not reported. HRS guidelines do not permit reporting categories with < 5 respondents.") ///
	sdec(1,1,3,1,3,1,3) addtable
	
**************************************************************
//tab of counts of surgeries for the sample
tab pro_cnt_all, missing
tab pro_cnt_date, missing 
tab pro_cnt_clm, missing

//about half of those with more than 1 qualifying claim had 6 month admission flag
tab pro_cnt_clm admit_ind_6m_pre, missing

**************************************************************	
log close


H="xxxxx"


H="Sensitivity analysis - run survival analysis excluding outliers"
/*Drop those observations that have the pre-surgery interview more than 3
years before the surgery (~6% of the sample is dropped) */

capture log close

clear all
set mem 500m
set matsize 800
set more off

local logpath E:\data\surgery\2012_update\logs
local datapath E:\data\surgery\2012_update\final_2012clms

log using "`logpath'\12_surgery_cloglog_excl_n1_time_outliers.txt", text replace

cd "`datapath'"

//Use sample from 12 month before surgery comorbidities
use surgery_final_n12m_sample_clean_stset.dta

gen n1_to_surg_yrs = floor(days_surg_n1core/365.25)
tab n1_to_surg_yrs, missing

drop if n1_to_surg_yrs>=3 & n1_to_surg_yrs!=.

stdes

save surgery_final_excl_outliers.dta, replace

tab _st, missing
tab procedure_date end_date if _st==0, missing

//get KM curve, by age group
sts graph, by(age_cat_2) /*tmax(400)*/ ///
	legend(label(1 "Age: 65-74") label(2 "75-84") label(3 "85 and older"))
	graph export `logpath'\KMCurve_excl_n1_ivw_time.png, replace

***********************************************************************************
***********************************************************************************
//Run complementary log log model, excluding complications
***********************************************************************************
***********************************************************************************
//base categories are age=65-74, srh=very good/excellent/good 
//adl = independent
local xvars_no_disch ib1.age_cat_2 i.comorb_32_0_n12m el_cancer i.comorb_1_0_n12m ///
	i.el_diab i.comorb_13_0_n12m i.comorb_31_0_n12m ///
	i.admit_ind_6m_pre i.adl_cat_ps i.srh_fp_ncore days_surg_n1core 


cloglog died_30d `xvars_no_disch' if _st==1, eform
estat ic
outreg, ///
 	stats(e_b e_ci) ctitles("","0-30-Day") ///
	title("Table 3: Effect of age on mortality - Complementary log log model, v3" \ ///
	"Excluding observations where n1 interview 3+years before surgery") ///
	note("Hazard ratios, 95% confidence intervals reported" \ ///
	"Base categories are Age: 65-74, Self-reported health: Excellent, very good or good," \ ///
	"and ADL: Independent.") ///
	varlabels store(table6) starlevels(10 5 1) bdec(2)
	
predict hr if _st==1, pr
somersd died_30d hr if _st==1, transf(c)
mat c=e(b)
mat cstat_1=J(1,3,.)
mat cstat_1[1,1]=c[1,1]	
drop hr
	
cloglog died_180d `xvars_no_disch' if _st==1, eform
estat ic
outreg, ///
 	stats(e_b e_ci) ctitles("","0-180-Day") ///
	varlabels merge(table6) starlevels(10 5 1) bdec(2)

predict hr if _st==1, pr
somersd died_180d hr if _st==1, transf(c)
mat c=e(b)
mat cstat_1[1,2]=c[1,1]	
drop hr	
	
cloglog died_365d `xvars_no_disch' if _st==1, eform
estat ic
outreg , ///
	stats(e_b e_ci) ctitles("","0-365-Day") ///
	varlabels merge(table6) starlevels(10 5 1) bdec(2) ///
	store(table6a) replace

predict hr if _st==1, pr
somersd died_365d hr if _st==1, transf(c)
mat c=e(b)
mat cstat_1[1,3]=c[1,1]	
drop hr	

frmttable, store(c) statmat(cstat_1) sdec(3) ///
rtitles("C-statistic")	

outreg using `logpath'\cloglog_excl_n1_ivw_time, ///
replay(table6a) append(c) replace
***********************************************************************************
***********************************************************************************
//Run complementary log log model, including complications
***********************************************************************************
***********************************************************************************

cloglog died_30d `xvars_no_disch' i.comp_any if _st==1, eform
estat ic
outreg, ///
 	stats(e_b e_ci) ctitles("","0-30-Day") ///
	title("Table 4: Effect of age on mortality - Complementary log log model" \ ///
	"Including complications during surgery as covariate" \ ///
	"Excluding observations where n1 interview 3+years before surgery") ///
	note("Hazard ratios, 95% confidence intervals reported" \ ///
	"Base categories are Age: 65-74, Self-reported health: Excellent, very good or good," \ ///
	"and ADL: Independent.") ///
	varlabels store(table6) starlevels(10 5 1) bdec(2)

predict hr if _st==1, pr
somersd died_30d hr if _st==1, transf(c)
mat c=e(b)
mat cstat_2=J(1,3,.)
mat cstat_2[1,1]=c[1,1]	
drop hr
	
cloglog died_180d `xvars_no_disch' i.comp_any if _st==1, eform
estat ic
outreg, ///
 	stats(e_b e_ci) ctitles("","0-180-Day") ///
	varlabels merge(table6) starlevels(10 5 1) bdec(2) 

predict hr if _st==1, pr
somersd died_180d hr if _st==1, transf(c)
mat c=e(b)
mat cstat_2[1,2]=c[1,1]	
drop hr	
	
cloglog died_365d `xvars_no_disch' i.comp_any if _st==1, eform
estat ic
outreg , ///
	stats(e_b e_ci) ctitles("","0-365-Day") ///
	varlabels merge(table6) starlevels(10 5 1) bdec(2) store(table6b)

predict hr if _st==1, pr
somersd died_365d hr if _st==1, transf(c)
mat c=e(b)
mat cstat_2[1,3]=c[1,1]	
drop hr	

frmttable, store(c) statmat(cstat_2) sdec(3) ///
rtitles("C-statistic")	

outreg using `logpath'\cloglog_excl_n1_ivw_time, ///
replay(table6b) append(c) addtable
********************************************************************************
log close


H="Sensitivity analysis - generate tables 1,2 excluding outliers"
/*surgery project analysis

Created 7/23/2014 to run unadjusted means tables for the final sample
that was used for the survival analysis

Some variable changes from email discussions with Zara 7/14/14-7/22/14
1. Table 1a: Combined tics mci + demented
2. Table 1b: 
	2a. Added row for time from n1 core interview to index surgery
	2b. Split up ltc category into snf, etc
3. Table 2, Univariate analysis:
	3a. Included time from n1 core interview to index surgery in table 1
	3b. Combined tics mci + demented in Table 1
	3c. Split up ltc category into snf, etc in Table 2
	3d. Changed 1st column to be % instead of n and removed n columns for 
	    individual mortality categories to match Zara's tables 1,2 in the draft
4. Added new, short table comparing mean days from interview to surgery
	for the 3 mortality groups. Wasn't sure how to add it to Table 2 since
	its a continuous variable. Could split into categories??

More updates per emails on 7/28/14
1. Combine discharge categories so only expired,home,snf and other/unknown
2. Updated cells to missing where n<5

Have to manually add in variable labels to word document, varlabels
not working with categorical variables for some reason

Need to manually fill in NR (not reported) for fields where n<5

This version runs with the mortality outcome time windows of:
0-30 days
0-180 days
0-365 days*/

capture log close

clear all
set mem 800m
set matsize 800
set more off

local logpath E:\data\surgery\2012_update\logs\
local datapath E:\data\surgery\2012_update\final_2012clms\

log using `logpath'13_Surgery_tables_excl_n1_time_outliers.txt, text replace

use `datapath'surgery_final_excl_outliers.dta if _st==1

stdes

//numlabel, add

tab died_0_30 died_31_180, missing
tab died_0_30 died_31_365, missing

stdes

tab _st, missing

***************************************************
***************************************************
// Table 1 - Cohort characteristics
***************************************************
***************************************************
local comorb comorb_32_0_n12m el_cancer comorb_1_0_n12m el_diab comorb_13_0_n12m comorb_31_0_n12m 

//First part - Patient Factors
tabout age_cat_2 female re_cat tics_cat_miss2 `comorb' srh_fp_ncore adl_cat_ps nhres_n1 ///
	admit_ind_6m_pre using `logpath'table1a_excl_n1_ivw_time.txt, ///
	c(freq col) oneway replace ///
	style(tab) /*ptotal(none)*/ format(0c 2p)
//Note: this uses tabout, paste tab delimited file from text file into
//an excel spreadsheet for easy importing into a table

//Second part - hospital episode

local compl comp_any comp_uti comp_pe comp_pne comp_inf comp_rf comp_mi comp_kid comp_del

//Table 1b Hospital Episode:
//added row for time of interview/surgery
//changed discharge codes to break out long term care into more categories
mat tab_1b=J(15,2,.)
sum index_los , detail
mat tab_1b[1,1]=r(mean)
mat tab_1b[1,2]=r(p50)

sum days_surg_n1core , detail
mat tab_1b[2,1]=r(mean)
mat tab_1b[2,2]=r(p50)
mat list tab_1b

local j=3
foreach v in `compl' {
	tab `v' , missing  matcell(m_`v')
	sca s_`v'_n=r(N)
	mat m_`v'_p=m_`v'/s_`v'_n
	mat tab_1b[`j',1] = m_`v'[2,1]
	mat tab_1b[`j',2] = m_`v'_p[2,1]*100 //in percent
	local j=`j'+1
}

local disch dis_died dis_home dis_snf dis_oth3

local j=12
foreach v in `disch' {
	tab `v' , missing  matcell(m_`v')
	sca s_`v'_n=r(N)
	mat m_`v'_p=m_`v'/s_`v'_n
	mat tab_1b[`j',1] = m_`v'[2,1]
	mat tab_1b[`j',2] = m_`v'_p[2,1]*100 //in percent
	local j=`j'+1
}
mat list tab_1b 

frmttable using `logpath'table1b_excl_n1_ivw_time , statmat(tab_1b) ///
	title("Table 1b - Hospital episode") ///
	ctitle("","n", "%") ///
	rtitle("LOS - mean, median" \ "Days core pre- to surgery - mean, median" ///
	\ "Any complication"\"UTI" \ "PE" \ "Pneumonia" \ ///
	 "Surgical site infection" \ "Respiratory failure" \ "MI" \ "Acute kidney failure" \ /// 
	"Delirium" \"Expired"\"Home"\"SNF"\"Other or Unknown") ///
	sdec(1,0 \ 0 , 2) replace

*******************************************************
*******************************************************
//Table 1c - timeline by 1 year outcome
*******************************************************
*******************************************************
//get days from core to surgery for overall sample to send to Zara
sum days_surg_n1core , detail
tab core_year_n1 surg_year , missing
tab n1_to_surg_yrs, missing

//create matrix for output
mat tab_1c=J(21,4,.)
local timevars days_surg_n1core days_surg_p1core surg_to_death_dt days_surg_x

//N for each category of outcome at 1 year
tab outcome_1yr , missing matcell(samples)  //only 4 categories in this sample, no obs=3
					    //died, no exit
mat list samples
sca sample_n4 = samples[3,1]
sca sample_n5 = samples[4,1]
sca sample_n1 = samples[1,1]
sca sample_n2 = samples[2,1]

mat tab_1c[1,1] =  sample_n4 //alive, completed core
mat tab_1c[6,1] =  sample_n5 //alive, core after 1 year or missing
mat tab_1c[11,1] =  sample_n1 //died, exit
mat tab_1c[16,1] =  sample_n2 //died, exit after 1 year

local j=2	
foreach v in `timevars' {
	sum `v' if outcome_1yr==4 , detail //alive and completed core w/i 1 year
	mat tab_1c[`j',1]=r(N)
	mat tab_1c[`j',2]=sample_n4 - r(N)
	mat tab_1c[`j',3]=r(p50) //median
	mat tab_1c[`j',4]=r(sd) //standard deviation
	local j=`j'+1
}
mat list tab_1c
local j=7	
foreach v in `timevars' {
	sum `v' if outcome_1yr==5 , detail //alive but no core w/i 1 year
	mat tab_1c[`j',1]=r(N)
	mat tab_1c[`j',2]=sample_n5 - r(N)
	mat tab_1c[`j',3]=r(p50) //median
	mat tab_1c[`j',4]=r(sd) //standard deviation
	local j=`j'+1
}
mat list tab_1c
local j=12	
foreach v in `timevars' {
	sum `v' if outcome_1yr==1 , detail //died, exit w/i 1 year
	mat tab_1c[`j',1]=r(N)
	mat tab_1c[`j',2]=sample_n1 - r(N)
	mat tab_1c[`j',3]=r(p50) //median
	mat tab_1c[`j',4]=r(sd) //standard deviation
	local j=`j'+1
}
mat list tab_1c
local j=17	
foreach v in `timevars' {
	sum `v' if outcome_1yr==2 , detail //died, exit after 1 year
	mat tab_1c[`j',1]=r(N)
	mat tab_1c[`j',2]=sample_n2 - r(N)
	mat tab_1c[`j',3]=r(p50) //median
	mat tab_1c[`j',4]=r(sd) //standard deviation
	local j=`j'+1
}
mat list tab_1c

local 1clabel "Days from Baseline interview to surgery" \ "Days from Surgery to next core interview" \ ///
	"Days from Surgery to death" \ "Days from Surgery to exit interview"

frmttable using `logpath'table1b_excl_n1_ivw_time , statmat(tab_1c) ///
	title("Table 1c - Interview/Procedure Timeline") ///
	ctitle("Status at 1 year post surgery","N","N - missing", "Median", "SD") ///
	rtitle("Alive & completed next core" \ "Days from Baseline interview to surgery" \ ///
	"Days from Surgery to next core interview" \ "Days from Surgery to death" \ ///
	"Days from Surgery to exit interview" \ ///
	"Alive, no next core" \ "Days from Baseline interview to surgery" \ ///
	"Days from Surgery to next core interview" \ "Days from Surgery to death" \ ///
	"Days from Surgery to exit interview" \ ///
	"Died, exit complete" \ "Days from Baseline interview to surgery" \ ///
	"Days from Surgery to next core interview" \ "Days from Surgery to death" \ ///
	"Days from Surgery to exit interview" \ ///
	"Died, no exit" \ "Days from Baseline interview to surgery" \ ///
	"Days from Surgery to next core interview" \ "Days from Surgery to death" \ ///
	"Days from Surgery to exit interview") ///
	sdec(0,0,1,1) addtable

*******************************************************
*******************************************************
//Table 2 - unadjusted mortality rates - 
//Have to manually input 100% mortality rates for
//those with discharge code = expired
//Categories for mortality - 0-30d, 0-180d, 0-365d

//Creates 2 tables -  Table 2= patient characteristics
//Table 3= Hospital episode characteristics
*******************************************************
*******************************************************
//creates two matrices
//1 has n's that are then used to calculate the %'s which are presented 
//in Tables 1 and 2 of the draft

//matrix for n's, patient char's
//first column = n for each category
//cols 2,4,6 are n's for each mortality group
//cols 3,5,7 are blank
mat n_tab2=J(27,7,.)

//matrix for percents, patient char's
//first column = percent
//then percent and p value for each of 30 day mort, 180 mort and 365 mort
mat tab_2=J(27,7,.)

//first column - n for each subgroup
//first row is overall sample
sum died_30d //overall sample
local oa_n=r(N)
mat n_tab2[1,1]=r(N)

local c = 2
foreach v in died_30d died_180d died_365d{
tab `v', matcell(n`c')
mat tab_2[1,`c']=n`c'[2,1]/`oa_n'*100
local c = `c' + 2
}

//now rest of first columns
local r = 2
forvalues i=1/3{
	sum died_30d if age_cat_2==`i' 
	mat n_tab2[`r',1]=r(N)
	mat tab_2[`r',1]=r(N)/`oa_n'*100
	local r = `r'+1
}

local r=5
foreach i in 1 0 {
	sum died_30d if female==`i'
	mat n_tab2[`r',1]=r(N)
	mat tab_2[`r',1]=r(N)/`oa_n'*100
	local r = `r'+1
}

local r=7
forvalues i=1/4{
	sum died_30d if re_cat==`i' //race,ethnicity categories
	mat n_tab2[`r',1]=r(N)
	mat tab_2[`r',1]=r(N)/`oa_n'*100
	local r = `r'+1
}

local k=11
	foreach w in `comorb' {  //comorbidities: cancer, chf, cad, dementia, esrd, dm
		sum died_30d if `w'==1
		mat n_tab2[`k',1]=r(N)
		mat tab_2[`k',1]=r(N)/`oa_n'*100
		local k = `k' + 1  //populates rows 11 through 16
	}
	
local r=17
foreach i in 1 0 {
	sum died_30d if admit_ind_6m_pre==`i' //pre surg admit
	mat n_tab2[`r',1]=r(N)
	mat tab_2[`r',1]=r(N)/`oa_n'*100
	sum died_30d if nhres_n1==`i' //nh resident
	mat n_tab2[`r'+2,1]=r(N)
	mat tab_2[`r'+2,1]=r(N)/`oa_n'*100
	local r = `r'+1
}

local r=21
foreach i in 0 1 {
	sum died_30d if adl_cat_ps==`i' //adl
	mat n_tab2[`r',1]=r(N)
	mat tab_2[`r',1]=r(N)/`oa_n'*100
	local r = `r'+1
}

local r=23
forvalues i=1/3{
	sum died_30d if tics_cat_miss2==`i' //tics normal
	mat n_tab2[`r',1]=r(N)
	mat tab_2[`r',1]=r(N)/`oa_n'*100
	local r = `r'+1
}

local r=26
foreach i in 0 1 {
	sum died_30d if srh_fp_ncore==`i'  //srhs
	mat n_tab2[`r',1]=r(N)
	mat tab_2[`r',1]=r(N)/`oa_n'*100
	local r = `r'+1
}

//next columns (keeps p columns blank)
//percents are percent of R's with that characteristic
local j=2
foreach v in died_30d died_180d died_365d {
	local r = 2
	forvalues i=1/3{
		tab `v' if age_cat_2==`i', matcell(`v'_`j') //age
		mat tab_2[`r',`j']=`v'_`j'[2,1]/r(N)*100 //percent
		mat n_tab2[`r',`j']=`v'_`j'[2,1] //n
		local r = `r'+1
	}
	
	local r = 5
	foreach i in 1 0{
		tab `v' if female==`i', matcell(`v'_`j') //female
		mat tab_2[`r',`j']=`v'_`j'[2,1]/r(N)*100
		mat n_tab2[`r',`j']=`v'_`j'[2,1]
		local r = `r'+1
	}

	local r = 7
	forvalues i=1/4{
		tab `v' if re_cat==`i', matcell(`v'_`j') //race,ethnicity
		mat tab_2[`r',`j']=`v'_`j'[2,1]/r(N)*100
		mat n_tab2[`r',`j']=`v'_`j'[2,1]
		local r = `r'+1
	}

	local k=11
	foreach w in `comorb' {  //comorbidities: cancer, chf, cad, dementia, esrd, dm
		tab `v' if `w'==1, matcell(`v'_`j')
		mat tab_2[`k',`j']=`v'_`j'[2,1]/r(N)*100
		mat n_tab2[`k',`j']=`v'_`j'[2,1]
		local k = `k' + 1  //populates rows 11 through 16
	}	
	
	local r = 17
	foreach i in 1 0{
		tab `v' if admit_ind_6m_pre==`i', matcell(`v'_`j') //pre surg admit
		mat tab_2[`r',`j']=`v'_`j'[2,1]/r(N)*100
		mat n_tab2[`r',`j']=`v'_`j'[2,1]	
		tab `v' if nhres_n1==`i', matcell(`v'_`j') //nh resident
		mat tab_2[`r'+2,`j']=`v'_`j'[2,1]/r(N)*100
		mat n_tab2[`r'+2,`j']=`v'_`j'[2,1]			
		local r = `r' + 1
	}

	local r = 21
	foreach i in 0 1{
		tab `v' if adl_cat_ps==`i', matcell(`v'_`j') //adl status
		mat tab_2[`r',`j']=`v'_`j'[2,1]/r(N)*100
		mat n_tab2[`r',`j']=`v'_`j'[2,1]	
		local r = `r' + 1
	}
	
	local r = 23
	forvalues i=1/3{
		tab `v' if tics_cat_miss2==`i', matcell(`v'_`j') //tics
		mat tab_2[`r',`j']=`v'_`j'[2,1]/r(N)*100
		mat n_tab2[`r',`j']=`v'_`j'[2,1]	
		local r = `r' + 1
	}
	
	local r = 26
	foreach i in 0 1{
		tab `v' if srh_fp_ncore==`i', matcell(`v'_`j') //srhs
		mat tab_2[`r',`j']=`v'_`j'[2,1]/r(N)*100
		mat n_tab2[`r',`j']=`v'_`j'[2,1]	
		local r = `r' + 1
	}
	
local j = `j' + 2
}

mat list tab_2

//p value columns - using Fisher's exact test

local j=3
foreach v in died_30d died_180d died_365d {
tab age_cat_2 `v', exact  //age
mat tab_2[2,`j']=r(p_exact) //pvalue
tab female  `v', exact  //gender
mat tab_2[5,`j']=r(p_exact) 
tab re_cat  `v', exact  //race
mat tab_2[7,`j']=r(p_exact) 
	local k=11
	foreach w in `comorb' {  //comorbidities: cancer, chf, cad, dementia, esrd, dm
		tab `w' `v', exact
		mat tab_2[`k',`j']=r(p_exact)
		local k = `k' + 1  //populates rows 11 through 16
	}
tab admit_ind_6m_pre  `v', exact  //admit 6 mos
mat tab_2[17,`j']=r(p_exact)	
tab nhres_n1  `v', exact  //nursing home res
mat tab_2[19,`j']=r(p_exact)
tab adl_cat_ps `v', exact  //adl
mat tab_2[21,`j']=r(p_exact) 
tab tics_cat_miss2  `v', exact  //tics
mat tab_2[23,`j']=r(p_exact)	
tab srh_fp_ncore `v', exact  //self reported health
mat tab_2[26,`j']=r(p_exact) 

local j = `j' + 2
}

mat list n_tab2
mat list tab_2

frmttable using `logpath'table1b_excl_n1_ivw_time , statmat(tab_2) ///
	title("Table 2 - Patient Characteristics and mortality over 1 year"\ ///
	"Univariate analysis")  ///
	ctitle("","%","0-30-Day %","p-val","0-180-Day %","p-val", "0-365-Day %","p-val") ///
	rtitle("Overall sample (N=`oa_n')" \ "Age: 65-74" \ "75-84" \ "85+" \ ///
	"Female" \ "Male"\ "African American" \ "Hispanic" \ "White" \"Other" \ ///
	"CAD"\"Cancer" \"CHF" \"Diabetes"\"Renal failure"\"Dementia"\ ///
	"Hospital admit in prior 6 mos: Yes" \ "No" \ "Nursing home resident - Yes" \ "No" \ ///
	"Baseline ADL: Independent" \ "ADL: Any Dependence" \ ///
	"TICS >8 Normal" \"0-8 MCI or Demented" \ "TICS Unknown" ///
	\"Self reported health: Exc / VG / Good" \ "Fair/Poor") ///
	note("P-values are calculating using Fisher's exact test." \ ///
	"NR=Not reported. HRS guidelines do not permit reporting categories with < 5 respondents.") ///
	sdec(1,1,3,1,3,1,3) addtable

**************************************************************
//Table 3: Hospital episode

//matrix for n's, hospital episode
mat n_tab3=J(6,7,.)

//matrix for %'s, hospital episode
mat tab_3=J(6,7,.)

//column 1
local r=1
foreach i in 1 0 {
	sum died_30d if comp_any==`i' // any complication 
	mat n_tab3[`r',1]=r(N)
	mat tab_3[`r',1]=r(N)/`oa_n'*100
	local r = `r'+1
	}
local r=3
	forvalues i=1/4 {					//discharge locations:
		sum died_30d if stay_dstn_cat3==`i'	//died, home, snf, other
			//hospice, other, expired
		mat n_tab3[`r',1]=r(N)
		mat tab_3[`r',1]=r(N)/`oa_n'*100
		local r = `r'+1 //rows 3-10
	}

//columns 2,4,6	
local j=2
foreach v in died_30d died_180d died_365d {	
	local r = 1
	foreach i in 1 0{	
		tab `v' if comp_any==`i', matcell(`v'_`j') // any complication - yes
		mat tab_3[`r',`j']=`v'_`j'[2,1]/r(N)*100
		mat n_tab3[`r',`j']=`v'_`j'[2,1]
		local r = `r'+1
		}	
local k=3
	forvalues i=1/4 {					//discharge locations:
		tab `v' if stay_dstn_cat3==`i', matcell(`v'_`j')	//died, home, snf, other
		mat tab_3[`k',`j']=`v'_`j'[2,1]/r(N)*100			
		mat n_tab3[`k',`j']=`v'_`j'[2,1]
		local k = `k'+1
	}
	
	local j = `j' + 2
}

//pvalues

local j=3
foreach v in died_30d died_180d died_365d {
	tab comp_any `v', exact  //any complication
	mat tab_3[1,`j']=r(p_exact) 
	tab dis_died `v', exact  //died
	mat tab_3[3,`j']=r(p_exact) 
	tab stay_dstn_cat3  `v' if inlist(stay_dstn_cat3,2,3,4), exact(4)  //discharge loc
	mat tab_3[4,`j']=r(p_exact) 
	local j = `j' + 2
}

mat list tab_3
mat list n_tab3


frmttable using `logpath'table1b_excl_n1_ivw_time , statmat(tab_3) ///
	title("Table 3 - Hospital episode and mortality over 1 year"\ ///
	"Univariate analysis")  ///
	ctitle("","%","0-30-Day %","p-val","0-180-Day %","p-val", "0-365-Day %","p-val") ///
	rtitle("Any complication: Yes" \ "No"\ "Expired during index hospital stay" \ ///
	"Discharge location: Home"\ "SNF" \"Other or Unknown" ) ///
	note("P-values are calculating using Fisher's exact test." / ///
	"NR=Not reported. HRS guidelines do not permit reporting categories with < 5 respondents.") ///
	sdec(1,1,3,1,3,1,3) addtable
	
**************************************************************
//tab of counts of surgeries for the sample
tab pro_cnt_all, missing
tab pro_cnt_date, missing 
tab pro_cnt_clm, missing

//about half of those with more than 1 qualifying claim had 6 month admission flag
tab pro_cnt_clm admit_ind_6m_pre, missing

//look at R's with no follow up interview
tab outcome_12m_v2, missing
tab post_surg_ivw, missing

**************************************************************	
log close


H="xxxxxxxxx"


H="Nov 2014 Addressing JAMA comments"
capture log close

clear all
set mem 800m
set matsize 800
set more off

local logpath E:\data\surgery\2012_update\logs\
local datapath E:\data\surgery\2012_update\final_2012clms\

log using `logpath'14_JAMA_comments.txt, text replace

use `datapath'surgery_final_excl_outliers.dta if _st==1

stdes
**************************************************************
//variable list in models, age=categorical, days core to surgery=cont.
//all others are binary indicators
local xvars age_cat_2 comorb_32_0_n12m el_cancer comorb_1_0_n12m ///
	el_diab comorb_13_0_n12m comorb_31_0_n12m ///
	admit_ind_6m_pre adl_cat_ps srh_fp_ncore days_surg_n1core ///
	comp_any

foreach v in `xvars'{
tab `v',missing
}

pwcorr `xvars', sig

//pairs of correlated variables are
//chf-cad , diabetes-chf , renal failure-chf, dementia-age, hospital admit-chf
//adl impaired and chf, diabetes, renal failure, hospital admit
//srh and chf, adl impaired

//chf and cad, diabetes, renal failure, hospital admission, adl impair, srh

**************************************************************
//try running cloglog regression, excluding some correlated variables
//to see if the results change

//original regression
local xvars ib1.age_cat_2 i.comorb_32_0_n12m i.el_cancer i.comorb_1_0_n12m ///
	i.el_diab i.comorb_13_0_n12m i.comorb_31_0_n12m ///
	i.admit_ind_6m_pre i.adl_cat_ps i.srh_fp_ncore days_surg_n1core i.comp_any

cloglog died_30d `xvars' if _st==1, eform
outreg, varlabels store(1) landscape stats(e_b e_ci) ///
title("cloglog, check for collinearity, mortality at 30 days") ///
ctitles("","all covariates") sdec(2)

cloglog died_180d `xvars' if _st==1, eform
outreg, varlabels store(2) landscape stats(e_b e_ci) ///
title("cloglog, check for collinearity, mortality at 180 days") ///
ctitles("","all covariates") sdec(2)
	
cloglog died_365d `xvars' if _st==1, eform
outreg, varlabels store(3) landscape stats(e_b e_ci) ///
title("cloglog, check for collinearity, mortality at 1 year") ///
ctitles("","all covariates") sdec(2)

**************************************************************
//exclude chf
local xvars1 ib1.age_cat_2 i.comorb_32_0_n12m i.el_cancer /*i.comorb_1_0_n12m*/ ///
	i.el_diab i.comorb_13_0_n12m i.comorb_31_0_n12m ///
	i.admit_ind_6m_pre i.adl_cat_ps i.srh_fp_ncore days_surg_n1core  i.comp_any
	
cloglog died_30d `xvars1' if _st==1, eform
outreg, varlabels merge(1) landscape stats(e_b e_ci) ///
ctitles("","excl CHF")  sdec(2)

cloglog died_180d `xvars1' if _st==1, eform
outreg, varlabels merge(2) landscape stats(e_b e_ci) ///
ctitles("","excl CHF")  sdec(2)	
	
cloglog died_365d `xvars1' if _st==1, eform
outreg, varlabels merge(3) landscape stats(e_b e_ci) ///
ctitles("","excl CHF")  sdec(2)

//exclude cad
local xvars1 ib1.age_cat_2 /*i.comorb_32_0_n12m*/ i.el_cancer i.comorb_1_0_n12m ///
	i.el_diab i.comorb_13_0_n12m i.comorb_31_0_n12m ///
	i.admit_ind_6m_pre i.adl_cat_ps i.srh_fp_ncore days_surg_n1core  i.comp_any
	
cloglog died_30d `xvars1' if _st==1, eform
outreg, varlabels merge(1) landscape stats(e_b e_ci) ///
ctitles("","excl CAD")  sdec(2)

cloglog died_180d `xvars1' if _st==1, eform
outreg, varlabels merge(2) landscape stats(e_b e_ci) ///
ctitles("","excl CAD")  sdec(2)	
	
cloglog died_365d `xvars1' if _st==1, eform
outreg, varlabels merge(3) landscape stats(e_b e_ci) ///
ctitles("","excl CAD")  sdec(2)

//exclude diabetes
local xvars1 ib1.age_cat_2 i.comorb_32_0_n12m i.el_cancer i.comorb_1_0_n12m ///
	/*i.el_diab*/ i.comorb_13_0_n12m i.comorb_31_0_n12m ///
	i.admit_ind_6m_pre i.adl_cat_ps i.srh_fp_ncore days_surg_n1core  i.comp_any
	
cloglog died_30d `xvars1' if _st==1, eform
outreg, varlabels merge(1) landscape stats(e_b e_ci) ///
ctitles("","excl diabetes")  sdec(2)

cloglog died_180d `xvars1' if _st==1, eform
outreg, varlabels merge(2) landscape stats(e_b e_ci) ///
ctitles("","excl diabetes")  sdec(2)	
	
cloglog died_365d `xvars1' if _st==1, eform
outreg, varlabels merge(3) landscape stats(e_b e_ci) ///
ctitles("","excl diabetes")  sdec(2)

//exclude renal failure
local xvars1 ib1.age_cat_2 i.comorb_32_0_n12m i.el_cancer i.comorb_1_0_n12m ///
	i.el_diab /*i.comorb_13_0_n12m*/ i.comorb_31_0_n12m ///
	i.admit_ind_6m_pre i.adl_cat_ps i.srh_fp_ncore days_surg_n1core  i.comp_any
	
cloglog died_30d `xvars1' if _st==1, eform
outreg, varlabels merge(1) landscape stats(e_b e_ci) ///
ctitles("","excl renal failure")  sdec(2)

cloglog died_180d `xvars1' if _st==1, eform
outreg, varlabels merge(2) landscape stats(e_b e_ci) ///
ctitles("","excl renal failure")  sdec(2)	
	
cloglog died_365d `xvars1' if _st==1, eform
outreg, varlabels merge(3) landscape stats(e_b e_ci) ///
ctitles("","excl renal failure")  sdec(2)

//exclude hospital admission
local xvars1 ib1.age_cat_2 i.comorb_32_0_n12m i.el_cancer i.comorb_1_0_n12m ///
	i.el_diab i.comorb_13_0_n12m i.comorb_31_0_n12m ///
	/*i.admit_ind_6m_pre*/ i.adl_cat_ps i.srh_fp_ncore days_surg_n1core  i.comp_any
	
cloglog died_30d `xvars1' if _st==1, eform
outreg, varlabels merge(1) landscape stats(e_b e_ci) ///
ctitles("","excl hospital adm")  sdec(2)

cloglog died_180d `xvars1' if _st==1, eform
outreg, varlabels merge(2) landscape stats(e_b e_ci) ///
ctitles("","excl hospital adm")  sdec(2)
	
cloglog died_365d `xvars1' if _st==1, eform
outreg, varlabels merge(3) landscape stats(e_b e_ci) ///
ctitles("","excl hospital adm")  sdec(2)

//exclude SRH
local xvars1 ib1.age_cat_2 i.comorb_32_0_n12m i.el_cancer i.comorb_1_0_n12m ///
	i.el_diab i.comorb_13_0_n12m i.comorb_31_0_n12m ///
	i.admit_ind_6m_pre i.adl_cat_ps /*i.srh_fp_ncore*/ days_surg_n1core  i.comp_any
	
cloglog died_30d `xvars1' if _st==1, eform
outreg , ///
varlabels merge(1) landscape stats(e_b e_ci) ///
ctitles("","excl SRH")  sdec(2)

cloglog died_180d `xvars1' if _st==1, eform
outreg , ///
varlabels merge(2) landscape stats(e_b e_ci) ///
ctitles("","excl SRH")  sdec(2)
	
cloglog died_365d `xvars1' if _st==1, eform
outreg , ///
varlabels merge(3) landscape stats(e_b e_ci) ///
ctitles("","excl SRH")  sdec(2)

************************************************************************
//exclude adl impairment
local xvars2 ib1.age_cat_2 i.comorb_32_0_n12m i.el_cancer i.comorb_1_0_n12m ///
	i.el_diab i.comorb_13_0_n12m i.comorb_31_0_n12m ///
	i.admit_ind_6m_pre /*i.adl_cat_ps*/ i.srh_fp_ncore days_surg_n1core  i.comp_any

cloglog died_30d `xvars2' if _st==1, eform
outreg using `logpath'14_correlation_check, replace ///
varlabels merge(1) landscape stats(e_b e_ci) ///
ctitles("","excl ADL impair")  sdec(2)

cloglog died_180d `xvars2' if _st==1, eform
outreg using `logpath'14_correlation_check, addtable ///
varlabels merge(2) landscape stats(e_b e_ci) ///
ctitles("","excl ADL impair")  sdec(2)	
	
cloglog died_365d `xvars2' if _st==1, eform
outreg using `logpath'14_correlation_check, addtable ///
varlabels merge(3) landscape stats(e_b e_ci) ///
ctitles("","excl ADL impair")  sdec(2)



**************************************************************
log close


H="xxxxxxxxxx"
/*create a correlation table of the covariates used in the model*/



H="Get HRS sample description"
/*This uses the Serious illness cohort dataset since that dataset
is maintained as a complete datatset, without limiting to observations
with surgeries

See the code in file serious_illness\Serious_illness_cohort_2014.txt
to see how the dataset is derived

Dataset saved as E:\data\serious_ill\int_data\core_ids_1yr_criteria_5.dta
in step 6 of that code*/

/*Stata do file to look at sample selection and serious illness cohort criteria*/

capture log close

clear all
set mem 800m
set more off

local logpath E:\data\surgery\2012_update\logs
local datapath E:\data\serious_ill\int_data
local datapath2 E:\data\surgery\2012_update\final_2012clms

log using "`logpath'\surgery_full_hrs_sample.txt", text replace

cd `datapath'

//surgery dataset, just keep variables I want to check against the overall
//hrs interview list
use `datapath2'\surgery_final_n12m_v2.dta

keep bid_hrs_21 type_adm procedure_date surgery_meet part_ab_6m hmo_d_6m ///
	age_at_surg_lt65 ind_n1core days_surg_n1core core_year_n1 em_urgent_admit

rename bid_hrs_21 bid_hrs
rename part_ab_6m surg_part_ab_6m
rename hmo_d_6m surg_hmo_d_6m
rename ind_n1core surg_ind_n1core
rename core_year_n1 surg_core_year_n1

save `datapath2'\surgery_final_n12m_v_to_merge.dta, replace

//idea, when do merge, match on n1 interview date, so those without n1 ivw
//will not have surgery information pull in (it would change to a 1:1 merge) 

***************************************************
use core_ids_1yr_criteria_5.dta

merge m:1 bid_hrs using `datapath2'\surgery_final_n12m_v_to_merge.dta
tab _merge
tab surg_ind_n1core if _merge==2, missing
//20 obs in surgery dataset didn't have n1 core so don't match up with
//an interview from the sic dataset

//look at which interviews have a surgery within the 3 years
gen ivw_to_surg = c_ivw_date - procedure_date
gen ivw_wi_3yrs_surg = 1 if 0<ivw_to_surg & ivw_to_surg<3*365.25
replace ivw_wi_3yrs_surg = 0 if ivw_to_surg>=3*365.25 | ivw_to_surg==. | 0>=ivw_to_surg
tab ivw_wi_3yrs_surg, missing
sum ivw_to_surg if ivw_wi_3yrs_surg==1 
sum ivw_to_surg if ivw_wi_3yrs_surg==0

*******************************************************************
//variable for age >=65.5 at interview

*******************************************************************
//Table of HRS sample
mat sample_set=J(5,1,.)

tab core_year, missing
sum core_year
mat sample_set[1,1]=r(N)

sum core_year if inlist(core_year,2000,2002,2004,2006,2008,2010)
mat sample_set[2,1]=r(N)

sum core_year if inlist(core_year,2000,2002,2004,2006,2008,2010) & age_ge_65==1
mat sample_set[3,1]=r(N)

sum core_year if inlist(core_year,2000,2002,2004,2006,2008,2010) & age_ge_65==1 & xwalk_yes==1
mat sample_set[4,1]=r(N)

//6 month ffs pre interview
sum core_year if inlist(core_year,2000,2002,2004,2006,2008,2010) & age_ge_65==1 & xwalk_yes==1 & ///
part_ab_6m==1 & hmo_d_6m==0
mat sample_set[5,1]=r(N)

mat rownames sample_set="Core interviews 1998-2010" "Core Interviews 2000-2010" "Age 65+" ///
"With xwalk id" "With FFS MC 6m pre-ivw"

mat colnames sample_set="Interviews"

mat list sample_set

frmttable using `logpath'\surgery_HRS_sample, statmat(sample_set) ///
title("HRS Sample, sample criteria") ///
ctitle("","N Interviews") ///
sdec(0) replace

*******************************************************************
//drop if core_year==1998

tab core_year _merge, missing

//unique R's 1998-2010
preserve

sort id core_year

by id: gen n1=_n
by id: gen n2=_N

keep if n1==n2
tab n1, missing matcell(cnt)

mat sample_r=J(8,1,.)
mat sample_r[1,1]=r(N)
restore
tab xwalk_yes, missing

//unique R's with xwalk id
drop if xwalk_yes==0 //keep if xwalk link = . or 1, keeps surgeries that didn't have n1 ivw
preserve

sort id core_year

by id: gen n1=_n
by id: gen n2=_N

keep if n1==n2
tab n1, missing matcell(cnt)

mat sample_r[2,1]=r(N)
restore

tab surgery_meet, missing

//with surgery 
drop if surgery_meet!=1
preserve

sort id core_year

by id: gen n1=_n
by id: gen n2=_N

keep if n1==n2
tab n1, missing matcell(cnt)

mat sample_r[3,1]=r(N)
restore

//65+ at surgery
drop if age_at_surg_lt65==1
preserve

sort id core_year

by id: gen n1=_n
by id: gen n2=_N

keep if n1==n2
tab n1, missing matcell(cnt)

mat sample_r[4,1]=r(N)
restore

//with ffs medicare 6 m prior to surgery
drop if surg_part_ab_6m!=1 | surg_hmo_d_6m!=0
preserve

sort id core_year

by id: gen n1=_n
by id: gen n2=_N

keep if n1==n2
tab n1, missing matcell(cnt)

mat sample_r[5,1]=r(N)
restore

tab surg_ind_n1core, missing

//with core n1 interview
drop if surg_ind_n1core!=1
preserve

keep if surg_core_year_n1==core_year //just keep n1 core interviews from ivw dataset

sort id
by id: gen n1=_n
tab n1, missing matcell(cnt)

mat sample_r[6,1]=r(N)
restore

//with urgent / emergent surgery
destring type_adm, gen(type_adm_2)
tab type_adm_2, missing

drop if em_urgent_admit!=1 //urgent or emergent admission
preserve

keep if surg_core_year_n1==core_year //just keep n1 core interviews from ivw dataset

sort id
by id: gen n1=_n
tab n1, missing matcell(cnt)

mat sample_r[7,1]=r(N)
restore

//with surgery within 3 years of an interview
drop if days_surg_n1core>3*365.25 
preserve

sort id core_year

keep if surg_core_year_n1==core_year //just keep n1 core interviews from ivw dataset
by id: gen n1=_n
tab n1, missing matcell(cnt)

mat sample_r[8,1]=r(N)
restore

tab surg_ind_n1core, missing
sum days_surg_n1core, detail
tab core_year, missing
tab surg_part_ab_6m, missing
tab surg_hmo_d_6m, missing
tab age_at_surg_lt65, missing
tab type_adm_2, missing

mat rownames sample_r="Core Interviews 1998-2010"  ///
"With xwalk id"  "Abdominal Surgery"  ///
"Age 65+ at surgery" "With FFS MC 6m pre-surg" "With n1 core ivw" ///
"Urgent/Emergent Surgery" "Surgery wi 3 years of core ivw"

mat list sample_r

frmttable using `logpath'\surgery_HRS_sample, statmat(sample_r) ///
title("HRS Sample, sample criteria") ///
ctitle("","N Unique R's with Core Interview") ///
sdec(0) addtable
*******************************************************************
log close


H="get index date"
/*
need to use stata 13

*/

capture log close

clear all
set mem 500m
set matsize 800
set more off

local logpath E:\data\surgery\2012_update\logs\
local datapath E:\data\surgery\2012_update\final_2012clms\

use `datapath'surgery_final_n12m_sample_clean_stset.dta 
keep id bid_hrs_21 procedure_date death_date
rename procedure_date index_date
saveold `datapath'index, replace

/*sas*/
/*hrs cleaned & restricted*/
libname hrs_cln 'E:\data\hrs_cleaned'; /*(contains exit, restricted, and core ivw's)*/
libname rand 'E:\data\hrs_public_2012\rand2012\main';

/*dartmouth wage index*/
libname dartm 'E:\data\Dartmouth_misc';
libname dart_wi 'E:\data\Dartmouth_misc\Wage Index';

/*project*/
libname proj_int 'E:\data\surgery\2012_update\int_data'; 
proc import datafile="E:\data\surgery\2012_update\final_2012clms\index.dta" out=proj_int.index replace; run;




H="charlson comorbidities"
/*Add indicator variables for the Charlson comorbidities
and Charlson weighted and unweighted index */

/*Charlson code

This program reads through the diagnosis codes of patient abstract records in a hospital
    file and identifies whether the record belongs to one (or more) of 17 different Charlson
    Comorbidity Index (CCI) groups.  The groups are identified by using the Enhanced ICD-9-CM
    diagnosis codes listed in Quan et al., "Coding Algorithms for Defining Comorbidities
    in ICD-9-CM and ICD-10 Administrative Data", Medical Care:43(11), Nov. 2005 p1130-1139.*/

%macro charlson(range1=,range2=);

data dx_charlson;
set sur_int.dx_&range1._&range2(rename=(diag=dx_0));
dx=trim(left(dx_0));

if dx~="" then do;

*initialize variables;
   charlson_1=0;
   charlson_2=0;
   charlson_3=0;
   charlson_4=0;
   charlson_5=0;
   charlson_6=0;
      charlson_7=0;
	     charlson_8=0;
		    charlson_9=0;
			   charlson_10=0;
			      charlson_11=0;
				     charlson_12=0;
					    charlson_13=0;
						   charlson_14=0;
						      charlson_15=0;
							     charlson_16=0;
								    charlson_17=0;

*do over dx;
   *Myocardial Infarction;
   if(substr(dx,1,3)='410' or
               substr(dx,1,3)='412')
               and charlson_1=0
               then charlson_1=1;
   *Congestive heart failure;
   if(substr(dx,1,5)='39891' or
               substr(dx,1,5)='40201' or
               substr(dx,1,5)='40211' or
               substr(dx,1,5)='40291' or
               substr(dx,1,5)='40401' or
               substr(dx,1,5)='40403' or
               substr(dx,1,5)='40411' or
               substr(dx,1,5)='40413' or
               substr(dx,1,5)='40491' or
               substr(dx,1,5)='40493' or
               substr(dx,1,4)='4254' or
               substr(dx,1,4)='4255' or
               substr(dx,1,4)='4256' or
               substr(dx,1,4)='4257' or
               substr(dx,1,4)='4258' or
               substr(dx,1,4)='4259' or
               substr(dx,1,3)='428')
               and charlson_2=0
               then charlson_2=1;
   *Periphral Vascular Disease;
    if(substr(dx,1,4)='0930' or
               substr(dx,1,4)='4373' or
               substr(dx,1,3)='440' or
               substr(dx,1,3)='441' or
               substr(dx,1,4)='4431' or
               substr(dx,1,4)='4432' or
               substr(dx,1,4)='4438' or
               substr(dx,1,4)='4439' or
               substr(dx,1,4)='4471' or
               substr(dx,1,4)='5571' or
               substr(dx,1,4)='5579' or
               substr(dx,1,4)='V434')
               and charlson_3=0
               then charlson_3=1;
    *Cerebrovascular Disease ;
        if(substr(dx,1,5)='36234' or
               substr(dx,1,3)='430' or
               substr(dx,1,3)='431' or
               substr(dx,1,3)='432' or
               substr(dx,1,3)='433' or
               substr(dx,1,3)='434' or
               substr(dx,1,3)='435' or
               substr(dx,1,3)='436' or
               substr(dx,1,3)='437' or
               substr(dx,1,3)='438')
               and charlson_4=0
               then charlson_4=1;
    *Dementia ;
       if(substr(dx,1,3)='290' or
               substr(dx,1,4)='2941' or
               substr(dx,1,4)='3312')
               and charlson_5=0
               then charlson_5=1;
   *Chronic Pulmonary Disease ;
        if(substr(dx,1,5)='4168' or
               substr(dx,1,4)='4169' or
               substr(dx,1,3)='490' or
               substr(dx,1,3)='491' or
               substr(dx,1,3)='492' or
               substr(dx,1,3)='493' or
               substr(dx,1,3)='494' or
               substr(dx,1,3)='495' or
               substr(dx,1,3)='496' or
               substr(dx,1,3)='500' or
               substr(dx,1,3)='501' or
               substr(dx,1,3)='502' or
               substr(dx,1,3)='503' or
               substr(dx,1,3)='504' or
               substr(dx,1,3)='505' or
               substr(dx,1,4)='5064' or
               substr(dx,1,4)='5081' or
               substr(dx,1,4)='5088')
               and charlson_6=0
               then charlson_6=1;
*Connective Tissue Disease-Rheumatic Disease;
         if(substr(dx,1,4)='4465' or
               substr(dx,1,4)='7100' or
               substr(dx,1,4)='7101' or
               substr(dx,1,4)='7102' or
               substr(dx,1,4)='7103' or
               substr(dx,1,4)='7104' or
               substr(dx,1,4)='7140' or
               substr(dx,1,4)='7141' or
               substr(dx,1,4)='7142' or
               substr(dx,1,4)='7148' or
               substr(dx,1,3)='725')
               and charlson_7=0
               then charlson_7=1;
 *Peptic Ulcer Disease;
         if(substr(dx,1,3)='531' or
               substr(dx,1,3)='532' or
               substr(dx,1,3)='533' or
               substr(dx,1,3)='534')
               and charlson_8=0
               then charlson_8=1;
*Mild Liver Disease ;
         if(substr(dx,1,5)='07022' or
               substr(dx,1,5)='07023' or
               substr(dx,1,5)='07032' or
               substr(dx,1,5)='07033' or
               substr(dx,1,5)='07044' or
               substr(dx,1,5)='07054' or
               substr(dx,1,4)='0706' or
               substr(dx,1,4)='0709' or
               substr(dx,1,3)='570' or
               substr(dx,1,3)='571' or
               substr(dx,1,4)='5733' or
               substr(dx,1,4)='5734' or
               substr(dx,1,4)='5738' or
               substr(dx,1,4)='5739' or
               substr(dx,1,4)='V427')
               and charlson_9=0
               then charlson_9=1;
*Diabetes without complications ;
         if(substr(dx,1,4)='2500' or
               substr(dx,1,4)='2501' or
               substr(dx,1,4)='2502' or
               substr(dx,1,4)='2503' or
               substr(dx,1,4)='2508' or
               substr(dx,1,4)='2509')
               and charlson_10=0
               then charlson_10=1;
*Diabetes, complicated;
	if (substr(dx,1,4)='2504' or
		substr(dx,1,4)='2505' or
		substr(dx,1,4)='2506' or
		substr(dx,1,4)='2507')
		and charlson_11=0
                then charlson_11=1;
*Paraplegia and Hemiplegia ;
	if (substr(dx,1,4)='3341' or
		substr(dx,1,3)='342' or
		substr(dx,1,3)='343' or
		substr(dx,1,4)='3440' or
		substr(dx,1,4)='3441' or
		substr(dx,1,4)='3442' or
		substr(dx,1,4)='3443' or
                substr(dx,1,4)='3444' or
		substr(dx,1,4)='3445' or
		substr(dx,1,4)='3446' or
		substr(dx,1,4)='3449')
		and charlson_12=0
                then charlson_12=1;
* Renal Disease ;
	if (substr(dx,1,5)='40301' or
		substr(dx,1,5)='40311' or
		substr(dx,1,5)='40391' or
		substr(dx,1,5)='40402' or
		substr(dx,1,5)='40403' or
		substr(dx,1,5)='40412' or
		substr(dx,1,5)='40413' or
                substr(dx,1,5)='40492' or
		substr(dx,1,5)='40493' or
		substr(dx,1,3)='582' or
		substr(dx,1,4)='5830' or
                substr(dx,1,4)='5831' or
                substr(dx,1,4)='5832' or
                substr(dx,1,4)='5834' or
                substr(dx,1,4)='5836' or
                substr(dx,1,4)='5837' or
                substr(dx,1,3)='585' or
                substr(dx,1,3)='586' or
                substr(dx,1,4)='5880' or
                substr(dx,1,4)='V420' or
                substr(dx,1,4)='V451' or
                substr(dx,1,3)='V56' )
		and charlson_13=0
                then charlson_13=1;
*Cancer ;
	if (substr(dx,1,2)='14' or
		substr(dx,1,2)='15' or
		substr(dx,1,2)='16' or
		substr(dx,1,3)='170' or
		substr(dx,1,3)='171' or
		substr(dx,1,3)='172' or
		substr(dx,1,3)='174' or
		substr(dx,1,3)='175' or
		substr(dx,1,3)='176' or
		substr(dx,1,3)='179' or
		substr(dx,1,2)='18' or
		substr(dx,1,3)='190' or
		substr(dx,1,3)='191' or
		substr(dx,1,3)='192' or
		substr(dx,1,3)='193' or
		substr(dx,1,3)='194' or
		substr(dx,1,3)='195' or
                substr(dx,1,3)='200' or
                substr(dx,1,3)='201' or
                substr(dx,1,3)='202' or
                substr(dx,1,3)='203' or
                substr(dx,1,3)='204' or
                substr(dx,1,3)='205' or
                substr(dx,1,3)='206' or
                substr(dx,1,3)='207' or
                substr(dx,1,3)='208' or
                substr(dx,1,3)='2386' )
		and charlson_14=0
                then charlson_14=1;
* Moderate or Severe Liver Disease ;
	if (substr(dx,1,4)='4560' or
		substr(dx,1,4)='4561' or
		substr(dx,1,4)='4562' or
		substr(dx,1,4)='5722' or
		substr(dx,1,4)='5723' or
		substr(dx,1,4)='5724' or
      		substr(dx,1,4)='5728' )
		and charlson_15=0
                then charlson_15=1;
  * Metastatic Carcinoma ;
	if (substr(dx,1,3)='196' or
		substr(dx,1,3)='197' or
		substr(dx,1,3)='198' or
		substr(dx,1,3)='199' )
		and charlson_16=0
                then charlson_16=1;
  * AIDS/HIV ;
	if (substr(dx,1,3)='042' or
		substr(dx,1,3)='043' or
		substr(dx,1,3)='044' )
		and charlson_17=0
                then charlson_17=1;

end;

run;

/*get count of each comorbidity for each id-core year combination*/
proc sql;
create table cha_test1 as
select distinct BID_hrs_21,
sum(charlson_1) as cha_1,
sum(charlson_2) as cha_2,
sum(charlson_3) as cha_3,
sum(charlson_4) as cha_4,
sum(charlson_5) as cha_5,
sum(charlson_6) as cha_6,
sum(charlson_7) as cha_7,
sum(charlson_8) as cha_8,
sum(charlson_9) as cha_9,
sum(charlson_10) as cha_10,
sum(charlson_11) as cha_11,
sum(charlson_12) as cha_12,
sum(charlson_13) as cha_13,
sum(charlson_14) as cha_14,
sum(charlson_15) as cha_15,
sum(charlson_16) as cha_16,
sum(charlson_17) as cha_17
from dx_charlson
group by BID_hrs_21;
quit;

/*convert counts of diagnoses for each comorbidity to indicator variables*/ 
data charlson_1(keep=BID_hrs_21 charls_1-charls_17 charls_index charls_index_wt);
set cha_test1;
array list_cha cha_1-cha_17;
array list_cha_bin charls_1-charls_17 ;

do over list_cha;
  list_cha_bin=0;

  if list_cha>0 then do;
    list_cha_bin=1;
   end;

end;
/*note this charls_index count count is not weighted for morbidity*/
charls_index=charls_1+charls_2+charls_3+charls_4+charls_5+charls_6+charls_7+charls_8+charls_9+charls_10
+charls_11+charls_12+charls_13+charls_14+charls_15+charls_16+charls_17;
/*now morbidity weighted*/
charls_index_wt=charls_1+charls_2+charls_3+charls_4+charls_5+charls_6+charls_7+charls_8+charls_9+charls_10
+2*charls_11+2*charls_12+2*charls_13+2*charls_14+3*charls_15+6*charls_16+6*charls_17;

label charls_1 ="Myocardial infarction, Charlson";
label charls_2 ="Congestive Heart Failure, Charlson";
label charls_3 ="Peripheral Vascular Disease, Charlson";
label charls_4 ="Cerebrovascular disease, Charlson";
label charls_5 ="Dementia, Charlson";
label charls_6 ="Chronic Pulmonary Disease, Charlson";
label charls_7 ="Rheumatic disease, Charlson";
label charls_8 ="Peptic ulcer disease, Charlson";
label charls_9 ="Mild liver disease, Charlson";
label charls_10 ="Diabetes, uncomplicated, Charlson";
label charls_11 ="Diabetes, complicated, Charlson";
label charls_12 ="Hemiplegia or paraplegia, Charlson";
label charls_13 ="Renal disease, Charlson";
label charls_14 ="Any malignancy except neoplasm of skin, Charlson";
label charls_15 ="Mod or severe liver disease, Charlson";
label charls_16 ="Metastatic solid tumor, Charlson";
label charls_17 ="AIDS/HIV, Charlson";
label charls_index ="Charlson score index, not weighted";
label charls_index_wt ="Charlson score index, weighted";

run;

/*merge into list of obs with ffs mc 6m prior to ivw*/
proc sort data=charlson_1 nodupkey out=charlson_&range2.;
by BID_hrs_21;
run;

%mend;

%charlson(range1=0, range2=n6m);
%charlson(range1=0, range2=n12m);

proc sql; 
create table proj_int.charlson as select * from
charlson_n12m a
left join charlson_n6m b
on a.bid_hrs_21=b.bid_hrs_21;
quit;




H="get  claims"
proc sort data=proj_int.index out=index1 nodupkey;
by bid_hrs_21 id index_date;
run;




/**************************************************************************/
/* ************** S Claims Before R's Death  ******************************/
/**************************************************************************/
/*macro to get claims before death
saves datasets for each claim type / time window to the spo_mc_i directory*/
%macro claims(days_start=,days_bef_index=,source=,suf=);

/*claims fully within x time of death date*/
proc sql;
create table &source._meet_1 as select a.*,b.index_date,b.id 
from medi.&source._2000_2012 a inner join
index1 b
on trim(left(a.bid_hrs_21))=trim(left(b.bid_hrs_21))
and &days_start<=b.index_date-a.admit_date<=&days_bef_index ;
quit;

/*claims that start earlier than x time but span into x time before death*/
proc sql;
create table &source._meet_2 as select a.*,b.index_date,b.id 
from medi.&source._2000_2012 a inner join
index1 b
on trim(left(a.bid_hrs_21))=trim(left(b.bid_hrs_21))
and b.index_date-a.admit_date>&days_bef_index and b.index_date-a.disch_date<=&days_bef_index;
quit;

data proj_int.&source._meet_&suf.(compress=yes);
set &source._meet_1 &source._meet_2;
run;
%mend;

/*6m before death*/
*%claims(days_start=0,days_bef_index=183,source=hh,suf=6m); /*home health*/
*%claims(days_start=0,days_bef_index=183,source=hs,suf=6m); /*hospice*/
*%claims(days_start=0,days_bef_index=183,source=mp,suf=6m); /*medpar*/
*%claims(days_start=0,days_bef_index=183,source=dm,suf=6m); /*dme*/
*%claims(days_start=0,days_bef_index=183,source=op,suf=6m); /*outpatient*/
*%claims(days_start=0,days_bef_index=183,source=pb,suf=6m); /*carrier*/
/*12m before death*/
%claims(days_start=0,days_bef_index=365,source=hh,suf=12m); /*home health*/
%claims(days_start=0,days_bef_index=365,source=hs,suf=12m); /*hospice*/
%claims(days_start=0,days_bef_index=365,source=mp,suf=12m); /*medpar*/
%claims(days_start=0,days_bef_index=365,source=dm,suf=12m); /*dme*/
%claims(days_start=0,days_bef_index=365,source=op,suf=12m); /*outpatient*/
%claims(days_start=0,days_bef_index=365,source=pb,suf=12m); /*carrier*/
/*18m before death*/
*%claims(days_start=0,days_bef_index=548,source=hh,suf=18m); /*home health*/
*%claims(days_start=0,days_bef_index=548,source=hs,suf=18m); /*hospice*/
*%claims(days_start=0,days_bef_index=548,source=mp,suf=18m); /*medpar*/
*%claims(days_start=0,days_bef_index=548,source=dm,suf=18m); /*dme*/
*%claims(days_start=0,days_bef_index=548,source=op,suf=18m); /*outpatient*/
*%claims(days_start=0,days_bef_index=548,source=pb,suf=18m); /*carrier*/
/*run for 24m before death*/
%claims(days_start=0,days_bef_index=365*2,source=hh,suf=24m); /*home health*/
%claims(days_start=0,days_bef_index=365*2,source=hs,suf=24m); /*hospice*/
%claims(days_start=0,days_bef_index=365*2,source=mp,suf=24m); /*medpar*/
%claims(days_start=0,days_bef_index=365*2,source=dm,suf=24m); /*dme*/
%claims(days_start=0,days_bef_index=365*2,source=op,suf=24m); /*outpatient*/
%claims(days_start=0,days_bef_index=365*2,source=pb,suf=24m); /*carrier*/

/**************************************************************************/
/* ************** S Claims After R's Death   ******************************/
/**************************************************************************/
/*macro to get claims after death
saves datasets for each claim type / time window to the spo_mc_i directory*/
%macro claims(days_start=,days_aft_index=,source=,suf=);

/*claims fully within x time of death date*/
proc sql;
create table &source._meet_1 as select a.*,b.index_date,b.id 
from medi.&source._2000_2012 a inner join
index1 b
on trim(left(a.bid_hrs_21))=trim(left(b.bid_hrs_21))
and &days_start<=a.admit_date - b.index_date<=&days_aft_index ;
quit;

/*claims that start earlier than R's DOD but span after R's death*/
proc sql;
create table &source._meet_2 as select a.*,b.index_date,b.id 
from medi.&source._2000_2012 a inner join
index1 b
on trim(left(a.bid_hrs_21))=trim(left(b.bid_hrs_21))
and a.admit_date<b.index_date
and &days_start<=a.disch_date - b.index_date;
quit;

data proj_int.&source._meet_&suf.(compress=yes);
set &source._meet_1 &source._meet_2;
format disch_date date9.;
format admit_date date9.;
run;
%mend;

/*6m after death*/
*%claims(days_start=0,days_aft_index=183,source=hh,suf=p6m); /*home health*/
*%claims(days_start=0,days_aft_index=183,source=hs,suf=p6m); /*hospice*/
*%claims(days_start=0,days_aft_index=183,source=mp,suf=p6m); /*medpar*/
*%claims(days_start=0,days_aft_index=183,source=dm,suf=p6m); /*dme*/
*%claims(days_start=0,days_aft_index=183,source=op,suf=p6m); /*outpatient*/
*%claims(days_start=0,days_aft_index=183,source=pb,suf=p6m); /*carrier*/
/*12m before death*/
%claims(days_start=0,days_aft_index=365,source=hh,suf=p12m); /*home health*/
%claims(days_start=0,days_aft_index=365,source=hs,suf=p12m); /*hospice*/
%claims(days_start=0,days_aft_index=365,source=mp,suf=p12m); /*medpar*/
%claims(days_start=0,days_aft_index=365,source=dm,suf=p12m); /*dme*/
%claims(days_start=0,days_aft_index=365,source=op,suf=p12m); /*outpatient*/
%claims(days_start=0,days_aft_index=365,source=pb,suf=p12m); /*carrier*/
/*18m before death*/
*%claims(days_start=0,days_aft_index=548,source=hh,suf=p18m); /*home health*/
*%claims(days_start=0,days_aft_index=548,source=hs,suf=p18m); /*hospice*/
*%claims(days_start=0,days_aft_index=548,source=mp,suf=p18m); /*medpar*/
*%claims(days_start=0,days_aft_index=548,source=dm,suf=p18m); /*dme*/
*%claims(days_start=0,days_aft_index=548,source=op,suf=p18m); /*outpatient*/
*%claims(days_start=0,days_aft_index=548,source=pb,suf=p18m); /*carrier*/
/*run for 24m before death*/
%claims(days_start=0,days_aft_index=365*2,source=hh,suf=p24m); /*home health*/
%claims(days_start=0,days_aft_index=365*2,source=hs,suf=p24m); /*hospice*/
%claims(days_start=0,days_aft_index=365*2,source=mp,suf=p24m); /*medpar*/
%claims(days_start=0,days_aft_index=365*2,source=dm,suf=p24m); /*dme*/
%claims(days_start=0,days_aft_index=365*2,source=op,suf=p24m); /*outpatient*/
%claims(days_start=0,days_aft_index=365*2,source=pb,suf=p24m); /*carrier*/

/**************************************************************************/
/* ********************* S Diagnosis Lists   ******************************/
/**************************************************************************/

%macro dx_time_range(range1=, range2=, suf=);
/*pulls just dx codes from carrier claims*/
data pb_last_&range2._dx(keep=bid_hrs_21 id diag index_date);
set proj_int.pb_meet_&suf.(keep=bid_hrs_21 id PDGNS_CD DGNSCD01-DGNSCD12 index_date);
array dx PDGNS_CD DGNSCD01-DGNSCD12;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=pb_last_&range2._dx out=pb_last_&range2._dx2 nodupkey;
by bid_hrs_21 id index_date diag;
run;

/*outpatient claims*/
data op_last_&range2._dx(keep=bid_hrs_21 id diag index_date);
set proj_int.op_meet_&suf.(keep=bid_hrs_21 id PDGNS_CD DGNSCD01-DGNSCD25  index_date);
array dx PDGNS_CD DGNSCD01-DGNSCD25 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=op_last_&range2._dx out=op_last_&range2._dx2 nodupkey;
by bid_hrs_21 id index_date diag;
run;

/*medpar claims*/
data mp_last_&range2._dx(keep=bid_hrs_21 id diag index_date);
set proj_int.mp_meet_&suf.(keep=bid_hrs_21 id AD_DGNS DGNS_CD01-DGNS_CD25 index_date );
array dx D_DGNS DGNS_CD01-DGNS_CD25 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=mp_last_&range2._dx out=mp_last_&range2._dx2 nodupkey;
by bid_hrs_21 id index_date diag;
run;

/*dme claims*/
data dm_last_&range2._dx(keep=bid_hrs_21 id diag index_date);
set proj_int.dm_meet_&suf.(keep=bid_hrs_21 id PDGNS_CD DGNSCD01-DGNSCD12 index_date);
array dx PDGNS_CD DGNSCD01-DGNSCD12 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=dm_last_&range2._dx out=dm_last_&range2._dx2 nodupkey;
by bid_hrs_21 id index_date diag;
run;

/*home health agency*/
data hh_last_&range2._dx(keep=bid_hrs_21 id diag index_date);
set proj_int.hh_meet_&suf.(keep=bid_hrs_21 id PDGNS_CD DGNSCD01-DGNSCD25 index_date);
array dx PDGNS_CD DGNSCD01-DGNSCD25 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=hh_last_&range2._dx out=hh_last_&range2._dx2 nodupkey;
by bid_hrs_21 id index_date diag;
run;

/*hospice*/
data hs_last_&range2._dx(keep=bid_hrs_21 id diag index_date);
set proj_int.hs_meet_&suf.(keep=bid_hrs_21 id PDGNS_CD DGNSCD01-DGNSCD25 index_date);
array dx PDGNS_CD DGNSCD01-DGNSCD25 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=hs_last_&range2._dx out=hs_last_&range2._dx2 nodupkey;
by bid_hrs_21 id index_date diag;
run;

/*set diag variable length = 7 chars since that's the max length from the mc claims
Need to do this because length varies across the different mc claim types*/
data hs_last_&range2._dx3;
length diag $7;
set hs_last_&range2._dx2;
run;
data hh_last_&range2._dx3;
length diag $7;
set hh_last_&range2._dx2;
run;
data mp_last_&range2._dx3;
length diag $7;
set mp_last_&range2._dx2;
run;
data dm_last_&range2._dx3;
length diag $7;
set dm_last_&range2._dx2;
run;
data op_last_&range2._dx3;
length diag $7;
set op_last_&range2._dx2;
run;
data pb_last_&range2._dx3;
length diag $7;
set pb_last_&range2._dx2;
run;

data dx_all_last_&range2.;
set hs_last_&range2._dx3
hh_last_&range2._dx3
mp_last_&range2._dx3
dm_last_&range2._dx3
op_last_&range2._dx3
pb_last_&range2._dx3;
run;

proc sort data=dx_all_last_&range2.(where=(diag~="")) out=proj_int.dx_&range1._&range2 nodupkey;
by bid_hrs_21 id index_date diag;
run;

%mend;

/*run macro to create data files proj_int.dx_0d_n6m proj_int.dx_0d_n12m and proj_int.dx_0d_n24m */
*%dx_time_range(range1=0d, range2=n6m, suf=6m);
%dx_time_range(range1=0d, range2=n12m, suf=12m);
*%dx_time_range(range1=0d, range2=n24m, suf=24m);

/*run for dx lists after R's death*/
*%dx_time_range(range1=0d, range2=p6m, suf=p6m);
%dx_time_range(range1=0d, range2=p12m, suf=p12m);
*%dx_time_range(range1=0d, range2=p24m, suf=p24m);



/*get spouse medicare costs by claim type and total, adjusted for inflation
to 2012$, monthly, 24m before and after R's death

begins with claims lists from "Get S MC claims lists..." section

final dataset is spo_mc_i.hrs_elix_cc_pay*/


/****************************************************************/
/*medpar claims, time periods before R's death*******************/
/****************************************************************/
/*macro for medpar claims, splits into costs for snf and ip claims
for time periods before r's death*/
%macro mp(source=,equ=,name=);
data proj_int.&source._meet_&name.;
set proj_int.mp_meet_&name.;
if (trim(left(SSLSSNF)))&equ.="N";
run;
%mend;

%mp(source=ip,equ=~,name=24m);
%mp(source=ip,equ=~,name=p24m);
%mp(source=snf,equ=,name=24m);
%mp(source=snf,equ=,name=p24m);

H="mc spending"
/*get spouse medicare costs by claim type and total, adjusted for inflation
to 2012$, monthly, 24m before and after R's death

begins with claims lists from "Get S MC claims lists..." section

final dataset is proj_int.hrs_elix_cc_pay*/



%macro mp_index_dt(source=);
*get claims that overlap with date of death;

data &source._meet_admit;
set proj_int.&source._meet_24m;
if index_date=admit_date and admit_date~=disch_date;
admit_on_index_date=1;
run;

data &source._meet_disch;
set proj_int.&source._meet_24m;
if index_date>admit_date and index_date=disch_date;
disch_on_index_date=1;
run;

data &source._meet_neither;
set proj_int.&source._meet_24m;
if index_date>admit_date and admit_date<disch_date;
run;

data &source._meet_both;
set proj_int.&source._meet_24m;
if index_date=disch_date and admit_date=disch_date;
admit_on_index_date=1;
disch_on_index_date=1;
run;




data &source._cost;
set &source._meet_admit &source._meet_disch &source._meet_neither &source._meet_both;
array list pmt_amt passthru;
do over list;
if list=. then list=0;
end;

if year(admit_date)>=2012 then rate=1;
if year(admit_date)=2011 then rate=1.03902;
if year(admit_date)=2010 then rate=1.07086;
if year(admit_date)=2009 then rate=1.10835;
if year(admit_date)=2008 then rate=1.1439;
if year(admit_date)=2007 then rate=1.1923;
if year(admit_date)=2006 then rate=1.25586;
if year(admit_date)=2005 then rate=1.30783;
if year(admit_date)=2004 then rate=1.37027;
if year(admit_date)=2003 then rate=1.43908;
if year(admit_date)=2002 then rate=1.50337;
if year(admit_date)=2001 then rate=1.57963;
if year(admit_date)=2000 then rate=1.65519;
if year(admit_date)<=1999 then rate=1.72641;


&source._paid_by_mc=rate*(pmt_amt+passthru);
&source._paid_by_mc_index_dt=(1/(disch_date-admit_date+1))*&source._paid_by_mc;
run;

proc sql;
create table &source._pay as select distinct bid_hrs_21,id,index_date,
sum(&source._paid_by_mc_index_dt) as &source._paid_by_mc_index_dt,
sum(admit_on_index_date) as &source._admit_dod, sum(disch_on_index_date) as &source._disch_dod
from &source._cost group by bid_hrs_21,id,index_date;
quit;

%mend;
%mp_index_dt(source=ip);
%mp_index_dt(source=snf);


%macro claims_index_dt(source=);
*get claims that start with date of death;

data &source._meet_admit;
set proj_int.&source._meet_24m;
if index_date=admit_date; 
run;



data &source._cost;
set &source._meet_admit;
array list pmt_amt passthru;
do over list;
if list=. then list=0;
end;

if year(admit_date)>=2012 then rate=1;
if year(admit_date)=2011 then rate=1.03902;
if year(admit_date)=2010 then rate=1.07086;
if year(admit_date)=2009 then rate=1.10835;
if year(admit_date)=2008 then rate=1.1439;
if year(admit_date)=2007 then rate=1.1923;
if year(admit_date)=2006 then rate=1.25586;
if year(admit_date)=2005 then rate=1.30783;
if year(admit_date)=2004 then rate=1.37027;
if year(admit_date)=2003 then rate=1.43908;
if year(admit_date)=2002 then rate=1.50337;
if year(admit_date)=2001 then rate=1.57963;
if year(admit_date)=2000 then rate=1.65519;
if year(admit_date)<=1999 then rate=1.72641;


&source._paid_by_mc_index_dt=rate*(pmt_amt);
run;

proc sql;
create table &source._pay as select distinct bid_hrs_21,id,index_date,
sum(&source._paid_by_mc_index_dt) as &source._paid_by_mc_index_dt
from &source._cost group by bid_hrs_21,id,index_date;
quit;

%mend;

%claims_index_dt(source=op);
%claims_index_dt(source=pb);
%claims_index_dt(source=hh);
%claims_index_dt(source=hs);
%claims_index_dt(source=dm);

data mc_costs_doda;
merge ip_pay snf_pay op_pay pb_pay hh_pay hs_pay dm_pay ;
bid_hrs_21=bid_hrs_21;
by bid_hrs_21 id index_date;
run;


data mc_costs_dod;
set mc_costs_doda;
tot_paid_by_mc_index_dt=ip_paid_by_mc_index_dt+snf_paid_by_mc_index_dt+op_paid_by_mc_index_dt +
pb_paid_by_mc_index_dt+hs_paid_by_mc_index_dt+dm_paid_by_mc_index_dt;
run;


%macro mp_claims(days_start=,days_bef_index=,source=,name=);

*first get claims lists for the specific claims type, snf or ip;
data &source._meet;
set proj_int.&source._meet_24m;
win_start_dt=index_date-&days_bef_index;
win_stop_dt=index_date-&days_start;
format admit_date disch_date win_start_dt win_stop_dt date9.;
run;

/*identify claims where entire claim is within the x months prior to death*/
data &source._meet_1;
set &source._meet;
if win_start_dt<=admit_date<win_stop_dt and
	win_start_dt<=disch_date<win_stop_dt;
run;

/*identify claims where start before window but end during window*/
data &source._meet_2;
set &source._meet;
if win_start_dt>admit_date and
	win_start_dt<=disch_date<win_stop_dt;
run;

/*identify fraction of claims to be attributed to period before death
by just using the fraction of time that was included in the time window*/
data &source._meet_3;
set &source._meet_2;
pct_xm=(disch_date-win_start_dt)/(disch_date-admit_date+1);
array list pmt_amt passthru;
do over list;
if list=. then list=0;
/*scale the partial claims by the time within the x month period*/
list=list*pct_xm;
end;

run;

/*claims where start within window but end after R's death*/
data &source._meet_4;
set &source._meet;
if win_start_dt<=admit_date<win_stop_dt and
	disch_date>=win_stop_dt;
run;

/*again fraction to attribute to window*/
data &source._meet_5;
set &source._meet_4;
pct_xm=(win_stop_dt-admit_date+1)/(disch_date-admit_date+1);
array list pmt_amt passthru;
do over list;
if list=. then list=0;
/*scale the partial claims by the time within the x month period*/
list=list*pct_xm;
end;
run;

/*claims where start before and end after window*/
data &source._meet_6;
set &source._meet;
if win_start_dt>admit_date and
	disch_date>=win_stop_dt;
run;

/*again fraction to attribute to window*/
data &source._meet_7;
set &source._meet_6;
pct_xm=(win_stop_dt-win_start_dt)/(disch_date-admit_date+1);
array list pmt_amt passthru;
do over list;
if list=. then list=0;
/*scale the partial claims by the time within the x month period*/
list=list*pct_xm;
end;
run;

/*merge claims into single dataset, adjust for inflation
Uses CPI for Medical Services from BLS website, accessed 5/4/2015*/
data &source._cost;
set &source._meet_1 &source._meet_3 &source._meet_5 &source._meet_7;
array list pmt_amt passthru;
do over list;
if list=. then list=0;
end;

if year(admit_date)>=2012 then rate=1;
if year(admit_date)=2011 then rate=1.03902;
if year(admit_date)=2010 then rate=1.07086;
if year(admit_date)=2009 then rate=1.10835;
if year(admit_date)=2008 then rate=1.1439;
if year(admit_date)=2007 then rate=1.1923;
if year(admit_date)=2006 then rate=1.25586;
if year(admit_date)=2005 then rate=1.30783;
if year(admit_date)=2004 then rate=1.37027;
if year(admit_date)=2003 then rate=1.43908;
if year(admit_date)=2002 then rate=1.50337;
if year(admit_date)=2001 then rate=1.57963;
if year(admit_date)=2000 then rate=1.65519;
if year(admit_date)<=1999 then rate=1.72641;


&source._paid_by_mc=rate*(pmt_amt+passthru);
run;

*calculates total of mc charges for the claim type by hrs bid;
proc sql;
create table &source._pay as select distinct bid_hrs_21,id,index_date,
sum(&source._paid_by_mc) as &source._paid_by_mc 
from &source._cost group by bid_hrs_21,id,index_date;
quit;

/*merge into a full bid list of those s's with ffs mc 6m or more*/
proc sql;
create table &source._&name. as select 
a.bid_hrs_21,a.id,a.index_date,coalesce(b.&source._paid_by_mc,0) as &source._paid_by_mc_&name.
from proj_int.index a
left join
 &source._pay b
 on trim(left(a.bid_hrs_21))=trim(left(b.bid_hrs_21)) and a.id=b.id and a.index_date=b.index_date;
 quit;

proc sort data=&source._&name.; by bid_hrs_21 id index_date; run;

%mend;



%macro claims(days_start=,days_bef_index=,source=,name=);

*first get claims lists for the specific claims type, not snf or ip;
data &source._meet;
set proj_int.&source._meet_24m;
win_start_dt=index_date-&days_bef_index;
win_stop_dt=index_date-&days_start;
format admit_date disch_date win_start_dt win_stop_dt date9.;
run;

/*identify claims where start of claim is within the x months prior to death*/
data proj_int.&source._meet&name.;
set &source._meet;
if win_start_dt<=admit_date<win_stop_dt;
run;


/*adjust for inflation
Uses CPI for Medical Services from BLS website, accessed 5/4/2015*/
data &source._cost;
set proj_int.&source._meet&name.;
array list pmt_amt passthru;
do over list;
if list=. then list=0;
end;

if year(admit_date)>=2012 then rate=1;
if year(admit_date)=2011 then rate=1.03902;
if year(admit_date)=2010 then rate=1.07086;
if year(admit_date)=2009 then rate=1.10835;
if year(admit_date)=2008 then rate=1.1439;
if year(admit_date)=2007 then rate=1.1923;
if year(admit_date)=2006 then rate=1.25586;
if year(admit_date)=2005 then rate=1.30783;
if year(admit_date)=2004 then rate=1.37027;
if year(admit_date)=2003 then rate=1.43908;
if year(admit_date)=2002 then rate=1.50337;
if year(admit_date)=2001 then rate=1.57963;
if year(admit_date)=2000 then rate=1.65519;
if year(admit_date)<=1999 then rate=1.72641;


&source._paid_by_mc=rate*(pmt_amt);
run;

*calculates total of mc charges for the claim type by hrs bid;
proc sql;
create table &source._pay as select distinct bid_hrs_21,id,index_date,
sum(&source._paid_by_mc) as &source._paid_by_mc 
from &source._cost group by bid_hrs_21,id,index_date;
quit;

/*merge into a full bid list of those s's with ffs at death*/
proc sql;
create table &source._&name. as select 
a.bid_hrs_21,a.id,a.index_date,coalesce(b.&source._paid_by_mc,0) as &source._paid_by_mc_&name.
from proj_int.index a
left join
 &source._pay b
 on trim(left(a.bid_hrs_21))=trim(left(b.bid_hrs_21)) and a.id=b.id and a.index_date=b.index_date;
 quit;

proc sort data=&source._&name.; by bid_hrs_21 id index_date; run;

%mend;




/****************************************************************/
/*all claims, time periods after R's death********************/
/****************************************************************/
%macro mp_claims_p(days_start=,days_aft_index=,source=,name=);

*first get claims lists for the specific claims type, snf or ip;
data &source._meet;
set proj_int.&source._meet_p24m;
win_end_dt=index_date+&days_aft_index;
win_start_dt=index_date+&days_start;
format admit_date disch_date win_end_dt win_start_dt date9.;
run;

/*identify claims where entire claim is within the x months after death*/
data &source._meet_1;
set &source._meet;
if win_start_dt<admit_date<=win_end_dt and
	win_start_dt<disch_date<=win_end_dt;
run;

/*identify claims where start before window but end during window*/
data &source._meet_2;
set &source._meet;
if win_start_dt>=admit_date and
	win_start_dt<disch_date<=win_end_dt;
run;

/*identify fraction of claims to be attributed to period after death
by just using the fraction of time that was included in the time window*/
data &source._meet_3;
set &source._meet_2;
pct_xm=(disch_date-win_start_dt)/(disch_date-admit_date+1);
array list pmt_amt passthru;
do over list;
if list=. then list=0;
/*scale the partial claims by the time within the x month period*/
list=list*pct_xm;
end;
run;

/*claims where start within window but end after window*/
data &source._meet_4;
set &source._meet;
if win_start_dt<admit_date<=win_end_dt and
	disch_date>win_end_dt ;
run;

/*again fraction to attribute to window*/
data &source._meet_5;
set &source._meet_4;
pct_xm=(win_end_dt-admit_date+1)/(disch_date-admit_date+1);
array list pmt_amt passthru;
do over list;
if list=. then list=0;
/*scale the partial claims by the time within the x month period*/
list=list*pct_xm;
end;
run;

/*claims where start before window but end after window*/
data &source._meet_6;
set &source._meet;
if win_start_dt>=admit_date and
	disch_date>win_end_dt ;
run;

/*again fraction to attribute to window*/
data &source._meet_7;
set &source._meet_6;
pct_xm=(win_end_dt -win_start_dt)/(disch_date-admit_date+1);
array list pmt_amt passthru;
do over list;
if list=. then list=0;
/*scale the partial claims by the time within the x month period*/
list=list*pct_xm;
end;
run;
/*merge claims into single dataset, adjust for inflation*/
data &source._cost;
set &source._meet_1 &source._meet_3 &source._meet_5 &source._meet_7;
array list pmt_amt passthru;
do over list;
if list=. then list=0;
end;

if year(admit_date)>=2012 then rate=1;
if year(admit_date)=2011 then rate=1.03902;
if year(admit_date)=2010 then rate=1.07086;
if year(admit_date)=2009 then rate=1.10835;
if year(admit_date)=2008 then rate=1.1439;
if year(admit_date)=2007 then rate=1.1923;
if year(admit_date)=2006 then rate=1.25586;
if year(admit_date)=2005 then rate=1.30783;
if year(admit_date)=2004 then rate=1.37027;
if year(admit_date)=2003 then rate=1.43908;
if year(admit_date)=2002 then rate=1.50337;
if year(admit_date)=2001 then rate=1.57963;
if year(admit_date)=2000 then rate=1.65519;
if year(admit_date)<=1999 then rate=1.72641;

&source._paid_by_mc=rate*(pmt_amt+passthru);
run;

*calculates total of mc charges for the claim type by hrs bid;
proc sql;
create table &source._pay as select distinct bid_hrs_21,id,index_date,
sum(&source._paid_by_mc) as &source._paid_by_mc 
from &source._cost group by bid_hrs_21,id,index_date;
quit;

/*merge into a full bid list of those s's with ffs mc at death*/
proc sql;
create table &source._&name. as select 
a.bid_hrs_21,a.id,a.index_date,coalesce(b.&source._paid_by_mc,0) as &source._paid_by_mc_&name.
from proj_int.index a
left join
 &source._pay b
 on trim(left(a.bid_hrs_21))=trim(left(b.bid_hrs_21)) and a.id=b.id and a.index_date=b.index_date;
 quit;

proc sort data=&source._&name.; by bid_hrs_21 id index_date; run;

%mend;




/****************************************************************/
/*all claims, time periods after R's death********************/
/****************************************************************/
%macro claims_p(days_start=,days_aft_index=,source=,name=);

*first get claims lists for the specific claims type, snf or ip;
data &source._meet;
set proj_int.&source._meet_p24m;
win_end_dt=index_date+&days_aft_index;
win_start_dt=index_date+&days_start;
format admit_date disch_date win_end_dt win_start_dt date9.;
run;

/*identify claims where entire claim is within the x months after death*/
data proj_int.&source._meet&name.;
set &source._meet;
if win_start_dt<admit_date<=win_end_dt;
run;


/*adjust for inflation*/
data &source._cost;
set proj_int.&source._meet&name.;
array list pmt_amt;
do over list;
if list=. then list=0;
end;

if year(admit_date)>=2012 then rate=1;
if year(admit_date)=2011 then rate=1.03902;
if year(admit_date)=2010 then rate=1.07086;
if year(admit_date)=2009 then rate=1.10835;
if year(admit_date)=2008 then rate=1.1439;
if year(admit_date)=2007 then rate=1.1923;
if year(admit_date)=2006 then rate=1.25586;
if year(admit_date)=2005 then rate=1.30783;
if year(admit_date)=2004 then rate=1.37027;
if year(admit_date)=2003 then rate=1.43908;
if year(admit_date)=2002 then rate=1.50337;
if year(admit_date)=2001 then rate=1.57963;
if year(admit_date)=2000 then rate=1.65519;
if year(admit_date)<=1999 then rate=1.72641;

&source._paid_by_mc=rate*(pmt_amt);
run;

*calculates total of mc charges for the claim type by hrs bid;
proc sql;
create table &source._pay as select distinct bid_hrs_21,id,index_date,
sum(&source._paid_by_mc) as &source._paid_by_mc 
from &source._cost group by bid_hrs_21,id,index_date;
quit;

/*merge into a full bid list of those s's with ffs mc at death*/
proc sql;
create table &source._&name. as select 
a.bid_hrs_21,a.id,a.index_date,coalesce(b.&source._paid_by_mc,0) as &source._paid_by_mc_&name.
from proj_int.index a
left join
 &source._pay b
 on trim(left(a.bid_hrs_21))=trim(left(b.bid_hrs_21)) and a.id=b.id and a.index_date=b.index_date;
 quit;

proc sort data=&source._&name.; by bid_hrs_21 id index_date; run;

%mend;

%macro days_nesting();

%do i=1 %to 24 ;


%mp_claims(days_start=floor((&i.-1)*30.417),days_bef_index=floor(&i.*30.417), source=snf,  name=m&i.);
%mp_claims(days_start=floor((&i.-1)*30.417),days_bef_index=floor(&i.*30.417), source=ip,  name=m&i.);
%claims(days_start=floor((&i.-1)*30.417),days_bef_index=floor(&i.*30.417), source=pb,  name=m&i.);
%claims(days_start=floor((&i.-1)*30.417),days_bef_index=floor(&i.*30.417), source=op,  name=m&i.);
%claims(days_start=floor((&i.-1)*30.417),days_bef_index=floor(&i.*30.417), source=hh,  name=m&i.);
%claims(days_start=floor((&i.-1)*30.417),days_bef_index=floor(&i.*30.417), source=hs,  name=m&i.);
%claims(days_start=floor((&i.-1)*30.417),days_bef_index=floor(&i.*30.417), source=dm,  name=m&i.);
%mp_claims_p(days_start=floor((&i.-1)*30.417),days_aft_index=floor(&i.*30.417), source=snf,  name=m&i.p);
%mp_claims_p(days_start=floor((&i.-1)*30.417),days_aft_index=floor(&i.*30.417), source=ip,  name=m&i.p);
%claims_p(days_start=floor((&i.-1)*30.417),days_aft_index=floor(&i.*30.417), source=op,  name=m&i.p);
%claims_p(days_start=floor((&i.-1)*30.417),days_aft_index=floor(&i.*30.417), source=pb,  name=m&i.p);
%claims_p(days_start=floor((&i.-1)*30.417),days_aft_index=floor(&i.*30.417), source=hh,  name=m&i.p);
%claims_p(days_start=floor((&i.-1)*30.417),days_aft_index=floor(&i.*30.417), source=hs,  name=m&i.p);
%claims_p(days_start=floor((&i.-1)*30.417),days_aft_index=floor(&i.*30.417), source=dm,  name=m&i.p);


%end;
%mend;

%days_nesting();




%macro merge(l=,source=,time=,p=);
data &source._&time._m1;
set &source._m1&p.;
run;

%do i=2 %to 24 ;
%let l = %eval(&i.-1) ;

data &source._&time._m&i.;
merge &source._&time._m&l. &source._m&i.&p.;
run;
%end;

data &source._&time.;
set &source._&time._m24;
run;
%mend;

%merge(source=ip,time=bef,p=);
%merge(source=ip,time=aft,p=p);
%merge(source=snf,time=bef,p=);
%merge(source=snf,time=aft,p=p);
%merge(source=op,time=bef,p=);
%merge(source=op,time=aft,p=p);
%merge(source=pb,time=bef,p=);
%merge(source=pb,time=aft,p=p);
%merge(source=hh,time=bef,p=);
%merge(source=hh,time=aft,p=p);
%merge(source=hs,time=bef,p=);
%merge(source=hs,time=aft,p=p);
%merge(source=dm,time=bef,p=);
%merge(source=dm,time=aft,p=p);

/*now merge into single dataset of MC costs and get totals for each time window*/
data mc_costs_all;
merge ip_bef snf_bef op_bef pb_bef hh_bef hs_bef dm_bef 
ip_aft snf_aft op_aft pb_aft hh_aft hs_aft dm_aft;
by bid_hrs_21 id index_date;
run;

%macro total();

data mc_costs_all2;
set mc_costs_all;
%do i=1 %to 24;
tot_paid_by_mc_m&i.=ip_paid_by_mc_m&i. + snf_paid_by_mc_m&i. + op_paid_by_mc_m&i. + 
pb_paid_by_mc_m&i. + hh_paid_by_mc_m&i. + hs_paid_by_mc_m&i. + dm_paid_by_mc_m&i.;
tot_paid_by_mc_m&i.p=ip_paid_by_mc_m&i.p + snf_paid_by_mc_m&i.p + op_paid_by_mc_m&i.p + 
pb_paid_by_mc_m&i.p + hh_paid_by_mc_m&i.p + hs_paid_by_mc_m&i.p + dm_paid_by_mc_m&i.p;
%end;
run;
%mend;

%total();

data mc_costs_all3;
merge mc_costs_all2 mc_costs_dod;
by  bid_hrs_21 id index_date;
run;

/*save permanent dataset*/
data proj_int.mc_costs_monthly;
set mc_costs_all3;
run;



H="other utilization"




/*additional outcome variables

Spouse - monthly pre and post R's death:
Hospital # visits
Hospital nights
# ED visits
# OP visits*/


/*get spouse medicare costs by claim type and total, adjusted for inflation
to 2012$, monthly, 24m before and after R's death

begins with claims lists from "Get S MC claims lists..." section

final dataset is proj_int.hrs_elix_cc_pay*/

proc sort data=proj_int.index out=index1 nodupkey;
by bid_hrs_21 index_date;
run;



/*****************************************************************************/
/*get admissions and ip ed visits from ip claims monthly pre R's death*/
/*****************************************************************************/




%macro pre_admissions(days_start=,days_bef_index=,suffix=,su=);

/*pull list of ip claims from all medpar claims x days pre-death*/
data ip_meet_&suffix._1a;
set proj_int.mp_meet_24m(where=(trim(left(SSLSSNF))~="N"));
win_start_dt=index_date-&days_bef_index;
win_stop_dt=index_date-&days_start;
format admit_date disch_date win_start_dt win_stop_dt date9.;
run;

data ip_meet_&suffix._1;
set ip_meet_&suffix._1a;
if win_start_dt<=admit_date<=win_stop_dt or 
win_start_dt<=disch_date<=win_stop_dt;
run;

data ip_&suffix._2;
set ip_meet_&suffix._1;
if icarecnt=. then icarecnt=0; /*medpar intensive care day count*/
if CRNRYDAY=. then CRNRYDAY=0; /*medpar coronary day count*/
icu_days=icarecnt+CRNRYDAY;


/*truncate stays where the admit is before x days pre- R's death
or discharge is after R's death so can get accurate LOS*/
admit_date2=admit_date;
disch_date2=disch_date;
if admit_date<win_start_dt then do;
	admit_date2=win_start_dt;
	admit_trunc=1;
	end;
if win_stop_dt <disch_date then do;
	disch_date2=win_stop_dt;
	disch_trunc=1;	
	end;
adj_los=disch_date2-admit_date2;
if disch_date-admit_date=0 then adj_los=1;
run;

/*determine if mental health dx is present*/
data ip_&suffix._2a;
set ip_&suffix._2;
/*first, check if mental health is the admitting diagnosis*/
adm_mental_ill=0;

/*dx list from the AHRQ CCS Multi dx Tool, 2015, for Mental Illness Level 1 category*/
	if (substr(ad_dgns,1,3)='290' or
		substr(ad_dgns,1,3)='291' or
		substr(ad_dgns,1,3)='292' or
		substr(ad_dgns,1,3)='293' or
		substr(ad_dgns,1,3)='294' or
		substr(ad_dgns,1,3)='295' or
		substr(ad_dgns,1,3)='296' or
		substr(ad_dgns,1,3)='297' or
		substr(ad_dgns,1,3)='298' or
		substr(ad_dgns,1,3)='299' or
		substr(ad_dgns,1,3)='300' or
		substr(ad_dgns,1,3)='301' or
		substr(ad_dgns,1,3)='302' or
		substr(ad_dgns,1,3)='303' or
		substr(ad_dgns,1,3)='304' or
		substr(ad_dgns,1,3)='305' or
		substr(ad_dgns,1,3)='306' or
		substr(ad_dgns,1,3)='307' or
		substr(ad_dgns,1,3)='308' or
		substr(ad_dgns,1,3)='309' or
		substr(ad_dgns,1,3)='310' or
		substr(ad_dgns,1,3)='311' or
		substr(ad_dgns,1,3)='312' or
		substr(ad_dgns,1,3)='313' or
		substr(ad_dgns,1,3)='314' or
		substr(ad_dgns,1,3)='315' or
		substr(ad_dgns,1,3)='316' or
		substr(ad_dgns,1,3)='317' or
		substr(ad_dgns,1,3)='318' or
		substr(ad_dgns,1,3)='319' or
		substr(ad_dgns,1,4)='3310' or
		substr(ad_dgns,1,4)='3311' or
		substr(ad_dgns,1,4)='3312' or
		substr(ad_dgns,1,5)='33182' or
		substr(ad_dgns,1,5)='33392' or
		substr(ad_dgns,1,4)='3575' or
		substr(ad_dgns,1,4)='4255' or
		substr(ad_dgns,1,4)='5353' or
		substr(ad_dgns,1,4)='5710' or
		substr(ad_dgns,1,4)='5711' or
		substr(ad_dgns,1,4)='5712' or
		substr(ad_dgns,1,4)='5713' or
		substr(ad_dgns,1,4)='6483' or
		substr(ad_dgns,1,4)='6484' or
		substr(ad_dgns,1,4)='6555' or
		substr(ad_dgns,1,5)='76071' or
		substr(ad_dgns,1,5)='76072' or
		substr(ad_dgns,1,5)='76073' or
		substr(ad_dgns,1,5)='76075' or
		substr(ad_dgns,1,4)='7795' or
		substr(ad_dgns,1,4)='7903' or
		substr(ad_dgns,1,3)='797' or 
		substr(ad_dgns,1,4)='9650' or
		substr(ad_dgns,1,4)='9800' or
		substr(ad_dgns,1,3)='E95' or
		substr(ad_dgns,1,3)='V11' or
		substr(ad_dgns,1,4)='V154' or
		substr(ad_dgns,1,5)='V1582' or
		substr(ad_dgns,1,3)='V40' or
		substr(ad_dgns,1,5)='V6284' or
		substr(ad_dgns,1,5)='V6285' or
		substr(ad_dgns,1,5)='V6542' or
		substr(ad_dgns,1,4)='V663' or
		substr(ad_dgns,1,4)='V673' or
		substr(ad_dgns,1,4)='V701' or
		substr(ad_dgns,1,4)='V702' or
		substr(ad_dgns,1,4)='V710' or
		substr(ad_dgns,1,3)='V79') 
		and adm_mental_ill=0 
		then adm_mental_ill=1;*set to 1 if not flagged already;

	   /*now check if mental illness is any of the diagnoses present for the claim*/
any_dx_mental_ill=0;
array dx DGNS_CD01-DGNS_CD25 ;
do over dx;
	if (substr(dx,1,3)='290' or
		substr(dx,1,3)='291' or
		substr(dx,1,3)='292' or
		substr(dx,1,3)='293' or
		substr(dx,1,3)='294' or
		substr(dx,1,3)='295' or
		substr(dx,1,3)='296' or
		substr(dx,1,3)='297' or
		substr(dx,1,3)='298' or
		substr(dx,1,3)='299' or
		substr(dx,1,3)='300' or
		substr(dx,1,3)='301' or
		substr(dx,1,3)='302' or
		substr(dx,1,3)='303' or
		substr(dx,1,3)='304' or
		substr(dx,1,3)='305' or
		substr(dx,1,3)='306' or
		substr(dx,1,3)='307' or
		substr(dx,1,3)='308' or
		substr(dx,1,3)='309' or
		substr(dx,1,3)='310' or
		substr(dx,1,3)='311' or
		substr(dx,1,3)='312' or
		substr(dx,1,3)='313' or
		substr(dx,1,3)='314' or
		substr(dx,1,3)='315' or
		substr(dx,1,3)='316' or
		substr(dx,1,3)='317' or
		substr(dx,1,3)='318' or
		substr(dx,1,3)='319' or
		substr(dx,1,4)='3310' or
		substr(dx,1,4)='3311' or
		substr(dx,1,4)='3312' or
		substr(dx,1,5)='33182' or
		substr(dx,1,5)='33392' or
		substr(dx,1,4)='3575' or
		substr(dx,1,4)='4255' or
		substr(dx,1,4)='5353' or
		substr(dx,1,4)='5710' or
		substr(dx,1,4)='5711' or
		substr(dx,1,4)='5712' or
		substr(dx,1,4)='5713' or
		substr(dx,1,4)='6483' or
		substr(dx,1,4)='6484' or
		substr(dx,1,4)='6555' or
		substr(dx,1,5)='76071' or
		substr(dx,1,5)='76072' or
		substr(dx,1,5)='76073' or
		substr(dx,1,5)='76075' or
		substr(dx,1,4)='7795' or
		substr(dx,1,4)='7903' or
		substr(dx,1,3)='797' or 
		substr(dx,1,4)='9650' or
		substr(dx,1,4)='9800' or
		substr(dx,1,3)='E95' or
		substr(dx,1,3)='V11' or
		substr(dx,1,4)='V154' or
		substr(dx,1,5)='V1582' or
		substr(dx,1,3)='V40' or
		substr(dx,1,5)='V6284' or
		substr(dx,1,5)='V6285' or
		substr(dx,1,5)='V6542' or
		substr(dx,1,4)='V663' or
		substr(dx,1,4)='V673' or
		substr(dx,1,4)='V701' or
		substr(dx,1,4)='V702' or
		substr(dx,1,4)='V710' or
		substr(dx,1,3)='V79') 
		and any_dx_mental_ill=0 
		then any_dx_mental_ill=1;*set to 1 if not flagged already;
	end;

run;



proc sort data=ip_&suffix._2a;
by BID_hrs_21 id index_date;
run;

proc sql;
create table ip_&suffix._3a as select distinct bid_hrs_21,id,index_date,
/*total Hospital LOS*/
sum(adj_los) as n_hospd_&suffix. label="total hospital days &suffix."
from ip_&suffix._2a group by bid_hrs_21,id,index_date;
quit;

data ip_&suffix._2b;
set ip_&suffix._2a;
if win_start_dt<=admit_date<win_stop_dt;
em_urgent_admit=0; /*Urgent , emergent admissions from admission type*/
if type_adm in (1,2) then em_urgent_admit=1;
em_admit=0;
if type_adm=1 then em_admit=1;
urgent_admit=0;
if type_adm=2 then urgent_admit=1;
elect_admit=0;
if type_adm=3 then elect_admit=1;
ind_ed_charge=0; /*ED charges as another indicator of ED use*/
if ER_AMT>0 & ER_AMT~=. then ind_ed_charge=1;
if ER_AMT=0 | ER_AMT=. then ind_ed_charge=0;
run;

proc sql;
create table ip_&suffix._3b as select distinct bid_hrs_21,id,index_date,
/*total ICU days*/
sum(icu_days) as icu_days_&suffix. label="total icu days &suffix.",
/*count of IP admissions, all types*/
count(*) as n_ip_admit_&suffix. label="total n of hospital admit &suffix.",
/*count of admissions with any ED charges*/
count(case when ind_ed_charge=1 then ind_ed_charge else . end) as n_ED_ip_&suffix. 
	label="total n of ED visits with subsequent admit &suffix.",
/*count of admissions for mental illness, per admitting dx*/
count(case when adm_mental_ill=1 then adm_mental_ill else . end) as n_mental_ill_adm_dx_ip_&suffix. 
	label="total n of admissions admit dx=mental illness &suffix.",
/*count of admissions for mental illness, per any dx code*/
count(case when any_dx_mental_ill=1 then any_dx_mental_ill else . end) as n_mental_ill_any_dx_ip_&suffix. 
	label="total n of admissions with any dx of mental illness &suffix."
 from ip_&suffix._2b group by bid_hrs_21,id,index_date;
quit;

proc sql;
create table ip_&suffix._3 as select *
from ip_&suffix._3a a 
left join ip_&suffix._3b b
on a.bid_hrs_21=b.bid_hrs_21 and a.index_date=b.index_date;
quit;

data ip_&suffix.;
set ip_&suffix._3;
if icu_days_&suffix.>n_hospd_&suffix. then icu_days_&suffix.=n_hospd_&suffix.;
run;




proc sort data=ip_&suffix.; by bid_hrs_21 id index_date; run;

%mend;

/*****************************************************************************/
/*get admissions and ip ed visits from ip claims monthly post R's death*/
/*****************************************************************************/
%macro post_admissions(days_start=,days_aft_index=,suffix=);

/*pull list of ip claims from all medpar claims x days post-death*/
data ip_meet_&suffix._1a;
set proj_int.mp_meet_p24m(where=(trim(left(SSLSSNF))~="N"));
win_stop_dt=index_date+&days_aft_index;
win_start_dt=index_date+&days_start;
format admit_date disch_date win_stop_dt win_start_dt date9.;
run;

data ip_meet_&suffix._1;
set ip_meet_&suffix._1a;
if win_start_dt<=admit_date<=win_stop_dt or 
win_start_dt<=disch_date<=win_stop_dt;
run;

data ip_&suffix._2;
set ip_meet_&suffix._1;
if icarecnt=. then icarecnt=0; /*medpar intensive care day count*/
if CRNRYDAY=. then CRNRYDAY=0; /*medpar coronary day count*/
icu_days=icarecnt+CRNRYDAY;


/*truncate stays where the admit is before R's death
or discharge is after the x days after R's death so can get accurate LOS*/
admit_date2=admit_date;
disch_date2=disch_date;
if admit_date<win_start_dt then do;
	admit_date2=win_start_dt;
	admit_trunc=1;
	end;
if win_stop_dt<disch_date then do;
	disch_date2=win_stop_dt;
	disch_trunc=1;	
	end;
adj_los=disch_date2-admit_date2;
if disch_date-admit_date=0 then adj_los=1;
run;

/*determine if mental health dx is present in the IP claim*/
data ip_&suffix._2a;
set ip_&suffix._2;
/*determine if mental health dx is admitting dx for hospitalization*/
adm_mental_ill=0;

/*dx list from the AHRQ CCS Multi dx Tool, 2015, for Mental Illness Level 1 category*/
	if (substr(ad_dgns,1,3)='290' or
		substr(ad_dgns,1,3)='291' or
		substr(ad_dgns,1,3)='292' or
		substr(ad_dgns,1,3)='293' or
		substr(ad_dgns,1,3)='294' or
		substr(ad_dgns,1,3)='295' or
		substr(ad_dgns,1,3)='296' or
		substr(ad_dgns,1,3)='297' or
		substr(ad_dgns,1,3)='298' or
		substr(ad_dgns,1,3)='299' or
		substr(ad_dgns,1,3)='300' or
		substr(ad_dgns,1,3)='301' or
		substr(ad_dgns,1,3)='302' or
		substr(ad_dgns,1,3)='303' or
		substr(ad_dgns,1,3)='304' or
		substr(ad_dgns,1,3)='305' or
		substr(ad_dgns,1,3)='306' or
		substr(ad_dgns,1,3)='307' or
		substr(ad_dgns,1,3)='308' or
		substr(ad_dgns,1,3)='309' or
		substr(ad_dgns,1,3)='310' or
		substr(ad_dgns,1,3)='311' or
		substr(ad_dgns,1,3)='312' or
		substr(ad_dgns,1,3)='313' or
		substr(ad_dgns,1,3)='314' or
		substr(ad_dgns,1,3)='315' or
		substr(ad_dgns,1,3)='316' or
		substr(ad_dgns,1,3)='317' or
		substr(ad_dgns,1,3)='318' or
		substr(ad_dgns,1,3)='319' or
		substr(ad_dgns,1,4)='3310' or
		substr(ad_dgns,1,4)='3311' or
		substr(ad_dgns,1,4)='3312' or
		substr(ad_dgns,1,5)='33182' or
		substr(ad_dgns,1,5)='33392' or
		substr(ad_dgns,1,4)='3575' or
		substr(ad_dgns,1,4)='4255' or
		substr(ad_dgns,1,4)='5353' or
		substr(ad_dgns,1,4)='5710' or
		substr(ad_dgns,1,4)='5711' or
		substr(ad_dgns,1,4)='5712' or
		substr(ad_dgns,1,4)='5713' or
		substr(ad_dgns,1,4)='6483' or
		substr(ad_dgns,1,4)='6484' or
		substr(ad_dgns,1,4)='6555' or
		substr(ad_dgns,1,5)='76071' or
		substr(ad_dgns,1,5)='76072' or
		substr(ad_dgns,1,5)='76073' or
		substr(ad_dgns,1,5)='76075' or
		substr(ad_dgns,1,4)='7795' or
		substr(ad_dgns,1,4)='7903' or
		substr(ad_dgns,1,3)='797' or 
		substr(ad_dgns,1,4)='9650' or
		substr(ad_dgns,1,4)='9800' or
		substr(ad_dgns,1,3)='E95' or
		substr(ad_dgns,1,3)='V11' or
		substr(ad_dgns,1,4)='V154' or
		substr(ad_dgns,1,5)='V1582' or
		substr(ad_dgns,1,3)='V40' or
		substr(ad_dgns,1,5)='V6284' or
		substr(ad_dgns,1,5)='V6285' or
		substr(ad_dgns,1,5)='V6542' or
		substr(ad_dgns,1,4)='V663' or
		substr(ad_dgns,1,4)='V673' or
		substr(ad_dgns,1,4)='V701' or
		substr(ad_dgns,1,4)='V702' or
		substr(ad_dgns,1,4)='V710' or
		substr(ad_dgns,1,3)='V79') 
		and adm_mental_ill=0 
		then adm_mental_ill=1;*set to 1 if not flagged already;

	   /*now check if mental illness is any of the diagnoses present for the claim*/
any_dx_mental_ill=0;
array dx DGNS_CD01-DGNS_CD25 ;
do over dx;
	if (substr(dx,1,3)='290' or
		substr(dx,1,3)='291' or
		substr(dx,1,3)='292' or
		substr(dx,1,3)='293' or
		substr(dx,1,3)='294' or
		substr(dx,1,3)='295' or
		substr(dx,1,3)='296' or
		substr(dx,1,3)='297' or
		substr(dx,1,3)='298' or
		substr(dx,1,3)='299' or
		substr(dx,1,3)='300' or
		substr(dx,1,3)='301' or
		substr(dx,1,3)='302' or
		substr(dx,1,3)='303' or
		substr(dx,1,3)='304' or
		substr(dx,1,3)='305' or
		substr(dx,1,3)='306' or
		substr(dx,1,3)='307' or
		substr(dx,1,3)='308' or
		substr(dx,1,3)='309' or
		substr(dx,1,3)='310' or
		substr(dx,1,3)='311' or
		substr(dx,1,3)='312' or
		substr(dx,1,3)='313' or
		substr(dx,1,3)='314' or
		substr(dx,1,3)='315' or
		substr(dx,1,3)='316' or
		substr(dx,1,3)='317' or
		substr(dx,1,3)='318' or
		substr(dx,1,3)='319' or
		substr(dx,1,4)='3310' or
		substr(dx,1,4)='3311' or
		substr(dx,1,4)='3312' or
		substr(dx,1,5)='33182' or
		substr(dx,1,5)='33392' or
		substr(dx,1,4)='3575' or
		substr(dx,1,4)='4255' or
		substr(dx,1,4)='5353' or
		substr(dx,1,4)='5710' or
		substr(dx,1,4)='5711' or
		substr(dx,1,4)='5712' or
		substr(dx,1,4)='5713' or
		substr(dx,1,4)='6483' or
		substr(dx,1,4)='6484' or
		substr(dx,1,4)='6555' or
		substr(dx,1,5)='76071' or
		substr(dx,1,5)='76072' or
		substr(dx,1,5)='76073' or
		substr(dx,1,5)='76075' or
		substr(dx,1,4)='7795' or
		substr(dx,1,4)='7903' or
		substr(dx,1,3)='797' or 
		substr(dx,1,4)='9650' or
		substr(dx,1,4)='9800' or
		substr(dx,1,3)='E95' or
		substr(dx,1,3)='V11' or
		substr(dx,1,4)='V154' or
		substr(dx,1,5)='V1582' or
		substr(dx,1,3)='V40' or
		substr(dx,1,5)='V6284' or
		substr(dx,1,5)='V6285' or
		substr(dx,1,5)='V6542' or
		substr(dx,1,4)='V663' or
		substr(dx,1,4)='V673' or
		substr(dx,1,4)='V701' or
		substr(dx,1,4)='V702' or
		substr(dx,1,4)='V710' or
		substr(dx,1,3)='V79') 
		and any_dx_mental_ill=0 
		then any_dx_mental_ill=1;*set to 1 if not flagged already;
	end;

run;


proc sort data=ip_&suffix._2a;
by BID_hrs_21 id index_date;
run;

proc sql;
create table ip_&suffix._3a as select distinct bid_hrs_21,id,index_date,
/*total Hospital LOS*/
sum(adj_los) as n_hospd_&suffix. label="total hospital days &suffix."
from ip_&suffix._2a group by bid_hrs_21,id,index_date;
quit;

data ip_&suffix._2b;
set ip_&suffix._2a;
if win_start_dt<admit_date<=win_stop_dt;
em_urgent_admit=0; /*Urgent , emergent admissions from admission type*/
if type_adm in (1,2) then em_urgent_admit=1;
em_admit=0;
if type_adm=1 then em_admit=1;
urgent_admit=0;
if type_adm=2 then urgent_admit=1;
elect_admit=0;
if type_adm=3 then elect_admit=1;
ind_ed_charge=0; /*ED charges as another indicator of ED use*/
if ER_AMT>0 & ER_AMT~=. then ind_ed_charge=1;
if ER_AMT=0 | ER_AMT=. then ind_ed_charge=0;
run;

proc sql;
create table ip_&suffix._3b as select distinct bid_hrs_21,id,index_date,
/*count of IP admissions, all types*/
count(*) as n_ip_admit_&suffix. label="total n of hospital admit &suffix.",
/*count of admissions with any ED charges*/
count(case when ind_ed_charge=1 then ind_ed_charge else . end) as n_ED_ip_&suffix. 
	label="total n of ED visits with subsequent admit &suffix.",
/*total ICU days*/
sum(icu_days) as icu_days_&suffix. label="total icu days &suffix.",
/*count of admissions for mental illness, per admitting dx*/
count(case when adm_mental_ill=1 then adm_mental_ill else . end) as n_mental_ill_adm_dx_ip_&suffix. 
	label="total n of admissions admit dx=mental illness &suffix.",
/*count of admissions for mental illness, per any dx code*/
count(case when any_dx_mental_ill=1 then any_dx_mental_ill else . end) as n_mental_ill_any_dx_ip_&suffix. 
	label="total n of admissions with any dx of mental illness &suffix."
 from ip_&suffix._2b group by bid_hrs_21,id,index_date;
quit;

proc sql;
create table ip_&suffix._3 as select *
from ip_&suffix._3a a 
left join ip_&suffix._3b b
on a.bid_hrs_21=b.bid_hrs_21 and a.index_date=b.index_date;
quit;

data ip_&suffix.;
set ip_&suffix._3;
if icu_days_&suffix.>n_hospd_&suffix. then icu_days_&suffix.=n_hospd_&suffix.;
run;



proc sort data=ip_&suffix.; by bid_hrs_21 id index_date; run;

%mend;



/*****************************************************************************/
/*get outpatient visits and ed use from op claims monthly pre and post R's death*/
/*****************************************************************************/
%macro op(days=,suffix=);

data op_meet_&suffix.;
set proj_int.op_meet&suffix.(keep=bid_hrs_21 id admit_date disch_date 
	index_date RVCNTR01-RVCNTR45);
run;

proc sort data=op_meet_&suffix.; by bid_hrs_21 id admit_date; run;

data ed_op_&suffix._1;
set op_meet_&suffix.;
ed_op=0;
array list RVCNTR01-RVCNTR45;
do over list;
	if list >= 450 and list < 460 and ed_op=0 then  
	ed_op = 1;
	end;
run;



proc sql;
create table op_&suffix. as select distinct bid_hrs_21,id,index_date,
count(case when ed_op=1 then ed_op else . end)
	as n_ed_op_visits_&suffix. label="n of OP ED visits &suffix.",
count(*) as n_op_visits_&suffix. label="n OP visits &suffix."
	from ed_op_&suffix._1 group by bid_hrs_21,id,index_date;
quit;


proc sort data=op_&suffix.; by bid_hrs_21 id index_date; run;

%mend;

%macro claims_nesting();

%do i=1 %to 24 ;
%pre_admissions(days_start=floor((&i.-1)*30.417),days_bef_index=floor(&i.*30.417), suffix=m&i.,su=m&i.);
%post_admissions(days_start=floor((&i.-1)*30.417),days_aft_index=floor(&i.*30.417),suffix=m&i.p);
%op(suffix=m&i.);
%op(suffix=m&i.p);
%end;
%mend;
%claims_nesting();

data ip_meet_24m;
set proj_int.ip_meet_24m;
run;

%pre_admissions(days_start=-1,days_bef_index=0,suffix=dod,su=_24m);
proc sql;
create table op_meet_dod1 as select * from
index a 
left join medi.op_2000_2012 b
on a.bid_hrs_21=b.bid_hrs_21 and a.index_date=b.admit_date;
quit;

data op_meet_dod;
set op_meet_dod1(keep=bid_hrs_21 id admit_date disch_date 
	index_date RVCNTR01-RVCNTR45);
run;
data op_meet_doda;
set op_meet_dod(where=(admit_date=index_date));
run;
proc sort data=op_meet_doda; by bid_hrs_21 id admit_date; run;

data ed_op_dod_1;
set op_meet_doda;
ed_op=0;
array list RVCNTR01-RVCNTR45;
do over list;
	if list >= 450 and list < 460 and ed_op=0 then  
	ed_op = 1;
	end;
run;


proc sql;
create table op_0 as select distinct bid_hrs_21,id,index_date,
count(case when ed_op=1 then ed_op else . end)
	as n_ed_op_visits_index_date label="n of OP ED visits index_date",
count(*) as n_op_visits_index_date label="n OP visits index_date"
	from ed_op_dod_1 group by bid_hrs_21,id,index_date;
quit;


proc sort data=op_0; by bid_hrs_21 id index_date; run;

data ip_0;
set ip_dod;
run;

proc sort data=ip_0; by bid_hrs_21 id index_date; run;
%macro claims_all(source=);
data &source._all_1;
merge &source._0 &source._m1 &source._m1p;
by bid_hrs_21 id index_date;
run;


%do i=2 %to 24 ;
%let l=%eval(&i-1);
data &source._all_&i.;
merge &source._all_&l. &source._m&i. &source._m&i.p;
by bid_hrs_21 id index_date;
run;
%end;

data &source._all;
set &source._all_24;
run;

%mend;

%claims_all(source=ip);
%claims_all(source=op);


proc sql;
create table ip as select a.*,b.admit_date from
proj_int.index a 
left join
medi.mp_2000_2012 b
on a.bid_hrs_21=b.bid_hrs_21 and a.index_date=b.admit_date;
quit;

data admit_index(drop=admit_date);
set ip;
admit_on_index=index_date=admit_date;
run;


/*now bring in to list of obs with ffs medicare at R's death*/
proc sql;
create table add_ip(drop=id2) as select 
a.bid_hrs_21,a.id,b.*,c.admit_on_index
from proj_int.index a
left join
ip_all(rename=(id=id2)) b
on trim(left(a.bid_hrs_21))=trim(left(b.bid_hrs_21)) and a.id=b.id2 and a.index_date=b.index_date
left join 
admit_index c
on a.bid_hrs_21=c.bid_hrs_21;
quit;

proc sql;
create table proj_int.op_ip_monthly(drop=id2) as select *
from add_ip a
left join
op_all(rename=(id=id2)) b
 on trim(left(a.bid_hrs_21))=trim(left(b.bid_hrs_21)) and a.id=b.id2 and a.index_date=b.index_date;
 quit;



H="get utilization 12m prior for high util"




/*additional outcome variables

Spouse - monthly pre and post R's death:
Hospital # visits
Hospital nights
# ED visits
# OP visits*/


/*get spouse medicare costs by claim type and total, adjusted for inflation
to 2012$, monthly, 24m before and after R's death

begins with claims lists from "Get S MC claims lists..." section

final dataset is proj_int.hrs_elix_cc_pay*/

proc sort data=proj_int.index out=index1 nodupkey;
by bid_hrs_21 index_date;
run;



/*****************************************************************************/
/*get admissions and ip ed visits from ip claims monthly pre R's death*/
/*****************************************************************************/




%macro pre_admissions(days_start=,days_bef_index=,suffix=,su=);

proc sql; 
create table ip_meet_12m as select * from
proj_int.index a 
left join
proj_int.mp_meet_24m b
on a.bid_hrs_21=b.bid_hrs_21 and a.is_admit_date-365<=b.admit_date<a.is_admit_date;
quit;

/*pull list of ip claims from all medpar claims x days pre-death*/
data ip_meet_&suffix._1a;
set ip_meet_12m(where=(trim(left(SSLSSNF))~="N"));
win_start_dt=is_admit_date-365;
win_stop_dt=is_admit_date;
format admit_date disch_date win_start_dt win_stop_dt date9.;
run;

data ip_meet_&suffix._1;
set ip_meet_&suffix._1a;
if win_start_dt<=admit_date<=win_stop_dt or 
win_start_dt<=disch_date<=win_stop_dt;
run;

data ip_&suffix._2;
set ip_meet_&suffix._1;
if icarecnt=. then icarecnt=0; /*medpar intensive care day count*/
if CRNRYDAY=. then CRNRYDAY=0; /*medpar coronary day count*/
icu_days=icarecnt+CRNRYDAY;


/*truncate stays where the admit is before x days pre- R's death
or discharge is after R's death so can get accurate LOS*/
admit_date2=admit_date;
disch_date2=disch_date;
if admit_date<win_start_dt then do;
	admit_date2=win_start_dt;
	admit_trunc=1;
	end;
if win_stop_dt <disch_date then do;
	disch_date2=win_stop_dt;
	disch_trunc=1;	
	end;
adj_los=disch_date2-admit_date2;
if disch_date-admit_date=0 then adj_los=1;
run;

/*determine if mental health dx is present*/
data ip_&suffix._2a;
set ip_&suffix._2;
/*first, check if mental health is the admitting diagnosis*/
adm_mental_ill=0;

/*dx list from the AHRQ CCS Multi dx Tool, 2015, for Mental Illness Level 1 category*/
	if (substr(ad_dgns,1,3)='290' or
		substr(ad_dgns,1,3)='291' or
		substr(ad_dgns,1,3)='292' or
		substr(ad_dgns,1,3)='293' or
		substr(ad_dgns,1,3)='294' or
		substr(ad_dgns,1,3)='295' or
		substr(ad_dgns,1,3)='296' or
		substr(ad_dgns,1,3)='297' or
		substr(ad_dgns,1,3)='298' or
		substr(ad_dgns,1,3)='299' or
		substr(ad_dgns,1,3)='300' or
		substr(ad_dgns,1,3)='301' or
		substr(ad_dgns,1,3)='302' or
		substr(ad_dgns,1,3)='303' or
		substr(ad_dgns,1,3)='304' or
		substr(ad_dgns,1,3)='305' or
		substr(ad_dgns,1,3)='306' or
		substr(ad_dgns,1,3)='307' or
		substr(ad_dgns,1,3)='308' or
		substr(ad_dgns,1,3)='309' or
		substr(ad_dgns,1,3)='310' or
		substr(ad_dgns,1,3)='311' or
		substr(ad_dgns,1,3)='312' or
		substr(ad_dgns,1,3)='313' or
		substr(ad_dgns,1,3)='314' or
		substr(ad_dgns,1,3)='315' or
		substr(ad_dgns,1,3)='316' or
		substr(ad_dgns,1,3)='317' or
		substr(ad_dgns,1,3)='318' or
		substr(ad_dgns,1,3)='319' or
		substr(ad_dgns,1,4)='3310' or
		substr(ad_dgns,1,4)='3311' or
		substr(ad_dgns,1,4)='3312' or
		substr(ad_dgns,1,5)='33182' or
		substr(ad_dgns,1,5)='33392' or
		substr(ad_dgns,1,4)='3575' or
		substr(ad_dgns,1,4)='4255' or
		substr(ad_dgns,1,4)='5353' or
		substr(ad_dgns,1,4)='5710' or
		substr(ad_dgns,1,4)='5711' or
		substr(ad_dgns,1,4)='5712' or
		substr(ad_dgns,1,4)='5713' or
		substr(ad_dgns,1,4)='6483' or
		substr(ad_dgns,1,4)='6484' or
		substr(ad_dgns,1,4)='6555' or
		substr(ad_dgns,1,5)='76071' or
		substr(ad_dgns,1,5)='76072' or
		substr(ad_dgns,1,5)='76073' or
		substr(ad_dgns,1,5)='76075' or
		substr(ad_dgns,1,4)='7795' or
		substr(ad_dgns,1,4)='7903' or
		substr(ad_dgns,1,3)='797' or 
		substr(ad_dgns,1,4)='9650' or
		substr(ad_dgns,1,4)='9800' or
		substr(ad_dgns,1,3)='E95' or
		substr(ad_dgns,1,3)='V11' or
		substr(ad_dgns,1,4)='V154' or
		substr(ad_dgns,1,5)='V1582' or
		substr(ad_dgns,1,3)='V40' or
		substr(ad_dgns,1,5)='V6284' or
		substr(ad_dgns,1,5)='V6285' or
		substr(ad_dgns,1,5)='V6542' or
		substr(ad_dgns,1,4)='V663' or
		substr(ad_dgns,1,4)='V673' or
		substr(ad_dgns,1,4)='V701' or
		substr(ad_dgns,1,4)='V702' or
		substr(ad_dgns,1,4)='V710' or
		substr(ad_dgns,1,3)='V79') 
		and adm_mental_ill=0 
		then adm_mental_ill=1;*set to 1 if not flagged already;

	   /*now check if mental illness is any of the diagnoses present for the claim*/
any_dx_mental_ill=0;
array dx DGNS_CD01-DGNS_CD25 ;
do over dx;
	if (substr(dx,1,3)='290' or
		substr(dx,1,3)='291' or
		substr(dx,1,3)='292' or
		substr(dx,1,3)='293' or
		substr(dx,1,3)='294' or
		substr(dx,1,3)='295' or
		substr(dx,1,3)='296' or
		substr(dx,1,3)='297' or
		substr(dx,1,3)='298' or
		substr(dx,1,3)='299' or
		substr(dx,1,3)='300' or
		substr(dx,1,3)='301' or
		substr(dx,1,3)='302' or
		substr(dx,1,3)='303' or
		substr(dx,1,3)='304' or
		substr(dx,1,3)='305' or
		substr(dx,1,3)='306' or
		substr(dx,1,3)='307' or
		substr(dx,1,3)='308' or
		substr(dx,1,3)='309' or
		substr(dx,1,3)='310' or
		substr(dx,1,3)='311' or
		substr(dx,1,3)='312' or
		substr(dx,1,3)='313' or
		substr(dx,1,3)='314' or
		substr(dx,1,3)='315' or
		substr(dx,1,3)='316' or
		substr(dx,1,3)='317' or
		substr(dx,1,3)='318' or
		substr(dx,1,3)='319' or
		substr(dx,1,4)='3310' or
		substr(dx,1,4)='3311' or
		substr(dx,1,4)='3312' or
		substr(dx,1,5)='33182' or
		substr(dx,1,5)='33392' or
		substr(dx,1,4)='3575' or
		substr(dx,1,4)='4255' or
		substr(dx,1,4)='5353' or
		substr(dx,1,4)='5710' or
		substr(dx,1,4)='5711' or
		substr(dx,1,4)='5712' or
		substr(dx,1,4)='5713' or
		substr(dx,1,4)='6483' or
		substr(dx,1,4)='6484' or
		substr(dx,1,4)='6555' or
		substr(dx,1,5)='76071' or
		substr(dx,1,5)='76072' or
		substr(dx,1,5)='76073' or
		substr(dx,1,5)='76075' or
		substr(dx,1,4)='7795' or
		substr(dx,1,4)='7903' or
		substr(dx,1,3)='797' or 
		substr(dx,1,4)='9650' or
		substr(dx,1,4)='9800' or
		substr(dx,1,3)='E95' or
		substr(dx,1,3)='V11' or
		substr(dx,1,4)='V154' or
		substr(dx,1,5)='V1582' or
		substr(dx,1,3)='V40' or
		substr(dx,1,5)='V6284' or
		substr(dx,1,5)='V6285' or
		substr(dx,1,5)='V6542' or
		substr(dx,1,4)='V663' or
		substr(dx,1,4)='V673' or
		substr(dx,1,4)='V701' or
		substr(dx,1,4)='V702' or
		substr(dx,1,4)='V710' or
		substr(dx,1,3)='V79') 
		and any_dx_mental_ill=0 
		then any_dx_mental_ill=1;*set to 1 if not flagged already;
	end;

run;



proc sort data=ip_&suffix._2a;
by BID_hrs_21 id index_date;
run;

proc sql;
create table ip_&suffix._3a as select distinct bid_hrs_21,id,index_date,
/*total Hospital LOS*/
sum(adj_los) as n_hospd_&suffix. label="total hospital days &suffix."
from ip_&suffix._2a group by bid_hrs_21,id,index_date;
quit;

data ip_&suffix._2b;
set ip_&suffix._2a;
if win_start_dt<=admit_date<win_stop_dt;
em_urgent_admit=0; /*Urgent , emergent admissions from admission type*/
if type_adm in (1,2) then em_urgent_admit=1;
em_admit=0;
if type_adm=1 then em_admit=1;
urgent_admit=0;
if type_adm=2 then urgent_admit=1;
elect_admit=0;
if type_adm=3 then elect_admit=1;
ind_ed_charge=0; /*ED charges as another indicator of ED use*/
if ER_AMT>0 & ER_AMT~=. then ind_ed_charge=1;
if ER_AMT=0 | ER_AMT=. then ind_ed_charge=0;
run;

proc sql;
create table ip_&suffix._3b as select distinct bid_hrs_21,id,index_date,
/*total ICU days*/
sum(icu_days) as icu_days_&suffix. label="total icu days &suffix.",
/*count of IP admissions, all types*/
count(*) as n_ip_admit_&suffix. label="total n of hospital admit &suffix.",
/*count of admissions with any ED charges*/
count(case when ind_ed_charge=1 then ind_ed_charge else . end) as n_ED_ip_&suffix. 
	label="total n of ED visits with subsequent admit &suffix.",
/*count of admissions for mental illness, per admitting dx*/
count(case when adm_mental_ill=1 then adm_mental_ill else . end) as n_mental_ill_adm_dx_ip_&suffix. 
	label="total n of admissions admit dx=mental illness &suffix.",
/*count of admissions for mental illness, per any dx code*/
count(case when any_dx_mental_ill=1 then any_dx_mental_ill else . end) as n_mental_ill_any_dx_ip_&suffix. 
	label="total n of admissions with any dx of mental illness &suffix."
 from ip_&suffix._2b group by bid_hrs_21,id,index_date;
quit;

proc sql;
create table ip_&suffix._3 as select *
from ip_&suffix._3a a 
left join ip_&suffix._3b b
on a.bid_hrs_21=b.bid_hrs_21 and a.index_date=b.index_date;
quit;

data ip_&suffix.;
set ip_&suffix._3;
if icu_days_&suffix.>n_hospd_&suffix. then icu_days_&suffix.=n_hospd_&suffix.;
run;




proc sort data=ip_&suffix.; by bid_hrs_21 id index_date; run;

%mend;


/*****************************************************************************/
/*get outpatient visits and ed use from op claims monthly pre and post R's death*/
/*****************************************************************************/
%macro op(days=,suffix=);

proc sql; 
create table op_meet_12m as select * from
proj_int.index a 
left join
proj_int.op_meet_24m b
on a.bid_hrs_21=b.bid_hrs_21 and a.is_admit_date<=b.admit_date<a.is_admit_date;
quit;

data op_meet_&suffix.;
set proj_int.op_meet_12m(keep=bid_hrs_21 id admit_date disch_date 
	index_date RVCNTR01-RVCNTR45);
run;

proc sort data=op_meet_&suffix.; by bid_hrs_21 id admit_date; run;

data ed_op_&suffix._1;
set op_meet_&suffix.;
ed_op=0;
array list RVCNTR01-RVCNTR45;
do over list;
	if list >= 450 and list < 460 and ed_op=0 then  
	ed_op = 1;
	end;
run;



proc sql;
create table op_&suffix. as select distinct bid_hrs_21,id,index_date,
count(case when ed_op=1 then ed_op else . end)
	as n_ed_op_visits_&suffix. label="n of OP ED visits &suffix.",
count(*) as n_op_visits_&suffix. label="n OP visits &suffix."
	from ed_op_&suffix._1 group by bid_hrs_21,id,index_date;
quit;


proc sort data=op_&suffix.; by bid_hrs_21 id index_date; run;

%mend;

%pre_admissions(days_start=floor(12m),days_bef_index=floor(365), suffix=12m,su=12m.);
%op(days=365,suffix=12m);




/*now bring in to list of obs with ffs medicare at R's death*/
proc sql;
create table proj_int.op_ip_12m as select 
a.bid_hrs_21,a.id,b.*,c.*
from proj_int.index a
left join
ip_12m b
on trim(left(a.bid_hrs_21))=trim(left(b.bid_hrs_21)) and a.id=b.id and a.index_date=b.index_date
left join 
op_12m c
on a.bid_hrs_21=c.bid_hrs_21;
quit;

proc freq; tables n_ip_admit_12m; run;


H="regional data"
/*get zip code for index year, also get birth date*/

data index1;
set proj_int.index;
index_year=year(index_date);
run;

data trackera;
set hrs_cln.restr_tracker_v2012(keep=id hhid pn birth_date zip:stateusps:);
if id~=.;
rename zip10_2010=ZIP10;
drop zip10_2000 zip92-zip96 stateusps92-stateusps96;
drop id;
run;

data trackerb(drop=hhid pn);
set trackera;
ZIP01=ZIP00;
zip03=zip02;
zip05=zip04;
zip07=zip08;
zip09=zip08;
zip11=ZIP10;
stateusps01=stateusps00;
stateusps03=stateusps02;
stateusps05=stateusps04;
stateusps07=stateusps08;
stateusps09=stateusps08;
stateusps11=stateusps10;
id=hhid||pn;
run;

data trackerc;
set trackerb;
if zip00='' then zip00=zip98;
if zip02='' then zip02=zip00;
if zip04='' then zip04=zip02;
if zip06='' then zip06=zip04;
if zip08='' then zip08=zip06;
if zip10='' then zip10=zip08;
if zip12='' then zip12=zip10;
if zip01='' then zip01=zip02;
if zip03='' then zip03=zip04;
if zip05='' then zip05=zip06;
if zip07='' then zip07=zip08;
if zip09='' then zip09=zip10;
if zip11='' then zip11=zip12;
if stateusps00='' then stateusps00=stateusps98;
if stateusps02='' then stateusps02=stateusps00;
if stateusps04='' then stateusps04=stateusps02;
if stateusps06='' then stateusps06=stateusps04;
if stateusps08='' then stateusps08=stateusps06;
if stateusps10='' then stateusps10=stateusps08;
if stateusps12='' then stateusps12=stateusps10;
if stateusps01='' then stateusps01=stateusps02;
if stateusps03='' then stateusps03=stateusps04;
if stateusps05='' then stateusps05=stateusps06;
if stateusps07='' then stateusps07=stateusps08;
if stateusps09='' then stateusps09=stateusps10;
if stateusps11='' then stateusps11=stateusps12;
run;

proc sort data=trackerc out=tracker;
by id;
run;

proc transpose data=tracker out=tracker1;
by id;
var zip00-zip12;
run;

data tracker2(keep=id zip index_year);
set tracker1(rename=(col1=zip1));
index_year=input(substr(_name_,4),5.)+2000;
zip=zip1+0;
run;

proc transpose data=tracker out=tracker3;
by id;
var stateusps00-stateusps12;
run;

data tracker4(keep=id stateusps index_year);
set tracker3(rename=(col1=stateusps));
index_year=input(substr(_name_,10),5.)+2000;
run;

proc sql;
create table zipa as select * from
index1 a 
left join tracker2 b
on a.id=b.id and a.index_year=b.index_year
left join tracker4 c
on a.id=c.id and a.index_year=c.index_year;
quit;

proc sql;
create table zip as select a.*,b.birth_date from
zipa a
left join tracker b
on a.id=b.id;
quit;

data zip_cb;
set dartm.xtract(keep=zip5 cbsa state metrodiv);
if metrodiv~='' then cbsa=metrodiv;
zip_n=zip5+0;
cbsa_n=cbsa+0;
/*If zip code is not missing, add state code*/
if zip_n~=.;
state_n=state+0;
run;

proc sort data=zip_cb out=zip_cb2 nodupkey;
by zip_n cbsa_n;
run;

/*note several zip codes have multiple cbsa*/
/*create dataset with just one entry for each zip code
8029 zip codes have more than one cbsa code
Just use the first one when sort*/
proc sort data=zip_cb2 out=cbsa_zip_final nodupkey;
by zip_n;
run;

*Check to see zip codes in a cbsa code for Rochester, NY;
proc sql;
select zip_n, cbsa from cbsa_zip_final
where cbsa_n in (40380);
quit;



/*bring in 2012 wage index file*/
data wage_index;
set dart_wi.wage_index_2012;
run;

/*for zip codes with no cbsa, wage index is left missing
there are also many cbsas with missing wage index*/
proc sql;
create table zip_cbsa_wage_index as
select a.*,b.wage_index_2012 from
cbsa_zip_final a
left join
wage_index b
on a.cbsa_n=b.cbsa_n;
quit;

/*Check for and remove duplicates by zip, keep first entry*/
proc sort data=zip_cbsa_wage_index out=zip_cbsa_wage_index2 nodupkey;
by zip_n;
run;

/******************************************************************/
/* Merge the wage index into the interview dataset by the cleaned zip */
/******************************************************************/

proc sql;
create table zip_wi as select a.*,b.wage_index_2012 from 
zip a 
left join
zip_cbsa_wage_index2 b
on a.zip=b.zip_n;
quit;


/*n=76792 ivws are missing the wage index when matched just by zip*/
data miss_wi;
set zip_wi;
if wage_index_2012 =.;
run;

/******************************************************************/
/* Bring in  WI by state if missing by zip (b/c not in a metro area) */
/******************************************************************/
proc sort data=wage_index out=wage_index3 nodupkey;
by state_in_wage_index;
run;

data wage_index4; set wage_index3; if state_in_wage_index~='';
run;


/*Merges in wage index if there's one for the state but was missing for the zip*/
proc sql;
create table zip_wi_2
as select a.*,coalesce(a.wage_index_2012,b.wage_index_2012) as wage_index_2012_2
from
zip_wi a
left join
wage_index4 b
on a.stateusps=b.ST;
quit;

/*check for missing values*/
proc means;
var wage_index_2012 wage_index_2012_2;
run;



data proj_int.zip_wi;
set zip_wi_2;
/* create census regions */
if stateusps in ('CT','ME','MA','NH','RI','VT','NJ','NY','PA') then REGION=1;
   else if stateusps in ('IN','IL','MI','OH','WI','IA','KS','MN','MO','NE','ND','SD') then REGION=2;
   else if stateusps in ('DE','DC','FL','GA','MD','NC','SC','VA','WV','AL','KY','MS','TN',
        'AR','LA','OK','TX' ) then REGION=3;
   else if stateusps in ('AZ','CO','ID','NM','MT','UT','NV','WY','AK','CA','HI','OR','WA') then REGION=4;
/*create census divisions */
if stateusps in ('CT','ME','MA','NH','RI','VT') then DIVISION=1;
   else if stateusps in ('NJ','NY','PA') then DIVISION=2;
   else if stateusps in ('IN','IL','MI','OH','WI') then DIVISION=3;
   else if stateusps in ('IA','KS','MN','MO','NE','ND','SD') then DIVISION=4;
   else if stateusps in ('DE','DC','FL','GA','MD','NC','SC','VA','WV') then DIVISION=5;
   else if stateusps in ('AL','KY','MS','TN') then DIVISION=6;
   else if stateusps in ('AR','LA','OK','TX' ) then DIVISION=7;
   else if stateusps in ('AZ','CO','ID','NM','MT','UT','NV','WY') then DIVISION=8;
   else if stateusps in ('AK','CA','HI','OR','WA') then DIVISION=9;

/* create medicaid eligibility groupings: =>138% or <138% */
if stateusps in ('AL','AK','FL','GA','ID','KS','LA','ME','MS','MO','MT','NE','NC',
        'OK','SC','SD','TN','TX','UT','VA','WI','WY') then MEDICAID_138=0;
   else if stateusps in ('AR','AZ','CA','CO','CT','DE','DC','HI','IN','IL','IA',
        'KY','MA','MI','MN','MD','NH','ND','NM','NV','NJ','NY','OH','OR','PA',
        'RI','VT','WV','WA') then MEDICAID_138=1;
label region='Census Region: 1=NE,2=MW,3=S,4=W';
label division='Census Division';
label medicaid_138='Medicaid eligibility GE 138% FPL';
run;



H="get specific eolc outcomes"
/*get measures of EOL care

IP-
ICU last 30days pre death
ED last 30 days pre death
days in hospital last year
days in hospital last year after surgery
death in hospital

OP-
ED last 30 days pre death

HS-
days in hospice total
days in hospice after surgery

*/

data index;
set proj_int.index;
if death_date~=. and death_date<index_date+365;
run;

proc sql;
create table ip as select * from
index a
left join 
medi.mp_2000_2012 b
on a.bid_hrs_21=b.bid_hrs_21 and a.death_date<=disch_date+365 and a.death_date>=b.admit_date;
quit;

data ip2;
set ip;
if sslssnf~="N";
if icarecnt=. then icarecnt=0; /*medpar intensive care day count*/
if CRNRYDAY=. then CRNRYDAY=0; /*medpar coronary day count*/
icu_days=icarecnt+CRNRYDAY;
if (death_date-disch_date)>30 then icu_days=0;
er_charge=er_amt>0 and er_amt~=.;
if (death_date-admit_date)>30 then er_charge=0;
los_ly=disch_date-admit_date+1;
if (death_date-365)>admit_date then los_ly=disch_date-(death_date-365);
los_postsurg=disch_date-admit_date+1;
if (death_date-30)>admit_date then los_postsurg=disch_date-(death_date-30);
if los_ly<0 then los_ly=0;
if los_postsurg<0 then los_postsurg=0;
dead=dschrgcd="B";
run;

proc sql;
create table ip3 as select distinct bid_hrs_21,
sum(icu_days) as n_icu_lastm,
sum(er_charge) as n_er_charge,
sum(los_ly) as n_hosp_days_last_year,
sum(los_postsurg) as n_hosp_days_postsurg,
sum(dead) as died_in_hospital
from ip2 group by bid_hrs_21;
quit;

proc sql;
create table op as select * from
index a
left join 
proj_int.op_meet_p24m b
on a.bid_hrs_21=b.bid_hrs_21 and a.death_date-30<=b.admit_date;
quit;

data op2;
set op;
ed_op=0;
array list RVCNTR01-RVCNTR45;
do over list;
	if list >= 450 and list < 460 and ed_op=0 then  
	ed_op = 1;
	end;
run;

proc sql;
create table op3 as select distinct bid_hrs_21,
sum(ed_op) as n_ed_op
from op2 group by bid_hrs_21;
quit;

proc sql;
create table hs as select * from
index a
left join 
medi.hs_2000_2012 b
on a.bid_hrs_21=b.bid_hrs_21;
quit;

data hs2;
set hs;
days_hs=disch_date-admit_date+1;
days_hs_postsurg=days_hs;
if admit_date<index_date then days_hs_postsurg=disch_date-index_date+1;
run;

proc sql;
create table hs3 as select distinct bid_hrs_21, 
sum(days_hs) as n_hs_days_tot,
sum(days_hs_postsurg) as n_hs_days_postsurg
from hs2 group by bid_hrs_21;
quit;

proc sql;
create table allm as select * from
proj_int.index a
left join 
ip3 b
on a.bid_hrs_21=b.bid_hrs_21
left join
op3 c
on a.bid_hrs_21=c.bid_hrs_21
left join
hs3 d
on a.bid_hrs_21=d.bid_hrs_21;
quit;

data proj_int.eol_measures (drop=n_icu_lastm n_er_charge n_ed_op);
set allm;
ind_icu_30d_pre_death=n_icu_lastm>0;
ind_ed_30d_pre_death=(n_er_charge+n_ed_op)>0;
if n_hosp_days_last_year<0 then n_hosp_days_last_year=0;
if n_hosp_days_postsurg<0 then n_hosp_days_postsurg=0;
if n_hs_days_tot<0 then n_hs_days_tot=0;
if n_hs_days_postsurg<0 then n_hs_days_postsurg=0;
run;



H="postsurg outcomes instead"
/*get measures of EOL care
2/7/17-note: switch so that outcomes are looking at post discharge instead of post procedure
IP-
ICU last 30days pre death
ED last 30 days pre death
days in hospital last year
days in hospital last year after surgery
death in hospital

OP-
ED last 30 days pre death

HS-
days in hospice total
days in hospice after surgery

*/

data index;
set proj_int.index;
run;
proc sql;
create table ipa as select * from
index a
left join 
medi.mp_2000_2012 b
on a.bid_hrs_21=b.bid_hrs_21 and b.admit_date<=a.index_date<=b.disch_date;
quit;

data ipa2;
set ipa;
if sslssnf~="N";
los_aftsurg=disch_date-index_date;
los_befsurg=index_date-admit_date;
status_died=dschrgcd="B";
destination_died=indexc(dstntncd,"20","40","41","42")~=0;
disch_not_home=indexc(dstntncd,"01")=0;
run;

proc sql;
create table ip as select * from
index a
left join 
medi.mp_2000_2012 b
on a.bid_hrs_21=b.bid_hrs_21 and a.is_disch_date<=b.admit_date 
and a.is_disch_date<b.disch_date and a.is_disch_date+365>=b.admit_date;
quit;

data ip2a;
set ip;
if sslssnf~="N";
if icarecnt=. then icarecnt=0; /*medpar intensive care day count*/
if CRNRYDAY=. then CRNRYDAY=0; /*medpar coronary day count*/
icu_days=icarecnt+CRNRYDAY;
er_charge=er_amt>0 and er_amt~=.;
if disch_date>is_disch_date+365 then disch_date=is_disch_date+365;
los_postsurg=disch_date-admit_date+1;
if icarecnt>0 or crnryday>0 then icu_admit=admit_date;
if er_charge>0 then er_admit=admit_date;
admit_date2=admit_date;
dead=dschrgcd="B";
run;

data ip2;
set ip2a ipa2;
run;
proc sql;
create table ip3 as select distinct bid_hrs_21,
sum(icu_days) as n_icu_lastm,
sum(er_charge) as n_er_charge,
sum(los_postsurg) as n_hosp_days_postsurg_postindex,
sum(los_aftsurg) as n_hosp_days_postsurg_index,
sum(los_befsurg) as n_hosp_days_presurg_index,
sum(dead) as died_in_hospital,
sum(status_died) as died_index_stay,
sum(destination_died) as died_index_destination,
sum(disch_not_home) as disch_not_home,
min(icu_admit) as first_icu,
min(admit_date2) as first_readmit,
min(er_admit) as first_inp_er
from ip2 group by bid_hrs_21;
quit;

proc sql;
create table op as select * from
index a
left join 
proj_int.op_meet_p24m b
on a.bid_hrs_21=b.bid_hrs_21 and a.is_disch_date<b.admit_date
and a.is_disch_date+365>=b.admit_date;
quit;

data op2;
set op;
ed_op=0;
array list RVCNTR01-RVCNTR45;
do over list;
	if list >= 450 and list < 460 and ed_op=0 then  
	ed_op = 1;
	end;
if ed_op=1 then er_admit=admit_date;
run;

proc sql;
create table op3 as select distinct bid_hrs_21,
sum(ed_op) as n_ed_op,
min(er_admit) as first_er
from op2 group by bid_hrs_21;
quit;

proc sql;
create table hs as select * from
index a
left join 
medi.hs_2000_2012 b
on a.bid_hrs_21=b.bid_hrs_21 and a.is_disch_date<b.admit_date
and a.is_disch_date+365>=b.admit_date;
quit;

data hs2;
set hs;
if disch_date>is_disch_date+365 then disch_date=is_disch_date+365;
days_hs=disch_date-admit_date+1;
days_hs_postsurg=days_hs;
if admit_date<is_disch_date then days_hs_postsurg=disch_date-is_disch_date+1;
run;

proc sql;
create table hs3 as select distinct bid_hrs_21, 
sum(days_hs) as n_hs_days_tot,
sum(days_hs_postsurg) as n_hs_days_postsurg
from hs2 group by bid_hrs_21;
quit;

proc sql;
create table allm as select * from
proj_int.index a
left join 
ip3 b
on a.bid_hrs_21=b.bid_hrs_21
left join
op3 c
on a.bid_hrs_21=c.bid_hrs_21
left join
hs3 d
on a.bid_hrs_21=d.bid_hrs_21;
quit;

data proj_int.postsurg_measures (drop=n_icu_lastm n_er_charge n_ed_op);
set allm;
ind_icu_postsurg=n_icu_lastm>0;
n_icu_days_postsurg=n_icu_lastm;
if n_icu_days_postsurg<0 then n_icu_days_postsurg=0;
ind_ed_postsurg=n_er_charge>0 or n_ed_op>0;
if n_hosp_days_postsurg_index<0 then n_hosp_days_postsurg_index=0;
if n_hosp_days_postsurg_postindex<0 then n_hosp_days_postsurg_postindex=0;
if n_hs_days_tot<0 then n_hs_days_tot=0;
if n_hs_days_postsurg<0 then n_hs_days_postsurg=0;
died_index_stay=died_index_stay>0;
died_index_destination=died_index_destination;
if first_inp_er<first_er and first_inp_er~=. then first_er=first_inp_er;
if first_er=. then first_er=first_inp_er;
run;

proc means; run;

H="combine into one dataset"


proc sql; 
create table tomerge as select * from
proj_int.index a left join
proj_int.charlson b
on a.bid_hrs_21=b.bid_hrs_21 
left join
proj_int.mc_costs_monthly e
on a.bid_hrs_21=e.bid_hrs_21 and a.index_date=e.index_date
left join
proj_int.op_ip_monthly f
on a.bid_hrs_21=f.bid_hrs_21 and a.index_date=f.index_date
left join 
proj_int.zip_wi g
on a.bid_hrs_21=g.bid_hrs_21 and a.index_date=g.index_date
left join 
proj_int.postsurg_measures h
on a.bid_hrs_21=h.bid_hrs_21
left join
proj_int.op_ip_12m i
on a.bid_hrs_21=i.bid_hrs_21;
quit;
proc import datafile="E:\data\surgery\2012_update\final_2012clms\surgery_final_n12m_sample_clean_stset.dta" out=old_final; run;
proc sql;
create table surg_final as select * from
old_final a 
left join
tomerge b 
on a.id=b.id and a.procedure_date=b.index_date;
quit;

proc sort data=surg_final out=proj_int.surg_final nodupkey;
by id core_year_n1 index_date;
run;
proc export data=proj_int.surg_final outfile="E:\data\surgery\2012_update\final_data\surg_charls_util_final.dta" replace;
run;




H="clean add new vars"


H="tables"
capture log close
set more off
clear all
local datapath E:\data\surgery\2012_update\final_data
local logpath E:\data\surgery\2012_update\logs

cd `datapath'

use surg_charls_util_final.dta
gen year=core_year_n1
gen hhid=hhid_n1
gen pn=pn_n1
merge 1:1 hhid pn year using E:\data\hrs_oop_2010\received_data\2012\helper_hours_2012.dta, keep(match master) gen(helpmerge)
rename year core_year
merge 1:1 id core_year using "E:\data\hrs_public_2012\dementia\pdem_withvarnames_ebl.dta", keep(match master) gen(demmerge)
replace n_hp=0 if missing(n_hp)
replace death_date=. if death_date<procedure_date 
replace died_365d=death_date<=procedure_date+365
gen n_helpers_cat=n_hp
replace n_helpers_cat=2 if n_hp>2
gen n_help_0=n_hp==0
gen n_help_1=n_hp==1
gen n_help_2plus=n_hp>1
gen whiteoth=white_e | other_na
label var whiteoth "White / Other race"
gen adl_diff_index_n1=0 
gen missadldif=0
foreach x of varlist adl_diff_*n1 {
replace adl_diff_index_n1=adl_diff_index_n1+`x' if !missing(`x')
replace missadldif=1 if `x'==.
}
gen adl_impair_n1=adl_independent_core_n1==0 if !missing(adl_independent_core_n1)
gen adl_diff_impair_n1=adl_diff_index_n1>0 if !missing(adl_diff_index_n1)
gen adl_diff_no_help=adl_diff_impair_n1==1 & adl_impair_n1==0 if !missing(adl_diff_impair_n1) & !missing(adl_impair_n1)
gen adl_diff_1=adl_diff_index_n1==1 if !missing(adl_diff_index_n1) & adl_diff_no_help==1
gen adl_diff_2plus=adl_diff_index_n1>1 if !missing(adl_diff_index_n1) & adl_diff_no_help==1

gen adl_1=adl_index_core_n1==1 if adl_impair_n1==1
gen adl_2=adl_index_core_n1>=2 if adl_impair_n1==1
label var adl_1 "Dependent in 1 ADL"
label var adl_2 "Dependent in 2+ ADLs"
gen iadl_diff_index_n1=0

gen missiadldif=0
foreach x of varlist iadl_diff_*n1 {
replace iadl_diff_index_n1=iadl_diff_index_n1+`x' if !missing(`x')
replace missiadldif=1 if `x'==.
}
gen iadl_diff_impair_n1=iadl_diff_index_n1>0 if !missing(iadl_diff_index_n1)

gen charls_gt2_ind=charls_index_wt>2 if !missing(charls_index)
gen el_ge_3_ind=comorb_all>=3 if !missing(comorb_all)
gen charls_diab=charls_10 | charls_11
label var charls_diab "Diabetes, complicated or uncomplicated"
foreach x of varlist *m1 {
replace `x'=0 if missing(`x')
}
gen op_visits_ge10_1m_ind=n_op_visits_m1>=10 if !missing(n_op_visits_m1)
gen n_adm_pre_is=n_ip_admit_m1
replace n_adm_pre_is=n_adm_pre_is-1 if admit_on_index==0 & !inlist(ip_paid_by_mc_in,0,.) ///
& n_adm_pre_is>0
gen high_utilization_ind=n_ed_op_visits_m1>0 | n_adm_pre_is>0 | op_visits_ge10_1m_ind==1
gen bmi_lt25_n1=bmi_n1<25 if !missing(bmi_n1)
/*gen leeindex_n1=1
qui replace leeindex_n1=leeindex_n1+1 if age_at_surg<70
qui replace leeindex_n1=leeindex_n1+2 if  age_at_surg>=70 & age_at_surg<75	
qui replace leeindex_n1=leeindex_n1+3 if age_at_surg>=75 & age_at_surg<80
qui replace leeindex_n1=leeindex_n1+4 if age_at_surg>=80 & age_at_surg<85
qui replace leeindex_n1=leeindex_n1+6 if age_at_surg>=85
qui replace leeindex_n1=leeindex_n1+2 if female ==0
qui replace leeindex_n1=leeindex_n1+1 if charls_diab==1
qui replace leeindex_n1=leeindex_n1+2 if charls_16==1
qui replace leeindex_n1=leeindex_n1+2 if charls_6==1
qui replace leeindex_n1=leeindex_n1+2 if charls_1==1
qui replace leeindex_n1=leeindex_n1+2 if smoke_curr_n1==1
qui replace leeindex_n1=leeindex_n1+1 if bmi_lt25_n1==1
qui replace leeindex_n1=leeindex_n1+2 if adl_diff_bh_n1==1
qui replace leeindex_n1=leeindex_n1+2 if iadl_diff_m_n1==1
qui replace leeindex_n1=leeindex_n1+1 if fl_diff_push_n1==1
qui replace leeindex_n1=leeindex_n1+2 if fl_diff_wk_many_n1==1
*/
gen charls_cancer=charls_14 | charls_16
label var charls_cancer "Cancer"
gen leeindex_n1=1
qui replace leeindex_n1=leeindex_n1+1 if age_at_surg<70
qui replace leeindex_n1=leeindex_n1+2 if  age_at_surg>=70 & age_at_surg<75	
qui replace leeindex_n1=leeindex_n1+3 if age_at_surg>=75 & age_at_surg<80
qui replace leeindex_n1=leeindex_n1+4 if age_at_surg>=80 & age_at_surg<85
qui replace leeindex_n1=leeindex_n1+6 if age_at_surg>=85
qui replace leeindex_n1=leeindex_n1+2 if female ==0
qui replace leeindex_n1=leeindex_n1+1 if dm_hrs_n1==1
qui replace leeindex_n1=leeindex_n1+2 if cancer_hrs_n1==1
qui replace leeindex_n1=leeindex_n1+2 if lung_hrs_n1== 1
qui replace leeindex_n1=leeindex_n1+2 if chf_hrs_n1 ==1
qui replace leeindex_n1=leeindex_n1+2 if smoke_curr_n1==1
qui replace leeindex_n1=leeindex_n1+1 if bmi_lt25_n1==1
qui replace leeindex_n1=leeindex_n1+2 if adl_diff_bh_n1==1
qui replace leeindex_n1=leeindex_n1+2 if iadl_diff_m_n1==1
qui replace leeindex_n1=leeindex_n1+1 if fl_diff_push_n1==1
qui replace leeindex_n1=leeindex_n1+2 if fl_diff_wk_many_n1==1

gen pain_mod_or_sev=pain_level_hrs_n1>=2 & pain_hrs_n1==1
gen pain_none_mild=pain_hrs_n1==0 | pain_level_hrs_n1==1
gen pain_mod=pain_level_hrs_n1==2
gen pain_sev=pain_level_hrs_n1==3
gen lee_index_ge13_ind=leeindex_n1>=13
gen pr_dem_gt50_n1=pdem>.5 if !missing(pdem)
gen tot_preop_illness_burden=0
label var tot_preop "Total Preop Illness Burden (mean, sd)"
gen cesd_tot_gt3_n1=cesd_tot_n1>3 if !missing(cesd_tot_n1)
gen symptom_burden=!pain_none_mild if !missing(pain_none_mild)
replace symptom_burden=1 if cesd_tot_gt3_n1==1
foreach x in comorb_31 adl_impair_n1 charls_gt2_ind high_utilizat lee_index_ge ///
 symptom_burden {
	replace tot_preop_illness_burden=tot_preop_illness_burden+`x' if !missing(`x')
}

gen high_illness_burden=tot_preop_illness_burden>=2 if !missing(tot_preop_illness_burden)
gen age_lt75=age_at_surg<75
gen age_75_84=age_at_surg>=75 & age_at_surg<85
gen age_85plus=age_at_surg>=85
gen readmission_365d_ind=0
gen readmission_30d_ind=n_ip_admit_m1p>0 & !missing(n_ip_admit_m1p)
forvalues i=1/12 {
	replace readmission_365d_ind=1 if n_ip_admit_m`i'p>0 & !missing(n_ip_admit_m`i'p)
}

gen ind_hs_lte3=n_hs_days_tot<=3
label var n_hs_days_tot "Total Hospice days (mean sd)"
label var n_hs_days_post "Hospice days post-surgery"
label var age_lt75 "Age at surgery <75"
label var age_75_84 "Age at surgery 75-84"
label var age_85 "Age at surgery 85+"
label var female "Female"
label var adl_diff_no "Reported ADL difficulty, no help"
label var adl_diff_1 "Reported difficulty with 1 ADL, no help"
label var adl_diff_2 "Reported difficulty with 2+ ADLs, no help"
label var iadl_diff_imp "Reported difficulty with IADLs"
label var n_help_0 "Total Helpers: 0"
label var n_help_1 "Total Helpers: 1"
label var n_help_2 "Total Helpers: 2+"
label var pr_dem_gt50_n1 "Probability of Dementia >.5"
label var comorb_31 "Dementia, from claims"
label var charls_gt2 "Charlson score >2"
label var lee_index_ge13 "Lee Index 13+ at n1 ivw"
label var symptom_burden "Symptom Burden" 
label var pain_none_mild "Pain: none or mild"
label var pain_mod_or_sev "Pain: moderate or severe"
label var pain_mod "Pain: moderate"
label var pain_sev "Pain: severe"
label var cesd_tot_gt3 "CESD total >3"
label var comp_any "Any complication"
label var readmission_30d_ind "Hospital readmission within 30d"
label var readmission_365d_ind "Hospital readmission within 365d"
label var died_365d "Died within 365 days of surgery"
label var ind_icu_po "ICU stay discharge date <30d pre-death"
label var ind_ed_po "ED visit <30d pre-death"
label var ind_hs_lte3 "<=3 days hospice"
label var n_hs_days_post "Days on hospice after surgery"
label var n_hosp_days_postsurg_index "Days in hospital index stay after surgery"
label var n_hosp_days_postsurg_postindex "Days in hospital post index stay 365 days post surgery"
label var died_in_ho "Died in hospital after index stay, from claims"
label var died_index_stay "Died in hospital during index stay"

local vars age_lt75 age_75_84 age_85plus female white_e black_e hisp_eth_e other_na_api_race_e ///
whiteoth adl_independent_core_n1 ///
adl_diff_no_help adl_1 adl_2 iadl_diff_impair_n1 n_help_0 n_help_1 n_help_2plus ///
nhres_n1 comorb_31_0_n12m pr_dem_gt50_n1 charls_gt2_ind charls_cancer charls_diab charls_2 ///
comorb_32_0_n12m charls_3 charls_4 charls_6 charls_13 ///
lee_index_ge13_ind symptom_burden pain_none_mild pain_mod_or_sev pain_mod pain_sev cesd_tot_gt3_n1 //tot_preop_illness_burden

local rn : word count `vars' 1
local r=1
local c=1

mat tab=J(`rn',3,.)
mat stars=J(`rn',3,0)

foreach x of local vars {
	sum female
	local tot=r(N)
	foreach i in "0,1"  {
		sum `x' if inlist(high_illness,`i')
			mat tab[`r',`c']=r(mean)*r(N)
			mat tab[`r',`c'+1]=r(mean)*100
			mat tab[`r',`c'+2]=`tot'-r(N)
			local c=`c'+2
}	
	/*tab `x' high_illness, chi2
	mat tab[`r',7]=r(p)
	mat stars[`r',7]=(r(p)<.05)+(r(p)<.01)*/
	local c=1
	local r=`r'+1
}
foreach i in "0,1" {
	sum tot_preop_illness_burden if inlist(high_illness,`i')
	mat tab[`r',`c']=r(N)
	*mat tab[`r'-1,`c']=r(mean)
	*mat tab[`r'-1,`c'+1]=r(sd)
	local c=`c'+2
}

mat rownames tab=`vars' N

frmttable using "`logpath'\surgery_update_tables.rtf", statmat(tab) ///
ctitles("" "Full Sample N" "%" "Missing") title("Table 1: Cohort Characteristics") varlabels ///
sdec(0,2,0) replace annotate(stars) asymbol(*,**)

local rn : word count `vars' 1
local r=1
local c=1

mat tab=J(`rn',6,.)
mat stars=J(`rn',6,0)

foreach x of local vars {
	foreach i in 1 0 {
		sum `x' if inlist(high_illness,`i')
			mat tab[`r',`c']=r(mean)*r(N)
			mat tab[`r',`c'+1]=r(mean)*100
			local c=`c'+2
}	
	if !inlist("`x'","age_lt75", "age_75_84","age_85plus","white_e","black_e", ///
	"hisp_eth_e", "whiteoth","other_na_api_race_e") & !inlist("`x'", "adl_1", "adl_2", ///
	"adl_diff_no_help") {
	tab `x' high_illness, chi2
	mat tab[`r',5]=r(p)
	mat stars[`r',5]=(r(p)<.05)+(r(p)<.01)
}
	if "`x'"=="age_lt75" {
	tab age_cat_2 high_illness, chi2
mat tab[`r',5]=r(p)
}
	if "`x'"=="white_e"{
gen racecat=whiteoth
replace racecat=2 if black
replace racecat=3 if hisp_eth_e
tab racecat high_illness, chi2
mat tab[`r',5]=r(p)
}

	local c=1
	local r=`r'+1
}
foreach i in 1 0 {
	sum tot_preop_illness_burden if inlist(high_illness,`i')
	mat tab[`r',`c']=r(N)
	*mat tab[`r'-1,`c']=r(mean)
	*mat tab[`r'-1,`c'+1]=r(sd)
	local c=`c'+2
}
mat rownames tab=`vars' N

frmttable using "`logpath'\surgery_update_tables.rtf", statmat(tab) ctitles("" "High illness burden" "" "Low illness burden" "" "P-value" \ ///
"" "N" "%" "N" "%" "") title("Table 1: Cohort Characteristics, by illness burden") varlabels ///
sdec(0,2,0,2,2) addtable annotate(stars) asymbol(*,**)
mat tab2=J(6,2,.)
local r=1
local c=1
preserve
replace tot_preop_ill=5 if tot_preop_ill==6
sum tot_preop_illness_burden
local denom=r(N)
forvalues i=0/5 {
	sum tot_preop_illness_burden if tot_preop_illness_burden==`i'
	mat tab2[`r',1]=r(N)
	mat tab2[`r',2]=(r(N)/`denom')*100
	local r=`r'+1
}
restore
mat rownames tab2=0 1 2 3 4 "5/6"
frmttable using "`logpath'\surgery_update_tables.rtf", statmat(tab2) ctitles("Illness Burden" "N" "%") sdec(0,2) ///
title("Table 2. Preoperative Illness Burden Among Cohort") addtable varlabels

mat tab3=J(4,6,.)
mat stars=J(4,6,0)
local r=1
local c=1

foreach x in comp_any readmission_30d_ind readmission_365d_ind died_365d {
	sum `x'
	local denom=r(N)
	forvalues i=1(-1)0 {
		sum `x' if high_illness_burden==`i'
		mat tab3[`r',`c']=r(N)*r(mean)
		mat tab3[`r',`c'+1]=r(mean)*100
		local c=`c'+2
}
	tab `x' high_illness_burden, chi2
	mat tab3[`r',5]=r(p)
	mat stars[`r',5]=(r(p)<.05)+(r(p)<.01)
	local c=1
	local r=`r'+1
}

mat rownames tab3=comp_any readmission_30d_ind readmission_365d_ind died_365d

frmttable using "`logpath'\surgery_update_tables.rtf", addtable statmat(tab3) ctitles("" "High Illness Burden" "" "Low Illness Burden" "" ///
"p-value"\ "" "N" "%" "N" "%" "") title("Table 3. A Comparison of Adverse outcomes..") ///
sdec(0,2,0,2,2) annotate(stars) asymbol(*,**) varlabels

label var loc_hosp_x "Died in hospital, from exit"
local deathtime "Death<=365 days post-surgery"
foreach time in 1 2 3 {

	local eoli1 ind_icu_postsurg ind_ed_postsurg ind_hs_lte3 
	local eolc1 n_hs_days_tot n_hs_days_postsurg n_hosp_days_postsurg_index ///
	n_hosp_days_postsurg_postindex 
	local eoli2 died_index_stay died_in_hospital loc_hosp_x

	local rn: word count 1 `eoli1' `eoli2' `eolc1' 
	
	mat tab4=J(`rn',6,.)
	mat stars=J(`rn',6,0)
	local r=1
	local c=1

	preserve
	keep if died_365d
	if `time'==2 {
		local deathtime "Death<=30 days post-surgery"
		keep if died_30d
}
	if `time'==3 {
		local deathtime "Death 31-365 days post-surgery"
		drop if died_30d
}

foreach num in 1 2 {
foreach x in `eoli`num'' {
	sum `x'
	forvalues i=1(-1)0 {
		sum `x' if high_illness_burden==`i'
		mat tab4[`r',`c']=r(N)*r(mean)
		mat tab4[`r',`c'+1]=r(mean)*100
		local c=`c'+2
}
	tab `x' high_illness_burden, chi2
	mat tab4[`r',5]=r(p)
	mat stars[`r',5]=(r(p)<.05)+(r(p)<.01)
	local c=1
	local r=`r'+1
}
foreach x in `eolc`num'' {
	forvalues i=1(-1)0 {
		sum `x' if high_illness_burden==`i',d
		mat tab4[`r',`c']=r(mean)
		mat tab4[`r',`c'+1]=r(sd)
		local c=`c'+2
}
	ttest `x', by(high_illness)
	mat tab4[`r',5]=r(p)
	mat stars[`r',5]=(r(p)<.05)+(r(p)<.01)
	local r=`r'+1
	local c=1
}

}	
foreach i in 1 0 {
	sum female if high_illness==`i'
	mat tab4[`r',`c']=r(N)
	local c=`c'+2
}

mat rownames tab4=`eoli1' `eolc1' `eoli2' N

frmttable using "`logpath'\surgery_update_tables.rtf", addtable statmat(tab4) ctitles("" "High Illness Burden" "" "Low Illness Burden" "" ///
"p-value"\ "" "N" "%" "N" "%" "") title("Table 4. End of Life Care Outcomes among decedents", ///
"`deathtime'") varlabels ///
sdec(0,2,0,2,2\0,2,0,2,2\0,2,0,2,2\2,2,2,2,2\2,2,2,2,2\2,2,2,2,2\2,2,2,2,2\0,2,0,2,2\0,2,0,2,2\0) annotate(stars) asymbol(*,**)

	local eoli1 ind_icu_postsurg ind_ed_postsurg ind_hs_lte3 
	local eolc1 n_hs_days_tot n_hs_days_postsurg n_hosp_days_postsurg_index n_hosp_days_postsurg_postindex
	local eoli2 died_in_hospital loc_hosp_x

	local rn: word count 1  `eolc1' 
mat tab4=J(`rn',9,.)
mat stars=J(`rn',9,0)
local r=1
local c=1
foreach num in 1 2 {
foreach x in `eola`num'' {
	sum `x'
	forvalues i=1(-1)0 {
		sum `x' if high_illness_burden==`i'
		mat tab4[`r',`c']=r(N)*r(mean)
		mat tab4[`r',`c'+1]=r(mean)*100
		local c=`c'+3
}
	tab `x' high_illness_burden, chi2
	mat tab4[`r',5]=r(p)
	mat stars[`r',5]=(r(p)<.05)+(r(p)<.01)
	local c=1
	local r=`r'+1
}
foreach x in `eolc`num'' {
	forvalues i=1(-1)0 {
		sum `x' if high_illness_burden==`i',d
		mat tab4[`r',`c']=r(p50)
		mat tab4[`r',`c'+1]=r(p25)
		mat tab4[`r',`c'+2]=r(p75)
		local c=`c'+3
}
	ttest `x', by(high_illness)
	*mat tab4[`r',7]=r(p)
	*mat stars[`r',7]=(r(p)<.05)+(r(p)<.01)
	local r=`r'+1
	local c=1
}

}	
foreach i in 1 0 {
	sum female if high_illness==`i'
	mat tab4[`r',`c']=r(N)
	local c=`c'+3
}

mat rownames tab4=`eola1' `eolc1'  N

frmttable using "`logpath'\surgery_update_tables.rtf", addtable statmat(tab4) ///
ctitles("" "High Illness Burden" "" "" "Low Illness Burden" "" "" ///
\ "" "Median" "25th percentile" "75th percentile" "Median" "25th percentile" ///
"75th percentile") title("Table 4. End of Life Care Outcomes among decedents", ///
"`deathtime'") varlabels ///
sdec(0,0,0,0,0,0) annotate(stars) asymbol(*,**)

restore
}


H="tables postsurg"


H="kaplan meier and regressions"
/*surgery project analysis

Created 1/15/2014 to run preliminary logit regressions of illness burden on mortality

Have to manually add in variable labels to word document, varlabels
not working with categorical variables for some reason

This version runs with the mortality outcome time windows of:
0-30 days
31-180 days
31-365 days

Does stset on the dataset and saves it for other analyses that follow so always run this code 
if dataset is changed*/

capture log close

clear all
set mem 500m
set matsize 800
set more off

local texpath E:\data\surgery\2012_update\logs\tex\
local logpath E:\data\surgery\2012_update\logs
local datapath E:\data\surgery\2012_update\final_data\

log using `logpath'\10_Surgery_code_analysis1.txt, text replace

use `datapath'illness_burden.dta

numlabel, add

tab died_0_30 died_31_180, missing
tab died_0_30 died_31_365, missing

***********************************************************************
***********************************************************************
//Survival analysis
***********************************************************************
***********************************************************************

//first assign a new date, end_date
//This is either the death date or the follow up date
//Follow up date is set to actual follow up date (from p1 core or claims) or 
//Dec 31,2011 since DOD file from HRS/NDI should be complete thru 2011
format death_date %td
//tab death_date, missing
*gen end_date=.
format end_date %td
replace end_date=death_date if died_ind==1 //use DOD if present
replace end_date=c_ivw_date_p1 if end_date==. & (c_ivw_date_p1-procedure_date >= 365) //p1 ivw date if +1yr ps
replace end_date=follow_up_dt_1yr_ps if end_date==. //use claims follow up date
replace end_date= mdy(12,31,2011) if end_date==. & ind_exit==0
tab end_date, missing
//lose the one obs has an exit interview but no death date

//indicator for missing information within 1 year of death
*gen proced_to_end_dt = end_date - procedure_date
tab proced_to_end_dt core_year_p1 if died_ind==0
*gen censor_1y_ind = .
replace censor_1y_ind = 1 if proced_to_end_dt<365 & died_ind==0
replace censor_1y_ind = 0 if proced_to_end_dt>=365 | (proced_to_end_dt<365 & died_ind==1)
replace censor_1y_ind = . if end_date==.
tab censor_1y_ind, missing
//no censored observations!
//the observaton with an exit ivw and no dod will be dropped from the data for the km curve

//2 observations die on date of surgery
tab stay_dstn_cd index_los if(death_date<=procedure_date )
tab procedure_date death_date if(death_date<procedure_date)
tab procedure_date end_date if(death_date<procedure_date)
tab id if(death_date<procedure_date)

//save dataset with end date assigned
*save `datapath'surgery_final_n12m_sample_clean_end_date.dta, replace
drop _d _t _t0
//set for 1 year outcomes only by specifying exit time
stset end_date, failure(died_365d) origin(procedure_date) exit(time procedure_date + 365)

//set with no end date, looks at outcomes > 1 year where present
//stset end_date, failure(died_ind) origin(procedure_date)

stdes

//save dataset with stset assigned
*saveold `datapath'surgery_final_n12m_sample_clean_stset.dta, replace version(11)


tab censor_1y_ind if _st==1
tab procedure_date if censor_1y_ind==1 & _st==1, missing
tab  c_ivw_date_p1 if censor_1y_ind==1 & _st==1, missing

tab procedure_date admit_12m_post if censor_1y_ind==1 & _st==1, missing
tab procedure_date snf_days_post_12m if censor_1y_ind==1 & _st==1, missing

tab adl_cat_core_n1 if procedure_date==d(20mar2002) & censor_1y_ind==1 & _st==1

******************************************************************
******************************************************************
//Run regression - effect of illness burden on mortality
//Exclude the discharge location variables, include diabetes
******************************************************************
******************************************************************
//base categories are age=65-73, srh=very good/excellent 
//adl = independent, disch destination = home
//no disch destination rehab (b/c no obs)
local xvars_no_disch ib1.age_cat i.comorb_1_0_n12m i.comorb_32_0_n12m ///
	i.comorb_31_0_n12m i.comorb_13_0_n12m i.el_diab ///
	ib1.srh_cat_core ib0.adl_cat_core i.nhres_n1 i.admit_ind_6m_pre ///
	/*ib1.stay_dstn_cat i2.stay_dstn_cat i4.stay_dstn_cat ///
	i5.stay_dstn_cat i6.stay_dstn_cat*/ i.comp_any

logit died_0_30 i.high_illness_burden `xvars_no_disch' if _st==1, /*vce(r)*/ or
estat ic
outreg, ///
	stats(e_b e_ci) ctitles("","0-30-Day") ///
	title("Effect of illness burden on mortality") ///
	note("Odds ratios, 95% confidence intervals reported" \ ///
	"Base categories are Age: 65-74, Self-reported health: Excellent or very good," \ ///
	"and ADL: Independent.") ///
	varlabels store(table4) starlevels(10 5 1)

logit died_31_180 i.high_illness_burden `xvars_no_disch' if died_0_30==0 & _st==1, /*vce(r)*/ or
estat ic
outreg, ///
	stats(e_b e_ci)  ctitles("","31-180-Day") ///
	varlabels merge(table4) starlevels(10 5 1)

logit died_31_365 i.high_illness_burden `xvars_no_disch' if died_0_30==0 & _st==1, /*vce(r)*/ or
estat ic
outreg using `logpath'\logit_age, ///
	stats(e_b e_ci)  ctitles("","31-365-Day") ///
	varlabels merge(table4) starlevels(10 5 1) replace		

	
	
******************************************************************
******************************************************************
//Run regression - effect of illness burden on mortality
//All controls
******************************************************************
******************************************************************
//base categories are age=65-73, race=white, tics=normal srh=very good/excellent 
//adl = independent, disch destination = home
//variables omitted b/c no obs: race=other, tics=demented, disch=rehab
local xvars_30d_all ib1.age_cat i.female i1.re_cat i2.re_cat ib3.re_cat ///
	i1b.tics_cat_miss i2.tics_cat_miss i4.tics_cat_miss ///
	i.el_cancer i.comorb_1_0_n12m i.comorb_32_0_n12m i.comorb_31_0_n12m ///
	i.comorb_13_0_n12m i.el_diab ib1.srh_cat_core ib0.adl_cat_core ///
	i.nhres_n1 i.admit_ind_6m_pre ///
	ib1.stay_dstn_cat i2.stay_dstn_cat i4.stay_dstn_cat ///
	i5.stay_dstn_cat i6.stay_dstn_cat i.comp_any

//For 180 day mortality regression
//variables omitted b/c no obs: tics=demented, disch=expired 
local xvars_180d_all ib1.age_cat i.female ib3.re_cat ///
	i1b.tics_cat_miss i2.tics_cat_miss i4.tics_cat_miss ///
	i.el_cancer i.comorb_1_0_n12m i.comorb_32_0_n12m i.comorb_31_0_n12m ///
	i.comorb_13_0_n12m i.el_diab ib1.srh_cat_core ib0.adl_cat_core ///
	i.nhres_n1 i.admit_ind_6m_pre ///
	ib1.stay_dstn_cat i2.stay_dstn_cat i3.stay_dstn_cat ///
	i4.stay_dstn_cat i5.stay_dstn_cat i.comp_any	

//For 365 day mortality regression
//variables omitted b/c no obs: tics=demented, disch=expired 
local xvars_180d_all ib1.age_cat i.female ib3.re_cat ///
	i1b.tics_cat_miss i2.tics_cat_miss i3.tics_cat_miss i4.tics_cat_miss ///
	i.el_cancer i.comorb_1_0_n12m i.comorb_32_0_n12m i.comorb_31_0_n12m ///
	i.comorb_13_0_n12m i.el_diab ib1.srh_cat_core ib0.adl_cat_core ///
	i.nhres_n1 i.admit_ind_6m_pre ///
	ib1.stay_dstn_cat i2.stay_dstn_cat i3.stay_dstn_cat ///
	i4.stay_dstn_cat i5.stay_dstn_cat i.comp_any	

logit died_0_30 i.high_illness_burden `xvars_30d_all'  if _st==1, /*vce(r)*/ or
outreg, ///
	stats(e_b e_ci) ctitles("","30-Day") ///
	title("Effect of illness burden on mortality - All covariates") ///
	note("Odds ratios, 95% confidence intervals reported" \ ///
	"Base categories are Age: 65-74, Race: White, TICS: Normal," \ ///
	"Self-reported health: Excellent or very good," \ ///
	"ADL: Independent, and Discharged to Home.") ///
	varlabels store(table5) starlevels(10 5 1)

logit died_31_180 i.high_illness_burden `xvars_180d_all' if died_0_30==0 & _st==1, /*vce(r)*/ or
outreg, ///
	stats(e_b e_ci)  ctitles("","180-Day") ///
	varlabels merge(table5) starlevels(10 5 1)

logit died_31_365 i.high_illness_burden `xvars_180d_all' if died_0_30==0 & _st==1, /*vce(r)*/ or
outreg using `logpath'\logit_age, ///
	stats(e_b e_ci)  ctitles("","365-Day") ///
	varlabels merge(table5) starlevels(10 5 1) addtable		



***********************************************************************************
***********************************************************************************
//KM Curve
***********************************************************************************
***********************************************************************************
sts list
sts graph
sts graph, by(high_illness_burden) /*tmax(400)*/ ///
legend(label(1 "Low Illness Burden") label(2 "High Illness Burden")) //label(3 "85 and older"))
graph export `logpath'\KMCurve.png, replace

local allxvars high_illness_burden age_cat female re_cat tics_cat_miss ///
	el_cancer comorb_1_0_n12m comorb_32_0_n12m comorb_31_0_n12m ///
	comorb_13_0_n12m el_diab srh_cat_core adl_cat_core ///
	nhres_n1 admit_ind_6m_pre ///
	stay_dstn_cat comp_any

foreach v in `allxvars'{
sts test `v', logrank
}

***********************************************************************************
***********************************************************************************
//Run complementary log log model
***********************************************************************************
***********************************************************************************
cloglog died_0_30 high_illness_burden `xvars_no_disch' if _st==1, eform
outreg, ///
 	stats(e_b e_ci) ctitles("","0-30-Day") ///
	title("Effect of illness burden on mortality - Complementary log log model") ///
	note("Hazard ratios, 95% confidence intervals reported" \ ///
	"Base categories are Age: 65-74, Self-reported health: Excellent or very good," \ ///
	"and ADL: Independent.") ///
	varlabels store(table6) starlevels(10 5 1)

cloglog died_31_180 high_illness_burden `xvars_no_disch' if died_0_30==0 & _st==1, eform
outreg, ///
 	stats(e_b e_ci) ctitles("","31-180-Day") ///
	varlabels merge(table6) starlevels(10 5 1)

cloglog died_31_365 high_illness_burden `xvars_no_disch' if died_0_30==0 & _st==1, eform
outreg using `logpath'\logit_age, ///
	stats(e_b e_ci) ctitles("","31-365-Day") ///
	varlabels merge(table6) starlevels(10 5 1) addtable

	
log close


H="readmissions"
/*surgery project analysis

Created 1/15/2014 to run preliminary logit regressions of illness burden on mortality

Have to manually add in variable labels to word document, varlabels
not working with categorical variables for some reason

This version runs with the mortality outcome time windows of:
0-30 days
31-180 days
31-365 days

Does stset on the dataset and saves it for other analyses that follow so always run this code 
if dataset is changed*/

capture log close

clear all
set mem 500m
set matsize 800
set more off

local texpath E:\data\surgery\2012_update\logs\tex\
local logpath E:\data\surgery\2012_update\logs
local datapath E:\data\surgery\2012_update\final_data\

log using `logpath'\10_Surgery_code_analysis1.txt, text replace

use `datapath'illness_burden.dta

numlabel, add

tab died_0_30 died_31_180, missing
tab died_0_30 died_31_365, missing

***********************************************************************
***********************************************************************
//Survival analysis
***********************************************************************
***********************************************************************

//first assign a new date, end_date
//This is either the death date or the follow up date
//Follow up date is set to actual follow up date (from p1 core or claims) or 
//Dec 31,2011 since DOD file from HRS/NDI should be complete thru 2011
format death_date %td
//tab death_date, missing
*gen end_date=.
format end_date %td
replace end_date=death_date if died_ind==1 //use DOD if present
replace end_date=c_ivw_date_p1 if end_date==. & (c_ivw_date_p1-procedure_date >= 365) //p1 ivw date if +1yr ps
replace end_date=follow_up_dt_1yr_ps if end_date==. //use claims follow up date
replace end_date= mdy(12,31,2011) if end_date==. & ind_exit==0
tab end_date, missing
//lose the one obs has an exit interview but no death date

//indicator for missing information within 1 year of death
*gen proced_to_end_dt = end_date - procedure_date
tab proced_to_end_dt core_year_p1 if died_ind==0
*gen censor_1y_ind = .
replace censor_1y_ind = 1 if proced_to_end_dt<365 & died_ind==0
replace censor_1y_ind = 0 if proced_to_end_dt>=365 | (proced_to_end_dt<365 & died_ind==1)
replace censor_1y_ind = . if end_date==.
tab censor_1y_ind, missing
//no censored observations!
//the observaton with an exit ivw and no dod will be dropped from the data for the km curve

//2 observations die on date of surgery
tab stay_dstn_cd index_los if(death_date<=procedure_date )
tab procedure_date death_date if(death_date<procedure_date)
tab procedure_date end_date if(death_date<procedure_date)
tab id if(death_date<procedure_date)

//save dataset with end date assigned
*save `datapath'surgery_final_n12m_sample_clean_end_date.dta, replace
drop _d _t _t0
//set for 1 year outcomes only by specifying exit time
stset end_date, failure(died_365d) origin(procedure_date) exit(time procedure_date + 365)

//set with no end date, looks at outcomes > 1 year where present
//stset end_date, failure(died_ind) origin(procedure_date)

stdes

//save dataset with stset assigned
*saveold `datapath'surgery_final_n12m_sample_clean_stset.dta, replace version(11)


tab censor_1y_ind if _st==1
tab procedure_date if censor_1y_ind==1 & _st==1, missing
tab  c_ivw_date_p1 if censor_1y_ind==1 & _st==1, missing

tab procedure_date admit_12m_post if censor_1y_ind==1 & _st==1, missing
tab procedure_date snf_days_post_12m if censor_1y_ind==1 & _st==1, missing

tab adl_cat_core_n1 if procedure_date==d(20mar2002) & censor_1y_ind==1 & _st==1

******************************************************************
******************************************************************
//Run regression - effect of illness burden on mortality
//Exclude the discharge location variables, include diabetes
******************************************************************
******************************************************************
//base categories are age=65-73, srh=very good/excellent 
//adl = independent, disch destination = home
//no disch destination rehab (b/c no obs)
local xvars_no_disch ib1.age_cat i.comorb_1_0_n12m i.comorb_32_0_n12m ///
	i.comorb_31_0_n12m i.comorb_13_0_n12m i.el_diab ///
	ib1.srh_cat_core ib0.adl_cat_core i.nhres_n1 i.admit_ind_6m_pre ///
	/*ib1.stay_dstn_cat i2.stay_dstn_cat i4.stay_dstn_cat ///
	i5.stay_dstn_cat i6.stay_dstn_cat*/ i.comp_any

logit died_0_30 i.high_illness_burden `xvars_no_disch' if _st==1, /*vce(r)*/ or
estat ic
outreg, ///
	stats(e_b e_ci) ctitles("","0-30-Day") ///
	title("Effect of illness burden on mortality") ///
	note("Odds ratios, 95% confidence intervals reported" \ ///
	"Base categories are Age: 65-74, Self-reported health: Excellent or very good," \ ///
	"and ADL: Independent.") ///
	varlabels store(table4) starlevels(10 5 1)

logit died_31_180 i.high_illness_burden `xvars_no_disch' if died_0_30==0 & _st==1, /*vce(r)*/ or
estat ic
outreg, ///
	stats(e_b e_ci)  ctitles("","31-180-Day") ///
	varlabels merge(table4) starlevels(10 5 1)

logit died_31_365 i.high_illness_burden `xvars_no_disch' if died_0_30==0 & _st==1, /*vce(r)*/ or
estat ic
outreg using `logpath'\logit_age, ///
	stats(e_b e_ci)  ctitles("","31-365-Day") ///
	varlabels merge(table4) starlevels(10 5 1) replace		

	
	
******************************************************************
******************************************************************
//Run regression - effect of illness burden on mortality
//All controls
******************************************************************
******************************************************************
//base categories are age=65-73, race=white, tics=normal srh=very good/excellent 
//adl = independent, disch destination = home
//variables omitted b/c no obs: race=other, tics=demented, disch=rehab
local xvars_30d_all ib1.age_cat i.female i1.re_cat i2.re_cat ib3.re_cat ///
	i1b.tics_cat_miss i2.tics_cat_miss i4.tics_cat_miss ///
	i.el_cancer i.comorb_1_0_n12m i.comorb_32_0_n12m i.comorb_31_0_n12m ///
	i.comorb_13_0_n12m i.el_diab ib1.srh_cat_core ib0.adl_cat_core ///
	i.nhres_n1 i.admit_ind_6m_pre ///
	ib1.stay_dstn_cat i2.stay_dstn_cat i4.stay_dstn_cat ///
	i5.stay_dstn_cat i6.stay_dstn_cat i.comp_any

//For 180 day mortality regression
//variables omitted b/c no obs: tics=demented, disch=expired 
local xvars_180d_all ib1.age_cat i.female ib3.re_cat ///
	i1b.tics_cat_miss i2.tics_cat_miss i4.tics_cat_miss ///
	i.el_cancer i.comorb_1_0_n12m i.comorb_32_0_n12m i.comorb_31_0_n12m ///
	i.comorb_13_0_n12m i.el_diab ib1.srh_cat_core ib0.adl_cat_core ///
	i.nhres_n1 i.admit_ind_6m_pre ///
	ib1.stay_dstn_cat i2.stay_dstn_cat i3.stay_dstn_cat ///
	i4.stay_dstn_cat i5.stay_dstn_cat i.comp_any	

//For 365 day mortality regression
//variables omitted b/c no obs: tics=demented, disch=expired 
local xvars_180d_all ib1.age_cat i.female ib3.re_cat ///
	i1b.tics_cat_miss i2.tics_cat_miss i3.tics_cat_miss i4.tics_cat_miss ///
	i.el_cancer i.comorb_1_0_n12m i.comorb_32_0_n12m i.comorb_31_0_n12m ///
	i.comorb_13_0_n12m i.el_diab ib1.srh_cat_core ib0.adl_cat_core ///
	i.nhres_n1 i.admit_ind_6m_pre ///
	ib1.stay_dstn_cat i2.stay_dstn_cat i3.stay_dstn_cat ///
	i4.stay_dstn_cat i5.stay_dstn_cat i.comp_any	

logit died_0_30 i.high_illness_burden `xvars_30d_all'  if _st==1, /*vce(r)*/ or
outreg, ///
	stats(e_b e_ci) ctitles("","30-Day") ///
	title("Effect of illness burden on mortality - All covariates") ///
	note("Odds ratios, 95% confidence intervals reported" \ ///
	"Base categories are Age: 65-74, Race: White, TICS: Normal," \ ///
	"Self-reported health: Excellent or very good," \ ///
	"ADL: Independent, and Discharged to Home.") ///
	varlabels store(table5) starlevels(10 5 1)

logit died_31_180 i.high_illness_burden `xvars_180d_all' if died_0_30==0 & _st==1, /*vce(r)*/ or
outreg, ///
	stats(e_b e_ci)  ctitles("","180-Day") ///
	varlabels merge(table5) starlevels(10 5 1)

logit died_31_365 i.high_illness_burden `xvars_180d_all' if died_0_30==0 & _st==1, /*vce(r)*/ or
outreg using `logpath'\logit_age, ///
	stats(e_b e_ci)  ctitles("","365-Day") ///
	varlabels merge(table5) starlevels(10 5 1) addtable		



***********************************************************************************
***********************************************************************************
//KM Curve
***********************************************************************************
***********************************************************************************
sts list
sts graph
sts graph, by(high_illness_burden) /*tmax(400)*/ ///
legend(label(1 "Low Illness Burden") label(2 "High Illness Burden")) //label(3 "85 and older"))
graph export `logpath'\KMCurve.png, replace

local allxvars high_illness_burden age_cat female re_cat tics_cat_miss ///
	el_cancer comorb_1_0_n12m comorb_32_0_n12m comorb_31_0_n12m ///
	comorb_13_0_n12m el_diab srh_cat_core adl_cat_core ///
	nhres_n1 admit_ind_6m_pre ///
	stay_dstn_cat comp_any

foreach v in `allxvars'{
sts test `v', logrank
}

***********************************************************************************
***********************************************************************************
//Run complementary log log model
***********************************************************************************
***********************************************************************************
cloglog died_0_30 high_illness_burden `xvars_no_disch' if _st==1, eform
outreg, ///
 	stats(e_b e_ci) ctitles("","0-30-Day") ///
	title("Effect of illness burden on mortality - Complementary log log model") ///
	note("Hazard ratios, 95% confidence intervals reported" \ ///
	"Base categories are Age: 65-74, Self-reported health: Excellent or very good," \ ///
	"and ADL: Independent.") ///
	varlabels store(table6) starlevels(10 5 1)

cloglog died_31_180 high_illness_burden `xvars_no_disch' if died_0_30==0 & _st==1, eform
outreg, ///
 	stats(e_b e_ci) ctitles("","31-180-Day") ///
	varlabels merge(table6) starlevels(10 5 1)

cloglog died_31_365 high_illness_burden `xvars_no_disch' if died_0_30==0 & _st==1, eform
outreg using `logpath'\logit_age, ///
	stats(e_b e_ci) ctitles("","31-365-Day") ///
	varlabels merge(table6) starlevels(10 5 1) addtable

	
log close


H="tables updated 11017"
capture log close
set more off
clear all
local datapath E:\data\surgery\2012_update\final_data
local logpath E:\data\surgery\2012_update\logs

cd `datapath'

use surg_charls_util_final.dta if procedure_date-c_ivw_date_n1<=(365.25*3) ///
& age_at_surg>=65.5 & procedure_date>=td(01jul2000)
gen year=core_year_n1
gen hhid=hhid_n1
gen pn=pn_n1
merge 1:1 hhid pn year using E:\data\hrs_oop_2010\received_data\2012\helper_hours_2012.dta, keep(match master) gen(helpmerge)
rename year core_year
merge 1:1 id core_year using "E:\data\hrs_public_2012\dementia\pdem_withvarnames_ebl.dta", keep(match master) gen(demmerge)
replace n_hp=0 if missing(n_hp)
replace death_date=. if death_date<procedure_date 
replace died_365d=death_date<=procedure_date+365
gen n_helpers_cat=n_hp
replace n_helpers_cat=2 if n_hp>2
gen n_help_0=n_hp==0
gen n_help_1=n_hp==1
gen n_help_2plus=n_hp>1
gen whiteoth=white_e | other_na
label var whiteoth "White / Other race"
gen adl_diff_index_n1=0 
gen missadldif=0
foreach x of varlist adl_diff_*n1 {
replace adl_diff_index_n1=adl_diff_index_n1+`x' if !missing(`x')
replace missadldif=1 if `x'==.
}
gen adl_impair_n1=adl_independent_core_n1==0 if !missing(adl_independent_core_n1)
gen adl_diff_impair_n1=adl_diff_index_n1>0 if !missing(adl_diff_index_n1)
gen adl_diff_no_help=adl_diff_impair_n1==1 & adl_impair_n1==0 if !missing(adl_diff_impair_n1) & !missing(adl_impair_n1)
gen adl_diff_1=adl_diff_index_n1==1 if !missing(adl_diff_index_n1) & adl_diff_no_help==1
gen adl_diff_2plus=adl_diff_index_n1>1 if !missing(adl_diff_index_n1) & adl_diff_no_help==1

gen adl_1=adl_index_core_n1==1 if !missing(adl_impair_n1)
gen adl_2=adl_index_core_n1>=2 if !missing(adl_impair_n1)
label var adl_1 "Dependent in 1 ADL"
label var adl_2 "Dependent in 2+ ADLs"
gen iadl_diff_index_n1=0

gen missiadldif=0
foreach x of varlist iadl_diff_*n1 {
replace iadl_diff_index_n1=iadl_diff_index_n1+`x' if !missing(`x')
replace missiadldif=1 if `x'==.
}
gen iadl_diff_impair_n1=iadl_diff_index_n1>0 if !missing(iadl_diff_index_n1)

gen charls_gt2_ind=charls_index_wt>2 if !missing(charls_index)
gen el_ge_3_ind=comorb_all>=3 if !missing(comorb_all)
gen charls_diab=charls_10 | charls_11
label var charls_diab "Diabetes, complicated or uncomplicated"
foreach x of varlist *m1 {
replace `x'=0 if missing(`x')
}

local symp dyspnea swelling_feet dizzy back_pain headache fatigue cough falls ///
incont

foreach x of local symp {
	gen `x'_n1n2=`x'_hrs_n1
	replace `x'_n1n2=`x'_hrs_n2 if missing(`x'_n1n2)
	local lab : var label `x'_hrs_n1
	label var `x'_n1n2 "`lab' n1 or n2"
	local symp1 `symp1' `x'_hrs_n1
	local symp2 `symp2' `x'_n1n2
}
gen op_visits_ge10_1m_ind=n_op_visits_m1>=10 if !missing(n_op_visits_m1)
gen n_adm_pre_is=n_ip_admit_m1
replace n_adm_pre_is=n_adm_pre_is-1 if admit_on_index==0 & !inlist(ip_paid_by_mc_in,0,.) ///
& n_adm_pre_is>0
gen high_utilization_ind=n_ed_op_visits_m1>0 | n_adm_pre_is>0 | op_visits_ge10_1m_ind==1
gen bmi_lt25_n1=bmi_n1<25 if !missing(bmi_n1)
/*gen leeindex_n1=1
qui replace leeindex_n1=leeindex_n1+1 if age_at_surg<70
qui replace leeindex_n1=leeindex_n1+2 if  age_at_surg>=70 & age_at_surg<75	
qui replace leeindex_n1=leeindex_n1+3 if age_at_surg>=75 & age_at_surg<80
qui replace leeindex_n1=leeindex_n1+4 if age_at_surg>=80 & age_at_surg<85
qui replace leeindex_n1=leeindex_n1+6 if age_at_surg>=85
qui replace leeindex_n1=leeindex_n1+2 if female ==0
qui replace leeindex_n1=leeindex_n1+1 if charls_diab==1
qui replace leeindex_n1=leeindex_n1+2 if charls_16==1
qui replace leeindex_n1=leeindex_n1+2 if charls_6==1
qui replace leeindex_n1=leeindex_n1+2 if charls_1==1
qui replace leeindex_n1=leeindex_n1+2 if smoke_curr_n1==1
qui replace leeindex_n1=leeindex_n1+1 if bmi_lt25_n1==1
qui replace leeindex_n1=leeindex_n1+2 if adl_diff_bh_n1==1
qui replace leeindex_n1=leeindex_n1+2 if iadl_diff_m_n1==1
qui replace leeindex_n1=leeindex_n1+1 if fl_diff_push_n1==1
qui replace leeindex_n1=leeindex_n1+2 if fl_diff_wk_many_n1==1
*/
gen charls_cancer=charls_14 | charls_16
label var charls_cancer "Cancer"
gen leeindex_n1=1
qui replace leeindex_n1=leeindex_n1+1 if age_at_surg<70
qui replace leeindex_n1=leeindex_n1+2 if  age_at_surg>=70 & age_at_surg<75	
qui replace leeindex_n1=leeindex_n1+3 if age_at_surg>=75 & age_at_surg<80
qui replace leeindex_n1=leeindex_n1+4 if age_at_surg>=80 & age_at_surg<85
qui replace leeindex_n1=leeindex_n1+6 if age_at_surg>=85
qui replace leeindex_n1=leeindex_n1+2 if female ==0
qui replace leeindex_n1=leeindex_n1+1 if dm_hrs_n1==1
qui replace leeindex_n1=leeindex_n1+2 if cancer_hrs_n1==1
qui replace leeindex_n1=leeindex_n1+2 if lung_hrs_n1== 1
qui replace leeindex_n1=leeindex_n1+2 if chf_hrs_n1 ==1
qui replace leeindex_n1=leeindex_n1+2 if smoke_curr_n1==1
qui replace leeindex_n1=leeindex_n1+1 if bmi_lt25_n1==1
qui replace leeindex_n1=leeindex_n1+2 if adl_diff_bh_n1==1
qui replace leeindex_n1=leeindex_n1+2 if iadl_diff_m_n1==1
qui replace leeindex_n1=leeindex_n1+1 if fl_diff_push_n1==1
qui replace leeindex_n1=leeindex_n1+2 if fl_diff_wk_many_n1==1

gen pain_mod_or_sev=pain_level_hrs_n1>=2 & pain_hrs_n1==1
gen pain_none_mild=pain_hrs_n1==0 | pain_level_hrs_n1==1
gen pain_mod=pain_level_hrs_n1==2
gen pain_sev=pain_level_hrs_n1==3
gen lee_index_ge13_ind=leeindex_n1>=13
gen pr_dem_gt50_n1=pdem>.5 if !missing(pdem)
gen tot_preop_illness_burden=0
label var tot_preop "Total Preop Illness Burden (mean, sd)"
gen cesd_tot_gt3_n1=cesd_tot_n1>3 if !missing(cesd_tot_n1)
gen symptom_burden=!pain_none_mild if !missing(pain_none_mild)
replace symptom_burden=1 if cesd_tot_gt3_n1==1
foreach x in comorb_31 adl_impair_n1 charls_gt2_ind high_utilizat lee_index_ge ///
 symptom_burden {
	replace tot_preop_illness_burden=tot_preop_illness_burden+`x' if !missing(`x')
}

gen high_illness_burden=tot_preop_illness_burden>=2 if !missing(tot_preop_illness_burden)
gen age_lt75=age_at_surg<75
gen age_75_84=age_at_surg>=75 & age_at_surg<85
gen age_85plus=age_at_surg>=85
gen readmission_365d_ind=0
gen readmission_30d_ind=n_ip_admit_m1p>0 & !missing(n_ip_admit_m1p)
forvalues i=1/12 {
	replace readmission_365d_ind=1 if n_ip_admit_m`i'p>0 & !missing(n_ip_admit_m`i'p)
}
gen ind_hs_any=n_hs_days_post>=1 if !missing(n_hs_days_post)
replace ind_hs_any=0 if n_hs_days_post<4
label var ind_hs_any "Hospice (4+ days)"
gen ind_hs_lte3=n_hs_days_p<=3
label var n_hs_days_tot "Total Hospice days (mean sd)"
label var n_hs_days_post "Hospice days post-surgery (mean,sd)"
label var age_lt75 "Age at surgery <75"
label var age_75_84 "Age at surgery 75-84"
label var age_85 "Age at surgery 85+"
label var female "Female"
label var adl_diff_no "Reported ADL difficulty, no help"
label var adl_diff_1 "Reported difficulty with 1 ADL, no help"
label var adl_diff_2 "Reported difficulty with 2+ ADLs, no help"
label var iadl_diff_imp "Reported difficulty with IADLs"
label var n_help_0 "Total Helpers: 0"
label var n_help_1 "Total Helpers: 1"
label var n_help_2 "Total Helpers: 2+"
label var pr_dem_gt50_n1 "Probability of Dementia >.5"
label var comorb_31 "Dementia, from claims"
label var charls_gt2 "Charlson score >2"
label var lee_index_ge13 "Lee Index 13+ at n1 ivw"
label var symptom_burden "Symptom Burden" 
label var pain_none_mild "Pain: none or mild"
label var pain_mod_or_sev "Pain: moderate or severe"
label var pain_mod "Pain: moderate"
label var pain_sev "Pain: severe"
label var cesd_tot_gt3 "CESD total >3"
label var comp_any "Any complication"
label var readmission_30d_ind "Hospital readmission within 30d of surgery"
label var readmission_365d_ind "Hospital readmission within 365d of surgery"
label var died_365d "Died within 365 days of surgery"
label var ind_icu_po "ICU stay within 365 days of surgery, post index stay"
label var ind_ed_po "ED visit within 365 days of surgery, post index stay"
label var ind_hs_lte3 "<=3 days hospice"
label var n_hs_days_post "Days on hospice after surgery"
label var n_hosp_days_postsurg_index "Days in hospital index stay after surgery"
label var n_hosp_days_postsurg_postindex "Days in hospital post index stay 365 days post surgery"
label var died_in_ho "Died in hospital after index stay, from claims"
label var died_index_stay "Died in hospital during index stay"
label var n_icu_d "ICU days within 365 days of surgery, post index stay"
replace died_index_stay=0 if death_date-procedure_date==469
local vars age_lt75 age_75_84 age_85plus female white_e black_e hisp_eth_e other_na_api_race_e ///
whiteoth adl_independent_core_n1 ///
adl_diff_no_help adl_1 adl_2 iadl_diff_impair_n1 n_help_0 n_help_1 n_help_2plus ///
nhres_n1 comorb_31_0_n12m pr_dem_gt50_n1 charls_gt2_ind charls_cancer charls_diab charls_2 ///
comorb_32_0_n12m charls_3 charls_4 charls_6 charls_13 ///
lee_index_ge13_ind symptom_burden pain_none_mild pain_mod_or_sev pain_mod pain_sev ///
cesd_tot_gt3_n1 `symp1' `symp2'
local rn : word count `vars' 1
local r=1
local c=1

mat tab=J(`rn',3,.)
mat stars=J(`rn',3,0)

foreach x of local vars {
	sum female
	local tot=r(N)
	foreach i in "0,1"  {
		sum `x' if inlist(high_illness,`i')
			mat tab[`r',`c']=r(mean)*r(N)
			mat tab[`r',`c'+1]=r(mean)*100
			mat tab[`r',`c'+2]=`tot'-r(N)
			local c=`c'+2
}	
	/*tab `x' high_illness, chi2
	mat tab[`r',7]=r(p)
	mat stars[`r',7]=(r(p)<.05)+(r(p)<.01)*/
	local c=1
	local r=`r'+1
}
foreach i in "0,1" {
	sum tot_preop_illness_burden if inlist(high_illness,`i')
	mat tab[`r',`c']=r(N)
	*mat tab[`r'-1,`c']=r(mean)
	*mat tab[`r'-1,`c'+1]=r(sd)
	local c=`c'+2
}

mat rownames tab=`vars' N

frmttable using "`logpath'\surgery_update_tables.rtf", statmat(tab) ///
ctitles("" "Full Sample N" "%" "Missing") title("Table 1: Cohort Characteristics") varlabels ///
sdec(0,2,0) replace annotate(stars) asymbol(*,**) ///


local rn : word count `vars' 1
local r=1
local c=1

mat tab=J(`rn',6,.)
mat stars=J(`rn',6,0)

foreach x of local vars {
	foreach i in 1 0 {
		sum `x' if inlist(high_illness,`i')
			mat tab[`r',`c']=r(mean)*r(N)
			mat tab[`r',`c'+1]=r(mean)*100
			local c=`c'+2
}	
	if !inlist("`x'","age_lt75", "age_75_84","age_85plus","white_e","black_e", ///
	"hisp_eth_e", "whiteoth","other_na_api_race_e") & !inlist("`x'", "adl_1", "adl_2", ///
	"adl_diff_no_help") {
	tab `x' high_illness, chi2
	mat tab[`r',5]=r(p)
	mat stars[`r',5]=(r(p)<.05)+(r(p)<.01)
}
	if "`x'"=="age_lt75" {
	tab age_cat_2 high_illness, chi2
mat tab[`r',5]=r(p)
}
	if "`x'"=="white_e"{
gen racecat=whiteoth
replace racecat=2 if black
replace racecat=3 if hisp_eth_e
tab racecat high_illness, chi2
mat tab[`r',5]=r(p)
}

	local c=1
	local r=`r'+1
}
foreach i in 1 0 {
	sum tot_preop_illness_burden if inlist(high_illness,`i')
	mat tab[`r',`c']=r(N)
	*mat tab[`r'-1,`c']=r(mean)
	*mat tab[`r'-1,`c'+1]=r(sd)
	local c=`c'+2
}
mat rownames tab=`vars' N

frmttable using "`logpath'\surgery_update_tables.rtf", statmat(tab) ctitles("" "High illness burden" "" "Low illness burden" "" "P-value" \ ///
"" "N" "%" "N" "%" "") title("Table 1a: Cohort Characteristics, by illness burden") varlabels ///
sdec(0,2,0,2,2) addtable annotate(stars) asymbol(*,**)
mat tab2=J(6,6,.)
local r=1
local c=3
preserve
replace tot_preop_ill=5 if tot_preop_ill==6
sum tot_preop_illness_burden
local denom=r(N)
 forvalues i=0/5 {
	sum tot_preop_illness_burden if tot_preop_illness_burden==`i'
	mat tab2[`r',1]=r(N)
	mat tab2[`r',2]=(r(N)/`denom')*100
	local r=`r'+1
}
local r=1
foreach x in died_index_stay died_30d ///
 readmission_30d_ind readmission_365d_ind {
	forvalues i=0/5 {
		sum `x' if tot_preop_illness_burden==`i'
		mat tab2[`r',`c']=r(mean)*100
		local r=`r'+1
}
	local c=`c'+1
	local r=1
}
restore
mat rownames tab2=0 1 2 3 4 "5/6"
frmttable using "`logpath'\surgery_update_tables.rtf", statmat(tab2) ///
ctitles("Illness Burden" "N" "% of total" "% die index stay" "% die 365d" ///
"% readmit 30d" "% readmit 365d") sdec(0,2) ///
title("Table 2. Preoperative Illness Burden Among Cohort") addtable varlabels

local vars comp_any readmission_30d_ind readmission_365d_ind ind_icu_postsurg ///
ind_ed_postsurg n_hosp_days_postsurg_index n_hosp_days_postsurg_postindex died_365d ///
died_index_stay 
local rn : word count `vars'
mat tab3=J(`rn',7,.)
mat stars=J(`rn',7,0)
local r=1
local c=1

foreach x in `vars' {
	sum `x'
	local denom=r(N)
	foreach i in "0,1" 1 0 {
	if !inlist(substr("`x'",1,2),"n_") {
	sum `x' if inlist(high_illness_burden,`i')
		mat tab3[`r',`c']=r(N)*r(mean)
		mat tab3[`r',`c'+1]=r(mean)*100
}
	else {
		sum `x' if inlist(high_illness_burden,`i'),d
		mat tab3[`r',`c']=r(mean)
		mat tab3[`r',`c'+1]=r(sd)
}		
	local c=`c'+2
}
	tab `x' high_illness_burden, chi2
	mat tab3[`r',7]=r(p)
	mat stars[`r',7]=(r(p)<.05)+(r(p)<.01)
	if inlist(substr("`x'",1,2),"n_") {
		ttest `x', by(high_illness)
		mat tab3[`r',7]=r(p)
		mat stars[`r',7]=(r(p)<.05)+(r(p)<.01)
}

	local r=`r'+1
	local c=1
}
mat rownames tab3=`vars'

frmttable using "`logpath'\surgery_update_tables.rtf", addtable statmat(tab3) ///
ctitles("" "Full Sample" "" "High Illness Burden" "" "Low Illness Burden" "" ///
"p-value"\ "" "N" "%" "N" "%" "" "%" "") title("Table 3. A Comparison of Adverse outcomes..") ///
sdec(0,2,0,2,0,2,2\0,2,0,2,0,2,2\0,2,0,2,0,2,2\0,2,0,2,0,2,2\2,2,2,2,2,2,2 ///
\2,2,2,2,2,2,2\2,2,2,2,2,2,2\0,2,0,2,0,2,2) annotate(stars) asymbol(*,**) varlabels

label var loc_hosp_x "Died in hospital, from exit"
local deathtime "Full sample" 
foreach time in 1 /*2 3*/ {

	local eoli1 ind_icu_postsurg 
	local eolc1 n_icu_days_postsurg
	local eolc2 n_hs_days_postsurg n_hosp_days_postsurg_index ///
	n_hosp_days_postsurg_postindex
	local eoli2 ind_ed_postsurg ind_hs_any
	local eoli3 died_index_stay died_in_hospital loc_hosp_x
	local rn: word count `eoli1' `eolc1' `eoli2' `eolc2' `eoli3' N
	
	mat tab4=J(`rn',7,.)
	mat stars=J(`rn',7,0)
	local r=1
	local c=1

	preserve
	if `time'==1 {
		local deathtime "Death<=365 days post-surgery"
		keep if died_365d
}
	if `time'==2 {
		local deathtime "Death<=30 days post-surgery"
		keep if died_30d
}
	if `time'==3 {
		local deathtime "Death 31-365 days post-surgery"
		drop if died_30d
}

foreach num in 1 2 3 {
foreach x in `eoli`num'' {
	sum `x'
	foreach i in "0,1" 1 0 {
		sum `x' if inlist(high_illness_burden,`i')
		mat tab4[`r',`c']=r(N)*r(mean)
		mat tab4[`r',`c'+1]=r(mean)*100
		local c=`c'+2
}
	tab `x' high_illness_burden, chi2
	mat tab4[`r',7]=r(p)
	mat stars[`r',7]=(r(p)<.05)+(r(p)<.01)
	local c=1
	local r=`r'+1
}
foreach x in `eolc`num'' {
	foreach i in "0,1" 1 0 {
		sum `x' if inlist(high_illness_burden,`i'),d
		mat tab4[`r',`c']=r(mean)
		mat tab4[`r',`c'+1]=r(sd)
		local c=`c'+2
}
	ttest `x', by(high_illness)
	mat tab4[`r',7]=r(p)
	mat stars[`r',7]=(r(p)<.05)+(r(p)<.01)
	local r=`r'+1
	local c=1
}

}	
foreach i in "0,1" 1 0 {
	sum female if inlist(high_illness_burden,`i')
	mat tab4[`r',`c']=r(N)
	local c=`c'+2
}

mat rownames tab4=`eoli1' `eolc1' `eoli2' `eolc2' `eoli3' N

frmttable using "`logpath'\surgery_update_tables.rtf", addtable statmat(tab4) ///
ctitles("" "Full Sample" "" "High Illness Burden" "" "Low Illness Burden" "" ///
"p-value"\ "" "N" "%" "N" "%" "N" "%" "") title("Table 4. End of Life Care Outcomes", ///
"`deathtime'") varlabels ///
sdec(0,2,0,2,0,2,2\2,2,2,2,2,2,2\0,2,0,2,0,2,2\0,2,0,2,0,2,2\2,2,2,2,2,2,2\2,2,2,2,2,2,2\2,2,2,2,2,2,2\2,2,2,2,2,2,2\2,2,2,2,2,2,2\0,2,0,2,0,2,2\0,2,0,2,0,2,2\0) annotate(stars) asymbol(*,**)

	local eoli1 ind_icu_postsurg ind_ed_postsurg ind_hs_lte3 
	local eolc1 n_hs_days_postsurg n_hosp_days_postsurg_index n_hosp_days_postsurg_postindex
	local eoli2 died_in_hospital loc_hosp_x
	local eolc2 
	local rn: word count 1  `eolc1' 
mat tab4=J(`rn',9,.)
mat stars=J(`rn',9,0)
local r=1
local c=1
foreach num in 1 2 {
foreach x in `eola`num'' {
	sum `x'
	foreach i in "0,1" 1 {
		sum `x' if inlist(high_illness_burden,`i')
		mat tab4[`r',`c']=r(N)*r(mean)
		mat tab4[`r',`c'+1]=r(mean)*100
		local c=`c'+3
}
	tab `x' high_illness_burden, chi2
	mat tab4[`r',5]=r(p)
	mat stars[`r',5]=(r(p)<.05)+(r(p)<.01)
	local c=1
	local r=`r'+1
}
foreach x in `eolc`num'' {
	foreach i in "0,1" 1 {
		sum `x' if inlist(high_illness_burden,`i'),d
		mat tab4[`r',`c']=r(p50)
		mat tab4[`r',`c'+1]=r(p25)
		mat tab4[`r',`c'+2]=r(p75)
		local c=`c'+3
}
	ttest `x', by(high_illness)
	*mat tab4[`r',7]=r(p)
	*mat stars[`r',7]=(r(p)<.05)+(r(p)<.01)
	local r=`r'+1
	local c=1
}

}	
foreach i in "0,1" 1 {
	sum female if inlist(high_illness_burden,`i')
	mat tab4[`r',`c']=r(N)
	local c=`c'+3
}

mat rownames tab4=`eola1' `eolc1' N

frmttable using "`logpath'\surgery_update_tables.rtf", addtable statmat(tab4) ///
ctitles("" "" "Full Sample" "" ""  "High Illness Burden" ///
\ "" "Median" "25th percentile" "75th percentile"  ///
"Median" "25th percentile" "75th percentile" ) title("Table 4. End of Life Care Outcomes among decedents", ///
"`deathtime'") varlabels ///
sdec(0,0,0,0,0,0) annotate(stars) asymbol(*,**)

local eoli1 ind_icu_postsurg 
local eolc1 n_icu_days_postsurg
local eolc2 n_hs_days_postsurg n_hosp_days_postsurg_index ///
n_hosp_days_postsurg_postindex
local eoli2 ind_ed_postsurg ind_hs_any
local eoli3 died_index_stay died_in_hospital loc_hosp_x
local rn: word count `eoli1' `eolc1' `eoli2' `eolc2' `eoli3' N
	
mat tab4=J(`rn',7,.)
mat stars=J(`rn',7,0)
local r=1
local c=1

drop if died_index_stay==1
local deathtime "Death<=365 days post-surgery, not within index stay"

foreach num in 1 2 3 {
foreach x in `eoli`num'' {
	sum `x'
	foreach i in "0,1" 1 0 {
		sum `x' if inlist(high_illness_burden,`i')
		mat tab4[`r',`c']=r(N)*r(mean)
		mat tab4[`r',`c'+1]=r(mean)*100
		local c=`c'+2
}
	tab `x' high_illness_burden, chi2
	mat tab4[`r',7]=r(p)
	mat stars[`r',7]=(r(p)<.05)+(r(p)<.01)
	local c=1
	local r=`r'+1
}
foreach x in `eolc`num'' {
	foreach i in "0,1" 1 0 {
		sum `x' if inlist(high_illness_burden,`i'),d
		mat tab4[`r',`c']=r(mean)
		mat tab4[`r',`c'+1]=r(sd)
		local c=`c'+2
}
	ttest `x', by(high_illness)
	mat tab4[`r',7]=r(p)
	mat stars[`r',7]=(r(p)<.05)+(r(p)<.01)
	local r=`r'+1
	local c=1
}

}	
foreach i in "0,1" 1 0 {
	sum female if inlist(high_illness_burden,`i')
	mat tab4[`r',`c']=r(N)
	local c=`c'+2
}

mat rownames tab4=`eoli1' `eolc1' `eoli2' `eolc2' `eoli3' N

frmttable using "`logpath'\surgery_update_tables.rtf", addtable statmat(tab4) ///
ctitles("" "Full Sample" "" "High Illness Burden" "" "Low Illness Burden" "" ///
"p-value"\ "" "N" "%" "N" "%" "N" "%" "") title("Table 4. End of Life Care Outcomes", ///
"`deathtime'") varlabels ///
sdec(0,2,0,2,0,2,2\2,2,2,2,2,2,2\0,2,0,2,0,2,2\0,2,0,2,0,2,2\2,2,2,2,2,2,2\2,2,2,2,2,2,2\2,2,2,2,2,2,2\2,2,2,2,2,2,2\2,2,2,2,2,2,2\0,2,0,2,0,2,2\0,2,0,2,0,2,2\0) annotate(stars) asymbol(*,**)
	local eoli1 ind_icu_postsurg ind_ed_postsurg ind_hs_lte3 
	local eolc1 n_hs_days_postsurg n_hosp_days_postsurg_index n_hosp_days_postsurg_postindex
	local eoli2 died_in_hospital loc_hosp_x
	local eolc2 
	local rn: word count 1  `eolc1' 
mat tab4=J(`rn',9,.)
mat stars=J(`rn',9,0)
local r=1
local c=1
foreach num in 1 2 {
foreach x in `eola`num'' {
	sum `x'
	foreach i in "0,1" 1 {
		sum `x' if inlist(high_illness_burden,`i')
		mat tab4[`r',`c']=r(N)*r(mean)
		mat tab4[`r',`c'+1]=r(mean)*100
		local c=`c'+3
}
	tab `x' high_illness_burden, chi2
	mat tab4[`r',5]=r(p)
	mat stars[`r',5]=(r(p)<.05)+(r(p)<.01)
	local c=1
	local r=`r'+1
}
foreach x in `eolc`num'' {
	foreach i in "0,1" 1 {
		sum `x' if inlist(high_illness_burden,`i'),d
		mat tab4[`r',`c']=r(p50)
		mat tab4[`r',`c'+1]=r(p25)
		mat tab4[`r',`c'+2]=r(p75)
		local c=`c'+3
}
	ttest `x', by(high_illness)
	*mat tab4[`r',7]=r(p)
	*mat stars[`r',7]=(r(p)<.05)+(r(p)<.01)
	local r=`r'+1
	local c=1
}

}	
foreach i in "0,1" 1 {
	sum female if inlist(high_illness_burden,`i')
	mat tab4[`r',`c']=r(N)
	local c=`c'+3
}

mat rownames tab4=`eola1' `eolc1' N

frmttable using "`logpath'\surgery_update_tables.rtf", addtable statmat(tab4) ///
ctitles("" "" "Full Sample" "" ""  "High Illness Burden" ///
\ "" "Median" "25th percentile" "75th percentile"  ///
"Median" "25th percentile" "75th percentile" ) title("Table 4. End of Life Care Outcomes among decedents", ///
"`deathtime'") varlabels ///
sdec(0,0,0,0,0,0) annotate(stars) asymbol(*,**)

restore
}


save `datapath'\surgery_sample.dta, replace


H="tables updated 020717"
capture log close
set more off
clear all
local datapath E:\data\surgery\2012_update\final_data
local logpath E:\data\surgery\2012_update\logs

cd `datapath'

use surg_charls_util_final.dta if procedure_date-c_ivw_date_n1<=(365.25*3) ///
& age_at_surg>=65.5 & procedure_date>=td(01jul2000)
gen year=core_year_n1
gen hhid=hhid_n1
gen pn=pn_n1
merge 1:1 hhid pn year using E:\data\hrs_oop_2010\received_data\2012\helper_hours_2012.dta, keep(match master) gen(helpmerge)
rename year core_year
merge 1:1 id core_year using "E:\data\hrs_public_2012\dementia\pdem_withvarnames_ebl.dta", keep(match master) gen(demmerge)
replace n_hp=0 if missing(n_hp)
replace death_date=. if death_date<procedure_date 
replace died_365d=death_date<=is_disch_date+365
gen n_helpers_cat=n_hp
replace n_helpers_cat=2 if n_hp>2
gen n_help_0=n_hp==0
gen n_help_1=n_hp==1
gen n_help_2plus=n_hp>1
gen whiteoth=white_e | other_na
label var whiteoth "White / Other race"
gen adl_diff_index_n1=0 
gen missadldif=0
foreach x of varlist adl_diff_*n1 {
replace adl_diff_index_n1=adl_diff_index_n1+`x' if !missing(`x')
replace missadldif=1 if `x'==.
}
gen adl_impair_n1=adl_independent_core_n1==0 if !missing(adl_independent_core_n1)
gen adl_diff_impair_n1=adl_diff_index_n1>0 if !missing(adl_diff_index_n1)
gen adl_diff_no_help=adl_diff_impair_n1==1 & adl_impair_n1==0 if !missing(adl_diff_impair_n1) & !missing(adl_impair_n1)
gen adl_diff_1=adl_diff_index_n1==1 if !missing(adl_diff_index_n1) & adl_diff_no_help==1
gen adl_diff_2plus=adl_diff_index_n1>1 if !missing(adl_diff_index_n1) & adl_diff_no_help==1

gen adl_1=adl_index_core_n1==1 if !missing(adl_impair_n1)
gen adl_2=adl_index_core_n1>=2 if !missing(adl_impair_n1)
label var adl_1 "Dependent in 1 ADL"
label var adl_2 "Dependent in 2+ ADLs"
gen iadl_diff_index_n1=0

gen missiadldif=0
foreach x of varlist iadl_diff_*n1 {
replace iadl_diff_index_n1=iadl_diff_index_n1+`x' if !missing(`x')
replace missiadldif=1 if `x'==.
}
gen iadl_diff_impair_n1=iadl_diff_index_n1>0 if !missing(iadl_diff_index_n1)

gen charls_gt2_ind=charls_index_wt>2 if !missing(charls_index)
gen el_ge_3_ind=comorb_all>=3 if !missing(comorb_all)
gen charls_diab=charls_10 | charls_11
label var charls_diab "Diabetes, complicated or uncomplicated"
foreach x of varlist *m1 {
replace `x'=0 if missing(`x')
}

local symp dyspnea swelling_feet dizzy back_pain headache fatigue cough falls ///
incont

foreach x of local symp {
	gen `x'_n1n2=`x'_hrs_n1
	replace `x'_n1n2=`x'_hrs_n2 if missing(`x'_n1n2)
	local lab : var label `x'_hrs_n1
	label var `x'_n1n2 "`lab' n1 or n2"
	local symp1 `symp1' `x'_hrs_n1
	local symp2 `symp2' `x'_n1n2
}
gen op_visits_ge10_1m_ind=n_op_visits_m1>=10 if !missing(n_op_visits_m1)
gen n_adm_pre_is=n_ip_admit_m1
replace n_adm_pre_is=n_adm_pre_is-1 if admit_on_index==0 & !inlist(ip_paid_by_mc_in,0,.) ///
& n_adm_pre_is>0
gen high_utilization_ind=n_ed_op_visits_m1>0 | n_adm_pre_is>0 | op_visits_ge10_1m_ind==1
gen bmi_lt25_n1=bmi_n1<25 if !missing(bmi_n1)
/*gen leeindex_n1=1
qui replace leeindex_n1=leeindex_n1+1 if age_at_surg<70
qui replace leeindex_n1=leeindex_n1+2 if  age_at_surg>=70 & age_at_surg<75	
qui replace leeindex_n1=leeindex_n1+3 if age_at_surg>=75 & age_at_surg<80
qui replace leeindex_n1=leeindex_n1+4 if age_at_surg>=80 & age_at_surg<85
qui replace leeindex_n1=leeindex_n1+6 if age_at_surg>=85
qui replace leeindex_n1=leeindex_n1+2 if female ==0
qui replace leeindex_n1=leeindex_n1+1 if charls_diab==1
qui replace leeindex_n1=leeindex_n1+2 if charls_16==1
qui replace leeindex_n1=leeindex_n1+2 if charls_6==1
qui replace leeindex_n1=leeindex_n1+2 if charls_1==1
qui replace leeindex_n1=leeindex_n1+2 if smoke_curr_n1==1
qui replace leeindex_n1=leeindex_n1+1 if bmi_lt25_n1==1
qui replace leeindex_n1=leeindex_n1+2 if adl_diff_bh_n1==1
qui replace leeindex_n1=leeindex_n1+2 if iadl_diff_m_n1==1
qui replace leeindex_n1=leeindex_n1+1 if fl_diff_push_n1==1
qui replace leeindex_n1=leeindex_n1+2 if fl_diff_wk_many_n1==1
*/
gen charls_cancer=charls_14 | charls_16
label var charls_cancer "Cancer"
gen leeindex_n1=1
qui replace leeindex_n1=leeindex_n1+1 if age_at_surg<70
qui replace leeindex_n1=leeindex_n1+2 if  age_at_surg>=70 & age_at_surg<75	
qui replace leeindex_n1=leeindex_n1+3 if age_at_surg>=75 & age_at_surg<80
qui replace leeindex_n1=leeindex_n1+4 if age_at_surg>=80 & age_at_surg<85
qui replace leeindex_n1=leeindex_n1+6 if age_at_surg>=85
qui replace leeindex_n1=leeindex_n1+2 if female ==0
qui replace leeindex_n1=leeindex_n1+1 if dm_hrs_n1==1
qui replace leeindex_n1=leeindex_n1+2 if cancer_hrs_n1==1
qui replace leeindex_n1=leeindex_n1+2 if lung_hrs_n1== 1
qui replace leeindex_n1=leeindex_n1+2 if chf_hrs_n1 ==1
qui replace leeindex_n1=leeindex_n1+2 if smoke_curr_n1==1
qui replace leeindex_n1=leeindex_n1+1 if bmi_lt25_n1==1
qui replace leeindex_n1=leeindex_n1+2 if adl_diff_bh_n1==1
qui replace leeindex_n1=leeindex_n1+2 if iadl_diff_m_n1==1
qui replace leeindex_n1=leeindex_n1+1 if fl_diff_push_n1==1
qui replace leeindex_n1=leeindex_n1+2 if fl_diff_wk_many_n1==1

gen pain_mod_or_sev=pain_level_hrs_n1>=2 & pain_hrs_n1==1
gen pain_none_mild=pain_hrs_n1==0 | pain_level_hrs_n1==1
gen pain_mod=pain_level_hrs_n1==2
gen pain_sev=pain_level_hrs_n1==3
gen lee_index_ge13_ind=leeindex_n1>=13
gen pr_dem_gt50_n1=pdem>.5 if !missing(pdem)
gen tot_preop_illness_burden=0
label var tot_preop "Total Preop Illness Burden (mean, sd)"
gen cesd_tot_gt3_n1=cesd_tot_n1>3 if !missing(cesd_tot_n1)
gen symptom_burden=!pain_none_mild if !missing(pain_none_mild)
replace symptom_burden=1 if cesd_tot_gt3_n1==1
foreach x in comorb_31 adl_impair_n1 charls_gt2_ind high_utilizat lee_index_ge ///
 symptom_burden {
	replace tot_preop_illness_burden=tot_preop_illness_burden+`x' if !missing(`x')
}

gen high_illness_burden=tot_preop_illness_burden>=2 if !missing(tot_preop_illness_burden)
gen age_lt75=age_at_surg<75
gen age_75_84=age_at_surg>=75 & age_at_surg<85
gen age_85plus=age_at_surg>=85
//2/8/17--using first occurance to determine
gen readmission_365d_ind=first_readmit-is_disch_d<=365
gen readmission_30d_ind=first_readmit-is_disch_d<=30
/*gen readmission_365d_ind=0
gen readmission_30d_ind=n_ip_admit_m1p>0 & !missing(n_ip_admit_m1p)
forvalues i=1/12 {
	replace readmission_365d_ind=1 if n_ip_admit_m`i'p>0 & !missing(n_ip_admit_m`i'p)
}*/
gen ind_hs_any=n_hs_days_post>=1 if !missing(n_hs_days_post)
*replace ind_hs_any=0 if n_hs_days_post<4
label var n_hosp_days_presurg_index "Days in hospital index stay pre surgery"
label var ind_hs_any "Any Hospice post discharge"
gen ind_hs_lte3=n_hs_days_p<=3
label var n_hs_days_tot "Total Hospice days (mean sd)"
gen n_hs_days_cond=n_hs_days_tot if n_hs_days_tot
label var n_hs_days_cond "Total Hospice days if any"
label var n_hs_days_postsurg "Hospice days post-discharge (mean,sd)"
gen n_hs_days_postsurg_cond=n_hs_days_postsurg if n_hs_days_post
label var n_hs_days_postsurg_cond "Hospice days post-discharge, if any"
label var age_lt75 "Age at surgery <75"
label var age_75_84 "Age at surgery 75-84"
label var age_85 "Age at surgery 85+"
label var female "Female"
label var adl_diff_no "Reported ADL difficulty, no help"
label var adl_diff_1 "Reported difficulty with 1 ADL, no help"
label var adl_diff_2 "Reported difficulty with 2+ ADLs, no help"
label var iadl_diff_imp "Reported difficulty with IADLs"
label var n_help_0 "Total Helpers: 0"
label var n_help_1 "Total Helpers: 1"
label var n_help_2 "Total Helpers: 2+"
label var pr_dem_gt50_n1 "Probability of Dementia >.5"
label var comorb_31 "Dementia, from claims"
label var charls_gt2 "Charlson score >2"
label var lee_index_ge13 "Lee Index 13+ at n1 ivw"
label var symptom_burden "Symptom Burden" 
label var pain_none_mild "Pain: none or mild"
label var pain_mod_or_sev "Pain: moderate or severe"
label var pain_mod "Pain: moderate"
label var pain_sev "Pain: severe"
label var cesd_tot_gt3 "CESD total >3"
label var comp_any "Any complication"
label var readmission_30d_ind "Hospital readmission within 30d of discharge"
label var readmission_365d_ind "Hospital readmission within 365d of discharge"
label var died_365d "Died within 365 days of discharge"
label var ind_icu_po "ICU stay within 365 days of discharge"
label var ind_ed_po "ED visit within 365 days of discharge"
label var ind_hs_lte3 "<=3 days hospice"
label var n_hs_days_postsurg "Days on hospice after discharge"
label var n_hosp_days_postsurg_index "Days in hospital index stay after surgery"
label var n_hosp_days_postsurg_postindex "Days in hospital post index stay 365 days post discharge"
label var died_in_ho "Died in hospital after index stay, from claims"
label var died_index_stay "Died in hospital during index stay"
label var n_icu_d "ICU days within 365 days of discharge"
foreach x of varlist n_icu_d* {
gen `x'_cond=`x' if `x'>0
label var `x'_cond "ICU days within 365 days of discharge, if any"
}
gen n_hosp_days_postindex_cond= n_hosp_days_postsurg_post if  n_hosp_days_postsurg_post>0
label var n_hosp_days_postindex_cond "Days in hospital post index stay if any"
replace died_index_stay=0 if death_date-procedure_date==469
local vars age_lt75 age_75_84 age_85plus female white_e black_e hisp_eth_e other_na_api_race_e ///
whiteoth adl_independent_core_n1 ///
adl_diff_no_help adl_1 adl_2 iadl_diff_impair_n1 n_help_0 n_help_1 n_help_2plus ///
nhres_n1 comorb_31_0_n12m pr_dem_gt50_n1 charls_gt2_ind charls_cancer charls_diab charls_2 ///
comorb_32_0_n12m charls_3 charls_4 charls_6 charls_13 ///
lee_index_ge13_ind symptom_burden pain_none_mild pain_mod_or_sev pain_mod pain_sev ///
cesd_tot_gt3_n1 `symp1' `symp2'
local rn : word count `vars' 1
local r=1
local c=1

mat tab=J(`rn',3,.)
mat stars=J(`rn',3,0)

foreach x of local vars {
	sum female
	local tot=r(N)
	foreach i in "0,1"  {
		sum `x' if inlist(high_illness,`i')
			mat tab[`r',`c']=r(mean)*r(N)
			mat tab[`r',`c'+1]=r(mean)*100
			mat tab[`r',`c'+2]=`tot'-r(N)
			local c=`c'+2
}	
	/*tab `x' high_illness, chi2
	mat tab[`r',7]=r(p)
	mat stars[`r',7]=(r(p)<.05)+(r(p)<.01)*/
	local c=1
	local r=`r'+1
}
foreach i in "0,1" {
	sum tot_preop_illness_burden if inlist(high_illness,`i')
	mat tab[`r',`c']=r(N)
	*mat tab[`r'-1,`c']=r(mean)
	*mat tab[`r'-1,`c'+1]=r(sd)
	local c=`c'+2
}

mat rownames tab=`vars' N

frmttable using "`logpath'\surgery_update_tables.rtf", statmat(tab) ///
ctitles("" "Full Sample N" "%/SD" "Missing") title("Table 1: Cohort Characteristics") varlabels ///
sdec(0,2,0) replace annotate(stars) asymbol(*,**) ///


local rn : word count `vars' 1
local r=1
local c=1

mat tab=J(`rn',6,.)
mat stars=J(`rn',6,0)

foreach x of local vars {
	foreach i in 1 0 {
		sum `x' if inlist(high_illness,`i')
			mat tab[`r',`c']=r(mean)*r(N)
			mat tab[`r',`c'+1]=r(mean)*100
			local c=`c'+2
}	
	if !inlist("`x'","age_lt75", "age_75_84","age_85plus","white_e","black_e", ///
	"hisp_eth_e", "whiteoth","other_na_api_race_e") & !inlist("`x'", "adl_1", "adl_2", ///
	"adl_diff_no_help") {
	tab `x' high_illness, chi2
	mat tab[`r',5]=r(p)
	mat stars[`r',5]=(r(p)<.05)+(r(p)<.01)
}
	if "`x'"=="age_lt75" {
	tab age_cat_2 high_illness, chi2
mat tab[`r',5]=r(p)
}
	if "`x'"=="white_e"{
gen racecat=whiteoth
replace racecat=2 if black
replace racecat=3 if hisp_eth_e
tab racecat high_illness, chi2
mat tab[`r',5]=r(p)
}

	local c=1
	local r=`r'+1
}
foreach i in 1 0 {
	sum tot_preop_illness_burden if inlist(high_illness,`i')
	mat tab[`r',`c']=r(N)
	*mat tab[`r'-1,`c']=r(mean)
	*mat tab[`r'-1,`c'+1]=r(sd)
	local c=`c'+2
}
mat rownames tab=`vars' N

frmttable using "`logpath'\surgery_update_tables.rtf", statmat(tab) ctitles("" "High illness burden" "" "Low illness burden" "" "P-value" \ ///
"" "N/mean" "%/SD" "N/mean" "%/SD" "") title("Table 1a: Cohort Characteristics, by illness burden") varlabels ///
sdec(0,2,0,2,2) addtable annotate(stars) asymbol(*,**)
mat tab2=J(6,6,.)
local r=1
local c=3
preserve
replace tot_preop_ill=5 if tot_preop_ill==6
sum tot_preop_illness_burden
local denom=r(N)
 forvalues i=0/5 {
	sum tot_preop_illness_burden if tot_preop_illness_burden==`i'
	mat tab2[`r',1]=r(N)
	mat tab2[`r',2]=(r(N)/`denom')*100
	local r=`r'+1
}
local r=1
foreach x in died_index_stay died_30d ///
 readmission_30d_ind readmission_365d_ind {
	forvalues i=0/5 {
		sum `x' if tot_preop_illness_burden==`i'
		mat tab2[`r',`c']=r(mean)*100
		local r=`r'+1
}
	local c=`c'+1
	local r=1
}
restore
mat rownames tab2=0 1 2 3 4 "5/6"
frmttable using "`logpath'\surgery_update_tables.rtf", statmat(tab2) ///
ctitles("Illness Burden" "N/mean" "% of total" "% die index stay" "% die 365d" ///
"% readmit 30d" "% readmit 365d") sdec(0,2) ///
title("Table 2. Preoperative Illness Burden Among Cohort") addtable varlabels

preserve
foreach a in b c d {

if "`a'"=="d" drop if died_365d 
if "`a'"=="d" local gp "Survived 365d post discharge"
local vars comp_any readmission_30d_ind readmission_365d_ind ind_icu_postsurg ///
ind_ed_postsurg n_hosp_days_presurg_index n_hosp_days_postsurg_index ///
n_hosp_days_postsurg_postindex died_365d ///
died_index_stay 
local rn : word count `vars' 1
mat tab3=J(`rn',7,.)
mat stars=J(`rn',7,0)
local r=1
local c=1

foreach x in `vars' {
	sum `x'
	local denom=r(N)
	foreach i in "0,1" 1 0 {
	if !inlist(substr("`x'",1,2),"n_") {
	sum `x' if inlist(high_illness_burden,`i')
		mat tab3[`r',`c']=r(N)*r(mean)
		mat tab3[`r',`c'+1]=r(mean)*100
}
	else {
		sum `x' if inlist(high_illness_burden,`i'),d
		mat tab3[`r',`c']=r(mean)
		mat tab3[`r',`c'+1]=r(sd)
}		
	local c=`c'+2
}
	tab `x' high_illness_burden, chi2
	mat tab3[`r',7]=r(p)
	mat stars[`r',7]=(r(p)<.05)+(r(p)<.01)
	if inlist(substr("`x'",1,2),"n_") {
		ttest `x', by(high_illness)
		mat tab3[`r',7]=r(p)
		mat stars[`r',7]=(r(p)<.05)+(r(p)<.01)
}

	local r=`r'+1
	local c=1
}
	foreach i in "0,1" 1 0 {
		sum female if inlist(high_ill,`i')
		mat tab3[`r',`c']=r(N)
		local c=`c'+2
}
mat rownames tab3=`vars' N

frmttable using "`logpath'\surgery_update_tables.rtf", addtable statmat(tab3) ///
ctitles("" "Full Sample" "" "High Illness Burden" "" "Low Illness Burden" "" ///
"p-value"\ "" "N/mean" "%/SD" "N/mean" "%/SD" "" "%/SD" "") ///
title("Table 3. A Comparison of Adverse outcomes" "`gp'") ///
sdec(0,2,0,2,0,2,2\0,2,0,2,0,2,2\0,2,0,2,0,2,2\0,2,0,2,0,2,2\0,2,0,2,0,2,2\ ///
2,2,2,2,2,2,2 ///
\2,2,2,2,2,2,2\2,2,2,2,2,2,2\0,2,0,2,0,2,2) annotate(stars) asymbol(*,**) varlabels
drop if died_index_stay
local gp "Did not die during index stay"
}
restore
label var loc_hosp_x "Died in hospital, from exit"
local deathtime "Full sample" 
foreach time in 1 /*2 3*/ {

	local eoli1 ind_icu_postsurg 
	local eolc1 n_icu_days_postsurg n_icu_days_postsurg_cond
	local eolc2 n_hs_days_postsurg n_hs_days_postsurg_cond n_hosp_days_presurg_index n_hosp_days_postsurg_index ///
	n_hosp_days_postsurg_postindex n_hosp_days_postindex_cond 
	local eoli2 ind_ed_postsurg ind_hs_any
	local eoli3 died_index_stay died_in_hospital loc_hosp_x
	local rn: word count `eoli1' `eolc1' `eoli2' `eolc2' `eoli3' N
	
	mat tab4=J(`rn',7,.)
	mat stars=J(`rn',7,0)
	local r=1
	local c=1

	preserve
	if `time'==1 {
		local deathtime "Death<=365 days post-surgery"
		keep if died_365d
}
	if `time'==2 {
		local deathtime "Died index stay"
		keep if died_index_stay
}
	if `time'==3 {
		local deathtime "Death 31-365 days post-surgery"
		keep if died_356d & !died_index_stay
}

foreach num in 1 2 3 {
foreach x in `eoli`num'' {
	sum `x'
	foreach i in "0,1" 1 0 {
		sum `x' if inlist(high_illness_burden,`i')
		mat tab4[`r',`c']=r(N)*r(mean)
		mat tab4[`r',`c'+1]=r(mean)*100
		local c=`c'+2
}
	tab `x' high_illness_burden, chi2
	mat tab4[`r',7]=r(p)
	mat stars[`r',7]=(r(p)<.05)+(r(p)<.01)
	local c=1
	local r=`r'+1
}
foreach x in `eolc`num'' {
	foreach i in "0,1" 1 0 {
		sum `x' if inlist(high_illness_burden,`i'),d
		mat tab4[`r',`c']=r(mean)
		mat tab4[`r',`c'+1]=r(sd)
		local c=`c'+2
}
	ttest `x', by(high_illness)
	mat tab4[`r',7]=r(p)
	mat stars[`r',7]=(r(p)<.05)+(r(p)<.01)
	local r=`r'+1
	local c=1
}

}	
foreach i in "0,1" 1 0 {
	sum female if inlist(high_illness_burden,`i')
	mat tab4[`r',`c']=r(N)
	local c=`c'+2
}

mat rownames tab4=`eoli1' `eolc1' `eoli2' `eolc2' `eoli3' N

frmttable using "`logpath'\surgery_update_tables.rtf", addtable statmat(tab4) ///
ctitles("" "Full Sample" "" "High Illness Burden" "" "Low Illness Burden" "" ///
"p-value"\ "" "N/mean" "%/SD" "N/mean" "%/SD" "N/mean" "%/SD" "") title("Table 4. End of Life Care Outcomes", ///
"`deathtime'") varlabels ///
sdec(0,2,0,2,0,2,2\2,2,2,2,2,2,2\2,2,2,2,2,2,2\0,2,0,2,0,2,2\0,2,0,2,0,2,2\ ///
2,2,2,2,2,2,2\ ///
2,2,2,2,2,2,2\2,2,2,2,2,2,2\2,2,2,2,2,2,2\2,2,2,2,2,2,2\2,2,2,2,2,2,2\ ///
0,2,0,2,0,2,2\0,2,0,2,0,2,2\0,2,0,2,0,2,2\0) annotate(stars) asymbol(*,**)

	local eoli1 ind_icu_postsurg ind_ed_postsurg ind_hs_lte3 
	local eolc1 n_hs_days_postsurg n_hs_days_postsurg_cond n_hosp_days_presurg_index n_hosp_days_postsurg_index ///
	n_hosp_days_postsurg_postindex n_hosp_days_postindex_cond 
	local eoli2 died_in_hospital loc_hosp_x
	local eolc2 
	local rn: word count 1  `eolc1' 
mat tab4=J(`rn',9,.)
mat stars=J(`rn',9,0)
local r=1
local c=1
foreach num in 1 2 {
foreach x in `eola`num'' {
	sum `x'
	foreach i in "0,1" 1 {
		sum `x' if inlist(high_illness_burden,`i')
		mat tab4[`r',`c']=r(N)*r(mean)
		mat tab4[`r',`c'+1]=r(mean)*100
		local c=`c'+3
}
	tab `x' high_illness_burden, chi2
	mat tab4[`r',5]=r(p)
	mat stars[`r',5]=(r(p)<.05)+(r(p)<.01)
	local c=1
	local r=`r'+1
}
foreach x in `eolc`num'' {
	foreach i in "0,1" 1 {
		sum `x' if inlist(high_illness_burden,`i'),d
		mat tab4[`r',`c']=r(p50)
		mat tab4[`r',`c'+1]=r(p25)
		mat tab4[`r',`c'+2]=r(p75)
		local c=`c'+3
}
	ttest `x', by(high_illness)
	*mat tab4[`r',7]=r(p)
	*mat stars[`r',7]=(r(p)<.05)+(r(p)<.01)
	local r=`r'+1
	local c=1
}

}	
foreach i in "0,1" 1 {
	sum female if inlist(high_illness_burden,`i')
	mat tab4[`r',`c']=r(N)
	local c=`c'+3
}

mat rownames tab4=`eola1' `eolc1' N

frmttable using "`logpath'\surgery_update_tables.rtf", addtable statmat(tab4) ///
ctitles("" "" "Full Sample" "" ""  "High Illness Burden" ///
\ "" "Median" "25th percentile" "75th percentile"  ///
"Median" "25th percentile" "75th percentile" ) title("Table 4. End of Life Care Outcomes among decedents", ///
"`deathtime'") varlabels ///
sdec(0,0,0,0,0,0) annotate(stars) asymbol(*,**)

restore
foreach dt in 1 0  {
preserve
keep if died_365d & died_index_stay==`dt'


local eoli1 ind_icu_postsurg 
local eolc1 n_icu_days_postsurg n_icu_days_postsurg_cond
local eolc2 n_hs_days_postsurg n_hs_days_postsurg_cond n_hosp_days_presurg_index n_hosp_days_postsurg_index ///
n_hosp_days_postsurg_postindex n_hosp_days_postindex_cond 
local eoli2 ind_ed_postsurg ind_hs_any
local eoli3 died_index_stay died_in_hospital loc_hosp_x
local rn: word count `eoli1' `eolc1' `eoli2' `eolc2' `eoli3' N

	
mat tab4=J(`rn',7,.)
mat stars=J(`rn',7,0)
local r=1
local c=1

if `dt'==0 local deathtime "Death<=365 days post-surgery, not within index stay"
if `dt'==1 local deathtime "Died index stay"
foreach num in 1 2 3 {
foreach x in `eoli`num'' {
	cap sum `x'
	foreach i in "0,1" 1 0 {
		cap sum `x' if inlist(high_illness_burden,`i')
		mat tab4[`r',`c']=r(N)*r(mean)
		mat tab4[`r',`c'+1]=r(mean)*100
		local c=`c'+2
}
	cap tab `x' high_illness_burden, chi2
	mat tab4[`r',7]=r(p)
	mat stars[`r',7]=(r(p)<.05)+(r(p)<.01)
	local c=1
	local r=`r'+1
}
foreach x in `eolc`num'' {
	foreach i in "0,1" 1 0 {
		cap sum `x' if inlist(high_illness_burden,`i'),d
		mat tab4[`r',`c']=r(mean)
		mat tab4[`r',`c'+1]=r(sd)
		local c=`c'+2
}
	cap ttest `x', by(high_illness)
	mat tab4[`r',7]=r(p)
	mat stars[`r',7]=(r(p)<.05)+(r(p)<.01)
	local r=`r'+1
	local c=1
}

}	
foreach i in "0,1" 1 0 {
	sum female if inlist(high_illness_burden,`i')
	mat tab4[`r',`c']=r(N)
	local c=`c'+2
}

mat rownames tab4=`eoli1' `eolc1' `eoli2' `eolc2' `eoli3' N

frmttable using "`logpath'\surgery_update_tables.rtf", addtable statmat(tab4) ///
ctitles("" "Full Sample" "" "High Illness Burden" "" "Low Illness Burden" "" ///
"p-value"\ "" "N/mean" "%/SD" "N/mean" "%/SD" "N/mean" "%/SD" "") title("Table 4. End of Life Care Outcomes", ///
"`deathtime'") varlabels ///
sdec(0,2,0,2,0,2,2\2,2,2,2,2,2,2\2,2,2,2,2,2,2\0,2,0,2,0,2,2\0,2,0,2,0,2,2\ ///
2,2,2,2,2,2,2\ ///
2,2,2,2,2,2,2\2,2,2,2,2,2,2\2,2,2,2,2,2,2\2,2,2,2,2,2,2\2,2,2,2,2,2,2\ ///
0,2,0,2,0,2,2\0,2,0,2,0,2,2\0,2,0,2,0,2,2\0) annotate(stars) asymbol(*,**)
	local eoli1 ind_icu_postsurg ind_ed_postsurg ind_hs_lte3 
	local eolc1 n_hs_days_postsurg n_hs_days_postsurg_cond n_hosp_days_presurg_index n_hosp_days_postsurg_index ///
	n_hosp_days_postsurg_postindex n_hosp_days_postindex_cond 
	local eoli2 died_in_hospital loc_hosp_x
	local eolc2 
	local rn: word count 1  `eolc1' 
mat tab4=J(`rn',9,.)
mat stars=J(`rn',9,0)
local r=1
local c=1
foreach num in 1 2 {
foreach x in `eola`num'' {
	sum `x'
	foreach i in "0,1" 1 {
		sum `x' if inlist(high_illness_burden,`i')
		mat tab4[`r',`c']=r(N)*r(mean)
		mat tab4[`r',`c'+1]=r(mean)*100
		local c=`c'+3
}
	tab `x' high_illness_burden, chi2
	mat tab4[`r',5]=r(p)
	mat stars[`r',5]=(r(p)<.05)+(r(p)<.01)
	local c=1
	local r=`r'+1
}
foreach x in `eolc`num'' {
	foreach i in "0,1" 1 {
		sum `x' if inlist(high_illness_burden,`i'),d
		mat tab4[`r',`c']=r(p50)
		mat tab4[`r',`c'+1]=r(p25)
		mat tab4[`r',`c'+2]=r(p75)
		local c=`c'+3
}
	cap ttest `x', by(high_illness)
	*mat tab4[`r',7]=r(p)
	*mat stars[`r',7]=(r(p)<.05)+(r(p)<.01)
	local r=`r'+1
	local c=1
}

}	
foreach i in "0,1" 1 {
	sum female if inlist(high_illness_burden,`i')
	mat tab4[`r',`c']=r(N)
	local c=`c'+3
}

mat rownames tab4=`eola1' `eolc1' N

frmttable using "`logpath'\surgery_update_tables.rtf", addtable statmat(tab4) ///
ctitles("" "" "Full Sample" "" ""  "High Illness Burden" ///
\ "" "Median" "25th percentile" "75th percentile"  ///
"Median" "25th percentile" "75th percentile" ) title("Table 4. End of Life Care Outcomes among decedents", ///
"`deathtime'") varlabels ///
sdec(0,0,0,0,0,0) annotate(stars) asymbol(*,**)

restore
}

}
save `datapath'\surgery_sample.dta, replace


H="tables updated 022117"
capture log close
set more off
clear all
local datapath E:\data\surgery\2012_update\final_data
local logpath E:\data\surgery\2012_update\logs

cd `datapath'

use surg_charls_util_final.dta if procedure_date-c_ivw_date_n1<=(365.25*3) ///
& age_at_surg>=65.5 & procedure_date>=td(01jan2001) & part_ab_1y==1 & hmo_d_1y==0
gen year=core_year_n1
gen hhid=hhid_n1
gen pn=pn_n1
merge 1:1 hhid pn year using E:\data\hrs_oop_2010\received_data\2012\helper_hours_2012.dta, keep(match master) gen(helpmerge)
rename year core_year
merge 1:1 id core_year using "E:\data\hrs_public_2012\dementia\pdem_withvarnames_ebl.dta", keep(match master) gen(demmerge)
replace n_hp=0 if missing(n_hp)
replace death_date=. if death_date<procedure_date 
replace died_365d=death_date<=is_disch_date+365
gen n_helpers_cat=n_hp
replace n_helpers_cat=2 if n_hp>2
replace n_helpers_cat=0 if hlphrs==0
gen n_help_0=n_hp==0 | hlphrs==0
gen n_help_1=n_hp==1 & hlphrs>0 & !missing(hlphrs)
gen n_help_2plus=n_hp>1 & hlphrs>0 & !missing(hlphrs)
gen ind_help_any=n_hp>0 & hlphrs>0 & !missing(hlphrs) 
gen whiteoth=white_e | other_na
label var whiteoth "White / Other race"
gen adl_diff_index_n1=0 
gen missadldif=0
foreach x of varlist adl_diff_*n1 {
replace adl_diff_index_n1=adl_diff_index_n1+`x' if !missing(`x')
replace missadldif=1 if `x'==.
}
gen adl_impair_n1=adl_independent_core_n1==0 if !missing(adl_independent_core_n1)
gen adl_diff_impair_n1=adl_diff_index_n1>0 if !missing(adl_diff_index_n1)
gen adl_diff_no_help=adl_diff_impair_n1==1 & adl_impair_n1==0 if !missing(adl_diff_impair_n1) & !missing(adl_impair_n1)
gen adl_diff_1=adl_diff_index_n1==1 if !missing(adl_diff_index_n1) & adl_diff_no_help==1
gen adl_diff_2plus=adl_diff_index_n1>1 if !missing(adl_diff_index_n1) & adl_diff_no_help==1

gen adl_1=adl_index_core_n1==1 if !missing(adl_impair_n1)
gen adl_2=adl_index_core_n1>=2 if !missing(adl_impair_n1)
label var adl_1 "Dependent in 1 ADL"
label var adl_2 "Dependent in 2+ ADLs"
gen iadl_diff_index_n1=0

gen missiadldif=0
foreach x of varlist iadl_diff_*n1 {
replace iadl_diff_index_n1=iadl_diff_index_n1+`x' if !missing(`x')
replace missiadldif=1 if `x'==.
}
gen iadl_diff_impair_n1=iadl_diff_index_n1>0 if !missing(iadl_diff_index_n1)

gen charls_gt2_ind=charls_index_wt>2 if !missing(charls_index)
gen el_ge_3_ind=comorb_all>=3 if !missing(comorb_all)
gen charls_diab=charls_10 | charls_11
label var charls_diab "Diabetes, complicated or uncomplicated"
foreach x of varlist *m1 {
replace `x'=0 if missing(`x')
}

local symp dyspnea swelling_feet dizzy back_pain headache fatigue cough falls ///
incont

foreach x of local symp {
	gen `x'_n1n2=`x'_hrs_n1
	replace `x'_n1n2=`x'_hrs_n2 if missing(`x'_n1n2)
	local lab : var label `x'_hrs_n1
	label var `x'_n1n2 "`lab' n1 or n2"
	local symp1 `symp1' `x'_hrs_n1
	local symp2 `symp2' `x'_n1n2
}
gen op_visits_ge10_12m_ind=n_op_visits_12>=10 & !missing(n_op_visits_12m)
gen n_adm_pre_is=n_ip_admit_12m
replace n_adm_pre_is=n_adm_pre_is-1 if admit_on_index==0 & !inlist(ip_paid_by_mc_in,0,.) ///
& n_adm_pre_is>0
foreach x in n_ed_op_visits_12m n_ip_admit_12m {
replace `x'=0 if missing(`x')
}
egen ip_ed_12m=rowtotal(n_ed_op_visits_12m n_ip_admit_12m)
gen high_utilization_ind=ip_ed_12m>=2 |  op_visits_ge10_12m_ind==1
gen bmi_lt25_n1=bmi_n1<25 if !missing(bmi_n1)
/*gen leeindex_n1=1
qui replace leeindex_n1=leeindex_n1+1 if age_at_surg<70
qui replace leeindex_n1=leeindex_n1+2 if  age_at_surg>=70 & age_at_surg<75	
qui replace leeindex_n1=leeindex_n1+3 if age_at_surg>=75 & age_at_surg<80
qui replace leeindex_n1=leeindex_n1+4 if age_at_surg>=80 & age_at_surg<85
qui replace leeindex_n1=leeindex_n1+6 if age_at_surg>=85
qui replace leeindex_n1=leeindex_n1+2 if female ==0
qui replace leeindex_n1=leeindex_n1+1 if charls_diab==1
qui replace leeindex_n1=leeindex_n1+2 if charls_16==1
qui replace leeindex_n1=leeindex_n1+2 if charls_6==1
qui replace leeindex_n1=leeindex_n1+2 if charls_1==1
qui replace leeindex_n1=leeindex_n1+2 if smoke_curr_n1==1
qui replace leeindex_n1=leeindex_n1+1 if bmi_lt25_n1==1
qui replace leeindex_n1=leeindex_n1+2 if adl_diff_bh_n1==1
qui replace leeindex_n1=leeindex_n1+2 if iadl_diff_m_n1==1
qui replace leeindex_n1=leeindex_n1+1 if fl_diff_push_n1==1
qui replace leeindex_n1=leeindex_n1+2 if fl_diff_wk_many_n1==1
*/
gen charls_cancer=charls_14 | charls_16
label var charls_cancer "Cancer"
gen leeindex_n1=1
qui replace leeindex_n1=leeindex_n1+1 if age_at_surg<70
qui replace leeindex_n1=leeindex_n1+2 if  age_at_surg>=70 & age_at_surg<75	
qui replace leeindex_n1=leeindex_n1+3 if age_at_surg>=75 & age_at_surg<80
qui replace leeindex_n1=leeindex_n1+4 if age_at_surg>=80 & age_at_surg<85
qui replace leeindex_n1=leeindex_n1+6 if age_at_surg>=85
qui replace leeindex_n1=leeindex_n1+2 if female ==0
qui replace leeindex_n1=leeindex_n1+1 if dm_hrs_n1==1
qui replace leeindex_n1=leeindex_n1+2 if cancer_hrs_n1==1
qui replace leeindex_n1=leeindex_n1+2 if lung_hrs_n1== 1
qui replace leeindex_n1=leeindex_n1+2 if chf_hrs_n1 ==1
qui replace leeindex_n1=leeindex_n1+2 if smoke_curr_n1==1
qui replace leeindex_n1=leeindex_n1+1 if bmi_lt25_n1==1
qui replace leeindex_n1=leeindex_n1+2 if adl_diff_bh_n1==1
qui replace leeindex_n1=leeindex_n1+2 if iadl_diff_m_n1==1
qui replace leeindex_n1=leeindex_n1+1 if fl_diff_push_n1==1
qui replace leeindex_n1=leeindex_n1+2 if fl_diff_wk_many_n1==1

gen pain_mod_or_sev=pain_level_hrs_n1>=2 & pain_hrs_n1==1
gen pain_none_mild=pain_hrs_n1==0 | pain_level_hrs_n1==1
gen pain_mod=pain_level_hrs_n1==2
gen pain_sev=pain_level_hrs_n1==3
gen lee_index_ge13_ind=leeindex_n1>=13
gen pr_dem_gt50_n1=pdem>.5 if !missing(pdem)
gen tot_preop_illness_burden=0
label var tot_preop "Total Preop Illness Burden (mean, sd)"
gen cesd_tot_gt3_n1=cesd_tot_n1>3 if !missing(cesd_tot_n1)
gen symptom_burden=!pain_none_mild if !missing(pain_none_mild)
replace symptom_burden=1 if cesd_tot_gt3_n1==1
foreach x in comorb_31_0_n12m adl_impair_n1 charls_gt2_ind high_utilizat lee_index_ge13 ///
 ind_help_any {
	replace tot_preop_illness_burden=tot_preop_illness_burden+`x' if !missing(`x')
}

gen high_illness_burden=tot_preop_illness_burden>=2 if !missing(tot_preop_illness_burden)
gen age_lt75=age_at_surg<75
gen age_75_84=age_at_surg>=75 & age_at_surg<85
gen age_85plus=age_at_surg>=85
//2/8/17--using first occurance to determine
gen readmission_365d_ind=first_readmit-is_disch_d<=365
gen readmission_30d_ind=first_readmit-is_disch_d<=30
/*gen readmission_365d_ind=0
gen readmission_30d_ind=n_ip_admit_m1p>0 & !missing(n_ip_admit_m1p)
forvalues i=1/12 {
	replace readmission_365d_ind=1 if n_ip_admit_m`i'p>0 & !missing(n_ip_admit_m`i'p)
}*/
gen ind_hs_any=n_hs_days_post>=1 if !missing(n_hs_days_post)
*replace ind_hs_any=0 if n_hs_days_post<4
label var n_hosp_days_presurg_index "Days in hospital index stay pre surgery"
label var ind_hs_any "Any Hospice post discharge"
gen ind_hs_lte3=n_hs_days_p<=3
label var n_hs_days_tot "Total Hospice days (mean sd)"
gen n_hs_days_cond=n_hs_days_tot if n_hs_days_tot
label var n_hs_days_cond "Total Hospice days if any"
label var n_hs_days_postsurg "Hospice days post-discharge (mean,sd)"
gen n_hs_days_postsurg_cond=n_hs_days_postsurg if n_hs_days_post
label var n_hs_days_postsurg_cond "Hospice days post-discharge, if any"
label var age_lt75 "Age at surgery <75"
label var age_75_84 "Age at surgery 75-84"
label var age_85 "Age at surgery 85+"
label var female "Female"
label var adl_diff_no "Reported ADL difficulty, no help"
label var adl_diff_1 "Reported difficulty with 1 ADL, no help"
label var adl_diff_2 "Reported difficulty with 2+ ADLs, no help"
label var iadl_diff_imp "Reported difficulty with IADLs"
label var n_help_0 "Total Helpers: 0"
label var n_help_1 "Total Helpers: 1"
label var n_help_2 "Total Helpers: 2+"
label var pr_dem_gt50_n1 "Probability of Dementia >.5"
label var comorb_31_0_n12m "Dementia, from claims"
label var charls_gt2 "Charlson score >2"
label var lee_index_ge13 "Lee Index 13+ at n1 ivw"
label var symptom_burden "Symptom Burden" 
label var pain_none_mild "Pain: none or mild"
label var pain_mod_or_sev "Pain: moderate or severe"
label var pain_mod "Pain: moderate"
label var pain_sev "Pain: severe"
label var cesd_tot_gt3 "CESD total >3"
label var comp_any "Any complication"
label var readmission_30d_ind "Hospital readmission within 30d of discharge"
label var readmission_365d_ind "Hospital readmission within 365d of discharge"
label var died_365d "Died within 365 days of discharge"
label var ind_icu_po "ICU stay within 365 days of discharge"
label var ind_ed_po "ED visit within 365 days of discharge"
label var ind_hs_lte3 "<=3 days hospice"
label var n_hs_days_postsurg "Days on hospice after discharge"
label var n_hosp_days_postsurg_index "Days in hospital index stay after surgery"
label var n_hosp_days_postsurg_postindex "Days in hospital post index stay 365 days post discharge"
label var died_in_ho "Died in hospital after index stay, from claims"
label var died_index_stay "Died in hospital during index stay"
label var n_icu_d "ICU days within 365 days of discharge"
foreach x of varlist n_icu_d* {
gen `x'_cond=`x' if `x'>0
label var `x'_cond "ICU days within 365 days of discharge, if any"
}
label var high_utilization "High utilization 12m prior"
label var ind_help_any "1+ helper, 1+ hr/wk"
label var adl_impair_n1 "Dependent in 1+ ADL"
gen n_hosp_days_postindex_cond= n_hosp_days_postsurg_post if  n_hosp_days_postsurg_post>0
label var n_hosp_days_postindex_cond "Days in hospital post index stay if any"
replace died_index_stay=0 if death_date-procedure_date==469
local vars age_lt75 age_75_84 age_85plus female white_e black_e hisp_eth_e other_na_api_race_e ///
whiteoth adl_independent_core_n1 ///
adl_diff_no_help adl_1 adl_2 iadl_diff_impair_n1 n_help_0 n_help_1 n_help_2plus ///
nhres_n1 comorb_31_0_n12m pr_dem_gt50_n1 charls_gt2_ind charls_cancer charls_diab charls_2 ///
comorb_32_0_n12m charls_3 charls_4 charls_6 charls_13 ///
lee_index_ge13_ind symptom_burden pain_none_mild pain_mod_or_sev pain_mod pain_sev ///
cesd_tot_gt3_n1 `symp1' `symp2'
local rn : word count `vars' 1
local r=1
local c=1

mat tab=J(`rn',3,.)
mat stars=J(`rn',3,0)

foreach x of local vars {
	sum female
	local tot=r(N)
	foreach i in "0,1"  {
		sum `x' if inlist(high_illness,`i')
			mat tab[`r',`c']=r(mean)*r(N)
			mat tab[`r',`c'+1]=r(mean)*100
			mat tab[`r',`c'+2]=`tot'-r(N)
			local c=`c'+2
}	
	/*tab `x' high_illness, chi2
	mat tab[`r',7]=r(p)
	mat stars[`r',7]=(r(p)<.05)+(r(p)<.01)*/
	local c=1
	local r=`r'+1
}
foreach i in "0,1" {
	sum tot_preop_illness_burden if inlist(high_illness,`i')
	mat tab[`r',`c']=r(N)
	*mat tab[`r'-1,`c']=r(mean)
	*mat tab[`r'-1,`c'+1]=r(sd)
	local c=`c'+2
}

mat rownames tab=`vars' N

frmttable using "`logpath'\surgery_update_tables.rtf", statmat(tab) ///
ctitles("" "Full Sample N" "%/SD" "Missing") title("Table 1: Cohort Characteristics") varlabels ///
sdec(0,2,0) replace annotate(stars) asymbol(*,**) ///


local rn : word count `vars' 1
local r=1
local c=1

mat tab=J(`rn',6,.)
mat stars=J(`rn',6,0)

foreach x of local vars {
	foreach i in 1 0 {
		sum `x' if inlist(high_illness,`i')
			mat tab[`r',`c']=r(mean)*r(N)
			mat tab[`r',`c'+1]=r(mean)*100
			local c=`c'+2
}	
	if !inlist("`x'","age_lt75", "age_75_84","age_85plus","white_e","black_e", ///
	"hisp_eth_e", "whiteoth","other_na_api_race_e") & !inlist("`x'", "adl_1", "adl_2", ///
	"adl_diff_no_help") {
	tab `x' high_illness, chi2
	mat tab[`r',5]=r(p)
	mat stars[`r',5]=(r(p)<.05)+(r(p)<.01)
}
	if "`x'"=="age_lt75" {
	tab age_cat_2 high_illness, chi2
mat tab[`r',5]=r(p)
}
	if "`x'"=="white_e"{
gen racecat=whiteoth
replace racecat=2 if black
replace racecat=3 if hisp_eth_e
tab racecat high_illness, chi2
mat tab[`r',5]=r(p)
}

	local c=1
	local r=`r'+1
}
foreach i in 1 0 {
	sum tot_preop_illness_burden if inlist(high_illness,`i')
	mat tab[`r',`c']=r(N)
	*mat tab[`r'-1,`c']=r(mean)
	*mat tab[`r'-1,`c'+1]=r(sd)
	local c=`c'+2
}
mat rownames tab=`vars' N

frmttable using "`logpath'\surgery_update_tables.rtf", statmat(tab) ctitles("" "High illness burden" "" "Low illness burden" "" "P-value" \ ///
"" "N/mean" "%/SD" "N/mean" "%/SD" "") title("Table 1a: Cohort Characteristics, by illness burden") varlabels ///
sdec(0,2,0,2,2) addtable annotate(stars) asymbol(*,**) ///
note("High illness burden is 2 or more of ADL dependency, 1+ helper (>=1 hour/week), presence of dementia diagnosis from Medicare claims, high utilization (2+ ED visits and/or IP admissions or 10+ OP visits 12m prior), 13+ on the Lee index at n1 interview, and >2 on the Charlson comorbidity index")


 
mat tab2=J(6,8,.)
local r=1
local c=3
preserve
replace tot_preop_ill=5 if tot_preop_ill==6
sum tot_preop_illness_burden
local denom=r(N)
 forvalues i=0/5 {
	sum tot_preop_illness_burden if tot_preop_illness_burden==`i'
	mat tab2[`r',1]=r(N)
	mat tab2[`r',2]=(r(N)/`denom')*100
	local r=`r'+1
}
local r=1
foreach x in comorb_31_0_n12m adl_impair_n1 charls_gt2_ind high_utilizat lee_index_ge13 ///
 ind_help_any {
	forvalues i=0/5 {
		sum `x' if tot_preop_illness_burden==`i'
		mat tab2[`r',`c']=r(mean)*100
		local r=`r'+1
}
	local c=`c'+1
	local r=1
}
restore
mat rownames tab2=0 1 2 3 4 "5/6"
mat colnames tab2="N" "% of total" comorb_31_0_n12m adl_impair_n1 charls_gt2_ind high_utilization lee_index_ge13_ind ///
 ind_help_any 
frmttable using "`logpath'\surgery_update_tables.rtf", statmat(tab2) ///
/*ctitles("Illness Burden" "N" "% of total" "% die index stay" "% die 365d" ///
"% readmit 30d" "% readmit 365d")*/ sdec(0,2) ///
title("Table 2. Preoperative Illness Burden Among Cohort") addtable varlabels

mat tab2=J(6,6,.)
local r=1
local c=3
preserve
replace tot_preop_ill=5 if tot_preop_ill==6
sum tot_preop_illness_burden
local denom=r(N)
 forvalues i=0/5 {
	sum tot_preop_illness_burden if tot_preop_illness_burden==`i'
	mat tab2[`r',1]=r(N)
	mat tab2[`r',2]=(r(N)/`denom')*100
	local r=`r'+1
}
local r=1
foreach x in died_index_stay died_30d ///
 readmission_30d_ind readmission_365d_ind {
	forvalues i=0/5 {
		sum `x' if tot_preop_illness_burden==`i'
		mat tab2[`r',`c']=r(mean)*100
		local r=`r'+1
}
	local c=`c'+1
	local r=1
}
restore
mat rownames tab2=0 1 2 3 4 "5/6"
frmttable using "`logpath'\surgery_update_tables.rtf", statmat(tab2) ///
ctitles("Illness Burden" "N" "% of total" "% die index stay" "% die 365d" ///
"% readmit 30d" "% readmit 365d") sdec(0,2) ///
title("Table 2. Preoperative Illness Burden Among Cohort") addtable varlabels




preserve
foreach a in b c d {

if "`a'"=="d" drop if died_365d 
if "`a'"=="d" local gp "Survived 365d post discharge"
local vars comp_any readmission_30d_ind readmission_365d_ind ind_icu_postsurg ///
ind_ed_postsurg n_hosp_days_presurg_index n_hosp_days_postsurg_index ///
n_hosp_days_postsurg_postindex died_365d ///
died_index_stay 
local rn : word count `vars' 1
mat tab3=J(`rn',7,.)
mat stars=J(`rn',7,0)
local r=1
local c=1

foreach x in `vars' {
	sum `x'
	local denom=r(N)
	foreach i in "0,1" 1 0 {
	if !inlist(substr("`x'",1,2),"n_") {
	sum `x' if inlist(high_illness_burden,`i')
		mat tab3[`r',`c']=r(N)*r(mean)
		mat tab3[`r',`c'+1]=r(mean)*100
}
	else {
		sum `x' if inlist(high_illness_burden,`i'),d
		mat tab3[`r',`c']=r(mean)
		mat tab3[`r',`c'+1]=r(sd)
}		
	local c=`c'+2
}
	tab `x' high_illness_burden, chi2
	mat tab3[`r',7]=r(p)
	mat stars[`r',7]=(r(p)<.05)+(r(p)<.01)
	if inlist(substr("`x'",1,2),"n_") {
		ttest `x', by(high_illness)
		mat tab3[`r',7]=r(p)
		mat stars[`r',7]=(r(p)<.05)+(r(p)<.01)
}

	local r=`r'+1
	local c=1
}
	foreach i in "0,1" 1 0 {
		sum female if inlist(high_ill,`i')
		mat tab3[`r',`c']=r(N)
		local c=`c'+2
}
mat rownames tab3=`vars' N

frmttable using "`logpath'\surgery_update_tables.rtf", addtable statmat(tab3) ///
ctitles("" "Full Sample" "" "High Illness Burden" "" "Low Illness Burden" "" ///
"p-value"\ "" "N/mean" "%/SD" "N/mean" "%/SD" "" "%/SD" "") ///
title("Table 3. A Comparison of Adverse outcomes" "`gp'") ///
sdec(0,2,0,2,0,2,2\0,2,0,2,0,2,2\0,2,0,2,0,2,2\0,2,0,2,0,2,2\0,2,0,2,0,2,2\ ///
2,2,2,2,2,2,2 ///
\2,2,2,2,2,2,2\2,2,2,2,2,2,2\0,2,0,2,0,2,2) annotate(stars) asymbol(*,**) varlabels
drop if died_index_stay
local gp "Did not die during index stay"
}
restore
label var loc_hosp_x "Died in hospital, from exit"
local deathtime "Full sample" 
foreach time in 1 /*2 3*/ {

	local eoli1 ind_icu_postsurg 
	local eolc1 n_icu_days_postsurg n_icu_days_postsurg_cond
	local eolc2 n_hs_days_postsurg n_hs_days_postsurg_cond n_hosp_days_presurg_index n_hosp_days_postsurg_index ///
	n_hosp_days_postsurg_postindex n_hosp_days_postindex_cond 
	local eoli2 ind_ed_postsurg ind_hs_any
	local eoli3 died_index_stay died_in_hospital loc_hosp_x
	local rn: word count `eoli1' `eolc1' `eoli2' `eolc2' `eoli3' N
	
	mat tab4=J(`rn',7,.)
	mat stars=J(`rn',7,0)
	local r=1
	local c=1

	preserve
	if `time'==1 {
		local deathtime "Death<=365 days post-surgery"
		keep if died_365d
}
	if `time'==2 {
		local deathtime "Died index stay"
		keep if died_index_stay
}
	if `time'==3 {
		local deathtime "Death 31-365 days post-surgery"
		keep if died_356d & !died_index_stay
}

foreach num in 1 2 3 {
foreach x in `eoli`num'' {
	sum `x'
	foreach i in "0,1" 1 0 {
		sum `x' if inlist(high_illness_burden,`i')
		mat tab4[`r',`c']=r(N)*r(mean)
		mat tab4[`r',`c'+1]=r(mean)*100
		local c=`c'+2
}
	tab `x' high_illness_burden, chi2
	mat tab4[`r',7]=r(p)
	mat stars[`r',7]=(r(p)<.05)+(r(p)<.01)
	local c=1
	local r=`r'+1
}
foreach x in `eolc`num'' {
	foreach i in "0,1" 1 0 {
		sum `x' if inlist(high_illness_burden,`i'),d
		mat tab4[`r',`c']=r(mean)
		mat tab4[`r',`c'+1]=r(sd)
		local c=`c'+2
}
	ttest `x', by(high_illness)
	mat tab4[`r',7]=r(p)
	mat stars[`r',7]=(r(p)<.05)+(r(p)<.01)
	local r=`r'+1
	local c=1
}

}	
foreach i in "0,1" 1 0 {
	sum female if inlist(high_illness_burden,`i')
	mat tab4[`r',`c']=r(N)
	local c=`c'+2
}

mat rownames tab4=`eoli1' `eolc1' `eoli2' `eolc2' `eoli3' N

frmttable using "`logpath'\surgery_update_tables.rtf", addtable statmat(tab4) ///
ctitles("" "Full Sample" "" "High Illness Burden" "" "Low Illness Burden" "" ///
"p-value"\ "" "N/mean" "%/SD" "N/mean" "%/SD" "N/mean" "%/SD" "") title("Table 4. End of Life Care Outcomes", ///
"`deathtime'") varlabels ///
sdec(0,2,0,2,0,2,2\2,2,2,2,2,2,2\2,2,2,2,2,2,2\0,2,0,2,0,2,2\0,2,0,2,0,2,2\ ///
2,2,2,2,2,2,2\ ///
2,2,2,2,2,2,2\2,2,2,2,2,2,2\2,2,2,2,2,2,2\2,2,2,2,2,2,2\2,2,2,2,2,2,2\ ///
0,2,0,2,0,2,2\0,2,0,2,0,2,2\0,2,0,2,0,2,2\0) annotate(stars) asymbol(*,**)

	local eoli1 ind_icu_postsurg ind_ed_postsurg ind_hs_lte3 
	local eolc1 n_hs_days_postsurg n_hs_days_postsurg_cond n_hosp_days_presurg_index n_hosp_days_postsurg_index ///
	n_hosp_days_postsurg_postindex n_hosp_days_postindex_cond 
	local eoli2 died_in_hospital loc_hosp_x
	local eolc2 
	local rn: word count 1  `eolc1' 
mat tab4=J(`rn',9,.)
mat stars=J(`rn',9,0)
local r=1
local c=1
foreach num in 1 2 {
foreach x in `eola`num'' {
	sum `x'
	foreach i in "0,1" 1 {
		sum `x' if inlist(high_illness_burden,`i')
		mat tab4[`r',`c']=r(N)*r(mean)
		mat tab4[`r',`c'+1]=r(mean)*100
		local c=`c'+3
}
	tab `x' high_illness_burden, chi2
	mat tab4[`r',5]=r(p)
	mat stars[`r',5]=(r(p)<.05)+(r(p)<.01)
	local c=1
	local r=`r'+1
}
foreach x in `eolc`num'' {
	foreach i in "0,1" 1 {
		sum `x' if inlist(high_illness_burden,`i'),d
		mat tab4[`r',`c']=r(p50)
		mat tab4[`r',`c'+1]=r(p25)
		mat tab4[`r',`c'+2]=r(p75)
		local c=`c'+3
}
	ttest `x', by(high_illness)
	*mat tab4[`r',7]=r(p)
	*mat stars[`r',7]=(r(p)<.05)+(r(p)<.01)
	local r=`r'+1
	local c=1
}

}	
foreach i in "0,1" 1 {
	sum female if inlist(high_illness_burden,`i')
	mat tab4[`r',`c']=r(N)
	local c=`c'+3
}

mat rownames tab4=`eola1' `eolc1' N

frmttable using "`logpath'\surgery_update_tables.rtf", addtable statmat(tab4) ///
ctitles("" "" "Full Sample" "" ""  "High Illness Burden" ///
\ "" "Median" "25th percentile" "75th percentile"  ///
"Median" "25th percentile" "75th percentile" ) title("Table 4. End of Life Care Outcomes among decedents", ///
"`deathtime'") varlabels ///
sdec(0,0,0,0,0,0) annotate(stars) asymbol(*,**)

restore
foreach dt in 1 0  {
preserve
keep if died_365d & died_index_stay==`dt'


local eoli1 ind_icu_postsurg 
local eolc1 n_icu_days_postsurg n_icu_days_postsurg_cond
local eolc2 n_hs_days_postsurg n_hs_days_postsurg_cond n_hosp_days_presurg_index n_hosp_days_postsurg_index ///
n_hosp_days_postsurg_postindex n_hosp_days_postindex_cond 
local eoli2 ind_ed_postsurg ind_hs_any
local eoli3 died_index_stay died_in_hospital loc_hosp_x
local rn: word count `eoli1' `eolc1' `eoli2' `eolc2' `eoli3' N

	
mat tab4=J(`rn',7,.)
mat stars=J(`rn',7,0)
local r=1
local c=1

if `dt'==0 local deathtime "Death<=365 days post-surgery, not within index stay"
if `dt'==1 local deathtime "Died index stay"
foreach num in 1 2 3 {
foreach x in `eoli`num'' {
	cap sum `x'
	foreach i in "0,1" 1 0 {
		cap sum `x' if inlist(high_illness_burden,`i')
		mat tab4[`r',`c']=r(N)*r(mean)
		mat tab4[`r',`c'+1]=r(mean)*100
		local c=`c'+2
}
	cap tab `x' high_illness_burden, chi2
	mat tab4[`r',7]=r(p)
	mat stars[`r',7]=(r(p)<.05)+(r(p)<.01)
	local c=1
	local r=`r'+1
}
foreach x in `eolc`num'' {
	foreach i in "0,1" 1 0 {
		cap sum `x' if inlist(high_illness_burden,`i'),d
		mat tab4[`r',`c']=r(mean)
		mat tab4[`r',`c'+1]=r(sd)
		local c=`c'+2
}
	cap ttest `x', by(high_illness)
	mat tab4[`r',7]=r(p)
	mat stars[`r',7]=(r(p)<.05)+(r(p)<.01)
	local r=`r'+1
	local c=1
}

}	
foreach i in "0,1" 1 0 {
	sum female if inlist(high_illness_burden,`i')
	mat tab4[`r',`c']=r(N)
	local c=`c'+2
}

mat rownames tab4=`eoli1' `eolc1' `eoli2' `eolc2' `eoli3' N

frmttable using "`logpath'\surgery_update_tables.rtf", addtable statmat(tab4) ///
ctitles("" "Full Sample" "" "High Illness Burden" "" "Low Illness Burden" "" ///
"p-value"\ "" "N/mean" "%/SD" "N/mean" "%/SD" "N/mean" "%/SD" "") title("Table 4. End of Life Care Outcomes", ///
"`deathtime'") varlabels ///
sdec(0,2,0,2,0,2,2\2,2,2,2,2,2,2\2,2,2,2,2,2,2\0,2,0,2,0,2,2\0,2,0,2,0,2,2\ ///
2,2,2,2,2,2,2\ ///
2,2,2,2,2,2,2\2,2,2,2,2,2,2\2,2,2,2,2,2,2\2,2,2,2,2,2,2\2,2,2,2,2,2,2\ ///
0,2,0,2,0,2,2\0,2,0,2,0,2,2\0,2,0,2,0,2,2\0) annotate(stars) asymbol(*,**)
	local eoli1 ind_icu_postsurg ind_ed_postsurg ind_hs_lte3 
	local eolc1 n_hs_days_postsurg n_hs_days_postsurg_cond n_hosp_days_presurg_index n_hosp_days_postsurg_index ///
	n_hosp_days_postsurg_postindex n_hosp_days_postindex_cond 
	local eoli2 died_in_hospital loc_hosp_x
	local eolc2 
	local rn: word count 1  `eolc1' 
mat tab4=J(`rn',9,.)
mat stars=J(`rn',9,0)
local r=1
local c=1
foreach num in 1 2 {
foreach x in `eola`num'' {
	sum `x'
	foreach i in "0,1" 1 {
		sum `x' if inlist(high_illness_burden,`i')
		mat tab4[`r',`c']=r(N)*r(mean)
		mat tab4[`r',`c'+1]=r(mean)*100
		local c=`c'+3
}
	tab `x' high_illness_burden, chi2
	mat tab4[`r',5]=r(p)
	mat stars[`r',5]=(r(p)<.05)+(r(p)<.01)
	local c=1
	local r=`r'+1
}
foreach x in `eolc`num'' {
	foreach i in "0,1" 1 {
		sum `x' if inlist(high_illness_burden,`i'),d
		mat tab4[`r',`c']=r(p50)
		mat tab4[`r',`c'+1]=r(p25)
		mat tab4[`r',`c'+2]=r(p75)
		local c=`c'+3
}
	cap ttest `x', by(high_illness)
	*mat tab4[`r',7]=r(p)
	*mat stars[`r',7]=(r(p)<.05)+(r(p)<.01)
	local r=`r'+1
	local c=1
}

}	
foreach i in "0,1" 1 {
	sum female if inlist(high_illness_burden,`i')
	mat tab4[`r',`c']=r(N)
	local c=`c'+3
}

mat rownames tab4=`eola1' `eolc1' N

frmttable using "`logpath'\surgery_update_tables.rtf", addtable statmat(tab4) ///
ctitles("" "" "Full Sample" "" ""  "High Illness Burden" ///
\ "" "Median" "25th percentile" "75th percentile"  ///
"Median" "25th percentile" "75th percentile" ) title("Table 4. End of Life Care Outcomes among decedents", ///
"`deathtime'") varlabels ///
sdec(0,0,0,0,0,0) annotate(stars) asymbol(*,**)

restore
}

}
save `datapath'\surgery_sample.dta, replace


H="km curves"
/*surgery project analysis

Created 1/15/2014 to run preliminary logit regressions of illness burden on mortality

Have to manually add in variable labels to word document, varlabels
not working with categorical variables for some reason

This version runs with the mortality outcome time windows of:
0-30 days
31-180 days
31-365 days

Does stset on the dataset and saves it for other analyses that follow so always run this code 
if dataset is changed*/

capture log close

clear all
set mem 500m
set matsize 800
set more off

local texpath E:\data\surgery\2012_update\logs\tex\
local logpath E:\data\surgery\2012_update\logs
local datapath E:\data\surgery\2012_update\final_data\

log using `logpath'\10_Surgery_code_analysis1.txt, text replace
cd `logpath'
use `datapath'surgery_sample.dta

numlabel, add

tab died_0_30 died_31_180, missing
tab died_0_30 died_31_365, missing

***********************************************************************
***********************************************************************
//Survival analysis
***********************************************************************
***********************************************************************

//first assign a new date, end_date
//This is either the death date or the follow up date
//Follow up date is set to actual follow up date (from p1 core or claims) or 
//Dec 31,2011 since DOD file from HRS/NDI should be complete thru 2011
format death_date %td
//tab death_date, missing
*gen end_date=.
format end_date %td
replace end_date=death_date if died_ind==1 //use DOD if present
replace end_date=c_ivw_date_p1 if end_date==. & (c_ivw_date_p1-procedure_date >= 365) //p1 ivw date if +1yr ps
replace end_date=follow_up_dt_1yr_ps if end_date==. //use claims follow up date
replace end_date= mdy(12,31,2011) if end_date==. & ind_exit==0
tab end_date, missing
//lose the one obs has an exit interview but no death date

//indicator for missing information within 1 year of death
*gen proced_to_end_dt = end_date - procedure_date
tab proced_to_end_dt core_year_p1 if died_ind==0
*gen censor_1y_ind = .
replace censor_1y_ind = 1 if proced_to_end_dt<365 & died_ind==0
replace censor_1y_ind = 0 if proced_to_end_dt>=365 | (proced_to_end_dt<365 & died_ind==1)
replace censor_1y_ind = . if end_date==.
tab censor_1y_ind, missing
//no censored observations!
//the observaton with an exit ivw and no dod will be dropped from the data for the km curve

//2 observations die on date of surgery
tab stay_dstn_cd index_los if(death_date<=procedure_date )
tab procedure_date death_date if(death_date<procedure_date)
tab procedure_date end_date if(death_date<procedure_date)
tab id if(death_date<procedure_date)

//save dataset with end date assigned
*save `datapath'surgery_final_n12m_sample_clean_end_date.dta, replace
drop _d _t _t0
//set for 1 year outcomes only by specifying exit time
/*stset end_date, failure(died_365d) origin(procedure_date) ///
exit(time is_disch_date + 365)
*/
local t=1
tokenize first_icu first_er first_readmit death_date
cap log close
foreach x in ind_icu ind_ed readmission_365 died_365d {
log using `logpath'/stset_`x'.txt, text replace
preserve
qui replace end_date=is_disch_date if death_date>is_disch_date & died_index_stay
local lab : var label `x'
replace end_date=``t'' if ``t''<end_date
stset end_date, failure(`x'=1) origin(is_disch_date) ///
exit(time is_disch_date + 365) enter(procedure_date)
sts graph, by(high_illness_burden) /*tmax(400)*/ ///
legend(label(1 "Low Illness Burden") label(2 "High Illness Burden")) ///
title("`lab'") note("Exit at first failure or 365 days post discharge, censored at death date")
graph export `logpath'\KMCurve`x'.pdf, replace
local t=`t'+1
stdes
sts test high_ill
restore
log close
}

//set with no end date, looks at outcomes > 1 year where present
//stset end_date, failure(died_ind) origin(procedure_date)

stdes

//save dataset with stset assigned
*saveold `datapath'surgery_final_n12m_sample_clean_stset.dta, replace version(11)


tab censor_1y_ind if _st==1
tab procedure_date if censor_1y_ind==1 & _st==1, missing
tab  c_ivw_date_p1 if censor_1y_ind==1 & _st==1, missing

tab procedure_date admit_12m_post if censor_1y_ind==1 & _st==1, missing
tab procedure_date snf_days_post_12m if censor_1y_ind==1 & _st==1, missing

tab adl_cat_core_n1 if procedure_date==d(20mar2002) & censor_1y_ind==1 & _st==1

******************************************************************
******************************************************************
//Run regression - effect of illness burden on mortality
//Exclude the discharge location variables, include diabetes
******************************************************************
******************************************************************
//base categories are age=65-73, srh=very good/excellent 
//adl = independent, disch destination = home
//no disch destination rehab (b/c no obs)
local xvars_no_disch ib1.age_cat i.comorb_1_0_n12m i.comorb_32_0_n12m ///
	i.comorb_31_0_n12m i.comorb_13_0_n12m i.el_diab ///
	ib1.srh_cat_core ib0.adl_cat_core i.nhres_n1 i.admit_ind_6m_pre ///
	/*ib1.stay_dstn_cat i2.stay_dstn_cat i4.stay_dstn_cat ///
	i5.stay_dstn_cat i6.stay_dstn_cat*/ i.comp_any

logit died_0_30 i.high_illness_burden `xvars_no_disch' if _st==1, /*vce(r)*/ or
estat ic
outreg, ///
	stats(e_b e_ci) ctitles("","0-30-Day") ///
	title("Effect of illness burden on mortality") ///
	note("Odds ratios, 95% confidence intervals reported" \ ///
	"Base categories are Age: 65-74, Self-reported health: Excellent or very good," \ ///
	"and ADL: Independent.") ///
	varlabels store(table4) starlevels(10 5 1)

logit died_31_180 i.high_illness_burden `xvars_no_disch' if died_0_30==0 & _st==1, /*vce(r)*/ or
estat ic
outreg, ///
	stats(e_b e_ci)  ctitles("","31-180-Day") ///
	varlabels merge(table4) starlevels(10 5 1)

logit died_31_365 i.high_illness_burden `xvars_no_disch' if died_0_30==0 & _st==1, /*vce(r)*/ or
estat ic
outreg using `logpath'\logit_age, ///
	stats(e_b e_ci)  ctitles("","31-365-Day") ///
	varlabels merge(table4) starlevels(10 5 1) replace		

	
	
******************************************************************
******************************************************************
//Run regression - effect of illness burden on mortality
//All controls
******************************************************************
******************************************************************
//base categories are age=65-73, race=white, tics=normal srh=very good/excellent 
//adl = independent, disch destination = home
//variables omitted b/c no obs: race=other, tics=demented, disch=rehab
local xvars_30d_all ib1.age_cat i.female i1.re_cat i2.re_cat ib3.re_cat ///
	i1b.tics_cat_miss i2.tics_cat_miss i4.tics_cat_miss ///
	i.el_cancer i.comorb_1_0_n12m i.comorb_32_0_n12m i.comorb_31_0_n12m ///
	i.comorb_13_0_n12m i.el_diab ib1.srh_cat_core ib0.adl_cat_core ///
	i.nhres_n1 i.admit_ind_6m_pre ///
	ib1.stay_dstn_cat i2.stay_dstn_cat i4.stay_dstn_cat ///
	i5.stay_dstn_cat i6.stay_dstn_cat i.comp_any

//For 180 day mortality regression
//variables omitted b/c no obs: tics=demented, disch=expired 
local xvars_180d_all ib1.age_cat i.female ib3.re_cat ///
	i1b.tics_cat_miss i2.tics_cat_miss i4.tics_cat_miss ///
	i.el_cancer i.comorb_1_0_n12m i.comorb_32_0_n12m i.comorb_31_0_n12m ///
	i.comorb_13_0_n12m i.el_diab ib1.srh_cat_core ib0.adl_cat_core ///
	i.nhres_n1 i.admit_ind_6m_pre ///
	ib1.stay_dstn_cat i2.stay_dstn_cat i3.stay_dstn_cat ///
	i4.stay_dstn_cat i5.stay_dstn_cat i.comp_any	

//For 365 day mortality regression
//variables omitted b/c no obs: tics=demented, disch=expired 
local xvars_180d_all ib1.age_cat i.female ib3.re_cat ///
	i1b.tics_cat_miss i2.tics_cat_miss i3.tics_cat_miss i4.tics_cat_miss ///
	i.el_cancer i.comorb_1_0_n12m i.comorb_32_0_n12m i.comorb_31_0_n12m ///
	i.comorb_13_0_n12m i.el_diab ib1.srh_cat_core ib0.adl_cat_core ///
	i.nhres_n1 i.admit_ind_6m_pre ///
	ib1.stay_dstn_cat i2.stay_dstn_cat i3.stay_dstn_cat ///
	i4.stay_dstn_cat i5.stay_dstn_cat i.comp_any	

logit died_0_30 i.high_illness_burden `xvars_30d_all'  if _st==1, /*vce(r)*/ or
outreg, ///
	stats(e_b e_ci) ctitles("","30-Day") ///
	title("Effect of illness burden on mortality - All covariates") ///
	note("Odds ratios, 95% confidence intervals reported" \ ///
	"Base categories are Age: 65-74, Race: White, TICS: Normal," \ ///
	"Self-reported health: Excellent or very good," \ ///
	"ADL: Independent, and Discharged to Home.") ///
	varlabels store(table5) starlevels(10 5 1)

logit died_31_180 i.high_illness_burden `xvars_180d_all' if died_0_30==0 & _st==1, /*vce(r)*/ or
outreg, ///
	stats(e_b e_ci)  ctitles("","180-Day") ///
	varlabels merge(table5) starlevels(10 5 1)

logit died_31_365 i.high_illness_burden `xvars_180d_all' if died_0_30==0 & _st==1, /*vce(r)*/ or
outreg using `logpath'\logit_age, ///
	stats(e_b e_ci)  ctitles("","365-Day") ///
	varlabels merge(table5) starlevels(10 5 1) addtable		



***********************************************************************************
***********************************************************************************
//KM Curve
***********************************************************************************
***********************************************************************************
sts list
sts graph
sts graph, by(high_illness_burden) /*tmax(400)*/ ///
legend(label(1 "Low Illness Burden") label(2 "High Illness Burden")) //label(3 "85 and older"))
graph export `logpath'\KMCurve.png, replace

local allxvars high_illness_burden age_cat female re_cat tics_cat_miss ///
	el_cancer comorb_1_0_n12m comorb_32_0_n12m comorb_31_0_n12m ///
	comorb_13_0_n12m el_diab srh_cat_core adl_cat_core ///
	nhres_n1 admit_ind_6m_pre ///
	stay_dstn_cat comp_any

foreach v in `allxvars'{
sts test `v', logrank
}

***********************************************************************************
***********************************************************************************
//Run complementary log log model
***********************************************************************************
***********************************************************************************
cloglog died_0_30 high_illness_burden `xvars_no_disch' if _st==1, eform
outreg, ///
 	stats(e_b e_ci) ctitles("","0-30-Day") ///
	title("Effect of illness burden on mortality - Complementary log log model") ///
	note("Hazard ratios, 95% confidence intervals reported" \ ///
	"Base categories are Age: 65-74, Self-reported health: Excellent or very good," \ ///
	"and ADL: Independent.") ///
	varlabels store(table6) starlevels(10 5 1)

cloglog died_31_180 high_illness_burden `xvars_no_disch' if died_0_30==0 & _st==1, eform
outreg, ///
 	stats(e_b e_ci) ctitles("","31-180-Day") ///
	varlabels merge(table6) starlevels(10 5 1)

cloglog died_31_365 high_illness_burden `xvars_no_disch' if died_0_30==0 & _st==1, eform
outreg using `logpath'\logit_age, ///
	stats(e_b e_ci) ctitles("","31-365-Day") ///
	varlabels merge(table6) starlevels(10 5 1) addtable

	
log close


H="code from LIz"
//AAST ABSTRACT USING FULL COHORT DATA//

//median pre/post length of stay for high/low burden and ranksum comparison for all patients, for those who died in-hospital, and live discharges
foreach var of varlist n_hosp_days_presurg_index n_hosp_days_postsurg_index {
by high_illness_burden, sort: summarize `var', d
ranksum `var', by(high_illness_burden)
}
foreach var of varlist n_hosp_days_presurg_index n_hosp_days_postsurg_index {
by high_illness_burden if died_index_stay == 1, sort: summarize `var', d
ranksum `var' if died_index_stay == 1, by(high_illness_burden)
}
foreach var of varlist n_hosp_days_presurg_index n_hosp_days_postsurg_index {
by high_illness_burden if died_index_stay == 0, sort: summarize `var', d
ranksum `var' if died_index_stay == 0, by(high_illness_burden)
}

//create age group variable//
gen agegrp = 1 if age_lt75 == 1
replace agegrp = 2 if age_75_84 == 1
replace agegrp = 3 if age_85plus == 1
label define agegrp 1 "<75 years" 2 "75-84 years" 3 ">=85 years"
label values agegrp agegrp
label variable agegrp "Age group at surgery"

//create race variable//
gen race = 1 if white_e == 1 | whiteoth == 1
replace race = 2 if black_e == 1
replace race = 3 if hisp_eth_e == 1
replace race = 4 if other_na_api_race_e == 1
label define race 1 "White" 2 "Black" 3 "Hispanic" 4 "Other"
label values race race
label variable race "Race"

//logistic regression models with age and sex 
logistic comp_any i.high_illness_burden i.agegrp i.female i.race
logistic died_index_stay i.high_illness_burden i.agegrp i.female i.race
logistic died_index_stay i.high_illness_burden i.agegrp i.female i.race i.comp_any
stset n_hosp_days_postsurg_index, failure(died_index_stay == 1)
stcox i.high_illness_burden i.agegrp i.female i.race
stcox i.high_illness_burden i.agegrp i.female i.race i.comp_any

//compare length of stay using competing risks regression / CIF for competing risk of death//
stset n_hosp_days_postsurg_index, failure(died_index_stay == 0)
stcrreg i.high_illness_burden i.agegrp i.female i.race, compete(died_index_stay == 1)
stcurve, cif at1(high_illness_burden == 0) at2 (high_illness_burden == 1) ylabels(0 .25 .5 .75 1)




//ACS ABSTRACT USING PATIENTS WHO SURVIVED IN-HOSPITAL//
//demographics//
foreach var of varlist agegrp female race adl_independent_core_n1 adl_diff_no_help adl_1 adl_2 iadl_diff_impair_n1 comorb_31_0_n12m charls_gt_2_ind symptom_burden comp_any {
tab `var' high_illness_burden if died_index_stay != 1, col chi2
}

//compare total LOS for EGS admission//
gen los_total = n_hosp_days_presurg_index + n_hosp_days_postsurg_index
label variable los_total "Total LOS EGS admission"
foreach var of varlist n_hosp_days_presurg_index n_hosp_days_postsurg_index los_total {
summarize `var'if died_index_stay != 1, d
by high_illness_burden, sort: summarize `var'if died_index_stay != 1, d
ranksum `var'if died_index_stay != 1, by(high_illness_burden)
}

//logistic regression for outcomes//
foreach var of varlist ind_ed_postsurg readmission_365d_ind ind_icu_postsurg died_365d {
logistic `var' i.high_illness_burden i.agegrp i.female i.race if died_index_stay != 1
logistic `var' i.high_illness_burden i.agegrp i.female i.race i.comp_any if died_index_stay != 1
}

/* NOTE
If possible, I would prefer to do a competing risks regression: questions
1. Were all patients followed for up to 365 days or death? Or were some censored < 365 days after discharge?  If so, what is the last date of follow-up?
2. Do you have the following data:
   a. date of discharge
   b. date of death: use to create time variable for time2death after discharge (or loss to follow-up)
   c. date of first readmission: use to create time2readmission after discharge (replace with time2death if not readmitted)
   d. date of first ED visit: use to create time2ed after discharge (replace with time2death if no ED visit)
   e. date of first readmission with an ICU stay: use to create time2icu after discharge (replace with time2death if no ICU admission)
3. If these data are available, the code for competing risks regression below can be used... I made some code for defining the time variables as well.
*/

//generate time variables for outcome vs. death//
gen time2death = 1 + (date_death - date_egs_discharge) if died_365d == 1
replace time2death = 365 if died_365d != 1
gen time2ed = 1 + (date_ed_visit - date_egs_discharge) if ind_ed_postsurg == 1
replace time2ed = 365 if ind_ed_postsurg != 1
gen time2readmission = 1 + (date_readmission - date_egs_discharge) if readmission_365d_ind == 1
replace time2readmission = 365 if readmission_365d_ind != 1
gen time2icu = 1 + (date_icu_readmission - date_egs_discharge) if ind_icu_postsurg == 1
replace time2icu = 365 if ind_icu_postsurg != 1

//competing risks regression for outcomes//
stset time2ed, failure(ind_ed_postsurg == 1)
stcrreg i.high_illness_burden i.agegrp i.female i.race i.comp_any if died_index_stay != 1, compete(ind_ed_postsurg == 0)
stset time2readmission, failure(readmission_365d_ind == 1)
stcrreg i.high_illness_burden i.agegrp i.female i.race i.comp_any if died_index_stay != 1, compete(readmission_365d_ind == 0)
stset time2icu, failure(ind_icu_postsurg == 1)
stcrreg i.high_illness_burden i.agegrp i.female i.race i.comp_any if died_index_stay != 1, compete(ind_icu_postsurg == 0)
stset time2death, failure(died_365d == 1)
stcrreg i.high_illness_burden i.agegrp i.female i.race i.comp_any if died_index_stay != 1, compete(died_365d == 0)


 


H="adapted"
//AAST ABSTRACT USING FULL COHORT DATA//

capture log close
set more off
clear all
local datapath E:\data\surgery\2012_update\final_data
local logpath E:\data\surgery\2012_update\logs

cd `datapath'


log using `logpath'\egs_surgery_output.txt,text replace
use `datapath'\surgery_sample.dta, clear
//median pre/post length of stay for high/low burden and ranksum comparison for all patients, for those who died in-hospital, and live discharges

foreach var of varlist n_hosp_days_presurg_index n_hosp_days_postsurg_index {
by high_illness_burden, sort: summarize `var', d
ranksum `var', by(high_illness_burden)
}
foreach var of varlist n_hosp_days_presurg_index n_hosp_days_postsurg_index {
by high_illness_burden, sort: summarize `var'  if died_index_stay == 1, d
ranksum `var' if died_index_stay == 1, by(high_illness_burden)
}
foreach var of varlist n_hosp_days_presurg_index n_hosp_days_postsurg_index {
by high_illness_burden, sort: summarize `var' if died_index_stay == 0, d
ranksum `var' if died_index_stay == 0, by(high_illness_burden)
}

//create age group variable//
gen agegrp = 1 if age_lt75 == 1
replace agegrp = 2 if age_75_84 == 1
replace agegrp = 3 if age_85plus == 1
label define agegrp 1 "<75 years" 2 "75-84 years" 3 ">=85 years"
label values agegrp agegrp
label variable agegrp "Age group at surgery"

//create race variable//
gen race = 1 if white_e == 1 | whiteoth == 1
replace race = 2 if black_e == 1
replace race = 3 if hisp_eth_e == 1
replace race = 4 if other_na_api_race_e == 1
label define race 1 "White" 2 "Black" 3 "Hispanic" 4 "Other"
label values race race
label variable race "Race"

//logistic regression models with age and sex 
logistic comp_any i.high_illness_burden i.agegrp i.female i.race
logistic died_index_stay i.high_illness_burden i.agegrp i.female i.race
logistic died_index_stay i.high_illness_burden i.agegrp i.female i.race i.comp_any
drop _*
stset n_hosp_days_postsurg_index, failure(died_index_stay == 1)
stcox i.high_illness_burden i.agegrp i.female i.race
stcox i.high_illness_burden i.agegrp i.female i.race i.comp_any

//compare length of stay using competing risks regression / CIF for competing risk of death//
stset n_hosp_days_postsurg_index, failure(died_index_stay == 0)
stcrreg i.high_illness_burden i.agegrp i.female i.race, compete(died_index_stay == 1)
stcurve, cif at1(high_illness_burden = 0) at2 (high_illness_burden = 1) ylabels(0 .25 .5 .75 1)




//ACS ABSTRACT USING PATIENTS WHO SURVIVED IN-HOSPITAL//
//demographics//
foreach var of varlist agegrp female race adl_independent_core_n1 adl_diff_no_help adl_1 adl_2 iadl_diff_impair_n1 comorb_31_0_n12m charls_gt2_ind symptom_burden comp_any {
tab `var' high_illness_burden if died_index_stay != 1, col chi2
}

//compare total LOS for EGS admission//
gen los_total = n_hosp_days_presurg_index + n_hosp_days_postsurg_index
label variable los_total "Total LOS EGS admission"
foreach var of varlist n_hosp_days_presurg_index n_hosp_days_postsurg_index los_total {
summarize `var' if died_index_stay != 1, d
by high_illness_burden, sort: summarize `var' if died_index_stay != 1, d
ranksum `var' if died_index_stay != 1, by(high_illness_burden)
}

//logistic regression for outcomes//
foreach var of varlist ind_ed_postsurg readmission_365d_ind ind_icu_postsurg died_365d {
logistic `var' i.high_illness_burden i.agegrp i.female i.race if died_index_stay != 1
logistic `var' i.high_illness_burden i.agegrp i.female i.race i.comp_any if died_index_stay != 1
}

/* NOTE
If possible, I would prefer to do a competing risks regression: questions
1. Were all patients followed for up to 365 days or death? Or were some censored < 365 days after discharge?  If so, what is the last date of follow-up?
2. Do you have the following data:
   a. date of discharge
   b. date of death: use to create time variable for time2death after discharge (or loss to follow-up)
   c. date of first readmission: use to create time2readmission after discharge (replace with time2death if not readmitted)
   d. date of first ED visit: use to create time2ed after discharge (replace with time2death if no ED visit)
   e. date of first readmission with an ICU stay: use to create time2icu after discharge (replace with time2death if no ICU admission)
3. If these data are available, the code for competing risks regression below can be used... I made some code for defining the time variables as well.
*/

//generate time variables for outcome vs. death//
gen time2death = 1 + (death_date - is_disch_date) if died_365d == 1
replace time2death = 365 if died_365d != 1
gen time2ed = 1 + (first_er - is_disch_date) if ind_ed_postsurg == 1
replace time2ed = 365 if ind_ed_postsurg != 1
gen time2readmission = 1 + (first_readmit - is_disch_date) if readmission_365d_ind == 1
replace time2readmission = 365 if readmission_365d_ind != 1
gen time2icu = 1 + (first_icu - is_disch_date) if ind_icu_postsurg == 1
replace time2icu = 365 if ind_icu_postsurg != 1

//competing risks regression for outcomes//
drop _*
stset time2ed, failure(ind_ed_postsurg == 1)
stcrreg i.high_illness_burden i.agegrp i.female i.race i.comp_any if died_index_stay != 1, compete(ind_ed_postsurg == 0)
drop _*
stset time2readmission, failure(readmission_365d_ind == 1)
stcrreg i.high_illness_burden i.agegrp i.female i.race i.comp_any if died_index_stay != 1, compete(readmission_365d_ind == 0)
drop _*
stset time2icu, failure(ind_icu_postsurg == 1)
stcrreg i.high_illness_burden i.agegrp i.female i.race i.comp_any if died_index_stay != 1, compete(ind_icu_postsurg == 0)
drop _*
stset time2death, failure(died_365d == 1)
stcrreg i.high_illness_burden i.agegrp i.female i.race i.comp_any if died_index_stay != 1, compete(died_365d == 0)

log close
 
